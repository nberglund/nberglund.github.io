<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Transactions in SQL Server (take 2956) &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Transactions in SQL Server (take 2956)</h1>
  <div class="post-subheading">
  <span class="post-date">11 Sep 2011</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>Transactions in SQL Server seems to be a difficult topic to grasp. This weekend I came across a blog-post where the poster showed a “solution” to the “The ROLLBACK TRANSACTION request has no corresponding BEGIN TRANSACTION” error we sometimes see when various stored procedures call each other. The solution (even though it masked out the error in question) did not get it quite right. So I thought I would make a post about the subject.</p>

<!--more-->

<h3 id="nested-transactions-in-sql-server-and-the-evil-trancount">Nested Transactions in SQL Server and the Evil @@TRANCOUNT</h3>

<p>In SQL Server we have the @@TRANCOUNT variable which gives us the number of transactions active in the session - or that’s at least what we might believe. Take this  extremely simple code:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">t</span> <span class="p">(</span><span class="n">col1</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
<span class="n">PRINT</span> <span class="o">@@</span><span class="n">TRANCOUNT</span>
<span class="k">BEGIN</span> <span class="n">TRAN</span>
<span class="n">PRINT</span> <span class="o">@@</span><span class="n">TRANCOUNT</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">#</span><span class="n">t</span> <span class="k">VALUES</span><span class="p">(</span><span class="s1">'HELLO'</span><span class="p">)</span>
<span class="k">BEGIN</span> <span class="n">TRAN</span>
<span class="n">PRINT</span> <span class="o">@@</span><span class="n">TRANCOUNT</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">#</span><span class="n">t</span> <span class="k">VALUES</span><span class="p">(</span><span class="s1">'WORLD'</span><span class="p">)</span>
<span class="k">COMMIT</span>
<span class="n">PRINT</span> <span class="o">@@</span><span class="n">TRANCOUNT</span>
<span class="k">COMMIT</span>
<span class="n">PRINT</span> <span class="o">@@</span><span class="n">TRANCOUNT</span>
</code></pre></div></div>

<p>You should see something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
2
1
0
</code></pre></div></div>

<p>I.e. it seems like the transaction count is increasing for each BEGIN TRAN, and decrease with COMMIT. And if you were to <code class="highlighter-rouge">SELECT * FROM #t</code> you would see two rows returned. So far so good, so what is wrong with @@TRANCOUNT then? Well, let us change the code slightly (don’t forget to drop #t if you copy and paste this code):</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">t</span> <span class="p">(</span><span class="n">col1</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
<span class="n">PRINT</span> <span class="o">@@</span><span class="n">TRANCOUNT</span>
<span class="k">BEGIN</span> <span class="n">TRAN</span>
<span class="n">PRINT</span> <span class="o">@@</span><span class="n">TRANCOUNT</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">#</span><span class="n">t</span> <span class="k">VALUES</span><span class="p">(</span><span class="s1">'HELLO'</span><span class="p">)</span>
<span class="k">BEGIN</span> <span class="n">TRAN</span>
<span class="n">PRINT</span> <span class="o">@@</span><span class="n">TRANCOUNT</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">#</span><span class="n">t</span> <span class="k">VALUES</span><span class="p">(</span><span class="s1">'WORLD'</span><span class="p">)</span>
<span class="k">COMMIT</span>
<span class="n">PRINT</span> <span class="o">@@</span><span class="n">TRANCOUNT</span>
<span class="k">ROLLBACK</span>
<span class="n">PRINT</span> <span class="o">@@</span><span class="n">TRANCOUNT</span>
</code></pre></div></div>

<p>If you now were to (don’t do it immediately) <code class="highlighter-rouge">SELECT * FROM #t</code>, how many rows would you get back - 0, 1, or 2? Seeing how the @@TRANCOUNT is increasing with every BEGIN TRAN and decreasing with COMMIT / ROLLBACK, it is understandable if your answer is 1:</p>

<ul>
  <li>we start a transaction and insert a row</li>
  <li>we then start another transaction and insert a second row</li>
  <li>we call commit after the second insert (the inner transaction)</li>
  <li>finally we do a rollback, on the “outer” transaction</li>
</ul>

<p>As we after the second BEGIN TRAN can see @@TRANCOUNT being 2, we could assume that the commit would commit the second insert. However, we all know what happens when we assume  (now would be a good time to do the SELECT)  ….</p>

<p>Right, the SELECT did not return any rows at all, so it is probably fair to say that we did not have multiple transactions, even though @@TRANCOUNT showed us more than one. So, then we might assume (keep in mind what I’ve said about assume) that the reason we rolled back was because ROLLBACK was the last statement. Let us switch the COMMIT on line 10 with the ROLLBACK on line 12 (we now have ROLLBACK on line 10 and COMMIT on line 12) and execute. WHOA – we got a big fat exception, what happened here? To answer that, let us look a bit closer at the main parts of transaction control in your code.</p>

<h3 id="begin-tran-commit-and-rollback">BEGIN TRAN, COMMIT and ROLLBACK</h3>

<p>When you execute BEGIN TRAN in T-SQL, SQL will look around in the execution context of your session and see if there already exists a transactional context. If not, SQL will start a new transaction. If there is a transaction already, SQL will enlist in this transaction. However in both cases SQL will increase the @@TRANCOUNT variable.</p>

<p>Then, when you execute a COMMIT, SQL will not immediately commit the transaction but will decrease the transaction count with 1. If the transaction count has reached 0 due to the commit, a commit will take place. OK, so far so good, but this does not explain the error we received when switching the COMMIT and ROLLBACK statements, if it works as described, then we should have committed?</p>

<p>Ah, yes – however, a ROLLBACK not only decrements the transaction count – it sets it to 0 immediately, and as the transaction count is now 0, a rollback will happen. So in our second example we are seeing something similar to when we – in stored procs – are getting the ”The ROLLBACK TRANSACTION request has no corresponding BEGIN TRANSACTION” error.</p>

<h3 id="stored-procedures-and-transactions">Stored Procedures and Transactions</h3>

<p>It is quite common to write procs something like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">PROC</span> <span class="n">sp2</span>
<span class="k">AS</span>
<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span>
<span class="k">BEGIN</span> <span class="n">TRAN</span>
<span class="k">BEGIN</span> <span class="n">TRY</span>
  <span class="c1">-- do some stuff</span>
  <span class="c1">-- then if all is OK we commit</span>
  <span class="k">COMMIT</span> <span class="n">TRAN</span>
  <span class="k">RETURN</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">END</span> <span class="n">TRY</span>
<span class="k">BEGIN</span> <span class="n">CATCH</span>
  <span class="k">DECLARE</span> <span class="o">@</span><span class="n">errMSg</span> <span class="n">varchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
  <span class="k">SELECT</span> <span class="o">@</span><span class="n">errMSg</span> <span class="o">=</span> <span class="n">ERROR_MESSAGE</span><span class="p">()</span>
  <span class="k">ROLLBACK</span> <span class="n">TRAN</span>
  <span class="k">RETURN</span> <span class="mi">999</span><span class="p">;</span> <span class="c1">--things have gone very wrong</span>
<span class="k">END</span> <span class="n">CATCH</span>
</code></pre></div></div>

<p>Then we are having a similar proc, looking almost the same, but it, in addition, calls into sp2:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">PROC</span> <span class="n">sp1</span>
<span class="k">AS</span>
<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span>
<span class="k">BEGIN</span> <span class="n">TRAN</span>
<span class="k">BEGIN</span> <span class="n">TRY</span>
  <span class="c1">-- do some stuff</span>
  <span class="c1">-- do some more stuff by calling into sp2</span>
  <span class="k">EXEC</span> <span class="n">sp2</span><span class="p">;</span>
  <span class="c1">-- then if all is OK we commit</span>
  <span class="k">COMMIT</span> <span class="n">TRAN</span>
  <span class="k">RETURN</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">END</span> <span class="n">TRY</span>
<span class="k">BEGIN</span> <span class="n">CATCH</span>
  <span class="k">DECLARE</span> <span class="o">@</span><span class="n">errMSg</span> <span class="n">varchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
  <span class="k">SELECT</span> <span class="o">@</span><span class="n">errMSg</span> <span class="o">=</span> <span class="n">ERROR_MESSAGE</span><span class="p">()</span>
  <span class="k">ROLLBACK</span> <span class="n">TRAN</span>
  <span class="k">RETURN</span> <span class="mi">999</span><span class="p">;</span> <span class="c1">--things have gone very wrong</span>
<span class="k">END</span> <span class="n">CATCH</span>
</code></pre></div></div>

<p>This is now when we will potentially see the error mentioned before. We call sp1, when sp1 is called there is no transactional context around, so SQL creates a new transaction. Then we go on to call sp2 from sp1. In the BEGIN TRAN call in sp2, there exists a transactional context, so SQL enlists us in that context.</p>

<p>If all now goes well and we call COMMIT in sp2, the commit causes the transaction count to be decreased to 1 – but no “real” commit happens. So when we subsequently calls COMMIT in sp1, we decrement the transaction count to 0, and we are committed.</p>

<p>In the case when things go wrong is sp2 and we call rollback, the transaction count is immediately set to 0, and a rollback happens. When we come back to sp1, SQL sees that we had a transaction in sp1, but there are no transactions around, and we will get the error discussed. If we then go on and do a rollback (as in our code) – we will get additional errors.</p>

<h3 id="solution">Solution</h3>

<p>A solution to the problem is to use the “evil” @@TRANCOUNT, to see if there are any transactions around. If there aren’t any, we start a transaction. If there are a transaction already, we don’t do anything, and we let the existing transaction handle everything:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">PROC</span> <span class="n">sp2</span>
<span class="k">AS</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">tranCount</span> <span class="n">int</span> <span class="o">=</span> <span class="o">@@</span><span class="n">TRANCOUNT</span><span class="p">;</span> <span class="c1">--I'm using SQL2008 here</span>
<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span>
<span class="n">IF</span><span class="p">(</span><span class="o">@</span><span class="n">tranCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">--no tx's around, we can start a new</span>
  <span class="k">BEGIN</span> <span class="n">TRAN</span>
<span class="k">BEGIN</span> <span class="n">TRY</span>
  <span class="c1">-- do some stuff</span>
  <span class="c1">-- then if all is OK we commit</span>
  <span class="c1">--if the variable @tranCount is 0,</span>
  <span class="c1">-- we have started the tx ourselves, and can commit</span>
  <span class="n">IF</span><span class="p">(</span><span class="o">@</span><span class="n">tranCount</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">AND</span> <span class="n">XACT_STATE</span><span class="p">()</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">--XACT_STATE - just to be on the safe side</span>
    <span class="k">COMMIT</span> <span class="n">TRAN</span><span class="p">;</span>

  <span class="k">RETURN</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">END</span> <span class="n">TRY</span>
<span class="k">BEGIN</span> <span class="n">CATCH</span>
  <span class="k">DECLARE</span> <span class="o">@</span><span class="n">errMSg</span> <span class="n">varchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
  <span class="k">SELECT</span> <span class="o">@</span><span class="n">errMSg</span> <span class="o">=</span> <span class="n">ERROR_MESSAGE</span><span class="p">()</span>
  <span class="c1">--if the variable @tranCount is 0,</span>
  <span class="c1">-- we have started the tx ourselves, and can rollback</span>
  <span class="n">IF</span><span class="p">(</span><span class="o">@</span><span class="n">tranCount</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">AND</span> <span class="n">XACT_STATE</span><span class="p">()</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">--XACT_STATE - just to be on the safe side</span>
    <span class="k">ROLLBACK</span> <span class="n">TRAN</span><span class="p">;</span>

  <span class="c1">--tell an eventual calling proc that things have gone wrong</span>
  <span class="c1">--and the calling proc should rollback</span>
  <span class="k">RETURN</span> <span class="mi">999</span><span class="p">;</span>
<span class="k">END</span> <span class="n">CATCH</span>
</code></pre></div></div>

<p>Obviously the calling proc would have similar code to decide if to start a tran or not.</p>

<p>In the above scenario we let the “outer” proc handle all the transactional control. Sometimes you are in a situation where – if things go wrong in the “inner” proc (sp2 in our case) – you do not want to roll back everything done, but only what was done in the inner proc. For such a scenarion, you can use named savepoints:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">PROC</span> <span class="n">sp2</span>
<span class="k">AS</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">tranCount</span> <span class="n">int</span> <span class="o">=</span> <span class="o">@@</span><span class="n">TRANCOUNT</span><span class="p">;</span> <span class="c1">--I'm using SQL2008 here</span>
<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span>
<span class="n">IF</span><span class="p">(</span><span class="o">@</span><span class="n">tranCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">--no tx's around, we can start a new</span>
  <span class="k">BEGIN</span> <span class="n">TRAN</span>
<span class="k">ELSE</span> <span class="c1">--we are already in a tx, take a savepoint here</span>
  <span class="n">SAVE</span> <span class="n">TRANSACTION</span> <span class="n">sp2</span> <span class="c1">--this is just a name</span>

<span class="k">BEGIN</span> <span class="n">TRY</span>
  <span class="c1">-- do some stuff</span>
  <span class="c1">-- then if all is OK we commit</span>
  <span class="c1">--if the variable @tranCount is 0,</span>
  <span class="c1">-- we have started the tx ourselves, and can commit</span>
  <span class="n">IF</span><span class="p">(</span><span class="o">@</span><span class="n">tranCount</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">AND</span> <span class="n">XACT_STATE</span><span class="p">()</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">--XACT_STATE - just to be on the safe side</span>
    <span class="k">COMMIT</span> <span class="n">TRAN</span><span class="p">;</span>

  <span class="k">RETURN</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">END</span> <span class="n">TRY</span>
<span class="k">BEGIN</span> <span class="n">CATCH</span>
  <span class="k">DECLARE</span> <span class="o">@</span><span class="n">errMSg</span> <span class="n">varchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
  <span class="k">SELECT</span> <span class="o">@</span><span class="n">errMSg</span> <span class="o">=</span> <span class="n">ERROR_MESSAGE</span><span class="p">()</span>
  <span class="c1">--if the variable @tranCount is 0,</span>
  <span class="c1">-- we have started the tx ourselves, and can rollback</span>
  <span class="n">IF</span><span class="p">(</span><span class="o">@</span><span class="n">tranCount</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">AND</span> <span class="n">XACT_STATE</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">--XACT_STATE - just to be on the safe side</span>
    <span class="k">ROLLBACK</span> <span class="n">TRAN</span><span class="p">;</span>
  <span class="k">ELSE</span> <span class="n">IF</span> <span class="p">(</span><span class="o">@</span><span class="n">tranCount</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span> <span class="k">AND</span> <span class="n">XACT_STATE</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">ROLLBACK</span> <span class="n">TRANSACTION</span> <span class="n">sp2</span> <span class="c1">--we are rolling back to the save-point</span>

  <span class="c1">--tell an eventual calling proc that things have gone wrong</span>
  <span class="c1">--and let the calling proc decide what to do with its parts</span>
  <span class="k">RETURN</span> <span class="mi">999</span><span class="p">;</span>
<span class="k">END</span> <span class="n">CATCH</span>
</code></pre></div></div>

<p>Personally, I do not use named save-points that much as they cannot be used together with linked servers, and we – unfortunately – are using linked servers a lot.</p>

<p>A final note about named save-points; they are not the same thing as beginning / committing / rolling back a transaction with a name:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">t</span> <span class="p">(</span><span class="n">col1</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
<span class="k">BEGIN</span> <span class="n">TRAN</span> <span class="n">t1</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">#</span><span class="n">t</span> <span class="k">VALUES</span><span class="p">(</span><span class="s1">'HELLO'</span><span class="p">)</span>
<span class="k">ROLLBACK</span> <span class="n">TRAN</span> <span class="n">t1</span>
</code></pre></div></div>

<p>Beginning a transaction with a name, is for most parts just a convenience. It has no effect on nesting (unless you use named save points), and SQL Server Books OnLine says this about naming of transactions:<br />
“Naming multiple transactions in a series of nested transactions with a transaction name has little effect on the transaction. Only the first (outermost) transaction name is registered with the system. A rollback to any other name (other than a valid savepoint name) generates an error. None of the statements executed before the rollback is, in fact, rolled back at the time this error occurs. The statements are rolled back only when the outer transaction is rolled back”.</p>

<p>If you have questions, observations etc., please feel free to leave me a comment, or drop me an email.</p>


    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2011/09/11/transactions-in-sql-server-take-2956/&text=Transactions in SQL Server (take 2956)&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2011/09/11/transactions-in-sql-server-take-2956/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2011/09/11/transactions-in-sql-server-take-2956/
         &title=Transactions in SQL Server (take 2956)
         &summary=Blog post: 
         &source=http://www.nielsberglund.com/2011/09/11/transactions-in-sql-server-take-2956/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2011/09/11/transactions-in-sql-server-take-2956/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#denali">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">denali</span>
    </a>
  
    
    <a href="/tags/#sql-server">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server</span>
    </a>
  
    
    <a href="/tags/#t-sql">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">t-sql</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2011/09/11/transactions-in-sql-server-take-2956/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2011/09/11/transactions-in-sql-server-take-2956/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/12/interesting-stuff-week-32/">
            Interesting Stuff - Week 32
            <small>12 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
