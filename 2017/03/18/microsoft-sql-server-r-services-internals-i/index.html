<!DOCTYPE html> <html lang="en-us"> <head> <!-- Google Tag Manager --> <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-K7B3642');</script> <!-- End Google Tag Manager --> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="SQL Server R Services series. Today we look at what happen in the SQL Server engine when we execute sp_execute_external_script."> <meta name="keywords" content="SQL Server R Services, SQL Server Machine Learning Services, R, WinDbg"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Microsoft SQL Server R Services - Internals I &middot; Niels Berglund </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-d361e701e0c0e75e121ac3e901cff1b8.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.5.0 --> <title>Microsoft SQL Server R Services - Internals I | Niels Berglund</title> <meta name="generator" content="Jekyll v3.8.2" /> <meta property="og:title" content="Microsoft SQL Server R Services - Internals I" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="SQL Server R Services series. Today we look at what happen in the SQL Server engine when we execute sp_execute_external_script." /> <meta property="og:description" content="SQL Server R Services series. Today we look at what happen in the SQL Server engine when we execute sp_execute_external_script." /> <link rel="canonical" href="http://nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/" /> <meta property="og:url" content="http://nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/" /> <meta property="og:site_name" content="Niels Berglund" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2017-03-18T16:21:21+02:00" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"http://nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/","headline":"Microsoft SQL Server R Services - Internals I","dateModified":"2017-03-18T16:21:21+02:00","datePublished":"2017-03-18T16:21:21+02:00","author":{"@type":"Person","name":"nielsb"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/"},"description":"SQL Server R Services series. Today we look at what happen in the SQL Server engine when we execute sp_execute_external_script.","@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-3005153158271538", enable_page_level_ads: true }); </script> </head> <body> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K7B3642" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) --> <div class="sidebar"> <div class="container"> <div class="sidebar-about"> <h1> <a href="/"> Niels Berglund </a> </h1> <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Sidebar_rectangle --> <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-3005153158271538" data-ad-slot="7704601332"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/disclaimer/">Disclaimer</a> <a class="sidebar-nav-item" href="/series/">Blog Post Series</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <img class="center" src="/images/MVP_Logo_large.png" width="300" height="121" > <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <p>&copy; 2018. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">Microsoft SQL Server R Services - Internals I</h1> <div class="post-subheading"> <span class="post-date">18 Mar 2017</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#Microsoft R Server">Microsoft R Server</a> <a href="/categories/#Data Science">Data Science</a> <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a> <a href="/categories/#SQL Server R Services">SQL Server R Services</a> <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server R Services">SQL Server R Services</a> <a href="/tags/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <a href="/tags/#R">R</a> <a href="/tags/#WinDbg">WinDbg</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> <p>This post is part of a series of blog-posts about Microsoft SQL Server R Services:</p> <ol> <li><a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">Microsoft SQL Server 2016 R Services Installation</a></li> <li>Microsoft SQL Server R Services - Internals I (this post)</li> <li><a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Microsoft SQL Server R Services - Internals II</a></li> <li><a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Microsoft SQL Server R Services - Internals III</a></li> <li><a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Microsoft SQL Server R Services - Internals IV</a></li> <li><a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Microsoft SQL Server R Services - Internals V</a></li> <li><a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Microsoft SQL Server R Services - Internals VI</a></li> <li><a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Microsoft SQL Server R Services - Internals VII</a></li> <li><a href="/2017/07/22/microsoft-sql-server-r-services-internals-viii/">Microsoft SQL Server R Services - Internals VIII</a></li> <li><a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Microsoft SQL Server R Services - Internals IX</a></li> <li><a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Microsoft SQL Server R Services - Internals X</a></li> <li><a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">Microsoft SQL Server R Services - Internals XI</a></li> <li><a href="/2017/10/31/microsoft-sql-server-r-services-internals-xii/">Microsoft SQL Server R Services - Internals XII</a></li> <li><a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">Microsoft SQL Server R Services - Internals XIII</a></li> <li><a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Microsoft SQL Server R Services - Internals XIV</a></li> <li><a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Microsoft SQL Server R Services - Internals XV</a></li> <li><a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Microsoft SQL Server R Services - Internals XVI</a></li> <li><a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Microsoft SQL Server R Services - Internals XVII</a></li> <li><a href="/2018/01/10/microsoft-sql-server-r-services-internals-xviii/">Microsoft SQL Server R Services - Internals XVIII</a></li> <li><a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Microsoft SQL Server R Services - Internals XIX</a></li> <li><a href="/2018/02/02/microsoft-sql-server-r-services-internals-xx/">Microsoft SQL Server R Services - Internals XX</a></li> <li><a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">Microsoft SQL Server R Services: sp_execute_external_script - I</a></li> <li><a href="/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/">Microsoft SQL Server R Services - sp_execute_external_script - II</a></li> <li><a href="/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/">Microsoft SQL Server R Services: sp_execute_external_script - III</a> <em>last post in the series</em></li> </ol> <p>In this post, and one or two more we will look at what goes on under the covers when we execute some R code inside SQL Server. This post looks at quite in detail what happens in the SQL engine when we execute <code>sp_execute_external_script</code>.</p> <p>To try and get an understanding we'll do something that we did quite a lot back in the day when I worked at Developmentor; we'll <a href="http://queue.acm.org/detail.cfm?id=945136">"spelunk"</a> the SQL Server code via <em>WinDbg</em>. This can be really useful when trying to understand and get to grips with new technology/functionality.</p> <blockquote><p><strong>NOTE:</strong> Developmentor were back in the day THE training company to go to if you wanted highly, highly technical training about COM, .NET, SQL Server, etc. <a href="http://www.javaworld.com/article/2073792/core-java/a-eulogy--developmentor--rip.html">This article</a> by my old colleague <a href="http://blogs.tedneward.com/">Ted Neward</a> (@tedneward) sums DM up quite accurately (apart from the fact that DM hadn't closed its doors when the article was written, ooops).</p></blockquote> <!--more--> <h2>Overview</h2> <p>The first post in the series discussed how to install and enable SQL Server R Services. In there I mentioned how the SQL Server R Services are different from SQLCLR in that the R engine is external to SQL Server, whereas in SQLCLR, CLR is loaded into the same process as the SQL Server engine.</p> <p>So in SQL Server R Services, there must be a way to communicate out of the SQL engine, and into the R engine/runtime, and back into the SQL Server process. Before we'll start trying to figure out what is going on, let's make sure WinDbg is set up.</p> <h2>WinDbg</h2> <p>If you want to follow along with what I did, and you haven't used WinDbg before, this section talks about how to attach to a process etc. If you are used to this, please skip it.</p> <p>In order to use WinDbg, we need to ensure we have the symbol file path set. The easiest is to have the symbol path pointing to Microsoft's Symbol Server. To set things up and also get an introduction to debugging SQL Server with WinDbg, go and read <a href="http://www.sqlpassion.at/archive/2014/05/05/sql-server-debugging-with-windbg-an-introduction/">Klaus Aschenbrenner's (@Aschenbrenner) excellent introduction</a> to the subject.</p> <p>When you want to debug and having the symbol path set you can attach to the SQL Server process, either by doing it as in Klaus' post, or you can attach from within WinDbg:</p> <p><img class="center" src="/images/posts/sql_r_services_windbg_attach_menu.png" width="327" height="150" > <strong>Figure 1:</strong> <em>Attach to Process Menu</em></p> <p>In WinDbg you either choose <em>Attach to a Process</em> from the File menu as in <em>Figure 1</em>, or you click F6. You are then presented with the <em>Attach to Process</em> dialog, where you choose <em>sqlservr.exe</em> as in <em>Figure 2</em>:</p> <p><img class="center" src="/images/posts/sql_r_services_windbg_attach_process.png" width="372" height="128" > <strong>Figure 2:</strong> <em>Attach to Process Dialog</em></p> <blockquote><p><strong>NOTE:</strong> <strong>NEVER, EVER</strong> run WinDbg against a production SQL Server, <strong>NEVER</strong>!!</p></blockquote> <p>When you have attached to the process it can be prudent to reload the symbols for that process, by executing <code>.reload -f sqlservr.exe</code> from the WinDbg command line:</p> <p><img class="center" src="/images/posts/sql_r_services_windbg_reload_symbols.png" width="435" height="179" > <strong>Figure 3:</strong> <em>Reload Symbols</em></p> <p>You should now be good to go.</p> <h2>sp_execute_external_script</h2> <p>We'll start with the procedure <code>sp_execute_external_script</code>. When reading official documentation, it says that the procedure is an extended stored procedure, and, indeed, if we try and do <code>sp_helptext sp_execute_external_script</code>, the result coming back is like so:</p> <p><img class="center" src="/images/posts/sql_r_services_ext_proc.png" width="158" height="68" > <strong>Figure 4:</strong> <em>Result of sp_helptext Against sp_execute_external_script</em></p> <p>The result indicates that this is internal to the server. Let us see if we can find out what happens when executing the proc by using WinDbg.</p> <p>An assumption we'll make is that when we execute the proc, there will be some symbols with a name something like <code>ExternalScript</code> among the various SQL Server modules. So, let us see what we can find. We do it by using the <code>x</code> command from the WinDbg command-line, like so: <code>x *!*ExternalScript*</code> (the "*" denotes a wild-card, like "%" in T-SQL). Whoops, that returned quite a lot of information:</p> <p><img class="center" src="/images/posts/sql_r_services_windbg_extscript_symbols.png" width="650" height="171" > <strong>Figure 5:</strong> <em>Result of Looking for Symbols With ExternalScript in the Name</em></p> <p>OK, but we are probably onto something here. When skimming the result we see that <code>ExternalScript</code> occurs in two modules:</p> <ul> <li><code>sqllang</code> - Implements things to do with T-SQL as well as the query engine.</li> <li><code>sqlmin</code> - Implements things related to the relational engine.</li> </ul> <p>Seeing that it occurs in <code>sqllang</code> and <code>sqllang</code> has to do with T-SQL etc., a fairly solid assumption is that we should look in the <code>sqllang</code> module for anything that has to do with that procedure. So just for giggles, let us execute on the WinDbg command-line the following: <code>x sqllang!*execute*externalscript*</code>:</p> <p><img class="center" src="/images/posts/sql_r_services_windbg_spexecuteextscript.png" width="580" height="67" > <strong>Figure 6:</strong> <em>sqllang!SpExecuteExternalScript</em></p> <p>Cool, we found something that probably is what we are after: <code>SpExecuteExternalScript</code>.</p> <p>To see if our assumption is correct we now set a break-point at <code>SpExecuteExternalScript</code>: <code>bp sqllang!SpExecuteExternalScript</code>. After the breakpoint is set, do not forget to click F5 to continue the process. At this stage we can now execute the <code>sp_execute_external_script</code> procedure and see if the breakpoint was hit:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Execution of Procedure</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="o">@</span><span class="k">language</span> <span class="o">=</span><span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s1">'OutputDataSet&lt;-InputDataSet'</span><span class="p">,</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span><span class="n">N</span><span class="s1">'SELECT 42'</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">(([</span><span class="n">TheAnswer</span><span class="p">]</span> <span class="n">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">));</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Execute sp_execute_external_script</em></p> <p>As can be seen in <em>Figure 7</em> below, the breakpoint is hit. It seems that our assumption is right:</p> <p><img class="center" src="/images/posts/sql_r_services_windbg_hitting_breakpoint.png" width="480" height="85" > <strong>Figure 7:</strong> <em>Hitting the Breakpoint</em></p> <p>When we have hit the breakpoint as in <em>Figure 7</em>, what do we do then? Well, we can always use the <code>k</code> command to look at the call-stack up until the breakpoint:</p> <p><img class="center" src="/images/posts/sql_r_services_windbg_callstack1.png" width="650" height="177" > <strong>Figure 8:</strong> <em>Partial call-stack</em></p> <p><em>Figure 8</em> shows part of the call-stack, and we can see what routines were called leading up to <code>SpExecuteExternalScript</code>. When you have looked at the call-stack you can hit F5, to let the routine complete and you should see a result in the Results tab in SSMS.</p> <p>But we are not really anywhere closer to understand what is going on, except that we know what has been called up until the breakpoint. We are interested in what routines <code>SpExecuteExternalScript</code> calls. To find out about that, there is a command in WinDbg, which allows us to disassemble routines; the <code>uf</code> command. The command signature looks like so: <code>uf [options] &lt;address&gt;</code>, where the address is the routine, and the options define how to display the result. One of the options is <code>/c</code> which displays only the call instructions in a routine. Let's execute <code>uf /c sqllang!SpExecuteExternalScript</code> and see what is being called. Quite a few calls are made and the figure below shows some of them:</p> <p><img class="center" src="/images/posts/sql_r_services_windbg_calls1.png" width="640" height="148" > <strong>Figure 9:</strong> <em>Calls Being Made by SpExecuteExternalScript</em></p> <p>When looking at the calls, there is nothing really that stands out, apart from the <code>sqllang!CSQLSource::Execute (00007ff9 ee237ec0)</code> call. We can assume that, that call takes us further down the "rabbit-hole", and we eventually could figure out what is going on. Tracing down could however take quite a while, so let us try another angle.</p> <blockquote><p><strong>NOTE:</strong> When you have hit a breakpoint in WinDbg you can use a trace command <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff561497(v=vs.85).aspx"><code>wt</code></a> to continue the execution and at the same time print out the calls being made. For a call like <code>SpExecuteExternalScript</code> the output will get very, very large, and also not completely easy to interpret, so we will not use it for <code>SpExecuteExternalScript</code>. We will use it a bit later though .</p></blockquote> <p>What we will do instead is to go back and look at symbols. The assumption is that calls further down the call-chain will have something to do with external scripts, and most likely be executed from within the <code>sqllang</code> module.</p> <p>So let us execute a variant of what we did when finding <code>SpExecuteExternalScript</code>; we'll execute <code>x sqllang!*ExternalScript*</code>. Quite a few routines comes back, I have copied some of the ones that might be of interest to us into the code snippet below:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>ExternalScript Related Classes and Routines</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">0</span><span class="o">:</span><span class="mi">113</span><span class="o">&gt;</span> <span class="n">x</span> <span class="n">sqllang</span><span class="o">!<em></span><span class="n">ExternalScript</span><span class="o"></em></span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PrepareLauncherInfo</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">Open</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">SetupService</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>Result from <code>x sqllang!*ExternalScript*</code></em></p> <p>If you want, you can set breakpoints for the routines in <em>Code Snippet 2</em>, and see if they are hit when executing the code in <em>Code Snippet 1</em>. In my tests they were hit in the following order:</p> <ul> <li>sqllang!SpExecuteExternalScript</li> <li>sqllang!CUDXR_ExternalScript::Open</li> <li>sqllang!CUDXR_ExternalScript::SetupService</li> <li>sqllang!CUDXR_ExternalScript::PrepareLauncherInfo</li> <li>sqllang!CUDXR_ExternalScript::ConnectToSatellite:</li> </ul> <p>No surprise we hit <code>SpExecuteExternalScript</code> first, and I guess at one stage the script has to <code>Open</code>. The question is what the other three routines are doing?</p> <p>In the <em>Overview</em> section in the beginning of this post I wrote how we need to communicate out of SQL Server in order to get to the R runtime. In my <a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">previous post</a>, I mentioned the <em>Launchpad</em> service, and how it acts as a "routing" mechanism between SQL Server and external languages/runtimes.</p> <p>So, somehow SQL Server calls into the launchpad service in order to have the R engine execute the R code. The routines <code>SetupService</code> and <code>PrepareLauncherInfo</code>, has to do with the launchpad service., and we'll shortly have a closer look at what <code>SetupService</code> does. The <code>ConnectToSatellite</code> routine is for when results are coming back into SQL Server from the external runtime.</p> <blockquote><p><strong>NOTE:</strong> Before we go any further, make sure that you are not sitting at a break-point, e.g. hit F5 to let the debugger run.</p></blockquote> <p>What about <code>SetupService</code> then, let us start with disassemble the routine to see what code is being called: <code>uf /c sqllang!CUDXR_ExternalScript::SetupService</code> (all code is not showing, I have copied certain interesting parts):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>SetupService</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">0</span><span class="o">:</span><span class="mi">125</span><span class="o">&gt;</span> <span class="n">uf</span> <span class="o">/</span><span class="n">c</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">SetupService</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">SetupService</span><span class="o">+</span><span class="mh">0xa6</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">77179</span><span class="n">ee6</span><span class="p">)</span><span class="o">:</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">Init</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7763</span><span class="n">bfc0</span><span class="p">)</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">...</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">SetupService</span><span class="o">+</span><span class="mh">0x19c</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">77179</span><span class="n">fdc</span><span class="p">)</span><span class="o">:</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">OpenNpConnection</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7763</span><span class="n">c480</span><span class="p">)</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">...</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">SetupService</span><span class="o">+</span><span class="mh">0x3ab</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7717</span><span class="n">a1eb</span><span class="p">)</span><span class="o">:</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7763</span><span class="n">b140</span><span class="p">)</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">SetupService</span><span class="o">+</span><span class="mh">0x3b5</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7717</span><span class="n">a1f5</span><span class="p">)</span><span class="o">:</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">FreePackets</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7763</span><span class="n">bc70</span><span class="p">)</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 3:</strong> <em>Interesting Calls in SetupService</em></p> <p>When looking at the call in <em>Code Snippet 3</em> we can see the <code>sqllang!CSQLSatelliteCommunication::Init</code> call. That is a call to initialize communication with the launchpad service. Then, somewhat later, there is an <code>OpenNpConnection</code> call. That call opens a named pipe connection to the launchpad service.</p> <p>The <code>WriteMessage</code> call finally sends the message packet to the launchpad service, and <code>FreePackets</code> releases the message packet. To further see what is going on, let's trace what <code>WriteMessage</code> is doing.</p> <p>If you are at a breakpoint right now, F5 out of there and then break into the debugger again, and set a breakpoint at <code>sqllang!CSQLSatelliteConnection::WriteMessage</code>. Execute your T-SQL code again and continue until you hit the breakpoint you just set. When you hit the breakpoint enter the trace command <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff561497(v=vs.85).aspx"><code>wt</code></a>. This will now run through the whole function and display what is being called as well as statistics about how many times etc., routines were called. In the code snippet below I have chosen some of the more interesting calls:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>WriteMessage</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">0</span><span class="o">:</span><span class="mo">013</span><span class="o">&gt;</span> <span class="n">wt</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">Tracing</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span> <span class="n">to</span> <span class="k">return</span> <span class="n">address</span> <span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7717</span><span class="n">a1f0</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="mi">23</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">0</span><span class="p">]</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="p">...</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="mi">30</span>   <span class="mi">109</span> <span class="p">[</span>  <span class="mi">0</span><span class="p">]</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="mi">26</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">1</span><span class="p">]</span>   <span class="n">sqllang</span><span class="o">!</span><span class="n">SNIWriteAsync</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="mi">21</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">2</span><span class="p">]</span>     <span class="n">sqllang</span><span class="o">!</span><span class="n">Np</span><span class="o">::</span><span class="n">WriteAsync</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="mi">32</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">3</span><span class="p">]</span>       <span class="n">sqllang</span><span class="o">!</span><span class="n">Np</span><span class="o">::</span><span class="n">SendPacketAsync</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="mi">30</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>         <span class="n">sqllang</span><span class="o">!</span><span class="n">SNI</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">Transport</span><span class="o">::</span><span class="n">PrepareForAsyncCall</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="mi">40</span>    <span class="mi">30</span> <span class="p">[</span>  <span class="mi">3</span><span class="p">]</span>       <span class="n">sqllang</span><span class="o">!</span><span class="n">Np</span><span class="o">::</span><span class="n">SendPacketAsync</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="mi">1</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>         <span class="n">KERNEL32</span><span class="o">!</span><span class="n">WriteFile</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="mi">37</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>         <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">WriteFile</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="mi">6</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">5</span><span class="p">]</span>           <span class="n">ntdll</span><span class="o">!</span><span class="n">ZwWriteFile</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="mi">51</span>     <span class="mi">6</span> <span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>        <span class="p">...</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="mi">34</span>   <span class="mi">230</span> <span class="p">[</span>  <span class="mi">1</span><span class="p">]</span>   <span class="n">sqllang</span><span class="o">!</span><span class="n">SNIWriteAsync</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="p">...</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 4:</strong> <em>Tracing WriteMessage</em></p> <p>In <em>Code Snippet 4</em> we see <code>WriteAsync</code>, <code>SendPacketAsync</code> and <code>WriteFile</code> is being called. At this stage, the packet has now been sent to the launchpad service. Before you let the process continue, disable the <code>WriteMessage</code> breakpoint, as it will be called when the result returns from R.</p> <p>To make really sure that what we think happens actually happens we can do a last test, involving <em>Launchpad.exe</em>. In the next post in this series we will look at what happens in the launchpad service in more detail, but for now let us just do a simple test:</p> <ul> <li>Open a second instance of WinDbg and attach to the <em>Launchpad.exe</em> process.</li> <li>Reload the launchpad symbols: <code>.reload -f launchpad.exe</code>.</li> <li>Set a breakpoint like so: <code>bp launchpad!CLaunchContext::Launch</code></li> <li>In the WinDbg instance for the SQL Server process set breakpoints at: <ul> <li>sqllang!CUDXR_ExternalScript::SetupService</li> <li>sqllang!CSQLSatelliteConnection::WriteMessage</li> <li>sqllang!CUDXR_ExternalScript::ConnectToSatellite</li> </ul> </li> <li>Ensure that all other breakpoints for the SQL Server process are disabled</li> <li>Make sure that both processes are running (i.e. not sitting in break mode).</li> </ul> <p>Execute the T-SQL code and notice what happens (you need to press F5 after hitting each breakpoint):</p> <ul> <li>You hit the breakpoint in the SQL Server process at <code>SetupService</code>.</li> <li>You hit the breakpoint in the SQL Server process at <code>WriteMessage</code>.</li> <li>You now hit the <code>Launch</code> breakpoint in the launchpad process.</li> <li>You are back in the SQL Server process at the <code>ConnectToSatellite</code> breakpoint.</li> </ul> <p>After you have pressed F5 at the <code>ConnectToSatellite</code> breakpoint you will hit the <code>WriteMessage</code> breakpoint quite a few times when the result comes back from R.</p> <h2>Summary</h2> <p><strong>UPDATE &amp; EDIT:</strong> To make the summary more "readable" I have added <em>Figure 10</em> and rearranged (and added) some text.</p> <p>Through our "spelunking", we have seen in somewhat detail what happens in the SQL Server engine when we execute <code>sp_execute_external_script</code>. <em>Figure 10</em> below shows from a very high level what goes on in the SQL Server engine:</p> <p><img class="center" src="/images/posts/sql-launchpad_post.png" width="650" height="241" > <strong>Figure 10:</strong> <em>Call Flow Executing sp_execute_external_script</em></p> <p>Following the flow in <em>Figure 10</em>, when executing <code>sp_execute_external_script</code>:</p> <ol> <li>EXEC <code>sp_execute_external_script</code>.</li> <li>Comes into the SQL Server process, and workers, schedulers, tasks, etc., comes into play.</li> <li>Eventually <code>sqllang!CSQLSource::Execute</code> is called (first invocation - not the one shown in <em>Figure 9</em>).</li> <li>Our friend <code>sqllang!SpExecuteExternalScript</code> is called.</li> <li>The external script is opened in <code>sqllang!CUDXR_ExternalScript::Open</code>.</li> <li>Things are hotting up and <code>sqllang!CUDXR_ExternalScript::SetupService</code> is hit.</li> <li>A named pipe connection to the launchpad service is opened in <code>sqllang!CSQLSatelliteConnection::OpenNpConnection</code>.</li> <li>A message containing the R scrips is written to the launchpad service in <code>sqllang!CSQLSatelliteConnection::WriteMessage</code>.</li> <li>That message eventually ends up in the launchpad process in <code>launchpad!CLaunchContext::Launch</code>.</li> </ol> <p>In between the calls mentioned, a lot of other calls are also made, but from a high level - this is what happens.</p> <p>If you have followed along, you can now go off and do your own "spelunking". In next post in this series we will look at what happens in the launchpad service in more detail.</p> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/&text=Microsoft SQL Server R Services - Internals I&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/03/18/microsoft-sql-server-r-services-internals-i/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/ &title=Microsoft SQL Server R Services - Internals I &summary=Blog post: SQL Server R Services series. Today we look at what happen in the SQL Server engine when we execute sp_execute_external_script. &source=http://www.nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> <br/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad2 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="1158080725" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2018/07/22/interesting-stuff-week-29/"> Interesting Stuff - Week 29 <small> (22 Jul 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/07/15/interesting-stuff-week-28/"> Interesting Stuff - Week 28 <small> (15 Jul 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/07/08/interesting-stuff-week-27/"> Interesting Stuff - Week 27 <small> (08 Jul 2018)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
