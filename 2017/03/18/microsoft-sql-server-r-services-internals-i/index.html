<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Microsoft SQL Server R Services - Internals I &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Microsoft SQL Server R Services - Internals I</h1>
  <div class="post-subheading">
  <span class="post-date">18 Mar 2017</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>This is the second post in a series about <strong>Microsoft SQL Server R Services</strong>, and the first post that drills down into the internal of how it works. To see other posts (including this) in the series, go to <a href="/series/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a>.</p>

<p>In this post, and one or two more we will look at what goes on under the covers when we execute some R code inside SQL Server. This post looks at quite in detail what happens in the SQL engine when we execute <code class="highlighter-rouge">sp_execute_external_script</code>.</p>

<p>To try and get an understanding we’ll do something that we did quite a lot back in the day when I worked at Developmentor; we’ll <a href="http://queue.acm.org/detail.cfm?id=945136">“spelunk”</a> the SQL Server code via <em>WinDbg</em>. This can be really useful when trying to understand and get to grips with new technology/functionality.</p>

<blockquote>
  <p><strong>NOTE:</strong> Developmentor were back in the day THE training company to go to if you wanted highly, highly technical training about COM, .NET, SQL Server, etc. <a href="http://www.javaworld.com/article/2073792/core-java/a-eulogy--developmentor--rip.html">This article</a> by my old colleague <a href="http://blogs.tedneward.com/">Ted Neward</a> (@tedneward) sums DM up quite accurately (apart from the fact that DM hadn’t closed its doors when the article was written, ooops).</p>
</blockquote>

<!--more-->

<h2 id="overview">Overview</h2>

<p>The first post in the series discussed how to install and enable SQL Server R Services. In there I mentioned how the SQL Server R Services are different from SQLCLR in that the R engine is external to SQL Server, whereas in SQLCLR, CLR is loaded into the same process as the SQL Server engine.</p>

<p>So in SQL Server R Services, there must be a way to communicate out of the SQL engine, and into the R engine/runtime, and back into the SQL Server process. Before we’ll start trying to figure out what is going on, let’s make sure WinDbg is set up.</p>

<h2 id="windbg">WinDbg</h2>

<p>If you want to follow along with what I did, and you haven’t used WinDbg before, this section talks about how to attach to a process etc. If you are used to this, please skip it.</p>

<p>In order to use WinDbg, we need to ensure we have the symbol file path set. The easiest is to have the symbol path pointing to Microsoft’s Symbol Server. To set things up and also get an introduction to debugging SQL Server with WinDbg, go and read <a href="http://www.sqlpassion.at/archive/2014/05/05/sql-server-debugging-with-windbg-an-introduction/">Klaus Aschenbrenner’s (@Aschenbrenner) excellent introduction</a> to the subject.</p>

<p>When you want to debug and having the symbol path set you can attach to the SQL Server process, either by doing it as in Klaus’ post, or you can attach from within WinDbg:</p>

<p><img src="/images/posts/sql_r_services_windbg_attach_menu.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Attach to Process Menu</em></p>

<p>In WinDbg you either choose <em>Attach to a Process</em> from the File menu as in <em>Figure 1</em>, or you click F6. You are then presented with the <em>Attach to Process</em> dialog, where you choose <em>sqlservr.exe</em> as in <em>Figure 2</em>:</p>

<p><img src="/images/posts/sql_r_services_windbg_attach_process.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>Attach to Process Dialog</em></p>

<blockquote>
  <p><strong>NOTE:</strong> <strong>NEVER, EVER</strong> run WinDbg against a production SQL Server, <strong>NEVER</strong>!!</p>
</blockquote>

<p>When you have attached to the process it can be prudent to reload the symbols for that process, by executing <code class="highlighter-rouge">.reload -f sqlservr.exe</code> from the WinDbg command line:</p>

<p><img src="/images/posts/sql_r_services_windbg_reload_symbols.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>Reload Symbols</em></p>

<p>You should now be good to go.</p>

<h2 id="sp_execute_external_script">sp_execute_external_script</h2>

<p>We’ll start with the procedure <code class="highlighter-rouge">sp_execute_external_script</code>. When reading official documentation, it says that the procedure is an extended stored procedure, and, indeed, if we try and do <code class="highlighter-rouge">sp_helptext sp_execute_external_script</code>, the result coming back is like so:</p>

<p><img src="/images/posts/sql_r_services_ext_proc.png" alt="" /></p>

<p><strong>Figure 4:</strong> <em>Result of sp_helptext Against sp_execute_external_script</em></p>

<p>The result indicates that this is internal to the server. Let us see if we can find out what happens when executing the proc by using WinDbg.</p>

<p>An assumption we’ll make is that when we execute the proc, there will be some symbols with a name something like <code class="highlighter-rouge">ExternalScript</code> among the various SQL Server modules. So, let us see what we can find. We do it by using the <code class="highlighter-rouge">x</code> command from the WinDbg command-line, like so: <code class="highlighter-rouge">x *!*ExternalScript*</code> (the “*” denotes a wild-card, like “%” in T-SQL). Whoops, that returned quite a lot of information:</p>

<p><img src="/images/posts/sql_r_services_windbg_extscript_symbols.png" alt="" /></p>

<p><strong>Figure 5:</strong> <em>Result of Looking for Symbols With ExternalScript in the Name</em></p>

<p>OK, but we are probably onto something here. When skimming the result we see that <code class="highlighter-rouge">ExternalScript</code> occurs in two modules:</p>

<ul>
  <li><code class="highlighter-rouge">sqllang</code> - Implements things to do with T-SQL as well as the query engine.</li>
  <li><code class="highlighter-rouge">sqlmin</code> - Implements things related to the relational engine.</li>
</ul>

<p>Seeing that it occurs in <code class="highlighter-rouge">sqllang</code> and <code class="highlighter-rouge">sqllang</code> has to do with T-SQL etc., a fairly solid assumption is that we should look in the <code class="highlighter-rouge">sqllang</code> module for anything that has to do with that procedure. So just for giggles, let us execute on the WinDbg command-line the following: <code class="highlighter-rouge">x sqllang!*execute*externalscript*</code>:</p>

<p><img src="/images/posts/sql_r_services_windbg_spexecuteextscript.png" alt="" /></p>

<p><strong>Figure 6:</strong> <em>sqllang!SpExecuteExternalScript</em></p>

<p>Cool, we found something that probably is what we are after: <code class="highlighter-rouge">SpExecuteExternalScript</code>.</p>

<p>To see if our assumption is correct we now set a break-point at <code class="highlighter-rouge">SpExecuteExternalScript</code>: <code class="highlighter-rouge">bp sqllang!SpExecuteExternalScript</code>. After the breakpoint is set, do not forget to click F5 to continue the process. At this stage we can now execute the <code class="highlighter-rouge">sp_execute_external_script</code> procedure and see if the breakpoint was hit:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span> 
                    <span class="o">@</span><span class="k">language</span> <span class="o">=</span><span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
                    <span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s1">'OutputDataSet&lt;-InputDataSet'</span><span class="p">,</span>
                    <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span><span class="n">N</span><span class="s1">'SELECT 42'</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">(([</span><span class="n">TheAnswer</span><span class="p">]</span> <span class="n">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">));</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Execute sp_execute_external_script</em></p>

<p>As can be seen in <em>Figure 7</em> below, the breakpoint is hit. It seems that our assumption is right:</p>

<p><img src="/images/posts/sql_r_services_windbg_hitting_breakpoint.png" alt="" /></p>

<p><strong>Figure 7:</strong> <em>Hitting the Breakpoint</em></p>

<p>When we have hit the breakpoint as in <em>Figure 7</em>, what do we do then? Well, we can always use the <code class="highlighter-rouge">k</code> command to look at the call-stack up until the breakpoint:</p>

<p><img src="/images/posts/sql_r_services_windbg_callstack1.png" alt="" /></p>

<p><strong>Figure 8:</strong> <em>Partial call-stack</em></p>

<p><em>Figure 8</em> shows part of the call-stack, and we can see what routines were called leading up to <code class="highlighter-rouge">SpExecuteExternalScript</code>. When you have looked at the call-stack you can hit F5, to let the routine complete and you should see a result in the Results tab in SSMS.</p>

<p>But we are not really anywhere closer to understand what is going on, except that we know what has been called up until the breakpoint. We are interested in what routines <code class="highlighter-rouge">SpExecuteExternalScript</code> calls. To find out about that, there is a command in WinDbg, which allows us to disassemble routines; the <code class="highlighter-rouge">uf</code> command. The command signature looks like so: <code class="highlighter-rouge">uf [options] &lt;address&gt;</code>, where the address is the routine, and the options define how to display the result. One of the options is <code class="highlighter-rouge">/c</code> which displays only the call instructions in a routine. Let’s execute <code class="highlighter-rouge">uf /c sqllang!SpExecuteExternalScript</code> and see what is being called. Quite a few calls are made and the figure below shows some of them:</p>

<p><img src="/images/posts/sql_r_services_windbg_calls1.png" alt="" /></p>

<p><strong>Figure 9:</strong> <em>Calls Being Made by SpExecuteExternalScript</em></p>

<p>When looking at the calls, there is nothing really that stands out, apart from the <code class="highlighter-rouge">sqllang!CSQLSource::Execute (00007ff9 ee237ec0)</code> call. We can assume that, that call takes us further down the “rabbit-hole”, and we eventually could figure out what is going on. Tracing down could however take quite a while, so let us try another angle.</p>

<blockquote>
  <p><strong>NOTE:</strong> When you have hit a breakpoint in WinDbg you can use a trace command <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff561497(v=vs.85).aspx"><code class="highlighter-rouge">wt</code></a> to continue the execution and at the same time print out the calls being made. For a call like <code class="highlighter-rouge">SpExecuteExternalScript</code> the output will get very, very large, and also not completely easy to interpret, so we will not use it for <code class="highlighter-rouge">SpExecuteExternalScript</code>. We will use it a bit later though .</p>
</blockquote>

<p>What we will do instead is to go back and look at symbols. The assumption is that calls further down the call-chain will have something to do with external scripts, and most likely be executed from within the <code class="highlighter-rouge">sqllang</code> module.</p>

<p>So let us execute a variant of what we did when finding <code class="highlighter-rouge">SpExecuteExternalScript</code>; we’ll execute <code class="highlighter-rouge">x sqllang!*ExternalScript*</code>. Quite a few routines comes back, I have copied some of the ones that might be of interest to us into the code snippet below:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0</span><span class="o">:</span><span class="mi">113</span><span class="o">&gt;</span> <span class="n">x</span> <span class="n">sqllang</span><span class="o">!*</span><span class="n">ExternalScript</span><span class="o">*</span>

<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PrepareLauncherInfo</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>

<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>

<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">Open</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>

<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">SetupService</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>

</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Result from <code class="highlighter-rouge">x sqllang!*ExternalScript*</code></em></p>

<p>If you want, you can set breakpoints for the routines in <em>Code Snippet 2</em>, and see if they are hit when executing the code in <em>Code Snippet 1</em>. In my tests they were hit in the following order:</p>

<ul>
  <li>sqllang!SpExecuteExternalScript</li>
  <li>sqllang!CUDXR_ExternalScript::Open</li>
  <li>sqllang!CUDXR_ExternalScript::SetupService</li>
  <li>sqllang!CUDXR_ExternalScript::PrepareLauncherInfo</li>
  <li>sqllang!CUDXR_ExternalScript::ConnectToSatellite:</li>
</ul>

<p>No surprise we hit <code class="highlighter-rouge">SpExecuteExternalScript</code> first, and I guess at one stage the script has to <code class="highlighter-rouge">Open</code>. The question is what the other three routines are doing?</p>

<p>In the <em>Overview</em> section in the beginning of this post I wrote how we need to communicate out of SQL Server in order to get to the R runtime. In my <a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">previous post</a>, I mentioned the <em>Launchpad</em> service, and how it acts as a “routing” mechanism between SQL Server and external languages/runtimes.</p>

<p>So, somehow SQL Server calls into the launchpad service in order to have the R engine execute the R code. The routines <code class="highlighter-rouge">SetupService</code> and <code class="highlighter-rouge">PrepareLauncherInfo</code>, has to do with the launchpad service., and we’ll shortly have a closer look at what <code class="highlighter-rouge">SetupService</code> does. The <code class="highlighter-rouge">ConnectToSatellite</code> routine is for when results are coming back into SQL Server from the external runtime.</p>

<blockquote>
  <p><strong>NOTE:</strong> Before we go any further, make sure that you are not sitting at a break-point, e.g. hit F5 to let the debugger run.</p>
</blockquote>

<p>What about <code class="highlighter-rouge">SetupService</code> then, let us start with disassemble the routine to see what code is being called: <code class="highlighter-rouge">uf /c sqllang!CUDXR_ExternalScript::SetupService</code> (all code is not showing, I have copied certain interesting parts):</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0</span><span class="o">:</span><span class="mi">125</span><span class="o">&gt;</span> <span class="n">uf</span> <span class="o">/</span><span class="n">c</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">SetupService</span>

<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">SetupService</span><span class="o">+</span><span class="mh">0xa6</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">77179</span><span class="n">ee6</span><span class="p">)</span><span class="o">:</span>
  <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">Init</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7763</span><span class="n">bfc0</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">SetupService</span><span class="o">+</span><span class="mh">0x19c</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">77179</span><span class="n">fdc</span><span class="p">)</span><span class="o">:</span>
  <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">OpenNpConnection</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7763</span><span class="n">c480</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">SetupService</span><span class="o">+</span><span class="mh">0x3ab</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7717</span><span class="n">a1eb</span><span class="p">)</span><span class="o">:</span>
  <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7763</span><span class="n">b140</span><span class="p">)</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">SetupService</span><span class="o">+</span><span class="mh">0x3b5</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7717</span><span class="n">a1f5</span><span class="p">)</span><span class="o">:</span>
  <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">FreePackets</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7763</span><span class="n">bc70</span><span class="p">)</span>
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Interesting Calls in SetupService</em></p>

<p>When looking at the call in <em>Code Snippet 3</em> we can see the <code class="highlighter-rouge">sqllang!CSQLSatelliteCommunication::Init</code> call. That is a call to initialize communication with the launchpad service. Then, somewhat later, there is an <code class="highlighter-rouge">OpenNpConnection</code> call. That call opens a named pipe connection to the launchpad service.</p>

<p>The <code class="highlighter-rouge">WriteMessage</code> call finally sends the message packet to the launchpad service, and <code class="highlighter-rouge">FreePackets</code> releases the message packet. To further see what is going on, let’s trace what <code class="highlighter-rouge">WriteMessage</code> is doing.</p>

<p>If you are at a breakpoint right now, F5 out of there and then break into the debugger again, and set a breakpoint at <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code>. Execute your T-SQL code again and continue until you hit the breakpoint you just set. When you hit the breakpoint enter the trace command <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff561497(v=vs.85).aspx"><code class="highlighter-rouge">wt</code></a>. This will now run through the whole function and display what is being called as well as statistics about how many times etc., routines were called. In the code snippet below I have chosen some of the more interesting calls:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0</span><span class="o">:</span><span class="mo">013</span><span class="o">&gt;</span> <span class="n">wt</span>
<span class="n">Tracing</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span> <span class="n">to</span> <span class="k">return</span> <span class="n">address</span> <span class="mo">00007</span><span class="n">ff8</span> <span class="mi">7717</span><span class="n">a1f0</span>
   <span class="mi">23</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">0</span><span class="p">]</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span>
   <span class="p">...</span>
   <span class="mi">30</span>   <span class="mi">109</span> <span class="p">[</span>  <span class="mi">0</span><span class="p">]</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span>
   <span class="mi">26</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">1</span><span class="p">]</span>   <span class="n">sqllang</span><span class="o">!</span><span class="n">SNIWriteAsync</span>
   <span class="mi">21</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">2</span><span class="p">]</span>     <span class="n">sqllang</span><span class="o">!</span><span class="n">Np</span><span class="o">::</span><span class="n">WriteAsync</span>
   <span class="mi">32</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">3</span><span class="p">]</span>       <span class="n">sqllang</span><span class="o">!</span><span class="n">Np</span><span class="o">::</span><span class="n">SendPacketAsync</span>
   <span class="mi">30</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>         <span class="n">sqllang</span><span class="o">!</span><span class="n">SNI</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">Transport</span><span class="o">::</span><span class="n">PrepareForAsyncCall</span>
   <span class="mi">40</span>    <span class="mi">30</span> <span class="p">[</span>  <span class="mi">3</span><span class="p">]</span>       <span class="n">sqllang</span><span class="o">!</span><span class="n">Np</span><span class="o">::</span><span class="n">SendPacketAsync</span>
    <span class="mi">1</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>         <span class="n">KERNEL32</span><span class="o">!</span><span class="n">WriteFile</span>
   <span class="mi">37</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>         <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">WriteFile</span>
    <span class="mi">6</span>     <span class="mi">0</span> <span class="p">[</span>  <span class="mi">5</span><span class="p">]</span>           <span class="n">ntdll</span><span class="o">!</span><span class="n">ZwWriteFile</span>
   <span class="mi">51</span>     <span class="mi">6</span> <span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>        <span class="p">...</span>
   <span class="mi">34</span>   <span class="mi">230</span> <span class="p">[</span>  <span class="mi">1</span><span class="p">]</span>   <span class="n">sqllang</span><span class="o">!</span><span class="n">SNIWriteAsync</span>
   <span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 4:</strong> <em>Tracing WriteMessage</em></p>

<p>In <em>Code Snippet 4</em> we see <code class="highlighter-rouge">WriteAsync</code>, <code class="highlighter-rouge">SendPacketAsync</code> and <code class="highlighter-rouge">WriteFile</code> is being called. At this stage, the packet has now been sent to the launchpad service. Before you let the process continue, disable the <code class="highlighter-rouge">WriteMessage</code> breakpoint, as it will be called when the result returns from R.</p>

<p>To make really sure that what we think happens actually happens we can do a last test, involving <em>Launchpad.exe</em>. In the next post in this series we will look at what happens in the launchpad service in more detail, but for now let us just do a simple test:</p>

<ul>
  <li>Open a second instance of WinDbg and attach to the <em>Launchpad.exe</em> process.</li>
  <li>Reload the launchpad symbols: <code class="highlighter-rouge">.reload -f launchpad.exe</code>.</li>
  <li>Set a breakpoint like so: <code class="highlighter-rouge">bp launchpad!CLaunchContext::Launch</code></li>
  <li>In the WinDbg instance for the SQL Server process set breakpoints at:
    <ul>
      <li>sqllang!CUDXR_ExternalScript::SetupService</li>
      <li>sqllang!CSQLSatelliteConnection::WriteMessage</li>
      <li>sqllang!CUDXR_ExternalScript::ConnectToSatellite</li>
    </ul>
  </li>
  <li>Ensure that all other breakpoints for the SQL Server process are disabled</li>
  <li>Make sure that both processes are running (i.e. not sitting in break mode).</li>
</ul>

<p>Execute the T-SQL code and notice what happens (you need to press F5 after hitting each breakpoint):</p>

<ul>
  <li>You hit the breakpoint in the SQL Server process at <code class="highlighter-rouge">SetupService</code>.</li>
  <li>You hit the breakpoint in the SQL Server process at <code class="highlighter-rouge">WriteMessage</code>.</li>
  <li>You now hit the <code class="highlighter-rouge">Launch</code> breakpoint in the launchpad process.</li>
  <li>You are back in the SQL Server process at the <code class="highlighter-rouge">ConnectToSatellite</code> breakpoint.</li>
</ul>

<p>After you have pressed F5 at the <code class="highlighter-rouge">ConnectToSatellite</code> breakpoint you will hit the <code class="highlighter-rouge">WriteMessage</code> breakpoint quite a few times when the result comes back from R.</p>

<h2 id="summary">Summary</h2>

<p><strong>UPDATE &amp; EDIT:</strong> To make the summary more “readable” I have added <em>Figure 10</em> and rearranged (and added) some text.</p>

<p>Through our “spelunking”, we have seen in somewhat detail what happens in the SQL Server engine when we execute <code class="highlighter-rouge">sp_execute_external_script</code>. <em>Figure 10</em> below shows from a very high level what goes on in the SQL Server engine:</p>

<p><img src="/images/posts/sql-launchpad_post.png" alt="" /></p>

<p><strong>Figure 10:</strong> <em>Call Flow Executing sp_execute_external_script</em></p>

<p>Following the flow in <em>Figure 10</em>, when executing <code class="highlighter-rouge">sp_execute_external_script</code>:</p>

<ol>
  <li>EXEC <code class="highlighter-rouge">sp_execute_external_script</code>.</li>
  <li>Comes into the SQL Server process, and workers, schedulers, tasks, etc., comes into play.</li>
  <li>Eventually <code class="highlighter-rouge">sqllang!CSQLSource::Execute</code> is called (first invocation - not the one shown in <em>Figure 9</em>).</li>
  <li>Our friend <code class="highlighter-rouge">sqllang!SpExecuteExternalScript</code> is called.</li>
  <li>The external script is opened in <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::Open</code>.</li>
  <li>Things are hotting up and <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::SetupService</code> is hit.</li>
  <li>A named pipe connection to the launchpad service is opened in <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::OpenNpConnection</code>.</li>
  <li>A message containing the R scrips is written to the launchpad service in <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code>.</li>
  <li>That message eventually ends up in the launchpad process in <code class="highlighter-rouge">launchpad!CLaunchContext::Launch</code>.</li>
</ol>

<p>In between the calls mentioned, a lot of other calls are also made, but from a high level - this is what happens.</p>

<p>If you have followed along, you can now go off and do your own “spelunking”. In next post in this series we will look at what happens in the launchpad service in more detail.</p>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/&text=Microsoft SQL Server R Services - Internals I&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/03/18/microsoft-sql-server-r-services-internals-i/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/
         &title=Microsoft SQL Server R Services - Internals I
         &summary=Blog post: SQL Server R Services series. Today we look at what happen in the SQL Server engine when we execute sp_execute_external_script.
         &source=http://www.nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-machine-learning-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Machine Learning Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#windbg">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WinDbg</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2017/03/18/microsoft-sql-server-r-services-internals-i/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/07/29/interesting-stuff-week-30/">
            Interesting Stuff - Week 30
            <small>29 Jul 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
