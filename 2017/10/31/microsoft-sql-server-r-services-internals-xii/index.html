<!DOCTYPE html> <html lang="en-us"> <head> <!-- Google Tag Manager --> <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-K7B3642');</script> <!-- End Google Tag Manager --> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="More about the TCP/IPpackets sent from SQL Server to SqlSatellite."> <meta name="keywords" content="SQL Server R Services, SQL Server Machine Learning Services, R, WinDbg, Launchpad, SqlSatellite"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Microsoft SQL Server R Services - Internals XII &middot; Niels Berglund </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-d361e701e0c0e75e121ac3e901cff1b8.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.5.0 --> <title>Microsoft SQL Server R Services - Internals XII | Niels Berglund</title> <meta name="generator" content="Jekyll v3.8.2" /> <meta property="og:title" content="Microsoft SQL Server R Services - Internals XII" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="More about the TCP/IPpackets sent from SQL Server to SqlSatellite." /> <meta property="og:description" content="More about the TCP/IPpackets sent from SQL Server to SqlSatellite." /> <link rel="canonical" href="http://nielsberglund.com/2017/10/31/microsoft-sql-server-r-services-internals-xii/" /> <meta property="og:url" content="http://nielsberglund.com/2017/10/31/microsoft-sql-server-r-services-internals-xii/" /> <meta property="og:site_name" content="Niels Berglund" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2017-10-31T19:57:36+02:00" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"http://nielsberglund.com/2017/10/31/microsoft-sql-server-r-services-internals-xii/","headline":"Microsoft SQL Server R Services - Internals XII","dateModified":"2017-10-31T19:57:36+02:00","datePublished":"2017-10-31T19:57:36+02:00","author":{"@type":"Person","name":"nielsb"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://nielsberglund.com/2017/10/31/microsoft-sql-server-r-services-internals-xii/"},"description":"More about the TCP/IPpackets sent from SQL Server to SqlSatellite.","@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-3005153158271538", enable_page_level_ads: true }); </script> </head> <body> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K7B3642" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) --> <div class="sidebar"> <div class="container"> <div class="sidebar-about"> <h1> <a href="/"> Niels Berglund </a> </h1> <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Sidebar_rectangle --> <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-3005153158271538" data-ad-slot="7704601332"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/disclaimer/">Disclaimer</a> <a class="sidebar-nav-item" href="/series/">Blog Post Series</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <img class="center" src="/images/MVP_Logo_large.png" width="300" height="121" > <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <p>&copy; 2018. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">Microsoft SQL Server R Services - Internals XII</h1> <div class="post-subheading"> <span class="post-date">31 Oct 2017</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#Microsoft R Server">Microsoft R Server</a> <a href="/categories/#Data Science">Data Science</a> <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a> <a href="/categories/#SQL Server R Services">SQL Server R Services</a> <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server R Services">SQL Server R Services</a> <a href="/tags/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <a href="/tags/#R">R</a> <a href="/tags/#WinDbg">WinDbg</a> <a href="/tags/#Launchpad">Launchpad</a> <a href="/tags/#SqlSatellite">SqlSatellite</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> <p>This post is part of a series of blog-posts about Microsoft SQL Server R Services:</p> <ol> <li><a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">Microsoft SQL Server 2016 R Services Installation</a></li> <li><a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Microsoft SQL Server R Services - Internals I</a></li> <li><a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Microsoft SQL Server R Services - Internals II</a></li> <li><a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Microsoft SQL Server R Services - Internals III</a></li> <li><a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Microsoft SQL Server R Services - Internals IV</a></li> <li><a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Microsoft SQL Server R Services - Internals V</a></li> <li><a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Microsoft SQL Server R Services - Internals VI</a></li> <li><a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Microsoft SQL Server R Services - Internals VII</a></li> <li><a href="/2017/07/22/microsoft-sql-server-r-services-internals-viii/">Microsoft SQL Server R Services - Internals VIII</a></li> <li><a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Microsoft SQL Server R Services - Internals IX</a></li> <li><a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Microsoft SQL Server R Services - Internals X</a></li> <li><a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">Microsoft SQL Server R Services - Internals XI</a></li> <li>Microsoft SQL Server R Services - Internals XII (this post)</li> <li><a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">Microsoft SQL Server R Services - Internals XIII</a></li> <li><a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Microsoft SQL Server R Services - Internals XIV</a></li> <li><a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Microsoft SQL Server R Services - Internals XV</a></li> <li><a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Microsoft SQL Server R Services - Internals XVI</a></li> <li><a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Microsoft SQL Server R Services - Internals XVII</a></li> <li><a href="/2018/01/10/microsoft-sql-server-r-services-internals-xviii/">Microsoft SQL Server R Services - Internals XVIII</a></li> <li><a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Microsoft SQL Server R Services - Internals XIX</a></li> <li><a href="/2018/02/02/microsoft-sql-server-r-services-internals-xx/">Microsoft SQL Server R Services - Internals XX</a></li> <li><a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">Microsoft SQL Server R Services: sp_execute_external_script - I</a></li> <li><a href="/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/">Microsoft SQL Server R Services - sp_execute_external_script - II</a></li> <li><a href="/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/">Microsoft SQL Server R Services: sp_execute_external_script - III</a> <em>last post in the series</em></li> </ol> <p>This post is the 13:th post about Microsoft SQL Server R Services, and the 12:th post that drills down into the internal of how it works.</p> <p>The last few posts in this series has been about communication between SQL Server and SqlSatellite. We have discussed the connection between the two, and we have also seen how packets are sent from SQL Server to SqlSatellite. In this post we'll continue looking at what causes the packets to be send and what sends them. We will specifically look at the packet containing the external script, as well as the packet that contains the data (<code>@input_data_set_1</code>).</p> <!--more--> <h2>Recap</h2> <p>In <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a>, we executed code looking like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Code</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">exec</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(30)
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                 d&lt;-42'</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>               <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>              SELECT TOP(1) y, rand1, rand2, rand3,
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                      rand4, rand5
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>              FROM dbo.rand_1M'</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>External Script with Data Select</em></p> <p>When executing the code in <em>Code Snippet 1</em>, and filtering on TCP event in <em>Process Monitor</em>, the output from the filtering looked like below:</p> <p><img class="center" src="/images/posts/sql_r_services_10_procmon_output3.png" width="648" height="241" > <strong>Figure 1:</strong> <em>Process Monitor Output Data Select</em></p> <p>By using <em>WireShark</em> we determined that the two highlighted packets (length 350, and 6300 respectively) contained the external script (packet with length 350), and the result from the <code>SELECT</code> (length 6300). We could however not determine what the two initial packets were, and what caused them to be sent - and in <a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">Internals - XI</a> we set out to try to find out more about those packets.</p> <p>By doing some <em>WinDbg</em> <a href="http://queue.acm.org/detail.cfm?id=945136">"spelunking"</a> we found out that the two packets are sent during authentication between SQL Server and the SqlSatellite and they are sent inside the <code>sqllang!CSQLSatelliteConnection::AuthenticateConnection</code> routine. The flow of calls can be illustrated as in the figure below:</p> <p><img class="center" src="/images/posts/sql_r_services_11_calls.png" width="800" height="532" > <strong>Figure 2:</strong> <em>Flow in SQL Server</em></p> <p>It is worth noting that the second <code>WriteAsync</code> is done on a separate thread from the first, but still within the <code>AuthenticateConnection</code> routine. We now know what causes the two first packets to be sent, and what routines are involved. We also know what the two following packets are for (script and data), but we do not know what routines are involved (other than <code>WriteMessage</code>), and we definitely don't know what the two packets with a length of 28 is for. As mentioned in the beginning of this post, this is now what we will try and figure out.</p> <h2>Helper Tools</h2> <p>To help us figure out the things we want, we will use <em>WinDbg</em> and <em>Process Monitor</em>. In the case of <em>Process Monitor</em>, we'll use it to filter TCP traffic. If you want to refresh your memory about how to do it, we covered that in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a>.</p> <h4>WinDbg</h4> <p>We have used <em>WinDbg</em> throughout this series, and in <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I</a> we discussed how to set it up etc. The <em>WinDbg</em> we have used up until now is the "classic" <em>WinDbg</em>, that has been available throughout the years. In August Microsoft released a preview version of a more modern <a href="https://www.microsoft.com/en-us/store/p/windbg/9pgjgd53tn86"><em>WinDbg</em> application</a>.</p> <p>It has been updated to have more modern visuals, faster windows, a full-fledged scripting experience, and Time Travel Debugging (whatever that is):</p> <p><img class="center" src="/images/posts/sql_r_services_12_windbg1.jpg" width="471" height="308" > <strong>Figure 3:</strong> <em>New WinDbg</em></p> <p>So, going forward in this series, the new <em>WinDbg</em> is the debugger I'll use.</p> <h2>Script Packets</h2> <p>Let us first start with the script packets, and the code we'll use for this is what we also used in <a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">Internals - XI</a>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Code</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">exec</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(30)
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                 d&lt;-42'</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>Basic External Script</em></p> <p>The reason for using simple code like in <em>Code Snippet 1</em>, is that it might make it easier to understand what is happening, and we can compare with what is happening when executing some other, not so basic, code. Notice how in <em>Code Snippet 2</em> there is a <code>Sys.sleep</code>. It is there to make it easier to determine - when debugging - when data is sent to R and when data is coming back.</p> <p>Before executing the code in <em>Code Snippet 2</em>:</p> <ul> <li>start up <em>Process Monitor</em> and run it as admin</li> <li>set up the filters we used in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a>.</li> </ul> <p>After <em>Process Monitor</em> has been set up, you can execute the code. When you execute, look closely at the <em>Process Monitor</em> output, especially what it looks like at the time you hit <code>Sys.sleep</code>. After execution the output should look like so:</p> <p><img class="center" src="/images/posts/sql_r_services_12_procmon1.png" width="660" height="211" > <strong>Figure 4:</strong> <em>Process Monitor Output</em></p> <p>The red line in <em>Figure 4</em> illustrates where <code>Sys.sleep</code> happens. Now let us drill down into the two packets with length 204 and the packet with a length of 28. As we did in Internals - <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">X</a> and <a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">XI</a>, we'll set some breakpoints in <em>WinDbg</em>:</p> <ul> <li>Start <em>WinDbg</em> as admin.</li> <li>Attach to the SQL Server process - (as I have said so many times before, DO NOT do this on a production machine)</li> </ul> <p>Let's now set some break-points:</p> <ul> <li><code>bp sqllang!CUDXR_ExternalScript::ConnectToSatellite</code></li> <li><code>bp sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li><code>bp sqllang!Tcp::WriteAsync</code></li> </ul> <p>We use the <code>ConnectToSatellite</code> break-point as a "navigation" aid, e.g. we know that what we are interested in will happen after <code>ConnectToSatellite</code>. We should also keep in mind that there will be two <code>sqllang!Tcp::WriteAsync</code> calls after <code>ConnectToSatellite</code>, which is related to the authentication between SQL Server and SqlSatellite (see <a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">Internals - XI</a>), and whatever we are interested in comes after those two calls.</p> <p>Execute the code in <em>Code Snippet 2</em>, and continue when you hit the first <code>WriteMessage</code> (this call is related top the named pipe connection between SQL Server and the launchpad service). Notice how you break at <code>ConnectToSatellite</code>, and when you continue, there are two <code>WriteAsync</code> straight after it (this is the authentication calls we covered in <a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">Internals - XI</a>). Now things are getting somewhat interesting; after the second <code>WriteAsync</code>, continue past <code>WriteMessage</code>, and you will break at <code>WriteAsync</code>, which is where the script is being sent to SqlSatellite.</p> <p>At that point, let's have a look at the call-stack. If you use the old <em>WinDbg</em>, you do a <code>kc</code>, and in the new <em>WinDbg</em> you look at the call-stack window:</p> <p><img class="center" src="/images/posts/sql_r_services_12_windbg_callstack.png" width="349" height="274" > <strong>Figure 5:</strong> <em>Call-stack Window in New WinDbg</em></p> <p>In <em>Figure 5</em> we see the call-stack, and I have also copied it out to the code snippet below to get a "fuller" view of the stack, (I only show the stack from <code>sqllang!SpExecuteExternalScript</code> onwards):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Call Stack</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SNIWriteAsync</span> <span class="o">+</span> <span class="mh">0xb0</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span> <span class="o">+</span> <span class="mh">0x7d</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteProxy</span><span class="o">::</span><span class="n">PostSetupMessage</span> <span class="o">+</span> <span class="mh">0x376</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span> <span class="o">+</span> <span class="mh">0x62</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">Open</span> <span class="o">+</span> <span class="mh">0x96</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">Open</span> <span class="o">+</span> <span class="mh">0xe5</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">StartupQuery</span> <span class="o">+</span> <span class="mh">0x316</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">SetupQueryScanAndExpression</span> <span class="o">+</span> <span class="mh">0x3fa</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">InitForExecute</span> <span class="o">+</span> <span class="mh">0x34</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span> <span class="o">+</span> <span class="mh">0x4dc</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtSelect</span><span class="o">::</span><span class="n">XretExecute</span> <span class="o">+</span> <span class="mh">0x322</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="o">+</span> <span class="mh">0x40d</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span> <span class="o">+</span> <span class="mh">0xa9e</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span> <span class="o">+</span> <span class="mh">0x983</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span> <span class="o">+</span> <span class="mh">0x140e</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">[</span><span class="n">snip</span><span class="p">]</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 3:</strong> <em>Call Stack</em></p> <p>When we look at the call-stack in <em>Figure 5</em> or <em>Code Snippet 3</em> we see some "old friends"; <code>sqllang!CUDXR_ExternalScript::Open</code> and <code>sqllang!CUDXR_ExternalScript::ConnectToSatellite</code> amongst them. The routine that sends the packet seems to be <code>sqllang!CSatelliteProxy::PostSetupMessage</code>.</p> <p>To try to prove that we start by looking at code in <code>PostSetupMessage</code>, specifically around where <code>WriteMessage</code> is called. In the <em>WinDbg</em> console, do <code>uf sqllang!CSatelliteProxy::PostSetupMessage</code> and look for <code>sqllang!CSQLSatelliteConnection::WriteMessage</code>. The region containing <code>WriteMessage</code> looks something like so (I have taken out some memory addresses etc.):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>PostSetupMessage</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteProxy</span><span class="o">::</span><span class="n">PostSetupMessage</span><span class="o">+</span><span class="mh">0x362</span><span class="o">:</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rcx</span><span class="o">+</span><span class="mi">0</span><span class="n">A0h</span><span class="p">],</span><span class="n">eax</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">mov</span>     <span class="n">rdx</span><span class="p">,</span><span class="n">rcx</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span><span class="n">r12</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">call</span>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">jmp</span>     <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteProxy</span><span class="o">::</span><span class="n">PostSetupMessage</span><span class="o">+</span><span class="mh">0x37d</span> <span class="n">Branch</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 4:</strong> <em>PostSetupMessage and WriteMessage</em></p> <p>We know that <code>WriteMessage</code> causes the <code>WriteAsync</code> and in <em>Code Snippet 4</em> we see that after the <code>WriteMessage</code> call, the code "jumps" to <code>PostSetupMessage+0x37d</code>. Logically, we then can believe that when <code>PostSetupMessage+0x37d</code> is hit, the packet should have been sent. So now we set a break-point at <code>PostSetupMessage+0x37d</code>, and we use <em>Process Monitor</em> to capture TCP traffic, the same way we did above.</p> <p>Before you execute the code in <em>Code Snippet 2</em>, it is probably a good idea to clear the display in <em>Process Monitor</em>, so you more easily can see what happens. Execute the code, and let it continue until it breaks for the third time (after <code>ConnectToSatellite</code>) at <code>WriteAsync</code>. At this stage the <em>Process Monitor</em> output looks like this:</p> <p><img class="center" src="/images/posts/sql_r_services_12_procmon2.png" width="688" height="154" > <strong>Figure 6:</strong> *Process Monitor Output *</p> <p>As we see in <em>Figure 6</em>, the packet containing the script has not been sent yet, but as soon as we continue the code in <em>WinDbg</em>, the packet is sent and is visible in <em>Process Monitor</em>. At this stage the code will hit the break-point at <code>PostSetupMessage+0x37d</code>, so we can now with certainty say that the script packet is sent from inside <code>PostSetupMessage</code>, and it has (in our example) a length of 204. So what about the packet with a length of 28?</p> <p>We have seen how that packet is sent straight after the packet with a length of 204, so we'll investigate this packet in the same way we did with the "204" packet. Execute the code again, but at this time continue until you hit the <code>WriteAsync</code> that comes after the "204" packet. At that stage have a look at the call-stack:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Call Stack 2</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SNIWriteAsync</span> <span class="o">+</span> <span class="mh">0xb0</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span> <span class="o">+</span> <span class="mh">0x7d</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEndMessage</span> <span class="o">+</span> <span class="mh">0x50</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEnd</span> <span class="o">+</span> <span class="mh">0x3e</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span> <span class="o">+</span> <span class="mh">0xa4</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">Open</span> <span class="o">+</span> <span class="mh">0x23b</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">StartupQuery</span> <span class="o">+</span> <span class="mh">0x316</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">SetupQueryScanAndExpression</span> <span class="o">+</span> <span class="mh">0x3fa</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">InitForExecute</span> <span class="o">+</span> <span class="mh">0x34</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span> <span class="o">+</span> <span class="mh">0x4dc</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtSelect</span><span class="o">::</span><span class="n">XretExecute</span> <span class="o">+</span> <span class="mh">0x322</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="o">+</span> <span class="mh">0x40d</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span> <span class="o">+</span> <span class="mh">0xa9e</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span> <span class="o">+</span> <span class="mh">0x983</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span> <span class="o">+</span> <span class="mh">0x140e</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 5:</strong> <em>Call Stack for "28" Packet</em></p> <p>At a cursory glance at the call-stack in <em>Code Snippet 5</em>, it looks quite similar to the call-stack in <em>Code Snippet 4</em>. However, when you start to look closer you can see it is not the same at all. There are no calls to <code>ConnectToSatellite</code> or <code>PostSetupMessage</code>, instead there are calls to some new routines:</p> <ul> <li>sqllang!CUDXR_ExternalScript::PushEOS</li> <li>sqllang!CSatelliteCargoContext::SendChunkEnd</li> <li>sqllang!CSatelliteCargoContext::SendChunkEndMessage</li> </ul> <p>It seems that the call-stacks in code snippets 4 and 5 originates both from <code>sqlmin!CQScanUdx::Open</code>, however from different locations. What is somewhat strange is that if we were to do an <code>uf sqlmin!CQScanUdx::Open</code>, we would not see any calls to <code>sqllang!CUDXR_ExternalScript::PushEOS</code> from the <code>Open</code> routine, so they must be "hidden" down deep in the code. To get a better feel for what goes on we can try to trace through the calls in <code>sqlmin!CQScanUdx::Open</code>:</p> <ul> <li>Remove all breakpoints.</li> <li>Set a breakpoint at <code>sqlmin!CQScanUdx::Open</code>.</li> </ul> <p>Execute the code again, and when you hit the breakpoint at <code>Open</code>, you execute the <code>wt</code>, (Trace and Watch), command. However do it with the <code>-l</code> option, which specifies the maximum depth of the calls to display. If you don't set the <code>-l</code> option, the <code>wt</code> will just go on and on and on. When I do it on my server I use a level of 4 (<code>wt -l 4</code>), and the end of the trace looks like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Trace</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1">//lot of other code</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">Open</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">EstimateDataChunkRows</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">GetTypeSizeInBytes</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">EstimateDataChunkRows</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">floor</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">MSVCR120</span><span class="o">!</span><span class="n">floor</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">EstimateDataChunkRows</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">Open</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">Open</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXC_ExternalScript</span><span class="o">::</span><span class="n">EUdxTypeGet</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">Open</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEnd</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEndMessage</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">PrepareChunkEndPacket</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEndMessage</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEndMessage</span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEnd</span>
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WaitWriteDone</span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEnd</span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span>
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">Open</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 6:</strong> <em>Trace and Watch of sqlmin!CQScanUdx::Open</em></p> <p>In <em>Code Snippet 6</em> we definitely see how the routines mentioned above are being called during <code>sqlmin!CQScanUdx::Open</code>. Based on their names we understand that the packet being sent has to do with informing the SqlSatellite that no more script data is coming.</p> <blockquote><p><strong>NOTE:</strong> In the code in <em>Code Snippet 6</em>, you can for now dismiss the first lines of code that has to do with <code>EstimateDataChunkRows</code>.</p></blockquote> <p>So the flow looks something like this (heavily abbreviated):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Flow</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">Open</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteProxy</span><span class="o">::</span><span class="n">PostSetupMessage</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">Open</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEndMessage</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 7:</strong> <em>Abbreviated Flow</em></p> <p>Please note that the flow in <em>Code Snippet 7</em> is for when no result data (no <code>@input_data_1</code>) is being sent. When we have result data the flow will look somewhat different as we will see below.</p> <h2>Input Data</h2> <p>Above we saw the packets for the external script and the end of script; how they were sent and what did send them. Now we'll have a look at the packets that are sent for data which is input for the script (<code>@input_data_1</code>). The code we'll use looks like this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Code</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">exec</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(30)
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                 d&lt;-InputDataSet'</span><span class="p">,</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT 42'</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 8:</strong> <em>External Script with SELECT</em></p> <p>The difference between the code in <em>Code Snippet 8</em> and the code in <em>Code Snippet 2</em>, is that in <em>Code Snippet 8</em> we are selecting an input data set, that will be passed to the SqlSatellite together with the script.</p> <p>We'll use <em>Process Monitor</em> to be able to see when the packets are being sent, and initially we'll just run through the code and see the output in <em>Process Monitor</em>. Remove whatever breakpoints you have, and execute the code in <em>Code Snippet 8</em>. As you did above have a close look at the output from <em>Process Monitor</em> when the external code hits <code>Sys.sleep</code>. The output looks like this:</p> <p><img class="center" src="/images/posts/sql_r_services_12_procmon3.png" width="713" height="237" > <strong>Figure 7:</strong> <em>Process Monitor Output</em></p> <p>As in <em>Figure 4</em>, the red line you see in <em>Figure 7</em> illustrates where control has been handed over to the SqlSatellite (we hit <code>Sys.sleep()</code>). The packets we are interested in are the three just above the red line, with lengths of 2023, 28, and 28. We do know that the "2023" packet contains the data from the <code>SELECT</code>, and that one of the "28" packets is the "end of script" packet from above. We do not know which one it is, and we do not know what the second "28" packet is.</p> <blockquote><p><strong>NOTE:</strong> From above, if you wonder why a packet sending just one integer has a size of 2023, that's something we'll look a bit into in next post.</p></blockquote> <p>To look more into the three packets we are interested in, we set breakpoints at:</p> <ul> <li><code>bp sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li><code>bp sqllang!Tcp::WriteAsync</code></li> <li><code>bp sqllang!CUDXR_ExternalScript::PushEOS</code></li> </ul> <p>Clear the display in <em>Process Monitor</em> and execute the code in <em>Code Snippet 8</em>. Let the code continue through until you hit the break-point for <code>PushEOS</code>. At this stage the output in <em>Process Monitor</em> looks like so:</p> <p><img class="center" src="/images/posts/sql_r_services_12_procmon4.png" width="666" height="159" > <strong>Figure 8:</strong> <em>Process Monitor Output at PushEOS</em></p> <p>Based on what we saw when we looked at how script packets were sent, what we see in <em>Figure 8</em> is what we expected. We see how the script packet has been sent (length 234), and we are waiting for the end of script packet. What is somewhat different though, is the call-stack (from <code>SpExecuteExternalScript</code>):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Call Stack 3</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">PushNextChildRow</span> <span class="o">+</span> <span class="mh">0x1af</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span> <span class="o">+</span> <span class="mh">0x79</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">GetRow</span> <span class="o">+</span> <span class="mh">0x81</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span> <span class="o">+</span> <span class="mh">0x4dc</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtSelect</span><span class="o">::</span><span class="n">XretExecute</span> <span class="o">+</span> <span class="mh">0x322</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="o">+</span> <span class="mh">0x40d</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span> <span class="o">+</span> <span class="mh">0xa9e</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span> <span class="o">+</span> <span class="mh">0x983</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span> <span class="o">+</span> <span class="mh">0x140e</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 9:</strong> <em>Call Stack at PushEOS with Input Data</em></p> <p>Notice in <em>Code Snippet 9</em> how <code>sqlmin!CQScanUdx::Open</code> is not in the stack at all. We'll come back to that in a little bit. Continue the execution from the break-point and stop at <code>WriteMessage</code>, and wait a second or two. Look at the output from <em>Process Monitor</em>:</p> <p><img class="center" src="/images/posts/sql_r_services_12_procmon5.png" width="665" height="180" > <strong>Figure 9:</strong> <em>Process Monitor Output at WriteMessage</em></p> <p>In <em>Figure 9</em> we now see how the input data packet (length 2023) have been sent, even though we haven't executed <code>WriteMessage</code>! When we now continue execution we will see how we hit:</p> <ul> <li><code>sqllang!Tcp::WriteAsync</code>, which sends a packet with a length of 28.</li> <li>another <code>WriteMessage</code>, followed by</li> <li><code>sqllang!Tcp::WriteAsync</code>, which sends a second packet with a length of 28.</li> </ul> <p>At this stage we are now at the red line in <em>Figure 7</em>. Having seen this, there are some questions:</p> <ol> <li>where did the data packet originate from, but no <code>sqllang!Tcp::WriteAsync</code> were called?</li> <li>we saw two packets with a length of 28, we know one must be the script end packet, but which is it, and what is the other packet?</li> </ol> <p>Let's start with point 1, where does the input data come from? For one reason or another it doesn't originate from a <code>WriteMessage</code> followed by an <code>sqllang!Tcp::WriteAsync</code>. However, we do know that the data is sent as a TCP packet, so somewhere some code having to do with sockets need to be called. If we "spelunk" down in Windows documentation, we can see that there is a function named <code>WSPSend</code>. According to the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms742292(v=vs.85).aspx">documentation</a>: "The WSPSend function sends data on a connected socket.".</p> <p>With that in mind, perhaps there is something in SQL Server that would be named something similar; <code>x *!*WSPSend*</code>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Socket</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">mswsock</span><span class="o">!</span><span class="n">WSPSend</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">mswsock</span><span class="o">!</span><span class="n">MSAFD_WSPSendMsg</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">mswsock</span><span class="o">!</span><span class="n">WSPSendTo</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">mswsock</span><span class="o">!</span><span class="n">WSPSendDisconnect</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 10:</strong> <em>Low Level Socket Calls</em></p> <p>What we see in <em>Code Snippet 10</em> looks promising! Let's start from the top, and set a break-point at <code>mswsock!WSPSend</code>. After having cleared out the display in <em>Process Monitor</em> we then execute the code in <em>Code Snippet 8</em> again. It seems our hunch about <code>WSPSend</code> being used for low level socket sends is correct, as when the code executes each <code>WriteAsync</code> is followed by a <code>WSPSend</code>.</p> <p>When the code breaks at <code>PushEOS</code> things are getting interesting. As expected we see in <em>Process Monitor</em> that the 2023 packet has not been sent yet. When continuing we immediately hit <code>mswsock!WSPSend</code>, which indicates that a package is about to be sent. At this point, look at the call-stack:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Call Stack 4</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">mswsock</span><span class="o">!</span><span class="n">WSPSend</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">WS2_32</span><span class="o">!</span><span class="n">WSASend</span> <span class="o">+</span> <span class="mh">0x16c</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">GatherWriteAsync</span> <span class="o">+</span> <span class="mh">0x181</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SNIGatherWriteAsync</span> <span class="o">+</span> <span class="mh">0xad</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteGatherMessages</span> <span class="o">+</span> <span class="mh">0xa6</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendPackets</span> <span class="o">+</span> <span class="mh">0x34</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendRemainingChunk</span> <span class="o">+</span> <span class="mh">0x149</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span> <span class="o">+</span> <span class="mh">0x2f</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">PushNextChildRow</span> <span class="o">+</span> <span class="mh">0x1af</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span> <span class="o">+</span> <span class="mh">0x79</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">GetRow</span> <span class="o">+</span> <span class="mh">0x81</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span> <span class="o">+</span> <span class="mh">0x4dc</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtSelect</span><span class="o">::</span><span class="n">XretExecute</span> <span class="o">+</span> <span class="mh">0x322</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="o">+</span> <span class="mh">0x40d</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span> <span class="o">+</span> <span class="mh">0xa9e</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span> <span class="o">+</span> <span class="mh">0x983</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span> <span class="o">+</span> <span class="mh">0x140e</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 11:</strong> <em>Call Stack Sending Data Packet</em></p> <p>We'll look closer at the call-stack as in <em>Code Snippet 11</em> shortly, but now we continue execution of the code. We immediately see the 2023 packet being sent, followed by hitting the <code>WriteMessage</code> break-point. Continuing on from there we hit <code>WriteAsync</code> followed by <code>WSPSend</code>, and at this stage the call-stack looks like this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Call Stack 5</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">mswsock</span><span class="o">!</span><span class="n">WSPSend</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">WS2_32</span><span class="o">!</span><span class="n">WSASend</span> <span class="o">+</span> <span class="mh">0x16c</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span> <span class="o">+</span> <span class="mh">0x174</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SNIWriteAsync</span> <span class="o">+</span> <span class="mh">0xb0</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span> <span class="o">+</span> <span class="mh">0x7d</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEndMessage</span> <span class="o">+</span> <span class="mh">0x50</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEnd</span> <span class="o">+</span> <span class="mh">0x3e</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span> <span class="o">+</span> <span class="mh">0x7c</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">PushNextChildRow</span> <span class="o">+</span> <span class="mh">0x1af</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span> <span class="o">+</span> <span class="mh">0x79</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">GetRow</span> <span class="o">+</span> <span class="mh">0x81</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span> <span class="o">+</span> <span class="mh">0x4dc</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtSelect</span><span class="o">::</span><span class="n">XretExecute</span> <span class="o">+</span> <span class="mh">0x322</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="o">+</span> <span class="mh">0x40d</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span> <span class="o">+</span> <span class="mh">0xa9e</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span> <span class="o">+</span> <span class="mh">0x983</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span> <span class="o">+</span> <span class="mh">0x140e</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 12:</strong> <em>Call Stack First 28 packet</em></p> <p>Continuing on from there, a 28 packet is being sent, and we eventually break at <code>WSPSend</code> again, and now the call-stack looks like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Call Stack 6</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">mswsock</span><span class="o">!</span><span class="n">WSPSend</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">WS2_32</span><span class="o">!</span><span class="n">WSASend</span> <span class="o">+</span> <span class="mh">0x16c</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span> <span class="o">+</span> <span class="mh">0x174</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SNIWriteAsync</span> <span class="o">+</span> <span class="mh">0xb0</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span> <span class="o">+</span> <span class="mh">0x7d</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEndMessage</span> <span class="o">+</span> <span class="mh">0x50</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEnd</span> <span class="o">+</span> <span class="mh">0x3e</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span> <span class="o">+</span> <span class="mh">0xa4</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">PushNextChildRow</span> <span class="o">+</span> <span class="mh">0x1af</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span> <span class="o">+</span> <span class="mh">0x79</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">GetRow</span> <span class="o">+</span> <span class="mh">0x81</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span> <span class="o">+</span> <span class="mh">0x4dc</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtSelect</span><span class="o">::</span><span class="n">XretExecute</span> <span class="o">+</span> <span class="mh">0x322</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="o">+</span> <span class="mh">0x40d</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span> <span class="o">+</span> <span class="mh">0xa9e</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span> <span class="o">+</span> <span class="mh">0x983</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span> <span class="o">+</span> <span class="mh">0x140e</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 13:</strong> <em>Call Stack Second 28 packet</em></p> <p>When the code in <em>Code Snippet 13</em> continues, it will cause the second 28 packet to be sent.</p> <p>So at this stage we have now sent three packets, let's now go back to the call-stack in <em>Code Snippet 11</em> and see what causes the result data packet to be sent. Before we do that however let's address the question that was asked when we looked at <em>Code Snippet 9</em>: where is <code>sqlmin!CQScanUdx::Open</code>?</p> <p>Remember, when we did not send any result data into the SqlSatellite, the end of script was called from inside <code>sqlmin!CQScanUdx::Open</code> as in <em>Code Snippet 7</em>. When result data is sent to the SqlSatellite <code>sqlmin!CQScanUdx::Open</code> is still being called obviously (otherwise no connection to the satellite would be made etc.), but the end of script message is not sent by <code>Open</code>, but instead after the result data has been sent.</p> <p>So, <em>Code Snippet 11</em> and the call-stack which sent result data: we can see how the result data is being sent from <code>sqllang!CSatelliteCargoContext::SendPackets</code> and an abbreviated flow looks like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Flow</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">PushNextChildRow</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendPackets</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 14:</strong> <em>Abbreviated Flow Result Data</em></p> <p>Then, as we've seen, two packets with a size of 28 is sent. One is the end packet for the external script, and one is to indicate that no more result data will be sent. The flow, including sending the result data, looks like this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Flow</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">PushNextChildRow</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendPackets</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEndMessage</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEndMessage</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 15:</strong> <em>Abbreviated Flow Result Data</em></p> <p>From what we've seen we can assume that <code>sqlmin!CQScanUdx::PushNextChildRow</code> pushes data into <code>CSatelliteCargoContext</code> from which the data is sent through the <code>sqllang!CSatelliteCargoContext::SendPackets</code> routine. After the result data has been sent, packets are sent to indicate that no more data (or script) is coming.</p> <h2>Summary</h2> <p>In this post we set out trying to figure out who and what sent the following packets from SQL Server to the SqlSatellite:</p> <ul> <li>External script packet</li> <li>Packet containing the input data</li> </ul> <p>We also wanted to figure out what the packets with a length of 28 were for.</p> <p><strong>EDIT:</strong> The figure below, and the flow has been edited, as I had forgotten the sending of the actual external script. It is now in the flow as point 6.</p> <p>Instead of "re-hashing" what we have covered above, the following figure depicts, from a high level, what is being sent and by who. The figure somewhat condenses what you see in <em>Figure 2</em>:</p> <p><img class="center" src="/images/posts/sql_r_services_12_calls.png" width="800" height="519" > <strong>Figure 10:</strong> <em>Flow in SQL Server</em></p> <p>The numbered arrows shows the communication out from SQL Server, and in what order it happens:</p> <ol> <li>SQL Server opens named pipe connection to the launchpad service.</li> <li>Message sent to the launchpad service.</li> <li>After the call above, the SqlSatellite opens a TCP/IP connection to SQL Server.</li> <li>SQL Server sends the first packet to the SQL Satellite for authentication purposes.</li> <li>A second authentication packet is sent to SqlSatellite.</li> <li>The script is sent from inside <code>sqllang!CSatelliteProxy::PostSetupMessage</code></li> <li>The data for <code>@input_data_1</code> is sent.</li> <li>The first end packet is sent.</li> <li>The second end packet is sent.</li> </ol> <h2>~ Finally</h2> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/10/31/microsoft-sql-server-r-services-internals-xii/&text=Microsoft SQL Server R Services - Internals XII&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/10/31/microsoft-sql-server-r-services-internals-xii/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2017/10/31/microsoft-sql-server-r-services-internals-xii/ &title=Microsoft SQL Server R Services - Internals XII &summary=Blog post: More about the TCP/IPpackets sent from SQL Server to SqlSatellite. &source=http://www.nielsberglund.com/2017/10/31/microsoft-sql-server-r-services-internals-xii/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/10/31/microsoft-sql-server-r-services-internals-xii/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> <br/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad2 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="1158080725" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2018/07/15/interesting-stuff-week-28/"> Interesting Stuff - Week 28 <small> (15 Jul 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/07/08/interesting-stuff-week-27/"> Interesting Stuff - Week 27 <small> (08 Jul 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/07/07/sp-execute-external-script-and-sql-compute-context-II/"> sp_execute_external_script and SQL Compute Context - II <small> (07 Jul 2018)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
