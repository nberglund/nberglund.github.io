<!DOCTYPE html> <html lang="en-us"> <head> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="What are the two strange TCP/IPpackets sent from SQL Server to SqlSatellite, and who sends them?"> <meta name="keywords" content="SQL Server R Services, R, WinDbg, Launchpad, SqlSatellite"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Microsoft SQL Server R Services - Internals XI &middot; Niels Berglund </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-6937d9aff18f4bd864a4e4772a407120.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.3.0 --> <title>Microsoft SQL Server R Services - Internals XI | Niels Berglund</title> <meta property="og:title" content="Microsoft SQL Server R Services - Internals XI" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="What are the two strange TCP/IPpackets sent from SQL Server to SqlSatellite, and who sends them?" /> <meta property="og:description" content="What are the two strange TCP/IPpackets sent from SQL Server to SqlSatellite, and who sends them?" /> <link rel="canonical" href="http://nielsberglund.com/2017/10/20/microsoft-sql-server-r-services-internals-xi/" /> <meta property="og:url" content="http://nielsberglund.com/2017/10/20/microsoft-sql-server-r-services-internals-xi/" /> <meta property="og:site_name" content="Niels Berglund" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2017-10-20T18:42:47+02:00" /> <script type="application/ld+json"> {"name":null,"description":"What are the two strange TCP/IPpackets sent from SQL Server to SqlSatellite, and who sends them?","author":{"@type":"Person","name":"nielsb"},"@type":"BlogPosting","url":"http://nielsberglund.com/2017/10/20/microsoft-sql-server-r-services-internals-xi/","publisher":null,"image":null,"headline":"Microsoft SQL Server R Services - Internals XI","dateModified":"2017-10-20T18:42:47+02:00","datePublished":"2017-10-20T18:42:47+02:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://nielsberglund.com/2017/10/20/microsoft-sql-server-r-services-internals-xi/"},"@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <div class="sidebar"> <div class="container"> <div class="sidebar-about"> <h1> <a href="/"> Niels Berglund </a> </h1> <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/disclaimer/">Disclaimer</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <img class="center" src="/images/MVP_Logo.png" width="181" height="74" > <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <p>&copy; 2018. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">Microsoft SQL Server R Services - Internals XI</h1> <div class="post-subheading"> <span class="post-date">20 Oct 2017</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#Microsoft R Server">Microsoft R Server</a> <a href="/categories/#Data Science">Data Science</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server R Services">SQL Server R Services</a> <a href="/tags/#R">R</a> <a href="/tags/#WinDbg">WinDbg</a> <a href="/tags/#Launchpad">Launchpad</a> <a href="/tags/#SqlSatellite">SqlSatellite</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> <p>This post is part of a series of blog-posts about Microsoft SQL Server R Services:</p> <ol> <li><a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">Microsoft SQL Server 2016 R Services Installation</a></li> <li><a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Microsoft SQL Server R Services - Internals I</a></li> <li><a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Microsoft SQL Server R Services - Internals II</a></li> <li><a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Microsoft SQL Server R Services - Internals III</a></li> <li><a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Microsoft SQL Server R Services - Internals IV</a></li> <li><a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Microsoft SQL Server R Services - Internals V</a></li> <li><a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Microsoft SQL Server R Services - Internals VI</a></li> <li><a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Microsoft SQL Server R Services - Internals VII</a></li> <li><a href="/2017/07/22/microsoft-sql-server-r-services-internals-viii/">Microsoft SQL Server R Services - Internals VIII</a></li> <li><a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Microsoft SQL Server R Services - Internals IX</a></li> <li><a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Microsoft SQL Server R Services - Internals X</a></li> <li>Microsoft SQL Server R Services - Internals XI (this post)</li> <li><a href="/2017/10/31/microsoft-sql-server-r-services-internals-xii/">Microsoft SQL Server R Services - Internals XII</a></li> <li><a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">Microsoft SQL Server R Services - Internals XIII</a></li> <li><a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Microsoft SQL Server R Services - Internals XIV</a></li> <li><a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Microsoft SQL Server R Services - Internals XV</a></li> <li><a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Microsoft SQL Server R Services - Internals XVI</a></li> <li><a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Microsoft SQL Server R Services - Internals XVII</a></li> <li>More to come (hopefully)</li> </ol> <p>This post is the twelfth post about Microsoft SQL Server R Services, and the eleventh post that drills down into the internal of how it works.</p> <p>In the last <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">post</a> we spoke about how the transfer of data happens between SQL Server and the R components, and we saw how data was transferred over the TCP connection between the <strong>SqlSatellite</strong> and SQL Server. In the post we mentioned that the protocol being used is <strong>Binary eXchange Language</strong> protocol(<strong>BXL</strong>), and this post was supposed to talk about BXL.</p> <!--more--> <p>However, while I was investigating BXL I did some WinDbg <a href="http://queue.acm.org/detail.cfm?id=945136">"spelunking"</a> in SQL Server and came across some interesting "stuff" that ties into how data is being sent, so I decided to post about that instead (a future post will definitely cover BXL).</p> <h2>Recap</h2> <p>In <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a>, as mentioned above, we looked at how data was transferred from SQL Server to R. By using <strong>WireShark</strong> we could see how the data was transferred over the TCP connection between the <strong>SqlSatellite</strong> and SQL Server.</p> <blockquote><p><strong>NOTE:</strong> We discussed the communications mechanisms in general and the TCP connection specifically in <a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Internals - IX</a>.</p></blockquote> <p>To see what happens in SQL Server as well as the launchpad service when a script executes we set some break-points in WinDbg, for both processes:</p> <ul> <li>SQL Server: <code>sqllang!SpExecuteExternalScript</code></li> <li>SQL Server: <code>sqllang!CSQLSatelliteConnection::OpenNpConnection</code></li> <li>SQL Server: <code>sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li>SQL Server: <code>sqllang!CUDXR_ExternalScript::ConnectToSatellite</code></li> <li>Launchpad: <code>launchpad!Np::AcceptConnection</code></li> <li>Launchpad: <code>launchpad!Np::ReadAsync</code></li> <li>Launchpad: <code>launchpad!CSQLSatelliteCommunication::SendResumeWithLoginInfo</code></li> <li>Launchpad: <code>launchpad!CSQLSatelliteConnection::WriteMessage</code></li> </ul> <p>The script used when investigation what happens is very simple:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Code</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">exec</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(30)
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                 d&lt;-42'</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Basic External Script</em></p> <p>The reason for using simple code like in <em>Code Snippet 1</em>, is that it might make it easier to understand what is happening, and we can compare with what is happening when executing some other, not so basic, code. Notice how in <em>Code Snippet 1</em> there is a <code>Sys.sleep</code>. It is there to make it easier to determine - when debugging - when data is sent to R and when data is coming back.</p> <p>When we executed the code in <em>Code Snippet 1</em>, we saw how the breakpoints where hit as below:</p> <ol> <li><code>sqllang!SpExecuteExternalScript</code> is called.</li> <li><code>sqllang!CSQLSatelliteConnection::OpenNpConnection</code></li> <li><code>launchpad!Np::AcceptConnection</code></li> <li><code>launchpad!Np::ReadAsync</code></li> <li><code>launchpad!Np::ReadAsync</code></li> <li><code>launchpad!Np::ReadAsync</code></li> <li><code>sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li><code>launchpad!Np::ReadAsync</code></li> <li><code>launchpad!CSQLSatelliteCommunication::SendResumeWithLoginInfo</code></li> <li><code>launchpad!CSQLSatelliteConnection::WriteMessage</code> - notice how nothing happens in the SQL process until <code>WriteMessage</code> is executed.</li> <li><code>sqllang!CUDXR_ExternalScript::ConnectToSatellite</code></li> <li><code>sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li><code>sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li>Pause for <code>Sys.sleep</code></li> <li><code>sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li><code>sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li><code>launchpad!Np::ReadAsync</code></li> <li><code>launchpad!CSQLSatelliteConnection::WriteMessage</code></li> </ol> <p>The above led us to the conclusion - which I voiced in the start of this recap - that data may not be sent via the launchpad service, but over the SqlSatellite TCP connection. The reason that conclusion was achieved was that some of the <code>sqllang!CSQLSatelliteConnection::WriteMessage</code> did not have a corresponding <code>launchpad!Np::ReadAsync</code>.</p> <p>In <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> we further proved that theory by using <em>Process Monitor</em> and capturing what TCP packets were sent to the SqlSatellite (or rather <code>BxlServer.exe</code> - which hosts SqlSatellite). When executing the code in <em>Code Snippet 1</em> we saw <em>Process Monitor</em> output like so:</p> <p><img class="center" src="/images/posts/sql_r_services_10_procmon_output1.png" width="652" height="210" > <strong>Figure 1:</strong> <em>Process Monitor Base Output</em></p> <p>Combined with the breakpoints the flow looked like below:</p> <ol> <li><code>sqllang!SpExecuteExternalScript</code> is called.</li> <li><code>sqllang!CSQLSatelliteConnection::OpenNpConnection</code></li> <li><code>launchpad!Np::AcceptConnection</code></li> <li><code>launchpad!Np::ReadAsync</code></li> <li><code>launchpad!Np::ReadAsync</code></li> <li><code>launchpad!Np::ReadAsync</code></li> <li><code>sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li><code>launchpad!Np::ReadAsync</code></li> <li>TCP Connect</li> <li><code>launchpad!CSQLSatelliteCommunication::SendResumeWithLoginInfo</code></li> <li><code>launchpad!CSQLSatelliteConnection::WriteMessage</code></li> <li><code>sqllang!CUDXR_ExternalScript::ConnectToSatellite</code></li> <li>TCP Receive</li> <li>TCP Receive</li> <li><code>sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li>TCP Receive</li> <li><code>sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li>TCP Receive</li> <li>Pause for <code>Sys.sleep</code></li> <li><code>sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li>TCP Receive</li> <li>TCP Receive</li> <li><code>sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li><code>launchpad!Np::ReadAsync</code></li> <li><code>launchpad!CSQLSatelliteConnection::WriteMessage</code></li> </ol> <p>From what we can see, the three first TCP events happens while we connect. The fourth happens after a <code>WriteMessage</code>, and the fifth after the second <code>WriteMessage</code> before <code>Sys.sleep</code>. The remainders will be covered when we investigate how data is returned to SQL Server.</p> <p>By using <em><em>WireShark</em> we saw how the actual script was sent to SqlSatellite in one of the TCP packets, and if data (<code>@input_data_1 = SELECT ...</code>) was sent, that also was transferred in TCP packet(s). In </em>Figure 2<em> below we see what it looks like in </em>Process Monitor* when both script and data is sent:</p> <p><img class="center" src="/images/posts/sql_r_services_10_procmon_output3.png" width="648" height="241" > <strong>Figure 2:</strong> <em>Process Monitor Output Data Select</em></p> <p>The two highlighted packets (with length of 350, and 6300 respectively) contains the data that is sent to SqlSatellite, but what are the two first packets being sent? That, and what in SQL Server that sends these packets are what we'll try to figure out in the rest of this post.</p> <h2>Packets Sent from SQL Server</h2> <p>So let's start at the top; when we look at <em>Figure 1</em> we see two <code>TCP Receive</code> after the connection is opened, and these two have a length of 217 and 17 respectively. Regardless what we execute, we'll always see these two "events" and they will always have the same lengths. Seeing that they appear after <code>sqllang!CUDXR_ExternalScript::ConnectToSatellite</code>, it may have something to do with setup of the connection, or something like that. To find out what these events are, let's do some "spelunking" using WinDbg. Run WinDbg as admin and attach to the <code>sqlservr.exe</code> process.</p> <blockquote><p><strong>NOTE:</strong> The <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I</a> has more information how to attach WinDbg to a process, and what commands to use.</p></blockquote> <p>When we look at the code flow above combining breakpoints together with the <em>Process Monitor</em> output we see that the two first <code>TCP Receive</code> events (the ones we are interested in appears after <code>sqllang!CUDXR_ExternalScript::ConnectToSatellite</code>, but there are no <code>sqllang!CSQLSatelliteConnection::WriteMessage</code> preceding them. Let's see if we can find out something based on what <code>sqllang!CUDXR_ExternalScript::ConnectToSatellite</code> calls. In <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I</a> we used the <code>uf [options] &lt;address&gt;</code> WinDbg command to see what a particular routine did, so let's do that for <code>sqllang!CUDXR_ExternalScript::ConnectToSatellite</code>. In the WinDbg console execute <code>uf /c sqllang!CUDXR_ExternalScript::ConnectToSatellite</code> (we're using the <code>/c</code> options which displays only the call instructions). That returns something like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>ConnectToSatellite</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span><span class="o">+</span><span class="mh">0x30</span><span class="o">:</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteProxy</span><span class="o">::</span><span class="n">RetrieveConnection</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span><span class="o">+</span><span class="mh">0x5d</span><span class="o">:</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteProxy</span><span class="o">::</span><span class="n">PostSetupMessage</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span><span class="o">+</span><span class="mh">0x90</span><span class="o">:</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">unresolvable</span> <span class="n">call</span><span class="o">:</span> <span class="n">call</span>    <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="mi">48</span><span class="n">h</span><span class="p">]</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span><span class="o">+</span><span class="mh">0x9e</span><span class="o">:</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">ex_raise_oom</span> <span class="p">(</span><span class="mo">00007</span><span class="n">ff8</span><span class="err">`</span><span class="mi">3</span><span class="n">d183fe0</span><span class="p">)</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span><span class="o">+</span><span class="mh">0xab</span><span class="o">:</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">CServerCargoContext</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span><span class="o">+</span><span class="mh">0xc2</span><span class="o">:</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">Init</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span><span class="o">+</span><span class="mh">0x111</span><span class="o">:</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SetupMessageWriter</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>ConnectToSatellite Calls</em></p> <p>Nothing, in <em>Code Snippet 2</em>, really stands out and screams "pick me, pick me" (think the donkey in Shrek) - for being responsible for the TCP events, so let's approach it from another angle. Let's try and see if we can find some routine that actually sends the TCP packets.</p> <p>For that we'll search in WinDbg for some routines that has TCP and Write in their names. So in the WinDbg console, execute the following: <code>x *!*TCP*Write*</code>. Hmm, that returned some interesting "stuff" (the result below is somewhat reduced for readability):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>TCP Routines</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00007</span><span class="n">ff8</span><span class="err">`</span><span class="mi">3</span><span class="n">d1bac30</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteSync</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00007</span><span class="n">ff8</span><span class="err">`</span><span class="mi">3</span><span class="n">d1ba9b0</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteDone</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00007</span><span class="n">ff8</span><span class="err">`</span><span class="mi">3</span><span class="n">d1baf30</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteSyncPost</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00007</span><span class="n">ff8</span><span class="err">`</span><span class="mi">3</span><span class="n">d1b6f40</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">GatherWriteAsync</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00007</span><span class="n">ff8</span><span class="err">`</span><span class="mi">3</span><span class="n">d1bb200</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteSyncWait</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00007</span><span class="n">ff8</span><span class="err">`</span><span class="mi">3</span><span class="n">cf79e40</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">no</span> <span class="n">parameter</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">)</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">...</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 3":</strong> <em>Partial Output for TCP::Write</em></p> <p>The output in <em>Code Snippet 3</em> has some "promising" routines, where <code>sqllang!Tcp::WriteAsync</code> looks very interesting. Let's set some breakpoints:</p> <ul> <li><code>bp sqllang!CSQLSatelliteConnection::WriteMessage</code></li> <li><code>bp sqllang!CUDXR_ExternalScript::ConnectToSatellite</code></li> <li><code>bp sqllang!Tcp::WriteAsync</code></li> </ul> <p>The breakpoints above are "loosely" based on what we did in [Internals - X], and hopefully they'll give us some clarity in what happens. After having set the breakpoints execute the code in <em>Code Snippet 1</em> and notice how the breakpoints are hit:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Flow</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span><span class="o">:</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span><span class="o">:</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span><span class="o">:</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span><span class="o">:</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span><span class="o">:</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span><span class="o">:</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span><span class="o">:</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span><span class="o">:</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="cp"># here is sys.Sleep</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span><span class="o">:</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span><span class="o">:</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span><span class="o">:</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 4":</strong> <em>Breakpoints Hit</em></p> <p>The code in <em>Code Snippet 4</em> matches quite well up with what we saw in the flow in the beginning; <code>ConnectToSatellite</code> followed by two TCP events, followed by <code>WriteMessage</code>, TCP event, <code>WriteMessage</code> and TCP event, and then <code>Sys.sleep</code>. Here we see two <code>sqllang!Tcp::WriteAsync</code> calls after <code>ConnectToSatellite</code> without any <code>WriteMessage</code>. Maybe if we investigated the call-stack at the first <code>sqllang!Tcp::WriteAsync</code>, that could give us some more information:</p> <ol> <li>Execute the code in <code>Code Snippet 1</code> again.</li> <li>Let it run through the <code>WriteMessage</code> and <code>ConnectToSatellite</code> breakpoints.</li> <li>When the first <code>sqllang!Tcp::WriteAsync</code> breakpoint is hit, check the call-stack: <code>kc</code>.</li> </ol> <blockquote><p><strong>NOTE:</strong> By using <code>kc</code> we display a clean stack trace where each display line includes only the module name and the function name.</p></blockquote> <p>The call-stack after step 3 above, looks like so (I have "snipped" out some of the initial calls):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Call Stack</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="cp"># Call Site</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">01</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CryptoBase</span><span class="o">::</span><span class="n">HandshakeWriteToken</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">02</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CryptoBase</span><span class="o">::</span><span class="n">ProcessAndWriteSecurityToken</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">03</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CryptoBase</span><span class="o">::</span><span class="n">ProcessAddProvider</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">04</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CryptoBase</span><span class="o">::</span><span class="n">NegotiateSecurityContext</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">05</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">Sspi</span><span class="o">::</span><span class="n">InitX</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">06</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">AddProvider</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">07</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">SNIAddProviderEx</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">08</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">09</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">DataCargoAcceptTask</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">0</span><span class="n">a</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Task</span><span class="o">::</span><span class="n">Param</span><span class="o">::</span><span class="n">Execute</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">[</span><span class="n">snip</span><span class="p">]</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 5:</strong> <em>Call Stack at First WriteAsync</em></p> <p>When we look at the call-stack we see some routines that have to do with security; <code>NegotiateSecurityContext</code>, <code>ProcessAndWriteSecurityToken</code>, etc. We also see a routine: <code>sqllang!SNIAddProviderEx</code>. This refers to the <strong>SQL Server Network Interface</strong> which is a protocol layer that establishes the network connection between the client and the server. Paired this with the routine <code>sqllang!CSQLSatelliteConnection::AuthenticateConnection</code> it seems that our initial thoughts that the first packet has something to do with setting up the connection to the satellite may not be totally off. Now, let the code run through by pressing F5 or <code>g</code> in the WinDbg console?</p> <p><strong>NOTE:</strong> At this stage, the TCP connection may be closed due to timeout and you eventually will get an error.</p> <p>So let's ensure that we have the part about <code>sqllang!CSQLSatelliteConnection::AuthenticateConnection</code> correct, by setting a breakpoint at it (<code>bp sqllang!CSQLSatelliteConnection::AuthenticateConnection</code>). When you execute you will see how you hit that breakpoint breakpoint almost immediately. You can ignore that, and continue executing until you hit <code>sqllang!CUDXR_ExternalScript::ConnectToSatellite</code>. After you have hit <code>ConnectToSatellite</code> you break at <code>sqllang!CSQLSatelliteConnection::AuthenticateConnection</code>. When you now continue execution you'll see something like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Breakpoints</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">:</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00007</span><span class="n">ff8</span><span class="err">`</span><span class="mi">9</span><span class="n">fbc1990</span> <span class="mi">488</span><span class="n">bc4</span>          <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span><span class="n">rsp</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">0</span><span class="o">:</span><span class="mo">054</span><span class="o">&gt;</span> <span class="n">g</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span><span class="o">:</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00007</span><span class="n">ff8</span><span class="err">`</span><span class="mf">9e864</span><span class="n">a40</span> <span class="mi">4</span><span class="n">c8bdc</span>          <span class="n">mov</span>     <span class="n">r11</span><span class="p">,</span><span class="n">rsp</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">0</span><span class="o">:</span><span class="mo">054</span><span class="o">&gt;</span> <span class="n">g</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span><span class="o">:</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00007</span><span class="n">ff8</span><span class="err">`</span><span class="mf">9e864</span><span class="n">a40</span> <span class="mi">4</span><span class="n">c8bdc</span>          <span class="n">mov</span>     <span class="n">r11</span><span class="p">,</span><span class="n">rsp</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">0</span><span class="o">:</span><span class="mo">050</span><span class="o">&gt;</span> <span class="n">g</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span><span class="o">:</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00007</span><span class="n">ff8</span><span class="err">`</span><span class="mf">9e864</span><span class="n">a40</span> <span class="mi">4</span><span class="n">c8bdc</span>          <span class="n">mov</span>     <span class="n">r11</span><span class="p">,</span><span class="n">rsp</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 6:</strong> <em>Breakpoints Hit</em></p> <p>What happens is that straight after the <code>AuthenticateConnection</code> you will hit the <code>WriteAsync</code> breakpoint twice, the same way as we see in <em>Code Snippet 4</em>. The first hit at <code>WriteAsync</code> sort of makes sense, as it ties up with the call-stack we see in <em>Code Snippet 5</em>. But what about the second <code>WriteAsync</code> (the one that causes the second package to be sent), where does that come from? To try to figure that out, we start with the call-stack for that particular <code>WriteAsync</code>.</p> <p> Execute the code in <em>Code Snippet 1</em> again, and continue to the second <code>WriteAsync</code>. When you hit the breakpoint do a <code>kc</code> again. The call-stack should now look somewhat like this (this time it is the full call-stack):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Call Stack 2</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'> <span class="cp"># Call Site</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">01</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CryptoBase</span><span class="o">::</span><span class="n">HandshakeWriteToken</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">02</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CryptoBase</span><span class="o">::</span><span class="n">ProcessAndWriteSecurityToken</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">03</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CryptoBase</span><span class="o">::</span><span class="n">ProcessAddProvider</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">04</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">SNIProcessAddProviderOnWorker</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">05</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Task</span><span class="o">::</span><span class="n">Param</span><span class="o">::</span><span class="n">Execute</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">06</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">RunTask</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">07</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">ProcessTasks</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">08</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SchedulerManager</span><span class="o">::</span><span class="n">WorkerEntryPoint</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">09</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SystemThread</span><span class="o">::</span><span class="n">RunWorker</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">0</span><span class="n">a</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SystemThreadDispatcher</span><span class="o">::</span><span class="n">ProcessWorker</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">0</span><span class="n">b</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SchedulerManager</span><span class="o">::</span><span class="n">ThreadEntryPoint</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">0</span><span class="n">c</span> <span class="n">KERNEL32</span><span class="o">!</span><span class="n">BaseThreadInitThunk</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">0</span><span class="n">d</span> <span class="n">ntdll</span><span class="o">!</span><span class="n">RtlUserThreadStart</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 7:</strong> <em>Call Stack at Second WriteAsync</em></p> <p>Comparing the call-stack in <em>Code Snippet 7</em> with the one in <em>Code Snippet 5</em> we see that they are somewhat similar. We also see that <code>sqllang!CSQLSatelliteConnection::AuthenticateConnection</code> is nowhere to be seen in the second call-stack. However it looks like this call has something to do with SNI as there is the <code>sqllang!SNIProcessAddProviderOnWorker</code> call. So what causes the second <code>WriteAsync</code>? As we did with <code>sqllang!CUDXR_ExternalScript::ConnectToSatellite</code> let's see what calls <code>AuthenticateConnection</code> makes (<code>uf /c sqllang!CSQLSatelliteConnection::AuthenticateConnection</code>):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>AuthenticateConnection</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x9d</span><span class="o">:</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">SNISetInfo</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0xbc</span><span class="o">:</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">SNIAddProviderEx</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x100</span><span class="o">:</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">EventInternal</span><span class="o">&lt;</span><span class="n">SuspendQueueSLock</span><span class="o">&gt;::</span><span class="n">Wait</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x13c</span><span class="o">:</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">RefCountImpl</span><span class="o">&lt;</span><span class="n">CSQLSatelliteConnection</span><span class="o">&gt;::</span><span class="n">Release</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x14a</span><span class="o">:</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">FireAuthenticationXEvent</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x163</span><span class="o">:</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x17a</span><span class="o">:</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SystemThread</span><span class="o">::</span><span class="n">MakeMiniSOSThread</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x189</span><span class="o">:</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x1bf</span><span class="o">:</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">AutoSwitchPreemptive</span><span class="o">::</span><span class="n">AutoSwitchPreemptive</span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x1d5</span><span class="o">:</span>
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthorizeNamedPipeConnection</span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x204</span><span class="o">:</span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">SNIGetInfo</span>
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x21c</span><span class="o">:</span>
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">SSPICLI</span><span class="o">!</span><span class="n">QueryContextAttributesW</span>
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x239</span><span class="o">:</span>
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">ADVAPI32</span><span class="o">!</span><span class="n">CheckTokenMembershipStub</span>
</div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x241</span><span class="o">:</span>
</div></div><div data-line='29' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">KERNEL32</span><span class="o">!</span><span class="n">GetLastErrorStub</span>
</div></div><div data-line='30' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x26c</span><span class="o">:</span>
</div></div><div data-line='31' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">FireAuthorizationXEvent</span>
</div></div><div data-line='32' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x2a8</span><span class="o">:</span>
</div></div><div data-line='33' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">unresolvable</span> <span class="n">call</span><span class="o">:</span> <span class="n">call</span>    <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="mi">10</span><span class="n">h</span><span class="p">]</span>
</div></div><div data-line='34' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x2b0</span><span class="o">:</span>
</div></div><div data-line='35' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">SOS_ExternalAutoWait</span><span class="o">::~</span><span class="n">SOS_ExternalAutoWait</span>
</div></div><div data-line='36' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x2da</span><span class="o">:</span>
</div></div><div data-line='37' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">call</span> <span class="n">to</span> <span class="n">sqllang</span><span class="o">!</span><span class="n">SNIRemoveProvider</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 8:</strong> <em>Calls from AuthenticateConnection</em></p> <p>Looking at the code in <em>Code Snippet 8</em>, we can see the call to <code>sqllang!SNIAddProviderEx</code> (line 5), but nowhere we see <code>sqllang!SNIProcessAddProviderOnWorker</code>. A first thought would be that <code>SNIProcessAddProviderOnWorker</code> is called from another routine, but looking at the call-stack for the second <code>WriteAsync</code> call (<em>Code Snippet 7</em>), we cannot see any particular method that would call <code>SNIProcessAddProviderOnWorker</code>. The only thing we see is that the first call in the call-stack is a start of a new thread: <code>ntdll!RtlUserThreadStart</code>.</p> <p>Hmm, based on the fact that a new thread is started and we're doing SNI "stuff", we may assume that we are still inside <code>AuthenticateConnection</code>. With that in mind we can now start "spelunking" away in <code>AuthenticateConnection</code>. From the code in <em>Code Snippet 8</em> wee see that the call to <code>SNIAddProviderEx</code> happens at <code>sqllang!CSQLSatelliteConnection::AuthenticateConnection+0xbc</code>. We know that the first call to <code>WriteAsync</code> happens after <code>SNIAddProviderEx</code>, which then tells us that the second <code>WriteAsync</code> must happen after <code>sqllang!CSQLSatelliteConnection::AuthenticateConnection+0xbc</code>. Next call is at <code>sqllang!CSQLSatelliteConnection::AuthenticateConnection+0x100</code>, so let us set a break-point there.</p> <p>When you execute again, (and ignore the first breaks on <code>AuthenticateConnection</code> and <code>AuthenticateConnection+0x100</code>), you will eventually see the following:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>AuthenticateConnection+0x100</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ConnectToSatellite</span><span class="o">:</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">mov</span>     <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">8</span><span class="p">],</span><span class="n">rcx</span> <span class="n">ss</span><span class="o">:</span><span class="mo">0000010</span><span class="n">d</span><span class="err">`</span><span class="mf">6e4</span><span class="n">fc2e0</span><span class="o">=</span><span class="mo">000002</span><span class="n">ab0d57d620</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">:</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span><span class="n">rsp</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span><span class="o">:</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">mov</span>     <span class="n">r11</span><span class="p">,</span><span class="n">rsp</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">AuthenticateConnection</span><span class="o">+</span><span class="mh">0x100</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">call</span>    <span class="n">sqllang</span><span class="o">!</span><span class="n">EventInternal</span><span class="o">&lt;</span><span class="n">SuspendQueueSLock</span><span class="o">&gt;::</span><span class="n">Wait</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">Tcp</span><span class="o">::</span><span class="n">WriteAsync</span><span class="o">:</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">mov</span>     <span class="n">r11</span><span class="p">,</span><span class="n">rsp</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 9:</strong> <em>Calls from AuthenticateConnection 2</em></p> <p>Our hunch was right, we can see how we are breaking at <code>AuthenticateConnection+0x100</code> right before the second <code>WriteAsync</code>. In other words the two packets we are interested in are both sent during authentication of the TCP/IP connection between SQL Server and SqlSatellite.</p> <h2>Summary</h2> <p>In this post we set out to find out more about the two TCP/IP packets that are sent from SQL Server to the SqlSatellite, before the actual packages with the script etc., are sent. After some WinDbg "spelunking" we figured out that the packets were sent during the connection to the SqlSatellite, more specifically during <code>sqllang!CSQLSatelliteConnection::AuthenticateConnection</code>.</p> <p>In <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I</a> I had a figure which tried to illustrate what happens in SQL Server when executing <code>sp_execute_external_script</code>, and - based on that figure - I created a new figure where I have included what we found out in this post:</p> <p><img class="center" src="/images/posts/sql_r_services_11_calls.png" width="800" height="532" > <strong>Figure 3:</strong> <em>Flow in SQL Server</em></p> <p>The numbered arrows shows the communication out from SQL Server, and in what order it happens:</p> <ol> <li><code>sqllang!CSQLSatelliteConnection::OpenNpConnection</code> - SQL Server opens named pipe connection to the launchpad service.</li> <li><code>sqllang!CSQLSatelliteConnection::WriteMessage</code> - Message sent to the launchpad service.</li> <li>After the call above, the SqlSatellite opens a TCP/IP connection to SQL Server.</li> <li>During <code>sqllang!CSQLSatelliteConnection::AuthenticateConnection</code> SQL Server sends the first packet to the SQL Satellite. The packet has something to do with authentication.</li> <li>After the first packet is sent, a second packet (still within <code>sqllang!CSQLSatelliteConnection::AuthenticateConnection</code>), which also is related to authentication, is sent on a separate thread to SqlSatellite.</li> </ol> <p>Thus we have figured out what the two first packets are, and where they are sent from.</p> <p>In the next post we'll look at what is sending the packets containing the scripts, and what the flow looks like.</p> <h2>~ Finally</h2> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/10/20/microsoft-sql-server-r-services-internals-xi/&text=Microsoft SQL Server R Services - Internals XI&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/10/20/microsoft-sql-server-r-services-internals-xi/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2017/10/20/microsoft-sql-server-r-services-internals-xi/ &title=Microsoft SQL Server R Services - Internals XI &summary=Blog post: What are the two strange TCP/IPpackets sent from SQL Server to SqlSatellite, and who sends them? &source=http://www.nielsberglund.com/2017/10/20/microsoft-sql-server-r-services-internals-xi/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/10/20/microsoft-sql-server-r-services-internals-xi/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> <br/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad2 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="1158080725" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/"> Microsoft SQL Server R Services - Internals XVII <small> (03 Jan 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/"> Microsoft SQL Server R Services - Internals XVI <small> (24 Dec 2017)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/"> Microsoft SQL Server R Services - Internals XV <small> (02 Dec 2017)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
