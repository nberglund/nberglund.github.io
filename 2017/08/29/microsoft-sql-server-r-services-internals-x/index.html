<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Microsoft SQL Server R Services - Internals X &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Microsoft SQL Server R Services - Internals X</h1>
  <div class="post-subheading">
  <span class="post-date">29 Aug 2017</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>This is the eleventh post in a series about <strong>Microsoft SQL Server R Services</strong>, and the tenth post that drills down into the internal of how it works. To see other posts (including this) in the series, go to <a href="/series/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a>.</p>

<p>In <a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Internals - IX</a> I said we were nearing the end of the internals part is this series, and I had planned this post to be the final post in the Internals part. However while investigating how data is sent between SQL Server and the external components I realized that I would need to probably do two more posts (apart from this) for Internals.</p>

<p>Anyway, in this post we’ll see how data is sent to the R components from SQL Server.</p>

<!--more-->

<p>The “cool” thing by writing all these Internals posts is that as we go along, I learn more things about how it works. For example when I wrote the <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I</a>, I was quite confident in how things worked. Today, how I thought it might have worked, is not entirely correct (as we’ll see). So, as I said I have learned a lot along the way.</p>

<h2 id="recap">Recap</h2>

<p>Since I thought this would be the last Internals post I wanted to do a full recap what has been covered so far. We now know that this is not the last Internals post, but since I have done the work, lets do the full recap anyway even though there will be one or two more posts covering Internals. Since I am lazy, I shamelessly “steal” the recap from <a href="/2017/07/22/microsoft-sql-server-r-services-internals-viii/">Internals - VIII</a> and add what we’ve done since then.</p>

<p>The first post in the series - <a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">Microsoft SQL Server 2016 R Services Installation</a> - covered the installation of SQL Server 2016 R Services, and it also touched upon the external procedure which allows us to execute external scripts; <code class="highlighter-rouge">sp_execute_external_script</code>. We looked at the signature of the procedure as well as executing the equivalent to a “Hello World” script.</p>

<p>In the subsequent posts we talked about - when executing <code class="highlighter-rouge">sp_execute_external_script</code> - how SQL Server calls into the launchpad service, and how the launchpad service - through the <code class="highlighter-rouge">rlauncher.dll</code> creates multiple <code class="highlighter-rouge">Rterm.exe</code> processes as in <em>Figure 1</em> below. One of the processes will be used to run the external script:</p>

<p><img src="/images/posts/sql-launchpad-rterm_processes.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Rterm.exe Processes</em></p>

<p>I addition to creating <code class="highlighter-rouge">Rterm.exe</code> processes, the launchpad service also creates backing directories for those processes. These backing directories are used for saving output, intermediate results etc. The following figure was used to illustrate what the call flow looks like:</p>

<p><img src="/images/posts/sql-launchpad_processes_post.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>Call Flow Executing sp_execute_external_script</em></p>

<p>We discussed how the number of processes can be controlled by the <code class="highlighter-rouge">PROCESS_POOL_SQLSATELLITE_GROWTH</code> setting in <code class="highlighter-rouge">rlauncher.config</code> file, and how it defaults to 5 if nothing is set.</p>

<p>In <a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Internals - VI</a> we came back to the backing directories, and we realized that in addition to the backing directories created for the Rterm processes, one more directory is created. This directory will be the “official” working directory for the session, and we showed this using this figure:</p>

<p><img src="/images/posts/sql_r_services_6_launchpad_working_dir.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>Launchpad, Directories and Processes</em></p>

<p>While we were investigating the directories created in <a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Internals - VI</a>, we saw that - while we executed an external script, files and sub-directories were created in the various backing directories:</p>

<p><img src="/images/posts/sql_r_services_7_outputdir.png" alt="" /></p>

<p><strong>Figure 4:</strong> <em>Contents Process Directory</em></p>

<p>In <em>Figure 4</em> we see the content of the directory which is the processing directory, and in <a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Internals - VII</a> we looked into what creates those files/directories and what they are for. We came to the conclusion that both the launchpad service (probably through the <code class="highlighter-rouge">rlauncher.dll</code>) created some files, whereas <code class="highlighter-rouge">Rterm.exe</code> created others.</p>

<p>So far in the series we have covered what happens up until the Rterm process is created. In <a href="/2017/07/22/microsoft-sql-server-r-services-internals-viii/">Internals - VIII</a> we saw how <code class="highlighter-rouge">Rterm.exe</code> was the entry point into R and how Rterm loaded the <code class="highlighter-rouge">R.dll</code> and <code class="highlighter-rouge">RxLink.dll</code>. RxLink acts as a conduit between the open source R and Microsoft’s <code class="highlighter-rouge">BxlServer.exe</code>. BxlServer is the executable hosting RevoScaleR, and it also coordinates with the R runtime in order to manage exchanges of data with SQL Server. To help with data exchanges with SQL Server, BxlServer loads <code class="highlighter-rouge">BxServerLink.dll</code>, who does a lot of data conversions etc. We illustrated all this with following figure:</p>

<p><img src="/images/posts/sql_r_services_8_arch_overview.png" alt="" /></p>

<p><strong>Figure 5:</strong> <em>BxlServer</em></p>

<p>In <a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Internals - IX</a> we tried to determine what communication mechanisms are used between the various components, and what components are involved to return data to SQL Server. We saw that in addition to BxlServer and BxServerLink we also had <code class="highlighter-rouge">SqlSatellite.dll</code>. SqlSatellite is an API to support external code and external run times, and it is the dll that BxlServer relies on in order to exchange data with SQL Server.</p>

<p>We eventually figured out how communication takes place between the various components and we used the figure below to illustrate the comms mechanisms:</p>

<p><img src="/images/posts/sql_r_services_9_comms2.png" alt="" /></p>

<p><strong>Figure 6:</strong> <em>How Communication Happens</em></p>

<p>So in <em>Figure 6</em> we see a high level view of the architecture, and the numbers denotes the comm mechanisms:</p>

<ul>
  <li>1 - named pipe.</li>
  <li>2 - IOCP.</li>
  <li>3 - named pipe.</li>
  <li>4 - TCP/IP</li>
</ul>

<p>By now we have a certain understanding how it works, and we do know that the SqlSatellite communicates with SQL Server. I this post we’ll look a little bit deeper into what is happening.</p>

<h2 id="demo-code">Demo Code</h2>

<p>As in quite a few of the other posts, let’s have a look at the demo code we’ll be using. In this post we’ll re-use what we had in <a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Internals - IX</a>. First the code to setup the database, and a table with some data:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="n">USE</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span><span class="p">(</span><span class="n">RowID</span> <span class="n">bigint</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> <span class="n">y</span> <span class="n">bigint</span><span class="p">,</span> 
                          <span class="n">rand1</span> <span class="n">bigint</span><span class="p">,</span> <span class="n">rand2</span> <span class="n">bigint</span><span class="p">,</span> <span class="n">rand3</span> <span class="n">bigint</span><span class="p">,</span> 
                          <span class="n">rand4</span> <span class="n">bigint</span><span class="p">,</span> <span class="n">rand5</span> <span class="n">bigint</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">rand3</span><span class="p">,</span> <span class="n">rand4</span><span class="p">,</span> <span class="n">rand5</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">bigint</span><span class="p">)</span> 
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">20</span> <span class="k">AS</span> <span class="n">bigint</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">25</span> <span class="k">AS</span> <span class="n">bigint</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">bigint</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">50</span> <span class="k">AS</span> <span class="n">bigint</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">100</span> <span class="k">AS</span> <span class="n">bigint</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o1</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o2</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o3</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o4</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Setup of Database, Table and Data</em></p>

<p>The code we’ll use to execute:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
          <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
        <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
             #Sys.sleep(10)
             pid &lt;- Sys.getpid()
             d &lt;- getwd()
             cat(paste0("ProcessId: ", pid))
             cat("</span><span class="se">\n</span><span class="s1">")
             cat(paste0("WorkDir: ", d))
             cat("</span><span class="se">\n</span><span class="s1">")
             r &lt;- rxLinMod(y ~ rand1 + rand2 + rand3 + rand4 + rand5, 
                           data=InputDataSet)
             coef &lt;- r$coefficients
             icept &lt;- coef[1];
             OutputDataSet &lt;- data.frame(pid=pid, nRows=r$nValidObs, 
                                          intercept=icept)'</span>
       <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
              SELECT y, rand1, rand2, rand3, 
                      rand4, rand5 
              FROM dbo.rand_1M'</span>
       
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">((</span><span class="n">pid</span> <span class="n">BIGINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">nRows</span> <span class="n">BIGINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> 
                   <span class="n">intercept</span> <span class="n">FLOAT</span> <span class="k">NULL</span><span class="p">));</span> 
</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Code to Execute</em></p>

<p>Even though the code in <em>Code Snippet 2</em> doesn’t do very much, it serves it’s purposes for what we want to do. Notice that we can pause the execution thought the commented out <code class="highlighter-rouge">Sys.sleep</code> statement, if we want to examine what is happening.</p>

<h2 id="data-transferexchange">Data Transfer/Exchange</h2>

<p>We know by now (at least after <a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Internals - IX</a>) that the SqlSatellite has something to do with data exchange. In addition we also know that the launchpad service (in reality <code class="highlighter-rouge">rlauncher.dll</code>) talks to R, and can potentially transfer data. So the question is who transfers data, and what data is transferred by who? If you look at the code in <em>Code Snippet 2</em>, there are various data transfers happening:</p>

<ul>
  <li>The R script is sent to R.</li>
  <li>A dataset is sent in to R trough the <code class="highlighter-rouge">@input_data_1</code> parameter.</li>
  <li>Variables (<code class="highlighter-rouge">pid</code> and <code class="highlighter-rouge">d</code>)  are printed through the <code class="highlighter-rouge">cat</code> statement.</li>
  <li>A dataset is returned from the <code class="highlighter-rouge">OutputDataSet</code> variable. The schema of the resultset is defined in <code class="highlighter-rouge">WITH RESULT SETS ...</code>.</li>
</ul>

<p>In addition to the scenarios above, parameters are also transferred (both in and out), but for now we’ll leave those out of the discussion.</p>

<p>So, cast you mind back to <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I</a> and <a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Internals - II</a> (“woooosh” - that’s the sound of your mind being cast back), where we discussed what happens when we execute <code class="highlighter-rouge">sp_execute_external_script</code>. We said that, SQL Server’s <code class="highlighter-rouge">sqllang!SpExecuteExternalScript</code> is called, and SQL Server then opens a named pipe connection to the launchpad service and sends a data packet to the service. The launchpad service creates the necessary processes (RTerm) etc., and sends the data packet it received on tho the executing process. The assumption made, at least implicitly,  was that all the necessary data is transferred to the R engine via the packets SQL Server sends to the launchpad service and that the launchpad sends it on. For return data the assumption was that the data is returned the same way. That’s what I thought up until <a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Internals - IX</a> when we discussed the SqlSatellite. So, let’s see what really happens.</p>

<h4 id="data---r">Data -&gt; R</h4>

<p>To see how data is sent to R, let’s fire up our trusted <strong>WinDbg</strong> an attach it to both the SQL Server process as well as the launchpad process:</p>

<ul>
  <li>Restart SQL Server and the launchpad service (just to start afresh).</li>
  <li>Attach WinDbg (as admin) to the two processes (one WinDbg instance each).</li>
</ul>

<p>Now we can set some break-points for both SQL Server as well as the launchpad process, and the break-points we set are some of the ones we have used in previous posts:</p>

<ul>
  <li>SQL Server: <code class="highlighter-rouge">sqllang!SpExecuteExternalScript</code></li>
  <li>SQL Server: <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::OpenNpConnection</code></li>
  <li>SQL Server: <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code></li>
  <li>SQL Server: <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ConnectToSatellite</code></li>
  <li>Launchpad: <code class="highlighter-rouge">launchpad!Np::AcceptConnection</code></li>
  <li>Launchpad: <code class="highlighter-rouge">launchpad!Np::ReadAsync</code></li>
  <li>Launchpad: <code class="highlighter-rouge">launchpad!CSQLSatelliteCommunication::SendResumeWithLoginInfo</code></li>
  <li>Launchpad: <code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::WriteMessage</code></li>
</ul>

<p>The code we’ll use initially is not what we see in <em>Code Snippet 2</em>, but something very, very basic:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">exec</span> <span class="n">sp_execute_external_script</span>
                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(30)
                 d&lt;-42'</span>
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Basic External Script</em></p>

<p>The reason for using simple code like in <em>Code Snippet 3</em>, is that it might make it easier to understand what is happening, and we can compare with what is happening when executing some other, not so basic, code. Notice how in <em>Code Snippet 3</em> there is a <code class="highlighter-rouge">Sys.sleep</code>. It is there to make it easier to determine - when debugging - when data is sent to R and when data is coming back.</p>

<p>We can now go ahead and execute the code in <em>Code Snippet 3</em>, and what we will see is how we break in following order:</p>

<ol>
  <li><code class="highlighter-rouge">sqllang!SpExecuteExternalScript</code> is called.</li>
  <li><code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::OpenNpConnection</code></li>
  <li><code class="highlighter-rouge">launchpad!Np::AcceptConnection</code></li>
  <li><code class="highlighter-rouge">launchpad!Np::ReadAsync</code></li>
  <li><code class="highlighter-rouge">launchpad!Np::ReadAsync</code></li>
  <li><code class="highlighter-rouge">launchpad!Np::ReadAsync</code></li>
  <li><code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code></li>
  <li><code class="highlighter-rouge">launchpad!Np::ReadAsync</code></li>
  <li><code class="highlighter-rouge">launchpad!CSQLSatelliteCommunication::SendResumeWithLoginInfo</code></li>
  <li><code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::WriteMessage</code> - notice how nothing happens in the SQL process until <code class="highlighter-rouge">WriteMessage</code> is executed.</li>
  <li><code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ConnectToSatellite</code></li>
  <li><code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code></li>
  <li><code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code></li>
  <li>Pause for <code class="highlighter-rouge">Sys.sleep</code></li>
  <li><code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code></li>
  <li><code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code></li>
  <li><code class="highlighter-rouge">launchpad!Np::ReadAsync</code></li>
  <li><code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::WriteMessage</code></li>
</ol>

<p>For now we won’t bother over what happens after the <code class="highlighter-rouge">Sys.sleep</code>, but we can see some behaviors that might make us doubt that we have been entirely correct in our previous assumptions how data is sent to the R engine. I am thinking about some of the <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code> who doesn’t have a corresponding launchpad action.</p>

<p>Let us see what happens if we were to execute the code in <em>Code Snippet 2</em>. Before you execute the code, change the <code class="highlighter-rouge">SELECT y ...</code> statement to be <code class="highlighter-rouge">SELECT TOP(10) y ...</code>. When you execute you will see a third <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code> before the <code class="highlighter-rouge">Sys.sleep</code>. After the <code class="highlighter-rouge">Sys.sleep</code> there’d be a third <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code> and a second  <code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::WriteMessage</code>. What happens if the <code class="highlighter-rouge">TOP</code> clause was changed to be <code class="highlighter-rouge">TOP(100000)</code> (hundred thousand)? Then there’d be 5 <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code> after <code class="highlighter-rouge">ConnectToSatellite</code> and the rest would stay the same. Based on this, there seems to be some impact based on how much data is being transferred, and it seems that the launchpad service is bypassed for at least some data transfer (as we don’t see any extra <code class="highlighter-rouge">launchpad!Np::ReadAsync</code>).</p>

<p>So if the launchpad service is being bypassed, what would be used to transfer data? Seeing that we discussed SqlSatellite in <a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Internals - IX</a>, and also mentioned SqlSatellite above, that might be the answer. Unfortunately we have no debug symbols for SqlSatellite or its host <code class="highlighter-rouge">BxlServer.exe</code>, so we cannot use WinDbg to check and see if we are correct. What we’ll do instead is to take advantage of the fact that SqlSatellite communicates with SQL Server using sockets, and we’ll use <a href="https://technet.microsoft.com/en-us/sysinternals/processmonitor.aspx"><strong>Process Monitor</strong></a>, to see if we can find any interesting things.</p>

<blockquote>
  <p><strong>NOTE:</strong> We used <em>Process Monitor</em> in <a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Internals - VII</a>, so go back there if you need pointers of how to use <em>Process Monitor</em>.</p>
</blockquote>

<p>After you have started up Process Monitor as admin, suppress any event monitoring to start with, as not too be flooded with events. You should also just choose to see event types you are interested in, in this case “Network Activity”. You can do this through the icons in the tool bar, as per below:</p>

<p><img src="/images/posts/sql_r_services_10_procmon1.png" alt="" /></p>

<p><strong>Figure 7:</strong> <em>Communication Mechanisms</em></p>

<p>In <em>Figure 7</em> we see how event capturing is paused due to having clicked on the magnifying glass (in the first outlined box). We also have chosen to receive only “Network Activity” events (the second outlined box). You can see that “Network Activity” is enabled as it has a barely visible light-blue background, and the others do not. Having set this up, now is a good time to clear out any events that might have been captured, so under the <em>Edit</em> menu click <em>Clear Display</em>.</p>

<p>So what are we going to use <em>Process Monitor</em> for? Well, as I mentioned above, there is socket communication between SQL Server and SqlSatellite, so we’ll try and capture that particular traffic. In order to do this, we’ll set up some <em>Process Monitor</em> event filters, the same way as we did in <a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Internals - VII</a>. The filters we’ll setup are for “Process Name” and “Operation”. The process we initially are interested in is <code class="highlighter-rouge">BxlServer.exe</code>, since BxlServer hosts the SqlSatellite. The operations we want are “TCP Connect” and “TCP Receive”. The idea is that we will be able to see when a connection is made between SQL Server and the SqlSatellite and if there is any data sent to the satellite from SQL Server.</p>

<p>To set the filter; under the <em>Filter</em> menu click the Filter menu item, and the “Process Monitor Filter” dialog will be shown. To create the filter we enter the conditions we want to match:</p>

<ul>
  <li>The <em>Process Name</em> (from first drop down) should be  <em>is</em> (from second drop down): <code class="highlighter-rouge">bxlserver.exe</code>.</li>
  <li><em>Operation</em> (first drop down) <em>is</em> (second drop down): “TCP Connect”</li>
  <li><em>Operation</em> (first drop down) <em>is</em> (second drop down): “TCP Receive”</li>
</ul>

<p>The conditions should be included and added, and when you are done the filter dialog should look something like so:</p>

<p><img src="/images/posts/sql_r_services_10_procmon_filter1_created.png" alt="" /></p>

<p><strong>Figure 8:</strong> <em>Filters BxlServer</em></p>

<p>What the filter says is that any “TCP Connect”, or “TCP Receive” events for <code class="highlighter-rouge">bxlserver.exe</code> should be monitored and displayed. Oh, and the only three filter criteria active (green check-mark) should be the top three ones. When you have clicked “OK” out of the dialog box, we are ready to test this out:</p>

<ul>
  <li>Ensure that you still are attached with the two WinDbg instances to SQL Server and the launchpad processes.</li>
  <li>It my be a good idea to in WinDbg clean out the command window (<code class="highlighter-rouge">.cls</code>).</li>
</ul>

<p>For this test we’ll use the code in <em>Code Snippet 3</em>, just so we can get something of a baseline. When you execute the code, look at what is happening in the two WinDbg instances as well as in <em>Process Monitor</em>. The flow of the events are something like this:</p>

<ol>
  <li><code class="highlighter-rouge">sqllang!SpExecuteExternalScript</code> is called.</li>
  <li><code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::OpenNpConnection</code></li>
  <li><code class="highlighter-rouge">launchpad!Np::AcceptConnection</code></li>
  <li><code class="highlighter-rouge">launchpad!Np::ReadAsync</code></li>
  <li><code class="highlighter-rouge">launchpad!Np::ReadAsync</code></li>
  <li><code class="highlighter-rouge">launchpad!Np::ReadAsync</code></li>
  <li><code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code></li>
  <li><code class="highlighter-rouge">launchpad!Np::ReadAsync</code></li>
  <li>TCP Connect</li>
  <li>TCP Receive</li>
  <li>TCP Receive</li>
  <li><code class="highlighter-rouge">launchpad!CSQLSatelliteCommunication::SendResumeWithLoginInfo</code></li>
  <li><code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::WriteMessage</code></li>
  <li><code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ConnectToSatellite</code></li>
  <li><code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code></li>
  <li>TCP Receive</li>
  <li><code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code></li>
  <li>TCP Receive</li>
  <li>Pause for <code class="highlighter-rouge">Sys.sleep</code></li>
  <li><code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code></li>
  <li>TCP Receive</li>
  <li>TCP Receive</li>
  <li><code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code></li>
  <li><code class="highlighter-rouge">launchpad!Np::ReadAsync</code></li>
  <li><code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::WriteMessage</code></li>
</ol>

<p>The output in <em>Process Monitor</em> looks like so (I have truncated the <code class="highlighter-rouge">Path</code> and <code class="highlighter-rouge">Detail</code> columns somewhat):</p>

<p><img src="/images/posts/sql_r_services_10_procmon_output1.png" alt="" /></p>

<p><strong>Figure 9:</strong> <em>Process Monitor Base Output</em></p>

<p>From what we can see, the three first TCP events happens while we connect. The fourth happens after a <code class="highlighter-rouge">WriteMessage</code>, and the fifth after the second <code class="highlighter-rouge">WriteMessage</code> before <code class="highlighter-rouge">Sys.sleep</code>. The remainders we don’t care about right now, as we’ll look at them when we investigate how data is returned to SQL Server. At this stage we cannot say for sure what happens, and what the different packages are for - but we can definitely see that data is being sent to SqlSatellite from SQL Server.</p>

<p>OK, so let’s try with some other code:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>  
                  <span class="o">@</span><span class="k">language</span> <span class="o">=</span><span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
                  <span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s1">'
                  Sys.sleep(10)
                  pid &lt;- Sys.getpid()
                  d &lt;- getwd()
                  cat(paste0("ProcessId: ", pid))
                  cat("</span><span class="se">\n</span><span class="s1">")
                  cat(paste0("WorkDir: ", d))
                  cat("</span><span class="se">\n</span><span class="s1">")'</span>
</code></pre></div></div>
<p><strong>Code Snippet 4:</strong> <em>Longer R Script</em></p>

<p>There is not much difference between what we execute in <em>Code Snippet 3</em> and this code in <em>Code Snippet 4</em>, except for the <em>Code Snippet 4</em> script being longer. Will size matter; let’s look at what happens in WinDbg and the output from <em>Process Monitor</em> after we have executed the code in <em>Code Snippet 4</em>:</p>

<p><img src="/images/posts/sql_r_services_10_procmon_output2.png" alt="" /></p>

<p><strong>Figure 10:</strong> <em>Process Monitor Output Longer Script</em></p>

<p>The flow in WinDbg did not change at all, and the same amount of packages were sent. However, the fourth event (packet), following <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ConnectToSatellite</code> and <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code> has a different size (870 vs. 204), as can be seen in <em>Figure 10</em>. Hmm, this would certainly indicate that the script to execute is sent over the socket connection to SqlSatellite, and not via the named pipe connection to the launchpad service. What about data going to the R engine? Based on what we saw when we executed the code in <em>Code Snippet 2</em> with a <code class="highlighter-rouge">SELECT TOP(100000) y ...</code> (multiple <code class="highlighter-rouge">WriteMessage</code> calls) we can probably safely assume that the data is also sent over the TCP connection. Just to ensure this really is the case we can test it out. We’ll change the code slightly, once again to have something to compare it to:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">exec</span> <span class="n">sp_execute_external_script</span>
                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(30)
                 d&lt;-42'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
              SELECT TOP(1) y, rand1, rand2, rand3, 
                      rand4, rand5 
              FROM dbo.rand_1M'</span>
</code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>External Script with Data Select</em></p>

<p>The output from <em>Process Monitor</em> looks as follows:</p>

<p><img src="/images/posts/sql_r_services_10_procmon_output3.png" alt="" /></p>

<p><strong>Figure 11:</strong> <em>Process Monitor Output Data Select</em></p>

<p>This is strange, the R script we executed here is exactly the same as in <em>Code Snippet 3</em>, but the packet size is different (350 vs. 204), and we also have a new packet sent to the SqlSatellite with a size of 6300. Let’s start with the last portion first; the packet with the size of 6300.</p>

<p>This packet actually contains the data sent to the SqlSatellite (the data represented by the  <code class="highlighter-rouge">@input_data_1</code> variable). Normally when SQL transfers data it is done via the <a href="https://en.wikipedia.org/wiki/Tabular_Data_Stream">TDS protocol</a> (Tabular Data Stream). However when sending data to and from the SqlSatellite, TDS is not used, but a custom protocol called <strong>BXL</strong> (Binary eXchange Language). The BXL protocol is optimized for fast data transfers between SQL Server and external script engines.</p>

<p>In the next blog-post in this series, we’ll look more at the BXL protocol, and why you see a packet size of 6300, when we only retrieve one row, with six <code class="highlighter-rouge">int</code> columns.</p>

<p>Let us look at the first question; why is the packet size different when the R script is exactly the same. To try to figure this out, we’ll use a packet analyzer:  <a href="https://www.wireshark.org/"><strong>WireShark</strong></a>.</p>

<blockquote>
  <p><strong>NOTE:</strong> If you are running SSMS and SQL Server on the same machine, then you need the <a href="https://nmap.org/npcap/"><strong>Npcap</strong></a> packet sniffer library instead of the default <strong>WinPcap</strong>. This is because WinPcap doesn’t support loop-back adapters.</p>
</blockquote>

<p>At this stage you don’t need the WinDbg breakpoints, so just disable all the breakpoints, both for SQL Server as well as the launchpad process. Also take note of the port SQL Server listens on for the satellite connection. We need the port number to filter events in WireShark, and we can get the port number by running <code class="highlighter-rouge">netstat -o -a -n</code> or look at the <code class="highlighter-rouge">Path</code> column in <em>Process Monitor</em>:</p>

<p><img src="/images/posts/sql_r_services_10_procmon_output_port.png" alt="" /></p>

<p><strong>Figure 12:</strong> <em>Get Port Number from Path</em></p>

<p>Equipped with the port number, it is time to set up <em>WireShark</em> for packet sniffing. Start <em>WireShark</em> as admin and on the opening screen double click the “Npcap Loopback Adapter”:</p>

<p><img src="/images/posts/sql_r_services_10_wireshark1.png" alt="" /></p>

<p><strong>Figure 13:</strong> <em>WireShark</em></p>

<p>That will now immediately start capturing events:</p>

<p><img src="/images/posts/sql_r_services_10_wireshark2.png" alt="" /></p>

<p><strong>Figure 14:</strong> <em>WireShark Events</em></p>

<p>Capturing can be stopped by clicking <strong>Ctrl + E</strong>, or click on the red square in <em>Figure 14</em> to the right of the grayed-out shark fin in the tool-bar. What we want to do now is to create a <em>WireShark</em> display filter, so we only see network packets we are interested in. The filter we’ll set is a filter showing only packets originating from the SQL Server’s listening port, as in <em>Figure 12</em> above. You set the filter in the text box just underneath the toolbox, and the filter you use is <code class="highlighter-rouge">tcp.srcport==port_number</code>, you then apply it by clicking on the right arrow to the right the filter box:</p>

<p><img src="/images/posts/sql_r_services_10_wireshark_display_filter.png" alt="" /></p>

<p><strong>Figure 15:</strong> <em>WireShark Display Filter</em></p>

<p>In <em>Figure 15</em>, I set the filter to be <code class="highlighter-rouge">tcp.srcport==50755</code>, and then I applied the filter by clicking the arrow. To start using this:</p>

<ul>
  <li>Clear the <em>Process Monitor</em> display, and make sure you are capturing events.</li>
  <li>Start <em>WireShark</em> capturing (Ctrl+E). If you get a question whether you want to save the captured packets, just click “Continue without Saving”.</li>
  <li>Execute the code in <em>Code Snippet 3</em>.</li>
</ul>

<p>The <em>Process Monitor</em> output looks almost the same as in <em>Figure 9</em>, whereas the <em>WireShark</em> output looks like so:</p>

<p><img src="/images/posts/sql_r_services_10_wireshark_output1.png" alt="" /></p>

<p><strong>Figure 16:</strong> <em>WireShark Captured Packets</em></p>

<p><em>WireShark</em> has captured the various packets sent from SQL Server, and we can see the same packages in <em>WireShark</em> as in <em>ProcessMonitor</em>.</p>

<blockquote>
  <p><strong>NOTE:</strong> Actually <em>WireShark</em> has a couple of more packets, as <em>ProcessMonitor</em> doesn’t show some of the <code class="highlighter-rouge">ACK</code> packets.</p>
</blockquote>

<p>The packet we are interested in is the one that is outlined in red in <em>Figure 16</em>, with a length of 204. Click on it and in the lower pane in <em>WireShark</em> (the packet bytes pane) you will see the data of the packet in a hex-dump style, and on the right hand side the corresponding ASCII text translation:</p>

<p><img src="/images/posts/sql_r_services_10_wireshark_output2.png" alt="" /></p>

<p><strong>Figure 17:</strong> <em>WireShark Hex-dump</em></p>

<table>
  <tbody>
    <tr>
      <td>The interesting part in <em>Figure 17</em> is the ASCII text translation (outlined in red) where we see something that is somewhat readable, and parts of it looks suspiciously like our script. I copied out the ASCII translation (File</td>
      <td>Export Packet Dissections</td>
      <td>As Plain Text), and this is what it looked like:</td>
    </tr>
  </tbody>
</table>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.........q<span class="s1">'.Nz.F
....z/CN........
......I.n.p.u.t.
D.a.t.a.S.e.t...
..O.u.t.p.u.t.D.
a.t.a.S.e.t...0.
..0.............
..E.x.p.r.1.0.0.
0...B.....S.y.s.
..s.l.e.e.p.(.1.
0.).;. ..... . .
 . . . . . . . .
d.&lt;.-.4.2...
</span></code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>WireShark Packet ASCII Text</em></p>

<p>In <em>Code Snippet 6</em> we see how our script (<code class="highlighter-rouge">S.y.s...s.l.e.e.p.(.1.0.).;. ..... . . . . . . . . . .d.&lt;.-.4.2...</code>) is actually sent to the SqlSatellite. What is then the part of the text saying <code class="highlighter-rouge">E.x.p.r.1.0.0.0...B</code>, and why is the length of the packet sent to SqlSatellite different between <em>Code Snippet 3</em> and <em>Code Snippet 5</em>, when the script is the same?</p>

<p>Start a new capture in <em>WireShark</em> and execute the code in <em>Code Snippet 5</em>. After you have executed, choose the packet in <em>WireShark</em> with a length of 350, and look at the ASCII text. In <em>Code Snippet 7</em> below, we see what it looks like on my machine after I did it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>....^....pq&amp;U..A
..8..N+A........
......I.n.p.u.t.
D.a.t.a.S.e.t...
..O.u.t.p.u.t.D.
a.t.a.S.e.t.....
................
..y.............
..........r.a.n.
d.1.............
..........r.a.n.
d.2.............
..........r.a.n.
d.3.............
..........r.a.n.
d.4.............
..........r.a.n.
d.5...B.....S.y.
s...s.l.e.e.p.<span class="o">(</span><span class="nb">.</span>
1.0.<span class="o">)</span><span class="nb">.</span> ..... <span class="nb">.</span> <span class="nb">.</span>
 <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
 .d.&lt;.-.4.2...
</code></pre></div></div>
<p><strong>Code Snippet 7:</strong> <em>WireShark Packet with Input Data ASCII Text</em></p>

<p>As we see in <em>Code Snippet 7</em>, part of what is sent to the SqlSatellite is also the actual column names/variables for the script.</p>

<p>Finally what we’ll do is to see how a script which expects a resultset coming back, is sent to the SqlSatellite. For this we’ll use the code in <em>Code Snippet 8</em> below:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span> 
            <span class="o">@</span><span class="k">language</span> <span class="o">=</span><span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s1">'Sys.sleep(10)
               d&lt;-42
               OutputDataSet&lt;-InputDataSet'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span><span class="n">N</span><span class="s1">'SELECT 42 as col1, 
                             666 AS col2'</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">(([</span><span class="n">TheAnswer</span><span class="p">]</span> <span class="n">int</span><span class="p">,</span> 
                   <span class="p">[</span><span class="n">TheDevil</span><span class="p">]</span> <span class="n">int</span><span class="p">));</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 8:</strong> <em>Script with Resultset</em></p>

<p>The code in <em>Code Snippet 8</em>, sends in two columns <code class="highlighter-rouge">col1</code> and <code class="highlighter-rouge">col2</code> and we expect a resultset back with two columns; <code class="highlighter-rouge">TheAnswer</code> and <code class="highlighter-rouge">TheDevil</code>. After having executed the code, and looking at the captured packet in <em>WireShark</em> we see something looking like so:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>........:......M
...K..B.........
......I.n.p.u.t.
D.a.t.a.S.e.t...
..O.u.t.p.u.t.D.
a.t.a.S.e.t...8.
..8.............
..c.o.l.1...8...
8...............
c.o.l.2...8...8.
..............T.
h.e.A.n.s.w.e.r.
..8...8.........
......T.h.e.D.e.
v.i.l.........S.
y.s...s.l.e.e.p.
<span class="o">(</span>.1.0.<span class="o">)</span>..... <span class="nb">.</span> <span class="nb">.</span>
 <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
 <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
 <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> .d.&lt;.-.
4.2..... <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
 <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
 <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
 <span class="nb">.</span> <span class="nb">.</span> .O.u.t.p.u.
t.D.a.t.a.S.e.t.
&lt;.-.I.n.p.u.t.D.
a.t.a.S.e.t...
</code></pre></div></div>
<p><strong>Code Snippet 9:</strong> <em>WireShark Packet for Input and Output</em></p>

<p>In <em>Code Snippet 9</em> we see how we are sending to the SqlSatellite, in addition the the script and the input data column names, also the output data columns.</p>

<p>By now it should be clear that SQL Server uses the SqlSatellite socket connection to send both the external script to execute as well as the actual data to the satellite. In following posts we will look at the BXL protocol used to send data to the satellite, and also how data is sent back to SQL Server.</p>

<h2 id="summary">Summary</h2>

<p>From previous posts we knew that SQL Server communicates with the launchpad service over named pipes. We also know that there is communication between SQL Server and the SqlSatellite over sockets. We may have assumed that data was sent from SQL Server to the R components through the named pipe connection to the launchpad service, and the on from there to the R components.</p>

<p>In this post we have seen how that is not true, but how both the script to execute including some metadata, as well as the actual data to use for analysis (<code class="highlighter-rouge">@input_data_1</code>) is sent over the socket connection.</p>

<h2 id="-finally">~ Finally</h2>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/08/29/microsoft-sql-server-r-services-internals-x/&text=Microsoft SQL Server R Services - Internals X&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/08/29/microsoft-sql-server-r-services-internals-x/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2017/08/29/microsoft-sql-server-r-services-internals-x/
         &title=Microsoft SQL Server R Services - Internals X
         &summary=Blog post: Here we look at how data is sent to SqlSatellite. We use WinDbg, WireShark and other cool stuff!
         &source=http://www.nielsberglund.com/2017/08/29/microsoft-sql-server-r-services-internals-x/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/08/29/microsoft-sql-server-r-services-internals-x/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-machine-learning-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Machine Learning Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#windbg">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WinDbg</span>
    </a>
  
    
    <a href="/tags/#launchpad">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Launchpad</span>
    </a>
  
    
    <a href="/tags/#rterm-exe">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">RTerm.exe</span>
    </a>
  
    
    <a href="/tags/#sqlsatellite">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SqlSatellite</span>
    </a>
  
    
    <a href="/tags/#wireshark">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WireShark</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2017/08/29/microsoft-sql-server-r-services-internals-x/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2017/08/29/microsoft-sql-server-r-services-internals-x/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/12/interesting-stuff-week-32/">
            Interesting Stuff - Week 32
            <small>12 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
