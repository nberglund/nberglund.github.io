<!DOCTYPE html> <html lang="en-us"> <head> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="Investigation SQL Server 2017 &quot;clr strict security&quot; and its impact on SQLCLR"> <meta name="keywords" content="SQL Server, SQL Server 2017, SQLCLR, permissions, clr strict security, certificates, TRUSTWORTHY"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> SQL Server 2017, SQLCLR and Permissions &middot; MANAGED DATA </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-fa627a383d47b30c65e6b1ee58efc794.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.2.3 --> <title>SQL Server 2017, SQLCLR and Permissions | MANAGED DATA</title> <meta property="og:title" content="SQL Server 2017, SQLCLR and Permissions" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Investigation SQL Server 2017 &quot;clr strict security&quot; and its impact on SQLCLR" /> <meta property="og:description" content="Investigation SQL Server 2017 &quot;clr strict security&quot; and its impact on SQLCLR" /> <link rel="canonical" href="http://localhost:4000//2017/07/02/sql-server-2017-sqlclr-and-permissions/" /> <meta property="og:url" content="http://localhost:4000//2017/07/02/sql-server-2017-sqlclr-and-permissions/" /> <meta property="og:site_name" content="MANAGED DATA" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2017-07-02T08:18:48+02:00" /> <script type="application/ld+json"> {"@context":"http://schema.org","@type":"BlogPosting","headline":"SQL Server 2017, SQLCLR and Permissions","author":{"@type":"Person","name":"nielsb"},"datePublished":"2017-07-02T08:18:48+02:00","dateModified":"2017-07-02T08:18:48+02:00","description":"Investigation SQL Server 2017 &quot;clr strict security&quot; and its impact on SQLCLR","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000//2017/07/02/sql-server-2017-sqlclr-and-permissions/"},"url":"http://localhost:4000//2017/07/02/sql-server-2017-sqlclr-and-permissions/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <div class="sidebar"> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1> <a href="/"> MANAGED DATA </a> </h1> <p class="lead">Technology musings about coding and data. Topics covered are - amongst others - .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <section> <h3 style="color:#ffffff">Disclaimer</h3> <p>This is my personal blog. The views expressed on these pages are mine alone and not those of my employer.</p> </section> <p>&copy; 2017. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">SQL Server 2017, SQLCLR and Permissions</h1> <div class="post-subheading"> <span class="post-date">02 Jul 2017</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#SQL Server 2017">SQL Server 2017</a> <a href="/categories/#SQLCLR">SQLCLR</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server">SQL Server</a> <a href="/tags/#SQL Server 2017">SQL Server 2017</a> <a href="/tags/#SQLCLR">SQLCLR</a> <a href="/tags/#permissions">permissions</a> <a href="/tags/#clr strict security">clr strict security</a> <a href="/tags/#certificates">certificates</a> <a href="/tags/#TRUSTWORTHY">TRUSTWORTHY</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <p>While I was writing the post about <a href="/2017/07/01/sqlclr-certificates/">SQLCLR and Certificates</a>, I came across some strange behavior when I accidentally ran my code on an SQL Server 2017 instance. I quickly connected back to my SQL Server 2016 instance and continued. However, afterwards I started to look into the differences between SQLCLR in SQL Server 2017 and SQL Server 2016, and this post is the result of me <del>playing around</del> investigating the changes.</p> <!--more--> <p>Let's start with a recap and an example</p> <h2>Recap</h2> <p>In all versions of SQL Server from 2005 (where SQLCLR was introduced) up to 2016; when you deploy assemblies to the database and you want the assemblies to be able to execute outside of the database it is deployed to, you assign a permission set to the assembly. There are three permission sets available, ranging from not allowing you to shoot yourself in the foot to blow your head off:</p> <ul> <li><code>SAFE</code> - the code is not doing anything that you cannot do in T-SQL. You cannot shoot yourself in the foot any more than what you can do with T-SQL. This is the default.</li> <li><code>EXTERNAL_ACCESS</code> - you can get outside of the local database, but only via "approved" assemblies, such as <code>ADO.NET</code>, etc. You can definitely shoot yourself in the foot.</li> <li><code>UNSAFE</code> - You can do pretty much what you want. You are free to blow your head off.</li> </ul> <p>The permission set is assigned when you create the assembly:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Create Assembly</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="o">&lt;</span><span class="n">some_name</span><span class="o">&gt;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="s1">'F:</span><span class="se">\</span><span class="s1">some_path</span><span class="se">\</span><span class="s1">somedll.dll'</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="n">PERMISSION_SET</span> <span class="o">=</span> <span class="n">SAFE</span> <span class="o">|</span> <span class="n">EXTERNAL_ACCESS</span> <span class="o">|</span> <span class="n">UNSAFE</span><span class="p">;</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Creating an Assembly from Absolute Path</em></p> <p>In order to create an assembly with anything else than <code>SAFE</code>, the database or assembly need to have additional authorizations, and that was what my <a href="/2017/07/01/sqlclr-certificates/">SQLCLR and Certificates</a> post covered.</p> <p>To see what has changed in SQL Server 2017, let's look at some sample code. In <em>Code Snippet 1</em> you see some C# code that we want to deploy to a SQL Server 2017 database:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Safe</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">namespace</span> <span class="nn">Sql2k17SqlClr</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">&#x7b;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">Functions</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">&#x7b;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fn_clr_Adder</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7b;</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="k">return</span> <span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">;</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7d;</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">&#x7d;</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">&#x7d;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Safe Code to be Deployed</em></p> <p>After having built the project with the code in <em>Code Snippet 1</em>, you would deploy it to a specific database in your SQL Server instance like so (the dll is named <code>Sql2k17SqlClr1.dll</code>):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Assembly Creation</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="n">Sql2k17SqlClr</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="s1">'W:</span><span class="se">\</span><span class="s1">&lt;path_to_dll&gt;</span><span class="se">\</span><span class="s1">Sql2k17SqlClr1.dll'</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>Create Safe Assembly</em></p> <p>The assembly we want to create in the database is definitely a safe assembly, as it is just doing some internal calculation, and in SQL Server (pre 2017), this would deploy just fine. In SQL Server 2017 however things are different. When you run the code in <em>Code Snippet 2</em>, you will get following error:</p> <p><img class="center" src="/images/posts/sql2k17_safe.png" width="430" height="209" > <strong>Figure 1:</strong> <em>Error Deploying Safe Assembly</em></p> <p>The error you see is more or less the same you'd receive if you - in SQL Server pre 2017 - tried to deploy an assembly as <code>EXTERNAL_ACCESS</code> or <code>UNSAFE</code>. You can read more about that particular issue in my <a href="/2017/07/01/sqlclr-certificates/">SQLCLR and Certificates</a> post.</p> <p>One difference in the error message you see in <em>Figure 1</em>, and what you would have received in pre SQL Server 2017 versions, is: "<em>the 'clr strict security' option of sp_configure is set to 1</em>". You may think; "what is this, I have never seen that in other SQL Server versions". You are absolutely correct, so let's look at that - and we'll start with <strong>Code Access Security</strong> (<strong>CAS</strong>)</p> <h2>Code Access Security</h2> <p>CAS is a security technology developed to provide the ability to protect system resources when a .NET assembly is executed. Such system resources could be: local files, files on a remote file system, registry keys, databases, printers and so on. CAS, in essence, was used to enforce security boundaries based on code origination or other identity aspects, and SQL Server's <code>PERMISSION_SET</code> relied on the CAS security boundaries. That was how SQLCLR assemblies which only performed "safe" operations did not need any further authorizations.</p> <p>In recent versions of the .NET framework (around version 4.5), Microsoft has changed the relation between CAS and security boundaries, and CAS is no longer supported as a boundary! From a SQLCLR perspective that is a real "bummer", as theoretically there is no control over what an assembly can and cannot do (whereas before <code>PERMISSION_SET</code> controlled the abilities).</p> <blockquote><p><strong>NOTE:</strong> The above statement about no control what an assembly can and cannot do is not entirely correct as we will see further down.</p></blockquote> <h3><code>clr strict security</code></h3> <p>With the changes of the implications of CAS, and in order to enhance the security of CLR assemblies, Microsoft has in SQL Server 2017 introduced an <code>sp_configure</code> option called <code>clr strict security</code>, which by default is set to 1 (on). When the setting is on, SQL Server treats all assemblies (<code>SAFE</code>, <code>EXTERNAL_ACCESS</code>, <code>UNSAFE</code>) as if they were marked <code>UNSAFE</code>. The implication of this is that you must either:</p> <ul> <li>Set the database to be <code>TRUSTWORTHY</code>, <em>OR</em></li> <li>Sign the assembly with a certificate that has a corresponding login with <code>UNSAFE ASSEMBLY</code> permission, <em>OR</em></li> <li>Sign the assembly with an asymmetric key that has a corresponding login with <code>UNSAFE ASSEMBLY</code> permission.</li> </ul> <p>If you changed the <code>clr strict security</code> option to 0, the code in <em>Code Snippet 2</em>, would work just fine. Likewise, if you didn't change the option, but instead set <code>TRUSTWORTHY ON</code> on the database, it would also work.</p> <h2>Assembly Authorization</h2> <p>So, where are we? In order to create a safe assembly we now need to authorize it as we would an <code>EXTERNAL_ACCESS</code> or <code>UNSAFE</code>, so let's do that to the assembly that the code in <em>Code Snippet 2</em> represents. We could do it by setting <code>TRUSTWORTHY</code> to <code>ON</code> for the database, and you who read my <a href="/2017/07/01/sqlclr-certificates/">SQLCLR and Certificates</a> post know that I do not think that setting <code>TRUSTWORTHY</code> to <code>ON</code> is like "opening the gates to hell", so I would not have an issue with doing that - even on a production database. That is however a discussion for another day, so let us do it by using a certificate.</p> <p>To recap from the <a href="/2017/07/01/sqlclr-certificates/">SQLCLR and Certificates</a> post, to use a certificate you'd:</p> <ul> <li>Create a certificate, if you don't already have one.</li> <li>Create a <code>.pfx</code> file from the certificate. Pfx stands for Personal Information Exchange, and we'll use it to sign your assembly.</li> <li>Sign the dll with the <code>.pfx</code> file.</li> <li>In the database create a SQL Server certificate from the original certificate.</li> <li>In the database create login from the certificate.</li> <li>Grant the login <code>UNSAFE ASSEMBLY</code>.</li> <li>Create the dll in the database.</li> </ul> <p>I already have a certificate and a <code>.pfx</code> file created from when I wrote the <a href="/2017/07/01/sqlclr-certificates/">SQLCLR and Certificates</a> post, so I'll re-use those and go ahead and sign the assembly with the <code>.pfx</code> file:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Signing</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">signtool</span> <span class="n">sign</span> <span class="o">/</span><span class="n">f</span> <span class="n">NielsTestPfx</span><span class="p">.</span><span class="n">pfx</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="o">/</span><span class="n">p</span> <span class="n">testPwd</span> <span class="n">Sql2k17SqlClr1</span><span class="p">.</span><span class="n">dll</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 3:</strong> <em>Sign the dll Using signtool.exe</em></p> <p>The <code>/p</code> flag in <em>Code Snippet 3</em> defines the password of your <code>.pfx</code> file. After having signed the dll, I create the SQL Server certificate, from the original certificate:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Certificate</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="n">CERTIFICATE</span> <span class="n">NielsTestCert</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="n">FILE</span> <span class="o">=</span> <span class="s1">'W:</span><span class="se">\</span><span class="s1">&lt;path_to_cert&gt;</span><span class="se">\</span><span class="s1">NielsTestCert.cer'</span><span class="p">;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 4:</strong> <em>Create a SQL Server Certificate</em></p> <p>When the certificate is created we can create a login from the certificate, and <code>GRANT</code> the login <code>UNSAFE</code> assembly permissions:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Login</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="n">LOGIN</span> <span class="n">login_NielsTestCert</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="n">CERTIFICATE</span> <span class="n">NielsTestCert</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GRANT</span> <span class="n">UNSAFE</span> <span class="n">ASSEMBLY</span> <span class="k">TO</span> <span class="n">login_NielsTestCert</span><span class="p">;</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 5:</strong> <em>Create a SQL Server Login and Grant Permissions</em></p> <p>After the login has been created and the <code>UNSAFE ASSEMBLY</code> permission granted to the login, the code in <em>Code Snippet 2</em>, should just work. Oh, don't forget to switch back from <code>master</code> to the database where you want to create the assembly.</p> <p>We can then finally create a T-SQL wrapper function against the <code>fn_clr_Adder</code> method:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Function</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_Adder</span><span class="p">(</span><span class="o">@</span><span class="n">x</span> <span class="n">int</span><span class="p">,</span> <span class="o">@</span><span class="n">y</span> <span class="n">int</span><span class="p">)</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">RETURNS</span> <span class="n">int</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXTERNAL</span> <span class="n">NAME</span> <span class="n">Sql2k17SqlClr</span><span class="p">.[</span><span class="n">Sql2k17SqlClr</span><span class="p">.</span><span class="n">Functions</span><span class="p">].</span><span class="n">fn_clr_Adder</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 6:</strong> <em>Create T-SQL Wrapper Function</em></p> <p>To check that it all works, run: <code>SELECT dbo.fn_clr_Adder(21,21)</code> and the <a href="https://en.wikipedia.org/wiki/42_(number)"><em>Answer to the Ultimate Question of Life, the Universe, and Everything</em></a> should be returned to you.</p> <p>So far this does not seem too bad, OK - so for a <code>SAFE</code> assembly we need to sign the assembly and have a login with <code>UNSAFE ASSEMBLY</code> permissions granted (or have <code>TRUSTWORTHY</code> on).</p> <h2>Confusion About <code>SAFE</code> Assemblies</h2> <p>Since the introduction of <code>clr strict security</code> there has been some confusion about how <code>SAFE</code> assemblies will behave, and part of this confusion can be attributed to the <a href="https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/clr-strict-security">documentation</a> around <code>clr strict security</code>. Specifically this statement: <em>A CLR assembly created with PERMISSION_SET = SAFE may be able to access external system resources, call unmanaged code, and acquire sysadmin privileges.</em>. When reading that statement, my understanding is that if I create an assembly as <code>SAFE</code> I could potentially do <code>UNSAFE</code> operations.</p> <p>Let us test this out, and create a second dll <code>Sql2k17SqlClr2.dll</code>, where the code looks like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Sql2k17SqlClr2.dll</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">namespace</span> <span class="nn">Sql2k17SqlClr</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">&#x7b;</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">Functions</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">&#x7b;</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fn_clr_Adder</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7b;</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="k">return</span> <span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">;</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7d;</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fn_clr_LongRunningAdder</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7b;</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="kt">var</span> <span class="n">t</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">LongRunning</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">));</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7d;</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="k">static</span> <span class="kt">int</span> <span class="nf">LongRunning</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7b;</span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="kt">var</span> <span class="n">wait</span> <span class="p">=</span> <span class="p">(</span><span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">)</span> <span class="p">*</span> <span class="m">100</span><span class="p">;</span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="k">return</span> <span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">;</span>
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7d;</span>
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">&#x7d;</span>
</div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">&#x7d;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 7:</strong> <em>Safe and Unsafe Behavior</em></p> <p>As you see in <em>Code Snippet 7</em>, we have our trusted <code>fn_clr_Adder</code> method, which is as safe as you can get. But, we also have the <code>fn_clr_LongRunningAdder</code> method which uses a <code>Task</code> for calling into another method and this is definitely <code>UNSAFE</code>. So what will happen here if we, after having built and signed the dll, create the assembly as <code>SAFE</code>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Assembly Creation</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="n">Sql2k17SqlClr2</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="s1">'W:</span><span class="se">\</span><span class="s1">&lt;path_to_dll&gt;</span><span class="se">\</span><span class="s1">Sql2k17SqlClr2.dll'</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="n">PERMISSION_SET</span> <span class="o">=</span> <span class="n">SAFE</span><span class="p">;</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 8:</strong> <em>Create Safe Assembly with Unsafe Method</em></p> <p>Running the code in <em>Code Snippet 8</em> should work, and it would also have worked in previous versions of SQL Server. We can now create a T-SQL wrapper function around the <code>fn_clr_LongRunningAdder</code> method (the method using <code>UNSAFE</code> resources):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Unsafe Function</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_LongRunningAdder</span><span class="p">(</span><span class="o">@</span><span class="n">x</span> <span class="n">int</span><span class="p">,</span> <span class="o">@</span><span class="n">y</span> <span class="n">int</span><span class="p">)</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">RETURNS</span> <span class="n">int</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXTERNAL</span> <span class="n">NAME</span> <span class="n">Sql2k17SqlClr2</span><span class="p">.[</span><span class="n">Sql2k17SqlClr</span><span class="p">.</span><span class="n">Functions</span><span class="p">].</span><span class="n">fn_clr_LongRunningAdder</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 9:</strong> <em>Create an Unsafe T-SQL Wrapper Function</em></p> <p>When I execute <code>SELECT dbo.fn_clr_LongRunningAdder(21, 21)</code> I would expect - having read the statement above - that this would work. However, on my SQL Server 2017 instance (CTP 2.1), I receive an error:</p> <p><img class="center" src="/images/posts/sql2k17_safe_unsafe.png" width="530" height="201" > <strong>Figure 2:</strong> <em>Error Executing UNSAFE Function in SAFE Assembly</em></p> <p>So, <code>HostProtection</code> kicks in and says that I do not have necessary permissions to do the operation. In previous SQL Server versions this would happen if you hadn't assigned the correct <code>PERMISSION_SET</code> to the assembly when it was created. So, let us drop the function and the assembly, and recreate the assembly with <code>PERMISSION_SET = UNSAFE</code>, and recreate the wrapper function:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Recreate Assembly</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">FUNCTION</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_LongRunningAdder</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="n">ASSEMBLY</span> <span class="n">Sql2k17SqlClr2</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="n">Sql2k17SqlClr2</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="s1">'W:</span><span class="se">\</span><span class="s1">&lt;path_to_dll&gt;</span><span class="se">\</span><span class="s1">Sql2k17SqlClr2.dll'</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="n">PERMISSION_SET</span> <span class="o">=</span> <span class="n">UNSAFE</span><span class="p">;</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_LongRunningAdder</span><span class="p">(</span><span class="o">@</span><span class="n">x</span> <span class="n">int</span><span class="p">,</span> <span class="o">@</span><span class="n">y</span> <span class="n">int</span><span class="p">)</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">RETURNS</span> <span class="n">int</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXTERNAL</span> <span class="n">NAME</span> <span class="n">Sql2k17SqlClr2</span><span class="p">.[</span><span class="n">Sql2k17SqlClr</span><span class="p">.</span><span class="n">Functions</span><span class="p">].</span><span class="n">fn_clr_LongRunningAdder</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 10:</strong> <em>Create the Assembly as UNSAFE</em></p> <p>Now when I execute <code>SELECT dbo.fn_clr_LongRunningAdder(21, 21)</code>, it all works as expected. So it seems that <code>PERMISSION_SET</code> still has a role to play, at least in this scenario.</p> <h3>Referenced Assemblies</h3> <p>So what about if I have a <code>SAFE</code> assembly which references an <code>UNSAFE</code> assembly, and calls into an <code>UNSAFE</code> method?</p> <p>I created a third dll: <code>Sql2k17SqlClr3.dll</code>, which has a method that calls into the <code>fn_clr_LongRunningAdder</code> method in the <code>UNSAFE</code> assembly <code>Sql2k17SqlClr2.dll</code>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Function</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">namespace</span> <span class="nn">Sql2k17SqlClr3</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">&#x7b;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">Functions</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">&#x7b;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fn_clr_Adder</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7b;</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="k">return</span> <span class="n">Sql2k17SqlClr</span><span class="p">.</span><span class="n">Functions</span><span class="p">.</span><span class="nf">fn_clr_LongRunningAdder</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7d;</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">&#x7d;</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">&#x7d;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 11:</strong> <em>Method Calling Into UNSAFE Method</em></p> <p>After having built and signed the dll, I deployed it to the database with <code>PERMISSION_SET = SAFE</code>, and created a T-SQL wrapper function around the <code>fn_clr_Adder</code> method. This is what was returned when executing the function:</p> <p><img class="center" src="/images/posts/sql2k17_safe_unsafe.png" width="530" height="201" > <strong>Figure 3:</strong> <em>Error Calling Into UNSAFE Assembly From SAFE</em></p> <p>Also in the case of referenced assemblies, it seems that <code>PERMISSION_SET</code> plays a role. This was confirmed when I dropped and recreated the <code>Sql2k17SqlClr3.dll</code> with <code>PERMISSION_SET = UNSAFE</code>. When I at that stage executed the wrapper function, all worked OK!</p> <h2>Summary</h2> <p>In SQL Server 2017, Microsoft now by default requires that all type of assemblies (<code>SAFE</code>, <code>EXTERNAL_ACCESS</code>, <code>UNSAFE</code>) are authorized for <code>UNSAFE</code> access, by:</p> <ul> <li>The database is set to be <code>TRUSTWORTHY</code>, <em>OR</em></li> <li>The assembly is signed with a certificate that has a corresponding login with <code>UNSAFE ASSEMBLY</code> permission, <em>OR</em></li> <li>The assembly is signed with an asymmetric key that has a corresponding login with <code>UNSAFE ASSEMBLY</code> permission.</li> </ul> <p>The above requirement is handled by a new configure option: <code>clr strict security</code>. The documentation around this option is, at least at the moment, somewhat mis-leading as it implies that <code>PERMISSION_SET</code> no longer has an impact on the behavior of an assembly.</p> <p>The tests above shows however that if you want to do an <code>UNSAFE</code> operation, the assembly has to be created with <code>PERMISSION_SET = UNSAFE</code>. So what I wrote in the beginning of this post: <em>"From a SQLCLR perspective that is a real "bummer", as theoretically there is no control over what an assembly can and cannot do (whereas before <code>PERMISSION_SET</code> controlled the abilities)."</em>, does not seem to be correct.</p> <p>Bear in mind that I am running SQL Server 2017 CTP 2.1, and things may change. I'll try and dig in some more in this, and if I find out something I will edit this post.</p> <h2>~ Finally</h2> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://localhost:4000/2017/07/02/sql-server-2017-sqlclr-and-permissions/&text=SQL Server 2017, SQLCLR and Permissions&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/07/02/sql-server-2017-sqlclr-and-permissions/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2017/07/02/sql-server-2017-sqlclr-and-permissions/ &title=SQL Server 2017, SQLCLR and Permissions &summary=Blog post: Investigation SQL Server 2017 "clr strict security" and its impact on SQLCLR &source=http://www.nielsberglund.com/2017/07/02/sql-server-2017-sqlclr-and-permissions/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/2017/07/02/sql-server-2017-sqlclr-and-permissions/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2017/07/02/interesting-stuff-week-26/"> Interesting Stuff - Week 26 <small> (02 Jul 2017)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2017/07/01/sqlclr-certificates/"> SQLCLR and Certificates <small> (01 Jul 2017)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2017/06/25/interesting-stuff-week-25/"> Interesting Stuff - Week 25 <small> (25 Jun 2017)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
