<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      SQLCLR and Certificates &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">SQLCLR and Certificates</h1>
  <div class="post-subheading">
  <span class="post-date">01 Jul 2017</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#SQLCLR">SQLCLR</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>This post originates, like the one about <a href="/2017/06/25/creating-r-stored-procedures-in-sql-server-2016-using-sqlrutils/">sqlrutils</a>, from a question on a Microsoft forum - this time the <a href="https://social.msdn.microsoft.com/Forums/sqlserver/en-US/home?forum=sqlnetfx">.NET Framework inside SQL Server</a> forum. As the name implies, the forum cover questions about the usage of SQLCLR (.NET inside SQL Server), and the <a href="https://social.msdn.microsoft.com/Forums/sqlserver/en-US/35b8bce5-8ea9-4fd4-aa87-1764a2071e92/long-lasting-pfx-file-for-sqlclr-externalaccess-signing?forum=sqlnetfx">question</a> was about signing of SQLCLR assemblies in order to assigning other permission sets than <code class="highlighter-rouge">SAFE</code> to the assembly.</p>

<p>As I, back in the day, taught SQLCLR as part of Developmentor’s SQL Server curriculum, I thought that it’d be interesting if I tried to answer the question, and also make a blog-post about it. That way I’d remember what to do the next time the question came up.</p>

<blockquote>
  <p><strong>NOTE:</strong> In another post, I wrote this about Developmentor: <em>Developmentor were back in the day THE training company to go to if you wanted highly, highly technical training about COM, .NET, SQL Server, etc. <a href="http://www.javaworld.com/article/2073792/core-java/a-eulogy--developmentor--rip.html">This article</a> by my old colleague <a href="http://blogs.tedneward.com/">Ted Neward</a> (@tedneward) sums DM up quite accurately (apart from the fact that DM hadn’t closed its doors when the article was written, ooops).</em> Ted was probably more accurate than he at the time thought, since DM went out of business somewhat later.</p>
</blockquote>

<p>Anyway, let’s see what this is all about…</p>

<!--more-->

<h2 id="sqlclr">SQLCLR</h2>

<p>SQLCLR is where the .NET framework is embedded in the SQL engine, and you execute .NET code in the SQL Server process. Since you execute .NET code, you can <em>almost</em> do anything you can in a “normal” .NET application.</p>

<blockquote>
  <p><strong>NOTE:</strong> I wrote “almost” above, as there actually are certain limitations. For this discussion however, the limitations have <strong>almost</strong> no impact on what we want to do.</p>
</blockquote>

<p>The way SQLCLR works is that you compile your code into a dll, and you then register the <strong>assembly</strong> with SQL Server:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="o">&lt;</span><span class="n">some_name</span><span class="o">&gt;</span> 
<span class="k">FROM</span> <span class="s1">'F:</span><span class="se">\s</span><span class="s1">ome_path</span><span class="se">\s</span><span class="s1">omedll.dll'</span>
<span class="k">WITH</span> <span class="n">PERMISSION_SET</span> <span class="o">=</span> <span class="n">SAFE</span> <span class="o">|</span> <span class="n">EXTERNAL_ACCESS</span> <span class="o">|</span> <span class="n">UNSAFE</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Creating an Assembly from Absolute Path</em></p>

<p>The code does the following:</p>

<ul>
  <li><code class="highlighter-rouge">CREATE ASSEMBLY</code> - creates an assembly with a given name (whatever you want it to be).</li>
  <li><code class="highlighter-rouge">FROM</code> - defines where the original assembly lives. The <code class="highlighter-rouge">FROM</code> statement can also take an UNC patch or a binary definition of the assembly. The installation files for this project uses the binary representation.</li>
  <li><code class="highlighter-rouge">WITH PERMISSION_SET</code> - sets the permissions. If you don’t specify the permission set, it defaults to <code class="highlighter-rouge">SAFE</code>. More about that below.</li>
</ul>

<h3 id="permission-sets">Permission Sets</h3>

<p>Seeing that your code runs in the same process as the SQL Server engine (scary thought), Microsoft introduced the notion of permission sets to indicate what the code is allowed to do. From <em>Code Snippet 1</em> you see there are three options:</p>

<ul>
  <li><code class="highlighter-rouge">SAFE</code> - the code is not doing anything that you cannot do in T-SQL. You are confined to do things inside the database you are executing in.</li>
  <li><code class="highlighter-rouge">EXTERNAL_ACCESS</code> - you can get outside of the local database, but only via “approved” assemblies, such as <code class="highlighter-rouge">ADO.NET</code>, etc.</li>
  <li><code class="highlighter-rouge">UNSAFE</code> - You can do pretty much what you want. As I mentioned above, there are certain limitations, but very few.</li>
</ul>

<p>Let us look at a very simple example of this, where we have code looking like so:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">SqlClrCert</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">class</span> <span class="nc">Functions</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fn_clr_Adder</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">return</span> <span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fn_clr_LongRunningAdder</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
    <span class="p">{</span>

      <span class="kt">var</span> <span class="n">t</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">LongRunning</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">));</span>
      <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="kt">int</span> <span class="nf">LongRunning</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">var</span> <span class="n">wait</span> <span class="p">=</span> <span class="p">(</span><span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">)</span> <span class="p">*</span> <span class="m">100</span><span class="p">;</span>
      <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">;</span>

    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Code to Use in SQL Server</em></p>

<p>As you can see, the code in <em>Code Snippet 2</em> has two public functions, and we are interested in being able to use both from inside SQL Server. The second public function <code class="highlighter-rouge">fn_clr_LongRunningAdder</code> emulates that we do something that takes a long time, so we have to use threads. When compiling this code, it compiles into an assembly: <code class="highlighter-rouge">SqlClrTest.dll</code>.</p>

<p>To use it from a database in SQL Server we need to create an assembly in SQL Server, as per what we see in <em>Code Snippet 1</em>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="n">CertTest</span>
<span class="k">FROM</span> <span class="s1">'W:</span><span class="se">\&lt;</span><span class="s1">path_to_dll&gt;</span><span class="se">\S</span><span class="s1">qlClrCert.dll'</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Create Assembly in SQL Server</em></p>

<p>When the assembly has been created we can go ahead and create the T-SQL wrapper functions for the two functions we have in the assembly:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_Adder</span><span class="p">(</span><span class="o">@</span><span class="n">x</span> <span class="n">int</span><span class="p">,</span> <span class="o">@</span><span class="n">y</span> <span class="n">int</span><span class="p">)</span>
<span class="k">RETURNS</span> <span class="n">int</span>
<span class="k">EXTERNAL</span> <span class="n">NAME</span> <span class="n">CertTest</span><span class="p">.[</span><span class="n">SqlClrCert</span><span class="p">.</span><span class="n">Functions</span><span class="p">].</span><span class="n">fn_clr_Adder</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_LongRunningAdder</span><span class="p">(</span><span class="o">@</span><span class="n">x</span> <span class="n">int</span><span class="p">,</span> <span class="o">@</span><span class="n">y</span> <span class="n">int</span><span class="p">)</span>
<span class="k">RETURNS</span> <span class="n">int</span>
<span class="k">EXTERNAL</span> <span class="n">NAME</span> <span class="n">CertTest</span><span class="p">.[</span><span class="n">SqlClrCert</span><span class="p">.</span><span class="n">Functions</span><span class="p">].</span><span class="n">fn_clr_LongRunningAdder</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 4:</strong> <em>Create T-SQL Wrapper Functions</em></p>

<p>If you want more information about the <code class="highlighter-rouge">CREATE FUNCTION</code> syntax, have a look <a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/create-function-transact-sql">here</a>. When the functions are created we can try and start use them, and we’ll begin with <code class="highlighter-rouge">dbo.fn_clr_Adder</code>:</p>

<blockquote>
  <p><strong>NOTE:</strong> Before you execute the function you may have to enable SQLCLR in the database: <code class="highlighter-rouge">sp_configure 'clr enabled', 1</code> followed by <code class="highlighter-rouge">RECONFIGURE</code>.</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_Adder</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span>
</code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>Execute dbo.fn_clr_Adder</em></p>

<p>When you execute the code, you should get back a result, cool! What happens if you now try to execute the long running adder:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_LongRunningAdder</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span>
</code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>Execute dbo.fn_clr_LongRunningAdder</em></p>

<p>Ouch, a very nasty error:</p>

<p><img src="/images/posts/sqlclrcert_exec1.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Error from Executing the Procedure</em></p>

<p>What you see in <em>Figure 1</em> is SQL Server’s way of telling you that you are about to do something, potentially, stupid - and that this is not supported under default permission settings.</p>

<p>So, if we go back to <em>Code Snippet 1</em> and look what options we have; maybe using the <code class="highlighter-rouge">WITH PERMISSION_SET</code> clause will help. So just to make sure that we start from the beginning, let’s drop the functions and the assembly:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">FUNCTION</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_Adder</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">FUNCTION</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_LongRunningAdder</span><span class="p">;</span>
<span class="k">DROP</span> <span class="n">ASSEMBLY</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">CertTest</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>Dropping Functions and Assembly</em></p>

<blockquote>
  <p><strong>NOTE:</strong> I am using SQL Server 2016, and its new <code class="highlighter-rouge">DROP ... IF EXISTS ...</code> syntax.</p>
</blockquote>

<p>We can now re-create the assembly with <code class="highlighter-rouge">UNSAFE</code> permissions:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="n">CertTest</span>
<span class="k">FROM</span> <span class="s1">'W:</span><span class="se">\&lt;</span><span class="s1">path_to_dll&gt;</span><span class="se">\S</span><span class="s1">qlClrCert.dll'</span>
<span class="k">WITH</span> <span class="n">PERMISSION_SET</span> <span class="o">=</span> <span class="n">UNSAFE</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 7:</strong> <em>Create Assembly in SQL Server with UNSAFE Permission Set</em></p>

<p>That should do the rick, so try and run it:</p>

<p><img src="/images/posts/sqlclrcert_permission_set_unsafe1.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>Error from Trying to Create the Assembly</em></p>

<p>Eish, not good! It looks like we need to do some more things with the assembly in order to be able to create it as <code class="highlighter-rouge">UNSAFE</code>.</p>

<h2 id="assembly-authorization">Assembly Authorization</h2>

<p>In <em>Figure 2</em> we see that the error has something to do with authorization of the assembly: <em>CREATE ASSEMBLY for assembly ‘SqlClrCert’ failed 
because assembly ‘SqlClrCert’ is not authorized for PERMISSION_SET = UNSAFE</em>. So it is not enough to say what permissions the assembly needs to have, there are certain requirements on the environment as well.</p>

<p>From the error we can see that in order to be authorized either of the following requirements need to be true:</p>

<ul>
  <li>The database owner (DBO) has <code class="highlighter-rouge">UNSAFE ASSEMBLY</code> permission and the database has the <code class="highlighter-rouge">TRUSTWORTHY</code> database property on.</li>
  <li>The assembly is signed with a certificate that has a corresponding login with <code class="highlighter-rouge">UNSAFE ASSEMBLY</code> permission.</li>
  <li>The assembly is signed with an asymmetric key that has a corresponding login with <code class="highlighter-rouge">UNSAFE ASSEMBLY</code> permission.</li>
</ul>

<p>Of the three options above, we’ll look at the two first ones (<code class="highlighter-rouge">TRUSTWORTHY</code> and certificate). I’ll skip the asymmetric key, as it - in my mind - is too inflexible to use in production.</p>

<h3 id="trustworthy">TRUSTWORTHY</h3>

<p>The <code class="highlighter-rouge">TRUSTWORTHY</code> setting defines whether SQL Server trusts code in the particular database to access external resources (a bit like: “Trust me, I am a professional!”). The way to set it on is through <code class="highlighter-rouge">ALTER DATABASE</code> syntax:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">DATABASE</span> <span class="o">&lt;</span><span class="n">your_db_name</span><span class="o">&gt;</span>
<span class="k">SET</span> <span class="n">TRUSTWORTHY</span> <span class="k">ON</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 8:</strong> <em>Set Database to Trustworthy</em></p>

<p>To see if <code class="highlighter-rouge">TRUSTWORTHY</code> will fix the issue for us, run the code in <em>Code Snippet 8</em>, followed by the code in <em>Code Snippet 7</em>. The <code class="highlighter-rouge">CREATE ASSEMBLY</code> statement in <em>Code Snippet 7</em> should now work without any issues. If you want, you can now go on and create the functions as in <em>Code Snippet 4</em>, and then execute the long running function as we do in <em>Code Snippet 6</em>. This should just work now! That was not too hard was it - why even bother doing it any other way?</p>

<p>Well, <code class="highlighter-rouge">TRUSTWORTHY</code> is kind of coarse grained, after having set it to <code class="highlighter-rouge">ON</code>, all assemblies can now be created with elevated permissions (<code class="highlighter-rouge">EXTERNAL_ACCESS</code> or <code class="highlighter-rouge">UNSAFE</code>) - in that particular database. If you do not have full control over the database, this can become a security hole.</p>

<p>My personal opinion is that the risks of <code class="highlighter-rouge">TRUSTWORTHY</code> are over exaggerated by some experts in the SQL server community, and I have yet to come across anyone that has been “bitten” by using <code class="highlighter-rouge">TRUSTWORTHY</code>. Here at <a href="/Derivco">Derivco</a> we are huge proponents of SQLCLR and the majority of our SQLCLR assemblies are <code class="highlighter-rouge">UNSAFE</code>, and we use <code class="highlighter-rouge">TRUSTWORTHY</code> all the time.</p>

<blockquote>
  <p><strong>NOTE:</strong> In order to create an assembly as <code class="highlighter-rouge">UNSAFE</code>, the user need to be part of <strong>sysadmin</strong>.</p>
</blockquote>

<p>In the case of <code class="highlighter-rouge">TRUSTWORTHY</code> it is not the assembly as such being authorized, but the database.</p>

<h3 id="certificates">Certificates</h3>

<p>The second way to authorize an assembly for <code class="highlighter-rouge">EXTERNAL_ACCESS</code> or <code class="highlighter-rouge">UNSAFE</code> is by the use of certificates. For this purpose the certificate can be self-signed (preferably a certificate common for your corporation). The steps to authorize using a certificate are:</p>

<ul>
  <li>Create a certificate, if you don’t already have one.</li>
  <li>Create a <code class="highlighter-rouge">.pfx</code> file from the certificate. Pfx stands for Personal Information Exchange, and we’ll use it to sign your assembly.</li>
  <li>Sign the dll with the <code class="highlighter-rouge">.pfx</code> file.</li>
  <li>In the database create a SQL Server certificate from the original certificate.</li>
  <li>In the database create login from the certificate.</li>
  <li>Grant the login necessary permissions (<code class="highlighter-rouge">UNSAFE ASSEMBLY</code> in our example).</li>
  <li>Create the dll in the database.</li>
</ul>

<p>To do all this above, we use tools from the Windows SDK. On my box, the path to these tools are at: <code class="highlighter-rouge">C:\Program Files (x86)\Windows Kits\10\bin\10.0.15063.0\x64</code>.</p>

<p>Let’s start with making a certificate, and for this we use the <code class="highlighter-rouge">makecert.exe</code> tool:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">makecert</span> <span class="o">-</span><span class="n">r</span> <span class="o">-</span><span class="n">pe</span> <span class="o">-</span><span class="n">n</span> <span class="s">"CN=Niels Test Root Authority"</span> 
         <span class="o">-</span><span class="n">a</span> <span class="n">sha256</span> <span class="o">-</span><span class="n">sky</span> <span class="n">signature</span> <span class="o">-</span><span class="n">cy</span> <span class="n">authority</span> 
         <span class="o">-</span><span class="n">sv</span> <span class="n">NielsTestPvk</span><span class="p">.</span><span class="n">pvk</span> <span class="o">-</span><span class="n">len</span> <span class="mi">2048</span> 
         <span class="o">-</span><span class="n">m</span> <span class="mi">144</span> <span class="n">NielsTestCert</span><span class="p">.</span><span class="n">cer</span>
</code></pre></div></div>
<p><strong>Code Snippet 9:</strong> <em>Create a Certificate Using makecert.exe</em></p>

<p>To see what the various flags used above means, you can run <code class="highlighter-rouge">makecert.exe -?</code> and <code class="highlighter-rouge">makecert.exe -!</code>. Some explanations:</p>

<ul>
  <li><code class="highlighter-rouge">-r</code> - Create a self signed certificate.</li>
  <li><code class="highlighter-rouge">-pe</code> - Make the generated private key exportable.</li>
  <li><code class="highlighter-rouge">-a</code> - The signature’s digest algorithm.</li>
  <li><code class="highlighter-rouge">-sv</code> - The PVK file to be created.</li>
  <li><code class="highlighter-rouge">-m</code> - Number of months the certificate will be valid for.</li>
</ul>

<p>When you run the code in <em>Code Snippet 9</em>, a couple of dialog boxes will “pop up” asking for you to define password for the private key, and then to enter the password for the private key. After execution you should see two newly created files in the directory where you ran the code: a <code class="highlighter-rouge">.cer</code> file, and a <code class="highlighter-rouge">.pvk</code> file.</p>

<p>Having created the certificate, we now create the <code class="highlighter-rouge">.pfx</code> using the <code class="highlighter-rouge">pvk2pfx.exe</code> tool:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PVK2PFX</span> <span class="o">-</span><span class="n">pvk</span> <span class="n">NielsTestPvk</span><span class="p">.</span><span class="n">pvk</span> 
        <span class="o">-</span><span class="n">spc</span> <span class="n">NielsTestCert</span><span class="p">.</span><span class="n">cer</span> 
        <span class="o">-</span><span class="n">pfx</span> <span class="n">NielsTestPfx</span><span class="p">.</span><span class="n">pfx</span>
        <span class="o">-</span><span class="n">pi</span> <span class="n">testPwd</span>
        <span class="o">-</span><span class="n">po</span> <span class="n">testPwd</span>
</code></pre></div></div>
<p><strong>Code Snippet 10:</strong> <em>Create a .pfx File Using pvk2pfx.exe</em></p>

<p>The flags should be fairly self explanatory, the two that need some sort of explanation may be:</p>

<ul>
  <li><code class="highlighter-rouge">-pi</code> - The password for the <code class="highlighter-rouge">.pvk</code> file.</li>
  <li><code class="highlighter-rouge">-po</code> - Password to set for the <code class="highlighter-rouge">.pfx</code> file.</li>
</ul>

<p>Executing the code in <em>Code Snippet 10</em> should result in a third file in your directory; a <code class="highlighter-rouge">.pfx</code> file.</p>

<p>The last thing to do before doing things inside SQL Server is to sign your assembly. You sign the assembly with the newly created <code class="highlighter-rouge">.pfx</code> file, and you use the <code class="highlighter-rouge">signtool.exe</code> tool for this. Copy your <code class="highlighter-rouge">.pfx</code> file to where your dll is (or vise versa), and then run <code class="highlighter-rouge">signtool.exe</code> with the <code class="highlighter-rouge">sign</code> command:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">signtool</span> <span class="n">sign</span> <span class="o">/</span><span class="n">f</span> <span class="n">NielsTestPfx</span><span class="p">.</span><span class="n">pfx</span> 
              <span class="o">/</span><span class="n">p</span> <span class="n">testPwd</span> <span class="n">SqlClrTest</span><span class="p">.</span><span class="n">dll</span>
</code></pre></div></div>
<p><strong>Code Snippet 10:</strong> <em>Sign the dll Using signtool.exe</em></p>

<p>The <code class="highlighter-rouge">/p</code> flag defines the password to use for opening the <code class="highlighter-rouge">.pfx</code> file.</p>

<p>Having done all this, we can now go to the database and do the final steps. First we need to create a SQL Server certificate from the certificate we created in <em>Code Snippet 9</em>. The certificate should be created in the <code class="highlighter-rouge">master</code> database:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
<span class="k">GO</span>
<span class="k">CREATE</span> <span class="n">CERTIFICATE</span> <span class="n">NielsTestCert</span>
<span class="k">FROM</span> <span class="n">FILE</span> <span class="o">=</span> <span class="s1">'W:</span><span class="se">\&lt;</span><span class="s1">path_to_cert&gt;</span><span class="se">\N</span><span class="s1">ielsTestCert.cer'</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 11:</strong> <em>Create a SQL Server Certificate</em></p>

<p>With a certificate created, we now create a login from the certificate, and also <code class="highlighter-rouge">GRANT</code> it the necessary permissions (<code class="highlighter-rouge">UNSAFE ASSEMBLY</code>):</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">LOGIN</span> <span class="n">login_NielsTestCert</span> 
<span class="k">FROM</span> <span class="n">CERTIFICATE</span> <span class="n">NielsTestCert</span>
<span class="k">GO</span>

<span class="k">GRANT</span> <span class="n">UNSAFE</span> <span class="n">ASSEMBLY</span> <span class="k">TO</span> <span class="n">login_NielsTestCert</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 12:</strong> <em>Create a SQL Server Login and Grant Permissions</em></p>

<p>We are now back to where we were in <em>Code Snippet 7</em>, where we want to create the assembly with <code class="highlighter-rouge">UNSAFE</code> permission set. Before you run the code in <em>Code Snippet 7</em>, make sure that the database is set to <code class="highlighter-rouge">TRUSTWORTHY OFF</code>, and the run the code.</p>

<p>After successfully created the assembly with the necessary permission set, you can run the code to create the functions (<em>Code Snippet 4</em>), and the execute the long running adder (<em>Code Snippet 6</em>). All of this should work fine! Congratulations, you have now used certificates to deploy an <code class="highlighter-rouge">UNSAFE</code> assembly.</p>

<p>This may seem like a lot of work, but after you have done the initial setup: certificate, <code class="highlighter-rouge">.pfx</code>, and certificate in the SQL Server instance together with a login - you can now use this for any assembly. The only thing you need to do is to sign the assembly with the <code class="highlighter-rouge">.pfx</code> file.</p>

<h2 id="dependent--referenced-assemblies">Dependent / Referenced Assemblies</h2>

<p>We have seen from the above how we can deploy assemblies to a database with elevated permissions by using either <code class="highlighter-rouge">TRUSTWORTHY</code> or certificates. But what about referenced assemblies?</p>

<p>In an earlier <a href="/2017/02/11/rabbitmq-sql-server/">post</a> I wrote about how to send data from SQL Server to RabbitMQ, and in our code we referenced the .NET client for RabbitMQ. When deploying our code to the database, the referenced assembly also need to be deployed - and in all likelihood have the same elevated permissions as our assembly. In that example we used <code class="highlighter-rouge">UNSAFE</code>.</p>

<p>If we use <code class="highlighter-rouge">TRUSTWORTHY</code>, things will just work fine, as the authorization is on the database level (and that’s how we did it in that post). What if we do not use <code class="highlighter-rouge">TRUSTWORTHY</code>, but certificates as above? That will work too - you can sign the referenced dll with the <code class="highlighter-rouge">.pfx</code> file and deploy it as you normally would. This also works for strong named assemblies like Microsoft’s!</p>

<h2 id="summary">Summary</h2>

<p>So to sum it up:</p>

<ul>
  <li>To deploy an assembly to SQL Server with elevated permissions, either the assembly or the database need to be authorized for this.</li>
  <li>You can authorize the database by setting <code class="highlighter-rouge">TRUSTWORTHY ON</code>.</li>
  <li>Assemblies can be authorized by either using certificates or asymmetric keys. I definitely prefer certificates over the keys.</li>
</ul>

<p>When it comes to the debate over “how dangerous” <code class="highlighter-rouge">TRUSTWORTHY</code> is, I call “BS” on the arguments that <code class="highlighter-rouge">TRUSTWORTHY</code> should not be used!</p>

<h3 id="sql-server-2017">SQL Server 2017</h3>

<p>Oh, one last thing: in SQL Server 2017, there are some changes to how things work, and I will make a separate blog-post about that.</p>

<h2 id="-finally">~ Finally</h2>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/07/01/sqlclr-certificates/&text=SQLCLR and Certificates&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/07/01/sqlclr-certificates/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2017/07/01/sqlclr-certificates/
         &title=SQLCLR and Certificates
         &summary=Blog post: We discuss the use of TRUSTWORTHY and certificates in SQL Server when deploying SQLCLR assemblies.
         &source=http://www.nielsberglund.com/2017/07/01/sqlclr-certificates/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/07/01/sqlclr-certificates/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server</span>
    </a>
  
    
    <a href="/tags/#sqlclr">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQLCLR</span>
    </a>
  
    
    <a href="/tags/#trustworthy">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">TRUSTWORTHY</span>
    </a>
  
    
    <a href="/tags/#assemblies">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">assemblies</span>
    </a>
  
    
    <a href="/tags/#certificates">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">certificates</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2017/07/01/sqlclr-certificates/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2017/07/01/sqlclr-certificates/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/07/29/interesting-stuff-week-30/">
            Interesting Stuff - Week 30
            <small>29 Jul 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
