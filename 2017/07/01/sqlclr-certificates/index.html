<!DOCTYPE html> <html lang="en-us"> <head> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="We discuss the use of TRUSTWORTHY and certificates in SQL Server when deploying SQLCLR assemblies."> <meta name="keywords" content="SQL Server, SQLCLR, TRUSTWORTHY, assemblies, certificates"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> SQLCLR and Certificates &middot; Niels Berglund </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-d361e701e0c0e75e121ac3e901cff1b8.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.5.0 --> <title>SQLCLR and Certificates | Niels Berglund</title> <meta name="generator" content="Jekyll v3.8.2" /> <meta property="og:title" content="SQLCLR and Certificates" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="We discuss the use of TRUSTWORTHY and certificates in SQL Server when deploying SQLCLR assemblies." /> <meta property="og:description" content="We discuss the use of TRUSTWORTHY and certificates in SQL Server when deploying SQLCLR assemblies." /> <link rel="canonical" href="http://nielsberglund.com/2017/07/01/sqlclr-certificates/" /> <meta property="og:url" content="http://nielsberglund.com/2017/07/01/sqlclr-certificates/" /> <meta property="og:site_name" content="Niels Berglund" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2017-07-01T06:21:55+02:00" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"http://nielsberglund.com/2017/07/01/sqlclr-certificates/","headline":"SQLCLR and Certificates","dateModified":"2017-07-01T06:21:55+02:00","datePublished":"2017-07-01T06:21:55+02:00","author":{"@type":"Person","name":"nielsb"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://nielsberglund.com/2017/07/01/sqlclr-certificates/"},"description":"We discuss the use of TRUSTWORTHY and certificates in SQL Server when deploying SQLCLR assemblies.","@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-3005153158271538", enable_page_level_ads: true }); </script> </head> <body> <div class="sidebar"> <div class="container"> <div class="sidebar-about"> <h1> <a href="/"> Niels Berglund </a> </h1> <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Sidebar_rectangle --> <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-3005153158271538" data-ad-slot="7704601332"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/disclaimer/">Disclaimer</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <img class="center" src="/images/MVP_Logo_large.png" width="300" height="121" > <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <p>&copy; 2018. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">SQLCLR and Certificates</h1> <div class="post-subheading"> <span class="post-date">01 Jul 2017</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#SQLCLR">SQLCLR</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server">SQL Server</a> <a href="/tags/#SQLCLR">SQLCLR</a> <a href="/tags/#TRUSTWORTHY">TRUSTWORTHY</a> <a href="/tags/#assemblies">assemblies</a> <a href="/tags/#certificates">certificates</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> <p>This post originates, like the one about <a href="/2017/06/25/creating-r-stored-procedures-in-sql-server-2016-using-sqlrutils/">sqlrutils</a>, from a question on a Microsoft forum - this time the <a href="https://social.msdn.microsoft.com/Forums/sqlserver/en-US/home?forum=sqlnetfx">.NET Framework inside SQL Server</a> forum. As the name implies, the forum cover questions about the usage of SQLCLR (.NET inside SQL Server), and the <a href="https://social.msdn.microsoft.com/Forums/sqlserver/en-US/35b8bce5-8ea9-4fd4-aa87-1764a2071e92/long-lasting-pfx-file-for-sqlclr-externalaccess-signing?forum=sqlnetfx">question</a> was about signing of SQLCLR assemblies in order to assigning other permission sets than <code>SAFE</code> to the assembly.</p> <p>As I, back in the day, taught SQLCLR as part of Developmentor's SQL Server curriculum, I thought that it'd be interesting if I tried to answer the question, and also make a blog-post about it. That way I'd remember what to do the next time the question came up.</p> <blockquote><p><strong>NOTE:</strong> In another post, I wrote this about Developmentor: <em>Developmentor were back in the day THE training company to go to if you wanted highly, highly technical training about COM, .NET, SQL Server, etc. <a href="http://www.javaworld.com/article/2073792/core-java/a-eulogy--developmentor--rip.html">This article</a> by my old colleague <a href="http://blogs.tedneward.com/">Ted Neward</a> (@tedneward) sums DM up quite accurately (apart from the fact that DM hadn't closed its doors when the article was written, ooops).</em> Ted was probably more accurate than he at the time thought, since DM went out of business somewhat later.</p></blockquote> <p>Anyway, let's see what this is all about...</p> <!--more--> <h2>SQLCLR</h2> <p>SQLCLR is where the .NET framework is embedded in the SQL engine, and you execute .NET code in the SQL Server process. Since you execute .NET code, you can <em>almost</em> do anything you can in a "normal" .NET application.</p> <blockquote><p><strong>NOTE:</strong> I wrote "almost" above, as there actually are certain limitations. For this discussion however, the limitations have <strong>almost</strong> no impact on what we want to do.</p></blockquote> <p>The way SQLCLR works is that you compile your code into a dll, and you then register the <strong>assembly</strong> with SQL Server:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Create Assembly</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="o">&lt;</span><span class="n">some_name</span><span class="o">&gt;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="s1">'F:</span><span class="se">\</span><span class="s1">some_path</span><span class="se">\</span><span class="s1">somedll.dll'</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="n">PERMISSION_SET</span> <span class="o">=</span> <span class="n">SAFE</span> <span class="o">|</span> <span class="n">EXTERNAL_ACCESS</span> <span class="o">|</span> <span class="n">UNSAFE</span><span class="p">;</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Creating an Assembly from Absolute Path</em></p> <p>The code does the following:</p> <ul> <li><code>CREATE ASSEMBLY</code> - creates an assembly with a given name (whatever you want it to be).</li> <li><code>FROM</code> - defines where the original assembly lives. The <code>FROM</code> statement can also take an UNC patch or a binary definition of the assembly. The installation files for this project uses the binary representation.</li> <li><code>WITH PERMISSION_SET</code> - sets the permissions. If you don't specify the permission set, it defaults to <code>SAFE</code>. More about that below.</li> </ul> <h3>Permission Sets</h3> <p>Seeing that your code runs in the same process as the SQL Server engine (scary thought), Microsoft introduced the notion of permission sets to indicate what the code is allowed to do. From <em>Code Snippet 1</em> you see there are three options:</p> <ul> <li><code>SAFE</code> - the code is not doing anything that you cannot do in T-SQL. You are confined to do things inside the database you are executing in.</li> <li><code>EXTERNAL_ACCESS</code> - you can get outside of the local database, but only via "approved" assemblies, such as <code>ADO.NET</code>, etc.</li> <li><code>UNSAFE</code> - You can do pretty much what you want. As I mentioned above, there are certain limitations, but very few.</li> </ul> <p>Let us look at a very simple example of this, where we have code looking like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Test Code</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">namespace</span> <span class="nn">SqlClrCert</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">&#x7b;</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">Functions</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">&#x7b;</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fn_clr_Adder</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7b;</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="k">return</span> <span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">;</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7d;</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fn_clr_LongRunningAdder</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7b;</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="kt">var</span> <span class="n">t</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">LongRunning</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">));</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7d;</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="k">static</span> <span class="kt">int</span> <span class="nf">LongRunning</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7b;</span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="kt">var</span> <span class="n">wait</span> <span class="p">=</span> <span class="p">(</span><span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">)</span> <span class="p">*</span> <span class="m">100</span><span class="p">;</span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="k">return</span> <span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">;</span>
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7d;</span>
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">&#x7d;</span>
</div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">&#x7d;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>Code to Use in SQL Server</em></p> <p>As you can see, the code in <em>Code Snippet 2</em> has two public functions, and we are interested in being able to use both from inside SQL Server. The second public function <code>fn_clr_LongRunningAdder</code> emulates that we do something that takes a long time, so we have to use threads. When compiling this code, it compiles into an assembly: <code>SqlClrTest.dll</code>.</p> <p>To use it from a database in SQL Server we need to create an assembly in SQL Server, as per what we see in <em>Code Snippet 1</em>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Assembly Creation</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="n">CertTest</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="s1">'W:</span><span class="se">\</span><span class="s1">&lt;path_to_dll&gt;</span><span class="se">\</span><span class="s1">SqlClrCert.dll'</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 3:</strong> <em>Create Assembly in SQL Server</em></p> <p>When the assembly has been created we can go ahead and create the T-SQL wrapper functions for the two functions we have in the assembly:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Functions</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_Adder</span><span class="p">(</span><span class="o">@</span><span class="n">x</span> <span class="n">int</span><span class="p">,</span> <span class="o">@</span><span class="n">y</span> <span class="n">int</span><span class="p">)</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">RETURNS</span> <span class="n">int</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXTERNAL</span> <span class="n">NAME</span> <span class="n">CertTest</span><span class="p">.[</span><span class="n">SqlClrCert</span><span class="p">.</span><span class="n">Functions</span><span class="p">].</span><span class="n">fn_clr_Adder</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_LongRunningAdder</span><span class="p">(</span><span class="o">@</span><span class="n">x</span> <span class="n">int</span><span class="p">,</span> <span class="o">@</span><span class="n">y</span> <span class="n">int</span><span class="p">)</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">RETURNS</span> <span class="n">int</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXTERNAL</span> <span class="n">NAME</span> <span class="n">CertTest</span><span class="p">.[</span><span class="n">SqlClrCert</span><span class="p">.</span><span class="n">Functions</span><span class="p">].</span><span class="n">fn_clr_LongRunningAdder</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 4:</strong> <em>Create T-SQL Wrapper Functions</em></p> <p>If you want more information about the <code>CREATE FUNCTION</code> syntax, have a look <a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/create-function-transact-sql">here</a>. When the functions are created we can try and start use them, and we'll begin with <code>dbo.fn_clr_Adder</code>:</p> <blockquote><p><strong>NOTE:</strong> Before you execute the function you may have to enable SQLCLR in the database: <code>sp_configure 'clr enabled', 1</code> followed by <code>RECONFIGURE</code>.</p></blockquote> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Answer to All Questions in the World</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_Adder</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 5:</strong> <em>Execute dbo.fn_clr_Adder</em></p> <p>When you execute the code, you should get back a result, cool! What happens if you now try to execute the long running adder:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Answer to All Questions in the World, Again</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_LongRunningAdder</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 6:</strong> <em>Execute dbo.fn_clr_LongRunningAdder</em></p> <p>Ouch, a very nasty error:</p> <p><img class="center" src="/images/posts/sqlclrcert_exec1.png" width="505" height="199" > <strong>Figure 1:</strong> <em>Error from Executing the Procedure</em></p> <p>What you see in <em>Figure 1</em> is SQL Server's way of telling you that you are about to do something, potentially, stupid - and that this is not supported under default permission settings.</p> <p>So, if we go back to <em>Code Snippet 1</em> and look what options we have; maybe using the <code>WITH PERMISSION_SET</code> clause will help. So just to make sure that we start from the beginning, let's drop the functions and the assembly:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Drop</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">FUNCTION</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_Adder</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">FUNCTION</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_LongRunningAdder</span><span class="p">;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="n">ASSEMBLY</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">CertTest</span><span class="p">;</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 6:</strong> <em>Dropping Functions and Assembly</em></p> <blockquote><p><strong>NOTE:</strong> I am using SQL Server 2016, and its new <code>DROP ... IF EXISTS ...</code> syntax.</p></blockquote> <p>We can now re-create the assembly with <code>UNSAFE</code> permissions:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Unsafe Assembly Creation</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="n">CertTest</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="s1">'W:</span><span class="se">\</span><span class="s1">&lt;path_to_dll&gt;</span><span class="se">\</span><span class="s1">SqlClrCert.dll'</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="n">PERMISSION_SET</span> <span class="o">=</span> <span class="n">UNSAFE</span><span class="p">;</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 7:</strong> <em>Create Assembly in SQL Server with UNSAFE Permission Set</em></p> <p>That should do the rick, so try and run it:</p> <p><img class="center" src="/images/posts/sqlclrcert_permission_set_unsafe1.png" width="420" height="173" > <strong>Figure 2:</strong> <em>Error from Trying to Create the Assembly</em></p> <p>Eish, not good! It looks like we need to do some more things with the assembly in order to be able to create it as <code>UNSAFE</code>.</p> <h2>Assembly Authorization</h2> <p>In <em>Figure 2</em> we see that the error has something to do with authorization of the assembly: <em>CREATE ASSEMBLY for assembly 'SqlClrCert' failed because assembly 'SqlClrCert' is not authorized for PERMISSION_SET = UNSAFE</em>. So it is not enough to say what permissions the assembly needs to have, there are certain requirements on the environment as well.</p> <p>From the error we can see that in order to be authorized either of the following requirements need to be true:</p> <ul> <li>The database owner (DBO) has <code>UNSAFE ASSEMBLY</code> permission and the database has the <code>TRUSTWORTHY</code> database property on.</li> <li>The assembly is signed with a certificate that has a corresponding login with <code>UNSAFE ASSEMBLY</code> permission.</li> <li>The assembly is signed with an asymmetric key that has a corresponding login with <code>UNSAFE ASSEMBLY</code> permission.</li> </ul> <p>Of the three options above, we'll look at the two first ones (<code>TRUSTWORTHY</code> and certificate). I'll skip the asymmetric key, as it - in my mind - is too inflexible to use in production.</p> <h3>TRUSTWORTHY</h3> <p>The <code>TRUSTWORTHY</code> setting defines whether SQL Server trusts code in the particular database to access external resources (a bit like: "Trust me, I am a professional!"). The way to set it on is through <code>ALTER DATABASE</code> syntax:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Trustworthy</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">ALTER</span> <span class="k">DATABASE</span> <span class="o">&lt;</span><span class="n">your_db_name</span><span class="o">&gt;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SET</span> <span class="n">TRUSTWORTHY</span> <span class="k">ON</span><span class="p">;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 8:</strong> <em>Set Database to Trustworthy</em></p> <p>To see if <code>TRUSTWORTHY</code> will fix the issue for us, run the code in <em>Code Snippet 8</em>, followed by the code in <em>Code Snippet 7</em>. The <code>CREATE ASSEMBLY</code> statement in <em>Code Snippet 7</em> should now work without any issues. If you want, you can now go on and create the functions as in <em>Code Snippet 4</em>, and then execute the long running function as we do in <em>Code Snippet 6</em>. This should just work now! That was not too hard was it - why even bother doing it any other way?</p> <p>Well, <code>TRUSTWORTHY</code> is kind of coarse grained, after having set it to <code>ON</code>, all assemblies can now be created with elevated permissions (<code>EXTERNAL_ACCESS</code> or <code>UNSAFE</code>) - in that particular database. If you do not have full control over the database, this can become a security hole.</p> <p>My personal opinion is that the risks of <code>TRUSTWORTHY</code> are over exaggerated by some experts in the SQL server community, and I have yet to come across anyone that has been "bitten" by using <code>TRUSTWORTHY</code>. Here at <a href="/Derivco">Derivco</a> we are huge proponents of SQLCLR and the majority of our SQLCLR assemblies are <code>UNSAFE</code>, and we use <code>TRUSTWORTHY</code> all the time.</p> <blockquote><p><strong>NOTE:</strong> In order to create an assembly as <code>UNSAFE</code>, the user need to be part of <strong>sysadmin</strong>.</p></blockquote> <p>In the case of <code>TRUSTWORTHY</code> it is not the assembly as such being authorized, but the database.</p> <h3>Certificates</h3> <p>The second way to authorize an assembly for <code>EXTERNAL_ACCESS</code> or <code>UNSAFE</code> is by the use of certificates. For this purpose the certificate can be self-signed (preferably a certificate common for your corporation). The steps to authorize using a certificate are:</p> <ul> <li>Create a certificate, if you don't already have one.</li> <li>Create a <code>.pfx</code> file from the certificate. Pfx stands for Personal Information Exchange, and we'll use it to sign your assembly.</li> <li>Sign the dll with the <code>.pfx</code> file.</li> <li>In the database create a SQL Server certificate from the original certificate.</li> <li>In the database create login from the certificate.</li> <li>Grant the login necessary permissions (<code>UNSAFE ASSEMBLY</code> in our example).</li> <li>Create the dll in the database.</li> </ul> <p>To do all this above, we use tools from the Windows SDK. On my box, the path to these tools are at: <code>C:\Program Files (x86)\Windows Kits\10\bin\10.0.15063.0\x64</code>.</p> <p>Let's start with making a certificate, and for this we use the <code>makecert.exe</code> tool:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Create Certificate</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">makecert</span> <span class="o">-</span><span class="n">r</span> <span class="o">-</span><span class="n">pe</span> <span class="o">-</span><span class="n">n</span> <span class="s">"CN=Niels Test Root Authority"</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>         <span class="o">-</span><span class="n">a</span> <span class="n">sha256</span> <span class="o">-</span><span class="n">sky</span> <span class="n">signature</span> <span class="o">-</span><span class="n">cy</span> <span class="n">authority</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>         <span class="o">-</span><span class="n">sv</span> <span class="n">NielsTestPvk</span><span class="p">.</span><span class="n">pvk</span> <span class="o">-</span><span class="n">len</span> <span class="mi">2048</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>         <span class="o">-</span><span class="n">m</span> <span class="mi">144</span> <span class="n">NielsTestCert</span><span class="p">.</span><span class="n">cer</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 9:</strong> <em>Create a Certificate Using makecert.exe</em></p> <p>To see what the various flags used above means, you can run <code>makecert.exe -?</code> and <code>makecert.exe -!</code>. Some explanations:</p> <ul> <li><code>-r</code> - Create a self signed certificate.</li> <li><code>-pe</code> - Make the generated private key exportable.</li> <li><code>-a</code> - The signature's digest algorithm.</li> <li><code>-sv</code> - The PVK file to be created.</li> <li><code>-m</code> - Number of months the certificate will be valid for.</li> </ul> <p>When you run the code in <em>Code Snippet 9</em>, a couple of dialog boxes will "pop up" asking for you to define password for the private key, and then to enter the password for the private key. After execution you should see two newly created files in the directory where you ran the code: a <code>.cer</code> file, and a <code>.pvk</code> file.</p> <p>Having created the certificate, we now create the <code>.pfx</code> using the <code>pvk2pfx.exe</code> tool:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Create .pfx File</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">PVK2PFX</span> <span class="o">-</span><span class="n">pvk</span> <span class="n">NielsTestPvk</span><span class="p">.</span><span class="n">pvk</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="o">-</span><span class="n">spc</span> <span class="n">NielsTestCert</span><span class="p">.</span><span class="n">cer</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="o">-</span><span class="n">pfx</span> <span class="n">NielsTestPfx</span><span class="p">.</span><span class="n">pfx</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="o">-</span><span class="n">pi</span> <span class="n">testPwd</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="o">-</span><span class="n">po</span> <span class="n">testPwd</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 10:</strong> <em>Create a .pfx File Using pvk2pfx.exe</em></p> <p>The flags should be fairly self explanatory, the two that need some sort of explanation may be:</p> <ul> <li><code>-pi</code> - The password for the <code>.pvk</code> file.</li> <li><code>-po</code> - Password to set for the <code>.pfx</code> file.</li> </ul> <p>Executing the code in <em>Code Snippet 10</em> should result in a third file in your directory; a <code>.pfx</code> file.</p> <p>The last thing to do before doing things inside SQL Server is to sign your assembly. You sign the assembly with the newly created <code>.pfx</code> file, and you use the <code>signtool.exe</code> tool for this. Copy your <code>.pfx</code> file to where your dll is (or vise versa), and then run <code>signtool.exe</code> with the <code>sign</code> command:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Signing</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">signtool</span> <span class="n">sign</span> <span class="o">/</span><span class="n">f</span> <span class="n">NielsTestPfx</span><span class="p">.</span><span class="n">pfx</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="o">/</span><span class="n">p</span> <span class="n">testPwd</span> <span class="n">SqlClrTest</span><span class="p">.</span><span class="n">dll</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 10:</strong> <em>Sign the dll Using signtool.exe</em></p> <p>The <code>/p</code> flag defines the password to use for opening the <code>.pfx</code> file.</p> <p>Having done all this, we can now go to the database and do the final steps. First we need to create a SQL Server certificate from the certificate we created in <em>Code Snippet 9</em>. The certificate should be created in the <code>master</code> database:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Certificate</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="n">CERTIFICATE</span> <span class="n">NielsTestCert</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="n">FILE</span> <span class="o">=</span> <span class="s1">'W:</span><span class="se">\</span><span class="s1">&lt;path_to_cert&gt;</span><span class="se">\</span><span class="s1">NielsTestCert.cer'</span><span class="p">;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 11:</strong> <em>Create a SQL Server Certificate</em></p> <p>With a certificate created, we now create a login from the certificate, and also <code>GRANT</code> it the necessary permissions (<code>UNSAFE ASSEMBLY</code>):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Login</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="n">LOGIN</span> <span class="n">login_NielsTestCert</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="n">CERTIFICATE</span> <span class="n">NielsTestCert</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GRANT</span> <span class="n">UNSAFE</span> <span class="n">ASSEMBLY</span> <span class="k">TO</span> <span class="n">login_NielsTestCert</span><span class="p">;</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 12:</strong> <em>Create a SQL Server Login and Grant Permissions</em></p> <p>We are now back to where we were in <em>Code Snippet 7</em>, where we want to create the assembly with <code>UNSAFE</code> permission set. Before you run the code in <em>Code Snippet 7</em>, make sure that the database is set to <code>TRUSTWORTHY OFF</code>, and the run the code.</p> <p>After successfully created the assembly with the necessary permission set, you can run the code to create the functions (<em>Code Snippet 4</em>), and the execute the long running adder (<em>Code Snippet 6</em>). All of this should work fine! Congratulations, you have now used certificates to deploy an <code>UNSAFE</code> assembly.</p> <p>This may seem like a lot of work, but after you have done the initial setup: certificate, <code>.pfx</code>, and certificate in the SQL Server instance together with a login - you can now use this for any assembly. The only thing you need to do is to sign the assembly with the <code>.pfx</code> file.</p> <h2>Dependent / Referenced Assemblies</h2> <p>We have seen from the above how we can deploy assemblies to a database with elevated permissions by using either <code>TRUSTWORTHY</code> or certificates. But what about referenced assemblies?</p> <p>In an earlier <a href="/2017/02/11/rabbitmq-sql-server/">post</a> I wrote about how to send data from SQL Server to RabbitMQ, and in our code we referenced the .NET client for RabbitMQ. When deploying our code to the database, the referenced assembly also need to be deployed - and in all likelihood have the same elevated permissions as our assembly. In that example we used <code>UNSAFE</code>.</p> <p>If we use <code>TRUSTWORTHY</code>, things will just work fine, as the authorization is on the database level (and that's how we did it in that post). What if we do not use <code>TRUSTWORTHY</code>, but certificates as above? That will work too - you can sign the referenced dll with the <code>.pfx</code> file and deploy it as you normally would. This also works for strong named assemblies like Microsoft's!</p> <h2>Summary</h2> <p>So to sum it up:</p> <ul> <li>To deploy an assembly to SQL Server with elevated permissions, either the assembly or the database need to be authorized for this.</li> <li>You can authorize the database by setting <code>TRUSTWORTHY ON</code>.</li> <li>Assemblies can be authorized by either using certificates or asymmetric keys. I definitely prefer certificates over the keys.</li> </ul> <p>When it comes to the debate over "how dangerous" <code>TRUSTWORTHY</code> is, I call "BS" on the arguments that <code>TRUSTWORTHY</code> should not be used!</p> <h3>SQL Server 2017</h3> <p>Oh, one last thing: in SQL Server 2017, there are some changes to how things work, and I will make a separate blog-post about that.</p> <h2>~ Finally</h2> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/07/01/sqlclr-certificates/&text=SQLCLR and Certificates&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/07/01/sqlclr-certificates/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2017/07/01/sqlclr-certificates/ &title=SQLCLR and Certificates &summary=Blog post: We discuss the use of TRUSTWORTHY and certificates in SQL Server when deploying SQLCLR assemblies. &source=http://www.nielsberglund.com/2017/07/01/sqlclr-certificates/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/07/01/sqlclr-certificates/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> <br/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad2 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="1158080725" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2018/04/22/interesting-stuff-week-16/"> Interesting Stuff - Week 16 <small> (22 Apr 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2017/07/23/interesting-stuff-week-29/"> Interesting Stuff - Week 29 <small> (23 Jul 2017)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2017/07/23/sql-server-2017-sqlclr-white-listing-assemblies/"> SQL Server 2017 SQLCLR - Whitelisting Assemblies <small> (23 Jul 2017)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
