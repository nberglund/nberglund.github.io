<!DOCTYPE html> <html lang="en-us"> <head> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="Here we look at some of the components the launchpad service loads; Rterm.exe, BxlServer.exe, etc."> <meta name="keywords" content="SQL Server R Services, R, WinDbg, Launchpad, RTerm.exe, BxlServer.exe"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Microsoft SQL Server R Services - Internals VIII &middot; Niels Berglund </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-fa627a383d47b30c65e6b1ee58efc794.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.2.3 --> <title>Microsoft SQL Server R Services - Internals VIII | Niels Berglund</title> <meta property="og:title" content="Microsoft SQL Server R Services - Internals VIII" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Here we look at some of the components the launchpad service loads; Rterm.exe, BxlServer.exe, etc." /> <meta property="og:description" content="Here we look at some of the components the launchpad service loads; Rterm.exe, BxlServer.exe, etc." /> <link rel="canonical" href="http://nielsberglund.com//2017/07/22/microsoft-sql-server-r-services-internals-viii/" /> <meta property="og:url" content="http://nielsberglund.com//2017/07/22/microsoft-sql-server-r-services-internals-viii/" /> <meta property="og:site_name" content="Niels Berglund" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2017-07-22T08:47:47+02:00" /> <script type="application/ld+json"> {"@context":"http://schema.org","@type":"BlogPosting","headline":"Microsoft SQL Server R Services - Internals VIII","author":{"@type":"Person","name":"nielsb"},"datePublished":"2017-07-22T08:47:47+02:00","dateModified":"2017-07-22T08:47:47+02:00","description":"Here we look at some of the components the launchpad service loads; Rterm.exe, BxlServer.exe, etc.","mainEntityOfPage":{"@type":"WebPage","@id":"http://nielsberglund.com//2017/07/22/microsoft-sql-server-r-services-internals-viii/"},"url":"http://nielsberglund.com//2017/07/22/microsoft-sql-server-r-services-internals-viii/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <div class="sidebar"> <div class="container"> <div class="sidebar-about"> <h1> <a href="/"> Niels Berglund </a> </h1> <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/disclaimer/">Disclaimer</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <img class="center" src="/images/MVP_Logo.png" width="181" height="74" > <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <p>&copy; 2017. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">Microsoft SQL Server R Services - Internals VIII</h1> <div class="post-subheading"> <span class="post-date">22 Jul 2017</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#Microsoft R Server">Microsoft R Server</a> <a href="/categories/#Data Science">Data Science</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server R Services">SQL Server R Services</a> <a href="/tags/#R">R</a> <a href="/tags/#WinDbg">WinDbg</a> <a href="/tags/#Launchpad">Launchpad</a> <a href="/tags/#RTerm.exe">RTerm.exe</a> <a href="/tags/#BxlServer.exe">BxlServer.exe</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> <p>This post is part of a series of blog-posts about Microsoft SQL Server R Services:</p> <ol> <li><a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">Microsoft SQL Server 2016 R Services Installation</a></li> <li><a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Microsoft SQL Server R Services - Internals I</a></li> <li><a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Microsoft SQL Server R Services - Internals II</a></li> <li><a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Microsoft SQL Server R Services - Internals III</a></li> <li><a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Microsoft SQL Server R Services - Internals IV</a></li> <li><a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Microsoft SQL Server R Services - Internals V</a></li> <li><a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Microsoft SQL Server R Services - Internals VI</a></li> <li><a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Microsoft SQL Server R Services - Internals VII</a></li> <li>Microsoft SQL Server R Services - Internals VIII (this post)</li> <li><a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Microsoft SQL Server R Services - Internals IX</a></li> <li>More to come (hopefully)</li> </ol> <p>This post is the ninth post about Microsoft SQL Server R Services, and the eight post that drills down into the internal of how it works.</p> <p>So far in this series we have been looking at what happens in SQL Server as well as the launchpad service when we execute <code>sp_execute_external_script</code>, and we have still no real "clue" to where the R engine comes into play.</p> <p>Well, hopefully that will change (at least a little bit) with this post, as we here will look at what happens when we leave the launchpad service.</p> <!--more--> <p>Before we dive into the "juicy" stuff, let's remind ourselves where we are.</p> <h2>Recap</h2> <p>Normally in the recaps in this series, we have looked at what was covered in the previous "episode". In this recap, let's look at he "full" picture up until now.</p> <p>The first post in the series - <a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">Microsoft SQL Server 2016 R Services Installation</a> - covered the installation of SQL Server 2016 R Services, and it also touched upon the external procedure which allows us to execute external scripts; <code>sp_execute_external_script</code>. We looked at the signature of the procedure as well as executing the equivalent to a "Hello World" script.</p> <p>In the subsequent posts we talked about - when executing <code>sp_execute_external_script</code> - how SQL Server calls into the launchpad service, and how the launchpad service - through the <code>rlauncher.dll</code> creates multiple <code>Rterm.exe</code> processes as in <em>Figure 1</em> below. One of the processes will be used to run the external script:</p> <p><img class="center" src="/images/posts/sql-launchpad-rterm_processes.png" width="583" height="100" > <strong>Figure 1:</strong> <em>Rterm.exe Processes</em></p> <p>I addition to creating <code>Rterm.exe</code> processes, the launchpad service also creates backing directories for those processes. These backing directories are used for saving output, intermediate results etc. The following figure was used to show what the call flow looks like:</p> <p><img class="center" src="/images/posts/sql-launchpad_processes_post.png" width="650" height="466" > <strong>Figure 2:</strong> <em>Call Flow Executing sp_execute_external_script</em></p> <p>We discussed how the number of processes can be controlled by the <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code> setting in <code>rlauncher.config</code> file, and how it defaults to 5 if nothing is set.</p> <p>In <a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Internals - VI</a> we came back to the backing directories, and we realized that in addition to the backing directories created for the Rterm processes, one more directory is created - which will be the "official" working directory for the session, and we showed this using this figure:</p> <p><img class="center" src="/images/posts/sql_r_services_6_launchpad_working_dir.png" width="650" height="433" > <strong>Figure 3:</strong> <em>Launchpad, Directories and Processes</em></p> <p>While we were investigating the directories created in <a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Internals - VI</a> we saw that, while we executed an external script, files and sub-directories were created in the various backing directories:</p> <p><img class="center" src="/images/posts/sql_r_services_7_outputdir.png" width="579" height="139" > <strong>Figure 4:</strong> <em>Contents Process Directory</em></p> <p>In <em>Figure 4</em> we see he content of the directory which is the processing directory, and in <a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Internals - VII</a> we looked into what creates those files/directories and what they are for. We came to the conclusion that both the launchpad service (probably through the <code>rlauncher.dll</code>) created some files, whereas <code>Rterm.exe</code> created others.</p> <p>That's where we are, and now it is time to look at the world outside of the launchpad, and try to figure out what is being used when executing an external script.</p> <h2>Rterm.exe</h2> <p>In <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a> we saw how the launchpad service creates Rterm processes, and how the launchpad service calls <code>launchpad!CSQLSatelliteCommunication::SendResumeWithLoginInfo</code> followed by <code>launchpad!CSQLSatelliteConnection::WriteMessage</code> to call into the Rterm process chosen for execution of the external script. So what does <code>Rterm.exe</code> and the RTerm process do?</p> <p>To answer that let us first look at what the R "engine" really is, and let's do that by looking at standard CRAN R, and for this I use RStudio as an IDE. So, let's open RStudio and make sure it uses the CRAN R engine:</p> <p><img class="center" src="/images/posts/sql_r_services_8_rstudio_cran.png" width="456" height="85" > <strong>Figure 5:</strong> <em>RStudion CRAN R</em></p> <p>At that stage if I check in <strong>Process Explorer</strong> to see what processes are loaded I see something like this:</p> <p><img class="center" src="/images/posts/sql_r_services_8_rstudio_rsession.png" width="599" height="56" > <strong>Figure 6:</strong> **</p> <p>So in <em>Figure 6</em> we see how the <code>rstudio.exe</code> is host for <code>rsession.exe</code>, which in turn host <code>conhost.exe</code>. For this discussion <code>conhost.exe</code> has no real impact, but if you want to know more about it, <a href="https://blogs.technet.microsoft.com/askperf/2009/10/05/windows-7-windows-server-2008-r2-console-host/">here</a> is a good article explaining why we have <code>conhost.exe</code>.</p> <p>Going back to <code>rsession.exe</code>; in Process Explorer, we look at what dll's it has loaded (click on <code>`rsession.exe</code> followed by <strong>Ctrl-D</strong> ) we'll see something like this:</p> <p><img class="center" src="/images/posts/sql_r_services_8_rstudio_rsession_dlls1.png" width="627" height="128" > <strong>Figure 7:</strong> <em>Loaded dll's</em></p> <p><em>Figure 7</em> above shows 7 dll's loaded by <code>rsession.exe</code>, and what is interesting is the second from bottom, which has a path pointing to the R libraries. When we look further down in the list we'll see more dll's from the R libraries:</p> <p><img class="center" src="/images/posts/sql_r_services_8_rstudio_rsession_rdlls.png" width="574" height="81" > <strong>Figure 8:</strong> <em>R Dlls</em></p> <p>Among the dll's we see the <code>R.dll</code>, which is the main dll for R. So, it seems that <code>rsession.exe</code> acts as a host for the R engine, and the R engine is a "bunch" of dll's.</p> <p>Coming back to <code>rterm.exe</code> and what it is, we can now assume it acts in the same way as <code>rsession.exe</code>. Let us go back to the code that we used in <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a> when we captured the figure we above in <em>Figure 1</em>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Script with Pause</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="o">@</span><span class="k">language</span> <span class="o">=</span><span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s1">'OutputDataSet&lt;-InputDataSet;
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                              Sys.sleep(120);'</span><span class="p">,</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span><span class="n">N</span><span class="s1">'SELECT 42'</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">(([</span><span class="n">TheAnswer</span><span class="p">]</span> <span class="n">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">));</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Execute with Sys.Sleep</em></p> <p>Like we did in <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a>, we'll execute the code in <em>Code Snippet 1</em>, and while the code is running we'll look in Process Explorer and see if we find anything of interest:</p> <ol> <li>Stop the launchpad service.</li> <li>Restart the launchpad service.</li> <li>Start <em>Process Explorer</em>, order by Process, and scroll down to where you see process names starting with "RT" (on my box there are none at this stage), or where the processes should be. <ul> <li>If you at this stage see RTerm, restart the launchpad service again and kill those processes.</li> </ul> </li> <li>Execute the code in <em>Code Snippet 1</em>.</li> </ol> <p>While the code is running, take a quick look in Process Explorer, and you should see something like so:</p> <p><img class="center" src="/images/posts/sql_r_services_8_rterm_processes.png" width="644" height="304" > <strong>Figure 9:</strong> <em>RTerm Processes</em></p> <p>The difference between <em>Figure 1</em> and <em>Figure 9</em>, is that in <em>Figure 1</em> I had collapsed the Rterm processes. In <em>Figure 9</em> we see how the launchpad service is host for multiple Rterm processes, and how <code>Rterm.exe</code> is host for <code>conhost.exe</code> as well as <code>BxlServer.exe</code>. We'll come back shortly to what <code>BxlServer.exe</code> is.</p> <p>Let's look a bit closer at what dll's we find for one of the active Rterm processes, click on the Rterm process which has a CPU value, and then click <strong>Ctrl-D</strong>.</p> <blockquote><p><strong>NOTE:</strong> You may have to re-execute the code in <em>Code Snippet 1</em>, maybe even increase the sleep time to 3 or 4 minutes to be able to see everything.</p></blockquote> <p>When I scroll down in the dll list I see some familiar R dll's, that we also saw in <em>Figure 8</em>:</p> <p><img class="center" src="/images/posts/sql_r_services_8_rterm_dlls.png" width="649" height="168" > <strong>Figure 10:</strong> <em>Rterm R dll's</em></p> <p>At this stage we can safely say that the <code>Rterm.exe</code> and its process hosts the R engine. That is cool (yeah I know - I need to get a life), but what does that <code>BxlServer.exe</code> do in the mix?</p> <h2>BxlServer</h2> <p>So the question was, what is the <code>BxlServer.exe</code>? To answer that let's take a step back, and look at the R offerings Microsoft has:</p> <ul> <li>Microsoft R Open - a Microsoft open source offering of R</li> <li>Microsoft R Server - Microsoft's commercial R offering.</li> <li>SQL Server R Services - the moral equivalent of Microsoft R Server, but with SQL Server as delivery vehicle.</li> </ul> <p>Let's see what happens if we pointed RStudio towards the Microsoft R Open environment:</p> <p><img class="center" src="/images/posts/sql_r_services_8_rstudio_mro.png" width="577" height="294" > <strong>Figure 11:</strong> <em>RStudio Targeting MRO</em></p> <p>In <em>Process Explorer</em>, looking at the rstudio process, it won't look any different than what it did when Rstudio targeted CRAN R as in <em>Figure 6</em>, so obviously the Microsoft R Open offering does not "know" of the <code>BxlServer.exe</code> we see in <em>Figure 9</em>. But, looking at the dll's loaded by <code>rsession.exe</code>, we see more or less the same as was loaded by <code>rterm.exe</code> in <em>Figure 10</em>:</p> <p><img class="center" src="/images/posts/sql_r_services_8_rstudio_mro_dlls.png" width="594" height="113" > <strong>Figure 12:</strong> <em>RStudio MRO dll's</em></p> <p>What would happen if RStudio targeted the Microsoft R Server (MRS) instead:</p> <p><img class="center" src="/images/posts/sql_r_services_8_rstudio_mrs.png" width="461" height="314" > <strong>Figure 13:</strong> <em>RStudio Targeting MRS</em></p> <p>This time when looking at the rstudio process we do see <code>BxlServer.exe</code> as a process hosted by <code>rsession.exe</code>, so it seems that <code>BxlServer.exe</code> is specifically for the commercial versions of Microsoft R.</p> <blockquote><p><strong>NOTE:</strong> There is no difference between the <code>BxlServer.exe</code> in MRS and SQL Server R Services. Well, not much anyway :), in next post we'll see some differences.</p></blockquote> <p>By now you are probably saying something like: "Niels, this is very informative - NOT, get to the point - what is <code>BxlServer.exe</code>". OK, so let us see some of the dll's <code>BxlServer.exe</code> has loaded (click on the <code>BxlServer.exe</code> process and <strong>Ctrl-D</strong>):</p> <p><img class="center" src="/images/posts/sql_r_services_8_rstudio_bxlserver.png" width="651" height="90" > <strong>Figure 13:</strong> <em>BxlServer Loaded dll's</em></p> <p>Ooh, that's interesting, look at the path and especially what is in the red rectangle: <code>RevoScaleR</code>.</p> <p>RevoScaleR, is an R package providing both High Performance Computing (HPC) and High Performance Analytics (HPA) capabilities for R. HPC capabilities allow you to distribute the execution of essentially any R function across cores and nodes, and deliver the results back to the user. HPA adds the ability to handle big data in a high performance way. In addition to this (or rather as part of) RevoScaleR also has functionality to handle data access with high performance, and <code>BxlServer.exe</code> is the host for all this.</p> <p>In addition to run the HPC, HPA and data access, <code>BxlServer.exe</code> also coordinates with the R runtime in order to manage exchanges of data with SQL Server, and it runs most of the R processing. A lot of the coordination and handling of result sets in <code>BxlServer.exe</code> is handled by a dll loaded by <code>BxlServer.exe</code>: <code>BxServerLink.dll</code>. Below we see how the <code>BxServerLink.dll</code> is loaded by <code>Bxlserver.exe</code>.</p> <p><img class="center" src="/images/posts/sql_r_services_8_rstudio_bxserverlink.png" width="602" height="21" > <strong>Figure 14:</strong> <em>BxServerLink Loaded by BxlServer.exe</em></p> <p>Let's go back to <em>Figure 13</em> , where we see how <code>rsession.exe</code> hosts <code>BxlServer.exe</code>. How does that work, I mean - <code>rsession.exe</code> is a CRAN R executable, and it does not know anything about Microsoft R Services and <code>BxlServer.exe</code>? The answer is <code>R.dll</code>; when <code>rsession.exe</code> loads <code>R.dll</code> (which is a Microsoft dll), the <code>R.dll</code> then starts to load other dll's. But, <code>BxlServer.exe</code> is not a dll, and it runs in a separate process, surely <code>R.dll</code> cannot do that? No, it cannot - but what it does do is to load a dll acting as a conduit: the <code>RxLink.dll</code>. The <code>RxLink.dll</code> creates a new process in where <code>BxlServer.exe</code> runs, and that is how communication happens between <code>rsession.exe</code> and <code>BxlServer.exe</code>. And that is also what happens in SQL Server R Services where <code>Rterm.exe</code> is the "host". <code>Rterm.exe</code> loads the <code>R.dll</code> which loads <code>RxLink.dll</code> who then creates a process for <code>BxlServer.exe</code>, and <code>BxlServer.exe</code> loads <code>BxLinkServer.dll</code>.</p> <blockquote><p><strong>NOTE:</strong> In the next Internals post we'll look more at <code>RxLink.dll</code>, and <code>BxLinkServer.dll</code>.</p></blockquote> <p>Finally, let's make sure that <code>BxlServer.exe</code> actually is doing something when we execute an external script in SQL Server R Services. For that we'll use some code we wrote in <a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Internals V</a>, where we discussed parallelism:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Setup</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span><span class="p">;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">TestParallel</span><span class="p">;</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">TestParallel</span><span class="p">;</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">USE</span> <span class="n">TestParallel</span><span class="p">;</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_30M</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_30M</span><span class="p">(</span><span class="n">RowID</span> <span class="n">bigint</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> <span class="n">y</span> <span class="n">int</span><span class="p">,</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>                          <span class="n">rand1</span> <span class="n">int</span><span class="p">,</span> <span class="n">rand2</span> <span class="n">int</span><span class="p">,</span> <span class="n">rand3</span> <span class="n">int</span><span class="p">,</span> <span class="n">rand4</span> <span class="n">int</span><span class="p">,</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>                          <span class="n">rand5</span> <span class="n">int</span><span class="p">);</span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_30M</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">rand3</span><span class="p">,</span> <span class="n">rand4</span><span class="p">,</span> <span class="n">rand5</span><span class="p">)</span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">30000000</span><span class="p">)</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">20</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">25</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">50</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">100</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o1</span>
</div></div><div data-line='29' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o2</span>
</div></div><div data-line='30' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o3</span>
</div></div><div data-line='31' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o4</span><span class="p">;</span>
</div></div><div data-line='32' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>Setup of Database, Table and Data</em></p> <p>The data we create in <em>Code Snippet 2</em> makes absolutely no sense at all, but it will serve our purposes of have some volume of data to work with, and cause the execution to run for a little while.</p> <blockquote><p><strong>NOTE:</strong> Go back to <a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Internals - V</a> if you are interested in seeing what this code does.</p></blockquote> <p>The code we want to execute in SQL Server looks like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Execute from SQL Server</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>          <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>             #Sys.sleep(30)
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>             pid &lt;- Sys.getpid()
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>             r &lt;- rxLinMod(y ~ rand1 + rand2 + rand3 + rand4 + rand5,
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                           data=InputDataSet)
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>             coef &lt;- r$coefficients
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>             icept &lt;- coef</span><span class="se">[</span><span class="s1">1</span><span class="se">]</span><span class="s1">;
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>              OutputDataSet &lt;- data.frame(pid=pid, nRows=r$nValidObs,
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>                                          intercept=icept)'</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>       <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>              SELECT  y, rand1, rand2, rand3,
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>                      rand4, rand5
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>              FROM dbo.rand_30M'</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">((</span><span class="n">pid</span> <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">nRows</span> <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">intercept</span> <span class="n">FLOAT</span> <span class="k">NULL</span><span class="p">)</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">);</span> </div></div></pre></div></figure></p> <p><strong>Code Snippet 3:</strong> <em>Linear Regression in SQL Server</em></p> <p>To run this:</p> <ul> <li>Restart the launchpad service (this is to clean-up any RTerm processes).</li> <li>Navigate to the <code>Launchpad.exe</code> process in <em>Process Explorer</em>.</li> <li>Execute the code in <em>Code Snippet 3</em>.</li> <li>While the code is executing, look in <em>Process Explorer</em> for RTerm processes.</li> </ul> <p>Among the Rterm and BxlServer processes you should see one <code>BxlServer.exe</code> process that has a CPU value, as well as consuming some memory:</p> <p><img class="center" src="/images/posts/sql_r_services_8_bxlserver_processing.png" width="646" height="66" > <strong>Figure 15:</strong> <em>BxlServer Processing</em></p> <p>So, as I mentioned above, it is the <code>BxlServer.exe</code> which is doing he heavy lifting in SQL Server R Services.</p> <h2>Summary</h2> <p>In this post we have now seen what happens when executing <code>sp_execute_external_script</code>:</p> <ul> <li>SQL Server calls into the launchpad service.</li> <li>The launchpad service calls into the <code>Rlauncher.dll</code>.</li> <li>The <code>Rlauncher.dll</code> creates Rterm processes.</li> <li>Through Rterm, the <code>R.dll</code> is loaded together with <code>RxLink.dll</code>.</li> <li>The <code>RxLink.dll</code> creates the <code>BxlServer.exe</code> process.</li> <li>To coordinate with SQL Server, <code>BxlServer.exe</code> loads <code>BxServerLink.dll</code>.</li> </ul> <p>Below I have tried to describe it in a figure:</p> <p><img class="center" src="/images/posts/sql_r_services_8_arch_overview.png" width="650" height="194" > <strong>Figure 15:</strong> <em>BxlServer Processing</em></p> <p>Notice how, in <em>Figure 15</em>, there is nothing about how data gets back to SQL Server. That is something we will discuss in next post. Oh and yes, <em>Figure 15</em> looks very much like one of the figures you can see in this <a href="https://docs.microsoft.com/en-us/sql/advanced-analytics/r/new-components-in-sql-server-to-support-r">post</a>, and I freely admit I have looked at it :).</p> <h2>~ Finally</h2> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/07/22/microsoft-sql-server-r-services-internals-viii/&text=Microsoft SQL Server R Services - Internals VIII&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/07/22/microsoft-sql-server-r-services-internals-viii/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2017/07/22/microsoft-sql-server-r-services-internals-viii/ &title=Microsoft SQL Server R Services - Internals VIII &summary=Blog post: Here we look at some of the components the launchpad service loads; Rterm.exe, BxlServer.exe, etc. &source=http://www.nielsberglund.com/2017/07/22/microsoft-sql-server-r-services-internals-viii/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/07/22/microsoft-sql-server-r-services-internals-viii/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> <br/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad2 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="1158080725" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/"> Microsoft SQL Server R Services - Internals IX <small> (18 Aug 2017)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/"> Microsoft SQL Server R Services - Internals VII <small> (11 Jul 2017)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2017/06/25/creating-r-stored-procedures-in-sql-server-2016-using-sqlrutils/"> Creating R Stored Procedures in SQL Server 2016 Using sqlrutils <small> (25 Jun 2017)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
