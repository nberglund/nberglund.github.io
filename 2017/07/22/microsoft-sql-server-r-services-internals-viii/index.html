<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Microsoft SQL Server R Services - Internals VIII &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Microsoft SQL Server R Services - Internals VIII</h1>
  <div class="post-subheading">
  <span class="post-date">22 Jul 2017</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>This is the ninth post in a series about <strong>Microsoft SQL Server R Services</strong>, and the eight post that drills down into the internal of how it works. To see other posts (including this) in the series, go to: <a href="/series/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a></p>

<p>So far in this series we have been looking at what happens in SQL Server as well as the launchpad service when we execute <code class="highlighter-rouge">sp_execute_external_script</code>, and we have still no real “clue” to where the R engine comes into play.</p>

<p>Well, hopefully that will change (at least a little bit) with this post, as we here will look at what happens when we leave the launchpad service.</p>

<!--more-->

<p>Before we dive into the “juicy” stuff, let’s remind ourselves where we are.</p>

<h2 id="recap">Recap</h2>

<p>Normally in the recaps in this series, we have looked at what was covered in the previous “episode”. In this recap, let’s look at he “full” picture up until now.</p>

<p>The first post in the series - <a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">Microsoft SQL Server 2016 R Services Installation</a> - covered the installation of SQL Server 2016 R Services, and it also touched upon the external procedure which allows us to execute external scripts; <code class="highlighter-rouge">sp_execute_external_script</code>. We looked at the signature of the procedure as well as executing the equivalent to a “Hello World” script.</p>

<p>In the subsequent posts we talked about - when executing <code class="highlighter-rouge">sp_execute_external_script</code> - how SQL Server calls into the launchpad service, and how the launchpad service - through the <code class="highlighter-rouge">rlauncher.dll</code> creates multiple <code class="highlighter-rouge">Rterm.exe</code> processes as in <em>Figure 1</em> below. One of the processes will be used to run the external script:</p>

<p><img src="/images/posts/sql-launchpad-rterm_processes.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Rterm.exe Processes</em></p>

<p>I addition to creating <code class="highlighter-rouge">Rterm.exe</code> processes, the launchpad service also creates backing directories for those processes. These backing directories are used for saving output, intermediate results etc. The following figure was used to show what the call flow looks like:</p>

<p><img src="/images/posts/sql-launchpad_processes_post.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>Call Flow Executing sp_execute_external_script</em></p>

<p>We discussed how the number of processes can be controlled by the <code class="highlighter-rouge">PROCESS_POOL_SQLSATELLITE_GROWTH</code> setting in <code class="highlighter-rouge">rlauncher.config</code> file, and how it defaults to 5 if nothing is set.</p>

<p>In <a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Internals - VI</a> we came back to the backing directories, and we realized that in addition to the backing directories created for the Rterm processes, one more directory is created - which will be the “official” working directory for the session, and we showed this using this figure:</p>

<p><img src="/images/posts/sql_r_services_6_launchpad_working_dir.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>Launchpad, Directories and Processes</em></p>

<p>While we were investigating the directories created in <a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Internals - VI</a> we saw that, while we executed an external script, files and sub-directories were created in the various backing directories:</p>

<p><img src="/images/posts/sql_r_services_7_outputdir.png" alt="" /></p>

<p><strong>Figure 4:</strong> <em>Contents Process Directory</em></p>

<p>In <em>Figure 4</em> we see he content of the directory which is the processing directory, and in <a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Internals - VII</a> we looked into what creates those files/directories and what they are for. We came to the conclusion that both the launchpad service (probably through the <code class="highlighter-rouge">rlauncher.dll</code>) created some files, whereas <code class="highlighter-rouge">Rterm.exe</code> created others.</p>

<p>That’s where we are, and now it is time to look at the world outside of the launchpad, and try to figure out what is being used when executing an external script.</p>

<h2 id="rtermexe">Rterm.exe</h2>

<p>In <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a> we saw how the launchpad service creates Rterm processes, and how the launchpad service calls <code class="highlighter-rouge">launchpad!CSQLSatelliteCommunication::SendResumeWithLoginInfo</code> followed by <code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::WriteMessage</code> to call into the Rterm process chosen for execution of the external script. So what does <code class="highlighter-rouge">Rterm.exe</code> and the RTerm process do?</p>

<p>To answer that let us first look at what the R “engine” really is, and let’s do that by looking at standard CRAN R, and for this I use RStudio as an IDE. So, let’s open RStudio and make sure it uses the CRAN R engine:</p>

<p><img src="/images/posts/sql_r_services_8_rstudio_cran.png" alt="" /></p>

<p><strong>Figure 5:</strong> <em>RStudion CRAN R</em></p>

<p>At that stage if I check in <strong>Process Explorer</strong> to see what processes are loaded I see something like this:</p>

<p><img src="/images/posts/sql_r_services_8_rstudio_rsession.png" alt="" /></p>

<p><strong>Figure 6:</strong> <em>Processes Loaded</em></p>

<p>So in <em>Figure 6</em> we see how the <code class="highlighter-rouge">rstudio.exe</code> is host for <code class="highlighter-rouge">rsession.exe</code>, which in turn host <code class="highlighter-rouge">conhost.exe</code>. For this discussion <code class="highlighter-rouge">conhost.exe</code> has no real impact, but if you want to know more about it, <a href="https://blogs.technet.microsoft.com/askperf/2009/10/05/windows-7-windows-server-2008-r2-console-host/">here</a> is a good article explaining why we have <code class="highlighter-rouge">conhost.exe</code>.</p>

<p>Going back to <code class="highlighter-rouge">rsession.exe</code>; in Process Explorer, we look at what dll’s it has loaded (click on ``rsession.exe` followed by <strong>Ctrl-D</strong> ) we’ll see something like this:</p>

<p><img src="/images/posts/sql_r_services_8_rstudio_rsession_dlls1.png" alt="" /></p>

<p><strong>Figure 7:</strong> <em>Loaded dll’s</em></p>

<p><em>Figure 7</em> above shows 7 dll’s loaded by <code class="highlighter-rouge">rsession.exe</code>, and what is interesting is the second from bottom, which has a path pointing to the R libraries. When we look further down in the list we’ll see more dll’s from the R libraries:</p>

<p><img src="/images/posts/sql_r_services_8_rstudio_rsession_rdlls.png" alt="" /></p>

<p><strong>Figure 8:</strong> <em>R Dlls</em></p>

<p>Among the dll’s we see the <code class="highlighter-rouge">R.dll</code>, which is the main dll for R. So, it seems that <code class="highlighter-rouge">rsession.exe</code> acts as a host for the R engine, and the R engine is a “bunch” of dll’s.</p>

<p>Coming back to <code class="highlighter-rouge">rterm.exe</code> and what it is, we can now assume it acts in the same way as <code class="highlighter-rouge">rsession.exe</code>. Let us go back to the code that we used in <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a> when we captured the figure we above in <em>Figure 1</em>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span> 
                    <span class="o">@</span><span class="k">language</span> <span class="o">=</span><span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
                    <span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s1">'OutputDataSet&lt;-InputDataSet;
                              Sys.sleep(120);'</span><span class="p">,</span>
                    <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span><span class="n">N</span><span class="s1">'SELECT 42'</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">(([</span><span class="n">TheAnswer</span><span class="p">]</span> <span class="n">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">));</span>
</code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Execute with Sys.Sleep</em></p>

<p>Like we did in <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a>, we’ll execute the code in <em>Code Snippet 1</em>, and while the code is running we’ll look in Process Explorer and see if we find anything of interest:</p>

<ol>
  <li>Stop the launchpad service.</li>
  <li>Restart the launchpad service.</li>
  <li>Start <em>Process Explorer</em>, order by Process, and scroll down to where you see process names starting with “RT” (on my box there are none at this stage), or where the processes should be.
    <ul>
      <li>If you at this stage see RTerm, restart the launchpad service again and kill those processes.</li>
    </ul>
  </li>
  <li>Execute the code in <em>Code Snippet 1</em>.</li>
</ol>

<p>While the code is running, take a quick look in Process Explorer, and you should see something like so:</p>

<p><img src="/images/posts/sql_r_services_8_rterm_processes.png" alt="" /></p>

<p><strong>Figure 9:</strong> <em>RTerm Processes</em></p>

<p>The difference between <em>Figure 1</em> and <em>Figure 9</em>, is that in <em>Figure 1</em> I had collapsed the Rterm processes. In <em>Figure 9</em> we see how the launchpad service is host for multiple Rterm processes, and how <code class="highlighter-rouge">Rterm.exe</code> is host for <code class="highlighter-rouge">conhost.exe</code> as well as <code class="highlighter-rouge">BxlServer.exe</code>. We’ll come back shortly to what <code class="highlighter-rouge">BxlServer.exe</code> is.</p>

<p>Let’s look a bit closer at what dll’s we find for one of the active Rterm processes, click on the Rterm process which has a CPU value, and then click <strong>Ctrl-D</strong>.</p>

<blockquote>
  <p><strong>NOTE:</strong> You may have to re-execute the code in <em>Code Snippet 1</em>, maybe even increase the sleep time to 3 or 4 minutes to be able to see everything.</p>
</blockquote>

<p>When I scroll down in the dll list I see some familiar R dll’s, that we also saw in <em>Figure 8</em>:</p>

<p><img src="/images/posts/sql_r_services_8_rterm_dlls.png" alt="" /></p>

<p><strong>Figure 10:</strong> <em>Rterm R dll’s</em></p>

<p>At this stage we can safely say that the <code class="highlighter-rouge">Rterm.exe</code> and its process hosts the R engine. That is cool (yeah I know - I need to get a life), but what does that <code class="highlighter-rouge">BxlServer.exe</code> do in the mix?</p>

<h2 id="bxlserver">BxlServer</h2>

<p>So the question was, what is the <code class="highlighter-rouge">BxlServer.exe</code>? To answer that let’s take a step back, and look at the R offerings Microsoft has:</p>

<ul>
  <li>Microsoft R Open - a Microsoft open source offering of R</li>
  <li>Microsoft R Server - Microsoft’s commercial R offering.</li>
  <li>SQL Server R Services - the moral equivalent of Microsoft R Server, but with SQL Server as delivery vehicle.</li>
</ul>

<p>Let’s see what happens if we pointed RStudio towards the Microsoft R Open environment:</p>

<p><img src="/images/posts/sql_r_services_8_rstudio_mro.png" alt="" /></p>

<p><strong>Figure 11:</strong> <em>RStudio Targeting MRO</em></p>

<p>In <em>Process Explorer</em>, looking at the rstudio process, it won’t look any different than what it did when Rstudio targeted CRAN R as in <em>Figure 6</em>, so obviously the Microsoft R Open offering does not “know” of the <code class="highlighter-rouge">BxlServer.exe</code> we see in <em>Figure 9</em>. But, looking at the dll’s loaded by <code class="highlighter-rouge">rsession.exe</code>, we see more or less the same as was loaded by <code class="highlighter-rouge">rterm.exe</code> in <em>Figure 10</em>:</p>

<p><img src="/images/posts/sql_r_services_8_rstudio_mro_dlls.png" alt="" /></p>

<p><strong>Figure 12:</strong> <em>RStudio MRO dll’s</em></p>

<p>What would happen if RStudio targeted the Microsoft R Server (MRS) instead:</p>

<p><img src="/images/posts/sql_r_services_8_rstudio_mrs.png" alt="" /></p>

<p><strong>Figure 13:</strong> <em>RStudio Targeting MRS</em></p>

<p>This time when looking at the rstudio process we do see <code class="highlighter-rouge">BxlServer.exe</code> as a process hosted by <code class="highlighter-rouge">rsession.exe</code>, so it seems that <code class="highlighter-rouge">BxlServer.exe</code> is specifically for the commercial versions of Microsoft R.</p>

<blockquote>
  <p><strong>NOTE:</strong> There is no difference between the <code class="highlighter-rouge">BxlServer.exe</code> in MRS and SQL Server R Services. Well, not much anyway :), in next post we’ll see some differences.</p>
</blockquote>

<p>By now you are probably saying something like: “Niels, this is very informative - NOT, get to the point - what is <code class="highlighter-rouge">BxlServer.exe</code>”. OK, so let us see some of the dll’s <code class="highlighter-rouge">BxlServer.exe</code> has loaded (click on the <code class="highlighter-rouge">BxlServer.exe</code> process and <strong>Ctrl-D</strong>):</p>

<p><img src="/images/posts/sql_r_services_8_rstudio_bxlserver.png" alt="" /></p>

<p><strong>Figure 13:</strong> <em>BxlServer Loaded dll’s</em></p>

<p>Ooh, that’s interesting, look at the path and especially what is in the red rectangle: <code class="highlighter-rouge">RevoScaleR</code>.</p>

<p>RevoScaleR, is an R package providing both High Performance Computing (HPC) and High Performance Analytics (HPA) capabilities for R.  HPC capabilities allow you to distribute the execution of essentially any R function across cores and nodes, and deliver the results back to the user. HPA adds the ability to handle big data in a high performance way. In addition to this (or rather as part of) RevoScaleR also has functionality to handle data access with high performance, and <code class="highlighter-rouge">BxlServer.exe</code> is the host for all this.</p>

<p>In addition to run the HPC, HPA and data access, <code class="highlighter-rouge">BxlServer.exe</code> also coordinates with the R runtime in order to manage exchanges of data with SQL Server, and it runs most of the R processing. A lot of the coordination and handling of result sets in <code class="highlighter-rouge">BxlServer.exe</code> is handled by a dll loaded by <code class="highlighter-rouge">BxlServer.exe</code>: <code class="highlighter-rouge">BxServerLink.dll</code>. Below we see how the <code class="highlighter-rouge">BxServerLink.dll</code> is loaded by <code class="highlighter-rouge">Bxlserver.exe</code>.</p>

<p><img src="/images/posts/sql_r_services_8_rstudio_bxserverlink.png" alt="" /></p>

<p><strong>Figure 14:</strong> <em>BxServerLink Loaded by BxlServer.exe</em></p>

<p>Let’s go back to <em>Figure 13</em> , where we see how <code class="highlighter-rouge">rsession.exe</code> hosts <code class="highlighter-rouge">BxlServer.exe</code>. How does that work, I mean - <code class="highlighter-rouge">rsession.exe</code> is a CRAN R executable, and it does not know anything about Microsoft R Services and <code class="highlighter-rouge">BxlServer.exe</code>? The answer is <code class="highlighter-rouge">R.dll</code>; when <code class="highlighter-rouge">rsession.exe</code> loads <code class="highlighter-rouge">R.dll</code> (which is a Microsoft dll), the <code class="highlighter-rouge">R.dll</code> then starts to load other dll’s. But, <code class="highlighter-rouge">BxlServer.exe</code> is not a dll, and it runs in a separate process, surely <code class="highlighter-rouge">R.dll</code> cannot do that? No, it cannot - but what it does do is to load a dll acting as a conduit: the <code class="highlighter-rouge">RxLink.dll</code>. The <code class="highlighter-rouge">RxLink.dll</code> creates a new process in where <code class="highlighter-rouge">BxlServer.exe</code> runs, and that is how communication happens between <code class="highlighter-rouge">rsession.exe</code> and <code class="highlighter-rouge">BxlServer.exe</code>. And that is also what happens in SQL Server R Services where <code class="highlighter-rouge">Rterm.exe</code> is the “host”. <code class="highlighter-rouge">Rterm.exe</code> loads the <code class="highlighter-rouge">R.dll</code> which loads <code class="highlighter-rouge">RxLink.dll</code> who then creates a process for <code class="highlighter-rouge">BxlServer.exe</code>, and <code class="highlighter-rouge">BxlServer.exe</code> loads <code class="highlighter-rouge">BxLinkServer.dll</code>.</p>

<blockquote>
  <p><strong>NOTE:</strong> In the next Internals post we’ll look more at <code class="highlighter-rouge">RxLink.dll</code>, and <code class="highlighter-rouge">BxLinkServer.dll</code>.</p>
</blockquote>

<p>Finally, let’s make sure that <code class="highlighter-rouge">BxlServer.exe</code> actually is doing something when we execute an external script in SQL Server R Services. For that we’ll use some code we wrote in <a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Internals V</a>, where we discussed parallelism:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="n">USE</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_30M</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_30M</span><span class="p">(</span><span class="n">RowID</span> <span class="n">bigint</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> <span class="n">y</span> <span class="n">int</span><span class="p">,</span> 
                          <span class="n">rand1</span> <span class="n">int</span><span class="p">,</span> <span class="n">rand2</span> <span class="n">int</span><span class="p">,</span> <span class="n">rand3</span> <span class="n">int</span><span class="p">,</span> <span class="n">rand4</span> <span class="n">int</span><span class="p">,</span> 
                          <span class="n">rand5</span> <span class="n">int</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_30M</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">rand3</span><span class="p">,</span> <span class="n">rand4</span><span class="p">,</span> <span class="n">rand5</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">30000000</span><span class="p">)</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span> 
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">20</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">25</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">50</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">100</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o1</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o2</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o3</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o4</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Setup of Database, Table and Data</em></p>

<p>The data we create in <em>Code Snippet 2</em> makes absolutely no sense at all, but it will serve our purposes of have some volume of data to work with, and cause the execution to run for a little while.</p>

<blockquote>
  <p><strong>NOTE:</strong> Go back to <a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Internals - V</a> if you are interested in seeing what this code does.</p>
</blockquote>

<p>The code we want to execute in SQL Server looks like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
          <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
        <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
             #Sys.sleep(30)
             pid &lt;- Sys.getpid()
             r &lt;- rxLinMod(y ~ rand1 + rand2 + rand3 + rand4 + rand5, 
                           data=InputDataSet)
 
             coef &lt;- r$coefficients
             icept &lt;- coef</span><span class="se">\[</span><span class="s1">1</span><span class="se">\]</span><span class="s1">;
              OutputDataSet &lt;- data.frame(pid=pid, nRows=r$nValidObs, 
                                          intercept=icept)'</span>
       <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
              SELECT  y, rand1, rand2, rand3, 
                      rand4, rand5 
              FROM dbo.rand_30M'</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">((</span><span class="n">pid</span> <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">nRows</span> <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">intercept</span> <span class="n">FLOAT</span> <span class="k">NULL</span><span class="p">)</span>
<span class="p">);</span> 
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Linear Regression in SQL Server</em></p>

<p>To run this:</p>

<ul>
  <li>Restart the launchpad service (this is to clean-up any RTerm processes).</li>
  <li>Navigate to the <code class="highlighter-rouge">Launchpad.exe</code> process in <em>Process Explorer</em>.</li>
  <li>Execute the code in <em>Code Snippet 3</em>.</li>
  <li>While the code is executing, look in <em>Process Explorer</em> for RTerm processes.</li>
</ul>

<p>Among the Rterm and BxlServer processes you should see one <code class="highlighter-rouge">BxlServer.exe</code> process that has a CPU value, as well as consuming some memory:</p>

<p><img src="/images/posts/sql_r_services_8_bxlserver_processing.png" alt="" /></p>

<p><strong>Figure 15:</strong> <em>BxlServer Processing</em></p>

<p>So, as I mentioned above, it is the <code class="highlighter-rouge">BxlServer.exe</code> which is doing he heavy lifting in SQL Server R Services.</p>

<h2 id="summary">Summary</h2>

<p>In this post we have now seen what happens when executing <code class="highlighter-rouge">sp_execute_external_script</code>:</p>

<ul>
  <li>SQL Server calls into the launchpad service.</li>
  <li>The launchpad service calls into the <code class="highlighter-rouge">Rlauncher.dll</code>.</li>
  <li>The <code class="highlighter-rouge">Rlauncher.dll</code> creates Rterm processes.</li>
  <li>Through Rterm, the <code class="highlighter-rouge">R.dll</code> is loaded together with <code class="highlighter-rouge">RxLink.dll</code>.</li>
  <li>The <code class="highlighter-rouge">RxLink.dll</code> creates the <code class="highlighter-rouge">BxlServer.exe</code> process.</li>
  <li>To coordinate with SQL Server, <code class="highlighter-rouge">BxlServer.exe</code> loads <code class="highlighter-rouge">BxServerLink.dll</code>.</li>
</ul>

<p>Below I have tried to describe it in a figure:</p>

<p><img src="/images/posts/sql_r_services_8_arch_overview.png" alt="" /></p>

<p><strong>Figure 15:</strong> <em>BxlServer Processing</em></p>

<p>Notice how, in <em>Figure 15</em>, there is nothing about how data gets back to SQL Server. That is something we will discuss in next post. Oh and yes, <em>Figure 15</em> looks very much like one of the figures you can see in this <a href="https://docs.microsoft.com/en-us/sql/advanced-analytics/r/new-components-in-sql-server-to-support-r">post</a>, and I freely admit I have looked at it :).</p>

<h2 id="-finally">~ Finally</h2>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/07/22/microsoft-sql-server-r-services-internals-viii/&text=Microsoft SQL Server R Services - Internals VIII&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/07/22/microsoft-sql-server-r-services-internals-viii/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2017/07/22/microsoft-sql-server-r-services-internals-viii/
         &title=Microsoft SQL Server R Services - Internals VIII
         &summary=Blog post: Here we look at some of the components the launchpad service loads; Rterm.exe, BxlServer.exe, etc.
         &source=http://www.nielsberglund.com/2017/07/22/microsoft-sql-server-r-services-internals-viii/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/07/22/microsoft-sql-server-r-services-internals-viii/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-machine-learning-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Machine Learning Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#windbg">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WinDbg</span>
    </a>
  
    
    <a href="/tags/#launchpad">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Launchpad</span>
    </a>
  
    
    <a href="/tags/#rterm-exe">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">RTerm.exe</span>
    </a>
  
    
    <a href="/tags/#bxlserver-exe">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">BxlServer.exe</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2017/07/22/microsoft-sql-server-r-services-internals-viii/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2017/07/22/microsoft-sql-server-r-services-internals-viii/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/07/29/interesting-stuff-week-30/">
            Interesting Stuff - Week 30
            <small>29 Jul 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
