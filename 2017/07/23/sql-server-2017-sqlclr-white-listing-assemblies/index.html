<!DOCTYPE html> <html lang="en-us"> <head> <!-- Google Tag Manager --> <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-K7B3642');</script> <!-- End Google Tag Manager --> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="SQL Server 2017 RC1 has added new functionality for SQLCLR security; sp_add_trusted_assembly."> <meta name="keywords" content="SQL Server, SQL Server 2017, SQLCLR, permissions, clr strict security, TRUSTWORTHY, sys.sp_add_trusted_assembly, HASHBYTES"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> SQL Server 2017 SQLCLR - Whitelisting Assemblies &middot; Niels Berglund </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-d361e701e0c0e75e121ac3e901cff1b8.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.5.0 --> <title>SQL Server 2017 SQLCLR - Whitelisting Assemblies | Niels Berglund</title> <meta name="generator" content="Jekyll v3.8.2" /> <meta property="og:title" content="SQL Server 2017 SQLCLR - Whitelisting Assemblies" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="SQL Server 2017 RC1 has added new functionality for SQLCLR security; sp_add_trusted_assembly." /> <meta property="og:description" content="SQL Server 2017 RC1 has added new functionality for SQLCLR security; sp_add_trusted_assembly." /> <link rel="canonical" href="http://nielsberglund.com/2017/07/23/sql-server-2017-sqlclr-white-listing-assemblies/" /> <meta property="og:url" content="http://nielsberglund.com/2017/07/23/sql-server-2017-sqlclr-white-listing-assemblies/" /> <meta property="og:site_name" content="Niels Berglund" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2017-07-23T09:53:57+02:00" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"http://nielsberglund.com/2017/07/23/sql-server-2017-sqlclr-white-listing-assemblies/","headline":"SQL Server 2017 SQLCLR - Whitelisting Assemblies","dateModified":"2017-07-23T09:53:57+02:00","datePublished":"2017-07-23T09:53:57+02:00","author":{"@type":"Person","name":"nielsb"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://nielsberglund.com/2017/07/23/sql-server-2017-sqlclr-white-listing-assemblies/"},"description":"SQL Server 2017 RC1 has added new functionality for SQLCLR security; sp_add_trusted_assembly.","@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-3005153158271538", enable_page_level_ads: true }); </script> </head> <body> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K7B3642" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) --> <div class="sidebar"> <div class="container"> <div class="sidebar-about"> <h1> <a href="/"> Niels Berglund </a> </h1> <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Sidebar_rectangle --> <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-3005153158271538" data-ad-slot="7704601332"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/disclaimer/">Disclaimer</a> <a class="sidebar-nav-item" href="/series/">Blog Post Series</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <img class="center" src="/images/MVP_Logo_large.png" width="300" height="121" > <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <p>&copy; 2018. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">SQL Server 2017 SQLCLR - Whitelisting Assemblies</h1> <div class="post-subheading"> <span class="post-date">23 Jul 2017</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#SQL Server 2017">SQL Server 2017</a> <a href="/categories/#SQLCLR">SQLCLR</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server">SQL Server</a> <a href="/tags/#SQL Server 2017">SQL Server 2017</a> <a href="/tags/#SQLCLR">SQLCLR</a> <a href="/tags/#permissions">permissions</a> <a href="/tags/#clr strict security">clr strict security</a> <a href="/tags/#TRUSTWORTHY">TRUSTWORTHY</a> <a href="/tags/#sys.sp_add_trusted_assembly">sys.sp_add_trusted_assembly</a> <a href="/tags/#HASHBYTES">HASHBYTES</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> <p>A little while ago I wrote a <a href="/2017/07/02/sql-server-2017-sqlclr-and-permissions/">blog-post</a> about the changes in the SQLCLR security model in SQL Server 2017. I wrote about how Microsoft has changed the relation between CAS and security boundaries, and CAS is no longer supported as a boundary! And also how Microsoft introduced an <code>sp_configure</code> option called <code>clr strict security</code>, which by default is set to 1 (on). When the setting is on, SQL Server treats all assemblies (<code>SAFE</code>, <code>EXTERNAL_ACCESS</code>, <code>UNSAFE</code>) as if they were marked <code>UNSAFE</code>.</p> <p>The release I wrote the post against was CTP 2.1, and earlier this week Microsoft released SQL Server 2017 RC1. Some days ago I received a comment from <em>Paul Vestuto</em> on my <a href="/2017/07/02/sql-server-2017-sqlclr-and-permissions/">post</a>, pointing out that in RC1 there has been some more changes to the security model. I thought those changes would earn their own blog-post, instead of just editing the <a href="/2017/07/02/sql-server-2017-sqlclr-and-permissions/">previous post</a>.</p> <!--more--> <p>Let's look back at what the changes were in SQL 2017, to the SQLCLR permissions.</p> <h2>Recap</h2> <p>In SQL Server 2017, Microsoft now by default requires that all type of assemblies (<code>SAFE</code>, <code>EXTERNAL_ACCESS</code>, <code>UNSAFE</code>) are authorized for <code>UNSAFE</code> access, by:</p> <ul> <li>The database is set to be <code>TRUSTWORTHY</code>, <em>OR</em></li> <li>The assembly is signed with a certificate that has a corresponding login with <code>UNSAFE ASSEMBLY</code> permission, <em>OR</em></li> <li>The assembly is signed with an asymmetric key that has a corresponding login with <code>UNSAFE ASSEMBLY</code> permission.</li> </ul> <p>The implication of the above is that, unless you want to mark your database <code>TRUSTWORTHY</code>, you can no longer "just" deploy a <code>SAFE</code> assembly, it has to be signed!</p> <p>You may say that: "signing is not that bad - what's the big deal". Sure, sign one or two assemblies may not be that bad, but if you have, like <a href="/derivco">us</a>, 50 - 60 assemblies then it can become a chore. Especially since there is no real tooling for this.</p> <p>So, in SQL Server 2017 RC1, Microsoft has tried to make things somewhat simpler.</p> <h2>Assembly Whitelisting</h2> <p>What Microsoft introduces in SQL Server 2017 RC1, is something I refer to as <a href="https://en.wikipedia.org/wiki/Whitelist">whitelisting</a>. It is somewhat similar to the <code>TRUSTWORTHY</code> setting, where you indicate that a database is to be trusted. But instead of doing it on the database level, you do it per assembly.</p> <p>To whitelist in SQL Server 2017 RC1, you use the system stored procedure <code>sys.sp_add_trusted_assembly</code>. As the name implies the procedure adds an assembly to a list of "trusted" assemblies. By marking an assembly as trusted, SQL Server will allow it to be loaded when <code>clr strict security</code> is on (on by default), even if:</p> <ul> <li>the assembly is not signed, <em>and</em></li> <li>the database where you want to deploy it to is not <code>TRUSTWORTHY</code>.</li> </ul> <h4>Demo Code</h4> <p>Before we start to look into how this works, let's look at the demo code we'll be using. If you read the <a href="/2017/07/02/sql-server-2017-sqlclr-and-permissions/">SQL Server 2017, SQLCLR and Permissions</a> post, the code should look fairly familiar. So, on a SQL Server 2017 RC1 installation, let us first make sure that we are correctly configured:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Configuration</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sp_configure</span> <span class="s1">'show advanced options'</span><span class="p">,</span> <span class="mi">1</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">RECONFIGURE</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sp_configure</span> <span class="s1">'clr_enabled'</span><span class="p">,</span> <span class="mi">1</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">RECONFIGURE</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sp_configure</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Check Configuration</em></p> <p>In <em>Code Snippet 1</em> we ensure that we can see all the various options that exist, and then we enable SQLCLR. Finally we see what values we have for the options and that should result in something like so:</p> <p><img class="center" src="/images/posts/sql2k17_trust_asms_options.png" width="547" height="100" > <strong>Figure 1:</strong> <em>Configuration Settings</em></p> <p>From <em>Figure 1</em> we see that SQLCLR is enabled as well as that <code>clr strict security</code> is on. We can now create the databases we need (yes, databases as in plural - will explain later):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Databases</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">DeployDB</span><span class="p">;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">TrustedAsmDB</span><span class="p">;</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">DeployDB</span><span class="p">;</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">ALTER</span> <span class="k">DATABASE</span> <span class="n">DeployDB</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SET</span> <span class="n">TRUSTWORTHY</span> <span class="k">ON</span><span class="p">;</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">TrustedAsmDB</span><span class="p">;</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>Create Databases</em></p> <p>For now, don't worry about the <code>DeployDB</code> database, the database that will be the "production" database and to where we want to deploy an assembly is <code>TrustedAsmDB</code>.</p> <p>With the databases created, the CLR code we will use is some of what we used in the <a href="/2017/07/02/sql-server-2017-sqlclr-and-permissions/">SQL Server 2017, SQLCLR and Permissions</a> post:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>CLR</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">namespace</span> <span class="nn">Sql2k17TrustedAsm1</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">&#x7b;</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="k">public</span> <span class="k">class</span> <span class="nc">Functions</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7b;</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fn_clr_Adder</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7b;</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="k">return</span> <span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">;</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7d;</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fn_clr_LongRunningAdder</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7b;</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="kt">var</span> <span class="n">t</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">LongRunning</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">));</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7d;</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="k">static</span> <span class="kt">int</span> <span class="nf">LongRunning</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7b;</span>
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="kt">var</span> <span class="n">wait</span> <span class="p">=</span> <span class="p">(</span><span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">)</span> <span class="p">*</span> <span class="m">100</span><span class="p">;</span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="k">return</span> <span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">;</span>
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">&#x7d;</span>
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">&#x7d;</span>
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">&#x7d;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 3:</strong> <em>C# Code to Use</em></p> <p>After having compiled the code in <em>Code Snippet 3</em> we can now try and deploy the assembly to our production database (which is not <code>TRUSTWORTHY</code>):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Assembly Creation</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">USE</span> <span class="n">TrustedAsmDB</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="n">Sql2k17TrustedAsm</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="s1">'W:</span><span class="se">\</span><span class="s1">&lt;path_to_dll&gt;</span><span class="se">\</span><span class="s1">Sql2k17TrustedAsm1.dll'</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 4:</strong> <em>Create Assembly</em></p> <p>When executing the code in <em>Code Snippet 4</em>, you'll get almost the same error message as we initially saw in <a href="/2017/07/02/sql-server-2017-sqlclr-and-permissions/">SQL Server 2017, SQLCLR and Permissions</a>, when we tried an deploy an assembly without the assembly being signed:</p> <p><img class="center" src="/images/posts/sql2k17_trust_asms_creation_fail.png" width="627" height="190" > <strong>Figure 2:</strong> <em>Error Deploying Assembly</em></p> <p>The only difference is the last part of the error message: <em>Alternatively, you can trust the assembly using sp_add_trusted_assembly</em>.</p> <h2>sys.sp_add_trusted_assembly</h2> <p>Above we mentioned how <code>sys.sp_add_trusted_assembly</code> adds an assembly to a list of "trusted" assemblies. We also said that by marking an assembly as trusted, SQL Server will allow it to be loaded when <code>clr strict security</code> is on, even though the assembly in question is not signed, and the database where you want to deploy it to is not <code>TRUSTWORTHY</code>.</p> <p>How do we use <code>sys.sp_add_trusted_assembly</code>? Well, the signature looks like this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Proc. Signature</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sp_add_trusted_assembly</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">[</span> <span class="o">@</span><span class="n">hash</span> <span class="o">=</span> <span class="p">]</span> <span class="s1">'value'</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">[</span> <span class="p">,</span> <span class="p">[</span> <span class="o">@</span><span class="n">description</span> <span class="o">=</span> <span class="p">]</span> <span class="s1">'description'</span> <span class="p">]</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 5:</strong> <em>Signature of sys.sp_add_trusted_assembly</em></p> <p>As we see in <em>Code Snippet 5</em>, the procedure takes two parameters:</p> <ul> <li><code>@hash</code> - this is the <code>SHA2_512</code> hash value of the binary representation of the assembly.</li> <li><code>@description</code> - an optional description of the assembly. It is recommended that the description is the same as you would see in the <code>clr_name</code> column in <code>sys.assemblies</code>.</li> </ul> <p>That seems straightforward enough, grab the binary, hash it and off you go! But wait a second, how do you get the binary representation of the assembly, and how do you hash it?</p> <p>Well, there are various way you can get the binary representation; write some C# code that reads out the binary value of the dll, is one way - and then when you have it, you can run some C# code to create the hash.</p> <p>Me, I am a lazy guy, and I am a database developer at heart, so I use the database for this, and this is now where that second database in <em>Code Snippet 2</em> comes in. The <code>DeployDB</code> which was marked as <code>TRUSTWORTHY</code>.</p> <p>What I do is:</p> <ul> <li>Create the assembly in the <code>TRUSTWORTHY</code> database.</li> <li>In SQL Server Management Studio's (SSMS) <strong>Object Explorer</strong> I script out the assembly as <code>CREATE</code> to the clipboard, or a new query window:</li> </ul> <p><img class="center" src="/images/posts/sql2k17_trust_asms_binary.png" width="650" height="580" > <strong>Figure 3:</strong> <em>Scripting the Assembly</em></p> <p>Scripting the assembly gives you the <code>CREATE</code> statement of the assembly based on the binary representation:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Create</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="p">[</span><span class="n">Sql2k17TrustedAsm</span><span class="p">]</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="mi">0</span><span class="n">x4D5A90000300000004000000FFFF00</span><span class="p">...</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 6:</strong> <em>Create Assembly from Binary</em></p> <p>Instead of scripting it out, I could have done a <code>SELECT</code> against the <code>sys.assembly_files</code> table and the <code>content</code> column, but I rather do it using the scripting option. I finally grab the <code>clr_name</code> value from the <code>sys.assemblies</code> table for the assembly:</p> <p><img class="center" src="/images/posts/sql2k17_trust_asms_clr_name.png" width="650" height="48" > <strong>Figure 4:</strong> <em>Clr Name</em></p> <p>Equipped with this I can now add the assembly as a trusted assembly. You may ask how do I get the hash value of the assembly? Fortunately SQL Server has a handy function called <code>HASHBYTES</code> which looks like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Hashbytes</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">HASHBYTES</span> <span class="p">(</span> <span class="s1">'&lt;algorithm&gt;'</span><span class="p">,</span> <span class="err">&#x7b;</span> <span class="o">@</span><span class="k">input</span> <span class="o">|</span> <span class="s1">'input'</span> <span class="err">&#x7d;</span> <span class="p">)</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 7:</strong> <em>T-SQL Hashbytes Function</em></p> <p>The function takes two parameters as you can see from <em>Code Snippet 7</em>:</p> <ul> <li><code>'&lt;algorithm&gt;'</code> - That is the hashing algorithm to use. In our case, <code>sys.sp_add_trusted_assembly</code> requires <code>SHA2_512</code>.</li> <li><code>{@input|'input'}</code> - This is either a <code>varchar</code>, <code>nvarchar</code> or <code>varbinary</code> variable, (<code>@input</code>), or an expression that results in a <code>varchar</code>, <code>nvarchar</code> or <code>varbinary</code>, (<code>'input'</code>). An example of the latter could be a column in a <code>SELECT</code> statement.</li> </ul> <p>When using the <code>SHA2_512</code> algorithm, the return value is 64 bytes, and an example of executing it based on the binary value of our assembly looks like this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>HASHBYTES</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="n">asmBin</span> <span class="n">varbinary</span><span class="p">(</span><span class="k">max</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="n">x4D5A90000300000004000000FFFF00</span><span class="p">...;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="n">hash</span> <span class="n">varbinary</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="o">@</span><span class="n">hash</span> <span class="o">=</span> <span class="n">HASHBYTES</span><span class="p">(</span><span class="s1">'SHA2_512'</span><span class="p">,</span> <span class="o">@</span><span class="n">asmBin</span><span class="p">);</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="o">@</span><span class="n">hash</span> </div></div></pre></div></figure></p> <p><strong>Code Snippet 8:</strong> <em>Usage of HASHBYTES</em></p> <p>In <em>Code Snippet 8</em> above, the <code>@asmBin</code> variable is obviously truncated for readability.</p> <p>Now, when we have the various pieces of the puzzle we can execute <code>sys.sp_add_trusted_assembly</code>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Trusted Assembly</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="n">clrName</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'sql2k17trustedasm1, ...'</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="n">asmBin</span> <span class="n">varbinary</span><span class="p">(</span><span class="k">max</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="n">x4D5A90000300000004000000FFFF00</span><span class="p">...;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="n">hash</span> <span class="n">varbinary</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="o">@</span><span class="n">hash</span> <span class="o">=</span> <span class="n">HASHBYTES</span><span class="p">(</span><span class="s1">'SHA2_512'</span><span class="p">,</span> <span class="o">@</span><span class="n">asmBin</span><span class="p">);</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sys</span><span class="p">.</span><span class="n">sp_add_trusted_assembly</span> <span class="o">@</span><span class="n">hash</span> <span class="o">=</span> <span class="o">@</span><span class="n">hash</span><span class="p">,</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>                                 <span class="o">@</span><span class="n">description</span> <span class="o">=</span> <span class="o">@</span><span class="n">clrName</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 9:</strong> <em>Adding Trusted Assembly</em></p> <p>The code in <em>Code Snippet 9</em> should succeed, and to ensure that is the case you can do: <code>SELECT * FROM sys.trusted_assemblies</code>:</p> <p><img class="center" src="/images/posts/sql2k17_trust_asms_trusted_assemblies.png" width="643" height="74" > <strong>Figure 5:</strong> <em>Content of sys.trusted_assemblies</em></p> <p>So, everything looks OK. We can now go to the production database where we started this journey and try and deploy the assembly. You can deploy it either using the code in <em>Code Snippet 4</em>, where it is being deployed from a path, or the code in <em>Code Snippet 6</em>, using the binary representation. The <code>CREATE ASSEMBLY</code> should now succeed.</p> <p>Having created the assembly, let's create a function against the <code>fn_clr_Adder</code> method, and then execute the function - just to ensure everything is OK:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Create Function</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_Adder</span><span class="p">(</span><span class="o">@</span><span class="n">x</span> <span class="n">int</span><span class="p">,</span> <span class="o">@</span><span class="n">y</span> <span class="n">int</span><span class="p">)</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">RETURNS</span> <span class="n">int</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXTERNAL</span> <span class="n">NAME</span> <span class="n">Sql2k17TrustedAsm</span><span class="p">.</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                   <span class="p">[</span><span class="n">Sql2k17TrustedAsm1</span><span class="p">.</span><span class="n">Functions</span><span class="p">].</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                   <span class="n">fn_clr_Adder</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_Adder</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 10:</strong> <em>Create and Test Function</em></p> <p>Running the code in <em>Code Snippet 10</em> should succeed, and you should get back a result of <code>42</code>. Just for "fun" you could create a new database, and try and deploy the assembly to that database. That should just work, seeing that <code>sys.sp_add_trusted_assembly</code> marks the assembly as trusted on the server instance.</p> <h4>Permission Sets</h4> <p>When we created the assembly from the code above, it was created with the default permission set <code>SAFE</code>. When you look at the C# code you see how there is a method - <code>fn_clr_LongRunningAdder</code> - which internally uses a <code>Task</code>. Using a <code>Task</code> is not considered <code>SAFE</code> in any shape or form, so what happens if you create a T-SQL function against that method and then try to execute:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Unsafe</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_LongRunningAdder</span><span class="p">(</span><span class="o">@</span><span class="n">x</span> <span class="n">int</span><span class="p">,</span> <span class="o">@</span><span class="n">y</span> <span class="n">int</span><span class="p">)</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">RETURNS</span> <span class="n">int</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXTERNAL</span> <span class="n">NAME</span> <span class="n">Sql2k17TrustedAsm</span><span class="p">.</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                  <span class="p">[</span><span class="n">Sql2k17TrustedAsm1</span><span class="p">.</span><span class="n">Functions</span><span class="p">].</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                  <span class="n">fn_clr_LongRunningAdder</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fn_clr_LongRunningAdder</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 11:</strong> <em>Create and Execute an Unsafe Function</em></p> <p>Ouch, the creation of the function succeeded, but when you executed the function you received an error that we also saw in the <a href="/2017/07/02/sql-server-2017-sqlclr-and-permissions/">SQL Server 2017, SQLCLR and Permissions</a> post. The error says something about not having necessary permissions to do the operation. This normally happens if the assembly has not been assigned the correct <code>PERMISSION_SET</code> when it was created.</p> <p>So, if you drop the functions and the assembly, and recreate the assembly with <code>PERMISSION_SET = UNSAFE</code>, then when you have recreated the functions, all should work.</p> <p>The slightly interesting thing with this is that even when you mark an assembly as trusted, it still has to be created with the correct permission set.</p> <h2>Dropping a Trusted Assembly</h2> <p>As with most database objects, if you can create them - then you can also <code>DROP</code> them. The question is if you have a trusted assembly, which you have deployed to the database and subsequently created functions etc., against - if you <code>DROP</code> the trusted assembly, what effect, if any, will it have on the existing assemblies in the various databases on the server? Let's find out.</p> <p>To drop a trusted assembly you use the proc <code>sys.sp_drop_trusted_assembly</code>. The proc takes one parameter, the hash value of the trusted assembly, and in our example the code would look like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Drop</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sys</span><span class="p">.</span><span class="n">sp_drop_trusted_assembly</span> <span class="o">@</span><span class="n">hash</span> <span class="o">=</span> <span class="mi">0</span><span class="n">xCDFEFD60682FBB0182</span><span class="p">...;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 12:</strong> <em>Drop Trusted Assembly</em></p> <p>Executing the code in <em>Code Snippet 12</em> works just fine, and when you look in <code>sys.trusted_assemblies</code> afterward, your trusted assembly is gone. However, if you check in <code>sys.assemblies</code> in the database where you deployed the actual assembly to, the assembly still exists. Isn't this now a big security hole? What happens when we execute one of our functions now, <code>SELECT dbo.fn_clr_Adder(21, 21)</code>:</p> <p><img class="center" src="/images/posts/sql2k17_trust_asms_no_trust.png" width="523" height="256" > <strong>Figure 6:</strong> <em>Assembly Not Trusted</em></p> <p>Based on the error message we get, it definitely seems like SQL Server checks whether the assembly is either signed or trusted during execution. So, no security hole.</p> <h2>Summary</h2> <p>In the <a href="/2017/07/02/sql-server-2017-sqlclr-and-permissions/">SQL Server 2017, SQLCLR and Permissions</a> post I summarized the new SQL Server 2017 SQLCLR security requirements with: <em>All type of assemblies (<code>SAFE</code>, <code>EXTERNAL_ACCESS</code>, <code>UNSAFE</code>) have to be authorized for <code>UNSAFE</code> access.</em></p> <p>With the release of SQL Server 2017 RC1 there is another option and that is, that the assembly is marked as trusted. You mark an assembly as trusted by the stored procedure <code>sys.sp_add_trusted_assembly</code>.</p> <p>The security choices you now have for an assembly in SQL Server 2017 are:</p> <ul> <li>The database is set to be <code>TRUSTWORTHY</code>, <em>OR</em></li> <li>The assembly is signed with a certificate that has a corresponding login with <code>UNSAFE ASSEMBLY</code> permission, <em>OR</em></li> <li>The assembly is signed with an asymmetric key that has a corresponding login with <code>UNSAFE ASSEMBLY</code> permission, <em>OR</em></li> <li>The assembly is marked as trustworthy by the <code>sys.sp_add_trusted_assembly</code> procedure.</li> </ul> <p>Marking an assembly as trusted does not mean that you can do whatever you want in the assembly, you still need to deploy the assembly with the correct permission set based on your operations in the assembly.</p> <p>I'm finishing this summary with the same caveat as I had in the <a href="/2017/07/02/sql-server-2017-sqlclr-and-permissions/">SQL Server 2017, SQLCLR and Permissions</a> post: Bear in mind that all the above are based on SQL Server 2017 RC1. Things may change up until release.</p> <h2>~ Finally</h2> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/07/23/sql-server-2017-sqlclr-white-listing-assemblies/&text=SQL Server 2017 SQLCLR - Whitelisting Assemblies&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/07/23/sql-server-2017-sqlclr-white-listing-assemblies/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2017/07/23/sql-server-2017-sqlclr-white-listing-assemblies/ &title=SQL Server 2017 SQLCLR - Whitelisting Assemblies &summary=Blog post: SQL Server 2017 RC1 has added new functionality for SQLCLR security; sp_add_trusted_assembly. &source=http://www.nielsberglund.com/2017/07/23/sql-server-2017-sqlclr-white-listing-assemblies/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/07/23/sql-server-2017-sqlclr-white-listing-assemblies/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> <br/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad2 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="1158080725" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2018/04/22/interesting-stuff-week-16/"> Interesting Stuff - Week 16 <small> (22 Apr 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/03/25/interesting-stuff-week-12/"> Interesting Stuff - Week 12 <small> (25 Mar 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2017/10/13/interesting-stuff-week-41/"> Interesting Stuff - Week 41 <small> (13 Oct 2017)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
