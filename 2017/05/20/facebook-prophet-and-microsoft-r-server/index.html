<!DOCTYPE html> <html lang="en-us"> <head> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="How to use Facebook Prophet in Microsoft R Server / SQL Server R Services"> <meta name="keywords" content="SQL Server R Services, SQL Server 2017, Microsoft R Server, R, R Tools for Visual Studio, Facebook Prophet, RTerm.exe"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Facebook Prophet and Microsoft R Server &middot; Niels Berglund </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-6937d9aff18f4bd864a4e4772a407120.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.3.0 --> <title>Facebook Prophet and Microsoft R Server | Niels Berglund</title> <meta property="og:title" content="Facebook Prophet and Microsoft R Server" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="How to use Facebook Prophet in Microsoft R Server / SQL Server R Services" /> <meta property="og:description" content="How to use Facebook Prophet in Microsoft R Server / SQL Server R Services" /> <link rel="canonical" href="http://nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/" /> <meta property="og:url" content="http://nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/" /> <meta property="og:site_name" content="Niels Berglund" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2017-05-20T11:31:37+02:00" /> <script type="application/ld+json"> {"name":null,"description":"How to use Facebook Prophet in Microsoft R Server / SQL Server R Services","author":{"@type":"Person","name":"nielsb"},"@type":"BlogPosting","url":"http://nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/","publisher":null,"image":null,"headline":"Facebook Prophet and Microsoft R Server","dateModified":"2017-05-20T11:31:37+02:00","datePublished":"2017-05-20T11:31:37+02:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/"},"@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <div class="sidebar"> <div class="container"> <div class="sidebar-about"> <h1> <a href="/"> Niels Berglund </a> </h1> <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/disclaimer/">Disclaimer</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <img class="center" src="/images/MVP_Logo.png" width="181" height="74" > <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <p>&copy; 2017. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">Facebook Prophet and Microsoft R Server</h1> <div class="post-subheading"> <span class="post-date">20 May 2017</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#Microsoft R Server">Microsoft R Server</a> <a href="/categories/#Data Science">Data Science</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server R Services">SQL Server R Services</a> <a href="/tags/#SQL Server 2017">SQL Server 2017</a> <a href="/tags/#Microsoft R Server">Microsoft R Server</a> <a href="/tags/#R">R</a> <a href="/tags/#R Tools for Visual Studio">R Tools for Visual Studio</a> <a href="/tags/#Facebook Prophet">Facebook Prophet</a> <a href="/tags/#RTerm.exe">RTerm.exe</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> <p><a href="https://en.wikipedia.org/wiki/Time_series">Time series</a> data is being used more and more in all industries, and of course we want to be able to forecast and predict future values. There are however a variety of challenges that come with producing a large number of forecasts across a variety of time series.</p> <p>The <a href="https://research.fb.com/category/data-science/">Facebook's data science team</a> has worked with time series forecasting for quite a while, and recently they open-sourced an internal tool for this type of forecasting: <a href="https://facebookincubator.github.io/prophet/">Facebook Prophet</a>.</p> <p>Recently there was a post on the Microsoft R Server forum if it was possible to use Prophet with Microsoft R Server, so I thought I'd test it out. This post covers how to use it, both from a standalone Microsoft R Server as well as SQL Server R Services.</p> <!--more--> <blockquote><p><strong>NOTE:</strong> Prophet requires an R version of 3.2.3 or greater. Unfortunately an installation of SQL Server 2016 R Services, in-database as well as standalone, uses R 3.2.2. So Prophet cannot be run on SQL Server R Services 2016, unless you upgrade the R version. In this post I am running SQL Server R Services 2017, both in-database and standalone.</p></blockquote> <p>So, in essence Prophet is just an R packet and should be installed as such. However on Windows, Prophet requires a compiler, <a href="http://mc-stan.org/">Stan</a>, which incurs some extra steps when installing Prophet.</p> <blockquote><p><strong>NOTE:</strong> The description of Stan from <a href="https://en.wikipedia.org/wiki/Stan_(software)">Wikipedia:</a> <em>Stan is a probabilistic programming language for statistical inference written in C++. The Stan language is used to specify a (Bayesian) statistical model with an imperative program calculating the log probability density function.</em>. So there!</p></blockquote> <h2>Stan &amp; Dependencies</h2> <p>If you are on Windows, regardless if you want to use Prophet in a standalone version of Microsoft R Server or in SQL Server R Services, you need to install Stan, or rather the R version (RStan). There is also a Stan version for Python; PyStan. In addition to RStan there are some dependencies that need to be installed.</p> <p>There is a very good article about how to install RStan on Windows <a href="https://github.com/stan-dev/rstan/wiki/Installing-RStan-on-Windows">here</a>, and below follows a very short summary of the article.</p> <h3>RTools Installation</h3> <p>Before you can install RStan you need to install a tool-chain that works with R, and - for this - RTools is an excellent choice.</p> <p>RTools can be downloaded form <a href="https://cran.r-project.org/bin/windows/Rtools/">here</a>, and you download the version that matches your Microsoft R Server's / SQL Server R Services version. The table below is a map between various Microsoft R Servers and the corresponding R version. I have not included SQL Server 2016 R Services as the R version is not compatible with Prophet:</p> <table> <thead> <tr> <th> <strong>R Server</strong> </th> <th> <strong>R Version</strong> </th> </tr> </thead> <tbody> <tr> <td> Microsoft R Server 8.x - 9.01 </td> <td> 3.3.2 </td> </tr> <tr> <td>-------------------------------</td> <td>-----------</td> </tr> <tr> <td> Microsoft R Server 9.1 </td> <td> 3.3.3 </td> </tr> <tr> <td>-------------------------------</td> <td>-----------</td> </tr> <tr> <td> SQL Server 2017 R Services </td> <td> 3.3.3 </td> </tr> <tr> <td>-------------------------------</td> <td>-----------</td> </tr> </tbody> </table> <p>On the machine I test this on, I have the in-database as well as the standalone R Services from SQL Server 2017, so I downloaded the <code>Rtools34.exe</code>.</p> <blockquote><p><strong>NOTE:</strong> If you have installed the stand-alone version of Microsoft R that comes with SQL Server R Services, the version of R is the same as for SQL Server R Services.</p></blockquote> <p>To install RTools double click the executable you just downloaded. What you need to ensure is that the <code>PATH</code> is set properly. So during the installation process, when it comes to the dialog <strong>Select Additional Tasks</strong> ensure that you check the check-box for <em>Edit the system PATH</em>:</p> <p><img class="center" src="/images/posts/prophet_rtool_install.png" width="496" height="384" > <strong>Figure 1:</strong> <em>Edit the System Path</em></p> <p>After having checked the box for editing the PATH, just click through and let the install finish. After installation check that the PATH has been set. You do this by running <code>RTerm.exe</code> and executing <code>Sys.getenv('PATH')</code> from command prompt.</p> <p>Dependent on if you want to run RTools on a standalone Microsoft Windows R Server installation or in-database, you find <code>RTerm.exe</code> at different locations. On my box the locations are:</p> <ul> <li>Standalone Microsoft R Server: <code>C:\Program Files\Microsoft SQL Server\140\R_SERVER\bin\x64</code></li> <li>SQL Server R Services: <code>C:\Program Files\Microsoft SQL Server\MSSQL14.INST2K17CTP20\R_SERVICES\bin\x64</code></li> </ul> <p>After executing <code>Sys.getenv('PATH')</code>, you should see something like so:</p> <p><img class="center" src="/images/posts/prophet_rtool_install_path.png" width="393" height="47" > <strong>Figure 2:</strong> <em>RTools Path</em></p> <p>You can also check that <code>g++</code> (C++ compiler) can be called: <code>system('g++ -v')</code>. That should result in something like:</p> <p><img class="center" src="/images/posts/prophet_rtool_install_g++.png" width="554" height="241" > <strong>Figure 3:</strong> <em>Checking for g++</em></p> <h3>RStan Installation</h3> <p>OK, so after all the above is OK - we can finally install RStan. RStan is just another package, and it should be installed as any other package (like Prophet, which we will see in a bit). Whereas RTools is just installed to a shared directory on the box where R resides, RStan needs to be installed for each R instance specifically.</p> <h4>Standalone Microsoft R Server</h4> <p>To install R packages you use the function <code>install.packages()</code>. For a standalone Microsoft R Server instance there is not much more you need to do, apart from saying where to install the package from and what to do about dependencies:</p> <ol> <li>Open <code>RTerm.exe</code> as admin from the location for the standalone instance (in my case: <code>C:\Program Files\Microsoft SQL Server\140\R_SERVER\bin\x64</code>).</li> <li>Execute the following code: <code>install.packages("rstan", repos = "https://cloud.r-project.org/", dependencies=TRUE)</code></li> <li>This will run for a while, click yes for any questions during installation.</li> </ol> <p>When the installation has finished you can test that it has succeeded and that the tool chain works:</p> <ol> <li>Close down the <code>RTerm.exe</code> terminal and re-open it (as admin).</li> <li>Execute the code in <em>Code Snippet 1</em> below.</li> </ol> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Toolchain Test</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1"># create an inline function fx</span><span class="w"></span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">fx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">inline</span><span class="o">::</span><span class="n">cxxfunction</span><span class="p">(</span><span class="w"> </span><span class="n">signature</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"numeric"</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="w">
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>            </span><span class="s1">'return ScalarReal( INTEGER(x)[0] * REAL(y)[0] ) ;'</span><span class="p">)</span><span class="w">
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">fx</span><span class="w"> </span><span class="p">(</span><span class="m">2L</span><span class="p">,</span><span class="m">5</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c1"># the result should be 10</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Test of RStan Installation</em></p> <p>When executing the above, the result from <code>fx(2L,5)</code> should be 10.</p> <h4>SQL Server R Services Installation</h4> <p>The way to install a package in SQL Server R Services is similar to the standalone installation. However you cannot install a package to any directory, it has to be installed to the default package directory for the instance, as only only one package library is allowed.</p> <p>The code in <em>Code Snippet 2</em> below shows how to retrieve the default package library:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Default Package Directory</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXECUTE</span> <span class="n">sp_execute_external_script</span><br/>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>           <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>         <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'OutputDataSet &lt;- data.frame(.libPaths());'</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">(([</span><span class="n">DefaultLibraryName</span><span class="p">]</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">));</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>Retrieving Default Package Directory</em></p> <p>On my machine the directory is: <code>C:/Program Files/Microsoft SQL Server/MSSQL14.INST2K17CTP20/R_SERVICES/library</code>. So to install RStan:</p> <ol> <li>Open <code>RTerm.exe</code> as admin from the location for the SQL Server R Services instance (in my case: <code>C:\Program Files\Microsoft SQL Server\MSSQL14.INST2K17CTP20\R_SERVICES\bin\x64</code>).</li> <li>Execute the code in <em>Code Snippet 3</em> at command prompt.</li> </ol> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>title "Package Install"</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">pkg.dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"C:\Program Files\Microsoft SQL Server\MSSQL14.INST2K17CTP20\R_SERVICES\library"</span><span class="w"></span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">install.packages</span><span class="p">(</span><span class="s2">"rstan"</span><span class="p">,</span><span class="w"> </span><span class="n">repos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://cloud.r-project.org/"</span><span class="p">,</span><span class="w"> </span><span class="n">dependencies</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pkg.dir</span><span class="p">)</span><span class="w"></span></div></div></pre></div></figure></p> <p><strong>Code Snippet 3:</strong> <em>Installing RStan on SQL Server R Services</em></p> <p>When I ran the code in <em>Code Snippet 3</em> on my box it ran OK, but it did not install all the dependencies as the install for the standalone installation did. I then tested the installation like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Toolchain Test SQlServer R Services</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXECUTE</span> <span class="n">sp_execute_external_script</span><br/>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>           <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>         <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>              library("rstan")
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>              fx &lt;- inline::cxxfunction
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                ( signature(x = "integer", y = "numeric" ) ,
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>            </span><span class="se">''</span><span class="s1">return ScalarReal( INTEGER(x)[0] * REAL(y)[0] ) ;</span><span class="se">''</span><span class="s1">)
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>            res &lt;-fx(2L, 5)
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>            cat(paste0("Result: ", res))
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>            cat("</span><span class="se">\n</span><span class="s1">")'</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 4</strong> <em>Test of RStan Installation SQL Server R Services</em></p> <p>Initially, straight after installation, I received an error that <code>ggplot2</code> was missing. I resorted to copying all the packages from the package library for the standalone installation (<code>W:\Documents\R\win-library\3.3</code>) to the package library for the SQL Server R Services, and that sorted it the issue. When executing the code in <em>Code Snippet 4</em> a second time, all was OK:</p> <p><img class="center" src="/images/posts/prophet_rstan_sql_server.png" width="648" height="191" > <strong>Figure 4:</strong> <em>Result from SQl Server R Services</em></p> <blockquote><p><strong>NOTE:</strong> My assumption is that when installing RStan the second time, the installation saw that I had the dependent packages installed already. However for SQL Server R Services all packages need to be installed in the default package library directory. For now it all works though.</p></blockquote> <p>OK, now when we we have the various pre-requisites installed we can install Prophet.</p> <h2>Prophet Installation</h2> <p>Compared to the installation of RStan (and its dependencies), the installation of Prophet is really straight forward. Let us start installing Prophet on a standalone Microsoft R Server instance.</p> <h3>Install Prophet on Microsoft R Server</h3> <p>As you did with RStan you:</p> <ol> <li>Open <code>RTerm.exe</code> as admin from the location for the standalone instance (in my case: <code>C:\Program Files\Microsoft SQL Server\140\R_SERVER\bin\x64</code>).</li> <li>Set the package library where to install Prophet to: <code>lib.dir &lt;- "C:\\Program Files\\Microsoft SQL Server\\140\\R_SERVER\\library"</code></li> <li>Execute the actual installation: install.packages("prophet", lib = lib.dir, repos = "https://cloud.r-project.org/", dependencies = TRUE)</li> </ol> <blockquote><p><strong>NOTE:</strong> The reason why I explicitly state where to get the package from in the code above is that I had problems with the Prophet package installing from Microsoft's R repo.</p></blockquote> <p>The output from the code above will be something like so (heavily redacted):</p> <p><img class="center" src="/images/posts/prophet_install_standalone.png" width="650" height="184" > <strong>Figure 5:</strong> <em>Install Prophet Microsoft R Server</em></p> <p>Prophet should now be installed and ready to use. Further below we'll see some examples how to use it.</p> <h3>Install Prophet on SQL Server 2017 R Services</h3> <p>The install of Prophet on SQL Server R Services does not differ much from the install on a standalone server:</p> <ol> <li>Open <code>RTerm.exe</code> as admin from the location for the SQL Server R Services instance (in my case: <code>C:\Program Files\Microsoft SQL Server\MSSQL14.INST2K17CTP20\R_SERVICES\bin\x64</code>).</li> <li>Execute the code in <em>Code Snippet 5</em>.</li> </ol> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Prophet Install</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">lib</span><span class="p">.</span><span class="n">dir</span> <span class="o">&lt;-</span> <span class="nv">"C:</span><span class="se">\</span><span class="nv">Program Files</span><span class="se">\</span><span class="nv">Microsoft SQL Server</span><span class="se">\</span><span class="nv">MSSQL14.INST2K17CTP20</span><span class="se">\</span><span class="nv">R_SERVICES</span><span class="se">\</span><span class="nv">library"</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">install</span><span class="p">.</span><span class="n">packages</span><span class="p">(</span><span class="nv">"prophet"</span><span class="p">,</span> <span class="n">lib</span> <span class="o">=</span> <span class="n">lib</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">repos</span> <span class="o">=</span> <span class="nv">"https://cloud.r-project.org/"</span><span class="p">,</span> <span class="n">dependencies</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">)</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 5:</strong> <em>Installation of Prophet on SQL Server 2017 R Services</em></p> <p>The output from the execution is the same as you see in <em>Figure 5</em>.</p> <h2>Use Prophet</h2> <p>Now everything should be ready, and we should be able to use Prophet. To test it out I am "shamelessly" "borrowing" the examples from <a href="https://facebookincubator.github.io/prophet/docs/quick_start.html#r-api">here</a> (but I will just do the bare minimum to see that it works - no plotting etc.). The data I use is also the same; the log number of views to <a href="https://en.wikipedia.org/wiki/Peyton_Manning">Petyon Manningâ€™s Wikipedia page</a>. The <code>csv</code> file can be downloaded from <a href="https://github.com/facebookincubator/prophet/blob/master/examples/example_wp_peyton_manning.csv">here</a>.</p> <p>After you have downloaded the <code>csv</code> file you can see it has two columns: <code>ds</code> which are dates, and <code>y</code> which shows the number of views of his page. This is now the data we'll use to predict future hits of his page. We'll start with the standalone Microsoft R Server installation.</p> <h3>Test Code Microsoft R Server</h3> <p>For this test you can use any IDE you want, I'm using R Tools for Visual Studio 2017. So following the <a href="https://facebookincubator.github.io/prophet/docs/quick_start.html#r-api">example</a>, this is what the code will look like:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Test</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1"># load prophet</span><span class="w"></span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">library</span><span class="p">(</span><span class="n">prophet</span><span class="p">)</span><span class="w"></span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1"># load dplyr, needed for mutate()</span><span class="w"></span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1"># read in the csv data into a data frame</span><span class="w"></span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s1">'W:/nielsb-work/GitHub-Repos/prophet/
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>                  examples/example_wp_peyton_manning.csv'</span><span class="p">)</span><span class="w">
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1"># convert the y variable to a natural logarithm</span><span class="w"></span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mutate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="w">
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1"># create the model</span><span class="w"></span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">prophet</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1"># create a dataframe to fit a forecast into</span><span class="w"></span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">future</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">make_future_dataframe</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">periods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">365</span><span class="p">)</span><span class="w">
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1"># do the forecast</span><span class="w"></span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">forecast</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">future</span><span class="p">)</span><span class="w">
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1"># print out some data</span><span class="w"></span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">tail</span><span class="p">(</span><span class="n">forecast</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s1">'ds'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yhat'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yhat_lower'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yhat_upper'</span><span class="p">)])</span><span class="w"></span></div></div></pre></div></figure></p> <p><strong>Code Snippet 6:</strong> <em>Forecasting With Prophet</em></p> <p>If you want to know what the code does, look at the comments in the code block. You can also look at the <a href="https://facebookincubator.github.io/prophet/docs/quick_start.html#r-api">Prophet Quick Start page</a> mentioned above, there they explain it quite well.</p> <p>Below you see the output from running the code, from the point where <code>forecast &lt;- predict(m, future)</code> was called:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Result</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="o">&gt;</span><span class="w"> </span><span class="n">forecast</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">future</span><span class="p">)</span><span class="w"></span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="o">&gt;</span><span class="w"> </span><span class="n">tail</span><span class="p">(</span><span class="n">forecast</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s1">'ds'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yhat'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yhat_lower'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yhat_upper'</span><span class="p">)])</span><span class="w">
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>             </span><span class="n">ds</span><span class="w">     </span><span class="n">yhat</span><span class="w"> </span><span class="n">yhat_lower</span><span class="w"> </span><span class="n">yhat_upper</span><span class="w"></span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="m">3265</span><span class="w"> </span><span class="m">2017-01-14</span><span class="w"> </span><span class="m">7.832611</span><span class="w">   </span><span class="m">7.133318</span><span class="w">   </span><span class="m">8.577273</span><span class="w"></span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="m">3266</span><span class="w"> </span><span class="m">2017-01-15</span><span class="w"> </span><span class="m">8.214427</span><span class="w">   </span><span class="m">7.507750</span><span class="w">   </span><span class="m">8.924990</span><span class="w"></span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="m">3267</span><span class="w"> </span><span class="m">2017-01-16</span><span class="w"> </span><span class="m">8.539490</span><span class="w">   </span><span class="m">7.824840</span><span class="w">   </span><span class="m">9.325312</span><span class="w"></span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="m">3268</span><span class="w"> </span><span class="m">2017-01-17</span><span class="w"> </span><span class="m">8.326945</span><span class="w">   </span><span class="m">7.660892</span><span class="w">   </span><span class="m">9.099628</span><span class="w"></span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="m">3269</span><span class="w"> </span><span class="m">2017-01-18</span><span class="w"> </span><span class="m">8.159623</span><span class="w">   </span><span class="m">7.447501</span><span class="w">   </span><span class="m">8.897813</span><span class="w"></span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="m">3270</span><span class="w"> </span><span class="m">2017-01-19</span><span class="w"> </span><span class="m">8.171545</span><span class="w">   </span><span class="m">7.473959</span><span class="w">   </span><span class="m">8.911978</span><span class="w"></span></div></div></pre></div></figure></p> <p><strong>Code Snippet 7:</strong> <em>Result from Forecasting with Prophet</em></p> <p>The <code>forecast</code> object is a data frame with a column <code>yhat</code> containing the forecast. It has additional columns for uncertainty intervals and seasonal components.</p> <h3>Test Code SQL Server R Services</h3> <p>Having done the Microsoft R Server test, let us do the test against SQL Server R Services. I want upfront say that there is an issue with running this on SQL Server R Services, whereby dates returned in the model are shown incorrectly. At the moment I am not sure why this is the case - if someone reading this knows the reason, please let me know. I do believe it may be due to some incorrect package in the SQL Server R Services installation, but I am not sure.</p> <p>Anyway, let's just see what it would look like running more or less the same code as in <em>Code Snippet 6</em>, inside SQL Server R Services. Let's take the code in <em>Code Snippet 6</em>, and enable it to run in SQL Server. You do that by encapsulation the R code inside the <code>@script</code> parameter in <code>sp_execute_external_script</code>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Prophet in SQL Server</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXECUTE</span> <span class="n">sp_execute_external_script</span><br/>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                  <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                      # load prophet
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                      library(prophet)
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                      # load dplyr, needed for mutate()
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                      library(dplyr)
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>                      # read in the csv data into a data frame
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>                      df &lt;- read.csv("W:</span><span class="se">\</span><span class="s1">nielsb-work</span><span class="se">\</span><span class="s1">GitHub-Repos</span><span class="se">\</span><span class="s1">prophet</span><span class="se">\</span><span class="s1">examples</span><span class="se">\</span><span class="s1">example_wp_peyton_manning.csv")
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>                      # convert the y variable to a natural logarithm
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>                      df &lt;- mutate(df, y = log(y))
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>                      # create the model
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>                      m &lt;- prophet(df)
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>                      # create a dataframe to fit a forecast into
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>                      future &lt;- make_future_dataframe(m, periods = 365)
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>                      # do the forecast
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>                      forecast &lt;- predict(m, future)
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'>                      # output the result of the forecast
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'>                      OutputDataSet &lt;- data.frame(forecast[c("ds", "yhat", "yhat_lower", "yhat_upper")])'</span>
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">((</span><span class="n">ds</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">yhat</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">yhat_lower</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">yhat_upper</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span> <span class="p">);</span>
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div></pre></div></figure></p> <p><strong>Code Snippet 8:</strong> <em>Executing Prophet in SQL Server</em></p> <p>The only difference from what we see in <em>Code Snippet 6</em>, is that we output the result as a result set. When you execute the code you will get 3270 rows back: 2905 historical, and 365 predicted. However as I said above, there seems to be something not quite right when running it in SQL Server as the dates are completely wrong, and the values are also a bit off. In <em>Figure 6</em> below, you see the last 6 rows returned from SQL Server, compare that with the same in <em>Code Snippet 7</em>, and you will see some differences (apart from the dates).</p> <p><img class="center" src="/images/posts/prophet_result_sql_server.png" width="480" height="135" > <strong>Figure 6:</strong> <em>Result from SQL Server Execution</em></p> <p>Anyway, this post was more about if you can, and if so how, run Prophet in Microsoft R Server and SQL Server R Services, which we now see we can.</p> <h2>Summary</h2> <ul> <li>Prophet can be run in both Microsoft R Server as well as SQL Server R Services.</li> <li>Prophet requires R 3.2.3 or above, so a standard SQL Server 2016 R installation is not going to work.</li> <li>There seems to be an issue when executing Prophet inside SQL Server, as dates come out completely wrong, and values are somewhat off. I'll try and find out why this is the case.</li> </ul> <h2>~ Finally</h2> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/&text=Facebook Prophet and Microsoft R Server&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/05/20/facebook-prophet-and-microsoft-r-server/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/ &title=Facebook Prophet and Microsoft R Server &summary=Blog post: How to use Facebook Prophet in Microsoft R Server / SQL Server R Services &source=http://www.nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> <br/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad2 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="1158080725" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/"> Microsoft SQL Server R Services - Internals XI <small> (20 Oct 2017)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/"> Microsoft SQL Server R Services - Internals X <small> (29 Aug 2017)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/"> Microsoft SQL Server R Services - Internals IX <small> (18 Aug 2017)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
