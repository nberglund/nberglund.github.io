<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Facebook Prophet and Microsoft R Server &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Facebook Prophet and Microsoft R Server</h1>
  <div class="post-subheading">
  <span class="post-date">20 May 2017</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p><a href="https://en.wikipedia.org/wiki/Time_series">Time series</a> data is being used more and more in all industries, and of course we want to be able to forecast and predict future values. There are however a variety of challenges that come with producing a large number of forecasts across a variety of time series.</p>

<p>The <a href="https://research.fb.com/category/data-science/">Facebook’s data science team</a> has worked with time series forecasting for quite a while, and recently they open-sourced an internal tool for this type of forecasting: <a href="https://facebookincubator.github.io/prophet/">Facebook Prophet</a>.</p>

<p>Recently there was a post on the Microsoft R Server forum if it was possible to use Prophet with Microsoft R Server, so I thought I’d test it out. This post covers how to use it, both from a standalone Microsoft R Server as well as SQL Server R Services.</p>

<!--more-->

<blockquote>
  <p><strong>NOTE:</strong> Prophet requires an R version of 3.2.3 or greater. Unfortunately an installation of SQL Server 2016 R Services, in-database as well as standalone, uses R 3.2.2. So Prophet cannot be run on SQL Server R Services 2016, unless you upgrade the R version. In this post I am running SQL Server R Services 2017, both in-database and standalone.</p>
</blockquote>

<p>So, in essence Prophet is just an R packet and should be installed as such. However on Windows, Prophet requires a compiler, <a href="http://mc-stan.org/">Stan</a>, which incurs some extra steps when installing Prophet.</p>

<blockquote>
  <p><strong>NOTE:</strong> The description of Stan from <a href="https://en.wikipedia.org/wiki/Stan_(software)">Wikipedia:</a> <em>Stan is a probabilistic programming language for statistical inference written in C++. The Stan language is used to specify a (Bayesian) statistical model with an imperative program calculating the log probability density function.</em>. So there!</p>
</blockquote>

<h2 id="stan--dependencies">Stan &amp; Dependencies</h2>

<p>If you are on Windows, regardless if you want to use Prophet in a standalone version of Microsoft R Server or in SQL Server R Services, you need to install Stan, or rather the R version (RStan). There is also a Stan version for Python; PyStan. In addition to RStan there are some dependencies that need to be installed.</p>

<p>There is a very good article about how to install RStan on Windows <a href="https://github.com/stan-dev/rstan/wiki/Installing-RStan-on-Windows">here</a>, and below follows a very short summary of the article.</p>

<h3 id="rtools-installation">RTools Installation</h3>

<p>Before you can install RStan you need to install a tool-chain that works with R, and - for this - RTools is an excellent choice.</p>

<p>RTools can be downloaded form <a href="https://cran.r-project.org/bin/windows/Rtools/">here</a>, and you download the version that matches your Microsoft R Server’s / SQL Server R Services version. The table below is a map between various Microsoft R Servers and the corresponding R version. I have not included SQL Server 2016 R Services as the R version is not compatible with Prophet:</p>

<table>
  <thead>
    <tr>
      <th><strong>R Server</strong></th>
      <th><strong>R Version</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Microsoft R Server 8.x - 9.01</td>
      <td>3.3.2</td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td>Microsoft R Server 9.1</td>
      <td>3.3.3</td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td>SQL Server 2017 R Services</td>
      <td>3.3.3</td>
    </tr>
  </tbody>
</table>

<p>On the machine I test this on, I have the in-database as well as the standalone R Services from SQL Server 2017, so I downloaded the <code class="highlighter-rouge">Rtools34.exe</code>.</p>

<blockquote>
  <p><strong>NOTE:</strong> If you have installed the stand-alone version of Microsoft R that comes with SQL Server R Services, the version of R is the same as for SQL Server R Services.</p>
</blockquote>

<p>To install RTools double click the executable you just downloaded. What you need to ensure is that the <code class="highlighter-rouge">PATH</code> is set properly. So during the installation process, when it comes to the dialog <strong>Select Additional Tasks</strong> ensure that you check the check-box for <em>Edit the system PATH</em>:</p>

<p><img src="/images/posts/prophet_rtool_install.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Edit the System Path</em></p>

<p>After having checked the box for editing the PATH, just click through and let the install finish. After installation check that the PATH has been set. You do this by running <code class="highlighter-rouge">RTerm.exe</code> and executing <code class="highlighter-rouge">Sys.getenv('PATH')</code> from command prompt.</p>

<p>Dependent on if you want to run RTools on a standalone Microsoft Windows R Server installation or in-database, you find <code class="highlighter-rouge">RTerm.exe</code> at different locations. On my box the locations are:</p>

<ul>
  <li>Standalone Microsoft R Server: <code class="highlighter-rouge">C:\Program Files\Microsoft SQL Server\140\R_SERVER\bin\x64</code></li>
  <li>SQL Server R Services: <code class="highlighter-rouge">C:\Program Files\Microsoft SQL Server\MSSQL14.INST2K17CTP20\R_SERVICES\bin\x64</code></li>
</ul>

<p>After executing <code class="highlighter-rouge">Sys.getenv('PATH')</code>, you should see something like so:</p>

<p><img src="/images/posts/prophet_rtool_install_path.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>RTools Path</em></p>

<p>You can also check that <code class="highlighter-rouge">g++</code> (C++ compiler) can be called: <code class="highlighter-rouge">system('g++ -v')</code>. That should result in something like:</p>

<p><img src="/images/posts/prophet_rtool_install_g++.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>Checking for g++</em></p>

<h3 id="rstan-installation">RStan Installation</h3>

<p>OK, so after all the above is OK - we can finally install RStan. RStan is just another package, and it should be installed as any other package (like Prophet, which we will see in a bit). Whereas RTools is just installed to a shared directory on the box where R resides, RStan needs to be installed for each R instance specifically.</p>

<h4 id="standalone-microsoft-r-server">Standalone Microsoft R Server</h4>

<p>To install R packages you use the function <code class="highlighter-rouge">install.packages()</code>. For a standalone Microsoft R Server instance there is not much more you need to do, apart from saying where to install the package from and what to do about dependencies:</p>

<ol>
  <li>Open <code class="highlighter-rouge">RTerm.exe</code> as admin from the location for the standalone instance (in my case: <code class="highlighter-rouge">C:\Program Files\Microsoft SQL Server\140\R_SERVER\bin\x64</code>).</li>
  <li>Execute the following code: <code class="highlighter-rouge">install.packages("rstan", repos = "https://cloud.r-project.org/", dependencies=TRUE)</code></li>
  <li>This will run for a while, click yes for any questions during installation.</li>
</ol>

<p>When the installation has finished you can test that it has succeeded and that the tool chain works:</p>

<ol>
  <li>Close down the <code class="highlighter-rouge">RTerm.exe</code> terminal and re-open it (as admin).</li>
  <li>Execute the code in <em>Code Snippet 1</em> below.</li>
</ol>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create an inline function fx</span><span class="w">
</span><span class="n">fx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">inline</span><span class="o">::</span><span class="n">cxxfunction</span><span class="p">(</span><span class="w"> </span><span class="n">signature</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"numeric"</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="w"> 
            </span><span class="s1">'return ScalarReal( INTEGER(x)[0] * REAL(y)[0] ) ;'</span><span class="p">)</span><span class="w">

</span><span class="n">fx</span><span class="w"> </span><span class="p">(</span><span class="m">2L</span><span class="p">,</span><span class="m">5</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c1"># the result should be 10</span><span class="w">
</span></code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Test of RStan Installation</em></p>

<p>When executing the above, the result from <code class="highlighter-rouge">fx(2L,5)</code> should be 10.</p>

<h4 id="sql-server-r-services-installation">SQL Server R Services Installation</h4>

<p>The way to install a package in SQL Server R Services is similar to the standalone installation. However you cannot install a package to any directory, it has to be installed to the default package directory for the instance, as only only one package library is allowed.</p>

<p>The code in <em>Code Snippet 2</em> below shows how to retrieve the default package library:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXECUTE</span> <span class="n">sp_execute_external_script</span>  
           <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
         <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'OutputDataSet &lt;- data.frame(.libPaths());'</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">(([</span><span class="n">DefaultLibraryName</span><span class="p">]</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">));</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Retrieving Default Package Directory</em></p>

<p>On my machine the directory is: <code class="highlighter-rouge">C:/Program Files/Microsoft SQL Server/MSSQL14.INST2K17CTP20/R_SERVICES/library</code>. So to install RStan:</p>

<ol>
  <li>Open <code class="highlighter-rouge">RTerm.exe</code> as admin from the location for the SQL Server R Services instance (in my case: <code class="highlighter-rouge">C:\Program Files\Microsoft SQL Server\MSSQL14.INST2K17CTP20\R_SERVICES\bin\x64</code>).</li>
  <li>Execute the code in <em>Code Snippet 3</em> at command prompt.</li>
</ol>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pkg.dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"C:\Program Files\Microsoft SQL Server\MSSQL14.INST2K17CTP20\R_SERVICES\library"</span><span class="w">
</span><span class="n">install.packages</span><span class="p">(</span><span class="s2">"rstan"</span><span class="p">,</span><span class="w"> </span><span class="n">repos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://cloud.r-project.org/"</span><span class="p">,</span><span class="w"> </span><span class="n">dependencies</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pkg.dir</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Installing RStan on SQL Server R Services</em></p>

<p>When I ran the code in <em>Code Snippet 3</em> on my box it ran OK, but it did not install all the dependencies as the install for the standalone installation did. I then tested the installation like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXECUTE</span> <span class="n">sp_execute_external_script</span>  
           <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
         <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
              library("rstan")
              fx &lt;- inline::cxxfunction
                ( signature(x = "integer", y = "numeric" ) , 
            </span><span class="se">''</span><span class="s1">return ScalarReal( INTEGER(x)[0] * REAL(y)[0] ) ;</span><span class="se">''</span><span class="s1">)
            res &lt;-fx(2L, 5)
            cat(paste0("Result: ", res))
            cat("</span><span class="se">\n</span><span class="s1">")'</span>
</code></pre></div></div>
<p><strong>Code Snippet 4</strong> <em>Test of RStan Installation SQL Server R Services</em></p>

<p>Initially, straight after installation, I received an error that <code class="highlighter-rouge">ggplot2</code> was missing. I resorted to copying all the packages from the package library for the standalone installation (<code class="highlighter-rouge">W:\Documents\R\win-library\3.3</code>) to the package library for the SQL Server R Services, and that sorted it the issue. When executing the code in <em>Code Snippet 4</em> a second time, all was OK:</p>

<p><img src="/images/posts/prophet_rstan_sql_server.png" alt="" /></p>

<p><strong>Figure 4:</strong> <em>Result from SQl Server R Services</em></p>

<blockquote>
  <p><strong>NOTE:</strong> My assumption is that when installing RStan the second time, the installation saw that I had the dependent packages installed already. However for SQL Server R Services all packages need to be installed in the default package library directory. For now it all works though.</p>
</blockquote>

<p>OK, now when we we have the various pre-requisites installed we can install Prophet.</p>

<h2 id="prophet-installation">Prophet Installation</h2>

<p>Compared to the installation of RStan (and its dependencies), the installation of Prophet is really straight forward. Let us start installing Prophet on a standalone Microsoft R Server instance.</p>

<h3 id="install-prophet-on-microsoft-r-server">Install Prophet on Microsoft R Server</h3>

<p>As you did with RStan you:</p>

<ol>
  <li>Open <code class="highlighter-rouge">RTerm.exe</code> as admin from the location for the standalone instance (in my case: <code class="highlighter-rouge">C:\Program Files\Microsoft SQL Server\140\R_SERVER\bin\x64</code>).</li>
  <li>Set the package library where to install Prophet to: <code class="highlighter-rouge">lib.dir &lt;- "C:\\Program Files\\Microsoft SQL Server\\140\\R_SERVER\\library"</code></li>
  <li>Execute the actual installation: install.packages(“prophet”, lib = lib.dir, repos = “https://cloud.r-project.org/”, dependencies = TRUE)</li>
</ol>

<blockquote>
  <p><strong>NOTE:</strong> The reason why I explicitly state where to get the package from in the code above is that I had problems with the Prophet package installing from Microsoft’s R repo.</p>
</blockquote>

<p>The output from the code above will be something like so (heavily redacted):</p>

<p><img src="/images/posts/prophet_install_standalone.png" alt="" /></p>

<p><strong>Figure 5:</strong> <em>Install Prophet Microsoft R Server</em></p>

<p>Prophet should now be installed and ready to use. Further below we’ll see some examples how to use it.</p>

<h3 id="install-prophet-on-sql-server-2017-r-services">Install Prophet on SQL Server 2017 R Services</h3>

<p>The install of Prophet on SQL Server R Services does not differ much from the install on a standalone server:</p>

<ol>
  <li>Open <code class="highlighter-rouge">RTerm.exe</code> as admin from the location for the SQL Server R Services instance (in my case: <code class="highlighter-rouge">C:\Program Files\Microsoft SQL Server\MSSQL14.INST2K17CTP20\R_SERVICES\bin\x64</code>).</li>
  <li>Execute the code in <em>Code Snippet 5</em>.</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lib.dir &lt;- "C:\\Program Files\\Microsoft SQL Server\\MSSQL14.INST2K17CTP20\\R_SERVICES\\library"
install.packages("prophet", lib = lib.dir, repos = "https://cloud.r-project.org/", dependencies = TRUE)
</code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>Installation of Prophet on SQL Server 2017 R Services</em></p>

<p>The output from the execution is the same as you see in <em>Figure 5</em>.</p>

<h2 id="use-prophet">Use Prophet</h2>

<p>Now everything should be ready, and we should be able to use Prophet. To test it out I am “shamelessly” “borrowing” the examples from <a href="https://facebookincubator.github.io/prophet/docs/quick_start.html#r-api">here</a> (but I will just do the bare minimum to see that it works - no plotting etc.). The data I use is also the same; the log number of views to <a href="https://en.wikipedia.org/wiki/Peyton_Manning">Petyon Manning’s Wikipedia page</a>. The <code class="highlighter-rouge">csv</code> file can be downloaded from <a href="https://github.com/facebookincubator/prophet/blob/master/examples/example_wp_peyton_manning.csv">here</a>.</p>

<p>After you have downloaded the <code class="highlighter-rouge">csv</code> file you can see it has two columns: <code class="highlighter-rouge">ds</code> which are dates, and <code class="highlighter-rouge">y</code> which shows the number of views of his page. This is now the data we’ll use to predict future hits of his page. We’ll start with the standalone Microsoft R Server installation.</p>

<h3 id="test-code-microsoft-r-server">Test Code Microsoft R Server</h3>

<p>For this test you can use any IDE you want, I’m using R Tools for Visual Studio 2017. So following the <a href="https://facebookincubator.github.io/prophet/docs/quick_start.html#r-api">example</a>, this is what the code will look like:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load prophet</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">prophet</span><span class="p">)</span><span class="w">
</span><span class="c1"># load dplyr, needed for mutate()</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">

</span><span class="c1"># read in the csv data into a data frame</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s1">'W:/nielsb-work/GitHub-Repos/prophet/
                  examples/example_wp_peyton_manning.csv'</span><span class="p">)</span><span class="w">

</span><span class="c1"># convert the y variable to a natural logarithm</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mutate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="w">

</span><span class="c1"># create the model</span><span class="w">
</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">prophet</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">

</span><span class="c1"># create a dataframe to fit a forecast into</span><span class="w">
</span><span class="n">future</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">make_future_dataframe</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">periods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">365</span><span class="p">)</span><span class="w">

</span><span class="c1"># do the forecast</span><span class="w">
</span><span class="n">forecast</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">future</span><span class="p">)</span><span class="w">

</span><span class="c1"># print out some data</span><span class="w">
</span><span class="n">tail</span><span class="p">(</span><span class="n">forecast</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s1">'ds'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yhat'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yhat_lower'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yhat_upper'</span><span class="p">)])</span><span class="w">
</span></code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>Forecasting With Prophet</em></p>

<p>If you want to know what the code does, look at the comments in the code block. You can also look at the <a href="https://facebookincubator.github.io/prophet/docs/quick_start.html#r-api">Prophet Quick Start page</a> mentioned above, there they explain it quite well.</p>

<p>Below you see the output from running the code, from the point where <code class="highlighter-rouge">forecast &lt;- predict(m, future)</code> was called:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">forecast</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">future</span><span class="p">)</span><span class="w">
</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tail</span><span class="p">(</span><span class="n">forecast</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s1">'ds'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yhat'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yhat_lower'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yhat_upper'</span><span class="p">)])</span><span class="w">
             </span><span class="n">ds</span><span class="w">     </span><span class="n">yhat</span><span class="w"> </span><span class="n">yhat_lower</span><span class="w"> </span><span class="n">yhat_upper</span><span class="w">
</span><span class="m">3265</span><span class="w"> </span><span class="m">2017-01-14</span><span class="w"> </span><span class="m">7.832611</span><span class="w">   </span><span class="m">7.133318</span><span class="w">   </span><span class="m">8.577273</span><span class="w">
</span><span class="m">3266</span><span class="w"> </span><span class="m">2017-01-15</span><span class="w"> </span><span class="m">8.214427</span><span class="w">   </span><span class="m">7.507750</span><span class="w">   </span><span class="m">8.924990</span><span class="w">
</span><span class="m">3267</span><span class="w"> </span><span class="m">2017-01-16</span><span class="w"> </span><span class="m">8.539490</span><span class="w">   </span><span class="m">7.824840</span><span class="w">   </span><span class="m">9.325312</span><span class="w">
</span><span class="m">3268</span><span class="w"> </span><span class="m">2017-01-17</span><span class="w"> </span><span class="m">8.326945</span><span class="w">   </span><span class="m">7.660892</span><span class="w">   </span><span class="m">9.099628</span><span class="w">
</span><span class="m">3269</span><span class="w"> </span><span class="m">2017-01-18</span><span class="w"> </span><span class="m">8.159623</span><span class="w">   </span><span class="m">7.447501</span><span class="w">   </span><span class="m">8.897813</span><span class="w">
</span><span class="m">3270</span><span class="w"> </span><span class="m">2017-01-19</span><span class="w"> </span><span class="m">8.171545</span><span class="w">   </span><span class="m">7.473959</span><span class="w">   </span><span class="m">8.911978</span><span class="w">
</span></code></pre></div></div>
<p><strong>Code Snippet 7:</strong> <em>Result from Forecasting with Prophet</em></p>

<p>The <code class="highlighter-rouge">forecast</code> object is a data frame with a column <code class="highlighter-rouge">yhat</code> containing the forecast. It has additional columns for uncertainty intervals and seasonal components.</p>

<h3 id="test-code-sql-server-r-services">Test Code SQL Server R Services</h3>

<p>Having done the Microsoft R Server test, let us do the test against SQL Server R Services. I want upfront say that there is an issue with running this on SQL Server R Services, whereby dates returned in the model are shown incorrectly. At the moment I am not sure why this is the case - if someone reading this knows the reason, please let me know. I do believe it may be due to some incorrect package in the SQL Server R Services installation, but I am not sure.</p>

<p>Anyway, let’s just see what it would look like running more or less the same code as in <em>Code Snippet 6</em>, inside SQL Server R Services. Let’s take the code in <em>Code Snippet 6</em>, and enable it to run in SQL Server. You do that by encapsulation the R code inside the <code class="highlighter-rouge">@script</code> parameter in <code class="highlighter-rouge">sp_execute_external_script</code>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXECUTE</span> <span class="n">sp_execute_external_script</span>  
                    <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
                  <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
                      # load prophet
                      library(prophet)
                      # load dplyr, needed for mutate()
                      library(dplyr)

                      # read in the csv data into a data frame
                      df &lt;- read.csv("W:</span><span class="se">\\</span><span class="s1">nielsb-work</span><span class="se">\\</span><span class="s1">GitHub-Repos</span><span class="se">\\</span><span class="s1">prophet</span><span class="se">\\</span><span class="s1">examples</span><span class="se">\\</span><span class="s1">example_wp_peyton_manning.csv")

                      # convert the y variable to a natural logarithm
                      df &lt;- mutate(df, y = log(y))

                      # create the model
                      m &lt;- prophet(df)

                      # create a dataframe to fit a forecast into
                      future &lt;- make_future_dataframe(m, periods = 365)

                      # do the forecast
                      forecast &lt;- predict(m, future)

                      # output the result of the forecast
                      OutputDataSet &lt;- data.frame(forecast[c("ds", "yhat", "yhat_lower", "yhat_upper")])'</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">((</span><span class="n">ds</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">yhat</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">yhat_lower</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">yhat_upper</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span> <span class="p">);</span>

</code></pre></div></div>
<p><strong>Code Snippet 8:</strong> <em>Executing Prophet in SQL Server</em></p>

<p>The only difference from what we see in <em>Code Snippet 6</em>, is that we output the result as a result set. When you execute the code you will get 3270 rows back: 2905 historical, and 365 predicted. However as I said above, there seems to be something not quite right when running it in SQL Server as the dates are completely wrong, and the values are also a bit off. In <em>Figure 6</em> below, you see the last 6 rows returned from SQL Server, compare that with the same in <em>Code Snippet 7</em>, and you will see some differences (apart from the dates).</p>

<p><img src="/images/posts/prophet_result_sql_server.png" alt="" /></p>

<p><strong>Figure 6:</strong> <em>Result from SQL Server Execution</em></p>

<p>Anyway, this post was more about if you can, and if so how, run Prophet in Microsoft R Server and SQL Server R Services, which we now see we can.</p>

<h2 id="summary">Summary</h2>

<ul>
  <li>Prophet can be run in both Microsoft R Server as well as SQL Server R Services.</li>
  <li>Prophet requires R 3.2.3 or above, so a standard SQL Server 2016 R installation is not going to work.</li>
  <li>There seems to be an issue when executing Prophet inside SQL Server, as dates come out completely wrong, and values are somewhat off. I’ll try and find out why this is the case.</li>
</ul>

<h2 id="-finally">~ Finally</h2>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/&text=Facebook Prophet and Microsoft R Server&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/05/20/facebook-prophet-and-microsoft-r-server/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/
         &title=Facebook Prophet and Microsoft R Server
         &summary=Blog post: How to use Facebook Prophet in Microsoft R Server / SQL Server R Services
         &source=http://www.nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-2017">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server 2017</span>
    </a>
  
    
    <a href="/tags/#microsoft-r-server">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Microsoft R Server</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#r-tools-for-visual-studio">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R Tools for Visual Studio</span>
    </a>
  
    
    <a href="/tags/#facebook-prophet">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Facebook Prophet</span>
    </a>
  
    
    <a href="/tags/#rterm-exe">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">RTerm.exe</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2017/05/20/facebook-prophet-and-microsoft-r-server/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/12/interesting-stuff-week-32/">
            Interesting Stuff - Week 32
            <small>12 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
