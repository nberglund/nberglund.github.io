<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Microsoft SQL Server R Services - Internals V &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Microsoft SQL Server R Services - Internals V</h1>
  <div class="post-subheading">
  <span class="post-date">01 May 2017</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>This is the sixth post in a series about <strong>Microsoft SQL Server R Services</strong>, and the fifth post that drills down into the internal of how it works. To see other posts (including this) in the series, go to <a href="/series/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a>.</p>

<p>In <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a> and <a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Internals - IV</a>, we looked at how the launchpad service creates <strong>RTerm</strong> processes when we execute an external script.</p>

<p>The <a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Internals - IV</a> post came about due to an email from Bob Albright (<a href="https://twitter.com/bob_albright">@bob_albright</a>), pointing me to some resources (a blog-post) regarding the processes the launchpad service creates.</p>

<p>In his email Bob also, kindly enough, attached some code. The code highlighted some behavior when creating the RTerm processes, especially around parallelism. In this blog-post we’ll follow up on that and look into the effect parallelism has on process creation.</p>

<!--more-->

<h2 id="recap">Recap</h2>

<p>In <a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Internals - IV</a>, we saw how:</p>

<ul>
  <li>The launchpad service creates by default 6 RTerm processes when an external script is executed by a user. One of the processes will be used for the execution of the script and torn down afterwards. The other 5 is added to the process pool. In essence the launchpad service creates 5 + 1.</li>
  <li>If more (or less) processes than 5 is needed, a setting <code class="highlighter-rouge">PROCESS_POOL_SQLSATELLITE_GROWTH</code> can be set in <code class="highlighter-rouge">rlauncher.config</code>. The value of the setting defines number of processes to create (as with default it will be setting value + 1).</li>
  <li>When a user executes subsequent requests, or concurrent requests from different sessions, processes are picked up and used from the pool.
    <ul>
      <li>The launchpad service simultaneously creates a new process.</li>
    </ul>
  </li>
</ul>

<p>Previously I had the assumption that “somehow” the number of processes created had to be configurable, and that the reason for creating multiple processes has to do with performance.</p>

<p>In the post we verified that, and this was much due to the <a href="https://blogs.msdn.microsoft.com/microsoftrservertigerteam/2016/09/20/tips-sql-r-services-optimization-for-concurrent-execution-of-in-database-analytics-using-sp_execute_external_script/">blog-post</a> Bob pointed to in his - previously mentioned - email. That particular post also briefly mentioned <code class="highlighter-rouge">MAXDOP</code>, and what to think about in terms of pool size. That and Bob’s code lead to this blog-post.</p>

<h2 id="code">Code</h2>

<p>Before diving into the “stuff”, let’s look at the code we’ll use. The code we have used in previous posts has been very, very minimal. Today we’ll be “very advanced” and select data from a table in a database - talk about cutting edge!! What we want to do is to execute some linear regression functions against data, and see what happens in different scenarios.</p>

<p>In <em>Code Snippet 1</em> below, we set up the database and a table with some data we can use, all in all 30 million records:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="n">USE</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_30M</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_30M</span><span class="p">(</span><span class="n">RowID</span> <span class="n">bigint</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> <span class="n">y</span> <span class="n">int</span><span class="p">,</span> 
                          <span class="n">rand1</span> <span class="n">int</span><span class="p">,</span> <span class="n">rand2</span> <span class="n">int</span><span class="p">,</span> <span class="n">rand3</span> <span class="n">int</span><span class="p">,</span> <span class="n">rand4</span> <span class="n">int</span><span class="p">,</span> 
                          <span class="n">rand5</span> <span class="n">int</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_30M</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">rand3</span><span class="p">,</span> <span class="n">rand4</span><span class="p">,</span> <span class="n">rand5</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">30000000</span><span class="p">)</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span> 
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">20</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">25</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">50</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">100</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o1</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o2</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o3</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o4</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Setup of Database, Table and Data</em></p>

<p>The data is completely “useless”, but it can at least be used for analysis work, it looks something like so (just a few rows):</p>

<p>!{}(/images/posts/sql_r_services_random_data.png)</p>

<p><strong>Figure 1:</strong> <em>10 Rows Random Data</em></p>

<p>What we want to do with the data is to create a linear regression model over it, where - ultimately - we want to predict the value of <code class="highlighter-rouge">y</code>, and we believe <code class="highlighter-rouge">y</code> is related to <code class="highlighter-rouge">rand1</code>, <code class="highlighter-rouge">rand2</code>, <code class="highlighter-rouge">rand3</code>,  <code class="highlighter-rouge">rand4</code> and <code class="highlighter-rouge">rand5</code>. In our examples we are not really interested in <code class="highlighter-rouge">y</code>, but we want to see what the <strong>intercept</strong> value(s) is. If we used open source R (CRAN R), the code for this would look something like so:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">r</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">rand1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rand2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rand3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rand4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rand5</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=&lt;</span><span class="n">some</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">data</span><span class="o">&gt;</span><span class="p">);</span><span class="w">

</span><span class="c1"># get the coefficients</span><span class="w">
</span><span class="n">coef</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r</span><span class="o">$</span><span class="n">coefficients</span><span class="w">

</span><span class="c1"># the intercept value is first value in the coefficients vector</span><span class="w">
</span><span class="n">icept</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">coef</span><span class="p">[</span><span class="m">1</span><span class="p">];</span><span class="w">

</span><span class="c1"># return the data</span><span class="w">
</span><span class="n">out_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">intercept</span><span class="o">=</span><span class="n">icept</span><span class="p">);</span><span class="w">
</span></code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Linear Regression Using CRAN R</em></p>

<p>Seeing that this is about SQL Server R Services, we should be using the equivalent RevoScaleR function: <code class="highlighter-rouge">rxLinMod</code>: <code class="highlighter-rouge">r &lt;- rxLinMod(y ~ rand1 + rand2 + rand3 + rand4 + rand5, data=&lt;some input data&gt;);</code>, and we would execute it from <code class="highlighter-rouge">sp_execute_external_script</code>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="k">start</span> <span class="n">datetime2</span> <span class="o">=</span> <span class="n">SYSUTCDATETIME</span><span class="p">();</span>
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
          <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
        <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
             #Sys.sleep(30)
             pid &lt;- Sys.getpid()
             r &lt;- rxLinMod(y ~ rand1 + rand2 + rand3 + rand4 + rand5, 
                           data=InputDataSet)
 
             coef &lt;- r$coefficients
             icept &lt;- coef</span><span class="se">\[</span><span class="s1">1</span><span class="se">\]</span><span class="s1">;
              OutputDataSet &lt;- data.frame(pid=pid, nRows=r$nValidObs, 
                                          intercept=icept)'</span>
       <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
              SELECT  y, rand1, rand2, rand3, 
                      rand4, rand5 
              FROM dbo.rand_30M'</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">((</span><span class="n">pid</span> <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">nRows</span> <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">intercept</span> <span class="n">FLOAT</span> <span class="k">NULL</span><span class="p">)</span>
<span class="p">);</span> 
<span class="k">SELECT</span> <span class="n">DATEDIFF</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="o">@</span><span class="k">start</span><span class="p">,</span> <span class="n">SYSUTCDATETIME</span><span class="p">())</span> <span class="k">AS</span> <span class="n">ElapsedTime</span><span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Linear Regression in SQL Server</em></p>

<p>So the code in <em>Code Snippet 3</em> is what we will “play” around with in this post. Some comments:</p>

<ul>
  <li>First line of the script (the <code class="highlighter-rouge">@script</code> parameter) is commented out; <code class="highlighter-rouge">Sys.sleep(30)</code>. We’ll use it at one stage to be able to look a little bit closer at what is happening.</li>
  <li>As we did in <a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Internals - IV</a> we grab the process id of the RTerm process the code executes under.</li>
  <li>In the <code class="highlighter-rouge">OutputDataSet</code> variable we output a data-frame consisting of the process id, how many rows we processed and the intercept value.</li>
  <li>The output data is being presented as a result set, by the <code class="highlighter-rouge">WITH RESULT SETS ...</code> statement.</li>
  <li>Oh, and for “giggles” we check how long the execution takes (first line and last line).</li>
</ul>

<p>In addition to the code above, we’ll also use <a href="https://technet.microsoft.com/en-us/sysinternals/processexplorer.aspx"><strong>Process Explorer</strong></a>, to see how many processes are created as well as memory consumption etc. If you have read <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a> and <a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Internals - IV</a>, you should be comfortable with <em>Process Explorer</em>.</p>

<h2 id="parallel-execution">Parallel Execution</h2>

<p>So the blog-post is about what impact parallel processing will have on the process creation, but before we go down that “rabbit” hole, let’s see what it looks like during non-parallel execution:</p>

<ul>
  <li>Restart the launchpad service (this is to clean-up any RTerm processes).</li>
  <li>Navigate to the <code class="highlighter-rouge">Launchpad.exe</code> process in <em>Process Explorer</em>.</li>
  <li>Execute the code in <em>Code Snippet 2</em>.</li>
  <li>While the code is executing, look in <em>Process Explorer</em> for RTerm processes.</li>
</ul>

<p>In <em>Process Explorer</em> you should see something similar to this:</p>

<p>!{}(/images/posts/sql_r_services_lin_reg1.png)</p>

<p><strong>Figure 1:</strong> <em>Processes from Code Execution</em></p>

<p>What you see in <em>Figure 1</em> matches pretty good with what we discussed in <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a> and <a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Internals - IV</a>; while a single user executes <code class="highlighter-rouge">sp_execute_external_script</code> 6 RTerm processes are alive, and one of the processes is the process where the script executes under. In this case it was process id 10120, and we determined that from the CPU value (.32) as well as Private Bytes: 1,023,376 K and Working Set 189,268 K respectively.  We can further confirm the process the code executed under by looking at the result coming back:</p>

<p><img src="/images/posts/sql_r_services_lin_reg1_result.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>Result from Code Execution</em></p>

<p>From <em>Figure 2</em> we can indeed see that the process id was 10120, and that we ran the regression model over 30 million rows. The time it took to execute the code was ~16 seconds. The query plan looks like in <em>Figure 3</em>:</p>

<p><img src="/images/posts/sql_r_services_lin_reg1_result_udx.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>Actual Query Plan</em></p>

<p>In <em>Figure 3</em> we see how we do clustered index scan for our rows and then hand it over to the UDX operator. The UDX operator comes normally in play when we do XML related processes, but - as we can see - it also comes into the picture for external scripts. It kind of makes sense as it is an <strong>Extended Operator</strong>.</p>

<p>This is all well and good, but it is not really anything new from what we discussed in <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a> and <a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">IV</a>.</p>

<p>So what about parallel execution? When you read documentation about <strong>SQL Server R Services</strong> it always mentions how efficient it is to execute external scripts as one can utilize SQL’s parallelism. How does this work then? In “normal” SQL Server parallelism, SQL Server decides whether to execute a statement in parallel or not, and the <code class="highlighter-rouge">MAXDOP</code> setting defines the number of processors the statement will execute on.</p>

<p>For <strong>SQL Server R Services</strong> it works in a similar way, except that you have to explicitly say that you want to execute in parallel. To specify parallel execution you use a parameter on the <code class="highlighter-rouge">sp_execute_external_script</code> procedure: <code class="highlighter-rouge">@parallel</code>. The parameter can either be either 0, no parallelism which is default, or 1.</p>

<blockquote>
  <p><strong>NOTE:</strong> Even if you specify that you want to execute in parallel, SQL may choose not to do it.</p>
</blockquote>

<p>So in order to enable parallelism, we need to add the parameter to the stored procedure, and in <em>Code Snippet 4</em> below we have inserted the parameter right after <code class="highlighter-rouge">@input_data1</code> parameter:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- preceding code not shown</span>
<span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
              SELECT  y, rand1, rand2, rand3, 
                      rand4, rand5 
              FROM dbo.rand_30M'</span>
<span class="p">,</span> <span class="o">@</span><span class="n">parallel</span><span class="o">=</span><span class="mi">1</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">((</span><span class="n">pid</span> <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">nRows</span> <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">intercept</span> <span class="n">FLOAT</span> <span class="k">NULL</span><span class="p">)</span>
<span class="p">);</span> 
<span class="k">SELECT</span> <span class="n">DATEDIFF</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="o">@</span><span class="k">start</span><span class="p">,</span> <span class="n">SYSUTCDATETIME</span><span class="p">())</span> <span class="k">AS</span> <span class="n">ElapsedTime</span><span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 4:</strong> <em>Using the @parallel Parameter</em></p>

<p>So let’s see what impact the change we did in <em>Code Snippet 4</em> has. For now we will not look at the RTerm processes, so you can just execute the code with the <code class="highlighter-rouge">@parallel = 1</code> parameter set. On my machine which is a 4 core machine with hyper threading (i.e. 8 processors) and <code class="highlighter-rouge">MAXDOP</code> is set to 0 (use all processors), I get the following result when I execute:</p>

<p><img src="/images/posts/sql_r_services_lin_reg2_result.png" alt="" /></p>

<p><strong>Figure 4:</strong> <em>Result from Parallel Execution</em></p>

<p>In <em>Figure 4</em> we see how the results are returned from 8 RTerm process id’s. This is to be expected when SQL uses parallelism and <code class="highlighter-rouge">MAXDOP</code> is 0. Oh, and BTW - according to people “in the know” you should not have <code class="highlighter-rouge">MAXDOP</code> set to 0 if you run on an HT box. <a href="https://www.mssqltips.com/sqlservertip/2650/what-maxdop-setting-should-be-used-for-sql-server/">Here</a> is an article about <code class="highlighter-rouge">MAXDOP</code> settings.</p>

<p>We also see from <em>Figure 4</em> that we executed in ~8.7 seconds, roughly half the time it took when we didn’t use parallelism.</p>

<blockquote>
  <p><strong>NOTE:</strong> There is no guarantee that you will improve performance by using parallelism, so it is a good idea to always test against the workloads you are using.</p>
</blockquote>

<p>The query plan from the execution also shows parallelism:</p>

<p><img src="/images/posts/sql_r_services_lin_reg2_qp.png" alt="" /></p>

<p><strong>Figure 5:</strong> <em>Query Plan With Parallelism</em></p>

<p>The interesting part with the query plan, as Bob pointed out to me, is that the UDX operator gets pushed <strong>before</strong> the <em>Parallelism</em> operator.</p>

<p>Let us now get back to what we started this with; how parallelism affects process creation. From what we have seen above, we can be fairly certain that 8 processes have been created, but let’s make sure that it really happens:</p>

<ul>
  <li>Un-comment the line in the R script saying <code class="highlighter-rouge">Sys.sleep(30)</code>. We’ll use this pause to be able to closer see what happens.</li>
  <li>Restart the launchpad service.</li>
  <li>Navigate to the <code class="highlighter-rouge">Launchpad.exe</code> process in <em>Process Explorer</em>.</li>
  <li>Execute the code.</li>
  <li>While the code executes look closely at the RTerm processes under the launchpad process in <em>Process Explorer</em>.</li>
</ul>

<p>On my box the RTerm processes looks like so:</p>

<p><img src="/images/posts/sql_r_services_lin_reg2_processes.png" alt="" /></p>

<p><strong>Figure 6:</strong> RTerm Processes and Parallelism*</p>

<p>From <em>Figure 6</em> we can see how there are 8 executing processes (the outlined rows), and 16 processes altogether. So when executing in parallel, the launchpad service creates two processes for each task, where one of the two processes are used for execution of the R code, and the other is being added to the process pool. The processes that are being used to executed on, are torn down after execution - and left are the ones in the process pool.</p>

<p>However if the level of parallelism (tasks) are less than the number of processes to be created, (5 by default or the value of <code class="highlighter-rouge">PROCESS_POOL_SQLSATELLITE_GROWTH</code>), then the launchpad service creates as many process as required so that there always is the required number of processes in the pool.</p>

<p>An example of this is if <code class="highlighter-rouge">PROCESS_POOL_SQLSATELLITE_GROWTH</code> has not been set, and we are working with 5 as default; if the level of parallelism is 4, then 9 processes will be created - 4 for execution, and 5 for the pool.</p>

<p>So why would the level of parallelism be less than the required number of processes? Well, we may execute on a box with few processors, maybe not so likely, or <code class="highlighter-rouge">MAXDOP</code> is set (see below).</p>

<h3 id="cran-r-functions">CRAN R Functions</h3>

<p>So far we have used RevoScaleR functions in our script code, what happens if we want to use a CRAN R function instead. Something similar to what is in <em>Code Snippet 2</em>? That works fine as well, multiple RTerm processes will process the data. I will not show the code here, but you can easily try it our yourselves.</p>

<h2 id="max-degree-of-parallelism-maxdop">Max Degree of Parallelism (MAXDOP)</h2>

<p>So <code class="highlighter-rouge">MAXDOP</code> is a way to indicate to SQL Server how many processors to execute a piece of code on. Or rather, it is a way to limit SQL Server from running a statement over all processors on the box. As this post is not about <code class="highlighter-rouge">MAXDOP</code> as such, I won’t go into details about it, but if you want to know more <a href="https://blogs.msdn.microsoft.com/arali/2009/11/25/sql-server-max-degree-of-parallelism-maxdop/">here is an MSDN article</a> covering <code class="highlighter-rouge">MAXDOP</code>. Anyway, <code class="highlighter-rouge">MAXDOP</code> is set on SQL Server instance level, but can also be used as query hint on individual queries.</p>

<p>Setting <code class="highlighter-rouge">MAXDOP</code> for individual statements also work for the statement used in the <code class="highlighter-rouge">@input_data_1</code> parameter on the <code class="highlighter-rouge">sp_execute_external_script</code> procedure. So in our code example was can change the <code class="highlighter-rouge">@input_data_1</code> parameter to look like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
              SELECT  y, rand1, rand2, rand3, 
                      rand4, rand5 
              FROM dbo.rand_30M OPTION(MAXDOP 4)'</span>
</code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>Using MAXDOP in SELECT</em></p>

<p>The code in <em>Code Snippet 5</em> will now restrict the parallelism to use 4 processors, and results coming back will show 4 different process id’s, and - as I mentioned above - during execution there will be 9 RTerm processes created, and when the execution has finished 5 will be in the process pool.</p>

<h2 id="some-unclear-points">Some Unclear Points</h2>

<p>All this seems pretty straight forward, however what is unclear for me is how the interaction between SQL Server and the launchpad service works when executing with parallelism. On the SQL Server side we can see how multiple tasks and workers are invoked when parallelism is in play by executing something like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">spid</span> <span class="n">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">spid_from_script_execute</span><span class="o">&gt;</span>
<span class="k">SELECT</span> <span class="n">t</span><span class="p">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">scheduler_id</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">task_address</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">worker_address</span> 
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_os_tasks</span> <span class="n">t</span>
<span class="k">WHERE</span> <span class="n">t</span><span class="p">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="o">@</span><span class="n">spid</span><span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>Viewing Tasks and Workers When Executing</em></p>

<p>To see this:</p>

<ol>
  <li>Open a second query window and copy the code from <em>Code Snippet 6</em> into that window.</li>
  <li>Replace the <code class="highlighter-rouge">&lt;spid_from_script_execute&gt;</code> with the session id (<code class="highlighter-rouge">@@SPID</code>) from where you execute <code class="highlighter-rouge">sp_execute_external_script</code>.</li>
  <li>Highlight the <em>Code Snippet 6</em> code in the query window.</li>
  <li>Execute the <code class="highlighter-rouge">sp_execute_external_script</code> code, where <code class="highlighter-rouge">@parallel</code> is set to 1.</li>
  <li>Quickly change over to the other query window and execute the code.</li>
</ol>

<p>The result from the query window where you execute the code from <em>Code Snippet 6</em> looks something like what you see in <em>Figure 7</em>:</p>

<p><img src="/images/posts/sql_r_services_lin_reg2_tasks.png" alt="" /></p>

<p><strong>Figure 7:</strong> Tasks, Workers and Schedulers*</p>

<p>Ok, we see multiple schedulers, tasks and workers being active when we execute our code, and there is nothing strange in that. Seeing that, I would then have expected that there would be a one-to-one relationship between the tasks and the calls into the launchpad service, but that is not the case.</p>

<p>I verified that by “firing up” my trusted debugger <strong>WinDbg</strong> and attached it to the launchpad process, similar to what we did in <a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Internals - II</a>. I then set a breakpoint at <code class="highlighter-rouge">launchpad!CLaunchContext::LaunchServTask</code>, and executed the code. My expectation was that I would see how the breakpoint was hit multiple times when I executed with parallelism.</p>

<p>That did not happen, the breakpoint was hit once, and that was it. That leaves me with the question how SQL Server interacts with the launchpad service when executing with parallelism. My guess is that when SQL Server calls into the launchpad service, (which we discussed at length in <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I</a> and <a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">II</a>), it tells the launchpad service that this call requires parallelism, and the level of it. But as I said, this is just a guess. Maybe someone out there can clarify what goes on.</p>

<h2 id="summary">Summary</h2>

<p>In this post I wanted to look at how parallelism affects the creation of RTerm processes in <strong>SQL Server R Services</strong>. The conclusion is that it does:</p>

<ul>
  <li>When executing with no parallelism, the launchpad service creates 6 processes by default (can be altered by <code class="highlighter-rouge">PROCESS_POOL_SQLSATELLITE_GROWTH</code>), and the code runs on one, the others are added to the process pool. When the code has finished executing, the executing process is torn down.</li>
  <li>When executing under parallelism the launchpad service creates two processes per degree of parallelism. One of the two processes are used to execute on, the other is added to the pool.
    <ul>
      <li>If the level of parallelism is lower than default number of process to be created (or <code class="highlighter-rouge">PROCESS_POOL_SQLSATELLITE_GROWTH</code>) then the launchpad service creates enough processes to satisfy the required level.</li>
    </ul>
  </li>
  <li>Parallelism works with CRAN R functions as well as RevoScaleR.</li>
  <li>The <code class="highlighter-rouge">MAXDOP</code> setting has impact on the parallelism.</li>
</ul>

<p>So that’s for now! Thanks once again to <a href="https://twitter.com/bob_albright">Bob</a> for his input and code!! And as I mentioned above, if anyone has input how SQL Server interacts with the launchpad service, when parallelism is in play - I’d be more than happy to hear about it.</p>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/05/01/microsoft-sql-server-r-services-internals-v/&text=Microsoft SQL Server R Services - Internals V&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/05/01/microsoft-sql-server-r-services-internals-v/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2017/05/01/microsoft-sql-server-r-services-internals-v/
         &title=Microsoft SQL Server R Services - Internals V
         &summary=Blog post: More about the launchpad service and RTerm processes in relation to parallelism in SQL Server R Services.
         &source=http://www.nielsberglund.com/2017/05/01/microsoft-sql-server-r-services-internals-v/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/05/01/microsoft-sql-server-r-services-internals-v/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-machine-learning-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Machine Learning Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#windbg">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WinDbg</span>
    </a>
  
    
    <a href="/tags/#launchpad">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Launchpad</span>
    </a>
  
    
    <a href="/tags/#rterm-exe">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">RTerm.exe</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2017/05/01/microsoft-sql-server-r-services-internals-v/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2017/05/01/microsoft-sql-server-r-services-internals-v/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/07/29/interesting-stuff-week-30/">
            Interesting Stuff - Week 30
            <small>29 Jul 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
