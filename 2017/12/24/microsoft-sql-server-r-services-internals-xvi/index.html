<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Microsoft SQL Server R Services - Internals XVI &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Microsoft SQL Server R Services - Internals XVI</h1>
  <div class="post-subheading">
  <span class="post-date">24 Dec 2017</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>This is the 17:th post in a series about <strong>Microsoft SQL Server R Services</strong>, and the 16:th post that drills down into the internal of how it works. To see other posts (including this) in the series, go to <a href="/series/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a>.</p>

<p>In the last few posts in this <em>Internals</em> series we have looked at how data is being transported from SQL Server to the SqlSatellite. In this post we’ll look at how data is going the other way, from the SqlSatellite to SQL Server.</p>

<!--more-->

<p>Before drilling down into the topic of today, let’s do a recap of some of the posts that have led up to where we are right now.</p>

<h2 id="recap">Recap</h2>

<p>In <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> we saw how both the external script as well as data from <code class="highlighter-rouge">@input_data_1</code> was sent over a TCP/IP connection to the SqlSatellite from SQL Server, and <a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">Internals - XI</a> looked at some of the authentication packets sent from SQL Server to the SqlSatellite.</p>

<p><a href="/2017/10/31/microsoft-sql-server-r-services-internals-xii/">Internals - XII</a> looked at from where the script and data packets are sent (what routines), and we determined that the script packet was sent while the <code class="highlighter-rouge">sqllang!CSatelliteProxy::PostSetupMessage</code> routine was called, and the data packet(s) was sent during the <code class="highlighter-rouge">sqllang!CSatelliteCargoContext::SendPackets</code> routine. In <a href="/2017/10/31/microsoft-sql-server-r-services-internals-xii/">XII</a> we also explained the two packets with a length of 28 we see in <em>Figure 1</em> (being sent after the two data packets), as end packets. These packets tell SqlSatellite that no more data is coming. We illustrated the internal SQL Server flow like this:</p>

<p><img src="/images/posts/sql_r_services_12_calls.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Flow in SQL Server</em></p>

<p>I was unclear of when the statement in <code class="highlighter-rouge">@input_data_1</code> was being executed, and [Internals - XIII] had a look at that and the conclusion we came to was:</p>

<ul>
  <li>Before the SqlSatellite is initialized the statement is compiled.</li>
  <li>After the satellite has been initialized the statement is executed.</li>
  <li>If an error happens after the satellite has been initialized, SQL Server sends an abort message to the satellite in the <code class="highlighter-rouge">sqllang!CSQLSatelliteCommunication::SendAbort</code> routine.</li>
</ul>

<p>Then, after “many a false starts”, I started talking about the <strong>Binary eXchange Language</strong> (<strong>BXL</strong>) protocol in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>. BXL is a protocol optimized for fast data transfers between SQL Server and external script engines and it moves data in column oriented fashion, and utilizes schema information to optimize how to send the data.</p>

<p>When looking at the data sent, the size of the packages and “drilling” into the TCP packets we could deduct that: :</p>

<ul>
  <li>Each column has an over-head of 32 bytes (at least for non nullable data)</li>
  <li>The size of the column in one row is the size of the data type for numeric types.</li>
  <li>For <code class="highlighter-rouge">decimal</code> and <code class="highlighter-rouge">numeric</code> an extra byte is added to each column, where this byte indicates the precision.</li>
  <li>Columns of alpha numeric type all had 2 bytes pre-pended to the bytes, except <code class="highlighter-rouge">max</code> types.</li>
  <li>For <code class="highlighter-rouge">char</code> and <code class="highlighter-rouge">nchar</code> the storage size was 2 bytes plus the size the column was defined as.</li>
  <li>For <code class="highlighter-rouge">varchar</code> and <code class="highlighter-rouge">nvarchar</code> the storage size was 2 bytes plus the size of the data stored.</li>
  <li>For the <code class="highlighter-rouge">varmax</code> data types the number of bytes that were pre-pended varied dependent on the data size.</li>
</ul>

<p>What happens with nullable columns is a mystery, as we saw column overheads ranging from 7312 bytes (<code class="highlighter-rouge">tinyint</code>) to 32 bytes (<code class="highlighter-rouge">decimal</code>), and I can’t help but think that there is a “bug” in there somewhere that causes this.</p>

<blockquote>
  <p><strong>NOTE:</strong> This nullable “issue” will raise it’s head in this post as well.</p>
</blockquote>

<p>So, in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a> we saw the packet sizes (over-heads etc.) for various data types, and in <a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Internals - XV</a> we looked at the packet sizes going over the wire. We compared it with TDS and saw how TDS sends multiple smaller packages where max size is by default the network package size (4536 bytes). BXL, on the other hand, tries to send as big packages as possible, where big in this instance is up to 65536 bytes. BXL creates a new package when the size of rows and columns has reached 65536.</p>

<p>We also looked at the code in SQL Server that is being executed when sending the data, and we realized that the <code class="highlighter-rouge">sqlmin!CQScanUdx::PushNextChildRow</code> routine was where everything happened (or in sub routines). We were aware of that routine from <a href="/2017/10/31/microsoft-sql-server-r-services-internals-xii/">Internals - XII</a>, where we looked at what sent the TCP packets to the SqlSatallite. We saw how <code class="highlighter-rouge">PushNextChildRow</code> calls <code class="highlighter-rouge">PushRow</code>, which in turns call <code class="highlighter-rouge">PostOneRow</code>. Dependent on if it is the first row, <code class="highlighter-rouge">PostOneRow</code> calls <code class="highlighter-rouge">WritePayloadHeader</code>followed by <code class="highlighter-rouge">WriteData</code>. If it is not the first row <code class="highlighter-rouge">PostOneRow</code> calls <code class="highlighter-rouge">WriteData</code> only. If the packet has reached the size of 65536 and there are more packets, <code class="highlighter-rouge">WriteMessageBlockDone</code> is called. If it is the last packet, <code class="highlighter-rouge">PushEOS</code> is called and <code class="highlighter-rouge">PushEOS</code> calls <code class="highlighter-rouge">WriteMessageBlockDone</code>. The figure below illustrates the flow:</p>

<p><img src="/images/posts/sql_r_services_15_bxl_code.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>BXL Code Flow</em></p>

<p>What we have recapped above should help us in this post.</p>

<h2 id="housekeeping">Housekeeping</h2>

<p>Housekeeping in this context is talking about the tools we’ll use, as well as the code. This section is here here for those of who want to follow along in what we’re doing in the posts.</p>

<h4 id="helper-tools">Helper Tools</h4>

<p>To help us figure out the things we want, we will use <em>Process Monitor</em>, and <em>WireShark</em>:</p>

<ul>
  <li><em>Process Monitor</em>, will be used it to filter TCP traffic. If you want to refresh your memory about how to do it, we covered that in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> as well as in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>.</li>
  <li>I’ll use <em>WireShark</em> for network packet sniffing. In previous posts I have used <em>Microsoft Message Analyzer</em> for this, but I am now back to <em>WireShark</em> as I find it gives me more readable output. If you want a refresher about <em>WireShark</em>, we covered the setup etc., in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a>.</li>
</ul>

<h4 id="code">Code</h4>

<p>The code below sets up the database and creates some tables with some data. it is more or less the same as we used in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">ResultData</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">ResultData</span><span class="p">;</span>
<span class="k">GO</span>

<span class="n">USE</span> <span class="n">ResultData</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span><span class="p">(</span><span class="n">RowID</span> <span class="n">bigint</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> 
                          <span class="n">y</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand1</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
              <span class="n">rand2</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand3</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> 
              <span class="n">rand4</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand5</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">);</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">test1</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">test1</span>
<span class="p">(</span>
  <span class="n">RowID</span> <span class="n">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> <span class="n">colint1</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">colint2</span> <span class="n">int</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">colint3</span> <span class="n">int</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">colvchar1</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">colvchar2</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NULL</span> 
<span class="p">);</span>
<span class="k">GO</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">test1</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">),</span>
       <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">);</span>
   
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">rand3</span><span class="p">,</span> <span class="n">rand4</span><span class="p">,</span> <span class="n">rand5</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span> 
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">20</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">25</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">50</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">100</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o1</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o2</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o3</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o4</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Database, and Database Object Creation</em></p>

<p>When you look at the database and the objects in <em>Code Snippet 1</em>, you’ll see it is more or less the same as we used in <a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Internals - XV</a>. The code you will execute is also very similar to what we did in <a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Internals - XV</a>, and the “base” code looks like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'OutputDataSet&lt;-InputDataSet'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT TOP(1) rand1 FROM dbo.rand_1M'</span>
</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Base Code to Execute</em></p>

<p>The major difference between the Code in <em>Code Snippet 2</em> and the code in <a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Internals - XV</a>, is that in the R script, we are “echoing” the incoming data from <code class="highlighter-rouge">@input_date_1</code>, to be the output as well: <code class="highlighter-rouge">OutputDataSet&lt;-InputDataSet</code>. Let’s see this in action.</p>

<h2 id="output-data-from-r">Output Data from R</h2>

<p>We’ll start with testing that everything works, as well as seeing the port SQL Server listens on for communication with the SqlSatellite. To get the port we’ll use <em>Process Monitor</em>, and look at the <code class="highlighter-rouge">Path</code> column for the port.</p>

<blockquote>
  <p><strong>NOTE:</strong> We need the path later on to set display filters in <em>WireShark</em>.</p>
</blockquote>

<p>So this is what we’ll do:</p>

<ul>
  <li>Run <em>Process Monitor</em> as admin.</li>
  <li>Set a filer to capture <code class="highlighter-rouge">TCP Receive</code> in the process <code class="highlighter-rouge">BxlServer.exe</code>.</li>
  <li>Execute the code in <em>Code Snippet 2</em>.</li>
</ul>

<p>After you executed the statement you should see in <em>Process Monitor</em> the - by now - familiar data packets being sent. Amongst them there is a packet with a length of 36 bytes, and - as we know - this is the packet with the actual data.</p>

<blockquote>
  <p><strong>NOTE:</strong> When you see the output from <em>Process Monitor</em>, don’t forget to see (and remember) what the port number on the SQL Server side is, you get it from the <code class="highlighter-rouge">Path</code> column.</p>
</blockquote>

<p>As the script now says <code class="highlighter-rouge">OutputDataSet&lt;-InputDataSet</code>, whatever we send to the SqlSatllite is “echoed” back and sure enough, in <em>SSMS</em> we should see something like so:</p>

<p><img src="/images/posts/sql_r_services_16_echo1.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>Output Dataset</em></p>

<p>The reason why we in <em>Figure 3</em>, don’t see a column name is because we have not told SQL Server what it is supposed to be (we’ll cover that in a future post).</p>

<p>As everything seems to be in order, let’s look at what is being sent back to SQL Server. To do this we first of all need a new filter in <em>Process Monitor</em>, where we can see packets sent from <code class="highlighter-rouge">BxlServer.exe</code> in addition to the packets that are sent to it. The easiest way to accomplish this is just to add a new operation: <code class="highlighter-rouge">TCP Send</code> to the existing filter:</p>

<p><img src="/images/posts/sql_r_services_16_send_receive_filter.png" alt="" /></p>

<p><strong>Figure 4:</strong> <em>Send and Receive Filter</em></p>

<p>In <em>Figure 4</em> you see what the filer should look like, and it may be a good idea to save this filter for future use. As we are interested in what is being sent back to SQL Server after SQL has sent the data, let’s change the code in <em>Code Snippet 2</em> slightly, and introduce a <code class="highlighter-rouge">Sys.sleep</code>. That will allow us to more easily see when (and what) data comes back:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(20)
                             OutputDataSet&lt;-InputDataSet'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT TOP(1) rand1 FROM dbo.rand_1M'</span>
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Code with Sleep</em></p>

<p>When you execute the code in <em>Code Snippet 3</em>, <em>Process Monitor</em> will output something like so (followed by a pause):</p>

<p><img src="/images/posts/sql_r_services_16_send_receive1.png" alt="" /></p>

<p><strong>Figure 5:</strong> <em>Sending and Receiving - I</em></p>

<p><em>Figure 5</em> shows the data being sent from SQL Server and received by SQL Server, and we see how:</p>

<ul>
  <li>SqlSatellite receives the script is (length 252), followed by</li>
  <li>the actual data (length 36 - as was discussed in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>), followed by</li>
  <li>the two “end” packages (length 28).</li>
</ul>

<p>Then, the highlighted data in <em>Figure 5</em>, SqlSatellite sends a packet with a length of 28. This packet is an ack packet, and is for this discussion not interesting. At this stage, the code is now pausing. After ~20 seconds <em>Process Monitor</em> outputs the “rest” (outlined in blue):</p>

<p><img src="/images/posts/sql_r_services_16_send_receive2.png" alt="" /></p>

<p><strong>Figure 6:</strong> <em>Sending and Receiving - II</em></p>

<p>The really interesting part of <em>Figure 6</em> is what is outlined in red; two packets with a length of 51, and 2051 respectively. Why do I say they are interesting? Well, change the <code class="highlighter-rouge">@input_data_1</code> parameter to be <code class="highlighter-rouge">SELECT TOP(1) rand1, rand2 FROM dbo.rand_1M</code> and execute. This results in two packets with lengths of 69 and 4074, which indicates that these packets have something to do with the data being returned from the SqlSatellite.</p>

<p>So, let’s see if we can prove that these two are related to the data being sent back from the SqlSatellite. Oh, and there are also some questions related to these packets:</p>

<ul>
  <li>Why two packets, when we are sending only one data packet?</li>
  <li>Which packet contains the data?</li>
  <li>Why is one of the packets so big?</li>
</ul>

<p>What we will do in order to try to figure out this is to execute the code in <em>Code Snippet 3</em> with different  <code class="highlighter-rouge">@input_data_1</code> statements. The statements will return different number of columns and rows, and from seeing the sizes coming out of that we may be able to deduct how things work. The statements we’ll execute are these:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- one row, one column</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">rand1</span> <span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span>

<span class="c1">-- two rows, one column</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">rand1</span> <span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span>

<span class="c1">-- one row, two columns</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span> <span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span>

<span class="c1">-- two rows, two columns</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span> <span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span>

<span class="c1">-- one row, three columns</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span> <span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span>
</code></pre></div></div>
<p><strong>Code Snippet 4:</strong> <em>Different @input_data_1 Statements</em></p>

<p>After executing the code with the statements in <em>Code Snippet 4</em> we see following sizes (R stands for row, C for column):</p>

<table>
  <thead>
    <tr>
      <th>Packet</th>
      <th style="text-align: center">1R, 1C</th>
      <th style="text-align: center">2R, 1C</th>
      <th style="text-align: center">1R, 2C</th>
      <th style="text-align: center">2R, 2C</th>
      <th style="text-align: center">1R, 3C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>small pkt.</td>
      <td style="text-align: center">51</td>
      <td style="text-align: center">51</td>
      <td style="text-align: center">69</td>
      <td style="text-align: center">69</td>
      <td style="text-align: center">87</td>
    </tr>
    <tr>
      <td>large pkt.</td>
      <td style="text-align: center">2051</td>
      <td style="text-align: center">2055</td>
      <td style="text-align: center">4074</td>
      <td style="text-align: center">4082</td>
      <td style="text-align: center">6097</td>
    </tr>
  </tbody>
</table>

<p><strong>Table 1:</strong> <em>Packet Sizes</em></p>

<p>From what we see in <em>Table 1</em> we can say that the “small” packet probably does not contain any data, seeing that when comparing the size for one column, one row with two rows one column, it has the same size (51 bytes). However, it definitely looks like the number of columns has an impact: 1 column 51 bytes, 2 columns 69 bytes, and finally three columns 87 bytes, which also tells us that each column adds 18 bytes to the size. So, it look like the “small” packet has something to do with the columns coming back. We’ll leave this packet for now and come back to it in next post.</p>

<p>The “big packet” definitely looks like it has something to do with the data coming back: one row, one column has a size of 2051, and two rows one column 2055. That’s 4 bytes more, the same size as an <code class="highlighter-rouge">int</code>. But, once again why such a big packet, this is like what we saw  in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals XIV</a> when data is sent to the SqlSatellite originating from nullable columns?</p>

<p>That is the answer, when returning numeric data from the SqlSatellite, the data is treated as it would originate from nullable columns. Character based data has the same behavior as when sending data to the SqlSatelllite - so not the big overhead when coming from nullable columns. There are though some differences between character data sent to SqlSatellite and character data coming back, and I’ll point out some of it below.</p>

<p>So, numeric data sent back from the SqlSatellite looks almost like nullable numeric data sent to the SqlSatellite. One difference though is the size for the first column; if you look in <em>Table 1</em> you see the size for one row, one column be 2051. When we look in <em>Table 2</em> in [Internals - XIV], the size for an <code class="highlighter-rouge">int</code> is 2023, so it seems there is a 28 bytes extra somewhere. Incidentally, 2023 is the difference between returning one row, one column and one row two columns. So it looks like that the 28 bytes overhead only occurs once.</p>

<p>Perhaps we can figure out what happens by doing some <em>WireShark</em> “sniffing”. If you look at the table <code class="highlighter-rouge">dbo.test1</code> you see it has two nullable <code class="highlighter-rouge">int</code> columns: <code class="highlighter-rouge">colint2</code> and <code class="highlighter-rouge">colint3</code>, and it is these two columns we’ll use when trying to figure out what happens. Before we involve <em>WireShark</em>, we’ll:</p>

<ul>
  <li>Change the <code class="highlighter-rouge">@input_data_1</code> parameter to be: <code class="highlighter-rouge">SELECT TOP(1) colint2 FROM dbo.test1</code>.</li>
  <li>Execute and check the packet sizes in <em>Process Monitor</em>.</li>
  <li>Check the port number in the <code class="highlighter-rouge">Path</code> column in <em>Process Monitor</em>.</li>
</ul>

<p>In the output from <em>Process Monitor</em> we should now see one packet being sent to the SqlSatellite with a length of 2023, and a packet being sent to the SQL Server with a length of 2051. The assumption we’re making is that those packets are identical, except for the 28 bytes overhead. Now it’s time for <em>WireShark</em>:</p>

<ul>
  <li>Run <em>WireShark</em> as admin.</li>
  <li>Choose the network adapter to “sniff” on. See <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> for discussion around loop-back adapters etc.</li>
  <li>Set a display filter on the port SQL Server listens on. In this case we want to sniff outgoing as well as incoming packets, so the filter should be: <code class="highlighter-rouge">tcp.port==xyz</code>.</li>
  <li>Apply the filter.</li>
</ul>

<p>After you execute the code what you’ll see in <em>WireShark</em> is quite a few packets being sent from and to the SQL Server port:</p>

<p><img src="/images/posts/sql_r_services_16_wireshark_packets1.png" alt="" /></p>

<p><strong>Figure 7:</strong> <em>WireShark Packets</em></p>

<blockquote>
  <p><strong>NOTE:</strong> When packets are sent over the network they are sent in chunks. <em>WireShark</em> captures each chunk individually, whereas <em>Process Monitor</em> shows the full package. That’s why you see multiple packages in <em>WireShark</em>, but only one in <em>Process Monitor</em>.</p>
</blockquote>

<p>In <em>Figure 7</em> we see - outlined in blue - two packets with a size of 1460 and 563. That’s the data packet sent to SQL Server, reported in <em>Process Monitor</em> as one packet with a length of 2023. Outlined in red we see the two packets containing the actual data going back to SQL Server from the SqlSatellite, with lengths of 1460 and 591 (2051 total). Let’s now compare the packet sent to the SqlSatallite with what is coming back, and we’ll start with the first 64 bytes of the two packets:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//packet sent to SqlSatellite</span>
<span class="mo">01</span> <span class="mo">00</span> <span class="mo">07</span> <span class="mi">80</span> <span class="n">e7</span> <span class="mo">07</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">04</span> <span class="n">c1</span> <span class="mi">82</span> <span class="mo">01</span> <span class="mi">79</span> <span class="mi">63</span> <span class="n">a7</span> <span class="mi">48</span>   <span class="p">........</span> <span class="p">....</span><span class="n">yc</span><span class="p">.</span><span class="n">H</span>
<span class="n">a0</span> <span class="n">c8</span> <span class="n">c0</span> <span class="n">ab</span> <span class="n">d8</span> <span class="n">cb</span> <span class="mi">27</span> <span class="mi">61</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">07</span> <span class="mi">3</span><span class="n">e</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">......</span><span class="err">'</span><span class="n">a</span> <span class="p">...</span><span class="o">&gt;</span><span class="p">....</span>
<span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">........</span> <span class="p">........</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">........</span> <span class="p">........</span>

<span class="c1">//packet received from SqlSatellite</span>
<span class="mo">01</span> <span class="mo">00</span> <span class="mo">07</span> <span class="mi">80</span> <span class="n">e7</span> <span class="mo">07</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">04</span> <span class="n">c1</span> <span class="mi">82</span> <span class="mo">01</span> <span class="mi">79</span> <span class="mi">63</span> <span class="n">a7</span> <span class="mi">48</span>   <span class="p">........</span> <span class="p">....</span><span class="n">yc</span><span class="p">.</span><span class="n">H</span>
<span class="n">a0</span> <span class="n">c8</span> <span class="n">c0</span> <span class="n">ab</span> <span class="n">d8</span> <span class="n">cb</span> <span class="mi">27</span> <span class="mi">61</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">07</span> <span class="mi">3</span><span class="n">e</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">......</span><span class="err">'</span><span class="n">a</span> <span class="p">...</span><span class="o">&gt;</span><span class="p">....</span>
<span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">........</span> <span class="p">........</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">........</span> <span class="p">........</span>
</code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>Packets Sent to and Received from SqlSatellite</em></p>

<p>Remember how we in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a> said that the BXL protocol has a column overhead of 32 bytes, but that we don’t really know what it contains. In <em>Code Snippet 5</em>, we see the first 32 bytes of the two packets are exactly the same, e.g. a column header - so it is probably safe to say that the BXL protocol is used also when returning data from the SqlSatellite. The remainder of the two packets looks also identical - up until the end:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//packet sent to SqlSatellite</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">........</span> <span class="p">........</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">02</span>   <span class="p">........</span> <span class="p">........</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>

<span class="c1">//packet received from SqlSatellite</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">........</span> <span class="p">........</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">02</span>   <span class="p">........</span> <span class="p">........</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">06</span> <span class="mi">80</span> <span class="mi">1</span><span class="n">c</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="n">c1</span> <span class="mi">82</span> <span class="mo">01</span> <span class="mi">79</span>   <span class="p">........</span> <span class="p">.......</span><span class="n">y</span>
<span class="mi">63</span> <span class="n">a7</span> <span class="mi">48</span> <span class="n">a0</span> <span class="n">c8</span> <span class="n">c0</span> <span class="n">ab</span> <span class="n">d8</span>  <span class="n">cb</span> <span class="mi">27</span> <span class="mi">61</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>      <span class="n">c</span><span class="p">.</span><span class="n">H</span><span class="p">.....</span> <span class="p">.</span><span class="err">'</span><span class="n">a</span><span class="p">....</span>
</code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>End Part of Packets</em></p>

<p>When looking at <em>Code Snippet 6</em> we see that the last 4 bytes of the first packet represents the value of the column: 2 which in hex is <code class="highlighter-rouge">02 00 00 00</code>. But looking at the packet coming back from the SqlSatellite we see that there are more data after the value. In fact - when we look at it, it turns out to be 28 bytes. Those 28 bytes look very much the same as the starting bytes, but not totally identical. If we change the statement for <code class="highlighter-rouge">@input_data_1</code> to be: <code class="highlighter-rouge">SELECT TOP(1) colint2, colint3 FROM dbo.test1</code> and execute, we’ll see how the 28 bytes extra appears at the end of the packet, almost like a separate row. Thinking back to the TDS discussion in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>, this feels like an end sequence, and we’ll revisit this in next post.</p>

<p>So out of the three question was asked above (why two packets, etc.) we have answered two - or rather we assume that the first packet is there for something column related, and we have seen how the second packet contains the actual data. The third question then, why is the packet containing the data so big? The answer to that (as far as I can tell) is that the data originating in the R engine, is always considered being nullable. Then the “bug”/feature that we spoke about in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a> raises its head, whereby “nullable” data gets a quite big overhead.</p>

<h4 id="numeric-types">Numeric Types</h4>

<p>Let’s look at numeric types and see what it gives us in terms of overhead. In the case of an int, coming back from SqlSatelite - the actual overhead is 1987 bytes excluding any data, end sequence, column overhead, etc. (1987, plus 4 bytes for the value, plus 32 bytes for the column, plus 28 bytes for the “end-sequence” gives us 2051). So do we then have the same behavior for all nullable numeric data types that we saw in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>:</p>

<table>
  <thead>
    <tr>
      <th>Data Type</th>
      <th style="text-align: center">1 Row</th>
      <th style="text-align: center">2 Rows</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>tinyint</td>
      <td style="text-align: center">7313</td>
      <td style="text-align: center">7314</td>
      <td>-</td>
    </tr>
    <tr>
      <td>smallint</td>
      <td style="text-align: center">3889</td>
      <td style="text-align: center">3891</td>
      <td>-</td>
    </tr>
    <tr>
      <td>int</td>
      <td style="text-align: center">2023</td>
      <td style="text-align: center">2027</td>
      <td>-</td>
    </tr>
    <tr>
      <td>real</td>
      <td style="text-align: center">2023</td>
      <td style="text-align: center">2027</td>
      <td>-</td>
    </tr>
    <tr>
      <td>float</td>
      <td style="text-align: center">2023 | 1050</td>
      <td style="text-align: center">2027 | 1058</td>
      <td>Based on storage size 4 or 8 bytes</td>
    </tr>
    <tr>
      <td>bigint</td>
      <td style="text-align: center">1050</td>
      <td style="text-align: center">1058</td>
      <td> </td>
    </tr>
    <tr>
      <td>money</td>
      <td style="text-align: center">1050</td>
      <td style="text-align: center">1058</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p><strong>Table 2:</strong> <em>Nullable Packet Sizes to SqlSatellite</em></p>

<p>In <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a> we saw the table above, and it listed the data sizes of packets sent to the SqlSatellite from SQL Server, where the data originates from nullable columns (the sizes above include the data size, and the 32 bytes column header). When looking at data coming back from the SqlSatellite you’d think that you’d see the sames sizes (plus the 28 bytes end-sequence), but that is not the case:</p>

<table>
  <thead>
    <tr>
      <th>Data Type</th>
      <th style="text-align: center">1 Row</th>
      <th style="text-align: center">2 Rows</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>tinyint</td>
      <td style="text-align: center">2051</td>
      <td style="text-align: center">2055</td>
      <td>-</td>
    </tr>
    <tr>
      <td>smallint</td>
      <td style="text-align: center">2051</td>
      <td style="text-align: center">2055</td>
      <td>-</td>
    </tr>
    <tr>
      <td>int</td>
      <td style="text-align: center">2051</td>
      <td style="text-align: center">2055</td>
      <td>-</td>
    </tr>
    <tr>
      <td>real</td>
      <td style="text-align: center">1078</td>
      <td style="text-align: center">1086</td>
      <td>-</td>
    </tr>
    <tr>
      <td>float</td>
      <td style="text-align: center">1078</td>
      <td style="text-align: center">1086</td>
      <td>No difference related to storage size</td>
    </tr>
    <tr>
      <td>bigint</td>
      <td style="text-align: center">1078</td>
      <td style="text-align: center">1086</td>
      <td> </td>
    </tr>
    <tr>
      <td>money</td>
      <td style="text-align: center">1078</td>
      <td style="text-align: center">1086</td>
      <td> </td>
    </tr>
    <tr>
      <td>decimal</td>
      <td style="text-align: center">1078</td>
      <td style="text-align: center">1086</td>
      <td>No difference related to storage size</td>
    </tr>
  </tbody>
</table>

<p><strong>Table 3:</strong> <em>Packet Sizes from SqlSatellite</em></p>

<p>Notice in <em>Table 3</em>, how - when data comes back from SqlSatellite - there are only two packet sizes (2051, 1078) regardless of data type. In addition we see <code class="highlighter-rouge">decimal</code> in the table, whereas when sending to SqlSatellite, there were no overhead for nullable <code class="highlighter-rouge">decimal</code>. The reason for only two sizes coming back is that whereas 
SQL Server supports quite a few data types, R has a limited number of scalar data types. So, whenever you use data from SQL Server in R scripts, the data might be implicitly converted to a compatible data type.</p>

<p>What is interesting in the paragraph above, or rather what the paragraph above implies; is that when data goes to the SqlSatellite - somewhere in the packet it contains type information, and that is most likely in the 32 bytes column “header”. Also interesting is that if you send the value 1 as an int, and the value 1 as a <code class="highlighter-rouge">bigint</code> you get different packet sizes returning - event though they are treated as nullable.</p>

<h4 id="alpha-numeric">Alpha Numeric</h4>

<p>What about alpha-numeric data types? Alpha numeric data has actually the same behavior when coming back from SqlSatellite as it does when sending data to SqlSatellite. With that I mean that nullable column data has no impact - no extra overhead is added to the data coming back. There are however some differences; remember what we said in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>, and also in the <em>Recap</em> above, about sending alpha numeric to SqlSatellite:</p>

<ul>
  <li>There is the “usual” 32 bytes column overhead.</li>
  <li>Columns of alpha numeric type all have 2 bytes pre-pended to the bytes, except <code class="highlighter-rouge">max</code> types.</li>
  <li>For <code class="highlighter-rouge">varchar</code> and <code class="highlighter-rouge">nvarchar</code> the storage size was 2 bytes (the 2 bytes mentioned above) plus the size of the data stored (single byte <code class="highlighter-rouge">varchar</code>, double byte <code class="highlighter-rouge">nvarchar</code>).</li>
</ul>

<blockquote>
  <p><strong>NOTE:</strong> I am not covering <code class="highlighter-rouge">max</code> types here, as I do not think there will be that many instances of <code class="highlighter-rouge">max</code> types being returned to SQL Server from SqlSatellite.</p>
</blockquote>

<p>When alpha numeric data comes back from the SqlSatellite however</p>

<ul>
  <li>There is the “usual” 32 bytes column overhead as before, plus the 28 bytes end-sequence.</li>
  <li>Instead of 2 bytes pre-pended, each column has 4 bytes pre-pended.</li>
  <li>The data coming back is always in double-byte format, so one character comes back as 2 bytes.</li>
</ul>

<p>An example of this is, in the table <code class="highlighter-rouge">dbo.Test1</code> there is a column <code class="highlighter-rouge">colvchar1</code>, and the first row has the value of <code class="highlighter-rouge">A</code>, the second a value of <code class="highlighter-rouge">B</code>. When executing the code in <em>Code Snippet 2</em> with the <code class="highlighter-rouge">@input_data_1</code> statement being: <code class="highlighter-rouge">SELECT TOP(1) colvchar1 FROM dbo.Test1</code>, the sizes are:</p>

<ul>
  <li>Going to SqlSatellite: 35 bytes (32 bytes column header + 2 bytes per column + 1 byte for the value).</li>
  <li>Back from SqlSatellite: 66 bytes (32 bytes column header + 28 bytes end sequence + 4 bytes per column + 2 bytes for the value).</li>
</ul>

<p>When selecting <code class="highlighter-rouge">TOP(2)</code> the sizes are:</p>

<ul>
  <li>Going to SqlSatellite: 38 bytes (35 from 1 row + 2 bytes per column + 1 byte for the value).</li>
  <li>Back from SqlSatellite: 72 bytes (66 bytes from one row + 4 bytes per column + 2 bytes for the value).</li>
</ul>

<h2 id="summary">Summary</h2>

<p>In this post we looked at data being returned from the SqlSatellite to SQL Server. We saw how there were actually two packets coming back, one small and one bigger, we deduced that those packets were:</p>

<ul>
  <li>The smaller packet had something to do with column meta-data.</li>
  <li>The bigger packet held the actual data.</li>
</ul>

<p>For numeric data types coming back:</p>

<ul>
  <li>The data was treated as originating from nullable columns (with a large overhead).</li>
  <li>The data packet contained a 28 bytes end sequence.</li>
</ul>

<p>Due to R not supporting all data types that SQL Server supports, the data was casted to compatible R types.</p>

<p>In next post we’ll look at the code involved in SQL Server as well as the launchpad service, when data comes back. Doing that we’ll also hope to be able to understand more about the smaller packet coming back, as well as the end sequence.</p>

<h2 id="-finally">~ Finally</h2>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/12/24/microsoft-sql-server-r-services-internals-xvi/&text=Microsoft SQL Server R Services - Internals XVI&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/12/24/microsoft-sql-server-r-services-internals-xvi/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2017/12/24/microsoft-sql-server-r-services-internals-xvi/
         &title=Microsoft SQL Server R Services - Internals XVI
         &summary=Blog post: Binary eXchange Language format,data coming back to SQL Server from SqlSatellite
         &source=http://www.nielsberglund.com/2017/12/24/microsoft-sql-server-r-services-internals-xvi/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/12/24/microsoft-sql-server-r-services-internals-xvi/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-machine-learning-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Machine Learning Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#windbg">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WinDbg</span>
    </a>
  
    
    <a href="/tags/#launchpad">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Launchpad</span>
    </a>
  
    
    <a href="/tags/#rterm-exe">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">RTerm.exe</span>
    </a>
  
    
    <a href="/tags/#binary-exchange-language">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Binary eXchange Language</span>
    </a>
  
    
    <a href="/tags/#bxl">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">BXL</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2017/12/24/microsoft-sql-server-r-services-internals-xvi/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2017/12/24/microsoft-sql-server-r-services-internals-xvi/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/12/interesting-stuff-week-32/">
            Interesting Stuff - Week 32
            <small>12 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
