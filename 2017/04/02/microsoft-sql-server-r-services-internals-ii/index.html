<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Microsoft SQL Server R Services - Internals II &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Microsoft SQL Server R Services - Internals II</h1>
  <div class="post-subheading">
  <span class="post-date">02 Apr 2017</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>This is the third post in a series about <strong>Microsoft SQL Server R Services</strong>, and the second post that drills down into the internal of how it works. To see other posts (including this) in the series, go to <a href="/series/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a>.</p>

<p>In the <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">previous internals post</a> we looked at what happens inside the SQL Server engine when  we execute <code class="highlighter-rouge">sp_execute_external_script</code>. In that post we wrapped up when we reached the launchpad service (<em>Launchpad.exe</em>). This post will look closer at the launchpad service, and we will do it by some more “spelunking”</p>

<!--more-->

<h2 id="recap">Recap</h2>

<p>In both previous posts about SQL Server R Services I have mentioned that the launchpad service is responsible for launching an external runtime when we execute <code class="highlighter-rouge">sp_execute_external_script</code>. In the <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals I</a> post the following picture showed what happened inside the SQL server engine when executing the procedure:</p>

<p><img src="/images/posts/sql-launchpad_post.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Call Flow Executing sp_execute_external_script</em></p>

<p>From <em>Figure 1</em> we see how an named pipe connection is opened from the SQL Server engine into the launchpad service, and eventually the routine <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code> writes a message to the service. The message will at one stage or another cause the <code class="highlighter-rouge">launchpad!CLaunchContext::Launch</code> routine in the launchpad service to be called. In a little while we’ll see how we came to that conclusion.</p>

<h2 id="launchpad">Launchpad</h2>

<p>Launchpad is a new service installed together with SQL Server 2016, and it is there to support execution of scripts targeting external runtimes/engines. The launchpad service calls into launchers, and it is the launcher’s job to launch the correct runtime/engine. How does the launchpad service know what launcher dll to call into? To answer that, cast your mind back to the previous post about <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">internals</a>, in that post we looked at the procedure used to execute external scripts: <code class="highlighter-rouge">sp_execute_external_script</code>, and we executed some code like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span> 
                    <span class="o">@</span><span class="k">language</span> <span class="o">=</span><span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
                    <span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s1">'OutputDataSet&lt;-InputDataSet'</span><span class="p">,</span>
                    <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span><span class="n">N</span><span class="s1">'SELECT 42'</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">(([</span><span class="n">TheAnswer</span><span class="p">]</span> <span class="n">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">));</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Execute sp_execute_external_script</em></p>

<p>Looking at the code in <em>Code Snippet 1</em> we see the first parameter being the <code class="highlighter-rouge">@language</code> parameter, and it is this parameter that tells the launchpad service to use (in this case) the launcher for R.</p>

<h3 id="launchers">Launchers</h3>

<p>The question still remains though; how does the launchpad service know what specific launcher dll to use? To answer that let us look a little bit more closely at the launchpad service, in the properties dialog:</p>

<p><img src="/images/posts/sql-launchpad_service.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>SQL Server Launchpad Service</em></p>

<p>If we look at the <em>Path to executable</em> setting under the <em>General</em> as in <em>Figure 2</em> tab we may get some more insight:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"C:\&lt;path_to_SQL_instance\&gt;\MSSQL\Binn\launchpad.exe" 
 -launcher RLauncher.dll 
 -pipename sqlsatellitelaunch
 -timeout 600000 
 -logPath "C:\&lt;path_to_SQL_instance&gt;\MSSQL\LOG\ExtensibilityLog" 
 -workingDir "C:\&lt;path_to_SQL_instance&gt;\MSSQL\ExtensibilityData" 
 -satelliteDllPath "C:\&lt;path_to_SQL_instance&gt;\MSSQL\Binn\sqlsatellite.dll"  
</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Path to Executable for Launchpad.exe</em></p>

<p>After having copied the value in <em>Path to executable</em> we see is shown in <em>Code Snippet 2</em>. And in there we can see a command line argument <code class="highlighter-rouge">-launcher</code> with a value of <em>RLauncher.dll</em>. If we search for a file named <em>RLauncher.dll</em> we find it in the <em>Binn</em> directory together with all other SQL Server files:</p>

<p><img src="/images/posts/sql_r_services_rlauncher.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>RLauncher</em></p>

<p>So, a theory is that during startup, the launchpad service reads in the value of the -launcher argument, and perhaps even loads the dll. Is there any way we can prove that theory? We can try:</p>

<ol>
  <li>Go to <em>Services</em> and stop the launchpad service</li>
  <li>Delete all files from the directory the <code class="highlighter-rouge">-logPath</code> parameter points to.</li>
  <li>Start the launchpad service.</li>
</ol>

<p>You should now see a couple of new files in the log directory, and when you open them you can see how there are log messages about <em>RLauncher.dll</em>. If you have <em>Process Explorer</em> installed you can also verify that <em>RLauncher.dll</em> is loaded by finding the launchpad service process and then look at dll’s as in <em>Figure 4</em> below:</p>

<p><img src="/images/posts/sql_r_services_launchpad_rlauncher.png" alt="" /></p>

<p><strong>Figure 4:</strong> <em>RLauncher Loaded</em></p>

<p>Before we start “spelunking” with WinDbg, let’s look at the arguments used by the launchpad service (as seen in <em>Code Snippet 2</em>) and see what they mean:</p>

<ul>
  <li><code class="highlighter-rouge">-launcher</code>: Full path to the launcher.</li>
  <li><code class="highlighter-rouge">-logPath</code>: The launchpad’s base log path.</li>
  <li><code class="highlighter-rouge">-satelliteDllPath</code>: The sql satellite dll path for the satellites, we’ll talk more about them in subsequent posts.</li>
  <li><code class="highlighter-rouge">-workingDir</code>: The launchpad and satellite process base working directory.</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td><code class="highlighter-rouge">-cleanupLog</code>: Whether to cleanup the log directory after every execution [0</td>
          <td>1] (not set above).</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td><code class="highlighter-rouge">-cleanupWorkingDir</code>: Whether to cleanup the working directory after every execution [0</td>
          <td>1] (not set above).</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li><code class="highlighter-rouge">-pipeName</code>: Define the launchpad’s name pipe’s name - this is from connection from SQL Server.</li>
  <li><code class="highlighter-rouge">-timeout</code>: Define the default timeout in ms.</li>
  <li><code class="highlighter-rouge">-SqlInstanceName</code>: Define the SqlInstanceName as in MSSQLSERVER or blank for default or an instance name (not set above).</li>
</ul>

<p>Some of the arguments (most in fact) I found in what I copied from the properties dialog for the service and the field <em>Path to executable</em> mentioned above. However a couple of the arguments were found by, from command prompt, trying to run the launchpad executable like so: <code class="highlighter-rouge">C:\&lt;path_to_sql_server_instance&gt;\MSSQL\Binn&gt;launchpad.exe</code> without any arguments. That resulted in an error and some help how to run the launchpad service.</p>

<p>What was interesting in that, was that it - apart from listing the arguments above - also gave an example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Example:
launchpad.exe 
    -launcher RLauncher.dll 
    -launcher PythonLauncher.dll 
    -logPath C:\Temp 
    -pipeName mypipename 
    -timeout 60000 
    -SqlInstanceName MSSQLSERVER
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Example of How to Launch Launchpad Defining Multiple Launchers</em></p>

<p>Notice how in <em>Code Snippet 3</em> above, multiple launchers are defined, and a launcher for Python being one of them. Maybe we’ll soon see Python being supported as well!</p>

<h3 id="windbg-investigations">WinDbg Investigations</h3>

<p>By now we know (or at least we have a strong hunch) that during startup of the launchpad service, the launchers are loaded. Now it is time to start drilling down in what happens inside the launchpad service when we execute code as in <em>Code Snippet 1</em>. First, let us look at what happens during connection from the SQL Server engine to the launchpad service. In the <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I post</a> I mentioned how SQL Server opens a named pipe connection to the launchpad service in the <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::OpenNPConnection</code> routine.</p>

<p>When named pipes are used, the client connects to a certain named pipe through the <code class="highlighter-rouge">ConnectNamedPipe</code> routine. Let’s do some “spelunking” in the launchpad service using WinDbg, and see if we can find anything that can have anything to do with named pipes:</p>

<ol>
  <li>Stop the launchpad service if it is running.</li>
  <li>Restart the service.</li>
  <li>Open an instance of WinDbg and attach to the <em>Launchpad.exe</em> process.</li>
  <li>Reload the symbols: <code class="highlighter-rouge">.reload /f</code>.</li>
</ol>

<blockquote>
  <p><strong>NOTE:</strong> The <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">internals - I post</a> has more information how to attach to a process, and what commands to use.</p>
</blockquote>

<p>Now, do a search for routines named like <code class="highlighter-rouge">ConnectNamedPipe</code>: <code class="highlighter-rouge">x *!*ConnectNamedPipe*</code>:</p>

<p><img src="/images/posts/sql_r_services_windbg_launchpad_connectnamedpipe.png" alt="" /></p>

<p><strong>Figure 5:</strong> <em>Routines Named ConnectNamedPipe</em></p>

<p><em>Figure 5</em> shows the result after the search, and the <code class="highlighter-rouge">KERNELBASE!ConnectNamedPipe</code> routine looks promising. To find out what happens, we’ll:</p>

<ol>
  <li>Open a second instance of WinDbg.</li>
  <li>Attach it to the <em>sqlservr.exe</em> process.</li>
  <li>Reload the symbols by: <code class="highlighter-rouge">.reload /f</code>.</li>
  <li>Set a breakpoint at the <code class="highlighter-rouge">OpenNPConnection</code> routine: <code class="highlighter-rouge">bp sqllang!CSQLSatelliteConnection::OpenNPConnection</code>.</li>
</ol>

<p>In the debugger attached to the launchpad service we set a breakpoint at <code class="highlighter-rouge">ConnectNamedPipe</code>: <code class="highlighter-rouge">bp KERNELBASE!ConnectNamedPipe</code>. We then execute the code in <em>Code Snippet 1</em> and see what happens:</p>

<ol>
  <li>The <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::OpenNpConnection</code> breakpoint is hit.</li>
  <li>After continuing, the <code class="highlighter-rouge">KERNELBASE!ConnectNamedPipe</code> breakpoint in the launchpad service is hit.</li>
</ol>

<p>The call-stack at this point looks something like so (call stack output by <code class="highlighter-rouge">k c</code>):</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0</span><span class="o">:</span><span class="mo">007</span><span class="o">&gt;</span> <span class="n">k</span> <span class="n">c</span>
 <span class="cp"># Call Site
</span><span class="mo">00</span> <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">ConnectNamedPipe</span>
<span class="mo">01</span> <span class="n">launchpad</span><span class="o">!</span><span class="n">Np</span><span class="o">::</span><span class="n">AsyncAccept</span><span class="o">+</span><span class="mh">0x143</span>
<span class="mo">02</span> <span class="n">launchpad</span><span class="o">!</span><span class="n">Np</span><span class="o">::</span><span class="n">PrepareForNextAccept</span><span class="o">+</span><span class="mh">0x9b</span>
<span class="mo">03</span> <span class="n">launchpad</span><span class="o">!</span><span class="n">SNIAcceptDoneWrapper</span><span class="o">+</span><span class="mh">0x83</span>
<span class="mo">04</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Task</span><span class="o">::</span><span class="n">Param</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x231</span>
<span class="mo">05</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">RunTask</span><span class="o">+</span><span class="mh">0xaa</span>
<span class="mo">06</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">ProcessTasks</span><span class="o">+</span><span class="mh">0x3cd</span>
<span class="mo">07</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SchedulerManager</span><span class="o">::</span><span class="n">WorkerEntryPoint</span><span class="o">+</span><span class="mh">0x2a1</span>
<span class="mi">08</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SystemThread</span><span class="o">::</span><span class="n">RunWorker</span><span class="o">+</span><span class="mh">0x8f</span>
<span class="mi">09</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SystemThreadDispatcher</span><span class="o">::</span><span class="n">ProcessWorker</span><span class="o">+</span><span class="mh">0x2de</span>
<span class="mi">0</span><span class="n">a</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SchedulerManager</span><span class="o">::</span><span class="n">ThreadEntryPoint</span><span class="o">+</span><span class="mh">0x1d8</span>
<span class="mi">0</span><span class="n">b</span> <span class="n">KERNEL32</span><span class="o">!</span><span class="n">BaseThreadInitThunk</span><span class="o">+</span><span class="mh">0x14</span>
<span class="mi">0</span><span class="n">c</span> <span class="n">ntdll</span><span class="o">!</span><span class="n">RtlUserThreadStart</span><span class="o">+</span><span class="mh">0x21</span>

</code></pre></div></div>
<p><strong>Code Snippet 4:</strong> <em>Callstack at KERNELBASE!ConnectNamedPipe</em></p>

<p>So that is how SQL Server connects into the launchpad service:</p>

<ol>
  <li>SQL Server calls <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::OpenNpConnection</code>.</li>
  <li>The launchpad service is doing <code class="highlighter-rouge">launchpad!SNIAcceptDoneWrapper</code>.</li>
  <li>Followed by <code class="highlighter-rouge">KERNELBASE!ConnectNamedPipe</code>, and the named pipe is now open.</li>
</ol>

<blockquote>
  <p><strong>NOTE:</strong> The above is very simplified, in fact a lot of things happen in parallel, and we’ll touch upon that a bit later.</p>
</blockquote>

<p>Let us now go on and have a look what happens after the connection has been made. How do we go about finding out what happens? Well, we can do it the “brute force” way:</p>

<p>We know that the launcher for R will try and load the R runtime, and if we look in the <code class="highlighter-rouge">MSSQL\Binn</code> folder where the <code class="highlighter-rouge">RLauncher.dll</code> resides we find a config file for the launcher: <code class="highlighter-rouge">rlauncher.config</code>. Let’s see what it contains:</p>

<p><img src="/images/posts/sql_r_services_rlauncher_config.png" alt="" /></p>

<p><strong>Figure 5:</strong> <em>RLauncher Configuration</em></p>

<p>In <em>Figure 5</em> we see that the configuration file for the launcher contains the <code class="highlighter-rouge">RHOME</code> path. With that in mind we can assume that the launcher will call into there and launch the runtime. What happens if the launcher cannot find the path? An exception would probably be thrown, and if we were debugging we could hopefully catch it and have a look at the stack. To test this theory:</p>

<ol>
  <li>Stop the launchpad service if it is running.</li>
  <li>Remove the <code class="highlighter-rouge">R_SERVICES</code> directory and its content and place it somewhere else.</li>
  <li>Delete all files from the directory the <code class="highlighter-rouge">-logPath</code> argument in <em>Code Snippet 3</em> points to.</li>
  <li>Restart the launchpad service.</li>
</ol>

<blockquote>
  <p><strong>NOTE:</strong> Please, please, please <strong>DO NOT</strong> do this on a production server!!</p>
</blockquote>

<p>The restart should just go fine, and you can now attach WinDbg to the launchpad process:</p>

<ul>
  <li>Open an instance of WinDbg and attach to the <em>Launchpad.exe</em> process.</li>
  <li>Reload the symbols: <code class="highlighter-rouge">.reload /f</code>.</li>
  <li>Hit F5 to let the debugger run.</li>
</ul>

<p>When the debugger runs, you execute the code in <em>Code Snippet 1</em>, and you get an ugly error in management studio:</p>

<p><img src="/images/posts/sql_r_services_rlauncher_exception.png" alt="" /></p>

<p><strong>Figure 6:</strong> <em>SQL Exception</em></p>

<p>Yeah, kind of obvious that the runtime for R cannot be launched as it is nowhere to be found. WinDbg also reports some exceptions but the debugger is still running. When looking at the exceptions you see something like so:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(2fcc.34c8): C++ EH exception - code e06d7363 (first chance)
(2fcc.35c): C++ EH exception - code e06d7363 (first chance)
[2017-04-01 07:14:54.605][Error] 
ProcessPool::CreateProcess(MSSQLSERVER01-ss-2, 
  78A18DD6-14A7-4BFA-BC1C-664A653A070C) failed with: 
  Failed with (80070003) to start executable 
  C:\&lt;path_to_sql_instance&gt;\R_SERVICES\bin\x64\rterm.exe 
  with args  --slave --no-restore --no-save -e "library(RevoScaleR);
</code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>C++ EH Exception</em></p>

<p>In <em>Code Snippet 5</em> we see that the launcher tries and create a process for <code class="highlighter-rouge">RTerm.exe</code> which is the entry-point to the R runtime. So the question is what was being called to get to this point. If you break out of the debugger and under the <em>Debug</em> menu choose <em>Event Filters</em>:</p>

<p><img src="/images/posts/sql_r_services_windbg_eventfilters.png" alt="" /></p>

<p><strong>Figure 7:</strong> <em>Event Filter</em></p>

<p>In there you can choose how certain events are handled. In <em>Code Snippet 5</em> we see that the exception we encounter is a <code class="highlighter-rouge">C++ EH</code> exception, so in the <em>Event Filters</em> dialog you can set how that particular exception should be handled. We want it to be enabled, but not handled:</p>

<p><img src="/images/posts/sql_r_services_windbg_eventfilters_enable.png" alt="" /></p>

<p><strong>Figure 8:</strong> <em>Enable C++ EH Exception</em></p>

<p>When you execute the code again after having enabled the exception as in <em>Figure 8</em>, the debugger will now break at the exception, and you can view the call-stack through the <code class="highlighter-rouge">k</code> command. In <em>Code Snippet 6</em> below I show an abbreviated part of the call-stack:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0</span><span class="o">:</span><span class="mo">010</span><span class="o">&gt;</span> <span class="n">k</span>
<span class="p">...</span>
<span class="mo">06</span>  <span class="n">RLauncher</span><span class="o">!</span><span class="n">GetInstance</span><span class="o">+</span><span class="mh">0x3239f</span>
<span class="mo">07</span>  <span class="n">RLauncher</span><span class="o">!</span><span class="n">GetInstance</span><span class="o">+</span><span class="mh">0x32a5d</span>
<span class="mi">08</span>  <span class="n">RLauncher</span><span class="o">!</span><span class="n">GetInstance</span><span class="o">+</span><span class="mh">0x5aeee</span>
<span class="mi">09</span>  <span class="n">RLauncher</span><span class="o">!</span><span class="n">GetInstance</span><span class="o">+</span><span class="mh">0x3fbca</span>
<span class="mi">0</span><span class="n">a</span>  <span class="n">RLauncher</span><span class="o">!</span><span class="n">GetInstance</span><span class="o">+</span><span class="mh">0x1c864</span>
<span class="mi">0</span><span class="n">b</span>  <span class="n">RLauncher</span><span class="o">!</span><span class="n">SQLSatellite_GetLauncherAPI</span><span class="o">+</span><span class="mh">0x9dd</span>
<span class="mi">0</span><span class="n">c</span>  <span class="n">launchpad</span><span class="o">!</span><span class="n">CLaunchContext</span><span class="o">::</span><span class="n">Launch</span><span class="o">+</span><span class="mh">0x160</span>
<span class="mi">0</span><span class="n">d</span>  <span class="n">launchpad</span><span class="o">!</span><span class="n">CLaunchContext</span><span class="o">::</span><span class="n">LaunchInternal</span><span class="o">+</span><span class="mh">0x2df</span>
<span class="mi">0</span><span class="n">e</span>  <span class="n">launchpad</span><span class="o">!</span><span class="n">CLaunchContext</span><span class="o">::</span><span class="n">LaunchServTask</span><span class="o">+</span><span class="mh">0x357</span>
<span class="mi">0</span><span class="n">f</span>  <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Task</span><span class="o">::</span><span class="n">Param</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x231</span>
</code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>Call Stack at Exception</em></p>

<p>In <em>Code Snippet 6</em> we see the <code class="highlighter-rouge">launchpad!CLaunchContext::Launch</code> routine, the same we identified in the <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">internals I post</a>. That routine has an important part to play when calling into the launcher. When you look at <em>Code Snippet 5</em> you also see routines from the <code class="highlighter-rouge">RLauncher</code> module. Unfortunately we cannot really see what goes on inside the launcher as there is no symbol file for it.</p>

<p>Coming back to <code class="highlighter-rouge">launchpad!CLaunchContext::Launch</code>; I said it has an important part to play, and it does. However the <code class="highlighter-rouge">launchpad!CLaunchContext::LaunchServTask</code> routine which you also can see in <em>Code Snippet 6</em> is even more important. That routine sets up most of the things that happen when SQL Server calls into the launchpad service. When I talked about the named pipe connection and how things happened in parallel, if you were to set a breakpoint at <code class="highlighter-rouge">launchpad!CLaunchContext::Launch</code> and then output the call-stack and compared that call-stack to what is shown in <em>Code Snippet 4</em>, you would see that both call-stacks have the same originating methods and addresses.</p>

<p>Seeing that we don’t have symbol files for the RLauncher module we have to “hunt” around in WinDbg as well as making some assumptions of what is happening if we want to go further in the “spelunking”. When we, in <em>Code Snippet 5</em> looked at the exception we received in the debugger we saw something about <code class="highlighter-rouge">CreateProcess</code>, and we already saw the <code class="highlighter-rouge">Launch</code> routine in <em>Code Snippet 6</em>. What if we were to look for something like that in the <code class="highlighter-rouge">launchpad</code> module: <code class="highlighter-rouge">x launchpad!*Launch*Process*</code>. That reveals:</p>

<ul>
  <li><code class="highlighter-rouge">launchpad!SQLSatellite_LaunchProcess</code></li>
  <li><code class="highlighter-rouge">launchpad!PhysicalUserContext::LaunchProcess</code></li>
</ul>

<p>Especially the second; <code class="highlighter-rouge">launchpad!PhysicalUserContext::LaunchProcess</code>, is interesting - as when launching the R runtime it should be done in the context of a user. So let us set a couple of breakpoints and see what happens. Set one breakpoint at: <code class="highlighter-rouge">bp launchpad!CLaunchContext::Launch</code> and the other at: <code class="highlighter-rouge">launchpad!PhysicalUserContext::LaunchProcess</code>. Then execute the code again.</p>

<p>When executing we see how we first break at <code class="highlighter-rouge">bp launchpad!CLaunchContext::Launch</code>, followed by <code class="highlighter-rouge">launchpad!PhysicalUserContext::LaunchProcess</code>, and we still have not had any exceptions. If you now hit F5, you will hit the exceptions immediately. So it seems that the <code class="highlighter-rouge">launchpad!PhysicalUserContext::LaunchProcess</code>, is where it happens; where we try and load the R runtime.</p>

<p>To confirm this we can copy back the <code class="highlighter-rouge">R_SERVICES</code> directory to where it is supposed to be, and while still having a breakpoint at <code class="highlighter-rouge">launchpad!PhysicalUserContext::LaunchProcess</code> execute the code again. When you hit the breakpoint, go to process explorer and have a look at running processes where the process is named something with R. On my machine it looks something like so:</p>

<p><img src="/images/posts/sql_r_services_launchpad_before_launch_process.png" alt="" /></p>

<p><strong>Figure 9:</strong> <em>Before LaunchProcess</em></p>

<p>After having continued the debugger, it looks like so:</p>

<p><img src="/images/posts/sql_r_services_launchpad_after_launch_process.png" alt="" /></p>

<p><strong>Figure 10:</strong> <em>After LaunchProcess</em></p>

<p>In <em>Figure 10</em> we now see how some instances of <code class="highlighter-rouge">RTerm.exe</code> has been spun up. In next post we’ll look at why there are multiple instances.</p>

<p><strong>UPDATE:</strong> After “spelunking” for the <strong>Microsoft SQL Server R Services - Internals III</strong> post (still in the works), I realized that I over-simplified the above, so I have tried to make it somewhat more clearer below.</p>

<p>Though it is correct to say that the actual launch of R happens in the <code class="highlighter-rouge">launchpad!PhysicalUserContext::LaunchProcess</code>, it is more to it than that. If we were to set a breakpoint at <code class="highlighter-rouge">launchpad!CLaunchContext::Launch</code>, and when we reach that breakpoint we would do “Watch and Trace” (<a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff561497(v=vs.85).aspx"><code class="highlighter-rouge">wt</code></a>), we would get a very lengthy trace, containing all calls being made.</p>

<blockquote>
  <table>
    <tbody>
      <tr>
        <td><strong>NOTE:</strong> Some routines (<code class="highlighter-rouge">launchpad!PhysicalUserContext::LaunchProcess</code> amongst them) may be too long for the WinDbg console, so <code class="highlighter-rouge">wt</code> can also be written to a log-file, using WinDbg menu *Edit</td>
        <td>Open/Close Log File*.</td>
      </tr>
    </tbody>
  </table>
</blockquote>

<p>During my “spelunking” I did a <code class="highlighter-rouge">wt</code> against <code class="highlighter-rouge">launchpad!PhysicalUserContext::LaunchProcess</code>, which resulted in a 7Mb file. When scrolling through the log-file, the following (extremely abbreviated) call-stack could be seen:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">launchpad</span><span class="o">!</span><span class="n">CLaunchContext</span><span class="o">::</span><span class="n">Launch</span>
<span class="p">...</span> <span class="n">loads</span> <span class="n">of</span> <span class="n">calls</span>
  <span class="n">RLauncher</span><span class="o">!</span><span class="n">SQLSatellite_GetLauncherAPI</span>
    <span class="n">RLauncher</span><span class="o">!</span><span class="n">GetInstance</span>
    <span class="p">...</span> <span class="n">loads</span> <span class="n">of</span> <span class="n">RLauncher</span> <span class="n">routines</span>
      <span class="n">launchpad</span><span class="o">!</span><span class="n">SQLSatellite_LaunchProcess</span>
        <span class="n">launchpad</span><span class="o">!</span><span class="n">CreateProcessForSatelliteSession</span>
          <span class="n">launchpad</span><span class="o">!</span><span class="n">PhysicalUserContext</span><span class="o">::</span><span class="n">LaunchProcess</span>
            <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">CreateProcessInternalW</span>
              <span class="p">...</span> <span class="n">The</span> <span class="n">R</span> <span class="n">process</span> <span class="n">is</span> <span class="n">created</span> <span class="n">here</span> <span class="n">somewhere</span>
            <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">CreateProcessInternalW</span>
          <span class="n">launchpad</span><span class="o">!</span><span class="n">PhysicalUserContext</span><span class="o">::</span><span class="n">LaunchProcess</span>
        <span class="n">launchpad</span><span class="o">!</span><span class="n">CreateProcessForSatelliteSession</span>
      <span class="n">launchpad</span><span class="o">!</span><span class="n">SQLSatellite_LaunchProcess</span>
    <span class="n">RLauncher</span><span class="o">!</span><span class="n">GetInstance</span>
  <span class="n">RLauncher</span><span class="o">!</span><span class="n">SQLSatellite_GetLauncherAPI</span>
<span class="n">launchpad</span><span class="o">!</span><span class="n">CLaunchContext</span><span class="o">::</span><span class="n">Launch</span>
</code></pre></div></div>
<p><strong>Code Snippet 7:</strong> <em>Trace output from launchpad!CLaunchContext::Launch</em></p>

<p>Setting breakpoints and stepping through the code I saw how the R process (RTerm.exe) was spun up inside the <code class="highlighter-rouge">KERNELBASE!CreateProcessInternalW</code> routine.</p>

<p>So if that creates the R process, when and how is the actual data being passed over to the R runtime? Remember back from the <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">internals I post</a>, where we saw how the actual data was written to the launchpad service in the <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code> routine. What if there is something similar in the launchpad service? Let us see what we find if we execute <code class="highlighter-rouge">x *!*WriteMessage*</code>. Oh, among the result is <code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::WriteMessage</code>; that looks something that would be worth looking into. Let us set a breakpoint at <code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::WriteMessage</code>, and execute the code again. We are breaking at out various breakpoints, and we also break at <code class="highlighter-rouge">WriteMessage</code>. If we output the call-stack, it looks like so:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mo">00</span> <span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span>
<span class="mo">01</span> <span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">SendResumeWithLoginInfo</span><span class="o">+</span><span class="mh">0x239</span>
<span class="mo">02</span> <span class="n">launchpad</span><span class="o">!</span><span class="n">CLaunchContext</span><span class="o">::</span><span class="n">LaunchInternal</span><span class="o">+</span><span class="mh">0x375</span>
<span class="mo">03</span> <span class="n">launchpad</span><span class="o">!</span><span class="n">CLaunchContext</span><span class="o">::</span><span class="n">LaunchServTask</span><span class="o">+</span><span class="mh">0x357</span>
<span class="mo">04</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Task</span><span class="o">::</span><span class="n">Param</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x231</span>
<span class="mo">05</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">RunTask</span><span class="o">+</span><span class="mh">0xaa</span>
<span class="mo">06</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">ProcessTasks</span><span class="o">+</span><span class="mh">0x3cd</span>
<span class="mo">07</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SchedulerManager</span><span class="o">::</span><span class="n">WorkerEntryPoint</span><span class="o">+</span><span class="mh">0x2a1</span>
<span class="mi">08</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SystemThread</span><span class="o">::</span><span class="n">RunWorker</span><span class="o">+</span><span class="mh">0x8f</span>
<span class="mi">09</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SystemThreadDispatcher</span><span class="o">::</span><span class="n">ProcessWorker</span><span class="o">+</span><span class="mh">0x2de</span>
<span class="mi">0</span><span class="n">a</span> <span class="n">sqldk</span><span class="o">!</span><span class="n">SchedulerManager</span><span class="o">::</span><span class="n">ThreadEntryPoint</span><span class="o">+</span><span class="mh">0x1d8</span>
<span class="mi">0</span><span class="n">b</span> <span class="n">KERNEL32</span><span class="o">!</span><span class="n">BaseThreadInitThunk</span><span class="o">+</span><span class="mh">0x14</span>
<span class="mi">0</span><span class="n">c</span> <span class="n">ntdll</span><span class="o">!</span><span class="n">RtlUserThreadStart</span><span class="o">+</span><span class="mh">0x21</span>
</code></pre></div></div>
<p><strong>Code Snippet 7:</strong> <em>Callstack for launchpad!CSQLSatelliteConnection::WriteMessage</em></p>

<p>If we were to step through the routine we’d see it looks quite like the <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code> which we looked at in the <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">internals I post</a>. Having reached this point we can now with somewhat certainty assume that after we have launched the process, the launchpad service sends the actual data packet to the R engine through the <code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::WriteMessage</code> routine. And this is where we leave it for now.</p>

<h2 id="summary">Summary</h2>

<p>We should now have a somewhat better understanding of what happens when the launchpad service is called from SQL Server. In <em>Figure 11</em> below shows some of the significant events/calls when <code class="highlighter-rouge">sp_execute_external_script</code> is executed:</p>

<p><img src="/images/posts/sql-launchpad-r-post.png" alt="" /></p>

<p><strong>Figure 11:</strong> <em>Launchpad Service Call Flow</em></p>

<p>The flow is something like this:</p>

<ol>
  <li>A call comes in from SQL Server.</li>
  <li>Enters the launchpad process, and workers, schedulers, tasks, etc., comes into play.</li>
  <li>Eventually <code class="highlighter-rouge">sqldk!SOS_Scheduler::RunTask</code> is called.</li>
  <li>Named pipe connection is accepted and opened.</li>
  <li>More or less in parallel, <code class="highlighter-rouge">launchpad!CLaunchContext::LaunchServTask</code> is called.</li>
  <li>We get into <code class="highlighter-rouge">launchpad!CLaunchContext::Launch</code>.</li>
  <li>The <code class="highlighter-rouge">launchpad!CLaunchContext::Launch</code> routine calls RLauncher routines.</li>
  <li>Multiple RLauncher calls are being made.</li>
  <li>An RLauncher routine calls <code class="highlighter-rouge">launchpad!SQLSatellite_LaunchProcess</code>.</li>
  <li>That call is followed by <code class="highlighter-rouge">launchpad!CreateProcessForSatelliteSession</code></li>
  <li>Which is followed by <code class="highlighter-rouge">launchpad!PhysicalUserContext::LaunchProcess</code>.</li>
  <li>The <code class="highlighter-rouge">KERNELBASE!CreateProcessInternalW</code> is called and the RTerm processes are started.</li>
  <li>Finally after the processes have been launched, <code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::WriteMessage</code> is called.</li>
</ol>

<p>Some of the above are, somewhat, educated guesswork since I don’t have the symbol file for <code class="highlighter-rouge">RLauncher.dll</code>. I do however believe it is more or less accurate. In the next internals post we’ll look at what happens in the RTerm process.</p>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/04/02/microsoft-sql-server-r-services-internals-ii/&text=Microsoft SQL Server R Services - Internals II&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/04/02/microsoft-sql-server-r-services-internals-ii/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2017/04/02/microsoft-sql-server-r-services-internals-ii/
         &title=Microsoft SQL Server R Services - Internals II
         &summary=Blog post: SQL Server R Services series. In this post we look at what happens inside the launchpad service.
         &source=http://www.nielsberglund.com/2017/04/02/microsoft-sql-server-r-services-internals-ii/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/04/02/microsoft-sql-server-r-services-internals-ii/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-machine-learning-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Machine Learning Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#windbg">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WinDbg</span>
    </a>
  
    
    <a href="/tags/#launchpad">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Launchpad</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2017/04/02/microsoft-sql-server-r-services-internals-ii/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2017/04/02/microsoft-sql-server-r-services-internals-ii/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/12/interesting-stuff-week-32/">
            Interesting Stuff - Week 32
            <small>12 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
