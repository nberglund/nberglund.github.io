<!DOCTYPE html> <html lang="en-us"> <head> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="Launchpad service, number of processes, process pool. More about process creation in the launchpad service"> <meta name="keywords" content="SQL Server R Services, SQL Server Machine Learning Services, R, WinDbg, Launchpad, RTerm.exe"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Microsoft SQL Server R Services - Internals IV &middot; Niels Berglund </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-d361e701e0c0e75e121ac3e901cff1b8.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.5.0 --> <title>Microsoft SQL Server R Services - Internals IV | Niels Berglund</title> <meta name="generator" content="Jekyll v3.8.2" /> <meta property="og:title" content="Microsoft SQL Server R Services - Internals IV" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Launchpad service, number of processes, process pool. More about process creation in the launchpad service" /> <meta property="og:description" content="Launchpad service, number of processes, process pool. More about process creation in the launchpad service" /> <link rel="canonical" href="http://nielsberglund.com/2017/04/23/microsoft-sql-server-r-services-internals-iv/" /> <meta property="og:url" content="http://nielsberglund.com/2017/04/23/microsoft-sql-server-r-services-internals-iv/" /> <meta property="og:site_name" content="Niels Berglund" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2017-04-23T14:42:01+02:00" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"http://nielsberglund.com/2017/04/23/microsoft-sql-server-r-services-internals-iv/","headline":"Microsoft SQL Server R Services - Internals IV","dateModified":"2017-04-23T14:42:01+02:00","datePublished":"2017-04-23T14:42:01+02:00","author":{"@type":"Person","name":"nielsb"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://nielsberglund.com/2017/04/23/microsoft-sql-server-r-services-internals-iv/"},"description":"Launchpad service, number of processes, process pool. More about process creation in the launchpad service","@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-3005153158271538", enable_page_level_ads: true }); </script> </head> <body> <div class="sidebar"> <div class="container"> <div class="sidebar-about"> <h1> <a href="/"> Niels Berglund </a> </h1> <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Sidebar_rectangle --> <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-3005153158271538" data-ad-slot="7704601332"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/disclaimer/">Disclaimer</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <img class="center" src="/images/MVP_Logo_large.png" width="300" height="121" > <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <p>&copy; 2018. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">Microsoft SQL Server R Services - Internals IV</h1> <div class="post-subheading"> <span class="post-date">23 Apr 2017</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#Microsoft R Server">Microsoft R Server</a> <a href="/categories/#Data Science">Data Science</a> <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a> <a href="/categories/#SQL Server R Services">SQL Server R Services</a> <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server R Services">SQL Server R Services</a> <a href="/tags/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <a href="/tags/#R">R</a> <a href="/tags/#WinDbg">WinDbg</a> <a href="/tags/#Launchpad">Launchpad</a> <a href="/tags/#RTerm.exe">RTerm.exe</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> <p>This post is part of a series of blog-posts about Microsoft SQL Server R Services:</p> <ol> <li><a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">Microsoft SQL Server 2016 R Services Installation</a></li> <li><a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Microsoft SQL Server R Services - Internals I</a></li> <li><a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Microsoft SQL Server R Services - Internals II</a></li> <li><a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Microsoft SQL Server R Services - Internals III</a></li> <li>Microsoft SQL Server R Services - Internals IV (this post)</li> <li><a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Microsoft SQL Server R Services - Internals V</a></li> <li><a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Microsoft SQL Server R Services - Internals VI</a></li> <li><a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Microsoft SQL Server R Services - Internals VII</a></li> <li><a href="/2017/07/22/microsoft-sql-server-r-services-internals-viii/">Microsoft SQL Server R Services - Internals VIII</a></li> <li><a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Microsoft SQL Server R Services - Internals IX</a></li> <li><a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Microsoft SQL Server R Services - Internals X</a></li> <li><a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">Microsoft SQL Server R Services - Internals XI</a></li> <li><a href="/2017/10/31/microsoft-sql-server-r-services-internals-xii/">Microsoft SQL Server R Services - Internals XII</a></li> <li><a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">Microsoft SQL Server R Services - Internals XIII</a></li> <li><a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Microsoft SQL Server R Services - Internals XIV</a></li> <li><a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Microsoft SQL Server R Services - Internals XV</a></li> <li><a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Microsoft SQL Server R Services - Internals XVI</a></li> <li><a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Microsoft SQL Server R Services - Internals XVII</a></li> <li><a href="/2018/01/10/microsoft-sql-server-r-services-internals-xviii/">Microsoft SQL Server R Services - Internals XVIII</a></li> <li><a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Microsoft SQL Server R Services - Internals XIX</a></li> <li><a href="/2018/02/02/microsoft-sql-server-r-services-internals-xx/">Microsoft SQL Server R Services - Internals XX</a></li> <li><a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">Microsoft SQL Server R Services: sp_execute_external_script - I</a></li> <li><a href="/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/">Microsoft SQL Server R Services - sp_execute_external_script - II</a></li> <li><a href="/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/">Microsoft SQL Server R Services: sp_execute_external_script - III</a> <em>last post in the series</em></li> </ol> <p>This post is the fifth post about Microsoft SQL Server R Services, and the fourth post that drills down into the internal of how it works. In <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a>, I wrote about how the launchpad service creates multiple processes when executing an external script.</p> <p>Seeing that some of the conclusions I came to was somewhat educated guesses, I asked you guys to correct me where I was in-correct and/or add more information. After that post - Bob Albright (<a href="https://twitter.com/bob_albright">@bob_albright</a>) - wrote me an email and pointed me to some resources around process creation, as well as some demo code. Thanks Bob!</p> <p>So today we'll drill even further into the creation of processes, and see how they are used.</p> <!--more--> <h2>Recap</h2> <p>In <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a>, we talked about how, during installation of an R enabled SQL Server instance, 20 Windows accounts are created. These accounts are created for the purpose to be able to provide isolation between users when executing external scripts.</p> <p>In addition to the Windows user accounts created during installation, folders named as the individual Windows accounts are also created in the <code>c:\&lt;sql_instance_path&gt;\MSSQL\ExtensibilityData</code> folder. These folders act as storage for files, results, objects, etc., during execution of an external script.</p> <p>When a user executes an external script in SQL Server, that account is being mapped to one of the 20 Windows account created, and it is under that Windows account the external part of the script is executed. Subsequently the files, etc., mentioned above, ends up in that folder somewhere. I write somewhere, because it is not entirely correct to say that the files, results, etc., are stored directly in the user folder. They are in fact stored in sub-folders of the user folder.</p> <p>During execution the launchpad service creates working directories (the sub-folders above) and processes, and assigns the working directories and processes the same names (<code>Guid</code> values).</p> <p><em>Figure 1</em> below shows the flow when executing a script:</p> <p><img class="center" src="/images/posts/sql-launchpad_processes_post.png" width="650" height="466" > <strong>Figure 1:</strong> <em>Flow when Executing a Script</em></p> <p>As per the figure:</p> <ul> <li>We see backing folders in <code>c:\&lt;sql_instance_path&gt;\MSSQL\ExtensibilityData</code> for the group of user accounts that are mapped to SQL Server users when executing code via <code>sp_execute_external_script</code>.</li> <li>When executing, <code>launchpad!CLaunchContext::LaunchServTask</code> is called, and a satellite session and a session object is created.</li> <li>Then the working directories (the sub-folders mentioned above), and RTerm processes are created. In the figure the working directories are named <code>WorkingDir1</code> etc., whereas in reality the names are <code>Guid</code> values. The processes are RTerm processes and are assigned the same <code>Guid</code> as the working directory name. So a RTerm process always executes "under" one user account sub-folder.</li> <li>After two initial directories and processes have been created, one of the two processes are assigned to the created session.</li> <li>When the process has been assigned to the session, the script is executed via; <code>launchpad!CSQLSatelliteCommunication::SendResumeWithLoginInfo</code> and <code>launchpad!CSQLSatelliteConnection::WriteMessage</code>. This normally happens while the third process is created.</li> <li>Processes and working directories 4 - 6 are created. These processes are available for subsequent executions.</li> <li>When the execution has finished the session is torn down together with the process. <ul> <li>At this stage we now have 5 processes running, and 5 working folders.</li> </ul> </li> </ul> <p>The above is in essence what <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a> covered, and if you want all the "nitty-gritty", please read that <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">post</a>.</p> <h2>Processes</h2> <p>In the <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a>, we figured out that, by default, the launchpad service creates 5 processes, plus the process that is used for execution, when executing an external script. In the post I assumed that the reason for creating 5 (well 6 actually), was for performance, and I also wondered where that magic number 5 came from - seeing I couldn't find it in any config files. That's where <a href="https://twitter.com/bob_albright">Bob's</a> email comes in, as he pointed me to a <a href="https://blogs.msdn.microsoft.com/microsoftrservertigerteam/2016/09/20/tips-sql-r-services-optimization-for-concurrent-execution-of-in-database-analytics-using-sp_execute_external_script/">blog-post</a> by the <a href="https://blogs.msdn.microsoft.com/sql_server_team/">SQL Server engineering</a> team, a.k.a TIGER (cool name!).</p> <p>So, that particular blog-post mentions that the number of processes spun up can be controlled by a setting in the <code>rlauncher.config</code> file: <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code>. If not set, it defaults to 5, and in the end, when executing, the setting + 1 processes has been created as per above.</p> <p>The post also "kind of" confirms that my assumption about performance being a reason for spinning up multiple processes is correct, considering that a user may execute concurrent requests and it takes around 100 ms to spin up a process. In <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a> I mentioned how the processes that are created are added to a pool of processes. So, the assumption on my part is that when there are multiple processes available, a new request will not execute on a newly created process, but will use a process from the pool.</p> <p>Let us see if we can confirm the points about the config setting as well as performance.</p> <h3>Controlling Number of Processes</h3> <p>Initially we'll begin with looking into the <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code> setting and see if it has any effect on the number of processes being created. In <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a> we looked at the number of processes having been spun up while the code was executing and we saw something like so:</p> <p><img class="center" src="/images/posts/sql-launchpad-rterm_processes.png" width="583" height="100" > <strong>Figure 2:</strong> <em>RTerm Processes</em></p> <p>So 6 processes alive while the code is executing. After the code has finished, the executing process is torn down, and we have 5 processes in the pool. That was without having changed any settings, so let's change the settings:</p> <ol> <li>Stop the launchpad service.</li> <li>Open the <code>rlauncher.config</code> file with your text editor of choice (you need to run the editor as administrator).</li> </ol> <p>The config file looks something like what you see in <em>Figure 3</em>:</p> <p><img class="center" src="/images/posts/sql_r_services_rlauncher_config.png" width="617" height="213" > <strong>Figure 3:</strong> <em>RLauncher Configuration</em></p> <p>As you see, there is no <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code> setting. Let us add the setting with a value of 15: <code>PROCESS_POOL_SQLSATELLITE_GROWTH=15</code> and see what happens.</p> <ol> <li>Save the config file after you have added the setting as per above.</li> <li>Restart the launchpad service.</li> </ol> <p>Well, it looks like the launchpad service started, so the setting is not causing any issues (yet). We'll now execute some code and try and figure out if more processes will be created. We use the same code as we did in <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a>, where the code has a pause statement, so we can easier look at what is happening:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Script with Pause</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="o">@</span><span class="k">language</span> <span class="o">=</span><span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s1">'OutputDataSet&lt;-InputDataSet;
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                              Sys.sleep(120);'</span><span class="p">,</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span><span class="n">N</span><span class="s1">'SELECT 42'</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">(([</span><span class="n">TheAnswer</span><span class="p">]</span> <span class="n">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">));</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Execute with Sys.sleep</em></p> <p>As in <a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Internals - III</a>, I use <a href="https://technet.microsoft.com/en-us/sysinternals/processexplorer.aspx"><em>Process Explorer</em></a> from <strong>Sysinternals</strong>. So, let's go ahead and see what happens:</p> <ol> <li>Start <em>Process Explorer</em>, order by Process, and scroll down to where you see process names starting with "RT" (on my box there are none at this stage), or where those processes should be. <ul> <li>If you at this stage see RTerm, restart the launchpad service again and kill those processes.</li> </ul> </li> <li>Execute the code in <em>Code Snippet 1</em>.</li> </ol> <p>While the code is running, take a quick look in <em>Process Explorer</em>, and you should see something like so:</p> <p><img class="center" src="/images/posts/sql_r_services_rterm_processes15.png" width="469" height="276" > <strong>Figure 4:</strong> <em>RTerm Processes after Setting Change</em></p> <p>In <em>Figure 4</em> you can now see 16 <code>RTerm.exe</code> processes running. Once again, the reason for 16 instead of 15 is that the launchpad service spins up the number it is supposed to, plus one more. After the execution has finished, you will see 15 RTerm processes.</p> <p>So yes, the setting does have impact. If you want, you can now delete the setting from the config file and restart the launchpad service.</p> <h3>Process Pool Impact on Executions from the Same Session / Concurrent Executions</h3> <p>Above I mentioned that I thought that by spinning up these processes, we'll get a performance benefit when executing concurrently or if we are, under the same <code>SPID</code>, doing subsequent executions. After all, as mentioned above, the processes are added to a process pool, and they should then be available for usage. A bit like connection pooling in ADO.NET or thread pooling in the .CLR.</p> <h4>Same Session Multiple Execs</h4> <p>Let us start with looking what happens when doing multiple executions in the same SQL Server session (<code>SPID</code>).</p> <p>So the way we will do this is to look at the process id of the RTerm processes, and the process id of the executing code. The process id's of the RTerm process we get from <em>Process Explorer</em>, and in <em>Figure 5</em> below you see the process id's in the outlined column furthest to the right:</p> <p><img class="center" src="/images/posts/sql_r_services_rterm_processids.png" width="406" height="85" > <strong>Figure 5:</strong> <em>RTerm ProcessId's</em></p> <p><em>Figure 5</em> tells us how we can see the id's of the RTerm processes, but how can we see the process id under which the code executes? It's not like we have <code>@@SPID</code> in the external engine. Fortunately R has a function to get the process id of the process in which the code is executing: <code>Sys.getpid()</code>. So if we change the code to something like in <em>Code Snippet 2</em>, we should be able to see the process id, and then be able to compare what we see from the RTerm processes:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Process ID</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="o">@</span><span class="k">language</span> <span class="o">=</span><span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                    pid &lt;- Sys.getpid()
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                    data&lt;-InputDataSet
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                    data$pid &lt;- pid
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                    OutputDataSet&lt;-data;
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>                    Sys.sleep(120);'</span><span class="p">,</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span><span class="n">N</span><span class="s1">'SELECT 42'</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">(([</span><span class="n">TheAnswer</span><span class="p">]</span> <span class="n">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span> <span class="n">ProcessID</span> <span class="n">int</span><span class="p">));</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>Get the Process Id</em></p> <p>Notice how we create and add a new column, <code>pid</code>, to the R data-frame, <code>data</code>, by: <code>data$pid</code> (the names <code>pid</code> and <code>data</code>could be anything). Now, the way we will do this is to, in the same session:</p> <ul> <li>Execute the code</li> <li>Capture the process id's of the created RTerm processes, before the code has finished executing.</li> <li>Look at the result from executing the code in <em>Code Snippet 2</em> and compare the process id which is part of the result with the process id's we captured from the RTerm processes.</li> </ul> <p>When we have done the steps above we repeat it a second time. If my assumption is correct that during a subsequent execution, a process will be used from the pool that was created at first execution; then the process id that comes back from the result of the second execution, should be found in the process id's that were captured during the first execution.</p> <blockquote><p><strong>NOTE:</strong> It is important that the second run of the code is done immediately after the first. If not, some of the pooled processes may have been torn down.</p></blockquote> <p>Let's do this:</p> <ul> <li>If you haven't deleted the <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code> setting from the config file, go ahead and do that.</li> <li>Restart the launchpad service.</li> <li>Navigate to the <code>Launchpad.exe</code> process in <em>Process Explorer</em>.</li> <li>Execute the code in <em>Code Snippet 2</em>.</li> <li>While the code is executing capture the process id's from the <code>RTerm.exe processes</code>.</li> </ul> <p>The capture of the first execution is shown in <em>Figure 6</em> below:</p> <p><img class="center" src="/images/posts/sql_r_services_rterm_processids_executing.png" width="414" height="115" > <strong>Figure 6:</strong> <em>Process Id's from First Run</em></p> <p>The result from the code came back with a process id of 16956. If you were to look at the processes directly after the result came back, you would see 5 processes, as process 16956 (the executing process) has been torn down. Now execute the code a second time. The captured processes are now like so:</p> <p><img class="center" src="/images/posts/sql_r_services_rterm_processids_executing2.png" width="401" height="115" > <strong>Figure 7:</strong> <em>Process Id's from Second Run</em></p> <p>In <em>Figure 7</em> we indeed see that process 16956 is not there any more. When the result comes back the process id is 19028 as in <em>Figure 8</em>:</p> <p><img class="center" src="/images/posts/sql_r_services_rterm_processids_result2.png" width="210" height="75" > <strong>Figure 8:</strong> <em>Result from 2:nd Run</em></p> <p>So, looking back at <em>Figure 6</em>, we see how process id 19028 is part of the processes initially created, so it seems that the assumptions about how processes are used are correct.</p> <p>But wait a second when we look at <em>Figure 8</em>, we see a new process id - 19192, and if we were to look at the processes right after the code has finished running, it would look something like so:</p> <p><img class="center" src="/images/posts/sql_r_services_rterm_processids_after_executing2.png" width="400" height="86" > <strong>Figure 9:</strong> <em>After 2:nd Run</em></p> <p>In <em>Figure 9</em> we see that the process that we executed under in the second run is gone as expected, but we have a new process running - 19192. So what happens is that, in parallel with R executing the code, the launchpad service is spinning up a new process.</p> <p>The theory that for executions by the same user and <code>SPID</code> - the launchpad service uses processes from the pool seems to be correct.</p> <h4>Concurrent Executions Different Sessions</h4> <p>To see what happens for concurrent executions, by the same user but from different <code>SPID</code>'s, we'll do it in almost the same way as above. Start with restarting the launchpad service, so we don't have any "hangers on-ers" from previous runs. We copy the code in <em>Code Snippet 2</em> to a new query window in <em>SQL Server Management Studio</em>, (this ensures a new <code>SPID</code>), and then we:</p> <ol> <li>Execute the code in query window 1.</li> <li>Capture the RTerm process id's.</li> <li>Execute the code in query window 2, while the code in query window 1 still executes.</li> <li>Capture the RTerm process id's.</li> </ol> <p>After both queries have finished executing, you will see that executing concurrently from the same user but different sessions will behave the same was as executing multiple times from the same session:</p> <ol> <li>A process will be picked up from the pool and the code will execute under that session.</li> <li>The launchpad service creates a new process, and adds it to the pool.</li> <li>When the code has finished executing, the process which it executed under is being torn down,</li> </ol> <p>So the theory holds true here as well.</p> <h4>Concurrent Executions Different Sessions Different Users</h4> <p>So what happens then if there are multiple users executing code concurrently? In this scenario nothing is different from when a single user executes for the first time:</p> <ul> <li>The second user will be mapped to another user account,</li> <li>The launchpad service creates it's normal 5 processes, plus one.</li> <li>The code is executed.</li> </ul> <p><img class="center" src="/images/posts/sql_r_services_rterm_processids_mult_users.png" width="407" height="212" > <strong>Figure 10:</strong> <em>Two Users Executing Concurrently</em></p> <p><em>Figure 10</em> shows what it looks like in <em>Process Explorer</em> when two different users executes concurrently. I either of these users would then execute another statement, it would be exactly as above where we looked at the single user scenario.</p> <blockquote><p><strong>NOTE:</strong> When looking in <em>Process Explorer</em> at the RTerm processes you can actually see what process is active. The active process has a value in the <em>CPU</em> column.</p></blockquote> <h2>Summary</h2> <p>In this blog-post I set out to prove/disprove two things:</p> <ol> <li>That the setting <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code> can be used to control the number of processes being created by the launchpad service.</li> <li>Processes that are added to the pool is being picked up and used for subsequent executions for a user.</li> </ol> <p>What we saw was:</p> <ul> <li>When <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code> is absent from the <code>rlauncher.config</code> file, the launchpad service creates 5 processes plus 1 by default, and after execution the executing process is torn down. The others are added to the pool.</li> <li>When a value has been set for <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code>, the launchpad service creates that number of processes plus one, and after execution the executing process is torn down. The others are added to the pool.</li> <li>When a user executes subsequent requests, or concurrent requests from different sessions, processes are picked up and used from the pool. <ul> <li>The launchpad service simultaneously creates a new process.</li> </ul> </li> </ul> <p>So, thanks <a href="https://twitter.com/bob_albright">Bob</a> for sending me the mail with the link the the <a href="https://blogs.msdn.microsoft.com/microsoftrservertigerteam/2016/09/20/tips-sql-r-services-optimization-for-concurrent-execution-of-in-database-analytics-using-sp_execute_external_script/">post</a>. That made me look deeper into how this "stuff" works! In that email Bob also sent some code, which will be used as a topic for another internals blog-post. That post will be about parallelism and the RTerm processes.</p> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/04/23/microsoft-sql-server-r-services-internals-iv/&text=Microsoft SQL Server R Services - Internals IV&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/04/23/microsoft-sql-server-r-services-internals-iv/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2017/04/23/microsoft-sql-server-r-services-internals-iv/ &title=Microsoft SQL Server R Services - Internals IV &summary=Blog post: Launchpad service, number of processes, process pool. More about process creation in the launchpad service &source=http://www.nielsberglund.com/2017/04/23/microsoft-sql-server-r-services-internals-iv/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/04/23/microsoft-sql-server-r-services-internals-iv/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> <br/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad2 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="1158080725" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2018/06/03/interesting-stuff-week-22/"> Interesting Stuff - Week 22 <small> (03 Jun 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/06/01/sql-server-machine-learning-services-and-sql-server-2017-cu-7/"> SQL Server Machine Learning Services and SQL Server 2017 CU7 <small> (01 Jun 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/05/27/interesting-stuff-week-21/"> Interesting Stuff - Week 21 <small> (27 May 2018)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
