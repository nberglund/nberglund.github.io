<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Creating R Stored Procedures in SQL Server 2016 Using sqlrutils &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Creating R Stored Procedures in SQL Server 2016 Using sqlrutils</h1>
  <div class="post-subheading">
  <span class="post-date">25 Jun 2017</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#R">R</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>In the <a href="https://social.msdn.microsoft.com/Forums/en-US/home?forum=MicrosoftR">Microsoft R Server forum</a> the other day was a <a href="https://social.msdn.microsoft.com/Forums/en-US/5759339f-ec8a-4c70-b05c-081d56542c84/sql-server-r-services-stored-procedures-inputs">question</a> about inputs to SQL Server R stored procedures, or rather about “strange” parameter naming, when using the <strong>sqlrutils</strong> package. I got intrigued by the question and started <del>playing around with</del> researching it, and this blog-post is the result. Oh, and this blog-post would never have seen the light of the day, if it hadn’t been for the original poster of the question: <a href="https://social.msdn.microsoft.com/profile/jd%20long/">JD Long</a>, thanks JD!</p>

<p>So, what is SQL Server R stored procedures and what is <strong>sqlrutils</strong>?</p>

<!--more-->

<p>Before we answer the question above, let’s do a quick recap of <code class="highlighter-rouge">sp_execute_external_script</code>.</p>

<h2 id="sp_execute_external_script"><code class="highlighter-rouge">sp_execute_external_script</code></h2>

<p>The procedure <code class="highlighter-rouge">sp_execute_external_script</code> is an extended stored procedure, and it allows us to execute R scripts (and in SQL 2017 also Python) from inside SQL Server. You use it by passing it the script you want to execute as well as various parameters. Let’s assume you have some R code looking like so:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># set a variable</span><span class="w">
</span><span class="n">multiplier</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">5</span><span class="w">

</span><span class="c1">#get the iris data set as a data frame</span><span class="w">
</span><span class="n">iris_dataset</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">iris</span><span class="w">

</span><span class="c1"># grab the setosa species</span><span class="w">
</span><span class="n">setosa</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">iris</span><span class="p">[</span><span class="n">iris</span><span class="o">$</span><span class="n">Species</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'setosa'</span><span class="p">,]</span><span class="w">

</span><span class="c1"># calculate mean of the Sepal.Width for setosa</span><span class="w">
</span><span class="n">menSepWidth</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">setosa</span><span class="o">$</span><span class="n">Sepal.Width</span><span class="p">)</span><span class="w">

</span><span class="c1"># use the multiplier to do some "stuff</span><span class="w">
</span><span class="n">iris_dataset</span><span class="o">$</span><span class="n">Sepal.Length</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">iris_dataset</span><span class="o">$</span><span class="n">Sepal.Length</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">multiplier</span><span class="w">

</span><span class="c1"># look at the resulting dataset </span><span class="w">
</span><span class="n">View</span><span class="p">(</span><span class="n">iris_dataset</span><span class="o">$</span><span class="n">Sepal.Length</span><span class="p">)</span><span class="w">

</span><span class="c1"># print out the mean</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">menSepWidth</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>R Script</em></p>

<p>As you see in <em>Code Snippet 1</em>, we:</p>

<ul>
  <li>Set the value of the <code class="highlighter-rouge">multiplier</code> variable.</li>
  <li>Reads in the <code class="highlighter-rouge">iris</code> data into a data frame: <code class="highlighter-rouge">iris_dataset</code>.</li>
  <li>Create a new data frame for the <code class="highlighter-rouge">setosa</code> species.</li>
  <li>Calculate the <code class="highlighter-rouge">mean</code> of the <code class="highlighter-rouge">Sepal.Width</code> for <code class="highlighter-rouge">setosa</code> and assigns that to a variable: <code class="highlighter-rouge">menSepWidth</code>.</li>
  <li>Multiply the <code class="highlighter-rouge">Sepal.Length</code> property with the <code class="highlighter-rouge">multiplier</code> variable.</li>
  <li>Finally output the calculated property, and print out the <code class="highlighter-rouge">menSepWidth</code> variable.</li>
</ul>

<p>Yes, yes, I know - the code is very, very simplistic, but it will still get the points across.</p>

<blockquote>
  <p><strong>NOTE:</strong> If you haven’t heard about the <code class="highlighter-rouge">iris</code> dataset before, you can read more about it <a href="https://en.wikipedia.org/wiki/Iris_flower_data_set">here</a>.</p>
</blockquote>

<p>To use this script in SQL Server with <code class="highlighter-rouge">sp_execute_external_script</code>, you would write something like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">out_val</span> <span class="n">float</span><span class="p">;</span>

<span class="k">exec</span> <span class="n">sp_execute_external_script</span>
      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
        iris_dataset &lt;- iris

        setosa &lt;- iris[iris$Species == "setosa",]

        menSepWidth &lt;- mean(setosa$Sepal.Width)

        iris_dataset$Sepal.Length &lt;- iris_dataset$Sepal.Length * multiplier
        OutputDataSet &lt;- data.frame(iris_dataset$Sepal.Length)      
      '</span><span class="p">,</span>
      <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@multiplier float, @menSepWidth float OUTPUT'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">multiplier</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
      <span class="o">@</span><span class="n">menSepWidth</span> <span class="o">=</span> <span class="o">@</span><span class="n">out_val</span> <span class="k">OUTPUT</span>
      <span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">((</span><span class="n">SepalLength</span> <span class="n">float</span><span class="p">));</span>  

<span class="k">SELECT</span> <span class="o">@</span><span class="n">out_val</span> <span class="k">AS</span> <span class="n">MeanSepWidth</span>
</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>The iris Script in SQL Server</em></p>

<p>As you see from <em>Code Snippet 2</em>, the R script is passed in to the <code class="highlighter-rouge">@script</code> parameter of <code class="highlighter-rouge">sp_execute_external_script</code>. The actual script looks almost identical to what is in <em>Code Snippet 1</em>, except for instead of the <code class="highlighter-rouge">View(iris_dataset$Sepal.Length)</code>, we use <code class="highlighter-rouge">OutputDataSet</code>. The <code class="highlighter-rouge">OutputDataSet</code> variable is a well known variable in SQL Server R Services, and it is the default variable that will contain the data to be returned to SQL Server as a result-set upon completion of the stored procedure call. The layout of the result-set is defined in the <code class="highlighter-rouge">WITH RESULT SETS</code> statement, and in <em>Code Snippet 2</em> above we are interested in one column, of type <code class="highlighter-rouge">float</code> and we name it <code class="highlighter-rouge">SepalLength</code>.</p>

<p>The parameters we use are defined in the <code class="highlighter-rouge">@params</code> parameter, followed by the parameters themselves. In this case <code class="highlighter-rouge">@multiplier</code> which we set to 5, and <code class="highlighter-rouge">@menSepWidth</code> which is <code class="highlighter-rouge">OUTPUT</code>. If you have used <code class="highlighter-rouge">sp_executesql</code> the parameter syntax should be familiar to you. We assign the (at the top of the script) declared <code class="highlighter-rouge">@out_val</code> variable to the <code class="highlighter-rouge">@menSepWidth</code> output parameter, and at the end of the script we <code class="highlighter-rouge">SELECT</code> it out.</p>

<p>When running <em>Code Snippet 2</em>, the output will be like in the two figures below:</p>

<p><img src="/images/posts/sqlrutils_extscript_result.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Result-set</em></p>

<p><em>Figure 1</em> shows the output from <code class="highlighter-rouge">OutputDataSet</code>, the calculated <code class="highlighter-rouge">Sepal.Length</code> column.</p>

<p><img src="/images/posts/sqlrutils_extscript_outparam.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>Output Parameter</em></p>

<p>In <em>Figure 2</em> we see the output parameter; <code class="highlighter-rouge">@menSepWidth</code>.</p>

<p>This is nice, being able to execute <code class="highlighter-rouge">sp_execute_external_script</code>, and run our R scripts in SQL Server. However how do I operationalize this, I can’t really be running these scripts every time I want to “crunch” some data?! Well, the answer to that is to wrap the code we see in <em>Code Snippet 2</em> in a stored procedure, which would take the necessary parameters, and then execute <code class="highlighter-rouge">sp_execute_external_script</code> inside the procedure.</p>

<p>To make it easier to create wrapping procedures, Microsoft has an R package to help with this: <strong>sqlrutils</strong>.</p>

<h2 id="sqlrutils">sqlrutils</h2>

<p>The sqlrutils package allows R users to, from inside an R IDE of choice, put their R scripts into a T-SQL stored procedure, register that stored procedure with a database, and run the stored procedure from an R development environment.</p>

<p>Let us see what the package does. To do that run from inside an R IDE, I am using R Tools for Visual Studio 2017 (RTVS), <code class="highlighter-rouge">help(package="sqlrutils")</code>.</p>

<blockquote>
  <p><strong>NOTE:</strong> Before you run the <code class="highlighter-rouge">help</code> statement above, you may have to run: <code class="highlighter-rouge">library(sqlrutils)</code>, to load the package.</p>
</blockquote>

<p>When running `help(package=”sqlrutils”), the httpd help server starts and you should see something like so:</p>

<p><img src="/images/posts/sqlrutils_help.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>Output from Help</em></p>

<p>In <em>Figure 3</em> you see the various function the package exposes. Now, let’s see what we can do with it.</p>

<h3 id="r-function">R Function</h3>

<p>It is considered best practices to rewrite your R script as a function, and pass necessary parameters to the function. So we take our script and turn it into a function:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">irisFunc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">multiplier</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">

  </span><span class="n">iris_dataset</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">iris</span><span class="w">

  </span><span class="n">setosa</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">iris</span><span class="p">[</span><span class="n">iris</span><span class="o">$</span><span class="n">Species</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'setosa'</span><span class="p">,]</span><span class="w">

  </span><span class="n">menSepWidth</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">setosa</span><span class="o">$</span><span class="n">Sepal.Width</span><span class="p">)</span><span class="w">

  </span><span class="n">iris_dataset</span><span class="o">$</span><span class="n">Sepal.Length</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">iris_dataset</span><span class="o">$</span><span class="n">Sepal.Length</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">multiplier</span><span class="w">

  </span><span class="n">sepLength</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">iris_dataset</span><span class="o">$</span><span class="n">Sepal.Length</span><span class="p">)</span><span class="w">

  </span><span class="n">retList</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">sepLengthData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sepLength</span><span class="p">,</span><span class="w"> 
                  </span><span class="n">menSepWidthValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">menSepWidth</span><span class="p">)</span><span class="w">

  </span><span class="nf">return</span><span class="p">(</span><span class="n">retList</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Create Function</em></p>

<p>In <em>Code Snippet 3</em> we create the function and we:</p>

<ul>
  <li>pass in the <code class="highlighter-rouge">multiplier</code> parameter</li>
  <li>declare the <code class="highlighter-rouge">menSepWidth</code> variable inside the function</li>
  <li>assign <code class="highlighter-rouge">iris_dataset$Sepal.Length</code> to a data frame variable</li>
  <li>create a named list, containing the data frame as well as <code class="highlighter-rouge">menSepWidth</code> variable</li>
  <li>return the list</li>
</ul>

<p>The function will eventually be part of the script inside <code class="highlighter-rouge">sp_execute_external_script</code>, but before we go there we should define the required parameters for the procedure.</p>

<h3 id="define-parameters">Define Parameters</h3>

<p>In this example we have three parameters / objects:</p>

<ul>
  <li>the <code class="highlighter-rouge">multiplier</code> input parameter</li>
  <li>the <code class="highlighter-rouge">menSepWidth</code> output parameter</li>
  <li>the output dataset</li>
</ul>

<p>When looking at the output from the <code class="highlighter-rouge">help</code> as in <em>Figure 3</em>, we see some functions that looks like doing what we want to do:</p>

<ul>
  <li><code class="highlighter-rouge">InputParameter</code></li>
  <li><code class="highlighter-rouge">OutputData</code></li>
  <li><code class="highlighter-rouge">OutputParameter</code></li>
</ul>

<p>So to create our parameters we write some code like in <em>Code Snippet 4</em>:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># if the sqlrutils package is not loaded yet:</span><span class="w">
</span><span class="c1"># library("sqlrutils")</span><span class="w">

</span><span class="n">inParam</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">InputParameter</span><span class="p">(</span><span class="s2">"multiplier"</span><span class="p">,</span><span class="w"> </span><span class="s2">"numeric"</span><span class="p">)</span><span class="w">
</span><span class="n">outParam</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">OutputParameter</span><span class="p">(</span><span class="s2">"menSepWidthValue"</span><span class="p">,</span><span class="w"> </span><span class="s2">"numeric"</span><span class="p">)</span><span class="w">
</span><span class="n">outputData</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">OutputData</span><span class="p">(</span><span class="s2">"sepLengthData"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p><strong>Code Snippet 4:</strong> <em>Parameter Creation</em></p>

<p>Notice how the output dataset, and the output parameter are named as the names in the list. This is important as we will see in a little bit. You can have multiple parameters (input/output), but only one output data set. If you have multiple parameters you define them as in <em>Code Snippet 4</em>.</p>

<p>Now when the parameters are defined, we can create the stored procedure.</p>

<h3 id="procedure-creation">Procedure Creation</h3>

<p>To create a stored procedure we use the <code class="highlighter-rouge">StoredProcedure</code> class generator, and the signature of <code class="highlighter-rouge">StoredProcedure</code> looks like so:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">StoredProcedure</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="w">
               </span><span class="n">spName</span><span class="p">,</span><span class="w">
               </span><span class="n">...</span><span class="p">,</span><span class="w">
               </span><span class="n">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">
               </span><span class="n">dbName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">
               </span><span class="n">connectionString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">
               </span><span class="n">batchSeparator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"GO"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>Signature for StoredProcedure Class Generator</em></p>

<p>The arguments in the signature are:</p>

<ul>
  <li><code class="highlighter-rouge">func</code> - the function name, of the function we want wrapped.</li>
  <li><code class="highlighter-rouge">spName</code> - name for the generated stored procedure</li>
  <li><code class="highlighter-rouge">...</code> - optional input and output parameters (including output dataset)</li>
  <li><code class="highlighter-rouge">filePath</code> - optional path to where to create and save a .sql source file.</li>
  <li><code class="highlighter-rouge">dbName</code> - optional name specifying the database to use in the script file.</li>
  <li><code class="highlighter-rouge">connectionString</code> - optional connection string.</li>
  <li><code class="highlighter-rouge">batchSeparator</code> - what batch separator to use.</li>
</ul>

<p>So, let’s see what we should do to create a stored procedure based on what we have done so far (the code snippet below includes the parameter definitions from *Code Snippet 4):</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">inParam</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">InputParameter</span><span class="p">(</span><span class="s2">"multiplier"</span><span class="p">,</span><span class="w"> </span><span class="s2">"numeric"</span><span class="p">)</span><span class="w">
</span><span class="n">outParam</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">OutputParameter</span><span class="p">(</span><span class="s2">"menSepWidthValue"</span><span class="p">,</span><span class="w"> </span><span class="s2">"numeric"</span><span class="p">)</span><span class="w">
</span><span class="n">outputData</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">OutputData</span><span class="p">(</span><span class="s2">"sepLengthData"</span><span class="p">)</span><span class="w">

</span><span class="n">irisProc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">StoredProcedure</span><span class="p">(</span><span class="n">irisFunc</span><span class="p">,</span><span class="w">
                      </span><span class="s2">"pr_IrisProc"</span><span class="p">,</span><span class="w">
                      </span><span class="n">inParam</span><span class="p">,</span><span class="w"> 
                      </span><span class="n">outputData</span><span class="p">,</span><span class="w">
                      </span><span class="n">outParam</span><span class="p">,</span><span class="w">
                      </span><span class="n">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\\Temp"</span><span class="w">
                      </span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>Generate Stored Procedure from R Function</em></p>

<p>In <em>Code Snippet 6</em> we:</p>

<ul>
  <li>define the function to use is the function assigned to the <code class="highlighter-rouge">irisFunc</code> variable from <em>Code Snippet 3</em>.</li>
  <li>say that we want the created procedure to be named <code class="highlighter-rouge">pr_IrisProc</code>.</li>
  <li>define the input and output parameters though the variables we have created. If you have defined more parameters (as we spoke about above), you add them to the <code class="highlighter-rouge">StoredProcedure</code> call.</li>
  <li>set the file path where we want the source files to be created.</li>
</ul>

<p>We skip the rest of the arguments, and when we run the code in <em>Code Snippet 6</em>, the source file looks like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IF</span> <span class="p">(</span><span class="n">OBJECT_ID</span><span class="p">(</span><span class="s1">'pr_IrisProc'</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">)</span>
<span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="n">pr_IrisProc</span>
<span class="k">GO</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">pr_IrisProc</span>
  <span class="o">@</span><span class="n">parallel_outer</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="o">@</span><span class="n">multiplier_outer</span> <span class="n">float</span><span class="p">,</span>
  <span class="o">@</span><span class="n">menSepWidthValue_outer</span> <span class="n">float</span> <span class="k">output</span>
<span class="k">AS</span>
  <span class="k">BEGIN</span> <span class="n">TRY</span>
    <span class="k">exec</span> <span class="n">sp_execute_external_script</span>
      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
        irisFunc &lt;- function (multiplier) 
        {
            iris_dataset &lt;- iris
            setosa &lt;- iris[iris$Species == "setosa", ]
            menSepWidth &lt;- mean(setosa$Sepal.Width)
            iris_dataset$Sepal.Length &lt;- iris_dataset$Sepal.Length * 
                multiplier
            sepLength &lt;- data.frame(iris_dataset$Sepal.Length)
            retList &lt;- list(sepLengthData = sepLength, menSepWidthValue = menSepWidth)
            return(retList)
        }
        result &lt;- irisFunc(multiplier = multiplier)
        if (is.list(result)) {
          OutputDataSet &lt;- result$sepLengthData
          menSepWidthValue &lt;- result$menSepWidthValue
        } else stop("the R function must return a list")
      '</span><span class="p">,</span>
      <span class="o">@</span><span class="n">parallel</span> <span class="o">=</span> <span class="o">@</span><span class="n">parallel_outer</span><span class="p">,</span>
      <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@multiplier float, @menSepWidthValue float output'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">multiplier</span> <span class="o">=</span> <span class="o">@</span><span class="n">multiplier_outer</span><span class="p">,</span>
      <span class="o">@</span><span class="n">menSepWidthValue</span> <span class="o">=</span> <span class="o">@</span><span class="n">menSepWidthValue_outer</span> <span class="k">output</span>
  <span class="k">END</span> <span class="n">TRY</span>
  <span class="k">BEGIN</span> <span class="n">CATCH</span>
    <span class="n">THROW</span><span class="p">;</span>
  <span class="k">END</span> <span class="n">CATCH</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 7:</strong> <em>Generated Stored Procedure</em></p>

<p>That looks OK, a couple of things to point out:</p>

<ul>
  <li>Parameter names are appended with <em>_outer</em>. This is what <a href="https://social.msdn.microsoft.com/profile/jd%20long/">JD Long</a> asked about; where comes that from? It seems to be the convention to do that, to separate the parameters for <code class="highlighter-rouge">sp_execute_external_script</code> from the parameters for the <em>outer</em> procedure. Hence the <em>_outer</em> in the name.</li>
  <li>What’s this <code class="highlighter-rouge">@parallel_outer</code> parameter, we did not define it anywhere? In <code class="highlighter-rouge">sp_execute_external_script</code> you have the ability to define that you wish the execution of the R script should happen in parallel, and <code class="highlighter-rouge">@parallel</code> is an existing parameter on <code class="highlighter-rouge">sp_execute_external_script</code>. So by default, this parameter is always created (and defaulted to 0).</li>
  <li>We then see the function definition as part of the <code class="highlighter-rouge">@script</code> parameter, together with generated code to execute and retrieve the results. This is where it is important that you return a named list from the function, especially if you have more than one output parameter (including the output dataset). The names in the list should be the same as you set in your parameter definitions.</li>
</ul>

<p>You can now take the source file and deploy the procedure to a database of your choice. Then you execute the procedure as so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="k">out</span> <span class="n">float</span><span class="p">;</span>
<span class="k">EXEC</span> <span class="n">pr_IrisProc</span> <span class="o">@</span><span class="n">parallel_outer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                  <span class="o">@</span><span class="n">multiplier_outer</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                  <span class="o">@</span><span class="n">menSepWidthValue_outer</span> <span class="o">=</span> <span class="o">@</span><span class="k">out</span> <span class="k">OUT</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="o">@</span><span class="k">out</span><span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 8:</strong> <em>Execution of Generated Procedure</em></p>

<p>When executing, you should get the same result as you see in <em>Figure 1</em> and <em>Figure 2</em>.</p>

<h3 id="deploying-from-r">Deploying from R</h3>

<p>Above we deployed the created procedure by running the script from SQL Server Management Studio, on the database we wanted to deploy to. You can also deploy straight from R, by using <code class="highlighter-rouge">registerStoredProcedure</code>. The signature of <code class="highlighter-rouge">registerStoredProcedure</code> looks like in <em>Code Snippet 8</em>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">registerStoredProcedure</span><span class="p">(</span><span class="n">sqlSP</span><span class="p">,</span> 
                        <span class="n">connectionString</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">)</span>
</code></pre></div></div>
<p><strong>Code Snippet 8:</strong> <em>Signature of registerStoredProcedure</em></p>

<p>We see in <em>Code Snippet 8</em> how <code class="highlighter-rouge">registerStoredProcedure</code> takes the generated stored procedure object (created by <code class="highlighter-rouge">StoredProcedure</code>), and an optional connection string. It is optional as the connection string can be defined in <code class="highlighter-rouge">StoredProcedure</code>.</p>

<p>If we want to deploy to SQL Server directly the code looks like so:</p>

<p>``` r tile: “Deploy”
conStr &lt;- paste0(“Driver={ODBC Driver 13 for SQL Server};Server=.;”,
                 “Database=RTest;uid=sa;pwd=secretpassword;”)</p>

<p>registerStoredProcedure(irisProc, conStr)
```
<strong>Code Snippet 9:</strong> <em>Deploying from R</em></p>

<p>In <em>Code Snippet 9</em>, we continue from <em>Code Snippet 6</em>, and we have created the stored procedure object <code class="highlighter-rouge">irisProc</code>. We create a connection string, and pass <code class="highlighter-rouge">irisProc</code> and the connection string to <code class="highlighter-rouge">registerStoredProcedure</code>. After executing the code in <em>Code Snippet 9</em>, you should see the procedure in the database.</p>

<p>As you know, by using <code class="highlighter-rouge">sp_execute_external_script</code>, we can now in SQL Server 2016 and 2017 execute R scripts (and in SQL 2017 also Python) from inside SQL Server. <code class="highlighter-rouge">sp_execute_external_script</code> is a SQL Server extended stored procedure and you pass in the script to execute as well as parameter info to the procedure.</p>

<h2 id="-finally">~ Finally</h2>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2017/06/25/creating-r-stored-procedures-in-sql-server-2016-using-sqlrutils/&text=Creating R Stored Procedures in SQL Server 2016 Using sqlrutils&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2017/06/25/creating-r-stored-procedures-in-sql-server-2016-using-sqlrutils/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2017/06/25/creating-r-stored-procedures-in-sql-server-2016-using-sqlrutils/
         &title=Creating R Stored Procedures in SQL Server 2016 Using sqlrutils
         &summary=Blog post: We look at how to use sqlrutils to create SQL Server stored procedures from inside an R environment.
         &source=http://www.nielsberglund.com/2017/06/25/creating-r-stored-procedures-in-sql-server-2016-using-sqlrutils/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2017/06/25/creating-r-stored-procedures-in-sql-server-2016-using-sqlrutils/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server</span>
    </a>
  
    
    <a href="/tags/#data-science">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Data Science</span>
    </a>
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#sqlrutils">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">sqlrutils</span>
    </a>
  
    
    <a href="/tags/#sp-execute-external-script">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">sp_execute_external_script</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2017/06/25/creating-r-stored-procedures-in-sql-server-2016-using-sqlrutils/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2017/06/25/creating-r-stored-procedures-in-sql-server-2016-using-sqlrutils/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/07/29/interesting-stuff-week-30/">
            Interesting Stuff - Week 30
            <small>29 Jul 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
