<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Using F# in SQLCLR &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Using F# in SQLCLR</h1>
  <div class="post-subheading">
  <span class="post-date">15 Nov 2010</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#.NET">.NET</a>
    
     <a href="/categories/#SQL Server">SQL Server</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>Recently I have become very interested in F# and I am at the moment trying to get to grips with it. It is definitely a different beast than C#, but so far I like it - a lot!</p>

<p>Anyway, I am a SQL nerd, and many moons ago I was very heavily involved in SQLCLR (for you who don’t know what that is; it is the ability to run .NET code inside the SQL Server engine. It was first introduced with SQL Server 2005). So I thought it would be a “giggle” to see if I could get some F# code running inside SQL Server.</p>

<!--more-->

<p>I created the simplest of the simple F# dll’s. SQLCLR requires you have a public class and your publicly exposed SQLCLR methods to be static, so my F# code looked like so:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">ManagedData</span><span class="p">.</span><span class="nn">Samples</span><span class="p">.</span><span class="nc">FSharp</span>
  <span class="k">type</span> <span class="nc">SqlClr</span> <span class="p">=</span>
    <span class="k">static</span> <span class="k">member</span> <span class="nc">Adder</span> <span class="n">a</span> <span class="n">b</span> <span class="p">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">static</span> <span class="k">member</span> <span class="nc">Factorial</span> <span class="n">n</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">n</span> <span class="k">with</span>
      <span class="p">|</span> <span class="mi">0</span> <span class="o">-&gt;;</span> <span class="mi">1</span>
      <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">n</span> <span class="p">*</span> <span class="p">(</span><span class="nn">SqlClr</span><span class="p">.</span><span class="nc">Factorial</span><span class="p">(</span> <span class="n">n</span> <span class="p">-</span> <span class="mi">1</span><span class="o">))</span>
</code></pre></div></div>
<p>As you can see my class is extremely advanced (not); it has two methods:</p>

<ul>
  <li>The canonical <code class="highlighter-rouge">Adder</code> method (every SQLCLR dll has to have an <code class="highlighter-rouge">Adder</code> method, it’s the law - nah, I’m just kidding), which takes two integers and returns an integer.</li>
  <li>A factorial method, which takes an integer and calculates the factorial from that.</li>
</ul>

<p>By the way, any pointers about how to write efficient F# code are very welcome .</p>

<p>Having written and compiled the code, it was time to deploy! When running .NET code in SQL Server, you need to deploy your assembly to the database you want to execute your code in, and SQL Server will actually load the assembly from the database. In fact most assemblies are loaded from the database, even quite a few of Microsoft’s own system assemblies which normally are loaded from the GAC. There are only about 13 system assemblies that are allowed to be loaded from the GAC these are known as the “blessed list”. You also need to create T-SQL wrapper objects (procedures, functions, triggers, etc.) around the methods you want to publicly expose.</p>

<p>In my SQL Server 2008R2 instance I created a database in which I wanted my F# assembly to, and then it was time to deploy. You can deploy in several ways, the easiest is something like this (in the database you want to use):</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="n">fsasm</span>
<span class="k">FROM</span> <span class="s1">'c:</span><span class="se">\\</span><span class="s1">repos</span><span class="se">\\</span><span class="s1">F#</span><span class="se">\\</span><span class="s1">testcode</span><span class="se">\\</span><span class="s1">fssqlclr</span><span class="se">\\</span><span class="s1">fslib</span><span class="se">\b</span><span class="s1">in</span><span class="se">\\</span><span class="s1">debug</span><span class="se">\\</span><span class="s1">fslib.dll'</span>
<span class="k">WITH</span> <span class="n">permission_set</span> <span class="o">=</span> <span class="n">SAFE</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p>The problem with the code above is that F# projects have a dependency on the assembly <code class="highlighter-rouge">FSharp.Core.dll</code>, so when I tried to deploy my assembly as per above, I got an exception. What I had to do was to deploy <code class="highlighter-rouge">FSharp.Core.dll</code> to my database first:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="n">fsasm</span>
<span class="k">FROM</span> <span class="s1">'C:</span><span class="se">\\</span><span class="s1">path to ...</span><span class="se">\\</span><span class="s1">FSharp.Core.dll'</span>
<span class="k">WITH</span> <span class="n">permission_set</span> <span class="o">=</span> <span class="n">UNSAFE</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p>Notice the use of <code class="highlighter-rouge">permission_set = UNSAFE</code>, this is to tell SQL Server that I know what I am doing and SQL Server should keep from doing a lot if validation. When I had catalogued the <code class="highlighter-rouge">FSharp.Core.dll</code> assembly I had no problems deploying my assembly to the database.</p>

<p>All there remained to do now was to create the T-SQL wrapper object(s) around my F# methods. This is done with “normal” <code class="highlighter-rouge">CREATE ...</code> syntax. The code for my factorial looks like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">FsFactorial</span><span class="p">(</span><span class="o">@</span><span class="n">x</span> <span class="n">int</span><span class="p">)</span>
<span class="k">RETURNS</span> <span class="n">int</span>
<span class="k">EXTERNAL</span> <span class="n">NAME</span> <span class="n">fsasm</span><span class="p">.[</span><span class="n">ManagedData</span><span class="p">.</span><span class="n">Samples</span><span class="p">.</span><span class="n">FSharp</span><span class="p">.</span><span class="n">SqlClr</span><span class="p">].</span><span class="n">Factorial</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p>This also went without problems, so now it is “crunch-time”. Can I execute a F# method in SQLCLR?</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">dbo</span><span class="p">.</span><span class="n">FsFactorial</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</code></pre></div></div>
<p>Lo and behold, it executed and I received 24 back! I had just now executed F# running inside SQL Server!!</p>

<p>So, what does this prove? Nothing really, it was just an exercise from me to see if it could be done. However, F# is really suitable for quite a few tasks you would want to use SQLCLR for, so it now gives a database developer another tool in his tool-belt.</p>

<p>If anyone is interested in the full code for this, please drop me a comment and I’ll email it to you.</p>


    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2010/11/15/using-fsharp-in-sqlclr/&text=Using F# in SQLCLR&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2010/11/15/using-fsharp-in-sqlclr/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2010/11/15/using-fsharp-in-sqlclr/
         &title=Using F# in SQLCLR
         &summary=Blog post: 
         &source=http://www.nielsberglund.com/2010/11/15/using-fsharp-in-sqlclr/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2010/11/15/using-fsharp-in-sqlclr/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#f">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">F#</span>
    </a>
  
    
    <a href="/tags/#sqlclr">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQLCLR</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2010/11/15/using-fsharp-in-sqlclr/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2010/11/15/using-fsharp-in-sqlclr/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/12/interesting-stuff-week-32/">
            Interesting Stuff - Week 32
            <small>12 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
