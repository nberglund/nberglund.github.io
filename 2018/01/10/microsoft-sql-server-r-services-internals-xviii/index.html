<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Microsoft SQL Server R Services - Internals XVIII &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Microsoft SQL Server R Services - Internals XVIII</h1>
  <div class="post-subheading">
  <span class="post-date">10 Jan 2018</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>This is the 19:th post in a series about <strong>Microsoft SQL Server R Services</strong>, and the 18:th post that drills down into the internal of how it works. To see other posts (including this) in the series, go to <a href="/series/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a>.</p>

<p>In this post we’ll continue looking at data coming back to SQL Server, and what happens code-wise in SQL.</p>

<!--more-->

<h2 id="recap">Recap</h2>

<p>In the last few posts in this series, we have looked at what happens when data is being returned to SQL Server from the SqlSatellite.</p>

<p>In <a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Internals - XVI</a> we looked at the data packages coming back to SQL Server, and realized there were two:</p>

<ul>
  <li>One small:ish</li>
  <li>One large.</li>
</ul>

<p>We subsequently saw that the small packet held meta data about the columns being returned and the large packet held the actual data. The reason for the packet being large was due to the data being treated as originating from nullable columns, so quite an overhead was put onto the various columns. This is similar to what we discussed in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>.</p>

<p><a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Internals - XVII</a> talked about what happens inside SQL Server when data is being returned, e.g. what the code flow looks like. We saw how, after the data packet(s) were sent to the SqlSatellite:</p>

<ul>
  <li>Immediately <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::PullRow</code> was called, and waited to be signaled when data was returned.</li>
  <li>The schema of the returning data was determined by calls to <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ProcessOutputSchema</code>, <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::GetOutputSchema</code>, <code class="highlighter-rouge">sqllang!CServerCargoContext::ReadSchemaInternal</code>, and <code class="highlighter-rouge">sqllang!CServerCargoContext::ReadSchemaFromPacket</code>.</li>
  <li>The result rows were processed, and turned into <em>TDS</em> packets, by calls to <code class="highlighter-rouge">ProcessResultRows</code> (one <code class="highlighter-rouge">ProcessResultRows</code> per row).</li>
  <li>During the first <code class="highlighter-rouge">ProcessResultRows</code> an ack packet is sent to the SqlSatellite and two packets is being returned.</li>
  <li>A final <code class="highlighter-rouge">ProcessResultRows</code> was called to indicate that no more rows are coming.</li>
</ul>

<p>There was a question what the two packets returned to SQL Server after the ack packet did, and we “sort of” realized that one of the packets indicated that no more data was coming from the SqlSatellite. The other packet we did not know what it did.</p>

<p>To illustrate the code flow we had a figure like so:</p>

<p><img src="/images/posts/sql_r_services_17_flow.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Code Flow Receiving Data from SqlSatellite</em></p>

<p>The numbered arrows shows the communication out to and in from SQL Server, and in what order it happens:</p>

<ol>
  <li>SQL Server opens named pipe connection to the launchpad service.</li>
  <li>Message sent to the launchpad service.</li>
  <li>After the call above, the SqlSatellite opens a TCP/IP connection to SQL Server.</li>
  <li>SQL Server sends the first packet to the SQL Satellite for authentication purposes.</li>
  <li>A second authentication packet is sent to SqlSatellite.</li>
  <li>The script is sent from inside <code class="highlighter-rouge">sqllang!CSatelliteProxy::PostSetupMessage</code></li>
  <li>The data for <code class="highlighter-rouge">@input_data_1</code> is sent together with two end packets.</li>
  <li>Packet are coming back to SQL Server containing meta-data and the actual data.</li>
  <li><code class="highlighter-rouge">PullRow</code> is being signaled.</li>
  <li>Execution continues to process meta-data as well as result rows.</li>
</ol>

<h2 id="housekeeping">Housekeeping</h2>

<p>Housekeeping in this context is talking about the tools we’ll use, as well as the code. This section is here here for those of who want to follow along in what we’re doing in the posts.</p>

<h4 id="helper-tools">Helper Tools</h4>

<p>To help us figure out the things we want, we will use <em>Process Monitor</em>, <em>WinDbg</em>, and <em>WireShark</em>:</p>

<ul>
  <li><em>Process Monitor</em>, will be used it to filter TCP traffic. If you want to refresh your memory about how to do it, we covered that in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> as well as in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>.</li>
  <li>In the last few posts I have used <em>WinDbg preview</em> a my debugger, but in this post I am reverting back to <em>WinDbg</em> “classic”. If you need help with setting it up, that is covered in <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I</a>.</li>
  <li>I’ll use <em>WireShark</em> for network packet sniffing. In previous posts I have used <em>Microsoft Message Analyzer</em> for this, but I am now back to <em>WireShark</em> as I find it gives me more readable output. If you want a refresher about <em>WireShark</em>, we covered the setup etc., in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a>.</li>
</ul>

<h4 id="code">Code</h4>

<p>The code below sets up the database and creates some tables with some data. It is more or less the same as we’ve used in the last posts:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">ResultData</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">ResultData</span><span class="p">;</span>
<span class="k">GO</span>

<span class="n">USE</span> <span class="n">ResultData</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span><span class="p">(</span><span class="n">RowID</span> <span class="n">bigint</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> 
                          <span class="n">y</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand1</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
              <span class="n">rand2</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand3</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> 
              <span class="n">rand4</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand5</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">);</span>
<span class="k">GO</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">rand3</span><span class="p">,</span> <span class="n">rand4</span><span class="p">,</span> <span class="n">rand5</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span> 
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">20</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">25</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">50</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">100</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o1</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o2</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o3</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o4</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Database, and Database Object Creation</em></p>

<p>The code we’ll use should by now look very familiar:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'OutputDataSet&lt;-InputDataSet'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT TOP(1) rand1 FROM dbo.rand_1M'</span>
</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Base Code to Execute</em></p>

<p>In previous posts, the script has also contained a <code class="highlighter-rouge">Sys.sleep</code>, but for now it is not necessary - we may change the script further down and include <code class="highlighter-rouge">Sys.sleep</code>, or we may not :).</p>

<h2 id="with-result-sets">WITH RESULT SETS</h2>

<p>Up until now, when we have executed code where data comes back from the SqlSatellite, the result looks something like so:</p>

<p><img src="/images/posts/sql_r_services_18_no_column.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>Undefined Column Name</em></p>

<p>From <em>Figure 2</em> we see the result, but with no column name. That’s because the SqlSatellite (or the R engine for that matter) doesn’t know about column names, or - at least - doesn’t take them into account. So, if you wanted the columns in the return result-set to be named in a specific way, you’d have to use the <code class="highlighter-rouge">WITH RESULT SETS &lt;result_sets_definition&gt;</code>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'OutputDataSet&lt;-InputDataSet'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT TOP(1) rand1 FROM dbo.rand_1M'</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">((</span><span class="n">Column1</span> <span class="n">int</span> <span class="p">))</span>               
</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Defining Output</em></p>

<p>The <code class="highlighter-rouge">WITH RESULT SETS</code> in <em>Code Snippet 2</em> tells SQL server that the one column being returned from the SqlSatellite, should be named <code class="highlighter-rouge">Column1</code> and be treated as an <code class="highlighter-rouge">int</code>. Executing the code in <em>Code Snippet 2</em>, results in the following:</p>

<p><img src="/images/posts/sql_r_services_18_column_name.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>Result with Column Name</em></p>

<p>Having defined <code class="highlighter-rouge">WITH RESULT SETS</code> we see now in <em>Figure 3</em> how the one column is named <code class="highlighter-rouge">Column1</code>. However, this post (or section in this post) doesn’t really have anything to do with <code class="highlighter-rouge">WITH RESULT SETS</code>, but what happens inside the SQL Server engine when a result-set comes back from the SqlSatellite and <code class="highlighter-rouge">WITH RESULT SETS</code> is set.</p>

<blockquote>
  <p><strong>NOTE:</strong> Almost all examples you see of <code class="highlighter-rouge">sp_execute_external_script</code> include <code class="highlighter-rouge">WITH RESULT SETS</code>. As we have seen in previous posts as well as this, <code class="highlighter-rouge">WITH RESULT SETS</code> is not required. If you want to read more about <code class="highlighter-rouge">WITH RESULT SETS</code> specifically, there is a link <a href="https://docs.microsoft.com/en-us/sql/t-sql/language-elements/execute-transact-sql">here</a>.</p>
</blockquote>

<p>Ok, so let’s find out what happens - and where - when a result-set comes back from SqlSatellite, with <code class="highlighter-rouge">WITH RESULT SETS</code> is defined. Here’s what we’ll do:</p>

<ul>
  <li>Run <em>WinDbg</em> as admin.</li>
  <li>Attach <em>WinDbg</em> to the SQL Server process (<code class="highlighter-rouge">sqlservr.exe</code>) - <strong>DO NOT DO THIS ON A PRODUCTION SERVER</strong>.</li>
  <li>Enable an <em>Event Filter</em>, in <em>WinDbg</em> for <code class="highlighter-rouge">C++ EH Exception</code>. If you need to refresh you memory about how to do it, <a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Internals - II</a> goes into the details.</li>
  <li>Change the <code class="highlighter-rouge">WITH RESULT SETS</code> in <em>Code Snippet 2</em> to: <code class="highlighter-rouge">WITH RESULT SETS ((Column1 int, ExtraColumn int ))</code>.</li>
</ul>

<p>By adding an extra column to the result-set definition, an exception will occur when executing - as the number of columns in the definition has to match exactly what is being returned. The idea is that we’ll then be able to to break in the debugger where the exception happens and investigate the call-stack, to be able to see where we break. So now we can execute the altered code, and sure enough an exception happens:</p>

<p><img src="/images/posts/sql_r_services_18_exception.png" alt="" /></p>

<p><strong>Figure 4:</strong> <em>C++ EH Exception</em></p>

<p>From <em>Figure 4</em> we see how we have stopped execution at the point of the exception. This gives us now the ability to check the call-stack: <code class="highlighter-rouge">k</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">KERNELBASE</span><span class="o">!</span><span class="n">RaiseException</span><span class="o">+</span><span class="mh">0x68</span>
<span class="n">MSVCR120</span><span class="o">!</span><span class="n">_CxxThrowException</span><span class="o">+</span><span class="mh">0xb3</span> <span class="p">[</span><span class="n">f</span><span class="o">:</span><span class="err">\</span><span class="n">dd</span><span class="err">\</span><span class="n">vctools</span><span class="err">\</span><span class="n">crt</span><span class="err">\</span><span class="n">crtw32</span><span class="err">\</span><span class="n">eh</span><span class="err">\</span><span class="k">throw</span><span class="p">.</span><span class="n">cpp</span> <span class="err">@</span> <span class="mi">154</span><span class="p">]</span> 
<span class="n">sqldk</span><span class="o">!</span><span class="n">ExceptionBackout</span><span class="o">::</span><span class="n">GetCurrentException</span><span class="o">+</span><span class="mh">0x385</span>
<span class="n">sqldk</span><span class="o">!</span><span class="n">ex_raise2</span><span class="o">+</span><span class="mh">0x52f</span>
<span class="n">sqldk</span><span class="o">!</span><span class="n">ex_raise</span><span class="o">+</span><span class="mh">0xc4</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CExecWithResultSetsCOut</span><span class="o">::</span><span class="n">SendMetaImpl</span><span class="o">+</span><span class="mh">0xa8</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">BeginOutput</span><span class="o">+</span><span class="mh">0xd5</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputSchema</span><span class="o">+</span><span class="mh">0x67</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span><span class="o">+</span><span class="mh">0xc7</span>
<span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span><span class="o">+</span><span class="mh">0x196</span>
<span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">GetRow</span><span class="o">+</span><span class="mh">0x81</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span><span class="o">+</span><span class="mh">0x4dc</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtSelect</span><span class="o">::</span><span class="n">XretExecute</span><span class="o">+</span><span class="mh">0x322</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;+</span><span class="mh">0x40d</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span><span class="o">+</span><span class="mh">0xa9e</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x983</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span><span class="o">+</span><span class="mh">0x140e</span>
<span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Call Stack at Exception</em></p>

<p>The code in <em>Code Snippet 3</em> shows the abbreviated call-sack at the time of the exception, and we see some routines that we also saw in <a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Internals - XVII</a> as well as in the <em>Recap</em> above:</p>

<ul>
  <li><code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::PullRow</code></li>
  <li><code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ProcessOutputSchema</code></li>
  <li><code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::BeginOutput</code></li>
</ul>

<p>One routine we haven’t seen before though is the <code class="highlighter-rouge">sqllang!CExecWithResultSetsCOut::SendMetaImpl</code>, and it is this routine that handles the <code class="highlighter-rouge">WITH RESULT SET</code>. We can verify that this is the case by setting a breakpoint at <code class="highlighter-rouge">SendMetaImpl</code> and execute the code in <em>Code Snippet 2</em> (without the extra column in the result set definition). We see how the execution breaks at the break-point. If we were to execute without any result set definition, the break-point wouldn’t be hit.</p>

<p>The <code class="highlighter-rouge">WITH RESULT SETS</code> is not specific to <code class="highlighter-rouge">sp_execute_external_script</code> but was introduced in SQL Server 2012 as a way to “reformat” a result-set, and can be used whenever <code class="highlighter-rouge">EXECUTE</code> is called. Let’s say we have code like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_executesql</span> <span class="n">N</span><span class="s1">'SELECT TOP(1) rand1 FROM dbo.rand_1M'</span> 
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span><span class="p">((</span><span class="n">Column1</span> <span class="n">int</span><span class="p">));</span>
</code></pre></div></div>
<p><strong>Code Snippet 4:</strong> <em>sp_executesql with Result Set Definition</em></p>

<p>If the breakpoint we set above is still enabled, we’ll see how we break when we execute the code in <em>Code Snippet 4</em>.</p>

<p>So from all of the above, when we are defining a result set definition for data being returned from the SqlSatellite, we see how the processing is handled in:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputSchema</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">BeginOutput</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CExecWithResultSetsCOut</span><span class="o">::</span><span class="n">SendMetaImpl</span>
</code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>Routines Involved with Result Set Definition</em></p>

<p>So that is <code class="highlighter-rouge">WITH RESULT SETS</code>. What about output parameters?</p>

<h2 id="output-parameters">Output Parameters</h2>

<p>So far in previous posts as well as in this- we have discussed what happens when result sets come back from the SqlSatellite, and we should be fairly confident now in understanding what happens in SQL Server. However, result-sets are not then only thing we can get back, we can also get back output parameters and in this section we’ll have a look at how that works.</p>

<p>This is some of the code we’ll use:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">p1</span> <span class="n">int</span><span class="p">;</span>
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'d&lt;-42
                     a &lt;- as.integer(3)
                     OutputDataSet&lt;-InputDataSet'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT TOP(1) rand1 FROM dbo.rand_1M'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@a int OUTPUT'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">a</span> <span class="o">=</span> <span class="o">@</span><span class="n">p1</span> <span class="k">OUTPUT</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span><span class="p">((</span><span class="n">ResultSet1</span> <span class="n">int</span><span class="p">));</span>
<span class="k">SELECT</span> <span class="o">@</span><span class="n">p1</span> <span class="k">As</span> <span class="n">OutParam1</span>
</code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>Base Code for Output Parameters</em></p>

<p>As you see in <em>Code Snippet 6</em>, there is one output parameter <code class="highlighter-rouge">@a</code> which in the script is assigned to a value of 3. When we execute the code, the result is:</p>

<p><img src="/images/posts/sql_r_services_18_output1.png" alt="" /></p>

<p><strong>Figure 5:</strong> <em>Result and Output Parameter</em></p>

<h4 id="output-parameter-packets-and-content">Output Parameter Packets and Content</h4>

<p>Let’s see how output parameters are handled:</p>

<ul>
  <li>Run <em>Process Monitor</em> as admin and load the filter we used in <a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Internals - XVI</a> where we filtered for <code class="highlighter-rouge">TCP Send</code> and <code class="highlighter-rouge">TCP Receive</code> for <code class="highlighter-rouge">BxlServer.exe</code>.</li>
  <li>Execute the code in <em>Code Snippet 6</em> and look at the output from <em>Process Monitor</em>.</li>
  <li>Pay attention to the <code class="highlighter-rouge">Path</code> column in the output, as it shows - as last part - what port SQL Server listens on. We’ll use that later when doing <em>WireShark</em> packet sniffing.</li>
</ul>

<p>The output looks something like so:</p>

<p><img src="/images/posts/sql_r_services_18_procmon1.png" alt="" /></p>

<p><strong>Figure 6:</strong> <em>Result and Output Parameter</em></p>

<p>What we see in <em>Figure 6</em> is what we have seen a few times before: we see the two data packets coming back from SQL Server (lengths: 51, 2051), followed by the ack message sent from SQL Server, followed by the two packets coming back from the SqlSatellite. We believe that one of the packets is indicating end of result-set, but we don’t know what the other packet is for. But wait a second, normally (with no output parameters) the second packet coming back after the ack message has a length of 28 - now, the packet (outlined in red) has a length of 61! What if we were to execute and expect back two output parameters (both <code class="highlighter-rouge">int</code>):</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">p1</span> <span class="n">int</span><span class="p">;</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">p2</span> <span class="n">int</span><span class="p">;</span>
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'d&lt;-42
                     a &lt;- as.integer(3)
                     b &lt;- as.integer(5)
                     OutputDataSet&lt;-InputDataSet'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT TOP(1) rand1 FROM dbo.rand_1M'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@a int OUTPUT, @b int OUTPUT'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">a</span> <span class="o">=</span> <span class="o">@</span><span class="n">p1</span> <span class="k">OUTPUT</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">b</span> <span class="o">=</span> <span class="o">@</span><span class="n">p2</span> <span class="k">OUTPUT</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span><span class="p">((</span><span class="n">ResultSet1</span> <span class="n">int</span><span class="p">));</span>
<span class="k">SELECT</span> <span class="o">@</span><span class="n">p1</span> <span class="k">As</span> <span class="n">OutParam1</span><span class="p">,</span> <span class="o">@</span><span class="n">p2</span> <span class="k">As</span> <span class="n">OutParam2</span>
</code></pre></div></div>
<p><strong>Code Snippet 7:</strong> <em>Code for 2 Output Parameters</em></p>

<p>The output from <em>Process Monitor</em> when executing the code in <em>Code Snippet 7</em> will show that the second packet (the one with a length of 61 above), now has a length of 94. With three <code class="highlighter-rouge">int</code> output parameters the length will be 127. So that particular packer definitely has something to do with output parameters, and for each new output parameters (of type <code class="highlighter-rouge">int</code> and a short parameter name) an additional 33 bytes are added to the packet. Seeing that with no output parameters the packet length was 28 bytes, so it would would make sense to assume that the output parameter packet has an overhead of 28 bytes (61 - 33 = 28).</p>

<p>To try and figure out what happens we’ll switch over to <em>WireShark</em>, and do some packet sniffing:</p>

<ul>
  <li>Run <em>WireShark</em> as admin.</li>
  <li>Choose the network adapter to “sniff” on. See <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> for discussion around loop-back adapters etc.</li>
  <li>Set a display filter on the port SQL Server listens on. In this case we want to sniff incoming packets, so the filter should be: <code class="highlighter-rouge">tcp.dstport==xyz</code> (<code class="highlighter-rouge">xyz</code> is the listening port of SQL Server).</li>
  <li>Apply the filter.</li>
</ul>

<p>When we execute the code in <em>Code Snippet 6</em> the output in <em>WireShark</em> will be:</p>

<p><img src="/images/posts/sql_r_services_18_wireshark1.png" alt="" /></p>

<p><strong>Figure 7:</strong> <em>Result and Output Parameter</em></p>

<p>In <em>Figure 7</em> we see some of the packets being received by SQL Server from the SqlSatallite, and the packet outlined in red is the one we are interested in (length of 61). When looking the data part of the packet (the 61 bytes) as a hex-dump it looks like so:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mo">01</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">d</span> <span class="mi">80</span> <span class="mi">3</span><span class="n">d</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mi">0</span><span class="n">b</span> <span class="n">eb</span> <span class="mi">62</span> <span class="n">a3</span> <span class="n">e1</span> <span class="n">fb</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">45</span>   <span class="p">....</span><span class="o">=</span><span class="p">...</span> <span class="p">..</span><span class="n">b</span><span class="p">...</span><span class="n">OE</span>
<span class="n">aa</span> <span class="n">ff</span> <span class="mi">44</span> <span class="n">be</span> <span class="n">ef</span> <span class="mi">1</span><span class="n">e</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">5</span><span class="n">d</span>  <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">..</span><span class="n">D</span><span class="p">...</span><span class="n">O</span><span class="p">]</span> <span class="p">...</span><span class="mf">.8</span><span class="p">...</span>
<span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">02</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="mf">8.</span><span class="p">......</span> <span class="p">........</span>
<span class="mi">40</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">03</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span>            <span class="err">@</span><span class="p">.</span><span class="n">a</span><span class="p">.....</span> <span class="p">.....</span>
</code></pre></div></div>
<p><strong>Code Snippet 8:</strong> <em>One Output Parameter Packet</em></p>

<p>What we see in <em>Code Snippet 8</em> is the “raw” hex dump (with ASCII hex on the right). Let’s see if it can be made somewhat more readable:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Hex 28 Bytes "Header"</span>
<span class="mo">01</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">d</span> <span class="mi">80</span> <span class="mi">3</span><span class="n">d</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mi">0</span><span class="n">b</span> <span class="n">eb</span> <span class="mi">62</span> <span class="n">a3</span> <span class="n">e1</span> <span class="n">fb</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">45</span>   <span class="p">....</span><span class="o">=</span><span class="p">...</span> <span class="p">..</span><span class="n">b</span><span class="p">...</span><span class="n">OE</span>
<span class="n">aa</span> <span class="n">ff</span> <span class="mi">44</span> <span class="n">be</span> <span class="n">ef</span> <span class="mi">1</span><span class="n">e</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">5</span><span class="n">d</span>  <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>               <span class="p">..</span><span class="n">D</span><span class="p">...</span><span class="n">O</span><span class="p">]</span> <span class="p">....</span>

<span class="c1">// Hex 33 Bytes "Payload"</span>
<span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">04</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="mf">8.</span><span class="p">.</span><span class="mf">.8</span><span class="p">...</span> <span class="p">........</span>
<span class="mo">02</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">40</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span>  <span class="mo">04</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">03</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">....</span><span class="err">@</span><span class="p">.</span><span class="n">a</span><span class="p">.</span> <span class="p">........</span>
<span class="mo">01</span>                                                 <span class="p">.</span>

<span class="c1">// ASCII Hex 28 Bytes "Header"</span>
<span class="p">....</span><span class="o">=</span><span class="p">.....</span><span class="n">b</span><span class="p">...</span><span class="n">OE</span><span class="p">..</span><span class="n">D</span><span class="p">...</span><span class="n">O</span><span class="p">]....</span>

<span class="c1">// ASCII Hex 33 Bytes "Payload"</span>
<span class="mf">8.</span><span class="p">.</span><span class="mf">.8</span><span class="p">...............</span><span class="err">@</span><span class="p">.</span><span class="n">a</span><span class="p">..........</span>
</code></pre></div></div>
<p><strong>Code Snippet 9:</strong> <em>Formatted One Output Parameter Packet</em></p>

<p>I have tried to “finesse” the packet in <em>Code Snippet 9</em> by breaking it up in a “header” part, which is the first 28 bytes and a “payload” part. I have also taken the ASCII hex and tried to make it more readable. What we see from <em>Code Snippet 9</em> is something like this:</p>

<ul>
  <li>The parameter name is in the packet as double byte characters. It is human readable in the ASCII hex representation where it starts at byte 21 in the “payload”, and you can see it in the hex dump as well at byte 21: <code class="highlighter-rouge">40 00 61 00</code> (<code class="highlighter-rouge">@a</code>).</li>
  <li>The value of the parameter starts at byte 29 in the payload: hex <code class="highlighter-rouge">03 00 00 00</code>.</li>
  <li>It looks like there is an “end” byte, hex <code class="highlighter-rouge">01</code> at the end of the packet, or at least at the end of the data that defines the parameter.</li>
  <li>There are 4 bytes between the end of the parameter name, and where the value is.</li>
</ul>

<p>Let’s see if we can further confirm what we see in <em>Code Snippet 9</em>, by executing the code in <em>Code Snippet 7</em> and capture the packets in <em>WireShark</em>. :</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Hex 28 Bytes "Header"</span>
<span class="mo">01</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">d</span> <span class="mi">80</span> <span class="mi">5</span><span class="n">e</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mi">3</span><span class="n">e</span> <span class="n">c0</span> <span class="mi">89</span> <span class="n">ed</span> <span class="mi">08</span> <span class="n">e0</span> <span class="n">b8</span> <span class="mi">4</span><span class="n">d</span>   <span class="p">....</span><span class="o">^</span><span class="p">...</span> <span class="o">&gt;</span><span class="p">......</span><span class="n">M</span>
<span class="mi">9</span><span class="n">f</span> <span class="mi">5</span><span class="n">b</span> <span class="mi">86</span> <span class="n">be</span> <span class="n">c4</span> <span class="n">ef</span> <span class="n">c6</span> <span class="n">eb</span>  <span class="mo">02</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>               <span class="p">.[......</span> <span class="p">....</span>


<span class="c1">// Hex 33 Bytes "Payload" Parameter 1 @a</span>
<span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">04</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="mf">8.</span><span class="p">.</span><span class="mf">.8</span><span class="p">...</span> <span class="p">........</span>
<span class="mo">02</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">40</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span>  <span class="mo">04</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">03</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">....</span><span class="err">@</span><span class="p">.</span><span class="n">a</span><span class="p">.</span> <span class="p">........</span>
<span class="mo">01</span>                                                 <span class="p">.</span>

<span class="c1">// Hex 33 Bytes "Payload" Parameter 2 @b</span>
<span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">04</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="mf">8.</span><span class="p">.</span><span class="mf">.8</span><span class="p">...</span> <span class="p">........</span>
<span class="mo">02</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">40</span> <span class="mo">00</span> <span class="mi">62</span> <span class="mo">00</span>  <span class="mo">04</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">05</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">....</span><span class="err">@</span><span class="p">.</span><span class="n">b</span><span class="p">.</span> <span class="p">........</span>
<span class="mo">01</span>                                                 <span class="p">.</span>
</code></pre></div></div>
<p><strong>Code Snippet 10:</strong> <em>Formatted Two Output Parameters Packet</em></p>

<p>As you see in <em>Code Snippet 10</em>, I have broken up the packet in three parts; “header” and one “payload” per parameter. I did it as, when looking at the “raw” packet, it was obvious that each parameter started with hex <code class="highlighter-rouge">38 00 00 00</code> and ended with hex <code class="highlighter-rouge">01</code>. So <em>Code Snippet 10</em> confirms our assumptions above. It also shows another interesting thing: look in the “header” at the last four bytes. In <em>Code Snippet 9</em> the value was hex <code class="highlighter-rouge">01 00 00 00</code>, which is decimal 1, and in <em>Code Snippet 10</em> it is hex <code class="highlighter-rouge">02 00 00 00</code>, decimal 2. Is it a coincidence that the number of parameters in <em>Code Snippet 9</em> was 1, and in <em>Code Snippet 10</em> 2? I do not think so, as when I tested with more parameters those 4 bytes always showed the number of parameters being returned.</p>

<h4 id="sql-server-code">SQL Server Code</h4>

<p>Now when we know where the output parameters come back and what the packets look like, let’s look at at what happens inside SQL Server when that output parameter packet comes back.</p>

<p>In <a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Internals - XVII</a> we looked for interesting routines in <code class="highlighter-rouge">x sqllang!CUDXR_ExternalScript*</code> for handling rows coming back from the SqlSatellite. Let’s do the same for output arguments:</p>

<ul>
  <li>Start up <em>WinDbg</em> as admin - once again, <strong>DO NOT DO THIS ON A PRODUCTION SERVER</strong>.</li>
  <li>Attach to the SQL Server process.</li>
  <li>Execute in the <em>WinDbg</em> console: <code class="highlighter-rouge">x sqllang!CUDXR_ExternalScript*Process*Arguments*</code></li>
</ul>

<p>The execute statement results in one routine: <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ProcessOutputArguments</code>, and - if I may say so myself - it looks like we’re onto something here. To confirm we’re on the right track, set a breakpoint at <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ProcessOutputArguments</code> and change the code in <em>Code Snippet 6</em> to have a <code class="highlighter-rouge">Sys.sleep</code> in the script so we can better determine what is being called when:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">p1</span> <span class="n">int</span><span class="p">;</span>
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(10)
                     d&lt;-42
                     a &lt;- as.integer(3)
                     OutputDataSet&lt;-InputDataSet'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT TOP(1) rand1 FROM dbo.rand_1M'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@a int OUTPUT'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">a</span> <span class="o">=</span> <span class="o">@</span><span class="n">p1</span> <span class="k">OUTPUT</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span><span class="p">((</span><span class="n">ResultSet1</span> <span class="n">int</span><span class="p">));</span>
<span class="k">SELECT</span> <span class="o">@</span><span class="n">p1</span> <span class="k">As</span> <span class="n">OutParam1</span>
</code></pre></div></div>
<p><strong>Code Snippet 11:</strong> <em>Base Code for Output Parameters with Pause</em></p>

<p>Execute the code in <em>Code Snippet 11</em>, and when the breakpoint is hit (after the sleep), check the call-stack: <code class="highlighter-rouge">k</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputArguments</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span><span class="o">+</span><span class="mh">0x139</span>
<span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span><span class="o">+</span><span class="mh">0x196</span>
<span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">GetRow</span><span class="o">+</span><span class="mh">0x81</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span><span class="o">+</span><span class="mh">0x4dc</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtSelect</span><span class="o">::</span><span class="n">XretExecute</span><span class="o">+</span><span class="mh">0x322</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;+</span><span class="mh">0x40d</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span><span class="o">+</span><span class="mh">0xa9e</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x983</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span><span class="o">+</span><span class="mh">0x140e</span>
<span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 11:</strong> <em>Call Stack Leading up to ProcessOutputArguments</em></p>

<p>Aha, <em>Code Snippet 12</em> show how <code class="highlighter-rouge">ProcessOutputArguments</code> is part of <code class="highlighter-rouge">PullRow</code> which we looked at in <a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Internals - XVII</a>, and which we mentioned in the <em>Recap</em> above. If we look back at <code class="highlighter-rouge">PullRow</code>, a very, very abbreviated call-stack looked like so:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputSchema</span>
    <span class="p">...</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
    <span class="p">...</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">OutputRow</span>
      <span class="p">...</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">EndOutput</span>
      <span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 12:</strong> <em>Highly Abbreviated PullRow Call Stack</em></p>

<p>Looking at the <code class="highlighter-rouge">PullRow</code> call-stack in <em>Code Snippet 12</em>, the question is where <code class="highlighter-rouge">ProcessOutputArguments</code> fit in? The call-stack in <em>Code Snippet 11</em> shows how <code class="highlighter-rouge">ProcessOutputArguments</code> is called directly from <code class="highlighter-rouge">PullRow</code>, so is that before or after <code class="highlighter-rouge">ProcessResultRows</code>? To figure this out, what do we do - well, we’ll set a breakpoint at <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ProcessResultRows</code>, in addition to the breakpoint at <code class="highlighter-rouge">ProcessOutputArguments</code>. When we execute we see that <code class="highlighter-rouge">ProcessResultRows</code> is called twice, followed by <code class="highlighter-rouge">ProcessOutputArguments</code>. From that we can say that the call-stack also including <code class="highlighter-rouge">ProcessOutputArguments</code> looks something like so:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputSchema</span>
    <span class="p">...</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
    <span class="p">...</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">OutputRow</span>
      <span class="p">...</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">EndOutput</span>
      <span class="p">...</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputArguments</span>
    <span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 13:</strong> <em>Highly Abbreviated PullRow Call Stack Including ProcessOutputArguments</em></p>

<p>We could have reached the same conclusion as we came to in <em>Code Snippet 13</em> if we had had a look at the “trace and watch” file we did in <a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Internals - XVII</a> for <code class="highlighter-rouge">PullRow</code>: <code class="highlighter-rouge">pull_row_full.txt</code>.</p>

<blockquote>
  <p><strong>NOTE:</strong> If you wonder why there are two <code class="highlighter-rouge">ProcessResultRows</code> calls when only one row is coming back - go back up to the <em>Recap</em>, where it is explained.</p>
</blockquote>

<p>To finish off with, let’s see what happens inside <code class="highlighter-rouge">ProcessOutputArguments</code>:</p>

<ul>
  <li>Disable the <code class="highlighter-rouge">ProcessResultRows</code> breakpoint, but keep the <code class="highlighter-rouge">ProcessOutputArguments</code> breakpoint.</li>
  <li>Execute the code in <em>Code Snippet 11</em> (the one with <code class="highlighter-rouge">Sys.sleep</code>).</li>
  <li>When the <code class="highlighter-rouge">ProcessOutputArguments</code> breakpoint is hit, do a “trace and watch”: <code class="highlighter-rouge">wt -l4</code> (trace 4 levels deep).</li>
</ul>

<p>When the trace has finished you can copy it to a file, to make it easier to follow what happens. When looking at the file, we see something like this:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputArguments</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOutputArgumentsInternal</span>
    <span class="p">...</span>
    <span class="n">sqlllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadAllPackets</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">GetNextMessage</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">RetrieveMessage</span>
    <span class="p">...</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOutputArgsFromPackets</span>
      <span class="p">...</span>
      <span class="p">...</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageArgument</span><span class="o">::</span><span class="n">ReadPayload</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageArgument</span><span class="o">::</span><span class="n">ReadArgsTypeInfo</span>
          <span class="p">...</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageArgument</span><span class="o">::</span><span class="n">ReadArgsName</span>
        <span class="p">...</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageArgument</span><span class="o">::</span><span class="n">ReadArgsValueSize</span>
        <span class="p">...</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageArgument</span><span class="o">::</span><span class="n">ReadArgsValue</span>
        <span class="p">...</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageArgument</span><span class="o">::</span><span class="n">ReadPayload</span>
      <span class="p">...</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOutputArgsFromPackets</span>
    <span class="p">...</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOutputArgumentsInternal</span>
  <span class="p">...</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputArguments</span>
</code></pre></div></div>
<p><strong>Code Snippet 14:</strong> <em>*Routines During ProcessOutputArguments</em></p>

<p>From <em>Code Snippet 14</em> we see how the argument packet is being read, from there we read the type information, followed by the argument name and value. If there are more than one output argument, the do it all over again. Oh, and if there are no output parameters we “bail” out after the <code class="highlighter-rouge">ReadPayload</code> routine.</p>

<h2 id="summary">Summary</h2>

<p>In this post we have looked at what happens if we have a result set definition when executing <code class="highlighter-rouge">sp_execute_external_script</code>. We saw that the result set definition was handled during <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ProcessOutputSchema</code> and the routine that did this was <code class="highlighter-rouge">sqllang!CExecWithResultSetsCOut::SendMetaImpl</code>. The <code class="highlighter-rouge">SendMetaImpl</code> is used not only for external scripts but for all executions with result set definitions.</p>

<p>We then went on to how output parameters are handled and we started looking at where the parameters are returned and what the packet looked like:</p>

<ul>
  <li>The output parameters is being returned in the second packet coming back from the SqlSatellite after the ack packet has been sent to the SqlSatellite.</li>
  <li>The packet returning the output parameters has a 28 bytes “header”.</li>
  <li>The header contains the number of parameters being returned.</li>
  <li>There is one “payload” per output parameter.</li>
  <li>The parameter “payload” contains the name of the output parameter as double byte characters.</li>
  <li>The payload consists of 20 bytes before the name of the parameter.</li>
  <li>After the parameter name is 4 bytes.</li>
  <li>The 4 bytes are followed by the parameter value.</li>
  <li>At the end of the parameter payload is an “end” byte, hex <code class="highlighter-rouge">01</code>.</li>
  <li>The size of the value is the data type size for numerics, and storage size for alpha-numerics.</li>
  <li>For alpha-numerics there are 2 bytes pre-pending the value. These 2 bytes indicate the size.</li>
</ul>

<p>An example of this would be what we receive if we were to execute the following:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">p2</span> <span class="n">int</span> 
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">p3</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'d&lt;-42
                     #outParam &lt;- d
               a &lt;- as.integer(3)
               b &lt;- "abcd"
                     OutputDataSet&lt;-InputDataSet'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT TOP(1) rand1 FROM dbo.rand_1M'</span> <span class="c1">--2051    --51 --94</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@a int OUTPUT, @b varchar(10) OUTPUT'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">a</span> <span class="o">=</span> <span class="o">@</span><span class="n">p2</span> <span class="k">OUTPUT</span>
         <span class="p">,</span> <span class="o">@</span><span class="n">b</span> <span class="o">=</span> <span class="o">@</span><span class="n">p3</span> <span class="k">OUTPUT</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span><span class="p">((</span><span class="n">ResultSet1</span> <span class="n">int</span><span class="p">));</span>
<span class="k">SELECT</span> <span class="o">@</span><span class="n">p2</span> <span class="k">AS</span> <span class="n">IntParam</span><span class="p">,</span> <span class="o">@</span><span class="n">p3</span> <span class="k">AS</span> <span class="n">StringParam</span>
</code></pre></div></div>
<p><strong>Code Snippet 15:</strong> <em>Two Output Params: Integer and Varchar</em></p>

<p>The code in <em>Code Snippet 15</em> reults in two output parameters: one - <code class="highlighter-rouge">int</code> - with a value of 3, and the other - <code class="highlighter-rouge">varchar</code> - with a value of “abcd”. The output parameter packet looks something like so after I have formatted it a bit:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// header</span>
<span class="mo">01</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">d</span> <span class="mi">80</span> <span class="mi">60</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">fc</span> <span class="n">f6</span> <span class="mi">1</span><span class="n">d</span> <span class="n">a8</span> <span class="mi">98</span> <span class="n">e3</span> <span class="mi">13</span> <span class="mi">41</span> <span class="n">be</span> <span class="mi">12</span> <span class="n">d2</span> <span class="mi">7</span><span class="n">f</span> <span class="mi">79</span> <span class="n">ad</span> <span class="n">e4</span> <span class="mi">47</span> 
<span class="mo">02</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="c1">// number of parameters</span>

 <span class="c1">// payload int param @a, value 3</span>
<span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">02</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> 
<span class="mi">40</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span> <span class="c1">// parameter name</span>
<span class="mo">04</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="c1">// 4 bytes</span>
<span class="mo">03</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="c1">// value</span>
<span class="mo">01</span> <span class="c1">// end byte</span>

<span class="c1">//payload varchar param @b, value 'abcd'</span>
<span class="n">a7</span> <span class="mo">02</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">a7</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">08</span> <span class="n">d0</span> <span class="mo">00</span> <span class="mi">34</span> <span class="mo">02</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> 
<span class="mi">40</span> <span class="mo">00</span> <span class="mi">62</span> <span class="mo">00</span> <span class="c1">// parameter name</span>
<span class="mo">06</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="c1">// 4 bytes</span>
<span class="mo">04</span> <span class="mo">00</span> <span class="c1">// size of parameter value</span>
<span class="mi">61</span> <span class="mi">62</span> <span class="mi">63</span> <span class="mi">64</span> <span class="c1">// value</span>
<span class="mo">01</span> <span class="c1">// end byte</span>
</code></pre></div></div>
<p><strong>Code Snippet 16:</strong> <em>Output Parameter Packet</em></p>

<p>As you see in <em>Code Snippet 16</em>, I have separated the “header” from the “payload”, and also made the hex somewhat more readable by separating out the various parts we discussed above.</p>

<p>When output arguments are returned to SQL Server, they are handled by the <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ProcessOutputArguments</code> routine which is part of the <code class="highlighter-rouge">PullRow</code> call. I have taken the <em>Figure 1</em> in the recap and altered it to show the flow for output arguments:</p>

<p><img src="/images/posts/sql_r_services_18_flow.png" alt="" /></p>

<p><strong>Figure 8:</strong> <em>Code Flow Receiving Output Arguments from SqlSatellite</em></p>

<p>The numbered arrows shows the communication out to and in from SQL Server, and in what order it happens, there is not much of a difference from what is in the <em>Recap</em>, except for the added point 11:</p>

<ol>
  <li>SQL Server opens named pipe connection to the launchpad service.</li>
  <li>Message sent to the launchpad service.</li>
  <li>After the call above, the SqlSatellite opens a TCP/IP connection to SQL Server.</li>
  <li>SQL Server sends the first packet to the SQL Satellite for authentication purposes.</li>
  <li>A second authentication packet is sent to SqlSatellite.</li>
  <li>The script is sent from inside <code class="highlighter-rouge">sqllang!CSatelliteProxy::PostSetupMessage</code></li>
  <li>The data for <code class="highlighter-rouge">@input_data_1</code> is sent together with two end packets.</li>
  <li>Packet are coming back to SQL Server containing meta-data and the actual data.</li>
  <li><code class="highlighter-rouge">PullRow</code> is being signaled.</li>
  <li>Execution continues to process meta-data as well as result rows.</li>
  <li>After processing result rows, output arguments are processed.</li>
</ol>

<h2 id="-finally">~ Finally</h2>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2018/01/10/microsoft-sql-server-r-services-internals-xviii/&text=Microsoft SQL Server R Services - Internals XVIII&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2018/01/10/microsoft-sql-server-r-services-internals-xviii/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2018/01/10/microsoft-sql-server-r-services-internals-xviii/
         &title=Microsoft SQL Server R Services - Internals XVIII
         &summary=Blog post: A look at how output parameters are handled in SQL Server R Services
         &source=http://www.nielsberglund.com/2018/01/10/microsoft-sql-server-r-services-internals-xviii/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2018/01/10/microsoft-sql-server-r-services-internals-xviii/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-machine-learning-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Machine Learning Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#windbg">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WinDbg</span>
    </a>
  
    
    <a href="/tags/#launchpad">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Launchpad</span>
    </a>
  
    
    <a href="/tags/#rterm-exe">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">RTerm.exe</span>
    </a>
  
    
    <a href="/tags/#bxl">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">BXL</span>
    </a>
  
    
    <a href="/tags/#process-monitor">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Process Monitor</span>
    </a>
  
    
    <a href="/tags/#wireshark">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WireShark</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2018/01/10/microsoft-sql-server-r-services-internals-xviii/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2018/01/10/microsoft-sql-server-r-services-internals-xviii/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/12/interesting-stuff-week-32/">
            Interesting Stuff - Week 32
            <small>12 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
