<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Microsoft SQL Server R Services - Internals XIX &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Microsoft SQL Server R Services - Internals XIX</h1>
  <div class="post-subheading">
  <span class="post-date">20 Jan 2018</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>This is the 20:th post in a series about <strong>Microsoft SQL Server R Services</strong>, and the 19:th post that drills down into the internal of how it works. To see other posts (including this) in the series, go to <a href="/series/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a>.</p>

<p>We are nearing the end of the <strong>Internals</strong> series, and if we look at what we have covered, we have almost come full circle.</p>

<!--more-->

<h2 id="recap">Recap</h2>

<p>In this <em>Recap</em>, let’s look back at some of the posts that has “bearing” on this particular post.</p>

<p>The <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I</a> post discussed how SQL Server opened a named pipe connection into, and called the, launchpad service when the proc <code class="highlighter-rouge">sp_execute_external_script</code> is executed. In <a href="/2017/07/22/microsoft-sql-server-r-services-internals-viii/">Internals - VIII</a> we looked at what different components are involved when the procedure executes:</p>

<ul>
  <li>SQL Server calls into the launchpad service.</li>
  <li>The launchpad service calls into the <code class="highlighter-rouge">Rlauncher.dll</code>.</li>
  <li>The <code class="highlighter-rouge">Rlauncher.dll</code> creates Rterm processes.</li>
  <li>Through Rterm, the <code class="highlighter-rouge">R.dll</code> is loaded together with <code class="highlighter-rouge">RxLink.dll</code>.</li>
  <li>The <code class="highlighter-rouge">RxLink.dll</code> creates the <code class="highlighter-rouge">BxlServer.exe</code> process.</li>
  <li>To coordinate with SQL Server, <code class="highlighter-rouge">BxlServer.exe</code> loads <code class="highlighter-rouge">BxServerLink.dll</code>.</li>
</ul>

<p>The above can be illustrated as in <em>Figure 1</em> below</p>

<p><img src="/images/posts/sql_r_services_8_arch_overview.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Components In Play</em></p>

<p>Based on the above, the question we then tried to answer in <a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Internals - IX</a> was how the components are communicating and what sort of communication mechanisms there are. We determined that there were different communication mechanisms, and used a figure to illustrate those various mechanisms:</p>

<p><img src="/images/posts/sql_r_services_9_comms2.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>How Communication Happens</em></p>

<p>The numbers indicate:</p>

<ul>
  <li>1 - named pipe.</li>
  <li>2 - IOCP.</li>
  <li>3 - named pipe.</li>
  <li>4 - TCP/IP</li>
</ul>

<p>In Internals - <a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">XVI</a> and <a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">XVII</a> we looked at how result sets were returned from the SqlSatellite to SQL Server, and we realized the data were delivered via data packets over the TCP connection between the SqlSatellite and SQL Server. In <a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Internals - XVII</a>, we also tried to understand what happened, code wise, in SQL Server when data packets were returned, and the following figure were used to illustrate the flow:</p>

<p><img src="/images/posts/sql_r_services_17_flow.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>Code Flow Receiving Data from SqlSatellite</em></p>

<p>Finally, in <a href="/2018/01/10/microsoft-sql-server-r-services-internals-xviii/">Internals - XVIII</a> we talked about how output parameters are handled between the SqlSatellite and SQL Server and we saw how the output parameters come back in a data packet over the TCP connection between the SqlSatellite and SQL Server. They are handled in SQL Server as per this figure:</p>

<p><img src="/images/posts/sql_r_services_18_flow.png" alt="" /></p>

<p><strong>Figure 4:</strong> <em>Code Flow Receiving Output Arguments from SqlSatellite</em></p>

<p>The numbered arrows in both <em>Figure 3</em> and <em>Figure 4</em> show the communication out to and in from SQL Server, and in what order it happens:</p>

<ol>
  <li>SQL Server opens named pipe connection to the launchpad service.</li>
  <li>Message sent to the launchpad service.</li>
  <li>After the call above, the SqlSatellite opens a TCP/IP connection to SQL Server.</li>
  <li>SQL Server sends the first packet to the SQL Satellite for authentication purposes.</li>
  <li>A second authentication packet is sent to SqlSatellite.</li>
  <li>The script is sent from inside <code class="highlighter-rouge">sqllang!CSatelliteProxy::PostSetupMessage</code></li>
  <li>The data for <code class="highlighter-rouge">@input_data_1</code> is sent together with two end packets.</li>
  <li>Packet are coming back to SQL Server containing meta-data and the actual data.</li>
  <li><code class="highlighter-rouge">PullRow</code> is being signaled.</li>
  <li>Execution continues to process meta-data as well as result rows.</li>
  <li>After processing result rows, output arguments are processed.</li>
</ol>

<p>So, we have seen in various posts how meta-data, result-sets and output parameters, etc. are send to SQL server from the SqlSatellite using the TCP connection. In this post we’ll look at other types of data going back to SQL server.</p>

<h2 id="housekeeping">Housekeeping</h2>

<p>Before we “dive” into todays topics let’s look at the code and the tools we’ll use. This section is here here for those of who want to follow along in what we’re doing in the posts.</p>

<h4 id="helper-tools">Helper Tools</h4>

<p>To help us figure out the things we want, we will use <em>Process Monitor</em>, and <em>WinDbg</em>:</p>

<ul>
  <li><em>Process Monitor</em>, will be used it to filter TCP traffic. If you want to refresh your memory about how to do it, we covered that in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> as well as in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>.</li>
  <li>In the last few posts I have used <em>WinDbg preview</em> a my debugger, but in this post I am reverting back to <em>WinDbg</em> “classic”. If you need help with setting it up, that is covered in <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I</a>.</li>
</ul>

<h4 id="code">Code</h4>

<p>In this post we won’t need a specific database, we’ll just execute variants of some very, very basic code:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(10)
                             d &lt;- 42'</span><span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Base Code to Execute</em></p>

<p>The <code class="highlighter-rouge">Sys.sleep</code> is in the script to make it easier for us to see what happens, and in what order.</p>

<h2 id="messages">Messages</h2>

<p>What is this <em>Messages</em> in the header of this section? I am using that name for data that is not result-set data or output parameter values. E.g “stuff” that appears in the <em>Messages</em> tab in <em>SSMS</em>. Execute the code in <em>Code Snippet 2</em> and you see something like so (you can comment out the <code class="highlighter-rouge">Sys.sleep</code> if you wish):</p>

<p><img src="/images/posts/sql_r_services_19_msgs1.png" alt="" /></p>

<p><strong>Figure 5:</strong> <em>Message in SSMS</em></p>

<p>The question is that, were does the message in <em>Figure 5</em> originate from? What you see in <em>Figure 5</em> may not be the best example, so let’s look at the following code:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(10)
                             cat("Hello World")
                             d &lt;- 42'</span><span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Code with Print</em></p>

<p>When the code in <em>Code Snippet 2</em> is executed (once again, you can comment out the <code class="highlighter-rouge">Sys.sleep</code>), the output looks like so:</p>

<p><img src="/images/posts/sql_r_services_19_msgs2.png" alt="" /></p>

<p><strong>Figure 6:</strong> <em>Message From cat Statement</em></p>

<p>In <em>Figure 6</em> it is clear that the “message” comes from the R engine, and the question is how does it get to SQL Server? As mentioned above, we have seen in previous posts how the data has been sent in data packets over the TCP connection. Is that perhaps the same thing here, and how do we find out? We’ll start with what we saw in <em>Figure 5</em> - the output from <em>Code Snippet 1</em>.</p>

<h4 id="acknowledgments">Acknowledgments</h4>

<p>When writing this post I realized that what we see in <em>Figure 5</em> is the result of an acknowledgment from the R “environment”, that the “job” is finished, and below we’ll see how I came to that conclusion.</p>

<p>We’ll use <em>Process Monitor</em> to begin with:</p>

<ul>
  <li>Run <em>Process Monitor</em> as admin and load the filter we used in <a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Internals - XVI</a> where we filtered for <code class="highlighter-rouge">TCP Send</code> and <code class="highlighter-rouge">TCP Receive</code> for <code class="highlighter-rouge">BxlServer.exe</code>.</li>
  <li>Execute the code in <em>Code Snippet 1</em> (without the <code class="highlighter-rouge">Sys.sleep</code> if you want) and look at the output from <em>Process Monitor</em>:</li>
</ul>

<p><img src="/images/posts/sql_r_services_19_procmon1.png" alt="" /></p>

<p><strong>Figure 7:</strong> <em>Return Packets</em></p>

<p>As you see in <em>Figure 7</em> three packets are returned to SQL Server after execution (outlined in red), and we have discussed in previous posts what they are. Potentially the “Commands completed successfully.” message could have been part of one of those three packets, but from what we know it is unlikely. We should be able to determine if a message is part of any of those three packets by executing the code in <em>Code Snippet 2</em>, but with a <code class="highlighter-rouge">cat</code> statement like this: <code class="highlighter-rouge">cat("A very, very, very long string to see if the packet sizes differ")</code>.</p>

<p>The idea is that having a long message string, we should see an impact on either of the data packets being sent back to SQL Server. However after we execute, the packets sent back to SQL Server look no different, so it seems that the message is sent back by other means, or generated in some other way.</p>

<p>Ok, so if the data is not sent back on the TCP connection between the SqlSatellite and SQL Server, then the data has to go back over the launchpad connection. Can we somehow see if that is what’s happening? If we believe that some data is passed from the R engine to SQL Server via the launchpad service, then the data has to be passed over the IOCP as well as the named pipes. So if we can “trap” the message when it arrives in the launchpad service, also see if/when it is sent back to SQL Server, and then finally “catch” it in SQL Server. That should “prove” out theory.</p>

<blockquote>
  <p><strong>NOTE:</strong> As we only have symbol files for SQL Server and the launchpad service, we need to do it the way it is outlined above.</p>
</blockquote>

<p>Right:</p>

<ul>
  <li>Start up two instances of <em>WinDbg</em> as admin.</li>
  <li>Attach <em>WinDbg</em> to the SQL Server process (<code class="highlighter-rouge">sqlservr.exe</code>), and the launchpad process (<code class="highlighter-rouge">launchpad.exe</code>) - <strong>DO NOT DO THIS ON A PRODUCTION SERVER</strong>.</li>
</ul>

<p>Let’s start with the launchpad service and search for routines that might be involved in reading data coming into the launchpad service as well as sending data out to SQL Server. So let’s start with looking for routines in the <code class="highlighter-rouge">launchpad</code> module: <code class="highlighter-rouge">x launchpad!*Read*</code>. When you execute that, you see there are quite a few. However when browsing through the output, there are some that looks interesting in the <code class="highlighter-rouge">CSQLSatelliteConnection</code> class:</p>

<ul>
  <li><code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::ReadCallBack</code></li>
  <li><code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::ReadCallBackInternal</code></li>
  <li><code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::ReadOneFullMessage</code></li>
</ul>

<p>Let’s set a breakpoint at <code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::ReadOneFullMessage</code> and execute the code in <em>Code Snippet 1</em>, this time ensure that the <code class="highlighter-rouge">Sys.sleep</code> statement is in the code, so that if the breakpoint is hit, we’ll know that it is after execution. Sure enough the breakpoint is hit almost immediately, and after letting the code continue, there is a pause and the breakpoint is hit a second time. At the second “hit” have a look at the call-stack: <code class="highlighter-rouge">k</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">ReadOneFullMessage</span>
<span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">ReadCallBackInternal</span><span class="o">+</span><span class="mh">0x37</span>
<span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">ReadCallBack</span><span class="o">+</span><span class="mh">0x39</span>
<span class="n">launchpad</span><span class="o">!</span><span class="n">SNIReadDone</span><span class="o">+</span><span class="mh">0x151</span>
<span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Node</span><span class="o">::</span><span class="n">ListenOnIOCompletionPort</span><span class="o">+</span><span class="mh">0x384</span>
<span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Task</span><span class="o">::</span><span class="n">Param</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x231</span>
<span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">RunTask</span><span class="o">+</span><span class="mh">0xaa</span>
<span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Call Stack at ReadOneFullMessage</em></p>

<p>The call-stack we see in <em>Code Snippet 3</em> clearly shows that our “hunch” about IOCP seems correct (<code class="highlighter-rouge">sqldk!SOS_Node::ListenOnIOCompletionPort</code>), and we see that the call flow includes all three <code class="highlighter-rouge">Read...</code> routines that we found above. If we wanted to see what happens inside the routines, we can disable the break-point at <code class="highlighter-rouge">ReadOneFullMessage</code> and set a break-point at <code class="highlighter-rouge">ReadCallBackInternal</code>instead, and then execute the code in <em>Code Snippet 1</em> again. When the <code class="highlighter-rouge">ReadCallBackInternal</code> break-point is hit the second time (after the pause), do a “trace and watch” <code class="highlighter-rouge">wt</code> and let the code run to completion.</p>

<blockquote>
  <p><strong>NOTE:</strong> The reason why you set the break-point on <code class="highlighter-rouge">ReadCallBackInternal</code>, and not <code class="highlighter-rouge">ReadOneFullMessage</code> is that a <code class="highlighter-rouge">wt</code> on <code class="highlighter-rouge">ReadOneFullMessage</code> won’t give you much information at all, whereas <code class="highlighter-rouge">ReadCallBackInternal</code> shows you quite a lot of interesting “stuff”.</p>
</blockquote>

<p>When the code has run to completion, copy the trace to a separate file, to make it easier to investigate:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">ReadCallBackInternal</span>
  <span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">ReadOneFullMessage</span>
  <span class="p">...</span>
  <span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">DeliverMessage</span>
  <span class="p">...</span>
  <span class="n">launchpad</span><span class="o">!</span><span class="n">EventInternal</span><span class="o">&lt;</span><span class="n">SuspendQueueSLock</span><span class="o">&gt;::</span><span class="n">SignalAll</span>
  <span class="p">...</span>
    <span class="p">...</span>
      <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">PrepareWorkerForResume</span>
      <span class="p">...</span>
      <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">RunnableQueueInsert</span>
        <span class="n">sqldk</span><span class="o">!</span><span class="n">GroupWorkerQueue</span><span class="o">::</span><span class="n">Enqueue</span>
        <span class="p">...</span>
      <span class="p">...</span>  
    <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">WakeUpScheduler</span>
    <span class="p">...</span>
      <span class="n">launchpad</span><span class="o">!</span><span class="n">Np</span><span class="o">::</span><span class="n">ReadAsync</span>
      <span class="p">...</span>
    <span class="p">...</span>  
    <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_RWLock</span><span class="o">::</span><span class="n">ReleaseLock</span>
  <span class="p">...</span>    
</code></pre></div></div>
<p><strong>Code Snippet 4:</strong> <em>Routines During ReadCallBackInternal</em></p>

<p>When I looked at the trace, I found some interesting routines, which are shown in <em>Code Snippet 4</em>. When I see the code above, I can’t help but to think about what we saw in <a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Internals - XVII</a>, where <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::PullRow</code> was signaled by <code class="highlighter-rouge">sqllang!EventInternal&lt;SuspendQueueSLock&gt;::SignalAll</code>. Here the signal happens through <code class="highlighter-rouge">launchpad!EventInternal&lt;SuspendQueueSLock&gt;::SignalAll</code>, and after the signal, “stuff” is enqueued and locks are released. If this is the case, what is being signaled then?</p>

<p>Hmm, let us think back one of the posts in the beginning of the <strong>Internals</strong> “journey”, and specifically <a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Internals - II</a>. In that post we looked at the code-flow, when SQL Server called into the launchpad service, and we saw a figure like so:</p>

<p><img src="/images/posts/sql-launchpad-r-post.png" alt="" /></p>

<p><strong>Figure 8:</strong> <em>Launchpad Service Call Flow</em></p>

<p>From <em>Figure 8</em> we see how the routine <code class="highlighter-rouge">launchpad!CLaunchContext::LaunchServTask</code> seems to be the “main” method. Maybe that’s what’s being signaled, let’s see if we can figure it out:</p>

<ul>
  <li>Disable the existing break-points in the launchpad process.</li>
  <li>Set a break-point at <code class="highlighter-rouge">launchpad!CLaunchContext::LaunchServTask</code>.</li>
  <li>Change the <code class="highlighter-rouge">Sys.sleep</code> in <em>Code Snippet 1</em> to <code class="highlighter-rouge">Sys.sleep(120)</code>.</li>
</ul>

<p>Execute the code and when you hit the <code class="highlighter-rouge">LaunchServTask</code> break-point, do a <code class="highlighter-rouge">wt -l4</code> (trace four levels deep). The execution will continue, until the control has been passed over to the R engine, and its various components. At this stage <code class="highlighter-rouge">LaunchServTask</code> has not finished execution, and you’ll see something like so at the end of the trace:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
  <span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">GetNextMessage</span>
    <span class="n">launchpad</span><span class="o">!</span><span class="n">EventInternal</span><span class="o">&lt;</span><span class="n">SuspendQueueSLock</span><span class="o">&gt;::</span><span class="n">Wait</span>
    <span class="p">...</span>
      <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Suspend</span>
      <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">SuspendNonPreemptive</span>
</code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>Wait for Continuation</em></p>

<p>So, in <em>Code Snippet 5</em>, we see where <code class="highlighter-rouge">LaunchServTask</code> “waits” for something to complete. When the script code has finished executing (after the <code class="highlighter-rouge">Sys.sleep</code>), you’ll see the trace continue - and it will continue with:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">SwitchContext</span>
        <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Switch</span>
      <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">SuspendNonPreemptive</span>
    <span class="n">launchpad</span><span class="o">!</span><span class="n">EventInternal</span><span class="o">&lt;</span><span class="n">SuspendQueueSLock</span><span class="o">&gt;::</span><span class="n">Wait</span>
      <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Task</span><span class="o">::</span><span class="n">PostWait</span>
<span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>Code Continues</em></p>

<p>What we see in <em>Code Snippet 6</em> is the continuation of the code, based on the “signal” in <em>Code Snippet 4</em>. If we then investigate the latter part of the trace further we’ll see:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">launchpad</span><span class="o">!</span><span class="n">CLaunchContext</span><span class="o">::</span><span class="n">LaunchServTask</span>
  <span class="p">...</span>
    <span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">GetSQLSatelliteMessage</span>
  <span class="p">...</span>
    <span class="n">launchpad</span><span class="o">!</span><span class="n">ConnectionStore</span><span class="o">::</span><span class="n">RemoveConnection</span>
      <span class="p">...</span>
    <span class="n">launchpad</span><span class="o">!</span><span class="n">TListElem</span><span class="o">&lt;</span><span class="n">TList</span><span class="o">&lt;</span><span class="n">SatelliteSessionList</span><span class="p">,</span><span class="n">SatelliteSession</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">TListSLock</span><span class="o">&gt;</span> <span class="o">&gt;::</span><span class="n">RemoveAndDestroy</span>
      <span class="p">...</span>
    <span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">SendAckMessage</span>
    <span class="p">...</span>
      <span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span>
    <span class="p">...</span>
  <span class="p">...</span>
<span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 7:</strong> <em>Tear Down Connection and Send Ack</em></p>

<p>In <em>Code Snippet 7</em> we see how after continuing the execution and being signaled in <em>Code Snippet 6</em>, we:</p>

<ul>
  <li>Retrieve the message</li>
  <li>Tear down the connection</li>
  <li>Removes the session</li>
  <li>Sending an ack message, through <code class="highlighter-rouge">WriteMessage</code></li>
</ul>

<blockquote>
  <p><strong>NOTE:</strong> Seeing the <code class="highlighter-rouge">launchpad!CSQLSatelliteCommunication::SendAckMessage</code> was what made me realize that we were looking at acknowledgments.</p>
</blockquote>

<p>Seeing that the connection to the SqlSatellite is torn down, we can with some certainty say that the ack will be sent to SQL Server. So now, let’s include SQL Server in our debug session as well:</p>

<ul>
  <li>Disable the <code class="highlighter-rouge">LaunchServTask</code> break-point in the launchpad process.</li>
  <li>Set a break-point in the launchpad process at <code class="highlighter-rouge">launchpad!CSQLSatelliteCommunication::SendAckMessage</code>.</li>
  <li>In the SQL Server process set a break-point at <code class="highlighter-rouge">sqllang!NP::ReadAsync</code>.</li>
</ul>

<p>The theory with the above is that after we break at the <code class="highlighter-rouge">SendAckMessage</code>; when we continue we should immediately break at the SQL Server <code class="highlighter-rouge">ReadAsync</code> break-point. Change the <code class="highlighter-rouge">Sys.sleep</code> back to <code class="highlighter-rouge">Sys.sleep(10)</code> and execute the code in <em>Code Snippet 1</em>. You’ll now break in the SQL Server process at <code class="highlighter-rouge">ReadAsync</code>, this is when the connections etc., are set up between SQL Server and the launchpad. Just continue on from there, and there will be a couple of more breaks before <code class="highlighter-rouge">SendAckMessage</code> - three more on my box, so four in total. Now wait until the break-point is hit at <code class="highlighter-rouge">SendAckMessage</code>, continue on from there and watch how you immediately break in the SQL Server process at <code class="highlighter-rouge">ReadAsync</code>. The call-stack at this stage:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">Np</span><span class="o">::</span><span class="n">ReadAsync</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">SNIReadAsync</span><span class="o">+</span><span class="mh">0xc7</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">ReadCallBackInternal</span><span class="o">+</span><span class="mh">0xc8</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">ReadCallBack</span><span class="o">+</span><span class="mh">0x39</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">SNIReadDone</span><span class="o">+</span><span class="mh">0x13c</span>
<span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Node</span><span class="o">::</span><span class="n">ListenOnIOCompletionPort</span><span class="o">+</span><span class="mh">0x384</span>
<span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 8:</strong> <em>Call Stack at ReadAsync</em></p>

<p>Hmm, there are some routines we recognize in the call-stack in <em>Code Snippet 8</em>, we see the <code class="highlighter-rouge">ReadCallback...</code> which we also saw in the launchpad process and if you remember <a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Internals - XVII</a>, we realized that <code class="highlighter-rouge">ReadCallbackInternal</code> was used to signal to <code class="highlighter-rouge">PullRow</code>, that data had arrived. The question is if something is signaled here as well? I doubt it is <code class="highlighter-rouge">PullRow</code>, seeing that this has nothing to do with processing result-sets. How can we find out about this?</p>

<p>In <a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Internals - XVII</a> we saw how after <code class="highlighter-rouge">PullRow</code> was signaled, <code class="highlighter-rouge">ProcessResultRows</code> were called and in there as one of the first calls were a call to <code class="highlighter-rouge">sqllang!CSQLSatelliteCommunication::GetSQLSatelliteMessage</code>. Maybe something similar is happening here. The way we can find is to set a break-point in the SQL Server process at <code class="highlighter-rouge">sqllang!CSQLSatelliteCommunication::GetSQLSatelliteMessage</code>, but disable it initially.</p>

<p>Execute the code in <em>Code Snippet 1</em> again, and continue until you hit the <code class="highlighter-rouge">ReadAsync</code> break-point in the SQL server process, after the <code class="highlighter-rouge">SendAckMessage</code> (as we did above). While you are in the <code class="highlighter-rouge">ReadAsync</code> break-point, enable the <code class="highlighter-rouge">GetSQLSatelliteMessage</code> in the SQL Server process, and continue the code execution. You’ll see how the <code class="highlighter-rouge">GetSQLSatelliteMessage</code> break-point is hit immediately after you have enabled it and continued from <code class="highlighter-rouge">ReadAsync</code>. When you look at the call-stack (<code class="highlighter-rouge">k</code>), it looks something like so:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">GetSQLSatelliteMessage</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">BindReadSNIPacket</span><span class="o">+</span><span class="mh">0x6f</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">WaitForAckMessage</span><span class="o">+</span><span class="mh">0x7a</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ShutdownService</span><span class="o">+</span><span class="mh">0x250</span>
<span class="n">sqlmin</span><span class="o">!</span><span class="n">CUDXR_ExternalScriptCleanup</span><span class="o">::</span><span class="n">Close</span><span class="o">+</span><span class="mh">0xe</span>
<span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryExecContext</span><span class="o">::</span><span class="n">FinalCleanup</span><span class="o">+</span><span class="mh">0x51</span>
<span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">DestroyQuery</span><span class="o">+</span><span class="mh">0x224</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ShutdownNormal</span><span class="o">+</span><span class="mh">0x151</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span><span class="o">+</span><span class="mh">0x1014</span>
<span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 9:</strong> <em>Call Stack at GetSQLSatelliteMessage</em></p>

<p>It looks like we are onto something here, e.g there is the <code class="highlighter-rouge">sqllang!CSQLSatelliteCommunication::WaitForAckMessage</code> routine, which seems to be called during shutdown of the session. From what we can see from the call-stack it also looks like the “main” routine <code class="highlighter-rouge">is sqllang!CXStmtQuery::ErsqExecuteQuery</code>, and my guess it is that routine which is being signaled. That’s what it looks like for code like in <em>Code Snippet 1</em>:</p>

<p>In the launchpad service:</p>

<ul>
  <li>It gets an IOCP notification.</li>
  <li>It reads the notification through the <code class="highlighter-rouge">Read...</code> routines, and signals it.</li>
  <li>The <code class="highlighter-rouge">LaunchServTask</code> wakes up and calls <code class="highlighter-rouge">launchpad!CSQLSatelliteCommunication::SendAckMessage</code>.</li>
</ul>

<p>In SQL Server:</p>

<ul>
  <li>It reads the message sent from the launchpad service.</li>
  <li>Signals into <code class="highlighter-rouge">ErsqExecuteQuery</code></li>
  <li>Handles the message.</li>
</ul>

<p>What about code like in <em>Code Snippet 2</em> where there is the equivalent of a “print” statement - what happens there?</p>

<h4 id="messages-generated-in-the-external-script">Messages Generated in the External Script</h4>

<p>What I noticed when I was <del>playing</del> researching this post, was that when I executed the code in <em>Code Snippet 1</em> - I saw one <code class="highlighter-rouge">sqllang!Np::ReadAsync</code> in the SQL Server process after the sleep in the code, and we now know it is because of the the <code class="highlighter-rouge">SendAckMessage</code>. However, when executing the code in <em>Code Snippet 2</em> (with the <code class="highlighter-rouge">cat</code> statement), all of a sudden I saw two <code class="highlighter-rouge">ReadAsync</code> but only one <code class="highlighter-rouge">SendAckMessage</code>. So something else seems to send a packet to SQL Server, but what?</p>

<p>I started trying to trace through <code class="highlighter-rouge">launchpad!CLaunchContext::LaunchServTask</code> with <code class="highlighter-rouge">wt</code>, but couldn’t do it completely as I received errors. So instead I looked at sending of packets in the launchpad service, and I set a break-point at <code class="highlighter-rouge">launchpad!CSQLSatelliteConnection::WriteMessage</code>. When executing the code in <em>Code Snippet 1</em>, the break-point was hit initially once immediately and the once after the sleep. The call-stack at this point looked like so:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span>
<span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">SendAckMessage</span><span class="o">+</span><span class="mh">0x191</span>
<span class="n">launchpad</span><span class="o">!</span><span class="n">CLaunchContext</span><span class="o">::</span><span class="n">LaunchServTask</span><span class="o">+</span><span class="mh">0x958</span>
<span class="n">launchpad</span><span class="o">!</span><span class="n">CLaunchContext</span><span class="o">::</span><span class="n">LaunchServTask</span><span class="o">+</span><span class="mh">0x722</span>
<span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Task</span><span class="o">::</span><span class="n">Param</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x231</span>
<span class="p">...</span>
<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlUserThreadStart</span><span class="o">+</span><span class="mh">0x21</span>
</code></pre></div></div>
<p><strong>Code Snippet 10:</strong> <em>Call Stack in Launchpad SendAckMessage</em></p>

<p>The call-stack we see in <em>Code Snippet 10</em>, is more or less what we see in <em>Code Snippet 7</em>. However, when we execute the code in <em>Code Snippet 2</em>, and we break at the first <code class="highlighter-rouge">WriteMessage</code> after the sleep, the call-stack looks as follows:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">launchpad</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span>
<span class="n">launchpad</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendLogMessage</span><span class="o">+</span><span class="mh">0x2b0</span>
<span class="n">launchpad</span><span class="o">!</span><span class="n">SQLSatellite_LogWString</span><span class="o">+</span><span class="mh">0x99</span>
<span class="n">RLauncher</span><span class="o">!</span><span class="n">GetInstance</span><span class="o">+</span><span class="mh">0x3eb28</span>
<span class="n">RLauncher</span><span class="o">!</span><span class="n">GetInstance</span><span class="o">+</span><span class="mh">0x3e7d1</span>
<span class="n">RLauncher</span><span class="o">!</span><span class="n">GetInstance</span><span class="o">+</span><span class="mh">0x3e9be</span>
<span class="n">RLauncher</span><span class="o">!</span><span class="n">GetInstance</span><span class="o">+</span><span class="mh">0x3d15b</span>
<span class="n">RLauncher</span><span class="o">!</span><span class="n">GetInstance</span><span class="o">+</span><span class="mh">0x1751d</span>
<span class="n">RLauncher</span><span class="o">!</span><span class="n">GetInstance</span><span class="o">+</span><span class="mh">0x1c30c</span>
<span class="n">RLauncher</span><span class="o">!</span><span class="n">SQLSatellite_GetLauncherAPI</span><span class="o">+</span><span class="mh">0xe50</span>
<span class="n">launchpad</span><span class="o">!</span><span class="n">CLaunchContext</span><span class="o">::</span><span class="n">Cleanup</span><span class="o">+</span><span class="mh">0x11a</span>
<span class="n">launchpad</span><span class="o">!</span><span class="n">CLaunchContext</span><span class="o">::</span><span class="n">LaunchServTask</span><span class="o">+</span><span class="mh">0x8fa</span>
<span class="n">launchpad</span><span class="o">!</span><span class="n">CLaunchContext</span><span class="o">::</span><span class="n">LaunchServTask</span><span class="o">+</span><span class="mh">0x722</span>
<span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Task</span><span class="o">::</span><span class="n">Param</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x231</span>
<span class="p">...</span>
<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlUserThreadStart</span><span class="o">+</span><span class="mh">0x21</span>
</code></pre></div></div>
<p><strong>Code Snippet 11:</strong> <em>Call Stack in Launchpad with Print Message</em></p>

<p>So the call-stack in <em>Code Snippet 11</em> is completely different than in <em>Code Snippet 10</em>. Well, we are still inside <code class="highlighter-rouge">LaunchServTask</code>, but <code class="highlighter-rouge">LaunchServTask</code> calls a cleanup routine, and within that routine calls to log routines are called: <code class="highlighter-rouge">launchpad!SQLSatellite_LogWString</code>, and <code class="highlighter-rouge">launchpad!CSatelliteCargoContext::SendLogMessage</code>. The <code class="highlighter-rouge">SendLogMessage</code> routine is the routine which ultimately sends the message to SQL Server. When the code continues, the <code class="highlighter-rouge">WriteMessage</code> breakpoint is hit the second time, and at this stage the breakpoint looks exactly the same as in <em>Code Snippet 10</em>. This then means that the ack message is sent after the message from which to log.</p>

<p>What is worth noticing is that even though the launchpad service sends two messages to SQL Server - there is only one message coming in from the external engine, e.g. the actual “print” message comes together with the ack message, as in <em>Code Snippet 3</em>.</p>

<p>Now, let’s see what it looks like at the SQL Server side, when we execute code like in <em>Code Snippet 2</em>:</p>

<ul>
  <li>Disable all breakpoints in the launchpad service, except for <code class="highlighter-rouge">SendAckMessage</code>.</li>
  <li>Set a break-point at <code class="highlighter-rouge">launchpad!CSatelliteCargoContext::SendLogMessage</code>.</li>
  <li>Keep the  break-point in the SQL Server process for <code class="highlighter-rouge">ReadAsync</code>.</li>
  <li>Disable all other breakpoints in the SQL server process, including the <code class="highlighter-rouge">GetSQLSatelliteMessage</code> break-point.</li>
</ul>

<p>Execute the code in <em>Code Snippet 2</em>, and let the code continue until you hit the <code class="highlighter-rouge">SendLogMessage</code> break-point in the launchpad process. Continue the execution, and when you hit <code class="highlighter-rouge">ReadAsync</code> in SQL server, enable the <code class="highlighter-rouge">GetSQLSatelliteMessage</code> break-point. Continue the execution and when the <code class="highlighter-rouge">GetSQLSatelliteMessage</code> breakpoint is hit, check the call-stack. Continue execution until the <code class="highlighter-rouge">SendAckMessage</code> break-point is hit in the launchpad process, and then continue until <code class="highlighter-rouge">GetSQLSatelliteMessage</code> in SQL Server is hit again. Check the call-stack, and compare them.</p>

<p>You’ll see how they are identical, and exactly like what we see in <em>Code Snippet 9</em>. So if the call-stacks look exactly the same (from what we can see), what then causes the “print” statement to be output? It turns out that it is somewhat similar to what happens in the launchpad process where the <code class="highlighter-rouge">Cleanup</code> routine leads into the <code class="highlighter-rouge">SendLogMessage</code> call. So in the SQL Server process, the <code class="highlighter-rouge">sqlmin!CQueryExecContext::FinalCleanup</code> routine calls into <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ShutdownService</code>, which - dependent on if a message comes back from the R engine - will read it in and then call a routine which handles the message: <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::HandleLogMessage</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryExecContext</span><span class="o">::</span><span class="n">FinalCleanup</span>
  <span class="n">sqlmin</span><span class="o">!</span><span class="n">CUDXR_ExternalScriptCleanup</span><span class="o">::</span><span class="n">Close</span>
  <span class="p">...</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ShutdownService</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">WaitForAckMessage</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">GetNextMessage</span>
        <span class="p">...</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">BindReadSNIPacket</span>
        <span class="p">...</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageLog</span><span class="o">::</span><span class="n">ReadPayload</span>
        <span class="p">...</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">HandleLogMessage</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">WaitForAckMessage</span>
      <span class="p">...</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">GetNextMessage</span>
      <span class="p">...</span>
  <span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 12:</strong> <em>Call Flow in SQL Server Log Message</em></p>

<p>When a “log” message is passed into SQL Server the code path is as in <em>Code Snippet 12</em>, when no log message is passed in after the <code class="highlighter-rouge">BindReadSNIPacket</code> in <em>Code Snippet 12</em>, the code will drop out until the <code class="highlighter-rouge">GetNextMessage</code> at the end of <em>Code Snippet 12</em></p>

<p>We started this blog-post by asking where the message we see in <em>Figure 5</em> comes from, and what causes it. By now is should be clear that what causes it; is the <code class="highlighter-rouge">SendAckMessage</code> routine in the launchpad service. The message indicates that all work has been done. For the actual message we see, I believe it is generated by <em>SSMS</em> directly, it does not come from the launchpad service.</p>

<p>When a message is explicitly generated in the R script, that message goes back to the launchpad service which calls <code class="highlighter-rouge">SendLogMessage</code>. After the <code class="highlighter-rouge">SendLogMesage</code> the <code class="highlighter-rouge">SendAckMessage</code> will be called as well.</p>

<h2 id="error-messages">Error Messages</h2>

<p>So far we’ve seen how “print” messages generated from R are handled. What about error messages?</p>

<p>That has to be covered in next post. When I started this post I thought I knew how error messages was handled - but when I looked at it closer, I realized there was more to it than I thought, so I need to do some more investigations. Sorry!</p>

<h2 id="summary">Summary</h2>

<p>In this post we have seen how “print” messages originating form the external script as well as acknowledgment messages from the external environment are handled by the launchpad service as well as SQL Server.</p>

<h4 id="launchpad">Launchpad</h4>

<p>The launchpad service:</p>

<ul>
  <li>Listens on callbacks from the external engine</li>
  <li>The callback signals <code class="highlighter-rouge">launchpad!CLaunchContext::LaunchServTask</code>.</li>
  <li><code class="highlighter-rouge">LaunchServTask</code> continues after signal into <code class="highlighter-rouge">launchpad!CLaunchContext::Cleanup</code></li>
  <li>If a “print” message comes from the external engine, <code class="highlighter-rouge">launchpad!CSatelliteCargoContext::SendLogMessage</code> is called.</li>
  <li>Regardless if there is a “print” message or not, launchpad will tell SQL Server that the external engine is “done” via <code class="highlighter-rouge">launchpad!CSQLSatelliteCommunication::SendAckMessage</code>.</li>
</ul>

<p>The figure below tries to illustrate the launchpad part:</p>

<p><img src="/images/posts/sql_r_services_19_launchpad_flow.png" alt="" /></p>

<p><strong>Figure 9:</strong> <em>Launchpad Flow</em></p>

<p>In <em>Figure 9</em> we see the main calls of leading up to and including when messages come back from the external engine. The numbered arrows show some of the calls and the communication in the launchpad service:</p>

<ol>
  <li>During startup an IOCP “listener” is set up.</li>
  <li>Creates supporting directories and process, and initiates the connection to the external engine.</li>
  <li>After work is done, a call comes back from the external engine.</li>
  <li>This causes the “listener” to call <code class="highlighter-rouge">Read...</code> routines.</li>
  <li><code class="highlighter-rouge">LaunchServTask</code> is signaled.</li>
  <li>Execution in <code class="highlighter-rouge">LaunchServTask</code> continues into launchpad!CLaunchContext::Cleanup.</li>
  <li>If a “print” message has been passed back from the external engine, eventually <code class="highlighter-rouge">launchpad!CSatelliteCargoContext::SendLogMessage</code> is called.</li>
  <li><code class="highlighter-rouge">launchpad!CSatelliteCargoContext::SendLogMessage</code> sends the message to SQL Server.</li>
  <li><code class="highlighter-rouge">LaunchServTask</code> continues into <code class="highlighter-rouge">launchpad!CSQLSatelliteCommunication::SendAckMessage</code>, which sends an ack that the “job is done” to SQL Server.</li>
</ol>

<h4 id="sql-server">SQL Server</h4>

<p>In SQL Server the flow is something like so:</p>

<ul>
  <li>As in the launchpad service, SQL Server listens for callbacks, on the named pipe connection to the launchpad service.</li>
  <li>A callback comes in, is being read and signals <code class="highlighter-rouge">sqllang!CXStmtQuery::ErsqExecuteQuery</code>.</li>
  <li>Execution continues and <code class="highlighter-rouge">sqlmin!CQueryExecContext::FinalCleanup</code> is called.</li>
  <li><code class="highlighter-rouge">FinalCleanup</code> calls into <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ShutdownService</code>.</li>
  <li>If a “print” message has been sent, <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::HandleLogMessage</code> is called.</li>
  <li>Independent of whether a “print” message is sent or not, <code class="highlighter-rouge">sqllang!CSQLSatelliteCommunication::WaitForAckMessage</code> will handle the final ack message.</li>
</ul>

<p>As with the launchpad service I have tried to create a figure illustrating the flow in SQL Server:</p>

<p><img src="/images/posts/sql_r_services_19_sql_flow.png" alt="" /></p>

<p><strong>Figure 10:</strong> <em>SQL Server Flow</em></p>

<p>The numbered arrows in <em>Figure 10</em> illustrates:</p>

<ol>
  <li>During launch of the launchpad service, an IOCP “listener” is set up.</li>
  <li>Message sent to the launchpad service.</li>
  <li>After the call above, the SqlSatellite opens a TCP/IP connection to SQL Server.</li>
  <li>Authentication packets and script packet is sent to  the SqlSatellite.</li>
  <li>If there is data for <code class="highlighter-rouge">@input_data_1</code>, it is sent, together with two end packets.</li>
  <li>Packets are coming back to SQL Server containing meta-data and the actual data.</li>
  <li><code class="highlighter-rouge">PullRow</code> is being signaled, and processing of meta-data as well as result rows continues.</li>
  <li>The launchpad service sends “print”/ack messages to SQL Server. In the figure it is illustrated as one packet, but there is one message for “print” and one for ack.</li>
  <li>A signal is sent to <code class="highlighter-rouge">ErsqExecuteQuery</code>.</li>
  <li>Execution continues by calling into <code class="highlighter-rouge">sqllang!CXStmtQuery::ShutdownNormal</code>, which calls into <code class="highlighter-rouge">FinalCleanup, </code>ShutdownService, and a call to <code class="highlighter-rouge">sqllang!CSQLSatelliteCommunication::WaitForAckMessage</code> is made followed by <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::GetNextMessage</code>.</li>
  <li>If a “print” message has been sent to SQL Server <code class="highlighter-rouge">ReadPayload</code> is called and then <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::HandleLogMessage</code>. If no “print” message has been sent in, the code loops on <code class="highlighter-rouge">sqllang!CSQLSatelliteCommunication::WaitForAckMessage</code>.</li>
  <li>SQL Server loops on <code class="highlighter-rouge">sqllang!CSQLSatelliteCommunication::WaitForAckMessage</code> and waits for the ack message,</li>
  <li>When the ack message has been received, the eventual messages are sent to the calling code.</li>
</ol>

<h2 id="-finally">~ Finally</h2>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2018/01/20/microsoft-sql-server-r-services-internals-xix/&text=Microsoft SQL Server R Services - Internals XIX&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2018/01/20/microsoft-sql-server-r-services-internals-xix/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2018/01/20/microsoft-sql-server-r-services-internals-xix/
         &title=Microsoft SQL Server R Services - Internals XIX
         &summary=Blog post: A drill down, using WinDbg, into how print statements in the external engine together with ack messages comes back to SQL Server.
         &source=http://www.nielsberglund.com/2018/01/20/microsoft-sql-server-r-services-internals-xix/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2018/01/20/microsoft-sql-server-r-services-internals-xix/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-machine-learning-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Machine Learning Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#windbg">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WinDbg</span>
    </a>
  
    
    <a href="/tags/#launchpad">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Launchpad</span>
    </a>
  
    
    <a href="/tags/#rterm-exe">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">RTerm.exe</span>
    </a>
  
    
    <a href="/tags/#bxl">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">BXL</span>
    </a>
  
    
    <a href="/tags/#process-monitor">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Process Monitor</span>
    </a>
  
    
    <a href="/tags/#sqlsatellite">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SqlSatellite</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2018/01/20/microsoft-sql-server-r-services-internals-xix/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2018/01/20/microsoft-sql-server-r-services-internals-xix/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/07/29/interesting-stuff-week-30/">
            Interesting Stuff - Week 30
            <small>29 Jul 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
