<!DOCTYPE html> <html lang="en-us"> <head> <!-- Google Tag Manager --> <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-K7B3642');</script> <!-- End Google Tag Manager --> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="Using WinDbg to find out what happens inside SQL Server when data is returned from SqlSatellite"> <meta name="keywords" content="SQL Server R Services, SQL Server Machine Learning Services, R, WinDbg, Launchpad, RTerm.exe, BXL, Process Monitor"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Microsoft SQL Server R Services - Internals XVII &middot; Niels Berglund </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-e8a259b38492bb97421cc4e038981561.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.5.0 --> <title>Microsoft SQL Server R Services - Internals XVII | Niels Berglund</title> <meta name="generator" content="Jekyll v3.8.3" /> <meta property="og:title" content="Microsoft SQL Server R Services - Internals XVII" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Using WinDbg to find out what happens inside SQL Server when data is returned from SqlSatellite" /> <meta property="og:description" content="Using WinDbg to find out what happens inside SQL Server when data is returned from SqlSatellite" /> <link rel="canonical" href="http://nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/" /> <meta property="og:url" content="http://nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/" /> <meta property="og:site_name" content="Niels Berglund" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2018-01-03T09:57:38+02:00" /> <script type="application/ld+json"> {"url":"http://nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/","headline":"Microsoft SQL Server R Services - Internals XVII","dateModified":"2018-01-03T09:57:38+02:00","datePublished":"2018-01-03T09:57:38+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/"},"author":{"@type":"Person","name":"nielsb"},"description":"Using WinDbg to find out what happens inside SQL Server when data is returned from SqlSatellite","@type":"BlogPosting","@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-3005153158271538", enable_page_level_ads: true }); </script> </head> <body> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K7B3642" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) --> <div class="sidebar"> <div class="container"> <div class="sidebar-about"> <h1> <a href="/"> Niels Berglund </a> </h1> <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Sidebar_rectangle --> <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-3005153158271538" data-ad-slot="7704601332"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/disclaimer/">Disclaimer</a> <a class="sidebar-nav-item" href="/series/">Blog Post Series</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <img class="center" src="/images/MVP_Logo_large.png" width="300" height="121" > <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <p>&copy; 2018. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">Microsoft SQL Server R Services - Internals XVII</h1> <div class="post-subheading"> <span class="post-date">03 Jan 2018</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#Microsoft R Server">Microsoft R Server</a> <a href="/categories/#Data Science">Data Science</a> <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a> <a href="/categories/#SQL Server R Services">SQL Server R Services</a> <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server R Services">SQL Server R Services</a> <a href="/tags/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <a href="/tags/#R">R</a> <a href="/tags/#WinDbg">WinDbg</a> <a href="/tags/#Launchpad">Launchpad</a> <a href="/tags/#RTerm.exe">RTerm.exe</a> <a href="/tags/#BXL">BXL</a> <a href="/tags/#Process Monitor">Process Monitor</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> <p>This post is part of a series of blog-posts about Microsoft SQL Server R Services:</p> <ol> <li><a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">Microsoft SQL Server 2016 R Services Installation</a></li> <li><a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Microsoft SQL Server R Services - Internals I</a></li> <li><a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Microsoft SQL Server R Services - Internals II</a></li> <li><a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Microsoft SQL Server R Services - Internals III</a></li> <li><a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Microsoft SQL Server R Services - Internals IV</a></li> <li><a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Microsoft SQL Server R Services - Internals V</a></li> <li><a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Microsoft SQL Server R Services - Internals VI</a></li> <li><a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Microsoft SQL Server R Services - Internals VII</a></li> <li><a href="/2017/07/22/microsoft-sql-server-r-services-internals-viii/">Microsoft SQL Server R Services - Internals VIII</a></li> <li><a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Microsoft SQL Server R Services - Internals IX</a></li> <li><a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Microsoft SQL Server R Services - Internals X</a></li> <li><a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">Microsoft SQL Server R Services - Internals XI</a></li> <li><a href="/2017/10/31/microsoft-sql-server-r-services-internals-xii/">Microsoft SQL Server R Services - Internals XII</a></li> <li><a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">Microsoft SQL Server R Services - Internals XIII</a></li> <li><a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Microsoft SQL Server R Services - Internals XIV</a></li> <li><a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Microsoft SQL Server R Services - Internals XV</a></li> <li><a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Microsoft SQL Server R Services - Internals XVI</a></li> <li>Microsoft SQL Server R Services - Internals XVII (this post)</li> <li><a href="/2018/01/10/microsoft-sql-server-r-services-internals-xviii/">Microsoft SQL Server R Services - Internals XVIII</a></li> <li><a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Microsoft SQL Server R Services - Internals XIX</a></li> <li><a href="/2018/02/02/microsoft-sql-server-r-services-internals-xx/">Microsoft SQL Server R Services - Internals XX</a></li> <li><a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">Microsoft SQL Server R Services: sp_execute_external_script - I</a></li> <li><a href="/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/">Microsoft SQL Server R Services - sp_execute_external_script - II</a></li> <li><a href="/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/">Microsoft SQL Server R Services: sp_execute_external_script - III</a> <em>last post in the series</em></li> </ol> <p>This post is the 18:th post about Microsoft SQL Server R Services, and the 17:th post that drills down into the internal of how it works.</p> <p>The last <em>Internals</em> posts have discussed the transport of data between SQL Server and the SqlSatellite. In <a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Internals - XVI</a> we looked at how data came back from the SqlSatellite, and what the data looked like.</p> <!--more--> <p>This post is a continuation of that post, and here we'll look at what happens inside SQL Server when data is returned from the SqlSatellite and the R engine.</p> <h2>Recap</h2> <p>In <a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Internals - XVI</a> we looked at the packets being sent back to SQL Server from the SqlSatellite when a dataset is returned. We saw how there were actually two packets coming back, one small and one bigger, we deduced that those packets were:</p> <ul> <li>The smaller packet had something to do with column meta-data. We'll try and see what we can find out about this packet in this post.</li> <li>The bigger packet held the actual data.</li> </ul> <p>The reason why the second package was bigger was due to the data being treated as originating from nullable columns, so quite an overhead was put onto the various columns:</p> <table> <thead> <tr> <th> Data Type </th> <th style="text-align:center;"> 1 Row </th> <th style="text-align:center;"> 2 Rows </th> <th> Comment </th> </tr> </thead> <tbody> <tr> <td> tinyint </td> <td style="text-align:center;"> 2051 </td> <td style="text-align:center;"> 2055 </td> <td> - </td> </tr> <tr> <td> smallint </td> <td style="text-align:center;"> 2051 </td> <td style="text-align:center;"> 2055 </td> <td> - </td> </tr> <tr> <td> int </td> <td style="text-align:center;"> 2051 </td> <td style="text-align:center;"> 2055 </td> <td> - </td> </tr> <tr> <td> real </td> <td style="text-align:center;"> 1078 </td> <td style="text-align:center;"> 1086 </td> <td> - </td> </tr> <tr> <td> float </td> <td style="text-align:center;"> 1078 </td> <td style="text-align:center;"> 1086 </td> <td> No difference related to storage size</td> </tr> <tr> <td> bigint </td> <td style="text-align:center;"> 1078 </td> <td style="text-align:center;"> 1086 </td> <td></td> </tr> <tr> <td> money </td> <td style="text-align:center;"> 1078 </td> <td style="text-align:center;"> 1086 </td> <td></td> </tr> <tr> <td> decimal </td> <td style="text-align:center;"> 1078 </td> <td style="text-align:center;"> 1086 </td> <td> No difference related to storage size</td> </tr> </tbody> </table> <p><strong>Table 1:</strong> <em>Packet Sizes from SqlSatellite</em></p> <p>Part of the overhead is the 32 bytes column overhead as we discussed in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>, and a 28 bytes end-sequence, where the end-sequence appears once per data-set, and is not per column. It is somewhat like a row in the data-set. Part of this post is trying to figure out what goes on with this end-sequence.</p> <p>When looking at the various sizes coming back, we see it is a lot less than what we saw in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>, sending data to SqlSatellite. This is due to R supporting a lot less data-types than SQL Server, and therefore the data might be implicitly converted to a compatible data type.</p> <h2>Housekeeping</h2> <p>Housekeeping in this context is talking about the tools we'll use, as well as the code. This section is here here for those of who want to follow along in what we're doing in the posts.</p> <h4>Helper Tools</h4> <p>To help us figure out the things we want, we will use <em>Process Monitor</em>, and <em>WinDbg</em>:</p> <ul> <li><em>Process Monitor</em>, will be used it to filter TCP traffic. If you want to refresh your memory about how to do it, we covered that in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> as well as in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>.</li> <li>In the last few posts I have used <em>WinDbg preview</em> a my debugger, but in this post I am reverting back to <em>WinDbg</em> "classic". If you need help with setting it up, that is covered in <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I</a>.</li> </ul> <h4>Code</h4> <p>The code below sets up the database and creates some tables with some data. It is more or less the same as we've used in the last posts:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Code</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span><span class="p">;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">ResultData</span><span class="p">;</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">ResultData</span><span class="p">;</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">USE</span> <span class="n">ResultData</span><span class="p">;</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span><span class="p">(</span><span class="n">RowID</span> <span class="n">bigint</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>                          <span class="n">y</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand1</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="n">rand2</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand3</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="n">rand4</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand5</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">);</span>
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">rand3</span><span class="p">,</span> <span class="n">rand4</span><span class="p">,</span> <span class="n">rand5</span><span class="p">)</span>
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">20</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">25</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">50</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='29' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">100</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='30' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o1</span>
</div></div><div data-line='31' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o2</span>
</div></div><div data-line='32' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o3</span>
</div></div><div data-line='33' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o4</span><span class="p">;</span>
</div></div><div data-line='34' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Database, and Database Object Creation</em></p> <p>The code we'll use should by now look very familiar:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Base Code</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(10)
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                             OutputDataSet&lt;-InputDataSet'</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>               <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT TOP(1) rand1 FROM dbo.rand_1M'</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>Base Code to Execute</em></p> <p>The reason there is a <code>Sys.sleep</code> in the code in <em>Code Snippet 2</em>, is so we can more easily determine at about what time data should be coming back from the SqlSatellite.</p> <h2>WinDbg Debugging</h2> <p>In <a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Internals - XV</a>, we used <em>WinDbg</em>, and we saw the routines involved when sending data to the SqlSatellite:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Routines</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushRow</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">PostOneRow</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">WritePayloadHeader</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">WriteData</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">WriteMessageBlockDone</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 3:</strong> <em>Routines Used when Sending Data</em></p> <p>Now we'll aim to do the same thing here, and we'll start with trying to find routines being used when receiving data, and we'll start with trying to find the "main" routine for receiving results. Remember in <a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Internals - XV</a>, we saw how <code>sqllang!CUDXR_ExternalScript::PushRow</code> where were things "started", when sending data. Perhaps there is something similar in the <code>CUDXR_ExternalScript</code> when receiving? So:</p> <ul> <li>Start up <em>WinDbg</em> as admin.</li> <li>Attach to the SQL Server process.</li> </ul> <p>After having attached to the process, execute in the <em>WinDbg</em> console: <code>x sqllang!CUDXR_ExternalScript*</code>. That returns quite a few routines, from which we can see if anyone looks promising. When I ran it I found a couple that caught my interest:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>CUDXR_ExternalScript Routines</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 4:</strong> <em>Interesting sqllang!CUDXR_ExternalScript Routines</em></p> <p>Let's now set breakpoints at the two routines above, plus a breakpoint at <code>sqllang!CSatelliteCargoContext::SendPackets</code>. The reason for the breakpoint at <code>SendPackets</code> is that it is there to indicate where we are, as <code>PullRow</code> can be called based on processing inside SQL Server, not only as result of data coming back from the SqlSatellite. Now execute the code in <em>Code Snippet 2</em>, and you'll see how:</p> <ul> <li><code>PullRow</code> is called once before <code>SendPackets</code> - that's not interesting to us.</li> <li><code>SendPackets</code> is called.</li> <li><code>PullRow</code> is called.</li> <li>A pause followed by <code>ProcessResultRows</code> being called twice.</li> </ul> <p>A couple of questions comes up after having seen the above:</p> <ul> <li>Why is the second <code>PullRow</code> called immediately after <code>SendPackets</code>?</li> <li>Why are there two <code>ProcessResultRows</code>, when only one row is returned?</li> </ul> <p>Just to confirm the last bullet point; change the <code>TOP</code> clause in <em>Code Snippet 2</em> to 5 instead of one and execute again. The breakpoint at <code>ProcessResultRows</code> is now hit 6 times. So <code>ProcessResultRows</code> is definitely related to number of rows returned, but also something else. Let's see if we can figure out what happens here:</p> <ul> <li>Disable all breakpoints except for the <code>ProcessResultRows</code> breakpoint.</li> <li>Clear the <em>WinDbg</em> command window by <code>.cls</code>.</li> <li>Change the <code>TOP</code> clause in <em>Code Snippet 2</em> to be 3.</li> <li>Execute the code.</li> <li>Each time the <code>ProcessResultRows</code> breakpoint do a <code>wt -l4</code> (trace and watch 4 levels deep).</li> <li>After each "trace and watch", copy the output to new files and name them <code>wt1.txt</code>, <code>wt2.txt</code>, etc.</li> </ul> <p>There should, after completing the execution, be four files, let's compare these four files.</p> <blockquote><p><strong>NOTE:</strong> If you haven't done the <code>wt</code> as above, you can download the four files, plus a couple of others from <a href="/downloads/misc/sql_r_services_internal17.zip">here</a>.</p></blockquote> <p>What we see is that the first file is bigger than the others, it has ~165 lines whereas the others are between 65 - 70 lines. The last third part of the first file (from about line 104), looks very much like the second and third files. We can also see that the fourth file is not similar to the other tree.</p> <p>Now what we'll do is to look at the similarities between the three first files and try to understand what is happening. In the files we see some interesting routines:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>ProcessResultRows</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="p">...</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">GetSQLSatelliteMessage</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">ReadData</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>     <span class="p">...</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">MSVCR120</span><span class="o">!</span><span class="n">memcpy_s</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">MSVCR120</span><span class="o">!</span><span class="n">memcpy</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">MSVCR120</span><span class="o">!</span><span class="n">MoveSmall</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">MSVCR120</span><span class="o">!</span><span class="n">memcpy_s</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">...</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">OutputRow</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CTds74</span><span class="o">::</span><span class="n">SendRowImpl</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CColMetaData</span><span class="o">::</span><span class="n">CCols</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">...</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">OutputRow</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 5:</strong> <em>Routines from sqllang!CUDXR_ExternalScript::ProcessResultRows</em></p> <p>By now we understand that <code>ProcessResultRows</code> is doing what it says on the packet; it takes the rows coming back from the SqlSatellite, processes it, and then outputs it through <code>sqllang!CUDXR_ExternalScript::OutputRow</code>. From what we see in <em>Code Snippet 5</em>, it looks like the rows being outputted is outputted in the <em>TDS</em> format - look at the calls to <code>sqllang!CTds74::SendRowImpl</code>. This would make sense since clients etc., do not "speak" <em>BXL</em>, and from what we've seen - <em>BXL</em> is what is coming back from the SqlSatellite.</p> <blockquote><p><strong>EDITED:</strong> The following section down to <code>PullRow</code> has been slightly changed, to make it more readable.</p></blockquote> <p>So the similar code in the three files (<code>wt1</code>, <code>wt2</code>, and <code>wt3</code>) processes the rows coming back, and outputs them as TDS, cool! So what about the first part of the first <code>ProcessResultRows</code>, what does that do? Let's have a look at the trace file for the first <code>ProcessResultRows</code>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>First ProcessResultRows</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">...</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">GetSQLSatelliteMessage</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">...</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReceiveOneDataChunk</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="p">...</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">BindBufferForRead</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">ReadPayloadHeader</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">BindBufferForRead</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">...</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReceiveOneDataChunk</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">SendAckMessage</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="p">...</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">SendAckMessage</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">PostWriteRequest</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">SendAckMessage</span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WaitWriteDone</span>
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">SendAckMessage</span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReceiveOneDataChunk</span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>     <span class="p">...</span>
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">BindBufferForRead</span>
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessage</span><span class="o">::</span><span class="n">BindBufferForRead</span>
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">...</span>
</div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">ReadPayloadHeader</span>
</div></div><div data-line='29' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">BindBufferForRead</span>
</div></div><div data-line='30' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">...</span>
</div></div><div data-line='31' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div></pre></div></figure> <strong>Code Snippet 6:</strong> <em>Routines from First ProcessResultRows</em></p> <p>In <em>Code Snippet 6</em> we see various parts of the first 2/3 of the first call to <code>ProcessResultRows</code>. What is interesting is the <code>sqllang!CServerCargoContext::ReceiveOneDataChunk</code>, <code>sqllang!CSQLSatelliteMessageDataChunk::ReadPayloadHeader</code> and the <code>sqllang!CSQLSatelliteCommunication::SendAckMessage</code> calls.</p> <p>From what I gather, the <code>ReceiveOneDataChunk</code> routine reads in data that has been received from a socket, the <code>ReadPayloadHeader</code> reads the column header for each column in the result-set being returned, in order to determine data types etc. The <code>SendAckMessage</code>, sends a message back to the SqlSatellite, most likely indicating that SQL Server has received the two packages being sent from the SqlSatellite. We can confirm the "sending message back" part by:</p> <ul> <li>Disabling all break-point in <em>WinDbg</em> except for the breakpoint at <code>sqllang!CUDXR_ExternalScript::ProcessResultRows</code>.</li> <li>Set a breakpoint at <code>sqllang!CSQLSatelliteConnection::WriteMessage</code>, but disable it.</li> <li>Run <em>Process Monitor</em> as admin and load the filter we used in <a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Internals - XVI</a> where we filtered for <code>TCP Send</code> and <code>TCP Receive</code> for <code>BxlServer.exe</code>.</li> </ul> <p>Execute the code in <em>Code Snippet 2</em>, and when you hit the <code>ProcessResultRows</code> breakpoint, look at the output from <em>Process Monitor</em>. You should see something like so:</p> <p><img class="center" src="/images/posts/sql_r_services_17_procmon1.png" width="579" height="280" > <strong>Figure 1:</strong> <em>Output Before WriteMessage</em></p> <p>We see in <em>Figure 1</em> how the two data packets have been sent to SQL Server, but nothing else has happened. Enable the <code>WriteMessage</code> break-point and continue the execution. We'll now break at <code>WriteMessage</code>, but nothing has happened in <em>Process Monitor</em> (no more packages have been sent or received). However, when we now continue the execution we'll see in *Process Monitor how a packet is sent to the SqlSatellite (<code>BxlServer.exe</code>) with a length of 28 bytes, and then two packets are returned back from the SQlSatellite:</p> <p><img class="center" src="/images/posts/sql_r_services_17_procmon2.png" width="519" height="325" > <strong>Figure 2</strong> <em>Output After WriteMessage</em></p> <p>We see the ack message sent to the SqlSatellite outlined in red in <em>Figure 2</em>, and the two packets coming back outlined in blue. Further down in this post as well as in an upcoming post we'll see if we can determine what the two packets coming back from the SqlSatellite do.</p> <p>Now we've seen how the first <code>ProcessResultRows</code> is doing both schema "stuff" as well as processing the first row, and how the second and third <code>ProcessResultRows</code>, handle the remaining rows. What about the fourth file, the last <code>ProcessResultRows</code> - what does that one do? Let's have a look at some of the calls that happens:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Last ProcessResultRows</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">...</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">GetSQLSatelliteMessage</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReceiveOneDataChunk</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="p">...</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">EndOutput</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">EndOutput</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CTdsConn</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;::</span><span class="n">EndResultSetImpl</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">SendDoneWarnings</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CTdsConn</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;::</span><span class="n">EndResultSetImpl</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">EndOutput</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 7:</strong> <em>Routines from Last ProcessResultRows</em></p> <p>From the code in <em>Code Snippet 7</em> we see how there is a <code>ReceiveOneDataChunk</code> call, which indicates data is being read after having been received from a socket. It also looks like that this last <code>ProcessResultRows</code> indicates that there are no more data: <code>sqllang!CUDXR_ExternalScript::EndOutput</code>, <code>sqllang!CTdsConn&lt;0&gt;::EndResultSetImpl</code> and <code>sqllang!SendDoneWarnings</code>. The question is what indicates this in the packets SQL Server receives from the SqlSatellite? This is now some speculation from my side, but I strongly suspect this originates from one of the 28 byte packets coming back from SqlSatellite after SQL Server sent the ack message above. I also think that the end-sequence that we mentioned in <a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Internals - XVI</a> as well as in the <em>Recap</em> above, has something to do with this.</p> <p>Now we should be able to answer the question above about why there are one more <code>ProcessResultRows</code> than rows returned, and we should also have a fairly good grasp of what happens when processing rows returned from the SqlSatellite:</p> <ul> <li>Rows are processed by <code>sqllang!CUDXR_ExternalScript::ProcessResultRows</code>.</li> <li>During the first <code>ProcessResultRows</code> the column header(s) are processed, followed by the first row.</li> <li>Subsequent rows are processed by <code>ProcessResultRows</code>.</li> <li>A final <code>ProcessResultRows</code> processes one of the packets received back from SqlSatellite after ack message has been sent.</li> </ul> <p>So, what about the first question we had above; why is there a <code>PullRow</code> called straight after <code>SendPackets</code>, e.g. the <code>PullRow</code> happens before data is returned from the SqlSatellite? To try to figure this out, let's disable all breakpoints, except for the breakpoint at <code>sqllang!CUDXR_ExternalScript::ProcessResultRows</code>, and execute <em>Code Snippet 2</em> again (you can take out the <code>Sys.sleep</code> if you want). When you execute and hit the breakpoint <code>ProcessResultRows</code> for the first time, look at the call-stack: <code>k</code>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Call Stack</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span><span class="o">+</span><span class="mh">0xf4</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span><span class="o">+</span><span class="mh">0x196</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">GetRow</span><span class="o">+</span><span class="mh">0x81</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span><span class="o">+</span><span class="mh">0x4dc</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtSelect</span><span class="o">::</span><span class="n">XretExecute</span><span class="o">+</span><span class="mh">0x322</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;+</span><span class="mh">0x40d</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span><span class="o">+</span><span class="mh">0xa9e</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x983</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span><span class="o">+</span><span class="mh">0x140e</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">...</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 8:</strong> <em>Call Stack at First ProcessResultRows</em></p> <p>What we see in <em>Code Snippet 8</em> is the important part of the call-stack and we can see how <code>ProcessResultRows</code> is called from within <code>PullRow</code>. Interesting, <code>PullRow</code> is called right after <code>SendPackets</code>, before the result has come back, and still <code>ProcessResultRows</code> is called from within <code>PullRow</code>, after the result is back? Let's see if we can figure out what's happening:</p> <ul> <li>Disable all breakpoints.</li> <li>Set a breakpoint at <code>sqllang!CUDXR_ExternalScript::PullRow</code>.</li> <li>Change the <code>Sys.sleep(10)</code> in <em>Code Snippet 2</em>, to <code>Sys.sleep(60)</code>.</li> <li>Execute the code.</li> <li>Continue past the first <code>PullRow</code>.</li> </ul> <p>When you hit the <code>PullRow</code> for the second time, do a <code>wt</code>. You'll see how the code continues, up until the execution starts in the R engine, and the code hits <code>Sys.sleep</code>. At this stage, copy out the output from <code>wt</code> into a new file (call it <code>pull_row_1.txt</code>).</p> <blockquote><p><strong>NOTE:</strong> The trace files for <code>PullRow</code> are also part of the download mentioned above.</p></blockquote> <p>At some stage the execution continues, and after the full <code>wt</code>, copy the whole trace into a second file <code>pull_row_full.txt</code>. Now open the <code>pull_row_1.txt</code> file, and look at the last 11 lines (for me it starts at around line 888):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Wait</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Switch</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">KERNEL32</span><span class="o">!</span><span class="n">QueryPerformanceCounter</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">ntdll</span><span class="o">!</span><span class="n">RtlQueryPerformanceCounter</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Switch</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">KERNEL32</span><span class="o">!</span><span class="n">SignalObjectAndWaitStub</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">memset</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">ntdll</span><span class="o">!</span><span class="n">memset</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">BaseFormatTimeOut</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 9:</strong> <em>Call Stack at End of First PullRow</em></p> <p>It seems from the code in <em>Code Snippet 9</em>, that we wait to be signaled, so the execution can continue, and when we open the "full" file (<code>pull_row_full.txt</code>), we can see that, that is indeed what happens:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Signal</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Switch</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">SignalObjectAndWaitStub</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">memset</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">ntdll</span><span class="o">!</span><span class="n">memset</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">BaseFormatTimeOut</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1">// above was the last lines in the first file</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">ntdll</span><span class="o">!</span><span class="n">NtSignalAndWaitForSingleObject</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Switch</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">QueryPerformanceCounterStub</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">ntdll</span><span class="o">!</span><span class="n">RtlQueryPerformanceCounter</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Switch</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">TaskTransition</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 10:</strong> <em>PullRow Being Signaled</em></p> <p>From <em>Code Snippet 10</em>, we see how <code>Pull</code> is signaled, and continues on with a <code>Switch</code> and a <code>TaskTransition</code>. The signal happens when SQL Server receives data from the SqlSatellite. There is an internal method <code>sqllang!CSQLSatelliteConnection::ReadCallBackInternal</code> which is being called when data is received, and part of <code>ReadCallBackInternal</code> is a signal call <code>sqllang!EventInternal&lt;SuspendQueueSLock&gt;::SignalAll</code>.</p> <p>Having briefly discussed signaling, let's go back to <code>pull_row_full.txt</code> and look further down in the file, where we see our first <code>ProcessResultRows</code>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>ProcessResultRows</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqldk</span><span class="o">!</span><span class="n">CMemProc</span><span class="o">::</span><span class="n">Alloc</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">GetSQLSatelliteMessage</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReceiveOneDataChunk</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">CSQLSatelliteCommunication</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReceiveOneDataChunk</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 11:</strong> <em>ProcessResultRows Called in PullRow</em></p> <p>We see how the code in <em>Code Snippet 11</em> is the same as the first lines of the file <code>wt1.txt</code>.</p> <p>Now we should be able to answer the first question we had; why <code>PullRow</code> is called directly after <code>SendPackets</code>: it is being called to wait for a call-back and continue handling receiving of data. But what else goes on in <code>PullRow</code>, we see the first <code>ProcessResultRows</code> at around line 3342, so there must be other "stuff" happening as well?</p> <p>In fact, if we look a couple of lines above where we found <code>ProcessResultRows</code> in <code>pull_row_full.txt</code> we'll see something like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>OutputSchema</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">BeginOutput</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputSchema</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1">// here is the first ProcessResultRows</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 12:</strong> <em>End of ProcessOutputSchema</em></p> <p>What we see in <em>Code Snippet 12</em> is how, above the first call to <code>ProcessResultRows</code>, we are in a routine named <code>ProcessOutputSchema</code>, and if we go upwards we see how there are at least three more routines dealing with schema:</p> <ul> <li><code>sqllang!CUDXR_ExternalScript::GetOutputSchema</code></li> <li><code>sqllang!CServerCargoContext::ReadSchemaInternal</code></li> <li><code>sqllang!CServerCargoContext::ReadSchemaFromPackets</code></li> </ul> <p>If we were to set breakpoints at those routines together with <code>PullRow</code> and <code>ProcessResultRows</code>, the flow (highly simplified) when executing would be something like this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Flow</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendPackets</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputSchema</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">GetOutputSchema</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadSchemaInternal</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadSchemaFromPackets</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 13:</strong> <em>Code Flow Handling Schema</em></p> <p>So what SQL Server is doing is that before it start processing the returning rows, it determines what the schema is for the result-set. As far as I can tell, SQL Server uses both the initial "small" packet from the SqlSatellite as well as the packet containing the actual result-set data.</p> <h2>Summary</h2> <p>This post tried to determine what SQL Server is doing when data is being returned from the SqlSatellite. We saw how, after the data packet(s) were sent to the SqlSatellite:</p> <ul> <li>Immediately <code>sqllang!CUDXR_ExternalScript::PullRow</code> was called, and waited to be signaled when data was returned.</li> <li>The schema of the returning data was determined by calls to <code>sqllang!CUDXR_ExternalScript::ProcessOutputSchema</code>, <code>sqllang!CUDXR_ExternalScript::GetOutputSchema</code>, <code>sqllang!CServerCargoContext::ReadSchemaInternal</code>, and <code>sqllang!CServerCargoContext::ReadSchemaFromPacket</code>.</li> <li>The result rows were processed, and turned into <em>TDS</em> packets, by calls to <code>ProcessResultRows</code> (one <code>ProcessResultRows</code> per row).</li> <li>A final <code>ProcessResultRows</code> was called to indicate that no more rows are coming.</li> </ul> <p>The figure below illustrates the flow:</p> <p><img class="center" src="/images/posts/sql_r_services_17_flow.png" width="800" height="527" > <strong>Figure 3:</strong> <em>Code Flow Receiving Data from SqlSatellite</em></p> <p>If you have read <a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Internals - XV</a>, you see how <em>Figure 3</em> is similar. I have however "compacted" the sending data to SqlSatellite somewhat. The numbered arrows shows the communication out to and in from SQL Server, and in what order it happens:</p> <ol> <li>SQL Server opens named pipe connection to the launchpad service.</li> <li>Message sent to the launchpad service.</li> <li>After the call above, the SqlSatellite opens a TCP/IP connection to SQL Server.</li> <li>SQL Server sends the first packet to the SQL Satellite for authentication purposes.</li> <li>A second authentication packet is sent to SqlSatellite.</li> <li>The script is sent from inside <code>sqllang!CSatelliteProxy::PostSetupMessage</code></li> <li>The data for <code>@input_data_1</code> is sent together with two end packets.</li> <li>Packet are coming back to SQL Server containing meta-data and the actual data.</li> <li><code>PullRow</code> is being signaled.</li> <li>Execution continues to process meta-data as well as result rows.</li> </ol> <p>There are still a couple of things to discuss about data coming back to SQL Server, as well a how errors are handled, and we'll do that in a future post.</p> <h2>~ Finally</h2> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/&text=Microsoft SQL Server R Services - Internals XVII&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2018/01/03/microsoft-sql-server-r-services-internals-xvii/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/ &title=Microsoft SQL Server R Services - Internals XVII &summary=Blog post: Using WinDbg to find out what happens inside SQL Server when data is returned from SqlSatellite &source=http://www.nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> <br/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad2 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="1158080725" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2018/08/05/interesting-stuff-week-31/"> Interesting Stuff - Week 31 <small> (05 Aug 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/"> sp_execute_external_script and SQL Compute Context - III <small> (04 Aug 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/07/29/interesting-stuff-week-30/"> Interesting Stuff - Week 30 <small> (29 Jul 2018)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
