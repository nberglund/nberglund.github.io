<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Microsoft SQL Server R Services - Internals XVII &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Microsoft SQL Server R Services - Internals XVII</h1>
  <div class="post-subheading">
  <span class="post-date">03 Jan 2018</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>This is the 18:th post in a series about <strong>Microsoft SQL Server R Services</strong>, and the 17:th post that drills down into the internal of how it works. To see other posts (including this) in the series, go to <a href="/series/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a>.</p>

<p>The last <em>Internals</em> posts have discussed the transport of data between SQL Server and the SqlSatellite. In <a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Internals - XVI</a> we looked at how data came back from the SqlSatellite, and what the data looked like.</p>

<!--more-->

<p>This post is a continuation of that post, and here we’ll look at what happens inside SQL Server when data is returned from the SqlSatellite and the R engine.</p>

<h2 id="recap">Recap</h2>

<p>In <a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Internals - XVI</a> we looked at the packets being sent back to SQL Server from the SqlSatellite when a dataset is returned. We saw how there were actually two packets coming back, one small and one bigger, we deduced that those packets were:</p>

<ul>
  <li>The smaller packet had something to do with column meta-data. We’ll try and see what we can find out about this packet in this post.</li>
  <li>The bigger packet held the actual data.</li>
</ul>

<p>The reason why the second package was bigger was due to the data being treated as originating from nullable columns, so quite an overhead was put onto the various columns:</p>

<table>
  <thead>
    <tr>
      <th>Data Type</th>
      <th style="text-align: center">1 Row</th>
      <th style="text-align: center">2 Rows</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>tinyint</td>
      <td style="text-align: center">2051</td>
      <td style="text-align: center">2055</td>
      <td>-</td>
    </tr>
    <tr>
      <td>smallint</td>
      <td style="text-align: center">2051</td>
      <td style="text-align: center">2055</td>
      <td>-</td>
    </tr>
    <tr>
      <td>int</td>
      <td style="text-align: center">2051</td>
      <td style="text-align: center">2055</td>
      <td>-</td>
    </tr>
    <tr>
      <td>real</td>
      <td style="text-align: center">1078</td>
      <td style="text-align: center">1086</td>
      <td>-</td>
    </tr>
    <tr>
      <td>float</td>
      <td style="text-align: center">1078</td>
      <td style="text-align: center">1086</td>
      <td>No difference related to storage size</td>
    </tr>
    <tr>
      <td>bigint</td>
      <td style="text-align: center">1078</td>
      <td style="text-align: center">1086</td>
      <td> </td>
    </tr>
    <tr>
      <td>money</td>
      <td style="text-align: center">1078</td>
      <td style="text-align: center">1086</td>
      <td> </td>
    </tr>
    <tr>
      <td>decimal</td>
      <td style="text-align: center">1078</td>
      <td style="text-align: center">1086</td>
      <td>No difference related to storage size</td>
    </tr>
  </tbody>
</table>

<p><strong>Table 1:</strong> <em>Packet Sizes from SqlSatellite</em></p>

<p>Part of the overhead is the 32 bytes column overhead as we discussed in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>, and a 28 bytes end-sequence, where the end-sequence appears once per data-set, and is not per column. It is somewhat like a row in the data-set. Part of this post is trying to figure out what goes on with this end-sequence.</p>

<p>When looking at the various sizes coming back, we see it is a lot less than what we saw in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>, sending data to SqlSatellite. This is due to R supporting a lot less data-types than SQL Server, and therefore the data might be implicitly converted to a compatible data type.</p>

<h2 id="housekeeping">Housekeeping</h2>

<p>Housekeeping in this context is talking about the tools we’ll use, as well as the code. This section is here here for those of who want to follow along in what we’re doing in the posts.</p>

<h4 id="helper-tools">Helper Tools</h4>

<p>To help us figure out the things we want, we will use <em>Process Monitor</em>, and <em>WinDbg</em>:</p>

<ul>
  <li><em>Process Monitor</em>, will be used it to filter TCP traffic. If you want to refresh your memory about how to do it, we covered that in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> as well as in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>.</li>
  <li>In the last few posts I have used <em>WinDbg preview</em> a my debugger, but in this post I am reverting back to <em>WinDbg</em> “classic”. If you need help with setting it up, that is covered in <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I</a>.</li>
</ul>

<h4 id="code">Code</h4>

<p>The code below sets up the database and creates some tables with some data. It is more or less the same as we’ve used in the last posts:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">ResultData</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">ResultData</span><span class="p">;</span>
<span class="k">GO</span>

<span class="n">USE</span> <span class="n">ResultData</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span><span class="p">(</span><span class="n">RowID</span> <span class="n">bigint</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> 
                          <span class="n">y</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand1</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
              <span class="n">rand2</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand3</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> 
              <span class="n">rand4</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand5</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">);</span>
<span class="k">GO</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">rand_1M</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">rand3</span><span class="p">,</span> <span class="n">rand4</span><span class="p">,</span> <span class="n">rand5</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span> 
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">20</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">25</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">50</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">100</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o1</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o2</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o3</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o4</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Database, and Database Object Creation</em></p>

<p>The code we’ll use should by now look very familiar:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(10)
                             OutputDataSet&lt;-InputDataSet'</span>
               <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT TOP(1) rand1 FROM dbo.rand_1M'</span>
</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Base Code to Execute</em></p>

<p>The reason there is a <code class="highlighter-rouge">Sys.sleep</code> in the code in <em>Code Snippet 2</em>, is so we can more easily determine at about what time data should be coming back from the SqlSatellite.</p>

<h2 id="windbg-debugging">WinDbg Debugging</h2>

<p>In <a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Internals - XV</a>, we used <em>WinDbg</em>, and we saw the routines involved when sending data to the SqlSatellite:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushRow</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">PostOneRow</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">WritePayloadHeader</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">WriteData</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushEOS</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">WriteMessageBlockDone</span>
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Routines Used when Sending Data</em></p>

<p>Now we’ll aim to do the same thing here, and we’ll start with trying to find routines being used when receiving data, and we’ll start with trying to find the “main” routine for receiving results. Remember in <a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Internals - XV</a>, we saw how <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::PushRow</code> where were things “started”, when sending data. Perhaps there is something similar in the <code class="highlighter-rouge">CUDXR_ExternalScript</code> when receiving? So:</p>

<ul>
  <li>Start up <em>WinDbg</em> as admin.</li>
  <li>Attach to the SQL Server process.</li>
</ul>

<p>After having attached to the process, execute in the <em>WinDbg</em> console: <code class="highlighter-rouge">x sqllang!CUDXR_ExternalScript*</code>. That returns quite a few routines, from which we can see if anyone looks promising. When I ran it I found a couple that caught my interest:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
</code></pre></div></div>
<p><strong>Code Snippet 4:</strong> <em>Interesting sqllang!CUDXR_ExternalScript Routines</em></p>

<p>Let’s now set breakpoints at the two routines above, plus a breakpoint at <code class="highlighter-rouge">sqllang!CSatelliteCargoContext::SendPackets</code>. The reason for the breakpoint at <code class="highlighter-rouge">SendPackets</code> is that it is there to indicate where we are, as <code class="highlighter-rouge">PullRow</code> can be called based on processing inside SQL Server, not only as result of data coming back from the SqlSatellite. Now execute the code in <em>Code Snippet 2</em>, and you’ll see how:</p>

<ul>
  <li><code class="highlighter-rouge">PullRow</code> is called once before <code class="highlighter-rouge">SendPackets</code> - that’s not interesting to us.</li>
  <li><code class="highlighter-rouge">SendPackets</code> is called.</li>
  <li><code class="highlighter-rouge">PullRow</code> is called.</li>
  <li>A pause followed by <code class="highlighter-rouge">ProcessResultRows</code> being called twice.</li>
</ul>

<p>A couple of questions comes up after having seen the above:</p>

<ul>
  <li>Why is the second <code class="highlighter-rouge">PullRow</code> called immediately after <code class="highlighter-rouge">SendPackets</code>?</li>
  <li>Why are there two <code class="highlighter-rouge">ProcessResultRows</code>, when only one row is returned?</li>
</ul>

<p>Just to confirm the last bullet point; change the <code class="highlighter-rouge">TOP</code> clause in <em>Code Snippet 2</em> to 5 instead of one and execute again. The breakpoint at <code class="highlighter-rouge">ProcessResultRows</code> is now hit 6 times. So <code class="highlighter-rouge">ProcessResultRows</code> is definitely related to number of rows returned, but also something else. Let’s see if we can figure out what happens here:</p>

<ul>
  <li>Disable all breakpoints except for the <code class="highlighter-rouge">ProcessResultRows</code> breakpoint.</li>
  <li>Clear the <em>WinDbg</em> command window by <code class="highlighter-rouge">.cls</code>.</li>
  <li>Change the <code class="highlighter-rouge">TOP</code> clause in <em>Code Snippet 2</em> to be 3.</li>
  <li>Execute the code.</li>
  <li>Each time the <code class="highlighter-rouge">ProcessResultRows</code> breakpoint do a <code class="highlighter-rouge">wt -l4</code> (trace and watch 4 levels deep).</li>
  <li>After each “trace and watch”, copy the output to new files and name them <code class="highlighter-rouge">wt1.txt</code>, <code class="highlighter-rouge">wt2.txt</code>, etc.</li>
</ul>

<p>There should, after completing the execution, be four files, let’s compare these four files.</p>

<blockquote>
  <p><strong>NOTE:</strong> If you haven’t done the <code class="highlighter-rouge">wt</code> as above, you can download the four files, plus a couple of others from <a href="/downloads/misc/sql_r_services_internal17.zip">here</a>.</p>
</blockquote>

<p>What we see is that the first file is bigger than the others, it has ~165 lines whereas the others are between 65 - 70 lines. The last third part of the first file (from about line 104), looks very much like the second and third files. We can also see that the fourth file is not similar to the other tree.</p>

<p>Now what we’ll do is to look at the similarities between the three first files and try to understand what is happening. In the files we see some interesting routines:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
   <span class="p">...</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">GetSQLSatelliteMessage</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">ReadData</span>
     <span class="p">...</span>
      <span class="n">MSVCR120</span><span class="o">!</span><span class="n">memcpy_s</span>
        <span class="n">MSVCR120</span><span class="o">!</span><span class="n">memcpy</span>
        <span class="n">MSVCR120</span><span class="o">!</span><span class="n">MoveSmall</span>
      <span class="n">MSVCR120</span><span class="o">!</span><span class="n">memcpy_s</span>
    <span class="p">...</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">OutputRow</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CTds74</span><span class="o">::</span><span class="n">SendRowImpl</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CColMetaData</span><span class="o">::</span><span class="n">CCols</span>
    <span class="p">...</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">OutputRow</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
</code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>Routines from sqllang!CUDXR_ExternalScript::ProcessResultRows</em></p>

<p>By now we understand that <code class="highlighter-rouge">ProcessResultRows</code> is doing what it says on the packet; it takes the rows coming back from the SqlSatellite, processes it, and then outputs it through <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::OutputRow</code>. From what we see in <em>Code Snippet 5</em>, it looks like the rows being outputted is outputted in the <em>TDS</em> format - look at the calls to <code class="highlighter-rouge">sqllang!CTds74::SendRowImpl</code>. This would make sense since clients etc., do not “speak” <em>BXL</em>, and from what we’ve seen - <em>BXL</em> is what is coming back from the SqlSatellite.</p>

<blockquote>
  <p><strong>EDITED:</strong> The following section down to <code class="highlighter-rouge">PullRow</code> has been slightly changed, to make it more readable.</p>
</blockquote>

<p>So the similar code in the three files (<code class="highlighter-rouge">wt1</code>, <code class="highlighter-rouge">wt2</code>, and <code class="highlighter-rouge">wt3</code>) processes the rows coming back, and outputs them as TDS, cool! So what about the first part of the first <code class="highlighter-rouge">ProcessResultRows</code>, what does that do? Let’s have a look at the trace file for the first <code class="highlighter-rouge">ProcessResultRows</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
    <span class="p">...</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">GetSQLSatelliteMessage</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
    <span class="p">...</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReceiveOneDataChunk</span>
      <span class="p">...</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">BindBufferForRead</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">ReadPayloadHeader</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">BindBufferForRead</span>
    <span class="p">...</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReceiveOneDataChunk</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">SendAckMessage</span>
        <span class="p">...</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">SendAckMessage</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">PostWriteRequest</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WriteMessage</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">SendAckMessage</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">WaitWriteDone</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">SendAckMessage</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReceiveOneDataChunk</span>
     <span class="p">...</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">BindBufferForRead</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessage</span><span class="o">::</span><span class="n">BindBufferForRead</span>
    <span class="p">...</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">ReadPayloadHeader</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteMessageDataChunk</span><span class="o">::</span><span class="n">BindBufferForRead</span>
  <span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>Routines from First ProcessResultRows</em></p>

<p>In <em>Code Snippet 6</em> we see various parts of the first 2/3 of the first call to <code class="highlighter-rouge">ProcessResultRows</code>. What is interesting is the <code class="highlighter-rouge">sqllang!CServerCargoContext::ReceiveOneDataChunk</code>, <code class="highlighter-rouge">sqllang!CSQLSatelliteMessageDataChunk::ReadPayloadHeader</code> and the <code class="highlighter-rouge">sqllang!CSQLSatelliteCommunication::SendAckMessage</code> calls.</p>

<p>From what I gather, the <code class="highlighter-rouge">ReceiveOneDataChunk</code> routine reads in data that has been received from a socket, the <code class="highlighter-rouge">ReadPayloadHeader</code> reads the column header for each column in the result-set being returned, in order to determine data types etc. The <code class="highlighter-rouge">SendAckMessage</code>, sends a message back to the SqlSatellite, most likely indicating that SQL Server has received the two packages being sent from the SqlSatellite. We can confirm the “sending message back” part by:</p>

<ul>
  <li>Disabling all break-point in <em>WinDbg</em> except for the breakpoint at <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ProcessResultRows</code>.</li>
  <li>Set a breakpoint at <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::WriteMessage</code>, but disable it.</li>
  <li>Run <em>Process Monitor</em> as admin and load the filter we used in <a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Internals - XVI</a> where we filtered for <code class="highlighter-rouge">TCP Send</code> and <code class="highlighter-rouge">TCP Receive</code> for <code class="highlighter-rouge">BxlServer.exe</code>.</li>
</ul>

<p>Execute the code in <em>Code Snippet 2</em>, and when you hit the <code class="highlighter-rouge">ProcessResultRows</code> breakpoint, look at the output from <em>Process Monitor</em>. You should see something like so:</p>

<p><img src="/images/posts/sql_r_services_17_procmon1.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Output Before WriteMessage</em></p>

<p>We see in <em>Figure 1</em> how the two data packets have been sent to SQL Server, but nothing else has happened. Enable the <code class="highlighter-rouge">WriteMessage</code> break-point and continue the execution. We’ll now break at <code class="highlighter-rouge">WriteMessage</code>, but nothing has happened in <em>Process Monitor</em> (no more packages have been sent or received). However, when we now continue the execution we’ll see in *Process Monitor how a packet is sent to the SqlSatellite (<code class="highlighter-rouge">BxlServer.exe</code>) with a length of 28 bytes, and then two packets are returned back from the SQlSatellite:</p>

<p><img src="/images/posts/sql_r_services_17_procmon2.png" alt="" /></p>

<p><strong>Figure 2</strong> <em>Output After WriteMessage</em></p>

<p>We see the ack message sent to the SqlSatellite outlined in red in <em>Figure 2</em>, and the two packets coming back outlined in blue. Further down in this post as well as in an upcoming post we’ll see if we can determine what the two packets coming back from the SqlSatellite do.</p>

<p>Now we’ve seen how the first <code class="highlighter-rouge">ProcessResultRows</code> is doing both schema “stuff” as well as processing the first row, and how the second and third <code class="highlighter-rouge">ProcessResultRows</code>, handle the remaining rows. What about the fourth file, the last <code class="highlighter-rouge">ProcessResultRows</code> - what does that one do? Let’s have a look at some of the calls that happens:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
    <span class="p">...</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">GetSQLSatelliteMessage</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReceiveOneDataChunk</span>
      <span class="p">...</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">EndOutput</span>
    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">EndOutput</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CTdsConn</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;::</span><span class="n">EndResultSetImpl</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">SendDoneWarnings</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CTdsConn</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;::</span><span class="n">EndResultSetImpl</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">EndOutput</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
</code></pre></div></div>
<p><strong>Code Snippet 7:</strong> <em>Routines from Last ProcessResultRows</em></p>

<p>From the code in <em>Code Snippet 7</em> we see how there is a <code class="highlighter-rouge">ReceiveOneDataChunk</code> call, which indicates data is being read after having  been received from a socket. It also looks like that this last <code class="highlighter-rouge">ProcessResultRows</code> indicates that there are no more data: <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::EndOutput</code>, <code class="highlighter-rouge">sqllang!CTdsConn&lt;0&gt;::EndResultSetImpl</code> and <code class="highlighter-rouge">sqllang!SendDoneWarnings</code>. The question is what indicates this in the packets SQL Server receives from the SqlSatellite? This is now some speculation from my side, but I strongly suspect this originates from one of the 28 byte packets coming back from SqlSatellite after SQL Server sent the ack message above. I also think that the end-sequence that we mentioned in <a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Internals - XVI</a> as well as in the <em>Recap</em> above, has something to do with this.</p>

<p>Now we should be able to answer the question above about why there are one more <code class="highlighter-rouge">ProcessResultRows</code> than rows returned, and we should also have a fairly good grasp of what happens when processing rows returned from the SqlSatellite:</p>

<ul>
  <li>Rows are processed by <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ProcessResultRows</code>.</li>
  <li>During the first <code class="highlighter-rouge">ProcessResultRows</code> the column header(s) are processed, followed by the first row.</li>
  <li>Subsequent rows are processed by <code class="highlighter-rouge">ProcessResultRows</code>.</li>
  <li>A final <code class="highlighter-rouge">ProcessResultRows</code> processes one of the packets received back from SqlSatellite after ack message has been sent.</li>
</ul>

<p>So, what about the first question we had above; why is there a <code class="highlighter-rouge">PullRow</code> called straight after <code class="highlighter-rouge">SendPackets</code>, e.g. the <code class="highlighter-rouge">PullRow</code> happens before data is returned from the SqlSatellite? To try to figure this out, let’s disable all breakpoints, except for the breakpoint at <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ProcessResultRows</code>, and execute <em>Code Snippet 2</em> again (you can take out the <code class="highlighter-rouge">Sys.sleep</code> if you want). When you execute and hit the breakpoint <code class="highlighter-rouge">ProcessResultRows</code> for the first time, look at the call-stack: <code class="highlighter-rouge">k</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span><span class="o">+</span><span class="mh">0xf4</span>
<span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span><span class="o">+</span><span class="mh">0x196</span>
<span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">GetRow</span><span class="o">+</span><span class="mh">0x81</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span><span class="o">+</span><span class="mh">0x4dc</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtSelect</span><span class="o">::</span><span class="n">XretExecute</span><span class="o">+</span><span class="mh">0x322</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;+</span><span class="mh">0x40d</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span><span class="o">+</span><span class="mh">0xa9e</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x983</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span><span class="o">+</span><span class="mh">0x140e</span>
<span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 8:</strong> <em>Call Stack at First ProcessResultRows</em></p>

<p>What we see in <em>Code Snippet 8</em>  is the important part of the call-stack and we can see how <code class="highlighter-rouge">ProcessResultRows</code> is called from within <code class="highlighter-rouge">PullRow</code>. Interesting, <code class="highlighter-rouge">PullRow</code> is called right after <code class="highlighter-rouge">SendPackets</code>, before the result has come back, and still <code class="highlighter-rouge">ProcessResultRows</code> is called from within <code class="highlighter-rouge">PullRow</code>, after the result is back? Let’s see if we can figure out what’s happening:</p>

<ul>
  <li>Disable all breakpoints.</li>
  <li>Set a breakpoint at <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::PullRow</code>.</li>
  <li>Change the <code class="highlighter-rouge">Sys.sleep(10)</code> in <em>Code Snippet 2</em>, to <code class="highlighter-rouge">Sys.sleep(60)</code>.</li>
  <li>Execute the code.</li>
  <li>Continue past the first <code class="highlighter-rouge">PullRow</code>.</li>
</ul>

<p>When you hit the <code class="highlighter-rouge">PullRow</code> for the second time, do a <code class="highlighter-rouge">wt</code>. You’ll see how the code continues, up until the execution starts in the R engine, and the code hits <code class="highlighter-rouge">Sys.sleep</code>. At this stage, copy out the output from <code class="highlighter-rouge">wt</code> into a new file (call it <code class="highlighter-rouge">pull_row_1.txt</code>).</p>

<blockquote>
  <p><strong>NOTE:</strong> The trace files for <code class="highlighter-rouge">PullRow</code> are also part of the download mentioned above.</p>
</blockquote>

<p>At some stage the execution continues, and after the full <code class="highlighter-rouge">wt</code>, copy the whole trace into a second file <code class="highlighter-rouge">pull_row_full.txt</code>. Now open the <code class="highlighter-rouge">pull_row_1.txt</code> file, and look at the last 11 lines (for me it starts at around line 888):</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Switch</span>
  <span class="n">KERNEL32</span><span class="o">!</span><span class="n">QueryPerformanceCounter</span>
  <span class="n">ntdll</span><span class="o">!</span><span class="n">RtlQueryPerformanceCounter</span>
<span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Switch</span>
  <span class="n">KERNEL32</span><span class="o">!</span><span class="n">SignalObjectAndWaitStub</span>
  <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span>
    <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">memset</span>
    <span class="n">ntdll</span><span class="o">!</span><span class="n">memset</span>
  <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span>
    <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">BaseFormatTimeOut</span>
  <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span>
</code></pre></div></div>
<p><strong>Code Snippet 9:</strong> <em>Call Stack at End of First PullRow</em></p>

<p>It seems from the code in <em>Code Snippet 9</em>, that we wait to be signaled, so the execution can continue, and when we open the “full” file (<code class="highlighter-rouge">pull_row_full.txt</code>), we can see that, that is indeed what happens:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Switch</span>
    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">SignalObjectAndWaitStub</span>
    <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span>
      <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">memset</span>
      <span class="n">ntdll</span><span class="o">!</span><span class="n">memset</span>
    <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span>
      <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">BaseFormatTimeOut</span>
    <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span>

<span class="c1">// above was the last lines in the first file</span>

      <span class="n">ntdll</span><span class="o">!</span><span class="n">NtSignalAndWaitForSingleObject</span>
    <span class="n">KERNELBASE</span><span class="o">!</span><span class="n">SignalObjectAndWait</span>
  <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Switch</span>
    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">QueryPerformanceCounterStub</span>
    <span class="n">ntdll</span><span class="o">!</span><span class="n">RtlQueryPerformanceCounter</span>
  <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Switch</span>
    <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">TaskTransition</span>
</code></pre></div></div>
<p><strong>Code Snippet 10:</strong> <em>PullRow Being Signaled</em></p>

<p>From <em>Code Snippet 10</em>, we see how <code class="highlighter-rouge">Pull</code> is signaled, and continues on with a <code class="highlighter-rouge">Switch</code> and a <code class="highlighter-rouge">TaskTransition</code>. The signal happens when SQL Server receives data from the SqlSatellite. There is an internal method <code class="highlighter-rouge">sqllang!CSQLSatelliteConnection::ReadCallBackInternal</code> which is being called when data is received, and part of <code class="highlighter-rouge">ReadCallBackInternal</code> is a signal call <code class="highlighter-rouge">sqllang!EventInternal&lt;SuspendQueueSLock&gt;::SignalAll</code>.</p>

<p>Having briefly discussed signaling, let’s go back to <code class="highlighter-rouge">pull_row_full.txt</code> and look further down in the file, where we see our first <code class="highlighter-rouge">ProcessResultRows</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
    <span class="n">sqldk</span><span class="o">!</span><span class="n">CMemProc</span><span class="o">::</span><span class="n">Alloc</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">GetSQLSatelliteMessage</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReceiveOneDataChunk</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">CSQLSatelliteCommunication</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReceiveOneDataChunk</span>
</code></pre></div></div>
<p><strong>Code Snippet 11:</strong> <em>ProcessResultRows Called in PullRow</em></p>

<p>We see how the code in <em>Code Snippet 11</em> is the same as the first lines of the file <code class="highlighter-rouge">wt1.txt</code>.</p>

<p>Now we should be able to answer the first question we had; why <code class="highlighter-rouge">PullRow</code> is called directly after <code class="highlighter-rouge">SendPackets</code>: it is being called to wait for a call-back and continue handling receiving of data. But what else goes on in <code class="highlighter-rouge">PullRow</code>, we see the first <code class="highlighter-rouge">ProcessResultRows</code> at around line 3342, so there must be other “stuff” happening as well?</p>

<p>In fact, if we look a couple of lines above where we found <code class="highlighter-rouge">ProcessResultRows</code> in <code class="highlighter-rouge">pull_row_full.txt</code> we’ll see something like so:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">BeginOutput</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputSchema</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span>

<span class="c1">// here is the first ProcessResultRows</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadOneRow</span>
</code></pre></div></div>
<p><strong>Code Snippet 12:</strong> <em>End of ProcessOutputSchema</em></p>

<p>What we see in <em>Code Snippet 12</em> is how, above the first call to <code class="highlighter-rouge">ProcessResultRows</code>, we are in a routine named <code class="highlighter-rouge">ProcessOutputSchema</code>, and if we go upwards we see how there are at least three more routines dealing with schema:</p>

<ul>
  <li><code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::GetOutputSchema</code></li>
  <li><code class="highlighter-rouge">sqllang!CServerCargoContext::ReadSchemaInternal</code></li>
  <li><code class="highlighter-rouge">sqllang!CServerCargoContext::ReadSchemaFromPackets</code></li>
</ul>

<p>If we were to set breakpoints at those routines together with <code class="highlighter-rouge">PullRow</code> and <code class="highlighter-rouge">ProcessResultRows</code>, the flow (highly simplified) when executing would be something like this:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendPackets</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputSchema</span>
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">GetOutputSchema</span>
      <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadSchemaInternal</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadSchemaFromPackets</span>
  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessResultRows</span>
</code></pre></div></div>
<p><strong>Code Snippet 13:</strong> <em>Code Flow Handling Schema</em></p>

<p>So what SQL Server is doing is that before it start processing the returning rows, it determines what the schema is for the result-set. As far as I can tell, SQL Server uses both the initial “small” packet from the SqlSatellite as well as the packet containing the actual result-set data.</p>

<h2 id="summary">Summary</h2>

<p>This post tried to determine what SQL Server is doing when data is being returned from the SqlSatellite. We saw how, after the data packet(s) were sent to the SqlSatellite:</p>

<ul>
  <li>Immediately <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::PullRow</code> was called, and waited to be signaled when data was returned.</li>
  <li>The schema of the returning data was determined by calls to <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::ProcessOutputSchema</code>, <code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::GetOutputSchema</code>, <code class="highlighter-rouge">sqllang!CServerCargoContext::ReadSchemaInternal</code>, and <code class="highlighter-rouge">sqllang!CServerCargoContext::ReadSchemaFromPacket</code>.</li>
  <li>The result rows were processed, and turned into <em>TDS</em> packets, by calls to <code class="highlighter-rouge">ProcessResultRows</code> (one <code class="highlighter-rouge">ProcessResultRows</code> per row).</li>
  <li>A final <code class="highlighter-rouge">ProcessResultRows</code> was called to indicate that no more rows are coming.</li>
</ul>

<p>The figure below illustrates the flow:</p>

<p><img src="/images/posts/sql_r_services_17_flow.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>Code Flow Receiving Data from SqlSatellite</em></p>

<p>If you have read <a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Internals - XV</a>, you see how <em>Figure 3</em> is similar. I have however “compacted” the sending data to SqlSatellite somewhat. The numbered arrows shows the communication out to and in from SQL Server, and in what order it happens:</p>

<ol>
  <li>SQL Server opens named pipe connection to the launchpad service.</li>
  <li>Message sent to the launchpad service.</li>
  <li>After the call above, the SqlSatellite opens a TCP/IP connection to SQL Server.</li>
  <li>SQL Server sends the first packet to the SQL Satellite for authentication purposes.</li>
  <li>A second authentication packet is sent to SqlSatellite.</li>
  <li>The script is sent from inside <code class="highlighter-rouge">sqllang!CSatelliteProxy::PostSetupMessage</code></li>
  <li>The data for <code class="highlighter-rouge">@input_data_1</code> is sent together with two end packets.</li>
  <li>Packet are coming back to SQL Server containing meta-data and the actual data.</li>
  <li><code class="highlighter-rouge">PullRow</code> is being signaled.</li>
  <li>Execution continues to process meta-data as well as result rows.</li>
</ol>

<p>There are still a couple of things to discuss about data coming back to SQL Server, as well a how errors are handled, and we’ll do that in a future post.</p>

<h2 id="-finally">~ Finally</h2>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/&text=Microsoft SQL Server R Services - Internals XVII&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2018/01/03/microsoft-sql-server-r-services-internals-xvii/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/
         &title=Microsoft SQL Server R Services - Internals XVII
         &summary=Blog post: Using WinDbg to find out what happens inside SQL Server when data is returned from SqlSatellite
         &source=http://www.nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-machine-learning-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Machine Learning Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#windbg">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WinDbg</span>
    </a>
  
    
    <a href="/tags/#launchpad">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Launchpad</span>
    </a>
  
    
    <a href="/tags/#rterm-exe">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">RTerm.exe</span>
    </a>
  
    
    <a href="/tags/#bxl">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">BXL</span>
    </a>
  
    
    <a href="/tags/#process-monitor">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Process Monitor</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2018/01/03/microsoft-sql-server-r-services-internals-xvii/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/07/29/interesting-stuff-week-30/">
            Interesting Stuff - Week 30
            <small>29 Jul 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
