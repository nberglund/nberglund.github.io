<!DOCTYPE html> <html lang="en-us"> <head> <!-- Google Tag Manager --> <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-K7B3642');</script> <!-- End Google Tag Manager --> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="A lowdown of sp_execute_external_script and its different parameters, using Process Monitor and WireShark"> <meta name="keywords" content="SQL Server R Services, SQL Server Machine Learning Services, R, Launchpad, Process Monitor, SqlSatellite, WireShark, sp_execute_external_script"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Microsoft SQL Server R Services - sp_execute_external_script - I &middot; Niels Berglund </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-d361e701e0c0e75e121ac3e901cff1b8.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.5.0 --> <title>Microsoft SQL Server R Services - sp_execute_external_script - I | Niels Berglund</title> <meta name="generator" content="Jekyll v3.8.2" /> <meta property="og:title" content="Microsoft SQL Server R Services - sp_execute_external_script - I" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A lowdown of sp_execute_external_script and its different parameters, using Process Monitor and WireShark" /> <meta property="og:description" content="A lowdown of sp_execute_external_script and its different parameters, using Process Monitor and WireShark" /> <link rel="canonical" href="http://nielsberglund.com/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/" /> <meta property="og:url" content="http://nielsberglund.com/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/" /> <meta property="og:site_name" content="Niels Berglund" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2018-03-07T19:37:31+02:00" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"http://nielsberglund.com/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/","headline":"Microsoft SQL Server R Services - sp_execute_external_script - I","dateModified":"2018-03-07T19:37:31+02:00","datePublished":"2018-03-07T19:37:31+02:00","author":{"@type":"Person","name":"nielsb"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://nielsberglund.com/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/"},"description":"A lowdown of sp_execute_external_script and its different parameters, using Process Monitor and WireShark","@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-3005153158271538", enable_page_level_ads: true }); </script> </head> <body> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K7B3642" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) --> <div class="sidebar"> <div class="container"> <div class="sidebar-about"> <h1> <a href="/"> Niels Berglund </a> </h1> <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Sidebar_rectangle --> <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-3005153158271538" data-ad-slot="7704601332"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/disclaimer/">Disclaimer</a> <a class="sidebar-nav-item" href="/series/">Blog Post Series</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <img class="center" src="/images/MVP_Logo_large.png" width="300" height="121" > <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <p>&copy; 2018. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">Microsoft SQL Server R Services - sp_execute_external_script - I</h1> <div class="post-subheading"> <span class="post-date">07 Mar 2018</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a> <a href="/categories/#SQL Server R Services">SQL Server R Services</a> <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <a href="/categories/#Microsoft R Server">Microsoft R Server</a> <a href="/categories/#Data Science">Data Science</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server R Services">SQL Server R Services</a> <a href="/tags/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <a href="/tags/#R">R</a> <a href="/tags/#Launchpad">Launchpad</a> <a href="/tags/#Process Monitor">Process Monitor</a> <a href="/tags/#SqlSatellite">SqlSatellite</a> <a href="/tags/#WireShark">WireShark</a> <a href="/tags/#sp_execute_external_script">sp_execute_external_script</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> <p>This post is part of a series of blog-posts about Microsoft SQL Server R Services:</p> <ol> <li><a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">Microsoft SQL Server 2016 R Services Installation</a></li> <li><a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Microsoft SQL Server R Services - Internals I</a></li> <li><a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Microsoft SQL Server R Services - Internals II</a></li> <li><a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Microsoft SQL Server R Services - Internals III</a></li> <li><a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Microsoft SQL Server R Services - Internals IV</a></li> <li><a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Microsoft SQL Server R Services - Internals V</a></li> <li><a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Microsoft SQL Server R Services - Internals VI</a></li> <li><a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Microsoft SQL Server R Services - Internals VII</a></li> <li><a href="/2017/07/22/microsoft-sql-server-r-services-internals-viii/">Microsoft SQL Server R Services - Internals VIII</a></li> <li><a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Microsoft SQL Server R Services - Internals IX</a></li> <li><a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Microsoft SQL Server R Services - Internals X</a></li> <li><a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">Microsoft SQL Server R Services - Internals XI</a></li> <li><a href="/2017/10/31/microsoft-sql-server-r-services-internals-xii/">Microsoft SQL Server R Services - Internals XII</a></li> <li><a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">Microsoft SQL Server R Services - Internals XIII</a></li> <li><a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Microsoft SQL Server R Services - Internals XIV</a></li> <li><a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Microsoft SQL Server R Services - Internals XV</a></li> <li><a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Microsoft SQL Server R Services - Internals XVI</a></li> <li><a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Microsoft SQL Server R Services - Internals XVII</a></li> <li><a href="/2018/01/10/microsoft-sql-server-r-services-internals-xviii/">Microsoft SQL Server R Services - Internals XVIII</a></li> <li><a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Microsoft SQL Server R Services - Internals XIX</a></li> <li><a href="/2018/02/02/microsoft-sql-server-r-services-internals-xx/">Microsoft SQL Server R Services - Internals XX</a></li> <li>Microsoft SQL Server R Services: sp_execute_external_script - I (this post)</li> <li><a href="/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/">Microsoft SQL Server R Services - sp_execute_external_script - II</a></li> <li><a href="/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/">Microsoft SQL Server R Services: sp_execute_external_script - III</a> <em>last post in the series</em></li> </ol> <p>This post is the 22:nd, post about <strong>Microsoft SQL Server R Services</strong>. This journey started about a year ago when I thought it would be a good idea to write a couple of blog posts about, what then went under the name of, Microsoft SQL Server 2016 R Services. Never in my wildest fantasies did I think I would write over 20 posts.</p> <blockquote><p><strong>NOTE:</strong> Since the introduction of Microsoft SQL Server R Services, it has been renamed to <strong>Microsoft SQL Server Machine Learning Services</strong>.</p></blockquote> <p>This series began with a discussion about how to install Microsoft SQL Server R Services and continued with the internals of how it works internally in SQL Server and the launchpad service. Throughout the series, we have used <code>sp_execute_external_script</code> when investigating what goes on. So, I thought that having a couple of posts looking at <code>sp_execute_external_script</code> would be a good way to finish this series off, and this post is the first of two about <code>sp_execute_external_script</code>.</p> <!--more--> <h2>Housekeeping</h2> <p>Before we "dive" into today's topics let us look at the code and the tools we use today. This section is here for those of who want to follow along in what we are doing in the post.</p> <h4>Helper Tools</h4> <p>To help us figure out the things we want, we use <em>Process Monitor</em>, and <em>WireShark</em>:</p> <ul> <li><em>Process Monitor</em>, is used it to filter TCP traffic. If you want to refresh your memory about how to do it, we covered that in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> as well as in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>.</li> <li>I use <em>WireShark</em> for network packet sniffing. If you want a refresher about <em>WireShark</em>, we covered the setup and so forth in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a>.</li> </ul> <h4>Code</h4> <p>The code below sets up the database and creates some tables with some data. The data is based on the <a href="https://en.wikipedia.org/wiki/Iris_flower_data_set"><em>Iris</em></a> dataset:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Database Objects</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">IrisTestDb</span><span class="p">;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">IrisTestDb</span><span class="p">;</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">USE</span> <span class="n">IrisTestDb</span><span class="p">;</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_irisdata_full</span><span class="p">;</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_irisdata_full</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">(</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">RowID</span> <span class="n">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> <span class="n">SepalLength</span> <span class="n">float</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">SepalWidth</span> <span class="n">float</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span> <span class="n">PetalLength</span> <span class="n">float</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">PetalWidth</span> <span class="n">float</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span> <span class="n">Species</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">null</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">);</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_irisdata_even</span><span class="p">;</span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_irisdata_even</span>
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">(</span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">RowID</span> <span class="n">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> <span class="n">SepalLength</span> <span class="n">float</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">SepalWidth</span> <span class="n">float</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span> <span class="n">PetalLength</span> <span class="n">float</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">PetalWidth</span> <span class="n">float</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span> <span class="n">Species</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">null</span>
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">);</span>
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_irisdata_uneven</span><span class="p">;</span>
</div></div><div data-line='29' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_irisdata_uneven</span>
</div></div><div data-line='30' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">(</span>
</div></div><div data-line='31' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">RowID</span> <span class="n">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> <span class="n">SepalLength</span> <span class="n">float</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
</div></div><div data-line='32' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">SepalWidth</span> <span class="n">float</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span> <span class="n">PetalLength</span> <span class="n">float</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
</div></div><div data-line='33' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">PetalWidth</span> <span class="n">float</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span> <span class="n">Species</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">null</span>
</div></div><div data-line='34' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">);</span>
</div></div><div data-line='35' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='36' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='37' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_irisdata_full</span><span class="p">(</span> <span class="n">SepalLength</span><span class="p">,</span> <span class="n">SepalWidth</span><span class="p">,</span>
</div></div><div data-line='38' class='code-highlight-row numbered'><div class='code-highlight-line'>                                  <span class="n">PetalLength</span><span class="p">,</span> <span class="n">PetalWidth</span><span class="p">,</span> <span class="n">Species</span><span class="p">)</span>
</div></div><div data-line='39' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXECUTE</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='40' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
</div></div><div data-line='41' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'iris_data &lt;- iris;'</span>
</div></div><div data-line='42' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">''</span>
</div></div><div data-line='43' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="o">@</span><span class="n">output_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'iris_data'</span><span class="p">;</span>
</div></div><div data-line='44' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='45' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1">--split up the Iris data</span>
</div></div><div data-line='46' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_irisdata_even</span><span class="p">(</span> <span class="n">SepalLength</span><span class="p">,</span> <span class="n">SepalWidth</span><span class="p">,</span>
</div></div><div data-line='47' class='code-highlight-row numbered'><div class='code-highlight-line'>                                  <span class="n">PetalLength</span><span class="p">,</span> <span class="n">PetalWidth</span><span class="p">,</span> <span class="n">Species</span><span class="p">)</span>
</div></div><div data-line='48' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="n">SepalLength</span><span class="p">,</span> <span class="n">SepalWidth</span><span class="p">,</span> <span class="n">PetalLength</span><span class="p">,</span> <span class="n">PetalWidth</span><span class="p">,</span> <span class="n">Species</span>
</div></div><div data-line='49' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_irisdata_full</span>
</div></div><div data-line='50' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WHERE</span> <span class="n">RowID</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">0</span>
</div></div><div data-line='51' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='52' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_irisdata_uneven</span><span class="p">(</span> <span class="n">SepalLength</span><span class="p">,</span> <span class="n">SepalWidth</span><span class="p">,</span>
</div></div><div data-line='53' class='code-highlight-row numbered'><div class='code-highlight-line'>                                    <span class="n">PetalLength</span><span class="p">,</span> <span class="n">PetalWidth</span><span class="p">,</span> <span class="n">Species</span><span class="p">)</span>
</div></div><div data-line='54' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="n">SepalLength</span><span class="p">,</span> <span class="n">SepalWidth</span><span class="p">,</span> <span class="n">PetalLength</span><span class="p">,</span> <span class="n">PetalWidth</span><span class="p">,</span> <span class="n">Species</span>
</div></div><div data-line='55' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_irisdata_full</span>
</div></div><div data-line='56' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WHERE</span> <span class="n">RowID</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">1</span>
</div></div><div data-line='57' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='58' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="cm">/<em>
</div></div><div data-line='59' class='code-highlight-row numbered'><div class='code-highlight-line'>SELECT * FROM dbo.tb_irisdata_full
</div></div><div data-line='60' class='code-highlight-row numbered'><div class='code-highlight-line'>SELECT * FROM dbo.tb_irisdata_even
</div></div><div data-line='61' class='code-highlight-row numbered'><div class='code-highlight-line'>SELECT * FROM dbo.tb_irisdata_uneven
</div></div><div data-line='62' class='code-highlight-row numbered'><div class='code-highlight-line'></em>/</span>
</div></div><div data-line='63' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Creating Database Objects and Generating Data</em></p> <p>The code in <em>Code Snippet 1</em> should be fairly self explanatory. The reason why we split up the full Iris dataset is to later on in this post handle multiple datasets.</p> <h2>sp_execute_external_script</h2> <p>The first thing to do is to remind ourselves why we need <code>sp_execute_external_script</code> at all? Well, as opposed to SQLCLR, the external script engine is not embedded in SQL Server, but sits outside of SQL Server and runs in its own process - it is, (wait for it...), external :). So, if the external engine runs outside of SQL Server there needs to be a bridge between SQL and the engine - and <code>sp_execute_external_script</code> is that bridge.</p> <p>In most of the blog posts in this series we have used <code>sp_execute_external_script</code> something like so (or with variants thereof):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Execution of R Script</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>  <span class="o">@</span><span class="k">language</span> <span class="o">=</span><span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                                 <span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s1">'OutputDataSet&lt;-InputDataSet'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                                 <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span><span class="n">N</span><span class="s1">'SELECT 42'</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">(([</span><span class="n">TheAnswer</span><span class="p">]</span> <span class="n">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">));</span><br/>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span> </div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>Use of sp_execute_external_script</em></p> <p>When we compare <em>Code Snippet 2</em> with what the full signature of <code>sp_execute_external_script</code>, as in <em>Code Snippet 3</em>, we see that we have used <code>sp_execute_external_script</code> in a somewhat simplistic way:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>sp_execute_external_script</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'language'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'script'</span><span class="p">,</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="p">[</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="p">]</span> <span class="s1">'input_data_1'</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="p">]</span> <span class="n">N</span><span class="s1">'input_data_1_name'</span> <span class="p">]</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">output_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'output_data_1_name'</span> <span class="p">]</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">parallel</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="p">]</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="p">]</span> <span class="n">N</span><span class="s1">'@parameter_name data_type [ OUT | OUTPUT ] [ ,...n ]'</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">parameter1</span> <span class="o">=</span> <span class="p">]</span> <span class="s1">'value1'</span> <span class="p">[</span> <span class="k">OUT</span> <span class="o">|</span> <span class="k">OUTPUT</span> <span class="p">]</span> <span class="p">[</span> <span class="p">,...</span><span class="n">n</span> <span class="p">]</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">[</span> <span class="k">WITH</span> <span class="o">&lt;</span><span class="n">execute_option</span><span class="o">&gt;</span> <span class="p">]</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">[;]</span> </div></div></pre></div></figure></p> <p><strong>Code Snippet 3:</strong> <em>Full Signature of sp_execute_external_script</em></p> <p>In a majority of the blog posts, the only parameters used are: <code>@language</code>, <code>@script</code> and sometimes <code>@input_data_1</code>, but as we see in <em>Code Snippet 3</em>, there are more:</p> <ul> <li><code>@language</code></li> <li><code>@script</code></li> <li><code>@input_data_1</code></li> <li><code>@input_data_1_name</code></li> <li><code>@output_data_1_name</code></li> <li><code>@parallel</code></li> <li><code>@params</code></li> <li><code>@parameter1</code></li> </ul> <p>So, what are these parameters intended use? Let us find out.</p> <h2><code>@language</code></h2> <p>By now we should know what the <code>@language</code> parameter is for. It is to tell the launchpad service which launcher dll to initialise, which in turn targets the correct external engine. At the time of writing, there are two external engines which we can use; R and Python, and I would expect Microsoft to add other engines over time. From my side, I would love to see being able to call into .NET - outside of the SQL Engine.</p> <p><img class="center" src="/images/posts/sql_r_services_ect_script1.png" width="800" height="344" > <strong>Figure 1:</strong> <em>External Script and Language</em></p> <p><em>Figure 1</em> illustrates how the launchpad service chooses which launcher dll to launch based on the <code>@language</code> parameter.</p> <blockquote><p><strong>NOTE:</strong> <a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Microsoft SQL Server R Services - Internals II</a> covers more about the launchpad service and different types of launchers.</p></blockquote> <p>The <code>@language</code> parameter is a required parameter.</p> <h2><code>@script</code></h2> <p>The <code>@script</code> parameter defines the code the external engine executes, and is a required parameter:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Script</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                  <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                  <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                    iris_dataset &lt;- iris
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                    setosa &lt;- iris[iris$Species == "setosa",]
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                    meanSepWidth &lt;- mean(setosa$Sepal.Width)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                    cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 4:</strong> <em>Example of @script Parameter</em></p> <p>In <em>Code Snippet 4</em> we use the <a href="https://en.wikipedia.org/wiki/Iris_flower_data_set"><em>Iris</em></a> dataset, and we calculate the mean of the <a href="https://en.wikipedia.org/wiki/Sepal">sepal</a> width for the setosa species. We pass the script as a literal in the <code>@script</code> parameter. Passing the script as a literal is quite common, and you can see it in most examples of <code>sp_execute_external_script</code>. It is however not required to pass the script as a literal; it can be passed as a variable as well as loaded from a source file. Code snippets 5 and 7 show examples of this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Script Variable</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="n">scriptParam</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span> <span class="o">=</span><br/>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                    <span class="n">N</span><span class="s1">'iris_dataset &lt;- iris
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                    setosa &lt;- iris[iris$Species == "setosa",]
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                    meanSepWidth &lt;- mean(setosa$Sepal.Width)
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                    cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">;</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>                      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>                      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="o">@</span><span class="n">scriptParam</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 5:</strong> <em>Script Passed in via a Variable</em></p> <p>So, in <em>Code Snippet 5</em> we see how the script is passed in as a variable (<code>@scriptParam</code>). A use case for this can be that you have scripts stored in a table in a database, and when you want to execute the script you load the particular script into a variable.</p> <p>Onto loading a script via a source file; let us assume we have an R source file named <code>iris_r.r</code> with code like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>R</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">iris_dataset</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">iris</span><span class="w"></span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">setosa</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">iris</span><span class="p">[</span><span class="n">iris</span><span class="o">$</span><span class="n">Species</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"setosa"</span><span class="p">,]</span><span class="w"></span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">meanSepWidth</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">setosa</span><span class="o">$</span><span class="n">Sepal.Width</span><span class="p">)</span><span class="w"></span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">cat</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">"Seposa sepal mean width: "</span><span class="p">,</span><span class="w"> </span><span class="n">meanSepWidth</span><span class="p">))</span><span class="w"></span></div></div></pre></div></figure></p> <p><strong>Code Snippet 6:</strong> <em>R Source File Content</em></p> <p>The file is at: <code>c:\rscripts</code>. The way to execute <code>sp_execute_external_script</code> based on this looks like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Script Source File</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'source("c:/rscripts/iris_r.r")'</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 7:</strong> <em>Script Passed in Through Source File</em></p> <p>We see in <em>Code Snippet 7</em> how we use the R command <code>source</code> to load the source code. The <code>source</code> command causes R to accept its input from the named file. Input is read and parsed from that file until the end of the file is reached, then the parsed expressions are evaluated sequentially in the chosen environment. When you use the <code>source</code> command, like in <em>Code Snippet 7</em>, the file path needs to be accessible by the external engine.</p> <p>You may note how, in <em>Code Snippet 7</em>, the file path is defined like you would do in Linux: <code>c:/rscripts/iris_r.r</code>. To do it this way is not required, you can use Windows path definitions, but you have to escape the <code>\</code>, like this: <code>c:\\rscripts\\iris_r.r</code>.</p> <p>Oh, something to keep in mind is that the values for <code>@language</code>, <code>@script</code>, <code>@input_data_1</code>, <code>@input_data_1_name</code>, <code>@output_data_1_name</code> and <code>@params</code> all have to be explicit <code>nvarchar</code>. What I mean with that is when you assign a value to the particular parameter, it has to be <code>DECLARE</code>:ed as an <code>nvarchar</code>. An example of this is <em>Code Snippet 5</em> and the <code>@scriptParam</code> parameter. If the parameter value is not <code>DECLARE</code>:ed as an <code>nvarchar</code>, it has to prepended with <code>N</code> as we see for example in <em>Code Snippet 7</em>: <code>@language = N'R'</code> and <code>@script = N'source("c:/rscripts/iris_r.r")</code>. If you do not <code>DECLARE</code> or prepend with <code>N</code> you get an error like this:</p> <p><img class="center" src="/images/posts/sql_r_services_ext_script_nvarchar_error.png" width="590" height="75" > <strong>Figure 2:</strong> <em>Error non nvarchar Parameter Value</em></p> <p>One final thing about the <code>@script</code> parameter. Remember how we, back in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a>, discussed how SQL Server sends the actual script to the SqlSatellite via a socket connection? When we supply the script through a file name, the data sent is: <code>source("c:/rscripts/iris_r.r")</code>. It may be obvious, but I thought I would mention it regardless.</p> <blockquote><p><strong>NOTE:</strong> Later on in this post we talk some more about what SQL Server sends to the SqlSatellite.</p></blockquote> <h2><code>@input_data_1</code></h2> <p>The <code>@input_data_1</code> parameter, which is optional, specifies the input data used by the external script. You can only use a T-SQL <code>SELECT</code> statement to generate the data; so no stored procedure calls, but <code>SELECT</code> against views or table-valued functions work fine:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Input Data</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                iris_dataset &lt;- InputDataSet
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                setosa &lt;- iris_dataset[iris_dataset$Species == "setosa",]
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">,</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full'</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 8:</strong> <em>Using @input_data_1 with straight SELECT</em></p> <p>In <em>Code Snippet 8</em> wee set how the <code>@input_data_1</code> parameter contains a <code>SELECT</code> statement against the <code>dbo.tb_irisdata_full</code> table, and the statement executes during the <code>sp_execute_external_script</code> execution (in <a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">Internals - XIII</a> we discussed when the statement was executed). The dataset generated by the query is referred to in the script as <code>InputDataSet</code>, and we discuss the naming later in this post. The <code>SELECT</code> does not have to be against a table, it can be, as I mentioned above, against a view or a user-defined function as well.</p> <p>So this is straight-forward so far, but what about if you need multiple datasets loaded into the external engine? My first thought when I saw <code>sp_execute_external_script</code> and the <code>@input_data_1</code> parameter, was that if there is an <code>@input_data_1</code> parameter, then there surely must be <code>@input_data_2</code>, <code>@input_data_n</code> parameters as well. Well, there are not, bummer, so what do we do?</p> <p>A thought would be to try and execute multiple statements from the same parameter and then in the script, parse out the different datasets, something like this: `@input_data_1 = N'SELECT * FROM dbo.tb_irisdata_even; SELECT * FROM dbo.tb_irisdata_uneven'. Good suggestion but no cigar, because when you try - this happens:</p> <p><img class="center" src="/images/posts/sql_r_services_ext_script_multi_error.png" width="450" height="75" > <strong>Figure 3:</strong> <em>Multi Statement Error</em></p> <p>The error we see in <em>Figure 3</em> is not very descriptive, but what it means is that you cannot have multiple <code>SELECT</code> statements generating <strong>multiple</strong> datasets. What you can do however is to use <code>UNION</code> or <code>UNION ALL</code>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>UNION ALL</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                iris_dataset &lt;- InputDataSet
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                setosa &lt;- iris_dataset[iris_dataset$Species == "setosa",]
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">,</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_even UNION ALL
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>                              SELECT * FROM dbo.tb_irisdata_uneven'</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 9:</strong> <em>SELECT with UNION ALL</em></p> <p>The code in <em>Code Snippet 9</em> uses the <code>UNION ALL</code> to combine the results of two or more queries into a single dataset. However, as useful as that is, sometimes that does not work: what if the two queries do not contain the same data types, or if you need two (or more) individual data-sets? In that case, the solution is to retrieve data from inside the script (in addition to the input data from <code>@input_data_1</code>).</p> <p>To retrieve data from within the external script, we can use <code>ODBC</code> (in R it is the <code>RODBC</code> package) or the highly optimized Microsoft <a href="https://docs.microsoft.com/en-us/machine-learning-server/r-reference/revoscaler/revoscaler"><strong><code>RevoScaleR</code></strong></a> package. In the following example I use <code>RevoScaleR</code>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>RevoScaleR</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>          # set up connection string     <br/>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>          sqlConnString &lt;- "Driver=SQL Server;server=win10-dev;
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                            database=IrisTestDb;uid=&lt;some_uid&gt;;pwd=&lt;some_pwd&gt;"
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>          # define the data
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>          mydata &lt;- RxSqlServerData(table = NULL,
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>                                    sqlQuery = "SELECT *
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>                                    FROM dbo.tb_irisdata_uneven",
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>                                    connectionString = sqlConnString)
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>          # open the dataset
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>          rxOpen(mydata)
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>          # read the data
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>          iris_uneven &lt;- rxReadNext(mydata)
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>          versicolor &lt;- iris_uneven[iris_uneven$Species == "versicolor",]
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>          meanSepWidthVersi &lt;- mean(versicolor$SepalWidth)
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>          # get the data from the input data set
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>          iris_dataset &lt;- InputDataSet
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'>          setosa &lt;- iris_dataset[iris_dataset$Species == "setosa",]
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'>          meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'>          # output the data
</div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'>          cat(paste("Seposa sepal mean width:", meanSepWidth, ".",
</div></div><div data-line='29' class='code-highlight-row numbered'><div class='code-highlight-line'>                     "Versicolor sepal mean width:", meanSepWidthVersi))'</span><span class="p">,</span>
</div></div><div data-line='30' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_even'</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 10:</strong> <em>Multiple Data Sets using RevoScaleR</em></p> <p>The code in <em>Code Snippet 10</em> shows how we read in data within the script by the use of <code>RevoScaleR</code> functionality together with the data from the <code>@input_data_1</code> parameter, and how we subsequently calculate <code>mean</code> on the two data-sets.</p> <p>Cool, we have now seen how we pass data into the external script via the <code>@input_data_1</code> parameter, and how multiple data-sets can be used by querying data from inside the script. What about returning data to the caller, you know - like we quite often do from stored procedures?</p> <h2><code>@input_data_1_name</code> &amp; <code>@output_data_1_name</code></h2> <p>You may now wonder what this section has to do with returning data to the caller? Don't worry; we get there soon!</p> <p>So, there are some parameters in <code>sp_execute_external_script</code> that we have not used yet, and <code>@input_data_1_name</code> and <code>@output_data_1_name</code>, which both are optional, are two of them.</p> <h4><code>@input_data_1_name</code></h4> <p>We use this parameter to explicitly name the variable in the script that contains the data we pass into the external engine. But, hang on, we have not used the <code>@input_data_1_name</code> parameter in the various examples in this post where we pass data to the engine, and it still works? Ah, look in code snippets 8, 9 and 10, and you see a line of code: <code>iris_dataset &lt;- InputDataSet</code>. Here <code>InputDataSet</code> defines the input data, and it so happens that the default value of <code>@input_data_1_name</code> is <code>InputDataSet</code>.</p> <p>So, let us see what happens if we change some things. Copy the code in <em>Code Snippet 8</em> and change it to this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Input Name</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                iris_dataset &lt;- InputDataSet
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                setosa &lt;- iris_dataset[iris_dataset$Species == "setosa",]
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">,</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full'</span><span class="p">,</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'MyDataSet'</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 11:</strong> <em>Invalid Input Name</em></p> <p>As you see in <em>Code Snippet 11</em> we assign a name to the <code>@input_data_1_name</code> parameter, but in the script we still use <code>InputDataSet</code>. When we execute the following error happens:</p> <p><img class="center" src="/images/posts/sql_r_services_ext_script_input_name_error.png" width="605" height="225" > <strong>Figure 4:</strong> <em>Non Existent Input Data Object</em></p> <p>So the error is that the script cannot find the <code>InputDataSet</code> object. Change the line: <code>iris_dataset &lt;- InputDataSet</code> to: <code>iris_dataset &lt;- MyDataSet</code>, and execute again. Now all is OK.</p> <p>How does the script know what the input data is, e.g. how does it know in <em>Code Snippet 11</em> that the data belongs to the <code>MyDataSet</code> variable? Well this comes back to, at least indirectly, what we discussed in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> and how SQL Server sent the script, plus other information, to the SqlSatellite.</p> <p>Just for fun, let us revisit some of what we did in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a>:</p> <ul> <li>Run <em>Process Monitor</em> as admin and load the filter we used in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> where we filtered for <code>TCP Receive</code> for <code>BxlServer.exe</code>.</li> <li>Execute the code in <em>Code Snippet 8</em> and look at the output from <em>Process Monitor</em> to see what packets SQL Server sends:</li> </ul> <p><img class="center" src="/images/posts/sql_r_services_ext_script_procmon1.png" width="625" height="225" > <strong>Figure 4:</strong> <em>Process Monitor Output</em></p> <p>The outlined packet in <em>Figure 4</em> is the packet containing the script SQL Server sent to the SqlSatallite. Notice the size of the packet and also make a note of the <code>Path</code> column and the last value (in the figure it is 50887). That value is the port with which SQL Server communicates with the SqlSatellite. We use this now in <em>WireShark</em> to try and see if we can get any more information about what is happening.</p> <p>So, let us switch over to <em>WireShark</em>:</p> <ul> <li>Run <em>WireShark</em> as admin.</li> <li>Choose the network adapter to "sniff" on. See <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> for discussion around loop-back adapters etc.</li> <li>Set a display filter on the port SQL Server listens on (the port you saw in the <code>Path</code> column). In this case, we want to sniff outgoing packets, and - if we used what we saw in <em>Figure 4</em> - the filter should subsequently be: <code>tcp.srcport==50887</code>.</li> <li>Apply the filter.</li> </ul> <p>Execute the code in <em>Code Snippet 8</em> again, and look at the output from <em>WireShark</em>. In the output is a packet with the same length as the highlighted packet in <em>Figure 4</em>. This packet is the packet SQL Server sends to the SqlSatellite with the script (as discussed above). When we look at the data part of that packet as a hex dump, the 64 first bytes look like this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Hex Dump I</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">01</span> <span class="mo">00</span> <span class="mo">05</span> <span class="mi">80</span> <span class="mi">48</span> <span class="mo">03</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mi">5</span><span class="n">c</span> <span class="mi">46</span> <span class="mi">19</span> <span class="mi">98</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">3</span><span class="n">f</span> <span class="mi">9</span><span class="n">a</span> <span class="mi">4</span><span class="n">f</span>   <span class="p">....</span><span class="n">H</span><span class="p">...</span> <span class="err">\</span><span class="n">F</span><span class="p">..</span><span class="n">j</span><span class="o">?</span><span class="p">.</span><span class="n">O</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">9</span><span class="n">d</span> <span class="n">b6</span> <span class="mi">25</span> <span class="mi">1</span><span class="n">f</span> <span class="mi">62</span> <span class="mi">7</span><span class="n">f</span> <span class="mi">8</span><span class="n">b</span> <span class="mi">50</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">06</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">..</span><span class="o">%</span><span class="p">.</span><span class="n">b</span><span class="p">..</span><span class="n">P</span> <span class="p">........</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">1</span><span class="n">a</span> <span class="mo">00</span> <span class="mi">49</span> <span class="mo">00</span>  <span class="mi">6</span><span class="n">e</span> <span class="mo">00</span> <span class="mi">70</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span>   <span class="p">......</span><span class="n">I</span><span class="p">.</span> <span class="n">n</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">t</span><span class="p">.</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">44</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span>  <span class="mi">53</span> <span class="mo">00</span> <span class="mi">65</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="n">D</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">a</span><span class="p">.</span> <span class="n">S</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">t</span><span class="p">...</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 12:</strong> <em>WireShark Output I</em></p> <p>In <em>Code Snippet 8</em> we did not define a name for the input data set, but in the script, we used <code>InputDataSet</code> as a variable name - as that is the default. When looking at the hex dump in <em>Code Snippet 12</em> we see the name <code>InputDataSet</code> 38 bytes into the packet. So it looks like the name we give the data set is being part of the script data SQL Server sends to the SqlSatellite. We can potentially prove that theory by executing the code in <em>Code Snippet 11</em> (remember to change the code that refers to the data set to: <code>iris_dataset &lt;- MyDataSet</code>) and see what <em>WireShark</em> outputs:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Hex Dump II</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">01</span> <span class="mo">00</span> <span class="mo">05</span> <span class="mi">80</span> <span class="mi">3</span><span class="n">c</span> <span class="mo">03</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mi">82</span> <span class="n">a4</span> <span class="mi">40</span> <span class="mi">22</span> <span class="n">b4</span> <span class="mi">3</span><span class="n">a</span> <span class="mo">05</span> <span class="mi">4</span><span class="n">b</span>   <span class="p">....</span><span class="o">&lt;</span><span class="p">...</span> <span class="p">..</span><span class="err">@</span><span class="s">".:.K</span><span class="err"></span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="s">9a d0 03 f2 df 19 96 4f  00 00 06 00 00 00 00 00   .......O ........</span><span class="err"></span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="s">00 00 00 00 14 00 4d 00  79 00 44 00 61 00 74 00   ......M. y.D.a.t.</span><span class="err"></span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="s">61 00 53 00 65 00 74 00  00 00 1c 00 4f 00 75 00   a.S.e.t. ....</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 13:</strong> <em>WireShark Output II</em></p> <p>Ok, so when we look at the code in <em>Code Snippet 13</em> we see how the input data set name that we assigned through the <code>@input_data_1_name</code> parameter is part of the packet.</p> <p>So we can answer the question how the script knows what variable contains input data by pointing to how SQL Server passes the name of the input data variable as part of the script. Worth noticing is how, in the two packets above, at 36 bytes into the packet, the size of the variable name (in double bytes) plus two bytes are defined. In <em>Code Snippet 12</em> it is hex: <code>1a</code> (decimal 26) , and in <em>Code Snippet 13</em> it is hex: <code>14</code> (decimal 20).</p> <h4><code>@output_data_1_name</code></h4> <p>Finally, we get to how the script knows to return resultsets to the caller. Let us assume that you want to do some calculations on the data passed in through the <code>MyDataSet</code> variable in <em>Code Snippet 11</em> and then return that data. Maybe something like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Return Data</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>          iris_dataset &lt;- MyDataSet
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>          setosa &lt;- iris_dataset[iris_dataset$Species == "setosa",]
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>          meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>          cat(paste("Seposa sepal mean width: ", meanSepWidth))
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>          multiplier &lt;- 5
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>          iris_dataset$SepalLength &lt;- iris_dataset$SepalLength * multiplier
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>          OutputDataSet &lt;- data.frame(iris_dataset$SepalLength)'</span><span class="p">,</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full'</span><span class="p">,</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'MyDataSet'</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 14:</strong> <em>Return a Result Set</em></p> <p>When you execute the code in <em>Code Snippet 14</em>, part of the resultset looks like this:</p> <p><img class="center" src="/images/posts/sql_r_services_ext_script_output1.png" width="180" height="155" > <strong>Figure 5:</strong> <em>Result Set</em></p> <p>In <em>Figure 5</em> we see how a resultset comes back, and looking at the code in <em>Code Snippet 14</em>, and knowing about <code>InputDataSet</code>, we assume that the reason a resultset comes back is that of the <code>OutputDataSet</code> variable in the script. It turns out that assumption is correct.</p> <p>Similar to the input data variable and its default name, the output data variable has a default name: <code>OutputDataSet</code>. You can change this name by setting the <code>@output_data_1_name</code> variable to a name of your choice, and reference that name in the script:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Output Data Name</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>          iris_dataset &lt;- MyDataSet
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>          setosa &lt;- iris_dataset[iris_dataset$Species == "setosa",]
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>          meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>          cat(paste("Seposa sepal mean width: ", meanSepWidth))
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>          multiplier &lt;- 5
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>          iris_dataset$SepalLength &lt;- iris_dataset$SepalLength * multiplier
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>          SepalLengthMult &lt;- data.frame(iris_dataset$SepalLength)'</span><span class="p">,</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full'</span><span class="p">,</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'MyDataSet'</span><span class="p">,</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">output_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SepalLengthMult'</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 15:</strong> <em>Customised Result Set Name</em></p> <p>In <em>Code Snippet 15</em> we changed the name of the output data variable to <code>SepalLengthMult</code> and referenced it in the script.</p> <p>The script engine (and script) knows about the variable name in the same way as it does for the input data variable - it is part of the script packet that SQL Server sends to the SqlSatellite. Below is a partial hex dump of the packet SQL Server sends when we execute the code in <em>Code Snippet 15</em>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Hex Dump III</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">01</span> <span class="mo">00</span> <span class="mo">05</span> <span class="mi">80</span> <span class="mi">66</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="n">e5</span> <span class="n">fe</span> <span class="mi">5</span><span class="n">a</span> <span class="n">d3</span> <span class="mi">1</span><span class="n">f</span> <span class="n">e3</span> <span class="mi">7</span><span class="n">d</span> <span class="mi">4</span><span class="n">a</span>   <span class="p">....</span><span class="n">f</span><span class="p">...</span> <span class="p">..</span><span class="n">Z</span><span class="p">...&#x7d;</span><span class="n">J</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">8</span><span class="n">e</span> <span class="mi">68</span> <span class="mi">95</span> <span class="n">ee</span> <span class="mi">31</span> <span class="mi">59</span> <span class="mi">75</span> <span class="mi">38</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">06</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">.</span><span class="n">h</span><span class="p">.</span><span class="mf">.1</span><span class="n">Yu8</span> <span class="p">........</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">14</span> <span class="mo">00</span> <span class="mi">4</span><span class="n">d</span> <span class="mo">00</span>  <span class="mi">79</span> <span class="mo">00</span> <span class="mi">44</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span>   <span class="p">......</span><span class="n">M</span><span class="p">.</span> <span class="n">y</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">t</span><span class="p">.</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">61</span> <span class="mo">00</span> <span class="mi">53</span> <span class="mo">00</span> <span class="mi">65</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mi">20</span> <span class="mo">00</span> <span class="mi">53</span> <span class="mo">00</span> <span class="mi">65</span> <span class="mo">00</span>   <span class="n">a</span><span class="p">.</span><span class="n">S</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">t</span><span class="p">.</span> <span class="p">..</span> <span class="p">.</span><span class="n">S</span><span class="p">.</span><span class="n">e</span><span class="p">.</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">70</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">c</span> <span class="mo">00</span> <span class="mi">4</span><span class="n">c</span> <span class="mo">00</span>  <span class="mi">65</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">e</span> <span class="mo">00</span> <span class="mi">67</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span>   <span class="n">p</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">L</span><span class="p">.</span> <span class="n">e</span><span class="p">.</span><span class="n">n</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="n">t</span><span class="p">.</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">68</span> <span class="mo">00</span> <span class="mi">4</span><span class="n">d</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">c</span> <span class="mo">00</span>  <span class="mi">74</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">38</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="n">h</span><span class="p">.</span><span class="n">M</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span> <span class="n">t</span><span class="p">..</span><span class="mf">.8</span><span class="p">...</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 16:</strong> <em>WireShark Output OutputData</em></p> <p>In the hex dump in <em>Code Snippet 16</em> we see the name of the output dataset variable starting at byte 60. We can also see at byte 58 how the length of the output data variable is defined, plus two bytes: hex <code>20</code>.</p> <p>So, <code>@output_data_1_name</code> specifies the name of the variable in the external script that contains the data to be returned to SQL Server when the stored procedure completes. There is an implicit expectation of the data type of the output; for R the expectation is a data frame, and for Python, it is a pandas data frame.</p> <p>Oh, a last thing about the output data. When you look at <em>Figure 5</em> you see that the resultset has no column names. By default <code>sp_execute_external_script</code> returns resultsets with unnamed columns as column names within a script are local. If you want to name columns you use the <code>WITH RESULTS SET</code> clause of the <code>EXECUTE</code>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Named Column</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>          iris_dataset &lt;- MyDataSet
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>          setosa &lt;- iris_dataset[iris_dataset$Species == "setosa",]
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>          meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>          cat(paste("Seposa sepal mean width: ", meanSepWidth))
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>          multiplier &lt;- 5
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>          iris_dataset$SepalLength &lt;- iris_dataset$SepalLength * multiplier
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>          SepalLengthMult &lt;- data.frame(iris_dataset$SepalLength)'</span><span class="p">,</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full'</span><span class="p">,</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'MyDataSet'</span><span class="p">,</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">output_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SepalLengthMult'</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">((</span><span class="n">LengthMultiplied</span> <span class="n">float</span><span class="p">));</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 17:</strong> <em>Define Column Name</em></p> <p>In <em>Code Snippet 17</em> we defined the column coming back with a name of <code>LengthMultiplied</code> and that the column should have a data type of <code>float</code>. When we execute the code we see this:</p> <p><img class="center" src="/images/posts/sql_r_services_ext_script_output2.png" width="170" height="150" > <strong>Figure 6:</strong> <em>Result Set</em></p> <p>Looking at <em>Figure 6</em> we see how we received a result set consisting of one column named <code>LengthMultiplied</code>. <code>WITH RESULT SETS</code> is not something specific for <code>sp_execute_external_script</code> but an option on the <code>EXECUTE</code> statement. If you are interested in what happens when you execute <code>sp_execute_external_script</code> with the <code>WITH RESULT SETS</code> option, I covered it in <a href="/2018/01/10/microsoft-sql-server-r-services-internals-xviii/">Internals - XVIII</a>.</p> <h2>Summary</h2> <p>In this post we have looked at some of the parameters <code>sp_execute_external_script</code> expects:</p> <ul> <li><code>@language</code> - tells the launchpad service what external engine to use. At the moment R and Python are supported.</li> <li><code>@script</code> - defines the script which the external engine executes. The script can be loaded as a literal value, a parameter or through the R <code>source(file_name)</code> command.</li> <li><code>@input_data_1</code> - specifies the input data used by the external script in the form of a Transact-SQL query (<code>SELECT</code> only, no procedure calls). The query can only generate one dataset. If more datasets are required, they have to be retrieved from inside the script.</li> <li><code>@input_data_1_name</code> - specifies the name of the variable used to represent the query defined by @input_data_1. The parameter is optional, and defaults to <code>InputDataset</code>.</li> <li><code>@output_data_1_name</code> - specifies the name of the variable in the external script that contains the data to be returned to SQL Server when the stored procedure completes. The parameter is optional, and defaults to <code>OutputDataSet</code>.</li> </ul> <p>All of the above parameter values have to be of the <code>NVARCHAR</code> data type.</p> <p>In next blog post we cover some of the remaining parameters for <code>sp_execute_external_script</code>.</p> <h2>~ Finally</h2> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/&text=Microsoft SQL Server R Services - sp_execute_external_script - I&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/ &title=Microsoft SQL Server R Services - sp_execute_external_script - I &summary=Blog post: A lowdown of sp_execute_external_script and its different parameters, using Process Monitor and WireShark &source=http://www.nielsberglund.com/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> <br/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad2 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="1158080725" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2018/07/15/interesting-stuff-week-28/"> Interesting Stuff - Week 28 <small> (15 Jul 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/07/08/interesting-stuff-week-27/"> Interesting Stuff - Week 27 <small> (08 Jul 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/07/07/sp-execute-external-script-and-sql-compute-context-II/"> sp_execute_external_script and SQL Compute Context - II <small> (07 Jul 2018)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
