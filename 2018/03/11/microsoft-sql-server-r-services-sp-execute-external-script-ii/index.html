<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Microsoft SQL Server R Services - sp_execute_external_script - II &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Microsoft SQL Server R Services - sp_execute_external_script - II</h1>
  <div class="post-subheading">
  <span class="post-date">11 Mar 2018</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>This post is the 23:rd post about <strong>Microsoft SQL Server R Services</strong>, and a continuation of <a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">sp_execute_external_script - I</a>. To see other posts (including this) in the series, go to <a href="/series/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a>.</p>

<p>I honestly thought this post would be the last in the series (I have thought quite a few times), but alas, that is not the case. There will be at least one more post about <code class="highlighter-rouge">sp_execute_external_script</code> after this.</p>

<!--more-->

<h2 id="recap">Recap</h2>

<p>In the last <a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">post</a> we started looking at <code class="highlighter-rouge">sp_execute_external_script</code>, and we said that <code class="highlighter-rouge">sp_execute_external_script</code> is the bridge between SQL Server and external execution engines, like R or Python. The signature for the procedure looks like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sp_execute_external_script</span> 
             <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'language'</span><span class="p">,</span> 
             <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'script'</span><span class="p">,</span> 
             <span class="p">[</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="p">]</span> <span class="s1">'input_data_1'</span> 
             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="p">]</span> <span class="n">N</span><span class="s1">'input_data_1_name'</span> <span class="p">]</span> 
             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">output_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'output_data_1_name'</span> <span class="p">]</span> 
             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">parallel</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="p">]</span> 
             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="p">]</span> <span class="n">N</span><span class="s1">'@parameter_name data_type [ OUT | OUTPUT ] [ ,...n ]'</span> 
             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">parameter1</span> <span class="o">=</span> <span class="p">]</span> <span class="s1">'value1'</span> <span class="p">[</span> <span class="k">OUT</span> <span class="o">|</span> <span class="k">OUTPUT</span> <span class="p">]</span> <span class="p">[</span> <span class="p">,...</span><span class="n">n</span> <span class="p">]</span> 
<span class="p">[</span> <span class="k">WITH</span> <span class="o">&lt;</span><span class="n">execute_option</span><span class="o">&gt;</span> <span class="p">]</span> 
<span class="p">[;]</span> 
</code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Full Signature of sp_execute_external_script</em></p>

<p>In the post we looked at the first five parameters:</p>

<ul>
  <li><code class="highlighter-rouge">@language</code> - tells the launchpad service what external engine to use. At the moment R and Python are supported. The parameter is required.</li>
  <li><code class="highlighter-rouge">@script</code> - defines the script which the external engine executes. The script can be loaded as a literal value, a parameter or through the R <code class="highlighter-rouge">source(file_name)</code> command. The parameter is required.</li>
  <li><code class="highlighter-rouge">@input_data_1</code> - specifies the input data used by the external script in the form of a Transact-SQL query (<code class="highlighter-rouge">SELECT</code> only, no procedure calls). The query can only generate one dataset. If more datasets are required, they have to be retrieved from inside the script. The parameter is optional.</li>
  <li><code class="highlighter-rouge">@input_data_1_name</code> - specifies the name of the variable used to represent the query defined by @input_data_1. The parameter is optional, and defaults to <code class="highlighter-rouge">InputDataset</code>.</li>
  <li><code class="highlighter-rouge">@output_data_1_name</code> - specifies the name of the variable in the external script that contains the data to be returned to SQL Server when the stored procedure completes. The parameter is optional, and defaults to <code class="highlighter-rouge">OutputDataSet</code>.</li>
</ul>

<p>We also said the data type of the values of all parameters have to be <code class="highlighter-rouge">NVARCHAR</code>.</p>

<p>This post covers the <code class="highlighter-rouge">@params</code> and  <code class="highlighter-rouge">@parameter1</code> parameters.</p>

<h2 id="housekeeping">Housekeeping</h2>

<p>Before we “dive” into today’s topics let us look at the code and the tools we use today. This section is here for those who want to follow along in what we are doing in the post.</p>

<h4 id="code">Code</h4>

<p>In this post we use the same database and database objects as in <a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">sp_execute_external_script - I</a>, so go there and grab the code if you need to create the database again.</p>

<h4 id="helper-tools">Helper Tools</h4>

<p>To help us figure out the things we want, we use <em>Process Monitor</em>, and <em>WireShark</em>:</p>

<ul>
  <li><em>Process Monitor</em>, is used it to filter TCP traffic. If you want to refresh your memory about how to do it, we covered that in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> as well as in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>.</li>
  <li>I use <em>WireShark</em> for network packet sniffing. If you want a refresher about <em>WireShark</em>, we covered the setup and so forth in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a>.</li>
</ul>

<p>Now then, let us start.</p>

<h2 id="params--parameter1"><code class="highlighter-rouge">@params</code> &amp; <code class="highlighter-rouge">@parameter1</code></h2>

<p>Yeah, yeah - I know, in <em>Code Snippet 1</em> above, the <code class="highlighter-rouge">@parallel</code> parameter comes before the <code class="highlighter-rouge">@params</code> parameter. However, it makes more sense for me to cover <code class="highlighter-rouge">@params</code> before <code class="highlighter-rouge">@parallel</code>.</p>

<p>The <code class="highlighter-rouge">@params</code> parameter is an optional parameter and when defined, it contains the definitions of all parameters embedded in the values for the <code class="highlighter-rouge">@input_data_1</code> and the <code class="highlighter-rouge">@script</code> parameters. The string must be either a Unicode constant or a Unicode variable. Each parameter definition consists of a parameter name and a data type. In <a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">sp_execute_external_script - I</a> we had code looking like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
                iris_dataset &lt;- InputDataSet
                setosa &lt;- iris_dataset[iris_dataset$Species == "setosa",]
                meanSepWidth &lt;- mean(setosa$SepalWidth)
                cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full'</span>
</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Using @input_data_1 with straight SELECT</em></p>

<p>In <em>Code Snippet 2</em> we <code class="highlighter-rouge">SELECT</code> all data from the <code class="highlighter-rouge">dbo.tb_irisdata_full</code> table, and then in the script we filter out for the “setosa” species: <code class="highlighter-rouge">setosa &lt;- iris_dataset[iris_dataset$Species == "setosa",]</code>. Instead of filtering in the script, our <code class="highlighter-rouge">SELECT</code> query can filter: <code class="highlighter-rouge">SELECT * FROM dbo.tb_irisdata_full WHERE species = 'setosa'</code>, and subsequently the <code class="highlighter-rouge">setosa</code> value becomes a parameter: <code class="highlighter-rouge">@specie</code>. The query (<code class="highlighter-rouge">@input_data_1</code>) then looks like this: <code class="highlighter-rouge">SELECT * FROM dbo.tb_irisdata_full WHERE species = @specie</code>. To use this in <em>Code Snippet 2</em> we now need to define the parameter in <code class="highlighter-rouge">@params</code>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
                setosa &lt;- InputDataSet
                meanSepWidth &lt;- mean(setosa$SepalWidth)
                cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full 
                              WHERE Species = @specie'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@specie nvarchar(20)'</span><span class="p">;</span>                              <span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Input Data with Parameter Definition</em></p>

<p>That all looks good, but when you execute you get an error:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptII_param_error.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Parameter Error</em></p>

<p>So, the error says that <code class="highlighter-rouge">@specie</code> is missing, which makes kind of sense since we have not assigned a value to the parameter. So what about this then:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">specie</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'setosa'</span><span class="p">;</span>
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
                setosa &lt;- InputDataSet
                meanSepWidth &lt;- mean(setosa$SepalWidth)
                cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full 
                              WHERE Species = @specie'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@specie nvarchar(20)'</span><span class="p">;</span>                              <span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 4:</strong> <em>Input Data with Parameter Definition</em></p>

<p>In the code above (<em>Code Snippet 4</em>) we declare a <code class="highlighter-rouge">@specie</code> parameter and give it a value, but when we execute the procedure we get the same error as when we executed the code in <em>Code Snippet 3</em>. What gives, we are obviously missing something here?</p>

<p>What is missing is that we need to define the parameter as part of the procedure and also assign a value to it. Didn’t we do that at the top of <em>Code Snippet 4</em>? No, what we did was we <code class="highlighter-rouge">DECLARE</code>: ed a new variable which had the same name as the parameter (<code class="highlighter-rouge">@specie</code>) but there is no reference to that variable anywhere, so it is not used.</p>

<p>To fix this, this is where <code class="highlighter-rouge">@parameter1</code> comes in (<code class="highlighter-rouge">@parameter1</code> is optional). In fact, there is no <code class="highlighter-rouge">@parameter1</code>, but it refers to the first parameter in the <code class="highlighter-rouge">@params</code> parameter list. When there is more than one parameter in the <code class="highlighter-rouge">@params</code> list, you have <code class="highlighter-rouge">@parameter2</code>, and so on. However, you do not refer to <code class="highlighter-rouge">@parameter1</code> as <code class="highlighter-rouge">@parameter1</code>, but you name it as per the name in the <code class="highlighter-rouge">@params</code> list:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
                setosa &lt;- InputDataSet
                meanSepWidth &lt;- mean(setosa$SepalWidth)
                cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full 
                              WHERE Species = @specie'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@specie nvarchar(20)'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">specie</span> <span class="o">=</span> <span class="s1">'setosa'</span><span class="p">;</span>                              <span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>Defined the Actual Parameter</em></p>

<p>In <em>Code Snippet 5</em> we see how the <code class="highlighter-rouge">@params</code> parameter lists the actual parameter, <code class="highlighter-rouge">@specie</code>, and how <code class="highlighter-rouge">@specie</code> is now a named parameter in the procedure. As with any parameters for stored procedures you can declare them as a variable, set the value, and assign them to the actual parameter:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">sp</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'setosa'</span>
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
                setosa &lt;- InputDataSet
                meanSepWidth &lt;- mean(setosa$SepalWidth)
                cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full 
                              WHERE Species = @specie'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@specie nvarchar(20)'</span><span class="p">,</span>
            <span class="o">@</span><span class="n">specie</span> <span class="o">=</span> <span class="o">@</span><span class="n">sp</span><span class="p">;</span>                              <span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>Use Parameter and Variable</em></p>

<p>So that is parameters for the <code class="highlighter-rouge">@input_data_1</code> query. How about parameters in the script, where we want to send in values for those? In <a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">sp_execute_external_script - I</a> we had code that looked like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
          iris_dataset &lt;- MyDataSet
          setosa &lt;- iris_dataset[iris_dataset$Species == "setosa",]
          meanSepWidth &lt;- mean(setosa$SepalWidth)
          cat(paste("Seposa sepal mean width: ", meanSepWidth))
          multiplier &lt;- 5
          iris_dataset$SepalLength &lt;- iris_dataset$SepalLength * multiplier
          OutputDataSet &lt;- data.frame(iris_dataset$SepalLength)'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'MyDataSet'</span>
</code></pre></div></div>
<p><strong>Code Snippet 7:</strong> <em>Return a Result Set</em></p>

<p>In <em>Code Snippet 7</em> we see how the script uses the <code class="highlighter-rouge">multiplier</code> variable, whose value is hardcoded in the script. What if we want to send in a value to the script when the procedure runs? Well, we define a parameter for the variable and add it to the <code class="highlighter-rouge">@params</code> list, and then we name the parameter in the procedure and assign it a value. Merging <em>Code Snippet 6</em> with what we see in <em>Code Snippet 7</em>, we get something like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">mult</span> <span class="n">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">sp</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'setosa'</span>
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
          setosa &lt;- MyDataSet
          meanSepWidth &lt;- mean(setosa$SepalWidth)
          cat(paste("Seposa sepal mean width: ", meanSepWidth))
          multiplier &lt;- multip
          setosa$SepalLength &lt;- setosa$SepalLength * multiplier
          OutputDataSet &lt;- data.frame(setosa$SepalLength)'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full 
                        WHERE Species = @specie'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'MyDataSet'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@specie nvarchar(20), @multip int'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">specie</span> <span class="o">=</span> <span class="o">@</span><span class="n">sp</span><span class="p">,</span>
      <span class="o">@</span><span class="n">multip</span> <span class="o">=</span> <span class="o">@</span><span class="n">mult</span><span class="p">;</span> 
</code></pre></div></div>
<p><strong>Code Snippet 8:</strong> <em>Multiple Parameters</em></p>

<p>What we see in <em>Code Snippet 8</em> is how the <code class="highlighter-rouge">@multip</code> parameter is defined in the <code class="highlighter-rouge">@params</code> list and added to the stored procedure. We have also created a variable, <code class="highlighter-rouge">@mult</code>, which we have set a value for, we have then assigned the variable to the parameter.</p>

<blockquote>
  <p><strong>NOTE:</strong> When you refer to the parameters in the script file, you refer to them without the ampersand, so <code class="highlighter-rouge">@multip</code> becomes <code class="highlighter-rouge">multip</code> and so forth.</p>
</blockquote>

<p>One more thing, we have now seen how parameters are used to assign to a query as well as pass into the script. When we look at the code in <em>Code Snippet 8</em> we see how we:</p>

<ul>
  <li>Calculate the mean and assign it to a variable (<code class="highlighter-rouge">meanSepWidth &lt;- mean(setosa$SepalWidth)</code>).</li>
  <li>Print out the mean using the <code class="highlighter-rouge">cat</code> function.</li>
</ul>

<p>In a “real-world” scenario, you would not print out the variable, but instead wanting it passed back to the calling code. As with any code in SQL Server, when we want data passed back (data that is not resultsets that is), we use output parameters. By now we should know the “drill”; add a parameter to the <code class="highlighter-rouge">@params</code> list, mark it as <code class="highlighter-rouge">OUTPUT</code> and then add the parameter to the procedure:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">meanOut</span> <span class="n">float</span><span class="p">;</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">mult</span> <span class="n">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">sp</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'setosa'</span>
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
          setosa &lt;- MyDataSet
          meanSepWidth &lt;- mean(setosa$SepalWidth)
          multiplier &lt;- multip
          setosa$SepalLength &lt;- setosa$SepalLength * multiplier
          OutputDataSet &lt;- data.frame(setosa$SepalLength)'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full 
                        WHERE Species = @specie'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'MyDataSet'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@specie nvarchar(20), @multip int, @meanSepWidth float OUT'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">specie</span> <span class="o">=</span> <span class="o">@</span><span class="n">sp</span><span class="p">,</span>
      <span class="o">@</span><span class="n">multip</span> <span class="o">=</span> <span class="o">@</span><span class="n">mult</span><span class="p">,</span>
      <span class="o">@</span><span class="n">meanSepWidth</span> <span class="o">=</span> <span class="o">@</span><span class="n">meanOut</span> <span class="k">OUT</span><span class="p">;</span>
      
<span class="k">SELECT</span>  <span class="o">@</span><span class="n">meanOut</span> <span class="k">AS</span> <span class="n">MeanSepWidth</span><span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 9:</strong> <em>Use of Output Parameter</em></p>

<p>In <em>Code Snippet 9</em> we see how the <code class="highlighter-rouge">@meanSepWidth</code> parameter is defined to the <code class="highlighter-rouge">@params</code> list as <code class="highlighter-rouge">OUTPUT</code> (<code class="highlighter-rouge">OUT</code> works as well) and added to the procedure. When we execute the code we get two resultsets coming back, one from the <code class="highlighter-rouge">OutputDataSet &lt;- data.frame(setosa$SepalLength)</code> and the second from <code class="highlighter-rouge">SELECT  @meanOut AS MeanSepWidth</code>:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptII_outparam.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Resultsets Coming Back</em></p>

<p>The last thing to discuss related to parameters are how it works internally, similar to how we in <a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">sp_execute_external_script - I</a> discussed how the script knew about the input and output datasets. Here we discuss how the script and the engine know about parameters and their values. Oh, in [Internals - XVIII] we discussed the mechanism with which the value(s) of the output parameter(s) come back, so, therefore, we do not cover return values of output parameters in this post.</p>

<p>To begin with, in what packets are the parameters passed? To find this out, we use some much-simplified code from what we have used so far:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
        d &lt;- 42
        cat(paste("Answer:", d))'</span><span class="p">;</span>
     
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
        d &lt;- multip
        cat(paste("Answer:", d))'</span><span class="p">,</span>      
      <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@multip int'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">multip</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 10:</strong> <em>Execution with and without Parameters</em></p>

<p>As we see in <em>Code Snippet 10</em> there are two instances of <code class="highlighter-rouge">sp_execute_external_script</code>, both are very similar, and both generate the same result. What differs is that the first one has the value <code class="highlighter-rouge">42</code> hard-coded where the other pass the value via a parameter. The idea is now to initially to use <em>Process Monitor</em> and compare the packets SQL Server sends to the SqlSatellite to see if we can figure out what packet passes the parameter(s). So:</p>

<ul>
  <li>Run <em>Process Monitor</em> as admin and load the filter we used in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> where we filtered for <code class="highlighter-rouge">TCP Receive</code> for <code class="highlighter-rouge">BxlServer.exe</code>.</li>
  <li>Run the two <code class="highlighter-rouge">EXECUTE</code> statements in <em>Code Snippet 10</em> and compare the output from <em>Process Monitor</em>. Make also a note of the <code class="highlighter-rouge">Path</code> column and the last value. That value is the port number of the TCP port with which SQL Server communicates with the SqlSatellite. We use the port value in <em>WireShark</em> when we “sniff” network packets later.</li>
</ul>

<p>When we execute the two statements in <em>Code Snippet 10</em>, <em>Process Monitor</em> outputs this:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptII_param_packets.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>Packets Sent</em></p>

<p>The black line in <em>Figure 2</em> separates the two executions, and we see how the third packet in each run differs in size (outlined in blue and red respectively). The packet outlined in red is bigger and comes from the second run - where we used the <code class="highlighter-rouge">@multip</code> parameter. The third packet is the packet where SQL Server sends the script to the SqlSatellite, and from what we can see so far it looks like some parameter information is part of this packet. Let us switch over to <em>WireShark</em> and see what goes on.</p>

<ul>
  <li>Run <em>WireShark</em> as admin.</li>
  <li>Choose the network adapter to “sniff” on. See <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> for discussion around loop-back adapters etc.</li>
  <li>Set a display filter on the port SQL Server communicates with SqlSatellite on (the port you saw in the <code class="highlighter-rouge">Path</code> column). In this case, we want to sniff outgoing packets, and - if we used what we saw in <em>Figure 2</em> - the filter should subsequently be: <code class="highlighter-rouge">tcp.srcport==50858</code>.</li>
  <li>Apply the filter.</li>
</ul>

<p>Execute the code in <em>Code Snippet 10</em> where we use the <code class="highlighter-rouge">@multip</code> parameter and look at the output from <em>WireShark</em>. In the output is a packet with the same length as the packet outlined in red in <em>Figure 2</em>, let us have a look at the data part of that packet:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mo">01</span> <span class="mo">00</span> <span class="mo">05</span> <span class="mi">80</span> <span class="mi">25</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="n">e3</span> <span class="mo">01</span> <span class="mi">86</span> <span class="mi">81</span> <span class="n">e1</span> <span class="n">a2</span> <span class="mi">2</span><span class="n">e</span> <span class="mi">43</span>   <span class="p">....</span><span class="o">%</span><span class="p">...</span> <span class="p">.......</span><span class="n">C</span>
<span class="n">b8</span> <span class="n">e0</span> <span class="n">a7</span> <span class="mi">31</span> <span class="mi">0</span><span class="n">d</span> <span class="n">d1</span> <span class="mi">83</span> <span class="n">dd</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span>   <span class="p">..</span><span class="mf">.1</span><span class="p">....</span> <span class="p">........</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">1</span><span class="n">a</span> <span class="mo">00</span> <span class="mi">49</span> <span class="mo">00</span>  <span class="mi">6</span><span class="n">e</span> <span class="mo">00</span> <span class="mi">70</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span>   <span class="p">......</span><span class="n">I</span><span class="p">.</span> <span class="n">n</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">t</span><span class="p">.</span>
<span class="mi">44</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span>  <span class="mi">53</span> <span class="mo">00</span> <span class="mi">65</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="n">D</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">a</span><span class="p">.</span> <span class="n">S</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">t</span><span class="p">...</span>
<span class="mi">1</span><span class="n">c</span> <span class="mo">00</span> <span class="mi">4</span><span class="n">f</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span>  <span class="mi">70</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">44</span> <span class="mo">00</span>   <span class="p">..</span><span class="n">O</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">t</span><span class="p">.</span> <span class="n">p</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">D</span><span class="p">.</span>
<span class="mi">61</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span> <span class="mi">53</span> <span class="mo">00</span>  <span class="mi">65</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span>   <span class="n">a</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">S</span><span class="p">.</span> <span class="n">e</span><span class="p">.</span><span class="n">t</span><span class="p">..</span><span class="mf">.0</span><span class="p">.</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span>  <span class="mo">03</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">.</span><span class="mf">.0</span><span class="p">.....</span> <span class="p">........</span>
<span class="mi">12</span> <span class="mo">00</span> <span class="mi">45</span> <span class="mo">00</span> <span class="mi">78</span> <span class="mo">00</span> <span class="mi">70</span> <span class="mo">00</span>  <span class="mi">72</span> <span class="mo">00</span> <span class="mi">31</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span>   <span class="p">..</span><span class="n">E</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">p</span><span class="p">.</span> <span class="n">r</span><span class="mf">.1.0.0</span><span class="p">.</span>
<span class="mi">30</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span> <span class="mo">00</span>   <span class="mf">0.</span><span class="p">.</span><span class="mf">.8</span><span class="p">...</span> <span class="mf">8.</span><span class="p">......</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mi">2</span><span class="n">a</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">10</span> <span class="mo">00</span> <span class="mi">40</span>   <span class="p">........</span> <span class="p">.</span><span class="o">*</span><span class="p">.....</span><span class="err">@</span>
<span class="mo">00</span> <span class="mi">6</span><span class="n">d</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">c</span> <span class="mo">00</span> <span class="mi">74</span>  <span class="mo">00</span> <span class="mi">69</span> <span class="mo">00</span> <span class="mi">70</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">70</span>   <span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">t</span> <span class="p">.</span><span class="n">i</span><span class="p">.</span><span class="n">p</span><span class="p">...</span><span class="n">p</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mi">80</span> <span class="mi">0</span><span class="n">d</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span>  <span class="mo">00</span> <span class="mi">20</span> <span class="mo">00</span> <span class="mi">20</span> <span class="mo">00</span> <span class="mi">20</span> <span class="mo">00</span> <span class="mi">20</span>   <span class="p">........</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> 
<span class="p">...</span>
</code></pre></div></div>
<p><strong>Code Snippet 11:</strong> *Hex Dump of Data Packet”</p>

<p>We see in <em>Code Snippet 11</em> the first 192 bytes of the packet containing the script which SQL Server sent to the SqlSatellite. In the text representation of the hex, we can see the parameter name (<code class="highlighter-rouge">@multip</code>), and it starts at byte 160 (the first byte in hex is <code class="highlighter-rouge">40</code>). So parameters are sent to the engine via the packet containing the script. What about the value of the parameter?</p>

<p>The value of the parameter is somewhat harder to figure out, seeing the value is an <code class="highlighter-rouge">int</code> and therefore not in clear-text. However, if we look closely at the hex, we see at byte 154 a hex value of <code class="highlighter-rouge">2a</code> which in decimal is 42. So SQL Server passes the value(s) of the parameter(s) as well in the “script” packet. In this case, it was one parameter with one value, what happens if we have multiple parameters and values, for example, something like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
        d &lt;- multip1 * multip2
        cat(paste("Answer:", d))'</span><span class="p">,</span>      
      <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@multip1 int, @multip2 int'</span><span class="p">,</span>
      <span class="o">@</span><span class="n">multip1</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
      <span class="o">@</span><span class="n">multip2</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 12:</strong> <em>Script using Multiple Parameters</em></p>

<p>In the code in <em>Code Snippet 12</em> we send two parameters to the script (<code class="highlighter-rouge">@multip1</code> and <code class="highlighter-rouge">@multip2</code>) and the hex-dump we get after we execute the code looks like so:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mo">01</span> <span class="mo">00</span> <span class="mo">05</span> <span class="mi">80</span> <span class="mi">6</span><span class="n">a</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="n">b8</span> <span class="n">b1</span> <span class="n">da</span> <span class="mi">7</span><span class="n">e</span> <span class="n">cc</span> <span class="n">d0</span> <span class="mi">4</span><span class="n">e</span> <span class="mi">40</span>   <span class="p">....</span><span class="n">j</span><span class="p">...</span> <span class="p">...</span><span class="o">~</span><span class="p">..</span><span class="n">N</span><span class="err">@</span>
<span class="mi">90</span> <span class="mi">95</span> <span class="n">c1</span> <span class="n">e3</span> <span class="n">e0</span> <span class="mi">58</span> <span class="n">dd</span> <span class="mi">7</span><span class="n">e</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">02</span> <span class="mo">00</span>   <span class="p">.....</span><span class="n">X</span><span class="p">.</span><span class="o">~</span> <span class="p">........</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">1</span><span class="n">a</span> <span class="mo">00</span> <span class="mi">49</span> <span class="mo">00</span>  <span class="mi">6</span><span class="n">e</span> <span class="mo">00</span> <span class="mi">70</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span>   <span class="p">......</span><span class="n">I</span><span class="p">.</span> <span class="n">n</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">t</span><span class="p">.</span>
<span class="mi">44</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span>  <span class="mi">53</span> <span class="mo">00</span> <span class="mi">65</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="n">D</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">a</span><span class="p">.</span> <span class="n">S</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">t</span><span class="p">...</span>
<span class="mi">1</span><span class="n">c</span> <span class="mo">00</span> <span class="mi">4</span><span class="n">f</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span>  <span class="mi">70</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">44</span> <span class="mo">00</span>   <span class="p">..</span><span class="n">O</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">t</span><span class="p">.</span> <span class="n">p</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">D</span><span class="p">.</span>
<span class="mi">61</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span> <span class="mi">53</span> <span class="mo">00</span>  <span class="mi">65</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span>   <span class="n">a</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">S</span><span class="p">.</span> <span class="n">e</span><span class="p">.</span><span class="n">t</span><span class="p">..</span><span class="mf">.0</span><span class="p">.</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span>  <span class="mo">03</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">.</span><span class="mf">.0</span><span class="p">.....</span> <span class="p">........</span>
<span class="mi">12</span> <span class="mo">00</span> <span class="mi">45</span> <span class="mo">00</span> <span class="mi">78</span> <span class="mo">00</span> <span class="mi">70</span> <span class="mo">00</span>  <span class="mi">72</span> <span class="mo">00</span> <span class="mi">31</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span>   <span class="p">..</span><span class="n">E</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">p</span><span class="p">.</span> <span class="n">r</span><span class="mf">.1.0.0</span><span class="p">.</span>
<span class="mi">30</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span> <span class="mo">00</span>   <span class="mf">0.</span><span class="p">.</span><span class="mf">.8</span><span class="p">...</span> <span class="mf">8.</span><span class="p">......</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mi">2</span><span class="n">a</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">........</span> <span class="p">.</span><span class="o">*</span><span class="p">..</span><span class="mf">.8</span><span class="p">..</span>
<span class="mo">00</span> <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span>   <span class="mf">.8</span><span class="p">......</span> <span class="p">........</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">05</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">12</span> <span class="mo">00</span>  <span class="mi">40</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">d</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">c</span> <span class="mo">00</span>   <span class="p">........</span> <span class="err">@</span><span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span>
<span class="mi">74</span> <span class="mo">00</span> <span class="mi">69</span> <span class="mo">00</span> <span class="mi">70</span> <span class="mo">00</span> <span class="mi">31</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mi">12</span> <span class="mo">00</span> <span class="mi">40</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">d</span> <span class="mo">00</span>   <span class="n">t</span><span class="p">.</span><span class="n">i</span><span class="p">.</span><span class="n">p</span><span class="mf">.1</span><span class="p">.</span> <span class="p">....</span><span class="err">@</span><span class="p">.</span><span class="n">m</span><span class="p">.</span>
<span class="mi">75</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">c</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">69</span> <span class="mo">00</span>  <span class="mi">70</span> <span class="mo">00</span> <span class="mi">32</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">86</span> <span class="mo">00</span>   <span class="n">u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">i</span><span class="p">.</span> <span class="n">p</span><span class="mf">.2</span><span class="p">.....</span>
<span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mi">80</span> <span class="mi">0</span><span class="n">d</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span> <span class="mo">00</span>  <span class="mi">20</span> <span class="mo">00</span> <span class="mi">20</span> <span class="mo">00</span> <span class="mi">20</span> <span class="mo">00</span> <span class="mi">20</span> <span class="mo">00</span>   <span class="p">........</span>  <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
</code></pre></div></div>
<p><strong>Code Snippet 13:</strong> <em>Hex Dump from Multiple Parameters</em></p>

<p>In <em>Code Snippet 13</em> we see the first 240 bytes of the hex-dump from <em>Code Snippet 12</em>. When I saw this dump for the first time I was surprised to see that the parameter names are together. I thought they would appear together with the values. However as we clearly can see the values come first. We see hex <code class="highlighter-rouge">2a</code> (decimal 42) at byte 154, and hex <code class="highlighter-rouge">05</code> (decimal 5) at byte 179 and the first parameter name starts at byte 185 (hex <code class="highlighter-rouge">40</code>). In essence, the parameter values come before the parameter names.</p>

<p>When we look at the two hex-dumps, there is something else worth noticing. If we look closely at where the values are and the parameter names we see how:</p>

<ul>
  <li>Four bytes before the value of each parameter there is a  hex value greater than 0.</li>
  <li>Two bytes before the parameter name is also a hex value greater than 0.</li>
</ul>

<p>After doing quite a few tests, I believe (almost 100% certain) that the value before the parameter value indicates the data size of the actual parameter value. In code snippets 11 and 13 that value is hex <code class="highlighter-rouge">04</code>, which is decimal 4 - the size of an integer. The value in front of the parameter name tells us the length of the parameter name in double-byte. In <em>Code Snippet 11</em> the value is hex <code class="highlighter-rouge">10</code> which is decimal 16, and that is the double-byte length of the parameter <code class="highlighter-rouge">@multip</code>. In <em>Code Snippet 13</em> the value is hex <code class="highlighter-rouge">12</code> before each parameter. Hex <code class="highlighter-rouge">12</code> is decimal 18, which is the double-byte length of <code class="highlighter-rouge">@multip1</code> and <code class="highlighter-rouge">@multip2</code>.</p>

<h2 id="summary">Summary</h2>

<p>Phew, that was quite a lot. So :</p>

<ul>
  <li>The <code class="highlighter-rouge">@params</code> parameter is used to define what parameters we use in the execution. The query in <code class="highlighter-rouge">@input_data_1</code> can use those parameters as well as the external script.</li>
  <li>The parameters defined in the <code class="highlighter-rouge">@params</code> list need to be added as named parameters to the stored procedure.</li>
  <li>In the case of parameters for the external script; the script references the parameters by name but without the <code class="highlighter-rouge">@</code> sign</li>
  <li>SQL Server sends the parameters and their values to the SqlSatellite in the packet containing the external script.</li>
  <li>In the “script” packet, preceding the values and the parameter names are hex values indicating the size of the parameter value (data type) and the parameter name.</li>
</ul>

<h2 id="-finally">~ Finally</h2>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/&text=Microsoft SQL Server R Services - sp_execute_external_script - II&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/
         &title=Microsoft SQL Server R Services - sp_execute_external_script - II
         &summary=Blog post: A lowdown of sp_execute_external_script and its @params and @parameter1 parameters, using Process Monitor and WireShark
         &source=http://www.nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-machine-learning-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Machine Learning Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#launchpad">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Launchpad</span>
    </a>
  
    
    <a href="/tags/#process-monitor">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Process Monitor</span>
    </a>
  
    
    <a href="/tags/#sqlsatellite">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SqlSatellite</span>
    </a>
  
    
    <a href="/tags/#wireshark">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WireShark</span>
    </a>
  
    
    <a href="/tags/#sp-execute-external-script">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">sp_execute_external_script</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/07/29/interesting-stuff-week-30/">
            Interesting Stuff - Week 30
            <small>29 Jul 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
