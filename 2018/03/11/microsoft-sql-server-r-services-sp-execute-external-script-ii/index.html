<!DOCTYPE html> <html lang="en-us"> <head> <!-- Google Tag Manager --> <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-K7B3642');</script> <!-- End Google Tag Manager --> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="A lowdown of sp_execute_external_script and its @params and @parameter1 parameters, using Process Monitor and WireShark"> <meta name="keywords" content="SQL Server R Services, SQL Server Machine Learning Services, R, Launchpad, Process Monitor, SqlSatellite, WireShark, sp_execute_external_script"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Microsoft SQL Server R Services - sp_execute_external_script - II &middot; Niels Berglund </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-d361e701e0c0e75e121ac3e901cff1b8.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.5.0 --> <title>Microsoft SQL Server R Services - sp_execute_external_script - II | Niels Berglund</title> <meta name="generator" content="Jekyll v3.8.2" /> <meta property="og:title" content="Microsoft SQL Server R Services - sp_execute_external_script - II" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A lowdown of sp_execute_external_script and its @params and @parameter1 parameters, using Process Monitor and WireShark" /> <meta property="og:description" content="A lowdown of sp_execute_external_script and its @params and @parameter1 parameters, using Process Monitor and WireShark" /> <link rel="canonical" href="http://nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/" /> <meta property="og:url" content="http://nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/" /> <meta property="og:site_name" content="Niels Berglund" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2018-03-11T11:55:37+02:00" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"http://nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/","headline":"Microsoft SQL Server R Services - sp_execute_external_script - II","dateModified":"2018-03-11T11:55:37+02:00","datePublished":"2018-03-11T11:55:37+02:00","author":{"@type":"Person","name":"nielsb"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/"},"description":"A lowdown of sp_execute_external_script and its @params and @parameter1 parameters, using Process Monitor and WireShark","@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-3005153158271538", enable_page_level_ads: true }); </script> </head> <body> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K7B3642" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) --> <div class="sidebar"> <div class="container"> <div class="sidebar-about"> <h1> <a href="/"> Niels Berglund </a> </h1> <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Sidebar_rectangle --> <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-3005153158271538" data-ad-slot="7704601332"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/disclaimer/">Disclaimer</a> <a class="sidebar-nav-item" href="/series/">Blog Post Series</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <img class="center" src="/images/MVP_Logo_large.png" width="300" height="121" > <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <p>&copy; 2018. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">Microsoft SQL Server R Services - sp_execute_external_script - II</h1> <div class="post-subheading"> <span class="post-date">11 Mar 2018</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#Microsoft R Server">Microsoft R Server</a> <a href="/categories/#Data Science">Data Science</a> <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a> <a href="/categories/#SQL Server R Services">SQL Server R Services</a> <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server R Services">SQL Server R Services</a> <a href="/tags/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <a href="/tags/#R">R</a> <a href="/tags/#Launchpad">Launchpad</a> <a href="/tags/#Process Monitor">Process Monitor</a> <a href="/tags/#SqlSatellite">SqlSatellite</a> <a href="/tags/#WireShark">WireShark</a> <a href="/tags/#sp_execute_external_script">sp_execute_external_script</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> <p>This post is part of a series of blog-posts about Microsoft SQL Server R Services:</p> <ol> <li><a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">Microsoft SQL Server 2016 R Services Installation</a></li> <li><a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Microsoft SQL Server R Services - Internals I</a></li> <li><a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Microsoft SQL Server R Services - Internals II</a></li> <li><a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Microsoft SQL Server R Services - Internals III</a></li> <li><a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Microsoft SQL Server R Services - Internals IV</a></li> <li><a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Microsoft SQL Server R Services - Internals V</a></li> <li><a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Microsoft SQL Server R Services - Internals VI</a></li> <li><a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Microsoft SQL Server R Services - Internals VII</a></li> <li><a href="/2017/07/22/microsoft-sql-server-r-services-internals-viii/">Microsoft SQL Server R Services - Internals VIII</a></li> <li><a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Microsoft SQL Server R Services - Internals IX</a></li> <li><a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Microsoft SQL Server R Services - Internals X</a></li> <li><a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">Microsoft SQL Server R Services - Internals XI</a></li> <li><a href="/2017/10/31/microsoft-sql-server-r-services-internals-xii/">Microsoft SQL Server R Services - Internals XII</a></li> <li><a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">Microsoft SQL Server R Services - Internals XIII</a></li> <li><a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Microsoft SQL Server R Services - Internals XIV</a></li> <li><a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Microsoft SQL Server R Services - Internals XV</a></li> <li><a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Microsoft SQL Server R Services - Internals XVI</a></li> <li><a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Microsoft SQL Server R Services - Internals XVII</a></li> <li><a href="/2018/01/10/microsoft-sql-server-r-services-internals-xviii/">Microsoft SQL Server R Services - Internals XVIII</a></li> <li><a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Microsoft SQL Server R Services - Internals XIX</a></li> <li><a href="/2018/02/02/microsoft-sql-server-r-services-internals-xx/">Microsoft SQL Server R Services - Internals XX</a></li> <li><a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">Microsoft SQL Server R Services - sp_execute_external_script - I</a></li> <li>Microsoft SQL Server R Services - sp_execute_external_script - II (this post)</li> <li><a href="/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/">Microsoft SQL Server R Services: sp_execute_external_script - III</a> <em>last post in the series</em></li> </ol> <p>This post is the 23:rd post about Microsoft SQL Server R Services, and a continuation of <a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">sp_execute_external_script - I</a>. I honestly thought this post would be the last in the series (I have thought quite a few times), but alas, that is not the case. There will be at least one more post about <code>sp_execute_external_script</code> after this.</p> <!--more--> <h2>Recap</h2> <p>In the last <a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">post</a> we started looking at <code>sp_execute_external_script</code>, and we said that <code>sp_execute_external_script</code> is the bridge between SQL Server and external execution engines, like R or Python. The signature for the procedure looks like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>sp_execute_external_script</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'language'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'script'</span><span class="p">,</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="p">[</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="p">]</span> <span class="s1">'input_data_1'</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="p">]</span> <span class="n">N</span><span class="s1">'input_data_1_name'</span> <span class="p">]</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">output_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'output_data_1_name'</span> <span class="p">]</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">parallel</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="p">]</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="p">]</span> <span class="n">N</span><span class="s1">'@parameter_name data_type [ OUT | OUTPUT ] [ ,...n ]'</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">parameter1</span> <span class="o">=</span> <span class="p">]</span> <span class="s1">'value1'</span> <span class="p">[</span> <span class="k">OUT</span> <span class="o">|</span> <span class="k">OUTPUT</span> <span class="p">]</span> <span class="p">[</span> <span class="p">,...</span><span class="n">n</span> <span class="p">]</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">[</span> <span class="k">WITH</span> <span class="o">&lt;</span><span class="n">execute_option</span><span class="o">&gt;</span> <span class="p">]</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">[;]</span> </div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Full Signature of sp_execute_external_script</em></p> <p>In the post we looked at the first five parameters:</p> <ul> <li><code>@language</code> - tells the launchpad service what external engine to use. At the moment R and Python are supported. The parameter is required.</li> <li><code>@script</code> - defines the script which the external engine executes. The script can be loaded as a literal value, a parameter or through the R <code>source(file_name)</code> command. The parameter is required.</li> <li><code>@input_data_1</code> - specifies the input data used by the external script in the form of a Transact-SQL query (<code>SELECT</code> only, no procedure calls). The query can only generate one dataset. If more datasets are required, they have to be retrieved from inside the script. The parameter is optional.</li> <li><code>@input_data_1_name</code> - specifies the name of the variable used to represent the query defined by @input_data_1. The parameter is optional, and defaults to <code>InputDataset</code>.</li> <li><code>@output_data_1_name</code> - specifies the name of the variable in the external script that contains the data to be returned to SQL Server when the stored procedure completes. The parameter is optional, and defaults to <code>OutputDataSet</code>.</li> </ul> <p>We also said the data type of the values of all parameters have to be <code>NVARCHAR</code>.</p> <p>This post covers the <code>@params</code> and <code>@parameter1</code> parameters.</p> <h2>Housekeeping</h2> <p>Before we "dive" into today's topics let us look at the code and the tools we use today. This section is here for those who want to follow along in what we are doing in the post.</p> <h4>Code</h4> <p>In this post we use the same database and database objects as in <a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">sp_execute_external_script - I</a>, so go there and grab the code if you need to create the database again.</p> <h4>Helper Tools</h4> <p>To help us figure out the things we want, we use <em>Process Monitor</em>, and <em>WireShark</em>:</p> <ul> <li><em>Process Monitor</em>, is used it to filter TCP traffic. If you want to refresh your memory about how to do it, we covered that in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> as well as in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>.</li> <li>I use <em>WireShark</em> for network packet sniffing. If you want a refresher about <em>WireShark</em>, we covered the setup and so forth in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a>.</li> </ul> <p>Now then, let us start.</p> <h2><code>@params</code> &amp; <code>@parameter1</code></h2> <p>Yeah, yeah - I know, in <em>Code Snippet 1</em> above, the <code>@parallel</code> parameter comes before the <code>@params</code> parameter. However, it makes more sense for me to cover <code>@params</code> before <code>@parallel</code>.</p> <p>The <code>@params</code> parameter is an optional parameter and when defined, it contains the definitions of all parameters embedded in the values for the <code>@input_data_1</code> and the <code>@script</code> parameters. The string must be either a Unicode constant or a Unicode variable. Each parameter definition consists of a parameter name and a data type. In <a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">sp_execute_external_script - I</a> we had code looking like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Input Data</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                iris_dataset &lt;- InputDataSet
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                setosa &lt;- iris_dataset[iris_dataset$Species == "setosa",]
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">,</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full'</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>Using @input_data_1 with straight SELECT</em></p> <p>In <em>Code Snippet 2</em> we <code>SELECT</code> all data from the <code>dbo.tb_irisdata_full</code> table, and then in the script we filter out for the "setosa" species: <code>setosa &lt;- iris_dataset[iris_dataset$Species == "setosa",]</code>. Instead of filtering in the script, our <code>SELECT</code> query can filter: <code>SELECT * FROM dbo.tb_irisdata_full WHERE species = 'setosa'</code>, and subsequently the <code>setosa</code> value becomes a parameter: <code>@specie</code>. The query (<code>@input_data_1</code>) then looks like this: <code>SELECT * FROM dbo.tb_irisdata_full WHERE species = @specie</code>. To use this in <em>Code Snippet 2</em> we now need to define the parameter in <code>@params</code>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Parameter I</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                setosa &lt;- InputDataSet
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">,</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>                              WHERE Species = @specie'</span><span class="p">,</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@specie nvarchar(20)'</span><span class="p">;</span>                              <span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 3:</strong> <em>Input Data with Parameter Definition</em></p> <p>That all looks good, but when you execute you get an error:</p> <p><img class="center" src="/images/posts/sql_r_services_ext_scriptII_param_error.png" width="405" height="70" > <strong>Figure 1:</strong> <em>Parameter Error</em></p> <p>So, the error says that <code>@specie</code> is missing, which makes kind of sense since we have not assigned a value to the parameter. So what about this then:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Parameter II</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="n">specie</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'setosa'</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                setosa &lt;- InputDataSet
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">,</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>                              WHERE Species = @specie'</span><span class="p">,</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@specie nvarchar(20)'</span><span class="p">;</span>                              <span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 4:</strong> <em>Input Data with Parameter Definition</em></p> <p>In the code above (<em>Code Snippet 4</em>) we declare a <code>@specie</code> parameter and give it a value, but when we execute the procedure we get the same error as when we executed the code in <em>Code Snippet 3</em>. What gives, we are obviously missing something here?</p> <p>What is missing is that we need to define the parameter as part of the procedure and also assign a value to it. Didn't we do that at the top of <em>Code Snippet 4</em>? No, what we did was we <code>DECLARE</code>: ed a new variable which had the same name as the parameter (<code>@specie</code>) but there is no reference to that variable anywhere, so it is not used.</p> <p>To fix this, this is where <code>@parameter1</code> comes in (<code>@parameter1</code> is optional). In fact, there is no <code>@parameter1</code>, but it refers to the first parameter in the <code>@params</code> parameter list. When there is more than one parameter in the <code>@params</code> list, you have <code>@parameter2</code>, and so on. However, you do not refer to <code>@parameter1</code> as <code>@parameter1</code>, but you name it as per the name in the <code>@params</code> list:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Parameter III</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                setosa &lt;- InputDataSet
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">,</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>                              WHERE Species = @specie'</span><span class="p">,</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@specie nvarchar(20)'</span><span class="p">,</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">specie</span> <span class="o">=</span> <span class="s1">'setosa'</span><span class="p">;</span>                              <span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 5:</strong> <em>Defined the Actual Parameter</em></p> <p>In <em>Code Snippet 5</em> we see how the <code>@params</code> parameter lists the actual parameter, <code>@specie</code>, and how <code>@specie</code> is now a named parameter in the procedure. As with any parameters for stored procedures you can declare them as a variable, set the value, and assign them to the actual parameter:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Parameter IV</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="n">sp</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'setosa'</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                setosa &lt;- InputDataSet
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                cat(paste("Seposa sepal mean width: ", meanSepWidth))'</span><span class="p">,</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>                              WHERE Species = @specie'</span><span class="p">,</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@specie nvarchar(20)'</span><span class="p">,</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="o">@</span><span class="n">specie</span> <span class="o">=</span> <span class="o">@</span><span class="n">sp</span><span class="p">;</span>                              <span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 6:</strong> <em>Use Parameter and Variable</em></p> <p>So that is parameters for the <code>@input_data_1</code> query. How about parameters in the script, where we want to send in values for those? In <a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">sp_execute_external_script - I</a> we had code that looked like this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Return Data</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>          iris_dataset &lt;- MyDataSet
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>          setosa &lt;- iris_dataset[iris_dataset$Species == "setosa",]
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>          meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>          cat(paste("Seposa sepal mean width: ", meanSepWidth))
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>          multiplier &lt;- 5
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>          iris_dataset$SepalLength &lt;- iris_dataset$SepalLength * multiplier
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>          OutputDataSet &lt;- data.frame(iris_dataset$SepalLength)'</span><span class="p">,</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full'</span><span class="p">,</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'MyDataSet'</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 7:</strong> <em>Return a Result Set</em></p> <p>In <em>Code Snippet 7</em> we see how the script uses the <code>multiplier</code> variable, whose value is hardcoded in the script. What if we want to send in a value to the script when the procedure runs? Well, we define a parameter for the variable and add it to the <code>@params</code> list, and then we name the parameter in the procedure and assign it a value. Merging <em>Code Snippet 6</em> with what we see in <em>Code Snippet 7</em>, we get something like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Parameter V</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="n">mult</span> <span class="n">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="n">sp</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'setosa'</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>          setosa &lt;- MyDataSet
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>          meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>          cat(paste("Seposa sepal mean width: ", meanSepWidth))
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>          multiplier &lt;- multip
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>          setosa$SepalLength &lt;- setosa$SepalLength * multiplier
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>          OutputDataSet &lt;- data.frame(setosa$SepalLength)'</span><span class="p">,</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>                        WHERE Species = @specie'</span><span class="p">,</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'MyDataSet'</span><span class="p">,</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@specie nvarchar(20), @multip int'</span><span class="p">,</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">specie</span> <span class="o">=</span> <span class="o">@</span><span class="n">sp</span><span class="p">,</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">multip</span> <span class="o">=</span> <span class="o">@</span><span class="n">mult</span><span class="p">;</span> </div></div></pre></div></figure></p> <p><strong>Code Snippet 8:</strong> <em>Multiple Parameters</em></p> <p>What we see in <em>Code Snippet 8</em> is how the <code>@multip</code> parameter is defined in the <code>@params</code> list and added to the stored procedure. We have also created a variable, <code>@mult</code>, which we have set a value for, we have then assigned the variable to the parameter.</p> <blockquote><p><strong>NOTE:</strong> When you refer to the parameters in the script file, you refer to them without the ampersand, so <code>@multip</code> becomes <code>multip</code> and so forth.</p></blockquote> <p>One more thing, we have now seen how parameters are used to assign to a query as well as pass into the script. When we look at the code in <em>Code Snippet 8</em> we see how we:</p> <ul> <li>Calculate the mean and assign it to a variable (<code>meanSepWidth &lt;- mean(setosa$SepalWidth)</code>).</li> <li>Print out the mean using the <code>cat</code> function.</li> </ul> <p>In a "real-world" scenario, you would not print out the variable, but instead wanting it passed back to the calling code. As with any code in SQL Server, when we want data passed back (data that is not resultsets that is), we use output parameters. By now we should know the "drill"; add a parameter to the <code>@params</code> list, mark it as <code>OUTPUT</code> and then add the parameter to the procedure:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Output</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="n">meanOut</span> <span class="n">float</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="n">mult</span> <span class="n">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="n">sp</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'setosa'</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>          setosa &lt;- MyDataSet
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>          meanSepWidth &lt;- mean(setosa$SepalWidth)
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>          multiplier &lt;- multip
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>          setosa$SepalLength &lt;- setosa$SepalLength * multiplier
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>          OutputDataSet &lt;- data.frame(setosa$SepalLength)'</span><span class="p">,</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT * FROM dbo.tb_irisdata_full
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>                        WHERE Species = @specie'</span><span class="p">,</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'MyDataSet'</span><span class="p">,</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@specie nvarchar(20), @multip int, @meanSepWidth float OUT'</span><span class="p">,</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">specie</span> <span class="o">=</span> <span class="o">@</span><span class="n">sp</span><span class="p">,</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">multip</span> <span class="o">=</span> <span class="o">@</span><span class="n">mult</span><span class="p">,</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">meanSepWidth</span> <span class="o">=</span> <span class="o">@</span><span class="n">meanOut</span> <span class="k">OUT</span><span class="p">;</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span>  <span class="o">@</span><span class="n">meanOut</span> <span class="k">AS</span> <span class="n">MeanSepWidth</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 9:</strong> <em>Use of Output Parameter</em></p> <p>In <em>Code Snippet 9</em> we see how the <code>@meanSepWidth</code> parameter is defined to the <code>@params</code> list as <code>OUTPUT</code> (<code>OUT</code> works as well) and added to the procedure. When we execute the code we get two resultsets coming back, one from the <code>OutputDataSet &lt;- data.frame(setosa$SepalLength)</code> and the second from <code>SELECT @meanOut AS MeanSepWidth</code>:</p> <p><img class="center" src="/images/posts/sql_r_services_ext_scriptII_outparam.png" width="185" height="175" > <strong>Figure 1:</strong> <em>Resultsets Coming Back</em></p> <p>The last thing to discuss related to parameters are how it works internally, similar to how we in <a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">sp_execute_external_script - I</a> discussed how the script knew about the input and output datasets. Here we discuss how the script and the engine know about parameters and their values. Oh, in [Internals - XVIII] we discussed the mechanism with which the value(s) of the output parameter(s) come back, so, therefore, we do not cover return values of output parameters in this post.</p> <p>To begin with, in what packets are the parameters passed? To find this out, we use some much-simplified code from what we have used so far:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Text</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>        d &lt;- 42
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>        cat(paste("Answer:", d))'</span><span class="p">;</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>        d &lt;- multip
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>        cat(paste("Answer:", d))'</span><span class="p">,</span>    <br/>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@multip int'</span><span class="p">,</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">multip</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 10:</strong> <em>Execution with and without Parameters</em></p> <p>As we see in <em>Code Snippet 10</em> there are two instances of <code>sp_execute_external_script</code>, both are very similar, and both generate the same result. What differs is that the first one has the value <code>42</code> hard-coded where the other pass the value via a parameter. The idea is now to initially to use <em>Process Monitor</em> and compare the packets SQL Server sends to the SqlSatellite to see if we can figure out what packet passes the parameter(s). So:</p> <ul> <li>Run <em>Process Monitor</em> as admin and load the filter we used in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> where we filtered for <code>TCP Receive</code> for <code>BxlServer.exe</code>.</li> <li>Run the two <code>EXECUTE</code> statements in <em>Code Snippet 10</em> and compare the output from <em>Process Monitor</em>. Make also a note of the <code>Path</code> column and the last value. That value is the port number of the TCP port with which SQL Server communicates with the SqlSatellite. We use the port value in <em>WireShark</em> when we "sniff" network packets later.</li> </ul> <p>When we execute the two statements in <em>Code Snippet 10</em>, <em>Process Monitor</em> outputs this:</p> <p><img class="center" src="/images/posts/sql_r_services_ext_scriptII_param_packets.png" width="565" height="300" > <strong>Figure 2:</strong> <em>Packets Sent</em></p> <p>The black line in <em>Figure 2</em> separates the two executions, and we see how the third packet in each run differs in size (outlined in blue and red respectively). The packet outlined in red is bigger and comes from the second run - where we used the <code>@multip</code> parameter. The third packet is the packet where SQL Server sends the script to the SqlSatellite, and from what we can see so far it looks like some parameter information is part of this packet. Let us switch over to <em>WireShark</em> and see what goes on.</p> <ul> <li>Run <em>WireShark</em> as admin.</li> <li>Choose the network adapter to "sniff" on. See <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> for discussion around loop-back adapters etc.</li> <li>Set a display filter on the port SQL Server communicates with SqlSatellite on (the port you saw in the <code>Path</code> column). In this case, we want to sniff outgoing packets, and - if we used what we saw in <em>Figure 2</em> - the filter should subsequently be: <code>tcp.srcport==50858</code>.</li> <li>Apply the filter.</li> </ul> <p>Execute the code in <em>Code Snippet 10</em> where we use the <code>@multip</code> parameter and look at the output from <em>WireShark</em>. In the output is a packet with the same length as the packet outlined in red in <em>Figure 2</em>, let us have a look at the data part of that packet:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Hex Dump I</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">01</span> <span class="mo">00</span> <span class="mo">05</span> <span class="mi">80</span> <span class="mi">25</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="n">e3</span> <span class="mo">01</span> <span class="mi">86</span> <span class="mi">81</span> <span class="n">e1</span> <span class="n">a2</span> <span class="mi">2</span><span class="n">e</span> <span class="mi">43</span>   <span class="p">....</span><span class="o">%</span><span class="p">...</span> <span class="p">.......</span><span class="n">C</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">b8</span> <span class="n">e0</span> <span class="n">a7</span> <span class="mi">31</span> <span class="mi">0</span><span class="n">d</span> <span class="n">d1</span> <span class="mi">83</span> <span class="n">dd</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span>   <span class="p">..</span><span class="mf">.1</span><span class="p">....</span> <span class="p">........</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">1</span><span class="n">a</span> <span class="mo">00</span> <span class="mi">49</span> <span class="mo">00</span>  <span class="mi">6</span><span class="n">e</span> <span class="mo">00</span> <span class="mi">70</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span>   <span class="p">......</span><span class="n">I</span><span class="p">.</span> <span class="n">n</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">t</span><span class="p">.</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">44</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span>  <span class="mi">53</span> <span class="mo">00</span> <span class="mi">65</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="n">D</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">a</span><span class="p">.</span> <span class="n">S</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">t</span><span class="p">...</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">1</span><span class="n">c</span> <span class="mo">00</span> <span class="mi">4</span><span class="n">f</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span>  <span class="mi">70</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">44</span> <span class="mo">00</span>   <span class="p">..</span><span class="n">O</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">t</span><span class="p">.</span> <span class="n">p</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">D</span><span class="p">.</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">61</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span> <span class="mi">53</span> <span class="mo">00</span>  <span class="mi">65</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span>   <span class="n">a</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">S</span><span class="p">.</span> <span class="n">e</span><span class="p">.</span><span class="n">t</span><span class="p">..</span><span class="mf">.0</span><span class="p">.</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span>  <span class="mo">03</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">.</span><span class="mf">.0</span><span class="p">.....</span> <span class="p">........</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">12</span> <span class="mo">00</span> <span class="mi">45</span> <span class="mo">00</span> <span class="mi">78</span> <span class="mo">00</span> <span class="mi">70</span> <span class="mo">00</span>  <span class="mi">72</span> <span class="mo">00</span> <span class="mi">31</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span>   <span class="p">..</span><span class="n">E</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">p</span><span class="p">.</span> <span class="n">r</span><span class="mf">.1.0.0</span><span class="p">.</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">30</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span> <span class="mo">00</span>   <span class="mf">0.</span><span class="p">.</span><span class="mf">.8</span><span class="p">...</span> <span class="mf">8.</span><span class="p">......</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mi">2</span><span class="n">a</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">10</span> <span class="mo">00</span> <span class="mi">40</span>   <span class="p">........</span> <span class="p">.</span><span class="o">*</span><span class="p">.....</span><span class="err">@</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="mi">6</span><span class="n">d</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">c</span> <span class="mo">00</span> <span class="mi">74</span>  <span class="mo">00</span> <span class="mi">69</span> <span class="mo">00</span> <span class="mi">70</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">70</span>   <span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">t</span> <span class="p">.</span><span class="n">i</span><span class="p">.</span><span class="n">p</span><span class="p">...</span><span class="n">p</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mi">80</span> <span class="mi">0</span><span class="n">d</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span>  <span class="mo">00</span> <span class="mi">20</span> <span class="mo">00</span> <span class="mi">20</span> <span class="mo">00</span> <span class="mi">20</span> <span class="mo">00</span> <span class="mi">20</span>   <span class="p">........</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">...</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 11:</strong> *Hex Dump of Data Packet"</p> <p>We see in <em>Code Snippet 11</em> the first 192 bytes of the packet containing the script which SQL Server sent to the SqlSatellite. In the text representation of the hex, we can see the parameter name (<code>@multip</code>), and it starts at byte 160 (the first byte in hex is <code>40</code>). So parameters are sent to the engine via the packet containing the script. What about the value of the parameter?</p> <p>The value of the parameter is somewhat harder to figure out, seeing the value is an <code>int</code> and therefore not in clear-text. However, if we look closely at the hex, we see at byte 154 a hex value of <code>2a</code> which in decimal is 42. So SQL Server passes the value(s) of the parameter(s) as well in the "script" packet. In this case, it was one parameter with one value, what happens if we have multiple parameters and values, for example, something like this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Multiple Params</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>        d &lt;- multip1 * multip2
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>        cat(paste("Answer:", d))'</span><span class="p">,</span>    <br/>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@multip1 int, @multip2 int'</span><span class="p">,</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">multip1</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="n">multip2</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 12:</strong> <em>Script using Multiple Parameters</em></p> <p>In the code in <em>Code Snippet 12</em> we send two parameters to the script (<code>@multip1</code> and <code>@multip2</code>) and the hex-dump we get after we execute the code looks like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Hex Dump II</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">01</span> <span class="mo">00</span> <span class="mo">05</span> <span class="mi">80</span> <span class="mi">6</span><span class="n">a</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="n">b8</span> <span class="n">b1</span> <span class="n">da</span> <span class="mi">7</span><span class="n">e</span> <span class="n">cc</span> <span class="n">d0</span> <span class="mi">4</span><span class="n">e</span> <span class="mi">40</span>   <span class="p">....</span><span class="n">j</span><span class="p">...</span> <span class="p">...</span><span class="o">~</span><span class="p">..</span><span class="n">N</span><span class="err">@</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">90</span> <span class="mi">95</span> <span class="n">c1</span> <span class="n">e3</span> <span class="n">e0</span> <span class="mi">58</span> <span class="n">dd</span> <span class="mi">7</span><span class="n">e</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">02</span> <span class="mo">00</span>   <span class="p">.....</span><span class="n">X</span><span class="p">.</span><span class="o">~</span> <span class="p">........</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">1</span><span class="n">a</span> <span class="mo">00</span> <span class="mi">49</span> <span class="mo">00</span>  <span class="mi">6</span><span class="n">e</span> <span class="mo">00</span> <span class="mi">70</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span>   <span class="p">......</span><span class="n">I</span><span class="p">.</span> <span class="n">n</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">t</span><span class="p">.</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">44</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span>  <span class="mi">53</span> <span class="mo">00</span> <span class="mi">65</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="n">D</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">a</span><span class="p">.</span> <span class="n">S</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">t</span><span class="p">...</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">1</span><span class="n">c</span> <span class="mo">00</span> <span class="mi">4</span><span class="n">f</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span>  <span class="mi">70</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">44</span> <span class="mo">00</span>   <span class="p">..</span><span class="n">O</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">t</span><span class="p">.</span> <span class="n">p</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">D</span><span class="p">.</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">61</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">61</span> <span class="mo">00</span> <span class="mi">53</span> <span class="mo">00</span>  <span class="mi">65</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span>   <span class="n">a</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">S</span><span class="p">.</span> <span class="n">e</span><span class="p">.</span><span class="n">t</span><span class="p">..</span><span class="mf">.0</span><span class="p">.</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span>  <span class="mo">03</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">.</span><span class="mf">.0</span><span class="p">.....</span> <span class="p">........</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">12</span> <span class="mo">00</span> <span class="mi">45</span> <span class="mo">00</span> <span class="mi">78</span> <span class="mo">00</span> <span class="mi">70</span> <span class="mo">00</span>  <span class="mi">72</span> <span class="mo">00</span> <span class="mi">31</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span> <span class="mi">30</span> <span class="mo">00</span>   <span class="p">..</span><span class="n">E</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">p</span><span class="p">.</span> <span class="n">r</span><span class="mf">.1.0.0</span><span class="p">.</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">30</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span> <span class="mo">00</span>   <span class="mf">0.</span><span class="p">.</span><span class="mf">.8</span><span class="p">...</span> <span class="mf">8.</span><span class="p">......</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mi">2</span><span class="n">a</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span>   <span class="p">........</span> <span class="p">.</span><span class="o">*</span><span class="p">..</span><span class="mf">.8</span><span class="p">..</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="mi">38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mo">00</span>   <span class="mf">.8</span><span class="p">......</span> <span class="p">........</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="mo">00</span> <span class="mo">05</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">12</span> <span class="mo">00</span>  <span class="mi">40</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">d</span> <span class="mo">00</span> <span class="mi">75</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">c</span> <span class="mo">00</span>   <span class="p">........</span> <span class="err">@</span><span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">74</span> <span class="mo">00</span> <span class="mi">69</span> <span class="mo">00</span> <span class="mi">70</span> <span class="mo">00</span> <span class="mi">31</span> <span class="mo">00</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mi">12</span> <span class="mo">00</span> <span class="mi">40</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">d</span> <span class="mo">00</span>   <span class="n">t</span><span class="p">.</span><span class="n">i</span><span class="p">.</span><span class="n">p</span><span class="mf">.1</span><span class="p">.</span> <span class="p">....</span><span class="err">@</span><span class="p">.</span><span class="n">m</span><span class="p">.</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">75</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">c</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">69</span> <span class="mo">00</span>  <span class="mi">70</span> <span class="mo">00</span> <span class="mi">32</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">86</span> <span class="mo">00</span>   <span class="n">u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">i</span><span class="p">.</span> <span class="n">p</span><span class="mf">.2</span><span class="p">.....</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mi">80</span> <span class="mi">0</span><span class="n">d</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">a</span> <span class="mo">00</span>  <span class="mi">20</span> <span class="mo">00</span> <span class="mi">20</span> <span class="mo">00</span> <span class="mi">20</span> <span class="mo">00</span> <span class="mi">20</span> <span class="mo">00</span>   <span class="p">........</span>  <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 13:</strong> <em>Hex Dump from Multiple Parameters</em></p> <p>In <em>Code Snippet 13</em> we see the first 240 bytes of the hex-dump from <em>Code Snippet 12</em>. When I saw this dump for the first time I was surprised to see that the parameter names are together. I thought they would appear together with the values. However as we clearly can see the values come first. We see hex <code>2a</code> (decimal 42) at byte 154, and hex <code>05</code> (decimal 5) at byte 179 and the first parameter name starts at byte 185 (hex <code>40</code>). In essence, the parameter values come before the parameter names.</p> <p>When we look at the two hex-dumps, there is something else worth noticing. If we look closely at where the values are and the parameter names we see how:</p> <ul> <li>Four bytes before the value of each parameter there is a hex value greater than 0.</li> <li>Two bytes before the parameter name is also a hex value greater than 0.</li> </ul> <p>After doing quite a few tests, I believe (almost 100% certain) that the value before the parameter value indicates the data size of the actual parameter value. In code snippets 11 and 13 that value is hex <code>04</code>, which is decimal 4 - the size of an integer. The value in front of the parameter name tells us the length of the parameter name in double-byte. In <em>Code Snippet 11</em> the value is hex <code>10</code> which is decimal 16, and that is the double-byte length of the parameter <code>@multip</code>. In <em>Code Snippet 13</em> the value is hex <code>12</code> before each parameter. Hex <code>12</code> is decimal 18, which is the double-byte length of <code>@multip1</code> and <code>@multip2</code>.</p> <h2>Summary</h2> <p>Phew, that was quite a lot. So :</p> <ul> <li>The <code>@params</code> parameter is used to define what parameters we use in the execution. The query in <code>@input_data_1</code> can use those parameters as well as the external script.</li> <li>The parameters defined in the <code>@params</code> list need to be added as named parameters to the stored procedure.</li> <li>In the case of parameters for the external script; the script references the parameters by name but without the <code>@</code> sign</li> <li>SQL Server sends the parameters and their values to the SqlSatellite in the packet containing the external script.</li> <li>In the "script" packet, preceding the values and the parameter names are hex values indicating the size of the parameter value (data type) and the parameter name.</li> </ul> <h2>~ Finally</h2> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/&text=Microsoft SQL Server R Services - sp_execute_external_script - II&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/ &title=Microsoft SQL Server R Services - sp_execute_external_script - II &summary=Blog post: A lowdown of sp_execute_external_script and its @params and @parameter1 parameters, using Process Monitor and WireShark &source=http://www.nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> <br/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad2 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="1158080725" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2018/07/08/interesting-stuff-week-27/"> Interesting Stuff - Week 27 <small> (08 Jul 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/07/07/sp-execute-external-script-and-sql-compute-context-II/"> sp_execute_external_script and SQL Compute Context - II <small> (07 Jul 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/07/01/interesting-stuff-week-26/"> Interesting Stuff - Week 26 <small> (01 Jul 2018)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
