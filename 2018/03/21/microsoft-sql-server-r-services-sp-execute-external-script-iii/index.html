<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Microsoft SQL Server R Services - sp_execute_external_script - III &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Microsoft SQL Server R Services - sp_execute_external_script - III</h1>
  <div class="post-subheading">
  <span class="post-date">21 Mar 2018</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services Series">SQL Server R Services Series</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>This post is the 24:th post about <strong>Microsoft SQL Server R Services</strong>, and the third that covers <code class="highlighter-rouge">sp_execute_external_script</code>. I have thought many times that this series has reached its end, and I have many times realised I was wrong. Well, now I can say that this is the last post in the series! I started over a year ago (March 4 2017) with an idea about “wouldn’t it be cool if I wrote a couple of posts about <strong>Microsoft SQL Server R Services</strong>”! Over one year and 24 posts later, here we are!</p>

<p>This last post talks about <code class="highlighter-rouge">sp_execute_external_script</code> and a parameter named <code class="highlighter-rouge">@parallel</code>. When we discuss this parameter, we also touch (a little bit) upon performance aspects of <code class="highlighter-rouge">sp_execute_external_script</code>.</p>

<!--more-->

<blockquote>
  <p><strong>NOTE:</strong> This post has similarities with the <a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Microsoft SQL Server R Services - Internals V</a> post, where I also discussed parallel execution. In that post however I concentrated more on the internal workings , whereas I in this post will not go that deep. In this post I also cover a couple of more things than just the <code class="highlighter-rouge">@parallel</code> parameter.</p>
</blockquote>

<h2 id="recap">Recap</h2>

<p>In the two last posts in this series we discussed <code class="highlighter-rouge">sp_execute_external_script</code> and the parameters the procedure expects/takes:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sp_execute_external_script</span> 
             <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'language'</span><span class="p">,</span> 
             <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'script'</span><span class="p">,</span> 
             <span class="p">[</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="p">]</span> <span class="s1">'input_data_1'</span> 
             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="p">]</span> <span class="n">N</span><span class="s1">'input_data_1_name'</span> <span class="p">]</span> 
             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">output_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'output_data_1_name'</span> <span class="p">]</span> 
             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">parallel</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="p">]</span> 
             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="p">]</span> <span class="n">N</span><span class="s1">'@parameter_name data_type [ OUT | OUTPUT ] [ ,...n ]'</span> 
             <span class="p">[</span> <span class="p">,</span> <span class="o">@</span><span class="n">parameter1</span> <span class="o">=</span> <span class="p">]</span> <span class="s1">'value1'</span> <span class="p">[</span> <span class="k">OUT</span> <span class="o">|</span> <span class="k">OUTPUT</span> <span class="p">]</span> <span class="p">[</span> <span class="p">,...</span><span class="n">n</span> <span class="p">]</span> 
<span class="p">[</span> <span class="k">WITH</span> <span class="o">&lt;</span><span class="n">execute_option</span><span class="o">&gt;</span> <span class="p">]</span> 
<span class="p">[;]</span> 
</code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Full Signature of sp_execute_external_script</em></p>

<p>In <em>Code Snippet 1</em> we see all parameters for <code class="highlighter-rouge">sp_execute_external_script</code>, and here is what we have covered so far:</p>

<h4 id="microsoft-sql-server-r-services-sp_execute_external_script---i">Microsoft SQL Server R Services: sp_execute_external_script - I</h4>

<p>In <a href="/2018/03/07/microsoft-sql-server-r-services-sp_execute_external_script-I/">sp_execute_external_script - I</a> we discussed:</p>

<ul>
  <li><code class="highlighter-rouge">@language</code> - tells the launchpad service what external engine to use. At the moment R and Python are supported. The parameter is required.</li>
  <li><code class="highlighter-rouge">@script</code> - defines the script which the external engine executes. The script can be loaded as a literal value, a parameter or through the R <code class="highlighter-rouge">source(file_name)</code> command. The parameter is required.</li>
  <li><code class="highlighter-rouge">@input_data_1</code> - specifies the input data used by the external script in the form of a Transact-SQL query (<code class="highlighter-rouge">SELECT</code> only, no procedure calls). The query can only generate one dataset. If more datasets are required, the script must retrieve them from within the script. The parameter is optional.</li>
  <li><code class="highlighter-rouge">@input_data_1_name</code> - specifies the name of the variable used to represent the query defined by @input_data_1. The parameter is optional, and defaults to <code class="highlighter-rouge">InputDataset</code>.</li>
  <li><code class="highlighter-rouge">@output_data_1_name</code> - specifies the name of the variable in the external script that contains the data to be returned to SQL Server when the stored procedure completes. The parameter is optional, and defaults to <code class="highlighter-rouge">OutputDataSet</code>.</li>
</ul>

<p>All of the above parameter values have to be of the  <code class="highlighter-rouge">NVARCHAR</code> data type.</p>

<h4 id="microsoft-sql-server-r-services---sp_execute_external_script---ii">Microsoft SQL Server R Services - sp_execute_external_script - II</h4>

<p>The next post <a href="/2018/03/11/microsoft-sql-server-r-services-sp-execute-external-script-ii/">sp_execute_external_script - II</a> covered <code class="highlighter-rouge">@params</code> and <code class="highlighter-rouge">@parameter1</code>:</p>

<ul>
  <li>The <code class="highlighter-rouge">@params</code> parameter is used to define what parameters we use in the execution. The query in <code class="highlighter-rouge">@input_data_1</code> can use those parameters as well as the external script.</li>
  <li>The parameters defined in the <code class="highlighter-rouge">@params</code> list need to be added as named parameters to the stored procedure.</li>
  <li>In the case of parameters for the external script; the script references the parameters by name but without the <code class="highlighter-rouge">@</code> sign</li>
  <li>SQL Server sends the parameters and their values to the SqlSatellite in the packet containing the external script.</li>
  <li>In the “script” packet, preceding the values and the parameter names are hex values indicating the size of the parameter value (data type) and the parameter name.</li>
</ul>

<p>So, now there is one parameter which we have not talked about: <code class="highlighter-rouge">@parallel</code>, and - as I mentioned above - that is the topic of this post.</p>

<h2 id="housekeeping">Housekeeping</h2>

<p>Before we “dive” into today’s topics let us look at the code and the tools we use today. This section is here for those who want to follow along in what we are doing in the post.</p>

<h4 id="helper-tools">Helper Tools</h4>

<p>To help us figure out the things we want, we use <em>Process Monitor</em>, and <em>Process Explorer</em>:</p>

<ul>
  <li><em>Process Monitor</em>, is used it to filter TCP traffic. If you want to refresh your memory about how to do it, we covered that in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> as well as in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>.</li>
  <li><em>Process Explorer</em> is used to look at running processes.</li>
</ul>

<h4 id="code">Code</h4>

<p>In this post, we do not use the same database and database objects as we have in last few posts, but something from quite a while back, for example <a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Microsoft SQL Server R Services - Internals V</a>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="n">USE</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Rand_3M</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Rand_3M</span>
<span class="p">(</span>
  <span class="n">RowID</span> <span class="n">bigint</span> <span class="k">identity</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">y</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand1</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> 
  <span class="n">rand2</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand3</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> 
  <span class="n">rand4</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand5</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Rand_3M</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">rand3</span><span class="p">,</span> <span class="n">rand4</span><span class="p">,</span> <span class="n">rand5</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">3000000</span><span class="p">)</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span> 
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">20</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">25</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">50</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">100</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o1</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o2</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o3</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o4</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Model</span><span class="p">;</span> 
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Model</span>
<span class="p">(</span>
  <span class="n">RowID</span> <span class="n">bigint</span> <span class="k">identity</span><span class="p">,</span>
  <span class="n">ModelName</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
  <span class="n">ModelBin</span> <span class="n">varbinary</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>
  <span class="k">CONSTRAINT</span> <span class="p">[</span><span class="n">pk_Model</span><span class="p">]</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">RowID</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Rand_30M</span>
<span class="k">GO</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Rand_30M</span>
<span class="p">(</span>
  <span class="n">RowID</span> <span class="n">bigint</span> <span class="k">identity</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> 
  <span class="n">y</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand1</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> 
  <span class="n">rand2</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand3</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> 
  <span class="n">rand4</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand5</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">GO</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Rand_30M</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">rand3</span><span class="p">,</span> <span class="n">rand4</span><span class="p">,</span> <span class="n">rand5</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">30000000</span><span class="p">)</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span> 
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">20</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">25</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">50</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">100</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o1</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o2</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o3</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o4</span><span class="p">;</span>
<span class="k">GO</span>

</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Setup of Database, Table and Data</em></p>

<p>The code above (<em>Code Snippet 2</em>), creates three tables:</p>

<ul>
  <li><code class="highlighter-rouge">dbo.tb_Rand_3M</code> - This table contains the data we want to analyse. Yes, I know - the data is completely useless, but it is a lot of it, and it helps to illustrate what we want to do.</li>
  <li><code class="highlighter-rouge">dbo.tb_Model</code> - The purpose of this table is to hold the data science models we create. When we subsequently make predictions against the data we load a model from the table.</li>
  <li><code class="highlighter-rouge">dbo.tb_Rand_30M</code> - Similar table to <code class="highlighter-rouge">dbo.tb_Rand_3M</code> but holds 30 million rows instead of 3 million.</li>
</ul>

<p>In <em>Code Snippet 2</em> we also see how we load 3 million records into the <code class="highlighter-rouge">dbo.tb_Rand_3M</code> as well as 30 million into the <code class="highlighter-rouge">dbo.tb_Rand_30M</code> tables. Be aware that when you run the code in <em>Code Snippet 2</em> it may take some time to finish.</p>

<p>The last thing we need to do before we get started in earnest is to create some models which we later use when we talk about the topics for this post. What we want to do with is to create linear regression models, where - ultimately - we want to predict the value of <code class="highlighter-rouge">y</code> in <code class="highlighter-rouge">dbo.tb_Rand_3M</code>. We believe <code class="highlighter-rouge">y</code> is related to <code class="highlighter-rouge">rand1</code>, <code class="highlighter-rouge">rand2</code>, <code class="highlighter-rouge">rand3</code>,  <code class="highlighter-rouge">rand4</code> and <code class="highlighter-rouge">rand5</code> and that is the bases for the prediction. In reality, there is no relation as such, but in this case, it does not matter - we just want to “play” with some data. We create two models, one using <strong>CRANR</strong> and one using <strong>RevoScaleR</strong> functionality, which we then persist to the <code class="highlighter-rouge">dbo.tb_Model</code> table above:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- this creates the CRANR model, using GLM</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="k">mod</span> <span class="n">varbinary</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
    <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
          myModel &lt;- glm(y ~ rand1 + rand2 + rand3 + rand4 + rand5, 
                       data=InputDataSet)
          
          model &lt;- serialize(myModel, NULL);'</span>
   
   <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
          SELECT  y, rand1, rand2, rand3, 
                  rand4, rand5 
          FROM dbo.tb_Rand_3M TABLESAMPLE(75 PERCENT) 
                              REPEATABLE(98074)'</span><span class="p">,</span>
     <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@model varbinary(max) OUT'</span><span class="p">,</span>
     <span class="o">@</span><span class="n">model</span> <span class="o">=</span> <span class="o">@</span><span class="k">mod</span> <span class="k">OUT</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Model</span><span class="p">(</span><span class="n">ModelName</span><span class="p">,</span> <span class="n">ModelBin</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'GLM_75Pct'</span><span class="p">,</span> <span class="o">@</span><span class="k">mod</span><span class="p">);</span>
<span class="k">GO</span>

<span class="c1">-- this creates the RevoScaleR model</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="k">mod</span> <span class="n">varbinary</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
    <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
          myModel &lt;- rxLinMod(y ~ rand1 + rand2 + rand3 + rand4 + rand5, 
                       data=InputDataSet)
          
          model &lt;- serialize(myModel, NULL);'</span>
   
   <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
          SELECT  y, rand1, rand2, rand3, 
                  rand4, rand5 
          FROM dbo.tb_Rand_3M TABLESAMPLE(75 PERCENT) 
                              REPEATABLE(98074)'</span><span class="p">,</span>
     <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@model varbinary(max) OUT'</span><span class="p">,</span>
     <span class="o">@</span><span class="n">model</span> <span class="o">=</span> <span class="o">@</span><span class="k">mod</span> <span class="k">OUT</span><span class="p">;</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Model</span><span class="p">(</span><span class="n">ModelName</span><span class="p">,</span> <span class="n">ModelBin</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'RxLM_75Pct'</span><span class="p">,</span> <span class="o">@</span><span class="k">mod</span><span class="p">);</span>
<span class="k">GO</span>     
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> “Creation of CRANR and RevoScaleR Models”</p>

<p>As I said above, the code in <em>Code Snippet 3</em> creates two models, one using “traditional” <code class="highlighter-rouge">glm</code>, and one <code class="highlighter-rouge">rxLinMod</code> from RevoScaleR. We persist the two models to the <code class="highlighter-rouge">dbo.tb_Model</code> table with a name, so we can retrieve them when we want to run predictions.</p>

<p>Now then, let us start. However, before we look into parallel processing and the <code class="highlighter-rouge">@parallel</code> parameter and all the other “cool stuff” let us recap what we have talked about in previous posts.</p>

<h2 id="background">Background</h2>

<p>In quite a few posts we have discussed how the launchpad service creates multiple RTerm processes when we execute <code class="highlighter-rouge">sp_execute_external_script</code>, and by default one of those processes executes the work. We can see the behaviour if we execute following code:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">model</span> <span class="n">varbinary</span><span class="p">(</span><span class="k">max</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">ModelBin</span>  
                                <span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Model</span> 
                                <span class="k">WHERE</span> <span class="n">ModelName</span> <span class="o">=</span> <span class="s1">'RxLM_75Pct'</span><span class="p">);</span>  
  <span class="k">EXEC</span> <span class="n">sp_execute_external_script</span> <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>  
     <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
       Sys.sleep(10)  
       mod &lt;- unserialize(model); 
       cat(paste0("R Process ID = ", Sys.getpid()))
       cat("</span><span class="se">\n</span><span class="s1">")
       cat(paste0("Nmbr rows = ", nrow(InputDataSet)))
       cat("</span><span class="se">\n</span><span class="s1">")
       cat("----------------")
       cat("</span><span class="se">\n</span><span class="s1">")      
       OutputDataSet &lt;- data.frame(rxPredict(modelObject = mod, 
           data = InputDataSet, 
           outData = NULL, 
           type = "response", 
           writeModelVars = FALSE, overwrite = TRUE));'</span><span class="p">,</span>  
  <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT TOP(2800000) y, rand1, rand2, rand3, 
                      rand4, rand5 
              FROM dbo.tb_Rand_3M 
WHERE  rand5 &gt;= 10'</span><span class="p">,</span> 
  <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@model varbinary(max)'</span><span class="p">,</span>  
  <span class="o">@</span><span class="n">model</span> <span class="o">=</span> <span class="o">@</span><span class="n">model</span><span class="p">;</span>
</code></pre></div></div>
<p><em>*Code Snippet 4:</em>Executing Prediction*</p>

<p>In <em>Code Snippet 4</em> we see how we, to begin with, retrieve the binary representation of the persisted model and use it as a parameter passed into the script. In the script, we first deserialise the binary model passed in, and from there we use it to predict <code class="highlighter-rouge">y</code>, based on the input data. The data passed in is the dataset we <code class="highlighter-rouge">SELECT</code> in <code class="highlighter-rouge">@input_data_1</code>, and the prediction function we use is the RevoScaleR <code class="highlighter-rouge">rxPredict</code> function. Finally, the predicted values come back in the <code class="highlighter-rouge">OutputDataSet</code>. Oh, the <code class="highlighter-rouge">Sys.sleep</code> at the first line of the script is so we, when we use <em>Process Explorer</em>, more easily can see what is happening. The part of the script with the <code class="highlighter-rouge">cat</code> statements is also to make what we see clearer.</p>

<blockquote>
  <p><strong>NOTE:</strong> In future posts, outside of this series, the plan is to talk more about <strong>RevoScaleR</strong> functions.</p>
</blockquote>

<p>When we execute the code, a resultset comes back and a print of the <code class="highlighter-rouge">cat</code> statements as below:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptIII_ssms1.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Output of cat</em></p>

<p>We see in <em>Figure 1</em> the process id of the RTerm the script ran in, and the number of rows that the external engine processed. Now let us check with <em>Process Explorer</em> what happens when we execute the same code:</p>

<ul>
  <li>Run <em>Process Explorer</em> as admin.</li>
  <li>Restart the launchpad service (this is to clean-up any RTerm processes).</li>
  <li>Navigate to the <code class="highlighter-rouge">Launchpad.exe</code> process in <em>Process Explorer</em>.</li>
  <li>Execute the code in <em>Code Snippet 4</em>.</li>
</ul>

<p>While the code is executing, look under the <code class="highlighter-rouge">Launchpad.exe</code> process in <em>Process Explorer</em> and you see something like so:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptIII_proc_exp1.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>Process Explorer Output</em></p>

<p>We see in <em>Figure 2</em> multiple RTerm processes, hosting BxlServer processes and this matches pretty good with what we discussed in previous posts about the launchpad service, RTerm and BxlServer processes and so forth, and we try to illustrate that like this:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptIII_single_process.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>Process Flow</em></p>

<p>In <em>Figure 3</em> we see what happens when we execute <code class="highlighter-rouge">sp_execute_external_script</code> and the numbers in the figure stands for:</p>

<ol>
  <li>We call <code class="highlighter-rouge">sp_execute_external_script</code> and SQL Server calls into the launchpad service.</li>
  <li>The launchpad service creates RTerm processes which in turn creates BxlServer processes. One process becomes the executing process (outlined in red in <em>Figure 2</em>).</li>
  <li>A TCP connection from the SqlSatellite in the executing process gets established.</li>
  <li>SQL server sends input data to the SqlSatellite.</li>
  <li>The <code class="highlighter-rouge">BxlServer.exe</code> does the processing.</li>
  <li>SQL Server receives data back from the SqlSatellite.</li>
</ol>

<h2 id="parallel-processing">Parallel Processing</h2>

<p>Let us now look at parallel execution. When you read documentation about <strong>SQL Server R Services</strong> it always mentions how efficient it is to execute external scripts as one can utilise SQL’s parallelism. How does this work then? In “normal” SQL Server parallelism, SQL Server decides whether to execute a statement in parallel or not, and the <code class="highlighter-rouge">MAXDOP</code> setting defines the number of processors executing the statement.</p>

<h4 id="parallel"><code class="highlighter-rouge">@parallel</code></h4>

<p>In <strong>SQL Server R Services</strong> it works in a similar way, except that you have to say that you want to execute in parallel explicitly. To indicate you want parallel processing, you use the <code class="highlighter-rouge">@parallel</code> parameter, as so: <code class="highlighter-rouge">@parallel = 1</code>. The <code class="highlighter-rouge">@parallel</code> parameter is optional and by default set to 0 (no parallelism). This code shows it in action:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">model</span> <span class="n">varbinary</span><span class="p">(</span><span class="k">max</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">ModelBin</span>
                                 <span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Model</span> 
                                 <span class="k">WHERE</span> <span class="n">ModelName</span> <span class="o">=</span> <span class="s1">'RxLM_75Pct'</span><span class="p">);</span>  
  <span class="k">EXEC</span> <span class="n">sp_execute_external_script</span> <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>  
     <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
       Sys.sleep(10)   
       mod &lt;- unserialize(model); 
       cat(paste0("R Process ID = ", Sys.getpid()))
       cat("</span><span class="se">\n</span><span class="s1">")
       cat(paste0("Nmbr rows = ", nrow(InputDataSet)))
       cat("</span><span class="se">\n</span><span class="s1">")
       cat("----------------")
       cat("</span><span class="se">\n</span><span class="s1">")      
       OutputDataSet &lt;- data.frame(rxPredict(modelObject = mod, 
           data = InputDataSet, 
           outData = NULL, 
           type = "response", 
           writeModelVars = FALSE, overwrite = TRUE));'</span><span class="p">,</span>  
  <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT TOP(2800000) y, rand1, rand2, rand3, 
                      rand4, rand5 
              FROM dbo.tb_Rand_3M 
WHERE  rand5 &gt;= 10           
OPTION(querytraceon 8649, MAXDOP 4)'</span><span class="p">,</span> 
  <span class="o">@</span><span class="n">parallel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>                                   
  <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@model varbinary(max)'</span><span class="p">,</span>  
  <span class="o">@</span><span class="n">model</span> <span class="o">=</span> <span class="o">@</span><span class="n">model</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">((</span><span class="n">Y_predict</span> <span class="n">float</span><span class="p">));</span> 
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>Parallel Execution External Script</em></p>

<p>As you see, <em>Code Snippet 5</em> looks more or less like <em>Code Snippet 4</em>, the only difference being:</p>

<ul>
  <li><code class="highlighter-rouge">OPTION(querytraceon 8649, MAXDOP 4)</code> at the end of the input query.</li>
  <li><code class="highlighter-rouge">@parallel = 1</code>.</li>
  <li><code class="highlighter-rouge">WITH RESULT SETS ((Y_predict float))</code>.</li>
</ul>

<p>The <code class="highlighter-rouge">@parallel = 1</code> probably does not need any explanation - we want to run in parallel, but the <code class="highlighter-rouge">OPTION(querytraceon 8649, MAXDOP 4)</code> may need some clarification. When I <del>played with</del> researched the code for this post I had problems with getting a parallel query plan, so I try to force parallelism by setting the query trace flag 8649 explicitly. When using <code class="highlighter-rouge">@parallel = 1</code> you must specify a <code class="highlighter-rouge">WITH RESULT SETS</code> clause with output schema, regardless if you actually return a resultset or not.</p>

<p>So let us now see what it looks like when we execute the code in <em>Code Snippet 5</em>. For this we use <em>Process Explorer</em> in the same way as we used it above:</p>

<ul>
  <li>Run <em>Process Explorer</em> as admin.</li>
  <li>Restart the launchpad service (this is to clean-up any RTerm processes).</li>
  <li>Navigate to the <code class="highlighter-rouge">Launchpad.exe</code> process in <em>Process Explorer</em>.</li>
</ul>

<p>Execute the code in <em>Code Snippet 5</em>, and while it executes look under the <code class="highlighter-rouge">Launchpad.exe</code> and see if it is different from above:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptIII_proc_exp2.png" alt="" /></p>

<p><strong>Figure 4:</strong> <em>Parallel Execution</em></p>

<p>Yes, what we see in <em>Figure 4</em> is different than <em>Figure 2</em>, and we see how we now have four RTerm processes active (outlined in red). When we look at the output of the <code class="highlighter-rouge">cat</code> statements (below) we see that we have four different R process id’s, and they match the highlighted (in yellow) process id’s of the active RTerm processes in <em>Figure 4</em>:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptIII_ssms2.png" alt="" /></p>

<p><strong>Figure 5:</strong> <em>SSMS Output</em></p>

<p>So <em>Figure 5</em> shows that we ran the <code class="highlighter-rouge">rxPredict</code> function in parallel using 4 processes, and the reason for 4 processes was the <code class="highlighter-rouge">MAXDOP</code> setting (4). So how does this work then, is there a coordinator somewhere distributing the work, or what? Let us try and figure that out, and to help us we use <em>Process Monitor</em> (for now we can exit <em>Process Explorer</em>).</p>

<p>Run <em>Process Monitor</em> as admin and set a filter where we see connections to the <code class="highlighter-rouge">BxlServer.exe</code> process. To set the filter; under the <em>Filter</em> menu in <em>Process Monitor</em> click the Filter menu item to see the “Process Monitor Filter” dialog. To create the filter we enter the conditions we want to match:</p>

<ul>
  <li>The <em>Process Name</em> (from the first drop-down) should be  <em>is</em> (from the second drop down): <code class="highlighter-rouge">BxlServer.exe</code>.</li>
  <li><em>Operation</em> (first drop-down) <em>is</em> (second drop-down): “TCP Connect”.</li>
  <li>Click <em>OK</em> “Process Monitor Filter” dialog.</li>
</ul>

<p>The filter we created filters out anything but “TCP Connect” events against the <code class="highlighter-rouge">BxlServer.exe</code> process. We are interested in the “TCP Connect” events because when no parallelism is in play, there is only one connection between SQL Server and the BxlServer process - or rather the SqlSatellite which BxlServer loads into its process.</p>

<p>To see what happens, execute the code in <em>Code Snippet 5</em> and watch the output from <em>Process Monitor</em>:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptIII_procmon1.png" alt="" /></p>

<p><strong>Figure 6:</strong> <em>Multiple Connections</em></p>

<p>Notice, in <em>Figure 6</em>, how there are four connections, and when we look in the <code class="highlighter-rouge">Path</code> column we see how the connections are all made to port 52245 from ports: 53318, 53319, 53320 and 53321. Port 52245 is SQL Server, and the other ports are SqlSatellite. OK, so four connections are made up front, what about sending data to the SqlSatellite?  Change the filter, instead of “TCP Connect”, to filter on “TCP Receive”, e.g. what the SqlSatellite(s) receives. Execute the code in <em>Code Snippet 5</em> again and see what <em>Process Monitor</em> outputs:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptIII_procmon2.png" alt="" /></p>

<p><strong>Figure 7:</strong> <em>Multiple Setup Packets</em></p>

<p>Wow, that was many events! In <em>Figure 7</em> we see the 12 first packets and how they sit in 4 groups for 4 distinct port numbers. The packets we see are the packets we discussed in quite a few posts, Internals <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">X</a>, <a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">XI</a> and <a href="/2017/10/31/microsoft-sql-server-r-services-internals-xii/">XII</a> amongst them, and the packets are the authentication packets SQL Server sends to the SqlSatellite and the packet containing the external script. So it looks like 4 SqlSatellites receives the same setup and script packets. When we scroll further down in the output we see how SQL Server sends input-data packets to the SqlSatellites:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptIII_procmon3.png" alt="" /></p>

<p><strong>Figure 8:</strong> <em>Input Data Packets</em></p>

<p><em>Figure 8</em> shows data packets sent from SQL Server (port 52245) to SqlSatellites and ports 55124 and 55126. If we browse through the whole output, we can see how SQL Server sends data to all four ports we see in <em>Figure 7</em>. When SQL Server sends the input-data packets, each SqlSatellite receives different data.</p>

<p>For data that comes back to SQL Server, the flow is the same; each SqlSatellite sends back “its” own data, and the figure below illustrates the full flow:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptIII_multi_process.png" alt="" /></p>

<p><strong>Figure 9:</strong> <em>Complete Flow</em></p>

<p><em>Figure 9</em> tries to illustrate executing external script in parallel, and the numbers in the figure are the same as for <em>Figure 3</em>:</p>

<ol>
  <li>We call <code class="highlighter-rouge">sp_execute_external_script</code> and SQL Server calls into the launchpad service.</li>
  <li>The launchpad service creates RTerm processes which in turn creates BxlServer processes. Based on <code class="highlighter-rouge">MAXDOP</code>, multiple executing processes “spin up”.</li>
  <li>TCP connections from the SqlSatellite in the executing processes get established.</li>
  <li>SQL server sends input data to the SqlSatellites.</li>
  <li>The <code class="highlighter-rouge">BxlServer.exe</code> processes the data.</li>
  <li>SQL Server receives data back from the individual SqlSatellite.</li>
</ol>

<p>So to answer the question about if there is a coordinator somewhere; SQL Server is the coordinator, and SQL Server sends data to the various SqlSatellites and the hosting BxlServer processes. It is important to note how the SqlSatellite and BxlServer processes, processes the data independently, which means that you do not want to do parallel execution through <code class="highlighter-rouge">@parallel = 1</code> if your data has dependencies between different rows, like creating models. Later in this post we cover how you can execute in parallel even if you have dependencies between rows.</p>

<p>A final word about parallel execution via <code class="highlighter-rouge">@parallel</code>: the requirement for parallel execution is that SQL Server can create a parallel execution plan of the input query. If SQL Server can do that, you get parallel execution. This also means that you can use CRANR functions instead of RevoScaleR functions, so in <em>Code Snippet 5</em> we can replace <code class="highlighter-rouge">rxPredict</code> with CRANR <code class="highlighter-rouge">predict</code>.</p>

<h4 id="r_rowsperread"><code class="highlighter-rouge">@r_rowsPerRead</code></h4>

<p>Sometimes you are in a situation where you need to process more data than fits into memory, and this can especially be true when you use CRANR functions which are not optimised to handle large datasets. That is where streaming of data comes in handy and the <code class="highlighter-rouge">@r_rowsPerRead</code> parameter. The <code class="highlighter-rouge">@r_rowsPerRead</code> parameter is not part of the signature of <code class="highlighter-rouge">sp_execute_external_script</code>, but it is still a valid parameter. It allows you to control the number of rows passed during streaming, by specifying an integer value for the parameter and adding the parameter to the <code class="highlighter-rouge">@params</code> collection:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">model</span> <span class="n">varbinary</span><span class="p">(</span><span class="k">max</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">ModelBin</span>
                                 <span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Model</span> 
                                 <span class="k">WHERE</span> <span class="n">ModelName</span> <span class="o">=</span> <span class="s1">'GLM_75Pct'</span><span class="p">);</span>  
  <span class="k">EXEC</span> <span class="n">sp_execute_external_script</span> <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>  
     <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'  
       mod &lt;- unserialize(model); 

       cat(paste0("R Process ID = ", Sys.getpid()))
       cat("</span><span class="se">\n</span><span class="s1">")
       cat(paste0("Nmbr rows = ", nrow(InputDataSet)))
       cat("</span><span class="se">\n</span><span class="s1">")
       cat("----------------")
       cat("</span><span class="se">\n</span><span class="s1">")

        OutputDataSet &lt;- data.frame(predict(mod, 
                                  newdata = InputDataSet, 
                                  type = "response"))'</span><span class="p">,</span>  
  <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">' SELECT TOP(1000) y, rand1, rand2, rand3, 
                      rand4, rand5 
              FROM dbo.tb_Rand_3M'</span><span class="p">,</span>  
  <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@model varbinary(max), @r_rowsPerRead int'</span><span class="p">,</span> 
  <span class="o">@</span><span class="n">model</span> <span class="o">=</span> <span class="o">@</span><span class="n">model</span><span class="p">,</span>
  <span class="o">@</span><span class="n">r_rowsPerRead</span> <span class="o">=</span> <span class="mi">250</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">((</span><span class="n">Y_predict</span> <span class="n">float</span><span class="p">));</span>
</code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>CRANR Rows Per Read</em></p>

<p>The code in <em>Code Snippet 6</em> is similar to <em>Code Snippet 5</em>, however in <em>Code Snippet 6</em> we use the CRANR <code class="highlighter-rouge">predict</code> function, and we also stream the data by defining the <code class="highlighter-rouge">@r_rowsPerRead</code> parameter and setting it to 250. The output after we execute the code looks like so:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptIII_ssms3.png" alt="" /></p>

<p><strong>Figure 10:</strong> <em>Streaming Data</em></p>

<p>The output from <em>SSMS</em>, which we see in <em>Figure 10</em>, shows how 250 rows have been processed four times by the same process id. What about streaming and parallel processing? Sure, that works as well, but I do not cover it in this post. OK, so how does the streaming work then, does SQL Server send batches of data to the SqlSatellite(s) as we saw when we executed in parallel? Let us try to find out, and we start with changing the code a little bit to make it simpler:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span> <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>  
     <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'  
      
       cat(paste0("R Process ID = ", Sys.getpid()))
       cat("</span><span class="se">\n</span><span class="s1">")
       cat(paste0("Nmbr rows = ", nrow(InputDataSet)))
       cat("</span><span class="se">\n</span><span class="s1">")
       cat("----------------")
       cat("</span><span class="se">\n</span><span class="s1">")

        OutputDataSet &lt;- InputDataSet'</span><span class="p">,</span>  
  <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">' SELECT TOP(100) y, rand1, rand2, rand3, 
                      rand4, rand5 
              FROM dbo.tb_Rand_3M'</span><span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 7:</strong> <em>Simplified Code - No Streaming</em></p>

<p>As you see in <em>Code Snippet 7</em> we no longer use a model, and we have also “scrapped” <code class="highlighter-rouge">@r_rowsPerRead</code>. In essence, the code looks like most of the code used throughout this series. When we use <em>Process Monitor</em> with the same filter as above, the output looks like this when we execute the code in <em>Code Snippet 7</em>:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptIII_procmon4.png" alt="" /></p>

<p><strong>Figure 11:</strong> <em>Simple Output</em></p>

<p>Look at the highlighted rows in <em>Figure 11</em>:</p>

<ul>
  <li>Yellow, length of 762 - this is the packet with the script.</li>
  <li>Green, length of 2592 - the input data (the 100 rows).</li>
  <li>Blue, length of 28 - end of the script.</li>
  <li>Red, length of 28 - end of the resultset.</li>
</ul>

<p>Compare what you see above with the output for code like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span> <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span><span class="p">,</span>  
     <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'  
       Sys.sleep(10)
       cat(paste0("R Process ID = ", Sys.getpid()))
       cat("</span><span class="se">\n</span><span class="s1">")
       cat(paste0("Nmbr rows = ", nrow(InputDataSet)))
       cat("</span><span class="se">\n</span><span class="s1">")
       cat("----------------")
       cat("</span><span class="se">\n</span><span class="s1">")

        OutputDataSet &lt;- InputDataSet'</span><span class="p">,</span>  
  <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">' SELECT TOP(100) y, rand1, rand2, rand3, 
                      rand4, rand5 
              FROM dbo.tb_Rand_3M'</span><span class="p">,</span>
  <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@r_rowsPerRead int'</span><span class="p">,</span>
  <span class="o">@</span><span class="n">r_rowsPerRead</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 8:</strong> <em>Simplified Code - No Streaming</em></p>

<p>In <em>Code Snippet 8</em> we add the <code class="highlighter-rouge">@r_rowsPerRead</code> parameter, and we set it to 25: stream 25 rows at a time. You see how we also have a <code class="highlighter-rouge">Sys.sleep(10)</code> in the script. That is to make what happens more transparent. Execute the code and watch the output from <em>Process Monitor</em>:</p>

<p><img src="/images/posts/sql_r_services_ext_scriptIII_procmon5.png" alt="" /></p>

<p><strong>Figure 12:</strong> <em>Streaming Output</em></p>

<p>Oh, that is interesting! In <em>Figure 12</em> we now see how the three first highlighted packets are the same as in <em>Figure 11</em>, highlighted in yellow, green and blue. The only slight difference is the script packet, where the packet in <em>Figure 12</em> is somewhat bigger. The reason for the packet being bigger in <em>Figure 12</em>  is that the <code class="highlighter-rouge">@r_rowsPerRead</code> parameter is part of the script packet. What we see makes it clear that SQL Server sends the whole resultset packet (green) to the SqlSatellite in one go, and the streaming is not because of batching from SQL Server. The streaming is due to SqlSatellite receiving an end of resultset packet (red), and when it receives the packet, it streams in the number of rows as per the <code class="highlighter-rouge">@r_rowsPerRead</code> parameter.</p>

<h2 id="sql-server-compute-context-and-parallel-processing">SQL Server Compute Context and Parallel Processing</h2>

<p><strong>UPDATE:</strong> Originally I covered the SQL Server Compute Context in this post. However, it turns out that; how I thought things worked was not necessarily true, so I wrote the post <a href="/2018/05/20/sp-execute-external-script-and-sql-compute-context/">sp_execute_external_script and SQL Compute Context - I</a>, to try and correct my mistakes. So if you are interested in how the SQL Server compute context works from <code class="highlighter-rouge">sp_execute_external_script</code> go over and have a <a href="/2018/05/20/sp-execute-external-script-and-sql-compute-context/">look</a>.</p>

<h2 id="summary">Summary</h2>

<p>In this, the last post in the <strong>[Microsoft SQL Server R Services</strong> series we discussed:</p>

<ul>
  <li>Parallel processing via the <code class="highlighter-rouge">@parallel</code> parameter.</li>
  <li>Streaming of data using <code class="highlighter-rouge">@r_rowsPerRead.</code></li>
  <li>SQL Server compute-context.</li>
</ul>

<h4 id="parallel-1"><code class="highlighter-rouge">@parallel</code></h4>

<ul>
  <li>By setting the <code class="highlighter-rouge">@parallel</code> parameter to 1, you can get parallel processing if the query SQL Server sends to the SqlSatellite can be parallelised.</li>
  <li>The parallelism you get is “trivial” parallelism; each task processes and returns the data individually.</li>
  <li>Useful if there are no dependencies between rows.</li>
  <li>Can be used with CRANR functions.</li>
</ul>

<h4 id="r_rowsperread-1"><code class="highlighter-rouge">@r_rowsPerRead</code></h4>

<ul>
  <li><code class="highlighter-rouge">@r_rowsPerRead</code> allow you to stream data from SQL Server to the SqlSatellite(s).</li>
  <li>All data is pushed from SQL Server in one go, but the SqlSatellite(s) reads the data per the value of the parameter.</li>
  <li><code class="highlighter-rouge">@r_rowsPerRead</code> can be used in conjunction with <code class="highlighter-rouge">@parallel</code>.</li>
</ul>

<h4 id="compute-context">Compute Context</h4>

<p>The post <a href="/2018/05/20/sp-execute-external-script-and-sql-compute-context/">sp_execute_external_script and SQL Compute Context - I</a> covers SQL Server Compute Context.</p>

<h2 id="-finally">~ Finally</h2>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me. As mentioned, this is the last post in this series: I have had a lot of fun writing this and I have learned a lot. Hope you - my readers - have enjoyed it as well!</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/&text=Microsoft SQL Server R Services - sp_execute_external_script - III&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/
         &title=Microsoft SQL Server R Services - sp_execute_external_script - III
         &summary=Blog post: A lowdown of sp_execute_external_script and the @parallel and @r_rowsPerRead parameters, the SQL Server compute context, using Process Monitor and Process Explorer
         &source=http://www.nielsberglund.com/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-machine-learning-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Machine Learning Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#launchpad">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Launchpad</span>
    </a>
  
    
    <a href="/tags/#process-monitor">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Process Monitor</span>
    </a>
  
    
    <a href="/tags/#sqlsatellite">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SqlSatellite</span>
    </a>
  
    
    <a href="/tags/#process-explorer">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Process Explorer</span>
    </a>
  
    
    <a href="/tags/#parallel">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">parallel</span>
    </a>
  
    
    <a href="/tags/#sql-server-compute-context">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server compute context</span>
    </a>
  
    
    <a href="/tags/#sp-execute-external-script">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">sp_execute_external_script</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/12/interesting-stuff-week-32/">
            Interesting Stuff - Week 32
            <small>12 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
