<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      SQL Server Machine Learning Services and Extended Events &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">SQL Server Machine Learning Services and Extended Events</h1>
  <div class="post-subheading">
  <span class="post-date">08 Apr 2018</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>Back in the day when I started with the <strong>SQL Server R Services - Internals</strong> posts, I thought I would use <a href="https://technet.microsoft.com/en-us/library/bb630354(v=sql.105).aspx">SQL Server Extended Events</a> (XEvents) to figure things out. I knew SQL Server and the extensibility architecture supported XEvents because I had come across <a href="https://docs.microsoft.com/en-us/sql/advanced-analytics/r/extended-events-for-sql-server-r-services">this</a> documentation, where it (amongst other things) said:</p>

<p>“<em>SQL Server provides a set of extended events to use in troubleshooting operations related to the SQL Server Trusted Launchpad, as well as Python or R jobs sent to SQL Server.</em>”</p>

<p>From the above, it is pretty clear that XEvents is the way to go when drilling down into how things “hang together”. However, how hard I tried, I could not make “head or tails” of how to get things to work (I should probably have tried harder), so in the end, I went the <strong>WinDbg</strong> and <strong>WireShark</strong> route.</p>

<p>Fast forward a year (and a bit) and someone asked a question on an internal forum about XEvents and <strong>SQL Server Machine Learning Services</strong>, and I decided to look into it and to try to understand it a bit better. So this post is the result of me <del>playing around with</del> researching XEvents and SQL Server Machine Learning Services.</p>

<!--more-->

<h2 id="extended-events">Extended Events</h2>

<p>Let us first look quickly at what Extended Events are.</p>

<blockquote>
  <p><strong>NOTE:</strong> Please feel free to skip this part if you know about XEvents already.</p>
</blockquote>

<p>Once upon a time, the only way for DBA’s, developers, and others to identify problems with performance, deadlocks and so forth was to use SQL Trace and SQL Server Profiler together with DBCC and various trace flags. When SQL Server 2005 came along, it expanded upon the diagnostic capabilities with the introduction of Dynamic Management Views (DMV’s). However, the diagnostic tools were still intrusive, and you would not want to keep a SQL Trace or SQL Profiler running for an extended period.</p>

<p>So, in SQL Server 2008 Microsoft introduced Extended Events, which is a general event-handling system for server systems. The Extended Events infrastructure supports the correlation of data from SQL Server, and under certain conditions, the correlation of data from the operating system and database applications. Compared to SQL Profiles and SQL Trace XEvents are less intrusive with minimal negative impact (if any) on performance. Some of the essential concepts/objects are:</p>

<ul>
  <li>Package</li>
  <li>Event</li>
  <li>Action</li>
  <li>Target</li>
  <li>Event Session</li>
</ul>

<blockquote>
  <p><strong>NOTE:</strong> The list above of concepts/objects are by no means complete. For example, I do not mention Predicates. The list and following explanations are just meant to give a quick, high-level overview of Extended Events.</p>
</blockquote>

<p>Let us look at the concepts/objects:</p>

<h4 id="package">Package</h4>

<p>SQL Server Extended Events consists of different type of objects and the <strong>Package</strong> is the “top level” container for these objects. A <em>Package</em> is registered in the XEvents engine by a binary <strong>Win32</strong> module, and the package exposes objects/functionality related to that module. The following code lists the packages and their respective modules:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">xp</span><span class="p">.</span><span class="n">name</span> <span class="n">PackageName</span><span class="p">,</span> <span class="n">xp</span><span class="p">.</span><span class="n">Description</span> <span class="n">PackageDesc</span><span class="p">,</span> 
       <span class="n">lm</span><span class="p">.</span><span class="n">name</span> <span class="n">ModuleName</span><span class="p">,</span> <span class="n">lm</span><span class="p">.</span><span class="n">description</span> <span class="n">ModuleDesc</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_xe_packages</span> <span class="n">xp</span>
<span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_os_loaded_modules</span> <span class="n">lm</span>
  <span class="k">ON</span> <span class="n">xp</span><span class="p">.</span><span class="n">module_address</span> <span class="o">=</span> <span class="n">lm</span><span class="p">.</span><span class="n">base_address</span>
</code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Packages and Modules</em></p>

<p>When you execute the code in <em>Code Snippet 1</em>, you see how there is a one to many relationships between modules and packages, and how all modules are SQL Server dll’s. When you work with XEvents you use objects from one or more packages, and objects from different packages can be mixed in an event session (we talk more about event sessions in a bit).</p>

<h4 id="event">Event</h4>

<p>The Event is the “thing” you want to monitor, and it is some point of interest that may or may not happen when executing an application. When the event fires - if it fires - it carries with it the payload (data) related to the occurrence of that point of interest. Execute following code to see all different events:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">xo</span><span class="p">.</span><span class="n">name</span> <span class="n">EventName</span><span class="p">,</span> <span class="n">xo</span><span class="p">.</span><span class="n">description</span> <span class="n">EventDesc</span><span class="p">,</span> 
       <span class="n">xp</span><span class="p">.</span><span class="n">name</span> <span class="n">PackageName</span> 
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_xe_objects</span> <span class="n">xo</span>
<span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_xe_packages</span> <span class="n">xp</span>
  <span class="k">ON</span> <span class="n">xo</span><span class="p">.</span><span class="n">package_guid</span> <span class="o">=</span> <span class="n">xp</span><span class="p">.</span><span class="n">guid</span>
<span class="k">WHERE</span> <span class="n">object_type</span> <span class="o">=</span> <span class="s1">'event'</span>  
</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Events and Packages</em></p>

<p>As you can see, there are quite a few events, and they cover a variety of things. The payload of the Event differs obviously between various events, but you can see the individual data elements in the payload for an Event via  <code class="highlighter-rouge">sys.dm_xe_object_columns</code>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">oc</span><span class="p">.</span><span class="n">name</span> <span class="n">ColumnName</span><span class="p">,</span> <span class="n">oc</span><span class="p">.</span><span class="n">column_id</span><span class="p">,</span>
       <span class="n">oc</span><span class="p">.</span><span class="n">object_name</span> <span class="n">Event</span> 
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_xe_object_columns</span> <span class="n">oc</span>
<span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_xe_objects</span> <span class="n">xo</span>
  <span class="k">ON</span> <span class="n">oc</span><span class="p">.</span><span class="n">object_name</span> <span class="o">=</span> <span class="n">xo</span><span class="p">.</span><span class="n">name</span>
<span class="k">WHERE</span> <span class="n">xo</span><span class="p">.</span><span class="n">object_type</span> <span class="o">=</span> <span class="s1">'event'</span>
  <span class="k">AND</span> <span class="n">oc</span><span class="p">.</span><span class="n">object_name</span> <span class="o">=</span> <span class="s1">'sql_statement_completed'</span>
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Retrieve Payload Columns for an Event</em></p>

<p>In <em>Code Snippet 3</em> we see how we select the individual data elements for the Event <code class="highlighter-rouge">sql_statement_completed</code>. So, the information returned in the payload is what you see in <code class="highlighter-rouge">sys.dm_xe_object_columns</code>. However, if you want more information you can achieve that by using Actions.</p>

<h4 id="actions">Actions</h4>

<p>We can think of an Action as an internal function bound to the Event, and it performs a specified task when the Event fires. There are two types of tasks the Action does; either collecting additional information and add it to the Event payload or do something inside the engine, like performing a memory dump, or breaking execution in the default debugger. Run following code to see what actions are available:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">xo</span><span class="p">.</span><span class="n">name</span> <span class="p">[</span><span class="n">Action</span><span class="p">],</span> <span class="n">xo</span><span class="p">.</span><span class="n">description</span> <span class="n">ActionDesc</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_xe_objects</span> <span class="n">xo</span>
<span class="k">WHERE</span> <span class="n">object_type</span> <span class="o">=</span> <span class="s1">'action'</span>
</code></pre></div></div>
<p><strong>Code Snippet 4:</strong> <em>Get Actions</em></p>

<p>We have seen see that for both events as well as actions, we can collect information. What do we now do with this information?</p>

<h4 id="targets">Targets</h4>

<p>The Target is what consumes an Event, and the Target can write to a file, aggregate event data, or start a task that is related to the event. The Target processes the data either synchronously or asynchronously. The code below lists what targets there are:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">xo</span><span class="p">.</span><span class="n">name</span> <span class="p">[</span><span class="n">Target</span><span class="p">],</span> <span class="n">xo</span><span class="p">.</span><span class="n">description</span> <span class="n">TargetDesc</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_xe_objects</span> <span class="n">xo</span>
<span class="k">WHERE</span> <span class="n">object_type</span> <span class="o">=</span> <span class="s1">'target'</span>
</code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>Available XEvents Targets</em></p>

<p>When you run the code in <em>Code Snippet 5</em> you see how a Target is either a file target, like the event file target and the ETW target, or an in-memory target, like event bucketing, event pairing, ring buffer target and so forth. Shortly we see how we use a Target (as well as events and actions).</p>

<h4 id="event-session">Event Session</h4>

<p>The Event Session is what ties Events, Actions, Targets and all the other XEVents objects together. In essence, an Event Session is a collection of events, corresponding actions, and the targets that are the destinations for the events we collect.</p>

<p>When you create an Event Session, it exists in the Extended Events Engine until you drop the Event Session. The Event Session can be started and stopped as needed without having to recreate the session. The flow of creating an Event Session is as follows:</p>

<ul>
  <li>You first create the Event Session.</li>
  <li>You add Events. Each Event can have additional Actions.</li>
  <li>You add one or more Targets.</li>
  <li>You start the Event Session.</li>
</ul>

<h4 id="example-code">Example Code</h4>

<p>With all the above in mind, let us see what it can look like when creating an Extended Event session:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IF</span> <span class="k">EXISTS</span><span class="p">(</span><span class="k">SELECT</span> <span class="mi">1</span> 
          <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_event_sessions</span> 
          <span class="k">WHERE</span> <span class="n">name</span><span class="o">=</span><span class="s1">'SimpleTest'</span><span class="p">)</span>
<span class="k">BEGIN</span>
  <span class="k">DROP</span> <span class="n">EVENT</span> <span class="k">SESSION</span> <span class="n">SimpleTest</span> <span class="k">ON</span> <span class="n">SERVER</span><span class="p">;</span>
<span class="k">END</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="n">EVENT</span> <span class="k">SESSION</span> <span class="n">SimpleTest</span> <span class="k">ON</span> <span class="n">SERVER</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">sqlserver</span><span class="p">.</span><span class="n">sql_statement_completed</span>
  <span class="k">ADD</span> <span class="n">TARGET</span> <span class="n">package0</span><span class="p">.</span><span class="n">ring_buffer</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">ALTER</span> <span class="n">EVENT</span> <span class="k">SESSION</span> <span class="n">SimpleTest</span>
<span class="k">ON</span> <span class="n">SERVER</span> <span class="k">STATE</span> <span class="o">=</span> <span class="k">START</span> 
<span class="k">GO</span> 
</code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>Create Event Session</em></p>

<p>In <em>Code Snippet 6</em> we see how we:</p>

<ul>
  <li>First check whether the Event Session already exists, and if so - we drop it.</li>
  <li>Create the Event Session through the <code class="highlighter-rouge">CREATE EVENT SESSION session_name ON SERVER</code> syntax.</li>
  <li>Add the Event(s) we are interested in: <code class="highlighter-rouge">ADD EVENT package_name.event_name</code>.</li>
  <li>Add the Target(s): <code class="highlighter-rouge">ADD TARGET package_name.target_name</code>.</li>
  <li>Start the session.</li>
</ul>

<p>You see in <em>Code Snippet 6</em> how we reference the package name for the Event as well as Target, and how the package for the target is <code class="highlighter-rouge">package0</code>. You may wonder what <code class="highlighter-rouge">package0</code> is: it is the default package in XEvents, and it contains (among other things) all actions and targets.</p>

<p>As the Event Session is now running, let us see what happens if we execute a SQL statement, for example: <code class="highlighter-rouge">SELECT * FROM sys.databases</code>. When we execute the statement, nothing visible happens, but hopefully, our Target has consumed some event information. The Target for our Event Session is the ring buffer, and to read data from the ring buffer we use code looking like so:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">CAST</span><span class="p">(</span><span class="n">stargets</span><span class="p">.</span><span class="n">target_data</span> <span class="k">AS</span> <span class="n">XML</span><span class="p">)</span> <span class="k">AS</span> <span class="n">targetdata</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_xe_session_targets</span> <span class="n">stargets</span> 
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_xe_sessions</span> <span class="n">sessions</span> 
<span class="k">ON</span> <span class="n">sessions</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">stargets</span><span class="p">.</span><span class="n">event_session_address</span> 
<span class="k">WHERE</span> <span class="n">sessions</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'SimpleTest'</span> 
  <span class="k">AND</span> <span class="n">stargets</span><span class="p">.</span><span class="n">target_name</span> <span class="o">=</span> <span class="s1">'ring_buffer'</span><span class="p">;</span>
</code></pre></div></div>
<p><strong>Code Snippet 7:</strong> <em>Reading Event Data from the Ring Buffer</em></p>

<p>When you execute the code in <em>Code Snippet 7</em>, the output is in XML format, and the XML you see below is heavily edited for display:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;event</span> <span class="na">name=</span><span class="s">"sql_statement_completed"</span> <span class="na">package=</span><span class="s">"sqlserver"</span> <span class="na">timestamp=</span><span class="s">"2018-03-30T17:35:16.226Z"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">name=</span><span class="s">"duration"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;type</span> <span class="na">name=</span><span class="s">"int64"</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;value&gt;</span>2115<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/data&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">name=</span><span class="s">"cpu_time"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;type</span> <span class="na">name=</span><span class="s">"uint64"</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;value&gt;</span>0<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/data&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">name=</span><span class="s">"physical_reads"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;type</span> <span class="na">name=</span><span class="s">"uint64"</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;value&gt;</span>0<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/data&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">name=</span><span class="s">"logical_reads"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;type</span> <span class="na">name=</span><span class="s">"uint64"</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;value&gt;</span>266<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/data&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">name=</span><span class="s">"writes"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;type</span> <span class="na">name=</span><span class="s">"uint64"</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;value&gt;</span>0<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/data&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">name=</span><span class="s">"row_count"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;type</span> <span class="na">name=</span><span class="s">"uint64"</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;value&gt;</span>10<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/data&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">name=</span><span class="s">"last_row_count"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;type</span> <span class="na">name=</span><span class="s">"uint64"</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;value&gt;</span>10<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/data&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">name=</span><span class="s">"line_number"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;type</span> <span class="na">name=</span><span class="s">"int32"</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;value&gt;</span>2<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/data&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">name=</span><span class="s">"offset"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;type</span> <span class="na">name=</span><span class="s">"int32"</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;value&gt;</span>4<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/data&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">name=</span><span class="s">"offset_end"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;type</span> <span class="na">name=</span><span class="s">"int32"</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;value&gt;</span>56<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/data&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">name=</span><span class="s">"statement"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;type</span> <span class="na">name=</span><span class="s">"unicode_string"</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;value&gt;</span>SELECT * FROM sys.databases<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/data&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">name=</span><span class="s">"parameterized_plan_handle"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;type</span> <span class="na">name=</span><span class="s">"binary_data"</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;value</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/data&gt;</span>
  <span class="nt">&lt;/event&gt;</span>
</code></pre></div></div>
<p><strong>Code Snippet 8:</strong> <em>Event Information for sql_statement_completed</em></p>

<p>Notice in <em>Code Snippet 8</em> how we can see the row count (<code class="highlighter-rouge">&lt;data name="row_count"&gt;</code>) and also the SQL statement which caused the event to fire (<code class="highlighter-rouge">&lt;data name="statement"&gt;</code>).</p>

<blockquote>
  <p><strong>NOTE:</strong> You can also use the UI in <strong>SQL Server Management Studio</strong> (SSMS) to set up Event Sessions.</p>
</blockquote>

<h4 id="event-file-target">Event File Target</h4>

<p>Using the ringbuffer as target fort the events is OK, and it is a “quick and dirty” way to get things underway. However, it can be somewhat cumbersome to read the data as it is in XML format and there is no UI support for it and so forth. Therefore, in the rest of this post the <code class="highlighter-rouge">event_file</code> target is the target of choice for us, instead of the ringbuffer.</p>

<blockquote>
  <p><strong>NOTE:</strong> Read this <a href="https://www.sqlskills.com/blogs/jonathan/why-i-hate-the-ring_buffer-target-in-extended-events/">blog-post</a> by, “Mr Extended Events”, <a href="https://www.sqlskills.com/about/jonathan-kehayias/">Jonathan Kehayias</a> for more information about why not to use the ringbuffer.</p>
</blockquote>

<p>Just to see the <code class="highlighter-rouge">event_file</code> target in action:</p>

<ul>
  <li>Create a new directory on the SQL Server box, and give it necessary permissions so that various processes can write to the directory (on my machine I created <code class="highlighter-rouge">C:\ExtLogs</code>).</li>
  <li>Alter the <code class="highlighter-rouge">SimpleTest</code> session like so:</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="n">EVENT</span> <span class="k">SESSION</span> <span class="n">SimpleTest</span> <span class="k">ON</span> <span class="n">SERVER</span>
  <span class="k">DROP</span> <span class="n">TARGET</span> <span class="n">package0</span><span class="p">.</span><span class="n">ring_buffer</span>

<span class="k">ALTER</span> <span class="n">EVENT</span> <span class="k">SESSION</span> <span class="n">SimpleTest</span> <span class="k">ON</span> <span class="n">SERVER</span>
  <span class="k">ADD</span> <span class="n">TARGET</span> <span class="n">package0</span><span class="p">.</span><span class="n">event_file</span>
             <span class="p">(</span>
               <span class="k">SET</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">'C:</span><span class="se">\E</span><span class="s1">xtLogs</span><span class="se">\S</span><span class="s1">impleTest.xel'</span><span class="p">,</span>
               <span class="n">max_file_size</span> <span class="o">=</span> <span class="mi">5</span>
             <span class="p">);</span>
<span class="k">GO</span>
</code></pre></div></div>
<p><strong>Code Snippet 9:</strong> <em>Alter Session to Use Event File Target</em></p>

<p>In the code in <em>Code Snippet 9</em> we see how we first drop the original <code class="highlighter-rouge">ring_buffer</code> target and then add the <code class="highlighter-rouge">event_file</code> target.</p>

<blockquote>
  <p><strong>NOTE:</strong> The assumption in the code in <em>Code Snippet 9</em> is that the event session exists and is in the <code class="highlighter-rouge">START</code> <code class="highlighter-rouge">STATE</code>. Oh - and it is not necessary to <code class="highlighter-rouge">DROP</code> the <code class="highlighter-rouge">ring_buffer</code> target as we can have more than one target in a session.</p>
</blockquote>

<p>To see this in action:</p>

<ul>
  <li>Execute the code we used before: <code class="highlighter-rouge">SELECT * FROM sys.databases</code>.</li>
  <li>If everything works, you now see in your directory, a file named something like so: <code class="highlighter-rouge">SimpleTest_0_some_long_number.xel</code></li>
  <li>Drag and drop the file into SSMS and you see something like so:</li>
</ul>

<p><img src="/images/posts/sql_ml_services_xevents_ssms_event_file.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Output Event File</em></p>

<p>In <em>Figure 1</em> you see the top part of what is on the SSMS canvas and what you see are the individual events that fired. When you click on one of the events you see the details as so:</p>

<p><img src="/images/posts/sql_ml_services_xevents_ssms_event_file_details.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>Event Details</em></p>

<p>In <em>Figure 2</em>, in the <code class="highlighter-rouge">Details</code> pane, we see the individual <code class="highlighter-rouge">data</code> elements, and their values from the event outlined in red. To me, I very much prefer what I see in <em>Figure 2</em> to what is in <em>Code Snippet 8</em>, especially since the information is the same.</p>

<p>You do not explicitly have to drag and drop the event file to the SSMS canvas, you can use the SSMS UI for this:</p>

<p><img src="/images/posts/sql_ml_services_xevents_ssms_target.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>Event Details</em></p>

<p>When you click on the <em>View Target Data</em> as you see in <em>Figure 3</em>, you get the same as in <em>Figure 1</em> and <em>Figure 2</em>.</p>

<h4 id="more-information">More Information</h4>

<p>As I mentioned above - this is a very simplified overview of XEvents, and I have skipped a lot of relevant information. Below follows a couple of links if you want to read more about SQL Server Extended Events:</p>

<ul>
  <li><a href="https://technet.microsoft.com/en-us/library/bb630282(v=sql.110).aspx">Extended Events</a>. Microsoft Extended Events documentation.</li>
  <li><a href="https://www.sqlskills.com/blogs/jonathan/an-xevent-a-day-31-days-of-extended-events/">An XEvent A Day: 31 days of Extended Events</a>. Blog post series by <a href="https://www.sqlskills.com/about/jonathan-kehayias/">Jonathan Kehayias</a> about Extended Events. Jonathan know what he talks about when it comes to Extended Events, among other things he wrote the <a href="https://msdn.microsoft.com/en-us/library/dd822788.aspx">definitive white-paper</a> on Extended Events for Microsoft.</li>
  <li><a href="https://msdn.microsoft.com/en-us/library/ff878115.aspx">Event File Target</a>. Documentation about the Event File target.</li>
</ul>

<h2 id="xevents-and-sql-server-machine-learning-services">XEvents and SQL Server Machine Learning Services</h2>

<p>At this stage I hope we all have at least some basic knowledge of XEvents, so let us now see how XEvents plays with <strong>SQL Server Machine Learning Services</strong>. When you looked through the results from the code in <em>Code Snippet 1</em> (XEvents packages), you might have noticed this:</p>

<p><img src="/images/posts/sql_ml_services_xevents_1.png" alt="" /></p>

<p><strong>Figure 4:</strong> <em>SqlSatellite Package</em></p>

<p>Starting with SQL Server 2016, there is a new XEvents package: <code class="highlighter-rouge">SQLSatellite</code>, and as there is a new package, the chance is high that there are events exposed through that package as well:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">xo</span><span class="p">.</span><span class="n">name</span> <span class="n">EventName</span><span class="p">,</span> <span class="n">xo</span><span class="p">.</span><span class="n">description</span> <span class="n">EventDesc</span><span class="p">,</span> 
       <span class="n">xp</span><span class="p">.</span><span class="n">name</span> <span class="n">PackageName</span> 
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_xe_objects</span> <span class="n">xo</span>
<span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_xe_packages</span> <span class="n">xp</span>
  <span class="k">ON</span> <span class="n">xo</span><span class="p">.</span><span class="n">package_guid</span> <span class="o">=</span> <span class="n">xp</span><span class="p">.</span><span class="n">guid</span>
<span class="k">WHERE</span> <span class="n">object_type</span> <span class="o">=</span> <span class="s1">'event'</span>
  <span class="k">AND</span> <span class="n">xp</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'SQLSatellite'</span>
</code></pre></div></div>
<p><strong>Code Snippet 10:</strong> <em>Retrieving Events from the SQLSatellite Package</em></p>

<p>When I execute the code in <em>Code Snippet 10</em>, I get 34 rows back:</p>

<p><img src="/images/posts/sql_ml_services_xevents_2.png" alt="" /></p>

<p><strong>Figure 5:</strong> <em>SqlSatellite Events</em></p>

<p>So, <em>Figure 5</em> shows all events from the <code class="highlighter-rouge">SQLSatellite</code> package, and I have outlined in red five events that look interesting. Now, let us create an event session with these five events, and see what happens:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IF</span> <span class="k">EXISTS</span><span class="p">(</span><span class="k">SELECT</span> <span class="mi">1</span> 
          <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_event_sessions</span> 
          <span class="k">WHERE</span> <span class="n">name</span><span class="o">=</span><span class="s1">'SatelliteTest1'</span><span class="p">)</span>
<span class="k">BEGIN</span>
  <span class="k">DROP</span> <span class="n">EVENT</span> <span class="k">SESSION</span> <span class="n">SatelliteTest1</span> <span class="k">ON</span> <span class="n">SERVER</span><span class="p">;</span>
<span class="k">END</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="n">EVENT</span> <span class="k">SESSION</span> <span class="p">[</span><span class="n">SatelliteTest1</span><span class="p">]</span> <span class="k">ON</span> <span class="n">SERVER</span> 
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_authentication_completion</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_authorization_completion</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_cleanup</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">launchpad_launch_start</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">launchpad_resume_sent</span>
  <span class="k">ADD</span> <span class="n">TARGET</span> <span class="n">package0</span><span class="p">.</span><span class="n">event_file</span>
             <span class="p">(</span>
               <span class="k">SET</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">'C:</span><span class="se">\E</span><span class="s1">xtLogs</span><span class="se">\S</span><span class="s1">atelliteTest1.xel'</span><span class="p">,</span>
               <span class="n">max_file_size</span> <span class="o">=</span> <span class="mi">5</span>
             <span class="p">)</span>
<span class="k">WITH</span><span class="p">(</span><span class="n">MAX_DISPATCH_LATENCY</span> <span class="o">=</span> <span class="mi">2</span> <span class="n">SECONDS</span><span class="p">);</span>
<span class="k">GO</span>

<span class="k">ALTER</span> <span class="n">EVENT</span> <span class="k">SESSION</span> <span class="n">SatelliteTest1</span>
<span class="k">ON</span> <span class="n">SERVER</span> <span class="k">STATE</span> <span class="o">=</span> <span class="k">START</span>
<span class="k">GO</span> 
</code></pre></div></div>
<p><strong>Code Snippet 11:</strong> “Event Session for SQLSatellite”</p>

<p>The code in <em>Code Snippet 11</em> looks similar to the code in <em>Code Snippet 9</em>, except for the <code class="highlighter-rouge">WITH(MAX_DISPATCH_LATENCY = 2 SECONDS)</code> event session option. The <code class="highlighter-rouge">MAX_DISPATCH_LATENCY</code> option specifies the amount of time that events sit in memory before being dispatched to event session targets. By default, this value is 30 seconds. In the code above, as you can see, the time in memory is 2 seconds.</p>

<p>Execute the code in <em>Code Snippet 11</em>, and then execute the following:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span> 
              <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
            <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'d &lt;- 42'</span>
</code></pre></div></div>
<p><strong>Code Snippet 12:</strong> <em>External Script</em></p>

<p>When we have executed the code in <em>Code Snippet 12</em>, let us see if some events have fired. Once again, if everything has gone to plan, you now see in your directory, a file named something like so: <code class="highlighter-rouge">SatelliteTest1_0_some_long_number.xel</code>. When you drop it on the SSMS canvas you get this:</p>

<p><img src="/images/posts/sql_ml_services_xevents_ssms_ext_script_1.png" alt="" /></p>

<p><strong>Figure 6:</strong> <em>Captured Events</em></p>

<p>Hmm - Ok, looking at <em>Figure 6</em> I have good news and bad news. The good news is that we captured events from our code execution! The bad news is that we have missing events (<code class="highlighter-rouge">satellite_cleanup</code>, <code class="highlighter-rouge">launchpad_launch_start</code>, <code class="highlighter-rouge">launchpad_resume_sent</code>), and the events we have, look like duplicates (two of both <code class="highlighter-rouge">satellite_authentication_completion</code> and <code class="highlighter-rouge">satellite_authorization_completion</code>). What is happening?</p>

<p>Let us look at the “alleged” duplication issue first. Click on the first <code class="highlighter-rouge">satellite_authentication_completion</code> event and you see this:</p>

<p><img src="/images/posts/sql_ml_services_xevents_ssms_ext_script_2.png" alt="" /></p>

<p><strong>Figure 7:</strong> <em>Event Data</em></p>

<p>In <em>Figure 7</em> you see the <code class="highlighter-rouge">data</code> element of the first <code class="highlighter-rouge">satellite_authentication_completion</code> event, and you see how the <code class="highlighter-rouge">connection_provider</code> is of type <code class="highlighter-rouge">ConnectionProviderNamedpipe</code>. The same <code class="highlighter-rouge">connection_provider</code> type shows for the first <code class="highlighter-rouge">satellite_authorization_completion</code> event as well. However, if you click on either of the second events, the <code class="highlighter-rouge">connection_provider</code> type is no longer <code class="highlighter-rouge">ConnectionProviderNamedpipe</code> but <code class="highlighter-rouge">ConnectionProviderTCP</code>. Ah, so we have two types of connections happening with separate authentication and authorisation events:</p>

<ul>
  <li>Named Pipes</li>
  <li>TCP Sockets</li>
</ul>

<p>That we see two connection types should not come as a surprise to those of you who have read my <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/"><strong>Internals - I</strong></a> and <a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/"><strong>Internals - IX</strong></a> posts in the <strong>Microsoft SQL Server R Services</strong> series. In those two posts we discussed how SQL Server makes a named pipes connection to the Launchpad service, and how there is a TCP socket connection established between the SqlSatellite and SQL Server. So, making authorisation and authentication calls for named pipe and TCP socket connections are why we see “duplicates”.</p>

<p>What about why we do not see the <code class="highlighter-rouge">satellite_cleanup</code>, <code class="highlighter-rouge">launchpad_launch_start</code> and <code class="highlighter-rouge">launchpad_resume_sent</code> events in <em>Figure 3</em>? Well, I did not read the <a href="https://docs.microsoft.com/en-us/sql/advanced-analytics/r/extended-events-for-sql-server-r-services">documentation</a> I linked to above thorough enough because in there it says:</p>

<p><em>Additional extended events are available for components that are related to and used by SQL Server Machine Learning Services, such as the SQL Server Trusted Launchpad, and BXLServer, the satellite process that starts the R runtime. <strong>These additional extended events are fired from the external processes, and thus must be captured using an external utility</strong>.</em></p>

<p>Clear as daylight, huh? Do not expect SQL Server to know when external processes fires events. If you want to capture events from processes outside of SQL Server, you need to do it in some other way, not <code class="highlighter-rouge">EVENT SESSION</code>.</p>

<h2 id="events-from-external-processes">Events from External Processes</h2>

<blockquote>
  <p><strong>NOTE:</strong> Some of the below are copied and re-worded from the <a href="https://docs.microsoft.com/en-us/sql/advanced-analytics/r/extended-events-for-sql-server-r-services">Extended events for SQL Server Machine Learning Services</a> page.</p>
</blockquote>

<p>So how do we then capture events from external processes, or rather - how do we register with an external process to capture events, and also, how do we define the events we want to capture? Oh, and what processes do we talk about here?</p>

<p>We start with the last one first: the processes that interests us are:</p>

<ul>
  <li><code class="highlighter-rouge">Launchpad.exe</code> - called in <code class="highlighter-rouge">sp_execute_external_script</code> and “routes” the request to correct external engine.</li>
  <li><code class="highlighter-rouge">BxlServer.exe</code> - this is the process that hosts the SqlSatellite.</li>
</ul>

<p>To register for events as well as defining the events which interest us, we use a configuration file. This file is the “moral equivalent” of the <code class="highlighter-rouge">CREATE EVENT SESSION</code> statement for SQL Server. What I mean with that is that, in said file, you define pretty much what you do in <code class="highlighter-rouge">CREATE EVENT SESSION</code>. The format of the file (taken from the <a href="https://docs.microsoft.com/en-us/sql/advanced-analytics/r/extended-events-for-sql-server-r-services">link</a> above), looks like this:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;event_sessions&gt;</span>
  <span class="nt">&lt;event_session</span> <span class="na">name=</span><span class="s">"[session name]"</span> 
                 <span class="na">maxMemory=</span><span class="s">"1"</span> 
                 <span class="na">dispatchLatency=</span><span class="s">"1"</span> 
                 <span class="na">MaxDispatchLatency=</span><span class="s">"2 SECONDS"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;description</span> <span class="na">owner=</span><span class="s">"you"</span><span class="nt">&gt;</span>XEvents.<span class="nt">&lt;/description&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> <span class="na">name=</span><span class="s">"[XEvent Name 1]"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> <span class="na">name=</span><span class="s">"[XEvent Name 2]"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;target</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="na">name=</span><span class="s">"event_file"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"filename"</span> <span class="na">value=</span><span class="s">"[SessionName].xel"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"max_file_size"</span> <span class="na">value=</span><span class="s">"10"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"max_rollover_files"</span> <span class="na">value=</span><span class="s">"10"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/target&gt;</span>
  <span class="nt">&lt;/event_session&gt;</span>
<span class="nt">&lt;/event_sessions&gt;</span> 
</code></pre></div></div>
<p><strong>Code Snippet 13:</strong> <em>Configuration File for External Extended Events</em></p>

<p>When looking at <em>Code Snippet 13</em> we see we have a root element <code class="highlighter-rouge">&lt;event_sessions&gt;</code> followed by a child element <code class="highlighter-rouge">&lt;event_session&gt;</code>. With this in mind, we see how one config file can support multiple event sessions. The <code class="highlighter-rouge">&lt;event_session&gt;</code> element is like an amalgamation of <code class="highlighter-rouge">CREATE EVEN SESSION</code> and the <code class="highlighter-rouge">WITH</code> event session options in the T-SQL statement for creating an event session. The <code class="highlighter-rouge">&lt;event_session&gt;</code> element has following attributes:</p>

<ul>
  <li><code class="highlighter-rouge">name</code> - A mandatory attribute. If you do not set the name, “bad things” happen.</li>
  <li><code class="highlighter-rouge">maxMemory</code> - An optional attribute and it is similar to <code class="highlighter-rouge">MAX_MEMORY</code> in SQL Server event session options, and it specifies the maximum amount of memory to allocate to the session for event buffering.</li>
  <li><code class="highlighter-rouge">MaxDispatchLatency</code> - Optional attribute, similar to <code class="highlighter-rouge">MAX_DISPATCH_LATENCY</code> in SQL Server event session options. The attribute has a default of 30 seconds, and it specifies the amount of time that events sit in memory before being dispatched to event session targets.</li>
  <li><code class="highlighter-rouge">dispatchLatency</code> - Optional attribute and this has no equivalent (as far as I can tell) in the SQL Server event session options. However, it is similar to <code class="highlighter-rouge">MaxDispatchLatency</code>, in that the attribute specifies the time (in seconds), events sit in memory before being dispatched to event session targets. If both <code class="highlighter-rouge">MaxDispatchLatency</code> and <code class="highlighter-rouge">dispatchLatency</code> have values, <code class="highlighter-rouge">dispatchLatency</code> takes precedence.</li>
</ul>

<p>The <code class="highlighter-rouge">&lt;description&gt;</code> element is optional, and I do not know what functionality it offers. I can only speculate, but perhaps, some event readers may display the description. Anyway, after the <code class="highlighter-rouge">&lt;description&gt;</code> element comes the actual <code class="highlighter-rouge">&lt;event&gt;</code> element(s), with attributes for <code class="highlighter-rouge">package</code> and <code class="highlighter-rouge">name</code> and this is equivalent of <code class="highlighter-rouge">ADD EVENT package.event</code>.</p>

<p>Finally, after the events, we set up the target in the <code class="highlighter-rouge">&lt;target&gt;</code> element. The only target I have tried with is the <code class="highlighter-rouge">event_file</code>, so keep that in mind. The package for all targets are <code class="highlighter-rouge">package0</code> and the <code class="highlighter-rouge">name</code> is <code class="highlighter-rouge">event_file</code>. The <code class="highlighter-rouge">&lt;target&gt;</code> element have child nodes of <code class="highlighter-rouge">&lt;parameter&gt;</code> nodes. For the <code class="highlighter-rouge">&lt;event_file&gt;</code> target the only required <code class="highlighter-rouge">&lt;parameter&gt;</code> is the <code class="highlighter-rouge">filename</code>.</p>

<p>So, <code class="highlighter-rouge">filename</code> - this is where things are getting interesting: Having seen how we define the file to write to for SQL Server XEvents (<em>Code Snippet 9</em> and <em>Code Snippet 11</em>), you expect it is the same for the external processes. But no, it is different, and it is even different between Launchpad and BxlServer!</p>

<p><strong>Launchpad:</strong></p>

<p>For Launchpad, the filename has to be the actual filename, no path: <code class="highlighter-rouge">&lt;parameter name="filename" value="launchpadTest.xel" /&gt;</code> for example. Launchpad then writes the event file to the path that the <code class="highlighter-rouge">-logFile</code> parameter sets at startup. Default location is <code class="highlighter-rouge">C:\\&lt;path_to_SQL_instance\&gt;\MSSQL\LOG\ExtensibilityLog</code>.</p>

<blockquote>
  <p><strong>NOTE:</strong> You can read more about startup parameters for the Launchpad service in <a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/"><strong>Internals - II</strong></a>.</p>
</blockquote>

<p><strong>BxlServer:</strong></p>

<p>You would expect that Launchpad and BxlServer would be similar in how they handle the file name, but as I wrote above they are not. BxlServer requires you to define the file as a relative path to where the <code class="highlighter-rouge">BxlServer.exe</code> is, and the BxlServer process needs write permissions on the directory where it writes the file to. So if I want the BxlServer to write the file to the directory I created above, the directory where SQL Server writes the events to, the parameter looks like so: <code class="highlighter-rouge">&lt;parameter name="filename" value="..\..\..\..\..\..\..\..\..\..\ExtLogs\bxlserver1.xel" /&gt;</code>.</p>

<blockquote>
  <p><strong>NOTE:</strong> I know the above purely due to <a href="https://www.linkedin.com/in/umachandarjayachandran/">Umachandar Jayachandran</a> (Program Manager in the SQL Server team) told me about it - so no great insight from me.</p>
</blockquote>

<p>The two remaining <code class="highlighter-rouge">&lt;parameter&gt;</code> nodes: <code class="highlighter-rouge">max_file_size</code> and <code class="highlighter-rouge">max_rollover_files</code> are both optional and you can read more about them in the <a href="https://msdn.microsoft.com/en-us/library/ff878115.aspx">Event File Target</a> documentation.</p>

<p>The final thing to cover before a couple of examples is where to place the configuration files and what to name them. You name the files<code class="highlighter-rouge">process_name.xevents.xml</code> ( <code class="highlighter-rouge">Launchpad.xevents.xml</code>, <code class="highlighter-rouge">bxlserver.xevents.xml</code>) and you place them together with the executables for the processes (remember that <code class="highlighter-rouge">BxlSever.exe</code> is in two locations, one for R and one for Python):</p>

<ul>
  <li>Launchpad - <code class="highlighter-rouge">C:\\&lt;path_to_SQL_instance\&gt;\MSSQL\Binn</code></li>
  <li>BxlServer R - <code class="highlighter-rouge">C:\\&lt;path_to_SQL_instance\&gt;\R_SERVICES\library\RevoScaleR\rxLibs\x64</code></li>
  <li>BxlServer Python - <code class="highlighter-rouge">C:\\&lt;path_to_SQL_instance\&gt;\PYTHON_SERVICES\Lib\site-packages\revoscalepy\rxLibs</code></li>
</ul>

<h4 id="example">Example</h4>

<p>Having covered the basics of SQL Server extended events for external processes, let us see an example of what it can look like with SQL Server, Launchpad and BxlServer. So the assumption for this example is that we want to understand what happens when we send and receive data to and from the external engine.</p>

<p>The first thing we do is to set up a SQL Server event session. We expand and alter the code in <em>Code Snippet 11</em> slightly:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IF</span> <span class="k">EXISTS</span><span class="p">(</span><span class="k">SELECT</span> <span class="mi">1</span> 
          <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_event_sessions</span> 
          <span class="k">WHERE</span> <span class="n">name</span><span class="o">=</span><span class="s1">'SatelliteTest1'</span><span class="p">)</span>
<span class="k">BEGIN</span>
  <span class="k">DROP</span> <span class="n">EVENT</span> <span class="k">SESSION</span> <span class="n">SatelliteTest1</span> <span class="k">ON</span> <span class="n">SERVER</span><span class="p">;</span>
<span class="k">END</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="n">EVENT</span> <span class="k">SESSION</span> <span class="p">[</span><span class="n">SatelliteTest1</span><span class="p">]</span> <span class="k">ON</span> <span class="n">SERVER</span> 
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_authentication_completion</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_authorization_completion</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_service_start_posted</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_data_send_start</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_data_chunk_sent</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_data_send_completion</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_schema_received</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_outputArgument_received</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_abort_sent</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_abort_received</span><span class="p">,</span>
  <span class="k">ADD</span> <span class="n">EVENT</span> <span class="n">SQLSatellite</span><span class="p">.</span><span class="n">satellite_abort_connection</span>
  <span class="k">ADD</span> <span class="n">TARGET</span> <span class="n">package0</span><span class="p">.</span><span class="n">event_file</span>
             <span class="p">(</span>
               <span class="k">SET</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">'C:</span><span class="se">\E</span><span class="s1">xtLogs</span><span class="se">\S</span><span class="s1">atelliteTest1.xel'</span><span class="p">,</span>
               <span class="n">max_file_size</span> <span class="o">=</span> <span class="mi">5</span>
             <span class="p">)</span>
<span class="k">WITH</span><span class="p">(</span><span class="n">MAX_DISPATCH_LATENCY</span> <span class="o">=</span> <span class="mi">2</span> <span class="n">SECONDS</span><span class="p">);</span>
<span class="k">GO</span>

<span class="k">ALTER</span> <span class="n">EVENT</span> <span class="k">SESSION</span> <span class="n">SatelliteTest1</span>
<span class="k">ON</span> <span class="n">SERVER</span> <span class="k">STATE</span> <span class="o">=</span> <span class="k">START</span> 
<span class="k">GO</span> 
</code></pre></div></div>
<p><strong>Code Snippet 14:</strong> <em>XEvents SQL Server</em></p>

<p>In <em>Code Snippet 14</em> we see how we use the authentication and authorisation events from <em>Code Snippet 11</em> and how we add data related events, output argument events and abort events to the session.</p>

<p>The Launchpad config file looks like so:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;event_sessions&gt;</span>
  <span class="nt">&lt;event_session</span> <span class="na">name=</span><span class="s">"dataEventsLaunchPad"</span> 
                 <span class="na">maxMemory=</span><span class="s">"1"</span> 
                 <span class="na">dispatchLatency=</span><span class="s">"1"</span> 
                 <span class="na">MaxDispatchLatency=</span><span class="s">"2 SECONDS"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> <span class="na">name=</span><span class="s">"trace_event"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> <span class="na">name=</span><span class="s">"launchpad_launch_start"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> <span class="na">name=</span><span class="s">"launchpad_resume_sent"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> 
           <span class="na">name=</span><span class="s">"satellite_authentication_completion"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> <span class="na">name=</span><span class="s">"satellite_messaging"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> <span class="na">name=</span><span class="s">"satellite_message_summary"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;target</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="na">name=</span><span class="s">"event_file"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"filename"</span> <span class="na">value=</span><span class="s">"launchpadDataEvents.xel"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"max_file_size"</span> <span class="na">value=</span><span class="s">"5"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"max_rollover_files"</span> <span class="na">value=</span><span class="s">"5"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/target&gt;</span>
  <span class="nt">&lt;/event_session&gt;</span>
<span class="nt">&lt;/event_sessions&gt;</span>
</code></pre></div></div>
<p><strong>Code Snippet 15:</strong> <em>Launchpad.xevents.xel Configuration File</em></p>

<p>For Launchpad we are interested in trace events, the start and resume events, authentication and then finally some message events. Notice how the file name is just the filename with no path. This is per what we discussed earlier.</p>

<p>Finally the BxlServer config file looks like this:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;event_sessions&gt;</span>
  <span class="nt">&lt;event_session</span> <span class="na">name=</span><span class="s">"dataEventsBxl"</span> 
                 <span class="na">maxMemory=</span><span class="s">"1"</span> 
                 <span class="na">dispatchLatency=</span><span class="s">"1"</span> 
                 <span class="na">MaxDispatchLatency=</span><span class="s">"2 SECONDS"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> <span class="na">name=</span><span class="s">"trace_event"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> 
           <span class="na">name=</span><span class="s">"satellite_authentication_completion"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> 
           <span class="na">name=</span><span class="s">"satellite_data_receive_completion"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> <span class="na">name=</span><span class="s">"satellite_schema_sent"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> 
           <span class="na">name=</span><span class="s">"satellite_outputArgument_sent"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> <span class="na">name=</span><span class="s">"satellite_abort_connection"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> <span class="na">name=</span><span class="s">"satellite_cleanup"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> <span class="na">name=</span><span class="s">"satellite_messaging"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">package=</span><span class="s">"SQLSatellite"</span> <span class="na">name=</span><span class="s">"satellite_message_summary"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;target</span> <span class="na">package=</span><span class="s">"package0"</span> <span class="na">name=</span><span class="s">"event_file"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"filename"</span> 
        <span class="na">value=</span><span class="s">"..\\..\\..\\..\\..\\..\\..\\..\\..\\..\ExtLogs\bxlDataEvents.xel"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"max_file_size"</span> <span class="na">value=</span><span class="s">"5"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"max_rollover_files"</span> <span class="na">value=</span><span class="s">"5"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/target&gt;</span>
  <span class="nt">&lt;/event_session&gt;</span>
<span class="nt">&lt;/event_sessions&gt;</span>
</code></pre></div></div>
<p><strong>Code Snippet 16:</strong> <em>bxlserver.xevents.xel Configuration File</em></p>

<p>The config file for BxlServer looks a little bit like the config file for Launchpad in that we are interested in authentication and trace events. In addition to to those events, we are interested in: data, output arguments, aborts and messages.</p>

<p>We now create the event session in <em>Code Snippet 14</em> by executing - in SSMS - the code in the code snippet. We then drop the configuration files for the Launchpad (<code class="highlighter-rouge">Launchpad.xevents.xel</code>) and BxlServer (<code class="highlighter-rouge">bxlserver.xevents.xel</code>) in respective directories (as we mentioned above).</p>

<blockquote>
  <p><strong>NOTE:</strong> Both Launchpad and BxlServer loads the configuration files at startup. This is not so much an issue with the BxlServer, as each execution results in a startup. However, for Launchpad it is different, as Launchpad starts when the service starts. So if you create a new configuration file for the Launchpad service (as we do here) or do changes to an existing file, you need to restart the Launchpad service afterwards.</p>
</blockquote>

<p>Right, we can now execute some <code class="highlighter-rouge">sp_execute_external_script</code> code and see what happens (after having restarted the Launchpad service):</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span> 
            <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
          <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'OutputDataSet &lt;- InputDataSet'</span>
          <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT name, database_id 
                              FROM sys.databases'</span>
</code></pre></div></div>
<p><strong>Code Snippet 17:</strong> <em>External Script</em></p>

<p>After execution, you now see in your log directory two <code class="highlighter-rouge">xel</code> files, one for the SQL Server <code class="highlighter-rouge">SatelliteTest1</code> session and one for the BxlServer. In the <code class="highlighter-rouge">..\Log\ExtensibilityLog</code> directory you see one <code class="highlighter-rouge">xel</code> file for the Launchpad extended events. If we drag and drop them to the SSMS canvas we see this:</p>

<p><img src="/images/posts/sql_ml_services_xevents_sql_xevents.png" alt="" /></p>

<p><strong>Figure 8:</strong> <em>SQL Server Event Data</em></p>

<p><img src="/images/posts/sql_ml_services_xevents_launchpad_xevents.png" alt="" /></p>

<p><strong>Figure 9:</strong> <em>Launchpad Event Data</em></p>

<p><img src="/images/posts/sql_ml_services_xevents_bxl_xevents.png" alt="" /></p>

<p><strong>Figure 10:</strong> <em>BxlServer Event Data</em></p>

<p>The three figures above show the extended events, after we executed the code in <em>Code Snippet 17</em>, from:</p>

<ul>
  <li>SQL Server - <em>Figure 8</em>.</li>
  <li>Launchpad - <em>Figure 9</em>.</li>
  <li>BxlServer - <em>Figure 10</em>.</li>
</ul>

<p>By looking at the events and the timestamps, we get an idea what the flow is when executing <code class="highlighter-rouge">sp_execute_external_script</code>, similar to what we covered in the <strong>SQL Server R Services - Internals</strong>. To see more clearly the flow, I inserted the different events into a table and selected out from the table in the order of the event time, and then it looks like this:</p>

<p><img src="/images/posts/sql_ml_services_xevents_event_order2.png" alt="" /></p>

<p><strong>Figure 11:</strong> <em>Event Order</em></p>

<p>I have in <em>Figure 11</em> highlighted some events worth saying a couple of words about:</p>

<ul>
  <li>Green - <code class="highlighter-rouge">trace_event</code>. In the <a href="https://docs.microsoft.com/en-us/sql/advanced-analytics/r/extended-events-for-sql-server-r-services">documentation</a> it says that the <code class="highlighter-rouge">trace_event</code> can include events due to output to stdout and stderr from R. From my testing I can not see that, it only outputs internal trace events, and it looks like SQL Server does not output any trace events at all.</li>
  <li>Yellow - <code class="highlighter-rouge">satellite_messaging</code>. This event is really cool, as it fires when the different processes send messages to each other. Useful if you want to see what happens. I only included <code class="highlighter-rouge">satellite_messaging</code> for the Launchpad service, as otherwise, the trace becomes too big.</li>
  <li>Blue - <code class="highlighter-rouge">satellite_schema_sent/received</code>. BxlServer fires <code class="highlighter-rouge">satellite_schema_sent</code> when data goes back to SQL Server, and SQL Server fires <code class="highlighter-rouge">satellite_schema_received</code>. In fact regardless if any return data goes back to SQL Server, these two events fires.</li>
  <li>Red - <code class="highlighter-rouge">satellite_outputArgument_sent/received</code>. As the name implies, these two events are related to output arguments. They have the same behaviour as the schema events above in that that they fire regardless whether there is an output argument or not.</li>
</ul>

<h2 id="event-matrix">Event Matrix</h2>

<p>During my playing around with extended events for <strong>SQL Server Machine Learning Services</strong> I have tried to keep track and what events fire when and for what processes. There are events I have not been able to see fire at all, but that is most likely due to me not knowing what I am doing. Anyway, the table below lays out what I have seen:</p>

<table>
  <thead>
    <tr>
      <th>Event</th>
      <th style="text-align: center">SQL Server</th>
      <th style="text-align: center">Launchpad</th>
      <th style="text-align: center">BxlServer</th>
      <th>Comments</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">launchpad_launch_start</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">x</td>
      <td style="text-align: center"> </td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">launchpad_resume_sent</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">x</td>
      <td style="text-align: center"> </td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">trace_event</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">x</td>
      <td style="text-align: center">x</td>
      <td>See above about <code class="highlighter-rouge">trace_event</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_authentication_completion</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center">x</td>
      <td style="text-align: center">x</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_authorization_completion</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_service_start_posted</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_data_send_start</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_data_chunk_sent</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_data_send_completion</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_data_receive_completion</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">x</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_schema_sent</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">x</td>
      <td>See above about <code class="highlighter-rouge">satellite_schema_sent</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_outputArgument_sent</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">x</td>
      <td>See above about <code class="highlighter-rouge">satellite_outputArgument_sent</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_error</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">x</td>
      <td style="text-align: center">x</td>
      <td>This event is output, regardless if there is an error or not.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_schema_received</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>See above about <code class="highlighter-rouge">satellite_schema_received</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_outputArgument_received</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>See above about <code class="highlighter-rouge">satellite_outputArgument_received</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_abort_sent</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">(x)</td>
      <td>See below.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_abort_received</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_abort_connection</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">x</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_cleanup</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">x</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_message_summary</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center">x</td>
      <td style="text-align: center">x</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_messaging</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center">x</td>
      <td style="text-align: center">x</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_message_coalesced</code></td>
      <td style="text-align: center">x</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">connection_accept</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>See below.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">failed_launching</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>See below.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">extensibility_session_snapshot</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>Cannot get to fire.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">external_resource_pool</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>Cannot get to fire.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">extensibility_error_ring_buffer_record</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>Cannot get to fire.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">extensibility_session_snapshot</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>Cannot get to fire.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_unexpected_message_received</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>Cannot get to fire.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">stack_trace</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>Should fire if a memory dump is made of the process.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_message_ring_buffer_record</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>Cannot get to fire. Believe this is more for debug purposes.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_sessionId_mismatch</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>Cannot get to fire. Believe this is more for debug purposes.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_invalid_sized_message</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>Cannot get to fire. Believe this is more for debug purposes.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_message_version_mismatch</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>Cannot get to fire. Believe this is more for debug purposes.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">satellite_partial_message</code></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td>Cannot get to fire.</td>
    </tr>
  </tbody>
</table>

<p><strong>Table 1:</strong> <em>Event Matrix</em></p>

<p>In <em>Table 1</em> there are a couple of “see below”:</p>

<ul>
  <li><code class="highlighter-rouge">satellite_abort_sent</code> - If execution goes OK, SQL Server fires the <code class="highlighter-rouge">satellite_abort_sent</code> at the end of execution. If an exception happens in the external engine, SqlSatellite fires <code class="highlighter-rouge">satellite_abort_sent</code>.</li>
  <li><code class="highlighter-rouge">connection_accept</code> - I am surprised that I cannot see this event fire.  I would have expected at least SQL Server or SqlSatellite to cause the event to happen when they connect.</li>
  <li><code class="highlighter-rouge">failed_launching</code> - This I am also surprised not to see fire. I stopped the launchpad service and tried to execute <code class="highlighter-rouge">sp_execute_external_script</code>, but no, no <code class="highlighter-rouge">failed_launching</code> event.</li>
</ul>

<p>I hope that Microsoft, at some stage, can explain to me what I did wrong when I could not see some of the events above fire. When that happens I will update this post.</p>

<h2 id="summary">Summary</h2>

<p>So what are the takeaway points in this post:</p>

<ul>
  <li>With the introduction of R in SQL Server 2016, Microsoft also introduced new extended events for <strong>SQL Server Machine Learning Services</strong>.</li>
  <li>The <code class="highlighter-rouge">SQLSatellite</code> package contains the events.</li>
  <li>XEvents are available both for the SQL Server process as well as the external processes: <code class="highlighter-rouge">Launchpad.exe</code> and <code class="highlighter-rouge">BxlServer.exe</code>.</li>
  <li>The three processes do not publish all the same events.</li>
  <li>To capture events from SQL Server you use the “normal” <code class="highlighter-rouge">CREATE EVENT SESSION</code> syntax.</li>
  <li>For <code class="highlighter-rouge">Launchpad.exe</code> and <code class="highlighter-rouge">BxlServer.exe</code> you use a configuration file in XML format to register the events that interests you.</li>
  <li>You place the configuration file(s) in the same directory as the executable(s).</li>
  <li>When the external processes target the <code class="highlighter-rouge">event_file</code> <code class="highlighter-rouge">target</code>, the target filename (and path) differs between the Launchpad process and the BxlServer process.
    <ul>
      <li>For Launchpad the filename is the filename only, and Launchpad writes the file to the <code class="highlighter-rouge">..\Log\ExtensibilityLog</code> directory.</li>
      <li>For BxlServer the path is a relative path (relative to BxlServer) to a directory which BxlServer has write access to.</li>
    </ul>
  </li>
</ul>

<p>As I mentioned at the beginning of this post, the post came about due to a question on an internal forum, and I just wanted to figure out for myself what goes on with extended events and <strong>SQL Server Machine Learning Services</strong>. The  <a href="https://docs.microsoft.com/en-us/sql/advanced-analytics/r/extended-events-for-sql-server-r-services">documentation</a> about extended events and SQL Server Machine Learning Services was a big help, and without the help from <a href="https://www.linkedin.com/in/umachandarjayachandran/">Umachandar Jayachandran</a> I would never have figured out why I could not see any events from <code class="highlighter-rouge">BxlServer.exe</code>.</p>

<h2 id="-finally">~ Finally</h2>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2018/04/08/sql-server-machine-learning-services-and-extended-events/&text=SQL Server Machine Learning Services and Extended Events&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2018/04/08/sql-server-machine-learning-services-and-extended-events/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2018/04/08/sql-server-machine-learning-services-and-extended-events/
         &title=SQL Server Machine Learning Services and Extended Events
         &summary=Blog post: SQL Server extended events (XEvents) and SQL Server Machine Learning Services
         &source=http://www.nielsberglund.com/2018/04/08/sql-server-machine-learning-services-and-extended-events/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2018/04/08/sql-server-machine-learning-services-and-extended-events/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-machine-learning-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Machine Learning Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#python">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Python</span>
    </a>
  
    
    <a href="/tags/#extended-events">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Extended Events</span>
    </a>
  
    
    <a href="/tags/#xevents">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">XEvents</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2018/04/08/sql-server-machine-learning-services-and-extended-events/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2018/04/08/sql-server-machine-learning-services-and-extended-events/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/12/interesting-stuff-week-32/">
            Interesting Stuff - Week 32
            <small>12 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/">
            sp_execute_external_script and SQL Compute Context - III
            <small>04 Aug 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
