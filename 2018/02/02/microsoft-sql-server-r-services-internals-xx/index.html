<!DOCTYPE html> <html lang="en-us"> <head> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="A drill down, using WinDbg, WireShark, Process Monitor, into how error messages in the external engine is handled by SQL Server."> <meta name="keywords" content="SQL Server R Services, SQL Server Machine Learning Services, R, WinDbg, Launchpad, RTerm.exe, BXL, Process Monitor, SqlSatellite, WireShark"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Microsoft SQL Server R Services - Internals XX &middot; Niels Berglund </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-6937d9aff18f4bd864a4e4772a407120.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.3.0 --> <title>Microsoft SQL Server R Services - Internals XX | Niels Berglund</title> <meta property="og:title" content="Microsoft SQL Server R Services - Internals XX" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A drill down, using WinDbg, WireShark, Process Monitor, into how error messages in the external engine is handled by SQL Server." /> <meta property="og:description" content="A drill down, using WinDbg, WireShark, Process Monitor, into how error messages in the external engine is handled by SQL Server." /> <link rel="canonical" href="http://nielsberglund.com/2018/02/02/microsoft-sql-server-r-services-internals-xx/" /> <meta property="og:url" content="http://nielsberglund.com/2018/02/02/microsoft-sql-server-r-services-internals-xx/" /> <meta property="og:site_name" content="Niels Berglund" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2018-02-02T19:48:22+02:00" /> <script type="application/ld+json"> {"name":null,"description":"A drill down, using WinDbg, WireShark, Process Monitor, into how error messages in the external engine is handled by SQL Server.","author":{"@type":"Person","name":"nielsb"},"@type":"BlogPosting","url":"http://nielsberglund.com/2018/02/02/microsoft-sql-server-r-services-internals-xx/","publisher":null,"image":null,"headline":"Microsoft SQL Server R Services - Internals XX","dateModified":"2018-02-02T19:48:22+02:00","datePublished":"2018-02-02T19:48:22+02:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://nielsberglund.com/2018/02/02/microsoft-sql-server-r-services-internals-xx/"},"@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-3005153158271538", enable_page_level_ads: true }); </script> </head> <body> <div class="sidebar"> <div class="container"> <div class="sidebar-about"> <h1> <a href="/"> Niels Berglund </a> </h1> <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Sidebar_rectangle --> <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-3005153158271538" data-ad-slot="7704601332"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/disclaimer/">Disclaimer</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <img class="center" src="/images/MVP_Logo_large.png" width="300" height="121" > <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <p>&copy; 2018. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">Microsoft SQL Server R Services - Internals XX</h1> <div class="post-subheading"> <span class="post-date">02 Feb 2018</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#Microsoft R Server">Microsoft R Server</a> <a href="/categories/#Data Science">Data Science</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server R Services">SQL Server R Services</a> <a href="/tags/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <a href="/tags/#R">R</a> <a href="/tags/#WinDbg">WinDbg</a> <a href="/tags/#Launchpad">Launchpad</a> <a href="/tags/#RTerm.exe">RTerm.exe</a> <a href="/tags/#BXL">BXL</a> <a href="/tags/#Process Monitor">Process Monitor</a> <a href="/tags/#SqlSatellite">SqlSatellite</a> <a href="/tags/#WireShark">WireShark</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> <p>This post is part of a series of blog-posts about Microsoft SQL Server R Services:</p> <ol> <li><a href="/2017/03/04/microsoft-sql-server-2016-r-services-installation/">Microsoft SQL Server 2016 R Services Installation</a></li> <li><a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Microsoft SQL Server R Services - Internals I</a></li> <li><a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Microsoft SQL Server R Services - Internals II</a></li> <li><a href="/2017/04/13/microsoft-sql-server-r-services-internals-iii/">Microsoft SQL Server R Services - Internals III</a></li> <li><a href="/2017/04/23/microsoft-sql-server-r-services-internals-iv/">Microsoft SQL Server R Services - Internals IV</a></li> <li><a href="/2017/05/01/microsoft-sql-server-r-services-internals-v/">Microsoft SQL Server R Services - Internals V</a></li> <li><a href="/2017/05/16/microsoft-sql-server-r-services-internals-vi/">Microsoft SQL Server R Services - Internals VI</a></li> <li><a href="/2017/07/11/microsoft-sql-server-r-services-internals-vii/">Microsoft SQL Server R Services - Internals VII</a></li> <li><a href="/2017/07/22/microsoft-sql-server-r-services-internals-viii/">Microsoft SQL Server R Services - Internals VIII</a></li> <li><a href="/2017/08/18/microsoft-sql-server-r-services-internals-ix/">Microsoft SQL Server R Services - Internals IX</a></li> <li><a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Microsoft SQL Server R Services - Internals X</a></li> <li><a href="/2017/10/20/microsoft-sql-server-r-services-internals-xi/">Microsoft SQL Server R Services - Internals XI</a></li> <li><a href="/2017/10/31/microsoft-sql-server-r-services-internals-xii/">Microsoft SQL Server R Services - Internals XII</a></li> <li><a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">Microsoft SQL Server R Services - Internals XIII</a></li> <li><a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Microsoft SQL Server R Services - Internals XIV</a></li> <li><a href="/2017/12/02/microsoft-sql-server-r-services-internals-xv/">Microsoft SQL Server R Services - Internals XV</a></li> <li><a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Microsoft SQL Server R Services - Internals XVI</a></li> <li><a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Microsoft SQL Server R Services - Internals XVII</a></li> <li><a href="/2018/01/10/microsoft-sql-server-r-services-internals-xviii/">Microsoft SQL Server R Services - Internals XVIII</a></li> <li><a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Microsoft SQL Server R Services - Internals XIX</a></li> <li>Microsoft SQL Server R Services - Internals XX (this post)</li> <li>More to come (hopefully)</li> </ol> <p>This post is the 21:th post about Microsoft SQL Server R Services (it is now called <strong>Microsoft SQL Server Machine Learning Services</strong>), and the 20:th post that drills down into the internals of how it works. Wow, 20 posts about internals - when I started this <strong>Microsoft SQL Server R Services</strong> series, I thought I might achieve five or six posts. I would never have - in my wildest fantasies - thought I would reach twenty!</p> <p>We are however now coming closer to the end of this whole series, and this post is the last for <strong>Internals</strong>. After this post, I foresee one, possibly two, more posts about other things related to <strong>Microsoft SQL Server R Services</strong> - and then we are done!</p> <!--more--> <p>In the last post: <a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Internals - XIX</a> we discussed how "print" statements and acks came back to SQL Server from the external engine. When I started writing that post, I intended to cover error messages as well, but as I was investigating what happens, I realised it was more to error messages than what I initially thought. So in this post, we talk about how SQL Server and the launchpad service handle errors.</p> <h2>Recap</h2> <p>Before we go into the details about errors, let us do a recap of the <a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Internals - XIX</a> post, as there are many similarities between the handling of error messages and "print"/ack messages are.</p> <p>The easiest way to recap is to use the two figures we had in <a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Internals - XIX</a> which illustrated the flow of the launchpad service as well as SQL Server.</p> <h4>Launchpad Service</h4> <p>This is the flow (on a high level) in the launchpad service:</p> <p><img class="center" src="/images/posts/sql_r_services_19_launchpad_flow.png" width="800" height="431" > <strong>Figure 1:</strong> <em>Launchpad Flow</em></p> <p>In <em>Figure 1</em> we see the main calls of leading up to and including when messages come back from the external engine. The numbered arrows show some of the calls and the communication in the launchpad service:</p> <ol> <li>During startup, an IOCP "listener" is set up.</li> <li>Creates supporting directories and process, and initiates the connection to the external engine.</li> <li>A call comes back from the external engine when work finishes.</li> <li>The call causes the "listener" to call <code>Read...</code> routines.</li> <li><code>LaunchServTask</code> is signalled.</li> <li>Execution in <code>LaunchServTask</code> continues into launchpad!CLaunchContext::Cleanup.</li> <li>A call to <code>launchpad!CSatelliteCargoContext::SendLogMessage</code> happens if a "print" message has been passed back from the external engine, eventually <code>launchpad!CSatelliteCargoContext::SendLogMessage</code> is called.</li> <li><code>launchpad!CSatelliteCargoContext::SendLogMessage</code> sends the message to SQL Server.</li> <li><code>LaunchServTask</code> continues into <code>launchpad!CSQLSatelliteCommunication::SendAckMessage</code>, which sends an ack that the "job is done" to SQL Server.</li> </ol> <h4>SQL Server</h4> <p>This is the high level flow in SQL Server:</p> <p><img class="center" src="/images/posts/sql_r_services_19_sql_flow.png" width="800" height="584" > <strong>Figure 2:</strong> <em>SQL Server Flow</em></p> <p>The numbered arrows in <em>Figure 2</em> illustrates:</p> <ol> <li>During the launch of the launchpad service, an IOCP "listener" is set up.</li> <li>Message sent to the launchpad service.</li> <li>After the call above, the SqlSatellite opens a TCP/IP connection to SQL Server.</li> <li>SQL Server sends authentication packets and script packet to the SqlSatellite.</li> <li>If there is data for <code>@input_data_1</code>, it is sent, together with two end packets.</li> <li>Packets are coming back to SQL Server containing meta-data and the actual data.</li> <li><code>PullRow</code> is being signalled, and processing of meta-data as well as result rows continues.</li> <li>The launchpad service sends "print"/ack messages to SQL Server. In the figure, they appear as one packet, but there is one message for "print" and one for ack.</li> <li><code>ErsqExecuteQuery</code> is signalled.</li> <li>Execution continues by calling into <code>sqllang!CXStmtQuery::ShutdownNormal</code>, which calls into <code>FinalCleanup,</code>ShutdownService, and a call to <code>sqllang!CSQLSatelliteCommunication::WaitForAckMessage</code> is made followed by <code>sqllang!CSQLSatelliteConnection::GetNextMessage</code>.</li> <li>If a "print" message has is sent to SQL Server, <code>ReadPayload</code> is called and then <code>sqllang!CUDXR_ExternalScript::HandleLogMessage</code>. The code loops on <code>sqllang!CSQLSatelliteCommunication::WaitForAckMessage</code> if there is no "print" message.</li> <li>SQL Server loops on <code>sqllang!CSQLSatelliteCommunication::WaitForAckMessage</code> and waits for the ack message,</li> <li>After receiving the ack message, SQL Server sends relevant messages to the calling code.</li> </ol> <h2>Housekeeping</h2> <p>Before we "dive" into today's topics let us look at the code and the tools we use today. This section is here for those of who want to follow along in what we are doing in the posts.</p> <h4>Helper Tools</h4> <p>To help us figure out the things we want, we use <em>Process Monitor</em>, <em>WinDbg</em> and <em>WireShark</em>:</p> <ul> <li><em>Process Monitor</em>, is used it to filter TCP traffic. If you want to refresh your memory about how to do it, we covered that in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> as well as in <a href="/2017/11/25/microsoft-sql-server-r-services-internals-xiv/">Internals - XIV</a>.</li> <li>In the last few posts I have used <em>WinDbg preview</em> as my debugger, but in this post, I am reverting to <em>WinDbg</em> "classic". If you need help with setting it up, I covered that in <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Internals - I</a>.</li> <li>I use <em>WireShark</em> for network packet sniffing. If you want a refresher about <em>WireShark</em>, we covered the setup and so forth in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a>.</li> </ul> <h4>Code</h4> <p>In this post we won't need a specific database, we'll just some basic code:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Base Code</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(10)
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                             d &lt;- 42'</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Base Code to Execute</em></p> <p>The code in <em>Code Snippet 1</em> is the code we use for "base-lining", e.g. what it looks like when everything works. The <code>Sys.sleep</code> is in the script to make it easier for us to see what happens, and in what order.</p> <p>We also use variants of that code to create errors:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Script Error</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(10)
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                             d &lt;- 42
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                             #the function below does not exist
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                             nonExistFunc(d)'</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>Script with Missing Function</em></p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>SQL Error</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(1)
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                             d &lt;- 42'</span><span class="p">,</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT 1/ 0'</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 3:</strong> <em>Error When Selecting Data</em></p> <p>We talk more about the two code snippets below.</p> <h2>Error</h2> <p>When we discuss error messages, there are two main types of errors, and the code above exemplifies that:</p> <ul> <li>Errors generated from the external engine script - <em>Code Snippet 2</em>.</li> <li>Errors raised when generating the input data-set (<code>@input_data_1</code>) - <em>Code Snippet 3</em>.</li> </ul> <p>So, let us look at what happens when we execute the code in <em>Code Snippet 2</em> and <em>Code Snippet 3</em>.</p> <p>This is the output from <em>Code Snippet 2</em>:</p> <p><img class="center" src="/images/posts/sql_r_services_19_error1.png" width="560" height="235" > <strong>Figure 3:</strong> <em>R Script Error</em></p> <p>The output from executing the code in <em>Code Snippet 3</em>:</p> <p><img class="center" src="/images/posts/sql_r_services_20_error2.png" width="520" height="185" > <strong>Figure 4:</strong> <em>SQL Execution Error</em></p> <p>When looking at both <em>Figure 3</em> and <em>Figure 4</em>, we see that there are SQL Server error numbers assigned to the errors. However, compare the errors in <em>Figure 3</em>, and <em>Figure 4</em>. In <em>Figure 3</em> there are two errors; <code>39004</code> and <code>39019</code> - and in the error message they both refer to the external script. In <em>Figure 4</em> however, the error message is the usual message about division by zero, and no referral to external script whatsoever. There is though some text about SqlSatellite.</p> <p>So it seems that for specific external script errors, SQL Server knows about them, but others not.</p> <h2>Known SQL Errors</h2> <p>We start by looking at, what I call, known SQL errors - like we see in <em>Figure 3</em>. Just for fun, let us execute following code:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Errors</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">text</span> <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">messages</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WHERE</span> <span class="n">message_id</span> <span class="k">BETWEEN</span> <span class="mi">39000</span> <span class="k">AND</span> <span class="mi">39999</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">AND</span> <span class="n">language_id</span> <span class="o">=</span> <span class="mi">1033</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 4:</strong> <em>Selecting Error Messages</em></p> <p>On my SQL Server 2016 box the statement in <em>Code Snippet 4</em> returns 27 rows, and when browsing through the result I realise that most of them are related to the external script or the external engine:</p> <p><img class="center" src="/images/posts/sql_r_services_20_error_msgs.png" width="800" height="245" > <strong>Figure 5:</strong> <em>SQL Server Error Messages</em></p> <p>In <em>Figure 5</em> wee see some of the error codes related to the external script/engine - so the question is how SQL Server knows that, what originates from the external engine, is an error?</p> <p>We know that error(s) are raised in SQL Server when something goes wrong in the external engine (see <em>Figure 3</em>), but what happens in the launchpad service? So, let us do this:</p> <ul> <li>Start up two instances of <em>WinDbg</em> as admin.</li> <li>Attach <em>WinDbg</em> to the SQL Server process (<code>sqlservr.exe</code>), and the launchpad process (<code>launchpad.exe</code>) - <strong>DO NOT DO THIS ON A PRODUCTION SERVER</strong>.</li> <li>In both instances of <em>WinDbg</em> enable an <em>Event Filter</em> for <code>C++ EH Exception</code>. If you need to refresh you memory about how to do it, <a href="/2017/04/02/microsoft-sql-server-r-services-internals-ii/">Internals - II</a> goes into the details.</li> <li>Execute the code in <em>Code Snippet 2</em>.</li> </ul> <p>When you execute, you see how you just continue through in the launchpad service, but you break with an exception in SQL Server. It looks like exceptions in the external engine does not affect the launchpad service at all. So let us start looking more in detail what happens in SQL Server.</p> <h4>SQL Server I</h4> <p>The exception in SQL server we received above looks like this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Exception</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">(</span><span class="mi">17</span><span class="n">d0</span><span class="mf">.3744</span><span class="p">)</span><span class="o">:</span> <span class="n">C</span><span class="o">++</span> <span class="n">EH</span> <span class="n">exception</span> <span class="o">-</span> <span class="n">code</span> <span class="n">e06d7363</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="n">and</span> <span class="n">handled</span><span class="p">.</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">KERNELBASE</span><span class="o">!</span><span class="n">RaiseException</span><span class="o">+</span><span class="mh">0x68</span><span class="o">:</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">00007</span><span class="n">ffe</span><span class="err">`</span><span class="n">dbba2918</span> <span class="mi">488</span><span class="n">b8c24c0000000</span> <span class="n">mov</span>   <br/>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">rcx</span><span class="p">,</span><span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">0</span><span class="n">C0h</span><span class="p">]</span> <span class="n">ss</span><span class="o">:</span><span class="mf">000000e1</span><span class="err">`</span><span class="mi">817</span><span class="n">fb9c0</span><span class="o">=</span><span class="mo">00001</span><span class="n">f7285a2fbf6</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 5:</strong> <em>External Engine Exception in SQL</em></p> <p>As in <em>Code Snippet 5</em>, there is an error in SQL Server, and when you continue a second error is raised which you continue through as well. Now execute the code in <em>Code Snippet 2</em> again, and check the call-stack (<code>k</code>) when SQL Server breaks at the first error :</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Call Stack</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">KERNELBASE</span><span class="o">!</span><span class="n">RaiseException</span><span class="o">+</span><span class="mh">0x68</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">MSVCR120</span><span class="o">!</span><span class="n">_CxxThrowException</span><span class="o">+</span><span class="mh">0xb3</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>         <span class="p">[</span><span class="n">f</span><span class="o">:</span><span class="err">\</span><span class="n">dd</span><span class="err">\</span><span class="n">vctools</span><span class="err">\</span><span class="n">crt</span><span class="err">\</span><span class="n">crtw32</span><span class="err">\</span><span class="n">eh</span><span class="err">\</span><span class="k">throw</span><span class="p">.</span><span class="n">cpp</span> <span class="err">@</span> <span class="mi">154</span><span class="p">]</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqldk</span><span class="o">!</span><span class="n">ExceptionBackout</span><span class="o">::</span><span class="n">GetCurrentException</span><span class="o">+</span><span class="mh">0x385</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqldk</span><span class="o">!</span><span class="n">ex_raise2</span><span class="o">+</span><span class="mh">0x52f</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqldk</span><span class="o">!</span><span class="n">ex_raise</span><span class="o">+</span><span class="mh">0xc4</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span><span class="o">+</span><span class="mh">0x172</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">GetRow</span><span class="o">+</span><span class="mh">0x81</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span><span class="o">+</span><span class="mh">0x4dc</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">...</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span><span class="o">+</span><span class="mh">0x140e</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">...</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">ntdll</span><span class="o">!</span><span class="n">RtlUserThreadStart</span><span class="o">+</span><span class="mh">0x21</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 6:</strong> <em>Call Stack at Exception</em></p> <p>Interesting, in <em>Code Snippet 6</em> we see the call to <code>sqlmin!CQScanUdx::GetRow</code> raise an error - even though we are not retrieving any data from the engine! What happens here?</p> <p>Remember back to the last posts, where we spoke about how the SqlSatellite returns packets to SQL Server after execution. We saw an example of what it looks like if we execute the code in <em>Code Snippet 1</em>:</p> <p><img class="center" src="/images/posts/sql_r_services_19_procmon1.png" width="500" height="285" > <strong>Figure 6:</strong> <em>Return Packets</em></p> <p>We saw <em>Figure 6</em> in <a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Internals - XIX</a>, and we discussed in that post, how the SqlSatellite returns the three packets outlined in red above to SQL Server. The first packet contains metadata information about potential result-sets returned, and if there is no result-set, we still get the packet. The second packet is a packet indicating the end of the result-set, and the third packet can potentially contain values of output parameters. Rows returned for a result-set, appear in packets, between the first and second packet in the figure above.</p> <p>So, in the case of an error, like in <em>Figure 3</em> above, are there any changes in what the SqlSatellite returns? By now, you probably realise that if I ask a question like that - there is a difference, but let us find out regardless:</p> <ul> <li>Run <em>Process Monitor</em> as admin and load the filter we used in <a href="/2017/12/24/microsoft-sql-server-r-services-internals-xvi/">Internals - XVI</a> where we filtered for <code>TCP Send</code> and <code>TCP Receive</code> for <code>BxlServer.exe</code>.</li> <li>Execute the code in <em>Code Snippet 2</em> (without the <code>Sys.sleep</code> if you want) and look at the output from <em>Process Monitor</em>:</li> </ul> <p><img class="center" src="/images/posts/sql_r_services_20_procmon1.png" width="680" height="255" > <strong>Figure 7:</strong> <em>Process Monitor Output Error</em></p> <p>It is interesting, that when an error happens, we do not get the packets referred to above. In <em>Figure 7</em> we only see one packet sent back from the SqlSatellite (outlined in red) after the SqlSatellite has received the various packets from SQL Server. While you look at the output from <em>Process Monitor</em>, also make a note of the <code>Path</code> column and the last value (in the figure it is 55538). That value is the port SQL Server receives packets. We use this now in <em>WireShark</em> to try and see if we can get any more information about what is happening.</p> <p>So, let us switch over to <em>WireShark</em>:</p> <ul> <li>Run <em>WireShark</em> as admin.</li> <li>Choose the network adapter to "sniff" on. See <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a> for discussion around loop-back adapters etc.</li> <li>Set a display filter on the port SQL Server listens on (what you saw in the <code>Path</code> column). In this case we want to sniff incoming packets, and if we did it based on what we saw in <em>Figure 7</em> the filter should be: <code>tcp.dstport==55538</code>.</li> <li>Apply the filter.</li> </ul> <p>To start with, we try to see what the packets look like when everything works - and the packets we are interested in, are the two packets with a length of 28. When we execute the code in <em>Code Snippet 1</em> and showing the two data packets as hex, it looks like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Packets</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1">//first 28 bytes packet</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">01</span> <span class="mo">00</span> <span class="mo">06</span> <span class="mi">80</span> <span class="mi">1</span><span class="n">c</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="n">b8</span> <span class="mi">16</span> <span class="mi">27</span> <span class="mi">5</span><span class="n">d</span> <span class="mi">86</span> <span class="n">b9</span> <span class="mi">95</span> <span class="mi">47</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">a3</span> <span class="n">fc</span> <span class="mo">06</span> <span class="mi">0</span><span class="n">a</span> <span class="mi">17</span> <span class="n">f1</span> <span class="mi">92</span> <span class="n">ca</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>          <br/>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1">//2:nd 28 bytes packet</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">01</span> <span class="mo">00</span> <span class="mi">0</span><span class="n">d</span> <span class="mi">80</span> <span class="mi">1</span><span class="n">c</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="n">b8</span> <span class="mi">16</span> <span class="mi">27</span> <span class="mi">5</span><span class="n">d</span> <span class="mi">86</span> <span class="n">b9</span> <span class="mi">95</span> <span class="mi">47</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">a3</span> <span class="n">fc</span> <span class="mo">06</span> <span class="mi">0</span><span class="n">a</span> <span class="mi">17</span> <span class="n">f1</span> <span class="mi">92</span> <span class="n">ca</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 7:</strong> <em>Packets When No Error</em></p> <p>When looking at the packets in <em>Code Snippet 7</em>, it looks like the first 4 bytes determines some packet type. Why I say that is when you execute the code multiple times, the first four bytes for packet 1 always look the same, and the same goes for the second packet. The second 4 bytes in both first and second packet, indicates the packet size (<code>1c</code> = 28). I have no "clue" what the following 16 bytes identify, but it is interesting to notice that the values are the same between packet 1 and 2. The values differ though in between executions. The last four bytes are always 0 in packet 1, in packet two the first byte indicates how many output parameters are returned (if there are any). Remember it is the second packet that contains the output parameters. The last byte in packet 2 is an "end" byte if parameters are returned, otherwise 0.</p> <p>So the above is when there are no errors. What when it is? Clear the display in <em>WireShark</em> (easiest way is to stop capturing packets, and start again) and execute the code in <em>Code Snippet 2</em>. As we know from the discussion around <em>Figure 7</em>, we only get one packet back - and when we look at the data as hex it looks like this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Error Packet</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">01</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mi">80</span> <span class="mi">1</span><span class="n">c</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mi">31</span> <span class="mi">0</span><span class="n">b</span> <span class="mi">6</span><span class="n">c</span> <span class="n">fe</span> <span class="n">b0</span> <span class="mi">9</span><span class="n">f</span> <span class="mi">7</span><span class="n">d</span> <span class="mi">43</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">a4</span> <span class="mi">75</span> <span class="mi">79</span> <span class="mi">5</span><span class="n">a</span> <span class="mi">70</span> <span class="mi">4</span><span class="n">c</span> <span class="n">e1</span> <span class="mo">05</span>  <span class="mi">12</span> <span class="mo">00</span> <span class="mi">2</span><span class="n">a</span> <span class="mo">00</span>            </div></div></pre></div></figure></p> <p><strong>Code Snippet 8:</strong> <em>Packet When Error</em></p> <p>The packet in <em>Code Snippet 8</em> is somewhat similar to what we see in <em>Code Snippet 7</em>, in that the first four bytes are always the same, irrespective of the error packet and the second four bytes part indicating the size. What is different and potentially points out that this is an error packet, is the last four bytes. The four last bytes are always the same for any error packet, and as we see - they are not 0.</p> <p>To summarize what we know so far when an error happens in the external engine:</p> <ul> <li>SQL Server receives one 28 bytes data packet back from the SqlSatellite.</li> <li>The four last bytes always are <code>12 00 2a 00</code>.</li> </ul> <p>Let's go back to the call-stack we see in <em>Code Snippet 6</em> and try to figure out what happens in the code. We have already said the error happens in <code>sqlmin!CQScanUdx::GetRow</code>. We have not spoken much about <code>GetRow</code> at all, but if you remember in <a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Internals- XVII</a> we discussed about how <code>sqllang!CXStmtQuery::ErsqExecuteQuery</code> called <code>sqllang!CUDXR_ExternalScript::PullRow</code>. In fact <code>sqllang!CXStmtQuery::ErsqExecuteQuery</code> calls <code>sqlmin!CQueryScan::GetRow</code> which in turn calls <code>sqlmin!CQScanUdx::GetRow</code> and it calls <code>PullRow</code>.</p> <p>In <a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Internals - XVII</a> we traced the <code>PullRow</code> call and saw how SQL Server handled returning data. To see what happens during an error, let us do the trace one step up - in <code>sqlmin!CQScanUdx::GetRow</code>. We start with the code that works (<em>Code Snippet 1</em>):</p> <ul> <li>Change the <code>Sys.sleep</code> in the script in *Code Snippet 1` to 30 seconds.</li> <li>Set a break-point in the SQL Server process at <code>sqlmin!CQScanUdx::GetRow</code>.</li> <li>Execute the code in <em>Code Snippet 1</em>.</li> <li>When <code>sqlmin!CQScanUdx::GetRow</code> hits the breakpoint, do a <code>wt -l8</code> (trace and watch the execution 8 levels deep).</li> </ul> <p>Look at the <em>WinDbg</em> output when the `Sys.sleep(30) is hit in the script, and notice the last few lines look like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>GetRow</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">EventInternal</span><span class="o">&lt;</span><span class="n">SuspendQueueSLock</span><span class="o">&gt;::</span><span class="n">Wait</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'> <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">EventInternal</span><span class="o">&lt;</span><span class="n">SuspendQueueSLock</span><span class="o">&gt;::</span><span class="n">Wait</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'> <span class="n">sqldk</span><span class="o">!</span><span class="n">SystemThread</span><span class="o">::</span><span class="n">GetCurrentId</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">EventInternal</span><span class="o">&lt;</span><span class="n">SuspendQueueSLock</span><span class="o">&gt;::</span><span class="n">Wait</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'> <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Task</span><span class="o">::</span><span class="n">PreWait</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">EventInternal</span><span class="o">&lt;</span><span class="n">SuspendQueueSLock</span><span class="o">&gt;::</span><span class="n">Wait</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'> <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Suspend</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 9:</strong> <em>wt Output at Sys.sleep</em></p> <p>The code in <em>Code Snippet 9</em> is what precedes the code we saw in <a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Internals - XVII</a> where the execution waited for a signal. After the trace has finished, copy it to a text file to make it easier to investigate what happens. Then execute the code in <em>Code Snippet 2</em> and do a new trace, and copy that result into a new file as well. When you then compare the two files you see how the first part is identical:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>GetRow 2</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputSchema</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">GetOutputSchema</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadSchemaInternal</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>          <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">CSQLSatelliteCommunication</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>          <span class="p">...</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>          <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadAllPackets</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">GetNextMessage</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="p">...</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="n">sqllang</span><span class="o">!</span><span class="n">EventInternal</span><span class="o">&lt;</span><span class="n">SuspendQueueSLock</span><span class="o">&gt;::</span><span class="n">Wait</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>                <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">Suspend</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="c1">//here is Sys.sleep</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="c1">//here we continue</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>                <span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Scheduler</span><span class="o">::</span><span class="n">SuspendNonPreemptive</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="n">sqllang</span><span class="o">!</span><span class="n">EventInternal</span><span class="o">&lt;</span><span class="n">SuspendQueueSLock</span><span class="o">&gt;::</span><span class="n">Wait</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>               <span class="p">...</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">GetNextMessage</span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteConnection</span><span class="o">::</span><span class="n">RetrieveMessage</span>
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>                <span class="p">...</span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>          <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadAllPackets</span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">BindReadSNIPacket</span>
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">GetSQLSatelliteMessage</span>
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="p">...</span>
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="p">...</span>
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'>          <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadAllPackets</span>
</div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'>          <span class="p">...</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 10:</strong> <em>Common Code Path</em></p> <p>In <em>Code Snippet 10</em> we recognise from <a href="/2018/01/03/microsoft-sql-server-r-services-internals-xvii/">Internals - XVII</a> the calls to retrieve rows, and they are the same in both trace files up until around line 50, after the <code>ReadAllPackets</code> in the next to last line above. Continuing, what we see in the files change. In the no error trace file nothing out of the ordinary happens, and eventually, the trace ends with the call to <code>sqllang!CUDXR_ExternalScript::ProcessOutputArguments</code>, which we discussed in <a href="/2018/01/10/microsoft-sql-server-r-services-internals-xviii/">Internals - XVIII</a>. The error trace file looks completely different though from after the last <code>ReadAllPackets</code> above:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>GetRow Exception</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputSchema</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">GetOutputSchema</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadSchemaInternal</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="p">...</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>          <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadAllPackets</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">BindReadSNIPacket</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">GetSQLSatelliteMessage</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="p">...</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>          <span class="c1">//this is the last ReadAllPackets above</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>           <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">ReadAllPackets</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">HandleSpecialMessage</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="n">sqllang</span><span class="o">!</span><span class="n">CServerCargoContext</span><span class="o">::</span><span class="n">HandleAbortMessage</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="p">...</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="p">...</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ProcessOutputSchema</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PullRow</span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span>
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXC_ExternalScript</span><span class="o">::</span><span class="n">EUdxTypeGet</span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">...</span>
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">...</span>
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqldk</span><span class="o">!</span><span class="n">ex_raise</span>
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqldk</span><span class="o">!</span><span class="n">ex_raise2</span>
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">...</span>
</div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'>           <span class="n">ntdll</span><span class="o">!</span><span class="n">RtlRaiseException</span>
</div></div><div data-line='29' class='code-highlight-row numbered'><div class='code-highlight-line'>           <span class="p">...</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 11:</strong> <em>Code Path for Exception</em></p> <p>Included in <em>Code Snippet 11</em> is the start of the routine, the same as in <em>Code Snippet 10</em>, but we see how after the last <code>ReadAllPackets</code> the call goes into <code>sqllang!CServerCargoContext::HandleSpecialMessage</code> and <code>sqllang!CServerCargoContext::HandleAbortMessage</code>. These two calls are still inside the <code>PullRow</code> and <code>ProcessOutputSchema</code> calls, e.g. while SQL Server processes the packet from the SqlSatellite. The <code>HandleSpecialMessage</code> and <code>HandleAbortMessage</code> explains the packet in <em>Code Snippet 8</em>: it is an abort packet.</p> <p>Further down in the code in <em>Code Snippet 11</em> is a call to <code>sqllang!CUDXC_ExternalScript::EUdxTypeGet</code>, where - I believe - SQL Server retrieves the type of error and then raises the error in the <code>sqldk!ex_raise</code> call-chain. The question now is how SQL Server knows the error message? What I mean is: when we look at the <code>text</code> column in the result from <em>Code Snippet 4</em> we see for error number the text being: <code>An external script error occurred: %.*ls%.*ls</code>. The <code>%.*ls%.*ls</code> characters are substitution parameters and when we look at the actual error message in <em>Figure 3</em>, the replacement for the substitution parameters is what we see outlined in red below:</p> <p><img class="center" src="/images/posts/sql_r_services_20_error3.png" width="560" height="235" > <strong>Figure 8:</strong> <em>Substitution Text</em></p> <p>So, where do the substitution outlined in <em>Figure 8</em> come from, and what is the text outlined in blue in the same figure? We know that the actual error-text is not part of the 28 bytes packet from the SqlSatellite, as no matter how long the error message is, the length of the packet is always the same. So where have we seen messages being passed back to SQL Server, without being in any data packets from the SqlSatellite? Well, we saw it in <a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Internals - XIX</a> where the launchpad service did send "print" messages as well as ack messages from the external engine to SQL Server. So, let us go to the launchpad service and <a href="http://queue.acm.org/detail.cfm?id=945136">"spelunk"</a> around a bit:</p> <h4>Launchpad</h4> <p>We know, from <a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Internals - XIX</a>, that the two routines used when sending messages are:</p> <ul> <li><code>launchpad!CSatelliteCargoContext::SendLogMessage</code></li> <li><code>launchpad!CSQLSatelliteCommunication::SendAckMessage</code></li> </ul> <p>First, we try to find any routines handling error messages specifically: <code>x *!*Send*Error*</code>. That returns one routine: <code>launchpad!HostErrorReportingManager:: SendErrorToUserWithTracing</code>. I did however not get a hit at a break-point set at the routine, when I executed the code in <em>Code Snippet 2</em>. So it looks like our best bet is one of the previously mentioned routines, and we try <code>launchpad!CSatelliteCargoContext::SendLogMessage</code> first:</p> <ul> <li>Set a break-point <code>launchpad!CSatelliteCargoContext::SendLogMessage</code>.</li> <li>Execute the code in <em>Code Snippet 1</em> (no error code).</li> </ul> <p>You see how the code executes all the way through, and the breakpoint is not hit. However, the execution breaks at the break-point when you run <em>Code Snippet 2</em> (error)! The only difference between the two code snippets is the error in <em>Code Snippet 2</em>, so it looks like the launchpad service sends a message to SQL Server with the error text from the external engine.</p> <h4>SQL Server II</h4> <p>We know from <a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Internals - XIX</a> that <code>sqllang!CUDXR_ExternalScript::HandleLogMessage</code> handles messages that are sent through <code>launchpad!CSatelliteCargoContext::SendLogMessage</code>. I wonder if that is the case when there is an exception as well:</p> <ul> <li>Disable the break-points in the launchpad <em>WinDbg</em> instance.</li> <li>Disable any break-points in the SQL Server <em>WinDbg</em> instance.</li> <li>Set a break-point at <code>sqllang!CUDXR_ExternalScript::HandleLogMessage</code>.</li> <li>Run the <em>Code Snippet 2</em> code.</li> <li>Continue through the exceptions.</li> </ul> <p>Cool, we hit the <code>HandleLogMessage</code> break-point, so let us look at the call-stack (<code>k</code>):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Call Stack</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">HandleLogMessage</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSatelliteCommunication</span><span class="o">::</span><span class="n">WaitForAckMessage</span><span class="o">+</span><span class="mh">0x164</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">ShutdownService</span><span class="o">+</span><span class="mh">0x250</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CUDXR_ExternalScriptCleanup</span><span class="o">::</span><span class="n">Close</span><span class="o">+</span><span class="mh">0xe</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryExecContext</span><span class="o">::</span><span class="n">FinalCleanupNoX</span><span class="o">+</span><span class="mh">0x116</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">DestroyQueryOnException</span><span class="o">+</span><span class="mh">0x129</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ShutdownOnException</span><span class="o">+</span><span class="mh">0xc8</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">FinishOnExceptionImp</span><span class="o">+</span><span class="mh">0x67</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n"><em>isa_available_init</span><span class="o">+</span><span class="mh">0xe8cf3</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">MSVCR120</span><span class="o">!</span><span class="n"></em>CallSettingFrame</span><span class="o">+</span><span class="mh">0x20</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>               <span class="p">[</span><span class="n">f</span><span class="o">:</span><span class="err">\</span><span class="n">dd</span><span class="err">\</span><span class="n">vctools</span><span class="err">\</span><span class="n">crt</span><span class="err">\</span><span class="n">crtw32</span><span class="err">\</span><span class="n">eh</span><span class="err">\</span><span class="n">amd64</span><span class="err">\</span><span class="n">handlers</span><span class="p">.</span><span class="k">asm</span> <span class="err">@</span> <span class="mi">51</span><span class="p">]</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">MSVCR120</span><span class="o">!</span><span class="n">__CxxCallCatchBlock</span><span class="o">+</span><span class="mh">0xf5</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>               <span class="p">[</span><span class="n">f</span><span class="o">:</span><span class="err">\</span><span class="n">dd</span><span class="err">\</span><span class="n">vctools</span><span class="err">\</span><span class="n">crt</span><span class="err">\</span><span class="n">crtw32</span><span class="err">\</span><span class="n">eh</span><span class="err">\</span><span class="n">frame</span><span class="p">.</span><span class="n">cpp</span> <span class="err">@</span> <span class="mi">1281</span><span class="p">]</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">ntdll</span><span class="o">!</span><span class="n">RcConsolidateFrames</span><span class="o">+</span><span class="mh">0x3</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span><span class="o">+</span><span class="mh">0xa9e</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x983</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span><span class="o">+</span><span class="mh">0x140e</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">...</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">ntdll</span><span class="o">!</span><span class="n">RtlUserThreadStart</span><span class="o">+</span><span class="mh">0x21</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 12:</strong> <em>HandleLogMessage Call Stack</em></p> <p>The call-stack we see in <em>Code Snippet 12</em> indicates a similar code path for <code>HandleLogMessage</code> as we saw in <em>Code Snippet 12</em> in the <a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Internals - XIX</a> post . They are similar, but there are some differences which becomes clear when we compare the code paths between the two call-stacks. In a no error scenario we have a code path like this:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>No Error</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtSelect</span><span class="o">::</span><span class="n">XretExecute</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ShutdownNormal</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>          <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">DestroyQuery</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryExecContext</span><span class="o">::</span><span class="n">FinalCleanup</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="n">sqlmin</span><span class="o">!</span><span class="n">CUDXR_ExternalScriptCleanup</span><span class="o">::</span><span class="n">Close</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="p">...</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="p">...</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>                <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">HandleLogMessage</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div></pre></div></figure></p> <p><strong>Code Snippet 13:</strong> <em>Code Path HandleLogMessage No Error</em></p> <p>Whereas the code path for an exception looks like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Error Path</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">...</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">...</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">FinishOnExceptionImp</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ShutdownOnException</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">DestroyQueryOnException</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryExecContext</span><span class="o">::</span><span class="n">FinalCleanupNoX</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>          <span class="n">sqlmin</span><span class="o">!</span><span class="n">CUDXR_ExternalScriptCleanup</span><span class="o">::</span><span class="n">Close</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="p">...</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="p">...</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>              <span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">HandleLogMessage</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 14:</strong> <em>Code Path HandleLogMessage with Error</em></p> <p>When we compare <em>Code Snippet 13</em> and <em>Code Snippet 14</em> we see how - in both cases - the code goes into shutdown and cleanup routines, but in the error case these routines are "exception" routines:</p> <ul> <li><code>sqllang!CXStmtQuery::FinishOnExceptionImp</code></li> <li><code>sqllang!CXStmtQuery::ShutdownOnException</code></li> <li><code>sqlmin!CQueryScan::DestroyQueryOnException</code></li> </ul> <p>The question now is how the message received from the external engine via the launchpad service is "hooked" up to the actual exception. The assumption is that the answer to that has something to do with <code>HandleLogMessage</code>. So, let us compare what happens in <code>HandleLogMessage</code> when we run code that logs a message (as we did in <a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Internals - XIX</a>), with running code that causes an exception.</p> <p>This is the code with no exception:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Code 2</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span> <span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                 <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Sys.sleep(10)
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                             cat("Hello World")
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                             d &lt;- 42'</span><span class="p">;</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 15:</strong> <em>Code with Print</em></p> <p>The code in <em>Code Snippet 15</em> is the same code we used in <a href="/2018/01/20/microsoft-sql-server-r-services-internals-xix/">Internals - XIX</a>, and this is what we do:</p> <ul> <li>Set a breakpoint at <code>sqllang!CUDXR_ExternalScript::HandleLogMessage</code>.</li> <li>Run the code in <em>Code Snippet 15</em>.</li> <li>Do a trace, (<code>wt -l6</code>), of the <code>HandleLogMessage</code> call when you hit the breakpoint.</li> <li>Copy the output of the trace into a new text file.</li> <li>Make sure the <code>C++ EH Exception</code> event filter is still enabled.</li> <li>Run the code in <em>Code Snippet 2</em>.</li> <li>Continue through the exceptions.</li> <li>Do a trace, (<code>wt -l6</code>), of the <code>HandleLogMessage</code> call when you hit the breakpoint.</li> <li>Copy the output of the trace into a new text file.</li> </ul> <p>When you compare the two files you see they are similar, but at around line 190, or so, there is a difference. In the "no-error" file you see something like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>HandleLogMessage 1</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CErrorReportingManager</span><span class="o">::</span><span class="n">CwchFormatAndPrint</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CAutoInterceptErrorForTsqlCatch</span><span class="o">::</span><span class="n">Initialize</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CAutoInterceptErrorForTsqlCatch</span><span class="o">::</span><span class="n">Initialize</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CErrorReportingManager</span><span class="o">::</span><span class="n">CwchFormatAndPrint</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CErrorReportingManager</span><span class="o">::</span><span class="n">SetError</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CErrorReportingManager</span><span class="o">::</span><span class="n">SetError</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">getret</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">getret</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">getret</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CErrorReportingManager</span><span class="o">::</span><span class="n">CwchFormatAndPrint</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CErrorReportingManager</span><span class="o">::</span><span class="n">SendErrorToUser</span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">...</span>
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">ErrorReportedAutoPublish</span><span class="o">::</span><span class="n">Publish</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 16:</strong> "HandleLogMessage No Error"</p> <p>However in the "error" file you see:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>HandleLogMessage 2</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CErrorReportingManager</span><span class="o">::</span><span class="n">CwchFormatAndPrint</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CAutoInterceptErrorForTsqlCatch</span><span class="o">::</span><span class="n">Initialize</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CAutoInterceptErrorForTsqlCatch</span><span class="o">::</span><span class="n">Initialize</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CAutoInterceptErrorForTsqlCatch</span><span class="o">::</span><span class="n">Initialize</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CAutoInterceptErrorForTsqlCatch</span><span class="o">::</span><span class="n">Initialize</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">PCXCtxtGetIfExistsEXPENSIVE</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">PCXCtxtGetIfExistsEXPENSIVE</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CAutoInterceptErrorForTsqlCatch</span><span class="o">::</span><span class="n">Initialize</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">PCXCtxtGetIfExistsEXPENSIVE</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">PCXCtxtGetIfExistsEXPENSIVE</span>
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CAutoInterceptErrorForTsqlCatch</span><span class="o">::</span><span class="n">Initialize</span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">sqllang</span><span class="o">!</span><span class="n">CExecLvlRepresentation</span><span class="o">::</span><span class="n">FErrorModeJumpToCatch</span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CAutoInterceptErrorForTsqlCatch</span><span class="o">::</span><span class="n">Initialize</span>
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CErrorReportingManager</span><span class="o">::</span><span class="n">CwchFormatAndPrint</span>
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CErrorReportingManager</span><span class="o">::</span><span class="n">SetError</span>
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CErrorReportingManager</span><span class="o">::</span><span class="n">SetError</span>
</div></div><div data-line='29' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">getret</span>
</div></div><div data-line='30' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='31' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='32' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">getret</span>
</div></div><div data-line='33' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValueStub</span>
</div></div><div data-line='34' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">KERNEL32</span><span class="o">!</span><span class="n">TlsGetValue</span>
</div></div><div data-line='35' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">getret</span>
</div></div><div data-line='36' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CErrorReportingManager</span><span class="o">::</span><span class="n">CwchFormatAndPrint</span>
</div></div><div data-line='37' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">CErrorReportingManager</span><span class="o">::</span><span class="n">SendErrorToUser</span>
</div></div><div data-line='38' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">...</span>
</div></div><div data-line='39' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sqllang</span><span class="o">!</span><span class="n">ErrorReportedAutoPublish</span><span class="o">::</span><span class="n">Publish</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 17:</strong> "HandleLogMessage Exception"</p> <p>You can see how, in the "error" file (<em>Code Snippet 17</em>), the code loops on <code>sqllang!CAutoInterceptErrorForTsqlCatch::Initialize</code>, before it calls into <code>sqllang!CExecLvlRepresentation::FErrorModeJumpToCatch</code>. This loop does not happen in the "non-error" case. Oh, and it is interesting to see how in the case of "normal" log messages, the message is still considered being an error:</p> <ul> <li><code>sqllang!CErrorReportingManager::SetError</code></li> <li><code>sqllang!CErrorReportingManager::SendErrorToUser</code></li> <li><code>sqllang!ErrorReportedAutoPublish::Publish</code></li> </ul> <h2>Errors Unknown to SQL Server</h2> <p>This post has become long, but let us talk a little bit about the type of error we saw in <em>Figure 4</em> before we finish. I refer to where SQL Server does not know about the error in the external engine (you see no specific external engine SQL Server error message).</p> <p>If we look at how the error in <em>Code Snippet 2</em> is handled and compare it with the error in <em>Code Snippet 3</em>, we may think they are handled the same way (an error is an error, right?), and it may look like that. For example, if we look at <em>Process Monitor</em> we see the same 28 bytes packet sent to SQL Server as we saw in <em>Figure 7</em>. The packet itself looks the same as in <em>Code Snippet 8</em> (first 4 bytes - <code>01 00 04 80</code> second 4 bytes - <code>1c 00 00 00</code>, and the final 4 bytes - <code>12 00 2a 00</code>). These similarities led me to believe we would see the same flow as in <em>Code Snippet 11</em>, where the code goes into <code>sqllang!CServerCargoContext::HandleSpecialMessage</code> and further down into <code>sqllang!CServerCargoContext::HandleAbortMessage</code>. I was wrong!</p> <p>I realised the errors of my ways when I set a breakpoint at <code>sqllang!CServerCargoContext::HandleSpecialMessage</code>, ran the code in <em>Code Snippet 3</em>, and the code never hit the breakpoint! So what happened here? Well, the actual exception happened way before sending the <code>@input_data_1</code> data to the SqlSatellite, and that is the cause of what we see. So let us:</p> <ul> <li>Disable all breakpoints.</li> <li>Keep the <code>C++ EH Exception</code> event filter enabled.</li> </ul> <p>When we run the <em>Code Snippet 3</em> code, we see how the execution breaks at exception three times in quick succession. When inspecting the call-stack of each of those three occurrences we see how all three exceptions are related to the <code>sqlTsEs!ESArithErrorHandler</code> routine which handles, among other things, division by zero.</p> <p>There is a slight pause when continuing after the third exception, and then we break once again with a new exception. The call-stack now looks like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>""</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">KERNELBASE</span><span class="o">!</span><span class="n">RaiseException</span><span class="o">+</span><span class="mh">0x68</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">MSVCR120</span><span class="o">!</span><span class="n">_CxxThrowException</span><span class="o">+</span><span class="mh">0xb3</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>          <span class="p">[</span><span class="n">f</span><span class="o">:</span><span class="err">\</span><span class="n">dd</span><span class="err">\</span><span class="n">vctools</span><span class="err">\</span><span class="n">crt</span><span class="err">\</span><span class="n">crtw32</span><span class="err">\</span><span class="n">eh</span><span class="err">\</span><span class="k">throw</span><span class="p">.</span><span class="n">cpp</span> <span class="err">@</span> <span class="mi">154</span><span class="p">]</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqldk</span><span class="o">!</span><span class="n">ExceptionBackout</span><span class="o">::</span><span class="n">GetCurrentException</span><span class="o">+</span><span class="mh">0x385</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqldk</span><span class="o">!</span><span class="n">ex_raise2</span><span class="o">+</span><span class="mh">0x52f</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqldk</span><span class="o">!</span><span class="n">ex_raise</span><span class="o">+</span><span class="mh">0xc4</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlTsEs</span><span class="o">!</span><span class="n">ESArithErrorHandler</span><span class="o">+</span><span class="mh">0x159</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlTsEs</span><span class="o">!</span><span class="n">CTEsArith</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="o">&gt;::</span><span class="n">RsltArithArgArg</span><span class="o">+</span><span class="mh">0x94</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlTsEs</span><span class="o">!</span><span class="n">CEsExec</span><span class="o">::</span><span class="n">GeneralEval4</span><span class="o">+</span><span class="mh">0xe7</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CUDXR_ExternalScript</span><span class="o">::</span><span class="n">PushRow</span><span class="o">+</span><span class="mh">0x78</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">PushNextChildRow</span><span class="o">+</span><span class="mh">0x13b</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanUdx</span><span class="o">::</span><span class="n">GetRow</span><span class="o">+</span><span class="mh">0x79</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">GetRow</span><span class="o">+</span><span class="mh">0x81</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span><span class="o">+</span><span class="mh">0x4dc</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">...</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span><span class="o">+</span><span class="mh">0x140e</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">...</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">ntdll</span><span class="o">!</span><span class="n">RtlUserThreadStart</span><span class="o">+</span><span class="mh">0x21</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 18:</strong> "Exception after Division by Zero"</p> <p>The call-stack we see in <em>Code Snippet 18</em> shows how an exception happens when we try to push data rows to a packet to send to SqlSatellite. So, even though there is a division by zero exception initially, SQL Server still tries to push data to the satellite. The question is if some data goes to the satellite? Remember from previous posts how we covered data sent to the SqlSatellite and how the satellite received end-packet(s) after the data. I wonder what happens in this case:</p> <ul> <li>Disable the <code>C++ EH Exception</code> event filter.</li> <li>Run <em>Process Monitor</em> as admin, and use the event filter we used above.</li> <li>Execute the code in <em>Code Snippet 3</em> and look at the output from <em>Process Monitor</em>:</li> </ul> <p><img class="center" src="/images/posts/sql_r_services_20_procmon2.png" width="550" height="230" > <strong>Figure 9:</strong> <em>Process Monitor Output 2</em></p> <p>When we compare <em>Figure 9</em> with what we see in <em>Figure 7</em>, there is not much of a difference. In both figures we see SQL Server sending a 28 bytes end-packet to the SqlSatellite. In <em>Figure 9</em> it is outlined in red, and in <em>Figure 7</em> it is just above the highlighted packet. Even though the two figures look the same, the difference lies in the end-packet. I used <em>WireShark</em> to capture packets from <em>Code Snippet 1</em> (no error), <em>Code Snippet 2</em> (external engine error) and <em>Code Snippet 3</em> (SQL error):</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>End Packets</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1">//OK</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">01</span> <span class="mo">00</span> <span class="mo">06</span> <span class="mi">80</span> <span class="mi">1</span><span class="n">c</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mi">76</span> <span class="mo">01</span> <span class="mi">1</span><span class="n">b</span> <span class="mi">35</span> <span class="n">fa</span> <span class="mi">75</span> <span class="mi">64</span> <span class="mi">48</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">81</span> <span class="mi">34</span> <span class="n">e2</span> <span class="n">ec</span> <span class="n">ec</span> <span class="mi">7</span><span class="n">d</span> <span class="mi">2</span><span class="n">d</span> <span class="n">c6</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <br/>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1">//engine exception</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">01</span> <span class="mo">00</span> <span class="mo">06</span> <span class="mi">80</span> <span class="mi">1</span><span class="n">c</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mi">90</span> <span class="mi">2</span><span class="n">b</span> <span class="mi">8</span><span class="n">a</span> <span class="mi">3</span><span class="n">f</span> <span class="mi">60</span> <span class="mi">5</span><span class="n">c</span> <span class="n">d5</span> <span class="mi">49</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">a0</span> <span class="mi">8</span><span class="n">f</span> <span class="n">f0</span> <span class="n">c4</span> <span class="n">c0</span> <span class="n">bf</span> <span class="n">c0</span> <span class="n">cb</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>          <br/>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1">//exception SQL</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mo">01</span> <span class="mo">00</span> <span class="mo">04</span> <span class="mi">80</span> <span class="mi">1</span><span class="n">c</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  <span class="mi">7</span><span class="n">f</span> <span class="mi">82</span> <span class="n">bc</span> <span class="n">e0</span> <span class="mi">3</span><span class="n">f</span> <span class="mi">5</span><span class="n">a</span> <span class="mi">29</span> <span class="mi">48</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="mi">83</span> <span class="n">d7</span> <span class="mi">20</span> <span class="mi">46</span> <span class="n">ad</span> <span class="mi">79</span> <span class="mo">04</span> <span class="mi">21</span>  <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>  </div></div></pre></div></figure></p> <p><strong>Code Snippet 19:</strong> <em>Different End Packet Types</em></p> <p>When we look at the packets in <em>Code Snippet 19</em> we see how the two first packets look like the success packets SQL Server receives from the SqlSatellite. Why I say that, is because the four first bytes are the same: <code>01 00 06 80</code>. The third packet, however, looks like the "error" packet SqlSatellite sends to SQL Server, with a header of <code>01 00 04 80</code>. The difference between the packet that SQL Server sends to the satellite, and the packet SQL Server receives are the last four bytes. Sending to the satellite the bytes are <code>00 00 00 00</code>, whereas when an error packet comes back from the satellite, it is - as we discussed when we saw <em>Code Snippet 8</em> - <code>12 00 2a 00</code>. I do believe that this packet is what causes the SqlSatellite to raise the error we see <code>SqlSatellite cannot read data chunk ...</code>.</p> <p>So this is what happens:</p> <ul> <li>The exception happens in the SQL Server engine, before the process has been handed over to the SqlSatellite.</li> <li>An error packet is sent to the satellite.</li> <li>The satellite cannot process the packet.</li> <li>The SqlSatellite sends back the error message we see.</li> <li>This is handled by the <code>HandleLogMessage</code> routine in SqlServer.</li> </ul> <p>In the bullet points above I say that the <code>HandleLogMessage</code> routine handles the message, and you can see this by setting a breakpoint on this routine.</p> <h2>Summary</h2> <p>We have in this post seen how there are two types of errors related to the external engine:</p> <ul> <li>Error raised in the extern engine itself.</li> <li>Error happening before the external engine has taken over.</li> </ul> <p>When an error happens in the external engine:</p> <ul> <li>the SqlSatellite sends an error packet to SQL Server.</li> <li>SQL Server receives the packet and handles it in <code>sqllang!CServerCargoContext::HandleSpecialMessage</code> and <code>sqllang!CServerCargoContext::HandleAbortMessage</code>. This raises a SQL Server exception related to the external engine.</li> <li>The error message from the external engine is sent to the launchpad service.</li> <li>The launchpad service sends the message to SQL Server via <code>launchpad!CSatelliteCargoContext::SendLogMessage</code></li> <li>SQL Server handles the message in <code>sqllang!CUDXR_ExternalScript::HandleLogMessage</code>.</li> </ul> <p>When the error happens in SQL Server before the external engine:</p> <ul> <li>An error packet is sent to the satellite.</li> <li>The satellite cannot process the packet.</li> <li>The SqlSatellite sends back the error message via <code>launchpad!CSatelliteCargoContext::SendLogMessage</code>.</li> <li>SQL Server handles the message in <code>sqllang!CUDXR_ExternalScript::HandleLogMessage</code> and related routines.</li> </ul> <h2>~ Finally</h2> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2018/02/02/microsoft-sql-server-r-services-internals-xx/&text=Microsoft SQL Server R Services - Internals XX&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2018/02/02/microsoft-sql-server-r-services-internals-xx/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2018/02/02/microsoft-sql-server-r-services-internals-xx/ &title=Microsoft SQL Server R Services - Internals XX &summary=Blog post: A drill down, using WinDbg, WireShark, Process Monitor, into how error messages in the external engine is handled by SQL Server. &source=http://www.nielsberglund.com/2018/02/02/microsoft-sql-server-r-services-internals-xx/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2018/02/02/microsoft-sql-server-r-services-internals-xx/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> <br/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad2 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="1158080725" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2018/03/04/interesting-stuff-week-9/"> Interesting Stuff - Week 9 <small> (04 Mar 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/02/25/interesting-stuff-week-8/"> Interesting Stuff - Week 8 <small> (25 Feb 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/02/18/interesting-stuff-week-7/"> Interesting Stuff - Week 7 <small> (18 Feb 2018)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
