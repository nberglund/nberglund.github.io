<!DOCTYPE html> <html lang="en-us"> <head> <!-- Google Tag Manager --> <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-K7B3642');</script> <!-- End Google Tag Manager --> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="description" content="A drill-down into how SQL Server Compute Context works when executing sp_execute_external_script."> <meta name="keywords" content="SQL Server R Services, SQL Server Machine Learning Services, R, Python, Launchpad, Process Monitor, SqlSatellite, Process Explorer, parallel, SQL Server compute context, sp_execute_external_script"/> <!-- Enable responsiveness on mobile devices--> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> sp_execute_external_script and SQL Compute Context - I &middot; Niels Berglund </title> <!-- CSS --> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/syntax.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> <!-- Icons --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <link href='/stylesheets/all-e8a259b38492bb97421cc4e038981561.css' media='all' rel='stylesheet' type='text/css'> <!-- Begin Jekyll SEO tag v2.5.0 --> <title>sp_execute_external_script and SQL Compute Context - I | Niels Berglund</title> <meta name="generator" content="Jekyll v3.8.3" /> <meta property="og:title" content="sp_execute_external_script and SQL Compute Context - I" /> <meta name="author" content="nielsb" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A drill-down into how SQL Server Compute Context works when executing sp_execute_external_script." /> <meta property="og:description" content="A drill-down into how SQL Server Compute Context works when executing sp_execute_external_script." /> <link rel="canonical" href="http://nielsberglund.com/2018/05/20/sp-execute-external-script-and-sql-compute-context/" /> <meta property="og:url" content="http://nielsberglund.com/2018/05/20/sp-execute-external-script-and-sql-compute-context/" /> <meta property="og:site_name" content="Niels Berglund" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2018-05-20T10:46:52+02:00" /> <script type="application/ld+json"> {"url":"http://nielsberglund.com/2018/05/20/sp-execute-external-script-and-sql-compute-context/","headline":"sp_execute_external_script and SQL Compute Context - I","dateModified":"2018-05-20T10:46:52+02:00","datePublished":"2018-05-20T10:46:52+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://nielsberglund.com/2018/05/20/sp-execute-external-script-and-sql-compute-context/"},"author":{"@type":"Person","name":"nielsb"},"description":"A drill-down into how SQL Server Compute Context works when executing sp_execute_external_script.","@type":"BlogPosting","@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-3005153158271538", enable_page_level_ads: true }); </script> </head> <body> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K7B3642" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) --> <div class="sidebar"> <div class="container"> <div class="sidebar-about"> <h1> <a href="/"> Niels Berglund </a> </h1> <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Sidebar_rectangle --> <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-3005153158271538" data-ad-slot="7704601332"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Posts Archive</a> <a class="sidebar-nav-item" href="/categories/">Categories</a> <a class="sidebar-nav-item" href="/disclaimer/">Disclaimer</a> <a class="sidebar-nav-item" href="/series/">Blog Post Series</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> </nav> <img class="center" src="/images/MVP_Logo_large.png" width="300" height="121" > <section> <h3 style="color:#ffffff">Follow Me:</h3> <ul> <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li> <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li> </ul> </section> <p>&copy; 2018. All rights reserved.</p> <div class="sidebar-social"> <div><a href="https://github.com/nberglund"> GitHub </a></div> <div><a href="https://twitter.com/nielsberglund"> Twitter </a></div> <div><a href="https://za.linkedin.com/in/niels-berglund-0122593"> LinkedIn </a></div> <div><a href="https://plus.google.com/u/0/109374849138720664008"> Google+ </a></div> </div> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">sp_execute_external_script and SQL Compute Context - I</h1> <div class="post-subheading"> <span class="post-date">20 May 2018</span> <span class="post-tag"> <span class="post-tagdesc">in categories:</span> <a href="/categories/#SQL Server">SQL Server</a> <a href="/categories/#Microsoft R Server">Microsoft R Server</a> <a href="/categories/#Microsoft Machine Learning Server">Microsoft Machine Learning Server</a> <a href="/categories/#Data Science">Data Science</a> <a href="/categories/#SQL Server R Services">SQL Server R Services</a> <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <span class="post-tagdesc">tags:</span> <a href="/tags/#SQL Server R Services">SQL Server R Services</a> <a href="/tags/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a> <a href="/tags/#R">R</a> <a href="/tags/#Python">Python</a> <a href="/tags/#Launchpad">Launchpad</a> <a href="/tags/#Process Monitor">Process Monitor</a> <a href="/tags/#SqlSatellite">SqlSatellite</a> <a href="/tags/#Process Explorer">Process Explorer</a> <a href="/tags/#parallel">parallel</a> <a href="/tags/#SQL Server compute context">SQL Server compute context</a> <a href="/tags/#sp_execute_external_script">sp_execute_external_script</a> </span> </div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad1 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="6668073777" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> <p>The last <a href="/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/">blog post</a> in the <a href="/series/sql_server_2k16_r_services">Microsoft SQL Server R Services</a> series covered some performance related parameters of <code>sp_execute_external_script</code>, (<code>@parallel</code> and <code>@r_rowsPerRead</code>), and it touched a little bit on <strong>SQL Server Compute Context</strong>.</p> <p>After I published the post, I received an email from <a href="https://www.linkedin.com/in/umachandarjayachandran/">Umachandar Jayachandran</a> who is a Principal Program Manager in the SQL Server team and is working on integration of R, Python and other runtimes into SQL Server (basically, he knows this "stuff"). In the mail, he said that I was somewhat incorrect in what I said about how the <strong>SQL Server Compute Context</strong> (SQLCC) works.</p> <p>So I decided to write a post to correct my mistakes, and this is it. While I wrote this post I realized that there are more to the SQL compute context that meets ones eye, so I will - in all likelihood - write more posts about SQLCC.</p> <p>To see other posts (including this) in the series, go to <a href="/series/spees_and_sql_compute_context"><strong>sp_execute_external_script and SQL Server Compute Context</strong></a>.</p> <p>Before I begin I want to say a very big <strong>THANK YOU</strong> to <a href="https://www.linkedin.com/in/umachandarjayachandran/">Umachandar</a> as well as <a href="https://twitter.com/nelliegson">Nellie Gustafsson</a> who also is a SQL Server Program Manager at Microsoft. Without them making me see the "errors of my way" I would not have been able to write this post.</p> <!--more--> <p>A little bit of background first.</p> <h2>Background</h2> <p>We all know how SQL Server supports parallelism, whereby it decides whether to execute a statement in parallel or not, and the <code>MAXDOP</code> setting defines the number of processors executing the statement. Parallel execution is also supported when executing <code>sp_execute_external_script</code> by setting the <code>@parallel</code> parameter to <code>1</code>.</p> <blockquote><p><strong>NOTE:</strong> You are not guaranteed to execute in parallel even if you set the parameter. SQL Server decides whether the statement you want to execute should be executed in parallel or not.</p></blockquote> <p>So, if SQL decides that it can execute in parallel, what happens is that multiple SqlSatellite instances and connections are created. Multiple <code>BxlServer.exe</code> processes host the SqlSatellites, and SQL Server acts as a coordinator and sends data to the various SqlSatellites:</p> <p><img class="center" src="/images/posts/sql_r_services_ext_scriptIII_multi_process.png" width="800" height="522" > <strong>Figure 1:</strong> <em>Parallel Execution</em></p> <p><em>Figure 1</em> tries to illustrate executing external script in parallel with a <code>MAXDOP</code> setting of 6 (6 processes used). The numbers in the figure are:</p> <ol> <li>We call <code>sp_execute_external_script</code> and SQL Server calls into the launchpad service.</li> <li>The launchpad service creates RTerm processes which in turn creates BxlServer processes. Based on <code>MAXDOP</code>, multiple executing processes "spin up".</li> <li>TCP connections from the SqlSatellite in the executing processes get established.</li> <li>SQL server sends input data to the SqlSatellites.</li> <li>The <code>BxlServer.exe</code> processes the data.</li> <li>SQL Server receives data back from the individual SqlSatellite.</li> </ol> <p>In <em>Figure 1</em> you see how the execution is in parallel and how SQL Server acts as a coordinator. What I mean with that is that the SqlSatellites make connections to SQL Server, SQL Server sends batches of data to the SqlSatellites, the BxlServer processes handle the data, and finally, SQL receives results back from the SqlSatellites. The good thing about how this works is that it does not matter whether you use <strong>RevoScaleR</strong> or <strong>CRANR</strong> functions, they execute in parallel regardless.</p> <p>The downside with this type of parallel execution (<code>@parallel = 1</code>) is that the processes are independent of each other:</p> <ul> <li>SqlSatellite makes independent connections to SQL Server.</li> <li>SQL Server sends individual batches of data to the SqlSatellite.</li> <li>The BxlServer processes hosting the SqlSatellites processes the data.</li> <li>SQL Server receives results back from the SqlSatellites.</li> </ul> <p>Why this is a downside is that, as the data is processed independently, if your data has dependencies between different rows (like creating models), there is a high risk that different processes process the dependent rows. We saw that in <a href="/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/">sp_execute_external_script - III</a> where we had code like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Model in Parallel</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>        pid &lt;- Sys.getpid()
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>        myModel &lt;- rxLinMod(y ~ rand1 + rand2 + rand3 + rand4 + rand5,
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                      data=InputDataSet)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>        model &lt;- serialize(myModel, NULL);
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>        modelbinstr = paste(model, collapse = "")
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>        OutputDataSet &lt;- data.frame(ProcessId = pid,
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>                                    nRows=myModel$nValidObs,
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>                                    theModel = modelbinstr)'</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'SELECT TOP(2400000) y, rand1, rand2, rand3,
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>                                           rand4, rand5
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>                       FROM dbo.tb_Rand_3M
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>                       WHERE  rand5 &gt;= 10         <br/>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>                       OPTION(querytraceon 8649, MAXDOP 4)'</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="p">,</span> <span class="o">@</span><span class="n">parallel</span> <span class="o">=</span> <span class="mi">1</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">((</span><span class="n">ProcessId</span> <span class="n">int</span><span class="p">,</span> <span class="k">Rows</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>                   <span class="n">ModelAsVarchar</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span> <span class="k">NULL</span><span class="p">));</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 1:</strong> <em>Model Creation in Parallel</em></p> <p>The code in <em>Code Snippet1</em> is supposed to create a model from some random data and then it outputs the serialized model as a string. However when we execute the code in <em>Code Snippet 1</em> we get a result looking like so:</p> <p><img class="center" src="/images/posts/sql_r_services_ext_scriptIII_ssms4.png" width="796" height="130" > <strong>Figure 2:</strong> <em>Parallel Model Creation</em></p> <p>Oh, that was probably not what we wanted - four different models from four different process id's. We see that the models are different based on the outlined, in red, part of <em>Figure 2</em>. So what we have seen right now should tell us that executing in parallel is not always a good thing.</p> <p>At this stage, you may wonder if everything you have read about <strong>RevoScaleR</strong> being optimised for Big Data and parallel processing if that is just a marketing ploy? No, it is not, it is correct that the <strong>RevoScaleR</strong> functions are optimised, and have parallel capabilities. However, for parallel processing, they need the help of the <strong>SQL Server Compute Context</strong>.</p> <h2>Housekeeping</h2> <p>Before we "dive" into today's topics let us look at the code and the tools we use today. This section is here for those who want to follow along in what we are doing in the post.</p> <h4>Helper Tools</h4> <p>To help us figure out the things we want, we use <em>Process Explorer</em>:</p> <ul> <li><em>Process Explorer</em> is used to look at running processes.</li> </ul> <h4>Code</h4> <p>This is the database objects we use in this post:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Setup</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span><span class="p">;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">TestParallel</span><span class="p">;</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">TestParallel</span><span class="p">;</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">USE</span> <span class="n">TestParallel</span><span class="p">;</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Rand_50M</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Rand_50M</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">(</span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">RowID</span> <span class="n">bigint</span> <span class="k">identity</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">y</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand1</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">rand2</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand3</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">rand4</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand5</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">);</span>
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Rand_50M</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">rand3</span><span class="p">,</span> <span class="n">rand4</span><span class="p">,</span> <span class="n">rand5</span><span class="p">)</span>
</div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">50000000</span><span class="p">)</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='29' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">20</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='30' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">25</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='31' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='32' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">50</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='33' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">100</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
</div></div><div data-line='34' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o1</span>
</div></div><div data-line='35' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o2</span>
</div></div><div data-line='36' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o3</span>
</div></div><div data-line='37' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o4</span><span class="p">;</span>
</div></div><div data-line='38' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">GO</span>
</div></div></pre></div></figure></p> <p><strong>Code Snippet 2:</strong> <em>Setup of Database, Table and Data</em></p> <p>The code above, (<em>Code Snippet 2</em>), creates a database - <code>TestParallel</code> and one table:</p> <ul> <li><code>dbo.tb_Rand_50M</code> - This table contains the data we want to analyse. Yes, I know - the data is completely useless, but it is a lot of it, and it helps to illustrate what we want to do.</li> </ul> <p>In <em>Code Snippet 2</em> we also see how we load 50 million records into the <code>dbo.tb_Rand_50M</code>. Be aware that when you run the code in <em>Code Snippet 2</em> it may take some time to finish due to the loading of the data.</p> <h2>SQL Server Compute Context</h2> <p>In <a href="/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/">sp_execute_external_script - III</a> we spoke about as part of the functionality in RevoScaleR is the ability to define where a workload executes. By default, it executes on your local machine, but you can also set it to execute in context of somewhere else: Hadoop, Spark and also SQL Server. For this post it is the the SQLCC that interests us.</p> <p>The SQLCC is not only available from within SQL Server, but also from desktop applications, like Visual Studio, RStudio and so forth. To demonstrate the ability to execute in a separate context we use Visual Studio and some R code:</p> <ol> <li>Open <em>Visual Studio</em></li> <li>Create a new R project.</li> </ol> <p>In the editor you now have an empty <code>.R</code> file.</p> <blockquote><p><strong>NOTE:</strong> You do not have to use R, you can if you want to use Python as well.</p></blockquote> <p>In the <code>.R</code> file enter following code:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>R Code</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1"># set up the connection string</span><span class="w"></span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlServerConnString</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"Driver=SQL Server;server=.\\inst2k17;
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                        database=testParallel;
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                        uid=&lt;the user id&gt;;pwd=&lt;the password&gt;"</span><span class="w">
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">mydata</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">RxSqlServerData</span><span class="p">(</span><span class="n">sqlQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SELECT y, rand1, rand2,
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                                      rand3, rand4, rand5
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>                                      FROM dbo.tb_Rand_50M"</span><span class="p">,</span><span class="w">
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>                          </span><span class="n">connectionString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqlServerConnString</span><span class="p">);</span><span class="w">
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">system.time</span><span class="p">(</span><span class="n">print</span><span class="p">(</span><span class="w"></span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">myModel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rxLinMod</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">rand1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rand2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rand3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rand4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rand5</span><span class="p">,</span><span class="w">
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>                    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mydata</span><span class="p">)));</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 3:</strong> <em>R Code - Local Compute Context</em></p> <p>As we see in <em>Code Snippet 3</em>, we create a linear regression model over the 50 million rows in the <code>dbo.tb_Rand_50M</code> table and we measure the time it takes (<code>system.time()</code>). As no compute context is defined the code runs under the local context in one thread.</p> <p>Before we execute the code we should start up <em>Process Explorer</em> to see what processes are involved when running the code:</p> <ul> <li>Run <em>Process Explorer</em> as admin.</li> <li>Navigate to the <code>devenv.exe</code> process in <em>Process Explorer</em>.</li> </ul> <p>Notice how, under the <code>devenv.exe</code> process, there is a node for <code>Microsoft.R.Host.Broker.exe</code>. Under that node are two <code>Microsoft.R.Host.exe</code> nodes which in turn hosts <code>BxlServer.exe</code>. This is in line with what we discussed in <a href="/2017/07/22/microsoft-sql-server-r-services-internals-viii/">Internals - VIII</a> about hosting of R processes.</p> <p>When you execute the code in <em>Code Snippet 3</em> the output in <em>Process Explorer</em> looks something like so:</p> <p><img class="center" src="/images/posts/sql_ml_services_comp_ctx1.png" width="435" height="309" > <strong>Figure 3:</strong> <em>Local Context Execution</em></p> <p>In <em>Figure 3</em> we see the <code>devenv.exe</code> process outlined in red and the two <code>Microsoft.R.Host.exe</code> processes outlined in blue. The second <code>Microsoft.R.Host.exe</code> process shows how the local <code>BxlServer.exe</code> process (highlighted in red) handles the execution of the code. We see this as the <code>CPU</code> value is greater than 0.01. As the process is local, it also means that the process retrieves all data it needs from wherever the data resides. So this is what executing in the local context looks like, oh and before we go any further, please make a note of the output from the <code>system.time()</code> call. On my machine, it is ~40 seconds.</p> <p>Let us now see what it looks like when we execute in the SQL Server compute context. To enable the SQL Server compute context we only need to add a couple of lines of code from what we saw in <em>Code Snippet 3</em>:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>R SQL Compute Context Code</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1"># set up the connection string</span><span class="w"></span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlServerConnString</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"Driver=SQL Server;server=.\\inst2k17;
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                        database=testParallel;
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                        uid=&lt;the user id&gt;;pwd=&lt;the password&gt;"</span><span class="w">
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1"># set up a compute context</span><span class="w"></span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">sqlCtx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">RxInSqlServer</span><span class="p">(</span><span class="n">connectionString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqlServerConnString</span><span class="p">,</span><span class="w">
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>                        </span><span class="n">numTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"></span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1"># set the compute context to be the sql context</span><span class="w"></span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">rxSetComputeContext</span><span class="p">(</span><span class="n">sqlCtx</span><span class="p">)</span><span class="w">
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">mydata</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">RxSqlServerData</span><span class="p">(</span><span class="n">sqlQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SELECT y, rand1, rand2,
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>                                      rand3, rand4, rand5
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>                                      FROM dbo.tb_Rand_50M"</span><span class="p">,</span><span class="w">
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>                          </span><span class="n">connectionString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqlServerConnString</span><span class="p">);</span><span class="w">
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">system.time</span><span class="p">(</span><span class="n">print</span><span class="p">(</span><span class="w"></span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">myModel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rxLinMod</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">rand1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rand2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rand3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rand4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rand5</span><span class="p">,</span><span class="w">
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>                    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mydata</span><span class="p">)));</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 4:</strong> <em>R Code - SQL Server Compute Context</em></p> <p>In the code above we use the <code>RxInSqlServer()</code> function to indicate we want to execute in a SQL context. The <code>connectionString</code> property defines where we execute, and the <code>numTasks</code> property sets the number of tasks (processes) to run for each computation, in <em>Code Snippet 4</em> it is set to 1 which from a processing perspective should match what we do in <em>Code Snippet 3</em>. Before we execute the code in <em>Code Snippet 4</em> we do what we did before we ran the code in <em>Code Snippet 3</em>:</p> <ul> <li>Run <em>Process Explorer</em> as admin.</li> <li>Navigate to the <code>devenv.exe</code> process in <em>Process Explorer</em>.</li> <li>In addition, also look at the <code>Launchpad.exe</code> process in <em>Process Explorer</em>.</li> </ul> <p>When we execute we see that the <code>BxlServer.exe</code> processes under the <code>Microsoft.R.Host.exe</code> processes are idling, but when we look at the <code>Launchpad.exe</code> process we see this:</p> <p><img class="center" src="/images/posts/sql_ml_services_comp_ctx2.png" width="425" height="340" > <strong>Figure 4:</strong> <em>SQL Server Compute Context Execution</em></p> <p>Interesting, we see that one of the <code>BxlServer.exe</code> processes under <code>Launchpad.exe</code> is busy (highlighted in yellow). So we see that the code executes in the context of SQL Server. What also is interesting is that the output from <code>system.time()</code>, is on my machine, around 32 seconds - 8 seconds less than when the execution happened in the local compute context! The fact that the execution time is shorter when executing in the SQL Server compute context than when executing in the local context is interesting since we do not do anything different - no more tasks, nothing. Later in this post, we come back to this, but now let us look at using the SQLCC when executing inside SQL Server - like when executing <code>sp_execute_external_script</code>.</p> <h2>SQL Server and SQL Server Compute Context</h2> <p>So the question is now that if we execute from inside of SQL Server, is that not automatically within a SQLCC? It is a valid question since what we see in <em>Figure 4</em> looks exactly what we saw in quite a few of the posts in the <a href="/series/sql_server_2k16_r_services">Internals</a> series. In there we saw how the <code>Launchpad.exe</code> process is hosting, via <code>RTerm.exe</code>, a <code>BxlServer.exe</code> server process which processes the data. So let us switch over to SQL Server and <em>SQL Server Management Studio</em> <em>SSMS</em> and try to see if we execute in the SQLCC or not.</p> <p>You see in <em>Code Snippet 4</em> how we use the function <code>rxSetComputeContext()</code> to set the compute context. There is also a function to retrieve the compute context you are in: <code>rxGetComputeContext()</code> (in Python it is <code>rx_get_compute_context</code>) which we now use:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Get Compute Context</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">EXEC</span><span class="w"> </span><span class="n">sp_execute_external_script</span><span class="w">
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>      </span><span class="o">@</span><span class="n">language</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="s1">'R'</span><span class="w">
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    </span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">script</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="s1">'
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>            ctx &lt;- rxGetComputeContext();
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>            show(ctx);'</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 5:</strong> <em>Use rxGetComputeContext()</em></p> <p>So in <em>Code Snippet 5</em> we call the <code>rxGetComputeContext()</code> function and assign the context to a variable for which we then print out the information from the metadata columns of the variable. This is what we see when we execute the code:</p> <p><img class="center" src="/images/posts/sql_ml_services_comp_local_ctx.png" width="350" height="65" > <strong>Figure 5:</strong> <em>SQL Server Local Compute Context</em></p> <p>The highlighted part in <em>Figure 5</em> says that we do run in the local compute context (<code>RxLocalSeq</code>). So, even when executing in SQL Server we need to explicitly set the SQL Server compute context via <code>RxInSqlServer()</code> and <code>rxSetComputeContext()</code> as we did in <em>Code Snippet 4</em>.</p> <blockquote><p><strong>NOTE:</strong> The local compute context is named <code>RxLocalSeq</code> (local sequential) and there is also another context <code>RxLocalParallel</code> (local parallel), which you can use if you manually manage distributed processing in Hadoop or Spark.</p></blockquote> <p> Let us now take a closer look at <code>RxInSqlServer()</code>.</p> <h4>RxInSqlServer()</h4> <p>When setting up a SQL Server Compute Context we use the <code>RxInSqlServer</code> function. The function name is the same for both R and Python and the signatures look like so:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>R</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">RxInSqlServer</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">connectionString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>              </span><span class="n">numTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rxGetOption</span><span class="p">(</span><span class="s2">"numTasks"</span><span class="p">),</span><span class="w">
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>              </span><span class="n">autoCleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">consoleOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>              </span><span class="n">executionTimeoutSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>              </span><span class="n">packagesToLoad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">shareDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>              </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">databaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>              </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">   </span><span class="n">...</span><span class="w">  </span><span class="p">)</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 6:</strong> <em>R Signature</em></p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Python</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">revoscalepy</span><span class="o">.</span><span class="n">RxInSqlServer</span><span class="p">(</span><span class="n">connection_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                          <span class="n">num_tasks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                          <span class="n">auto_cleanup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                          <span class="n">console_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                          <span class="n">execution_timeout_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                          <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                          <span class="n">packages_to_load</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 7:</strong> <em>Python Signature</em></p> <p>When we compare the signatures in <em>Code Snippet 6</em> and <em>Code Snippet 7</em> we see they differ somewhat, the reason for this I am not sure about but for now let us look at the parameters that are useful/important when executing <code>sp_execute_external_script</code>.</p> <p><strong>connectionString</strong>/<strong>connection_string</strong>:</p> <p>The ODBC connection string to the SQL Server where you want the computations to take place and you can use both Windows authentication mode as well as mixed mode.</p> <p>Please keep in mind that the connection string for the data source (where you get the data to process from) does not need to be the same as the connection string for the context and the context connection string does not have to point to a different database than the one you execute in.</p> <p><strong>numTasks</strong>/<strong>num_tasks</strong>:</p> <p>This parameter is where you set the number of tasks (processes) to run for each computation. The parameter defines the maximum number of tasks SQL Server can use. SQL Server can, however, decide to start fewer processes:</p> <ul> <li>Dependent on the volume of data (small dataset lower number of processes).</li> <li>If other jobs are already using too many resources.</li> <li>If num_tasks exceeds the MAXDOP (maximum degree of parallelism) configuration option in SQL Server.</li> </ul> <p>Each of the tasks is given data in parallel and does computations in parallel, and so computation time may decrease as num_tasks increases.</p> <h4>Set the Context</h4> <p>To set the compute context we do the same as in <em>Code Snippet 4</em>:</p> <ul> <li>Set the connection string which defines where the computations take place.</li> <li>Call <code>RxInSqlServer()</code> to create the context.</li> <li>Set the context via <code>rxSetComputeContext()</code>.</li> <li>Computations using RevoScaleR/revoscalepy functionality is now "automagically" processed in the defined compute context whereas non RevoScaleR/revoscalepy functions run in the local context.</li> </ul> <p>To see what it looks like we edit the code in <em>Code Snippet 4</em> somewhat:</p> <p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>SQL Compute Context</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">DECLARE</span> <span class="o">@</span><span class="k">start</span> <span class="n">datetime2</span> <span class="o">=</span> <span class="n">SYSUTCDATETIME</span><span class="p">()</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span><br/>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>      # set up the connection string
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>      sqlServerConnString &lt;- "Driver=SQL Server;server=.</span><span class="se">\</span><span class="s1">inst2k17;
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>                              database=testParallel;
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>                              uid=&lt;the user id&gt;;pwd=&lt;the password&gt;"
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>      # set up a compute context
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>      sqlCtx &lt;- RxInSqlServer(connectionString = sqlServerConnString,
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>                              numTasks = 1)
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>      # set the compute context to be the sql context
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>      rxSetComputeContext(sqlCtx)
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>      mydata &lt;- RxSqlServerData(sqlQuery = "SELECT y, rand1, rand2,
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>                                           rand3, rand4, rand5
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>                                           FROM dbo.tb_Rand_50M",
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>                                connectionString = sqlServerConnString);
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>      myModel &lt;- rxLinMod(y ~ rand1 + rand2 + rand3 + rand4 + rand5,
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>                          data = mydata);
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'>      ctx &lt;- rxGetComputeContext();
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'>      show(ctx);'</span>
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="k">SELECT</span> <span class="n">DATEDIFF</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="o">@</span><span class="k">start</span><span class="p">,</span> <span class="n">SYSUTCDATETIME</span><span class="p">())</span></div></div></pre></div></figure></p> <p><strong>Code Snippet 8:</strong> <em>SQL Compute Context from sp_execute_external_script</em></p> <p>The only difference between the code in <em>Code Snippet 8</em> and <em>Code Snippet 4</em> is that we do not use <code>system.time</code> anymore, but instead do a<code>DATEDIFF</code>. We also print out the context at the very end, and when we execute we see that we are in the SQLCC:</p> <p><img class="center" src="/images/posts/sql_ml_services_comp_sql_ctx.png" width="440" height="295" > <strong>Figure 5:</strong> <em>Compute Context Output</em></p> <p>The two highlighted parts in <em>Figure 5</em> shows that we indeed executed inside the SQLCC. As for the execution time; I see in the <em>Results</em> tab in <em>SSMS</em> that the execution took ~30 seconds. If you were to comment out the <code>RxInSqlServer</code> and <code>rxSetComputeContext</code> statements and re-run the code, you'd see the same as we saw above when we used Visual Studio. E.g. executing inside the SQLCC is faster than in the local context, even though it runs in the same database and with the same number of tasks (1). As mentioned in the part where we looked at executing from Visual Studio, something is "going on", and that is a topic for a future post.</p> <h2>Under the Covers</h2> <p>Now it is time to see how it works when we execute code running in a SQL Server compute context set up with multiple tasks. Remember what we saw in <a href="/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/">sp_execute_external_script - III</a> when we executed code that ran in parallel:</p> <p><img class="center" src="/images/posts/sql_r_services_ext_scriptIII_proc_exp2.png" width="720" height="575" > <strong>Figure 6:</strong> <em>Parallel Execution</em></p> <p>What we see in <em>Figure 6</em> is what we discussed in the Recap; how multiple RTerm and <code>BxlServer.exe</code> processes ran and handled the data independently. So what does it look like when we use the SQLCC, and we execute the code in <em>Code Snippet 8</em>, but the compute context's number of tasks is set to 4: <code>numTasks = 4</code>?</p> <p>So to investigate, let us do the following:</p> <ul> <li>Run <em>Process Explorer</em> as admin.</li> <li>Restart the Launchpad service for the SQL Server compute context's instance (this is to clean-up any RTerm processes).</li> <li>Navigate to the <code>Launchpad.exe</code> process in <em>Process Explorer</em>.</li> <li>Execute the code in <em>Code Snippet 8</em>, but ensure you have changed <code>numTasks</code> to 4.</li> </ul> <p>While the code is executing, look under the <code>Launchpad.exe</code> process in <em>Process Explorer</em> and you see something like so:</p> <p><img class="center" src="/images/posts/sql_ml_services_comp_mpi.png" width="620" height="500" > <strong>Figure 7:</strong> <em>Parallel Execution in Compute Context</em></p> <p>Well, that is interesting! In <em>Figure 7</em> we now see not only the "usual" RTerm and <code>BxlServer.exe</code> processes but also a new hosting process, outlined in red, <code>mpiexec.exe</code>. Underneath the <code>mpiexec.exe</code> process we see the <code>smpd.exe</code> process (outlined in green) and then four RTerm processes with <code>BxlServer.exe</code> processes which handle the workload. So, <code>mpiexec.exe</code> and <code>smpd.exe</code> are parts of <a href="https://msdn.microsoft.com/en-us/library/bb524831%28v=vs.85%29.aspx?f=255&amp;MSPPError=-2147217396"><strong>Microsoft MPI</strong></a> which is an implementation of MPI which is a communication protocol for programming parallel computers. We talk briefly about MPI a bit later in this post, but first, let us understand the flow.</p> <h4>Flow</h4> <p>We execute <code>sp_execute_external_script</code> and that "spins up" the usual RTerm and BxlServer process which we discussed in quite a few <a href="/series/sql_server_2k16_r_services">Internals</a> posts. SQL Server creates the compute context via another <code>sp_execute_external_script</code> call to the Launchpad service.</p> <blockquote><p><strong>NOTE:</strong> Above I say <em>another <code>sp_execute_external_script</code> call</em>, it is in fact two calls. Hopefully a future post covers why and how there are multiple calls</p></blockquote> <p>The Launchpad service creates the <code>mpiexec.exe</code> process which in turns creates the <code>smpd.exe</code> process and the Rterm/BxlServer pairs. If <code>numTasks</code> is set to 1, the Launchpad service does not create a <code>mpiexec.exe</code> process, but instead, it creates a Rterm/BxlServer pair.</p> <h2>MPI</h2> <p>As I mentioned above Microsoft MPI is a Microsoft implementation of the Message Passing Interface standard for developing and running parallel applications on the Windows platform, and it is an integral part of Microsoft HPC (High Performance Computing).</p> <h4>mpiexec &amp; smpd</h4> <p>The <code>mpiexec</code> is called from the launchpad service to start the parallel job. The <code>mpiexec</code> process in turn calls <code>smpd</code> which is a parallel process manager and it launches/monitors RTerm/BxlServer processes.</p> <h2>Summary</h2> <ul> <li>The compute context defines where/what executes a workload.</li> <li>RevoScaleR exposes multiple contexts, where SQL Server is one of them.</li> <li>You create the SQL Server compute-context by calling <code>RxInSqlServer</code> followed by <code>rxSetComputeContext</code>.</li> <li>You define how many processes to tun by the <code>RxInSqlServer</code>'s <code>numTasks</code> parameter.</li> <li>The execution of the code inside the SQLCC is initiated via two "extra" <code>sp_execute_external_script</code> calls.</li> <li>The compute context pushes fragments of the data to the tasks, which processes the data.</li> <li>The results are merged back into one result.</li> </ul> <h2>~ Finally</h2> <p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p> <p> <h2>Share this Post:</h2> <a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2018/05/20/sp-execute-external-script-and-sql-compute-context/&text=sp_execute_external_script and SQL Compute Context - I&via=nielsberglund" target="_blank">Twitter</a> <a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2018/05/20/sp-execute-external-script-and-sql-compute-context/" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"> | Google+</a> <a href="https://www.linkedin.com/shareArticle? mini=true &url=http://www.nielsberglund.com/2018/05/20/sp-execute-external-script-and-sql-compute-context/ &title=sp_execute_external_script and SQL Compute Context - I &summary=Blog post: A drill-down into how SQL Server Compute Context works when executing sp_execute_external_script. &source=http://www.nielsberglund.com/2018/05/20/sp-execute-external-script-and-sql-compute-context/"> | LinkedIn</a> </p> <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script> http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2018/05/20/sp-execute-external-script-and-sql-compute-context/ --> <p> <h2>Blog Feed:</h2> To automatically receive more posts like this, please <a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p> <br/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- Ad2 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3005153158271538" data-ad-slot="1158080725" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br/> </div> <div class="related"> <h2>Related Posts</h2> <div class="related-posts"> <h3><a href="/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/"> sp_execute_external_script and SQL Compute Context - III <small> (04 Aug 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/07/29/interesting-stuff-week-30/"> Interesting Stuff - Week 30 <small> (29 Jul 2018)</small> </a></h3> </div> <div class="related-posts"> <h3><a href="/2018/07/22/interesting-stuff-week-29/"> Interesting Stuff - Week 29 <small> (22 Jul 2018)</small> </a></h3> </div> </div> <div id="disqus_thread"></div> <script> var disqus_developer = 1; (function() { /*DON'T EDIT BELOW THIS LINE*/ var d = document, s = d.createElement('script'); s.src = '//manageddata.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18914734-2', 'auto'); ga('send', 'pageview'); </script> </body> </html>
