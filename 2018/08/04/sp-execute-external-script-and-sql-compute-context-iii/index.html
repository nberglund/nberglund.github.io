<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      sp_execute_external_script and SQL Compute Context - III &middot; Niels Berglund
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Niels Berglund
      </a>
    </div>
    <p class="lead">Technology musings about coding and data. Some topics: .NET, SQL Server, Data Science, R, Windows Azure and a lot more.</p>
  </header>
  <div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar_rectangle -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="7704601332"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
  <br/>
  
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  

  
    
      <a class="page-link "
          href="/about/">About Me</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Posts Archive</a>
    
  

  
    
      <a class="page-link "
          href="/categories/">Categories</a>
    
  

  
    
  

  
    
      <a class="page-link "
          href="/disclaimer/">Disclaimer</a>
    
  

  
    
  

  
    
  

  

  
    
      <a class="page-link "
          href="/series/">Blog Post Series</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
  <br/>
  <img src="/images/MVP_Logo_large.png"/>


  <section>
  <h3 style="color:#ffffff">Follow Me:</h3>
  <ul>
    <li><a href="https://twitter.com/nielsberglund" target="_blank">Twitter</a></li>
    <li><a href="http://feeds.feedburner.com/manageddata/" target="_blank">RSS/Atom Feed</a></li>
  </ul>
</section>
  
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">sp_execute_external_script and SQL Compute Context - III</h1>
  <div class="post-subheading">
  <span class="post-date">04 Aug 2018</span>

  <span class="post-tag">
    
      <br/>
      <span class="post-tagdesc">Categories:</span>
    

    
     <a href="/categories/#SQL Server">SQL Server</a>
    
     <a href="/categories/#Microsoft R Server">Microsoft R Server</a>
    
     <a href="/categories/#Microsoft Machine Learning Server">Microsoft Machine Learning Server</a>
    
     <a href="/categories/#Data Science">Data Science</a>
    
     <a href="/categories/#SQL Server R Services">SQL Server R Services</a>
    
     <a href="/categories/#SQL Server Machine Learning Services">SQL Server Machine Learning Services</a>
    

      
  </span>
</div>
  <br/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="6668073777"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</header>
<div class="content">
  <div class="post-body">
    <p>In the <a href="/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/">Microsoft SQL Server R Services - sp_execute_external_script - III</a> post I wrote about <code class="highlighter-rouge">sp_execute_external_script</code> (SPEES) and the <strong>SQL Server Compute Context</strong> (SQLCC). Afterwards I realised I had some things wrong, so I wrote a followup post: <a href="/2018/05/20/sp-execute-external-script-and-sql-compute-context/">sp_execute_external_script and SQL Compute Context - I</a> where I tried to correct my mistakes from the <a href="/2018/03/21/microsoft-sql-server-r-services-sp-execute-external-script-iii/">initial post</a>. That post led to <a href="/2018/07/07/sp-execute-external-script-and-sql-compute-context-II/">sp_execute_external_script and SQL Compute Context - II</a> and now we have a mini-series.</p>

<p>To see other posts (including this) in the series, go to <a href="/series/spees_and_sql_compute_context"><strong>sp_execute_external_script and SQL Server Compute Context</strong></a>.</p>

<p>In the previous post in this series, we looked at how data is sent to the SqlSatellite from SQL Server when we are in the SQLCC. This post was meant to look at what goes on inside SQL Server when we execute in SQLCC, but I realised that it would make more sense if, before we look at the internal working when in SQLCC, I covered what happens when pulling data in the local context. So that is what this post is all about.</p>

<!--more-->

<p>Before we dive into todays topic let us recap.</p>

<h2 id="recap">Recap</h2>

<p>In <a href="/2018/05/20/sp-execute-external-script-and-sql-compute-context/">Context - I</a> we discussed what the SQLCC is and we said that as part of RevoScaleR, you can define where a workload executes. By default, it executes on your local machine, but you can also set it to execute in the context of somewhere else: Hadoop, Spark and also SQL Server. So, in essence, you can run some code on your development machine and have it execute in the environments mentioned above. To use the SQLCC in SQL Server we use <code class="highlighter-rouge">RxInSqlServer</code> and <code class="highlighter-rouge">rxSetComputeContext</code>:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># set up the connection string</span><span class="w">
</span><span class="n">sqlServerConnString</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"Driver=SQL Server;
                        server=.; # localhost
                        database=testParallel;
                        uid=some_uid;pwd=some_pwd"</span><span class="w">

</span><span class="c1"># set up the context</span><span class="w">
</span><span class="n">sqlCtx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">RxInSqlServer</span><span class="p">(</span><span class="n">connectionString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqlServerConnString</span><span class="p">,</span><span class="w"> 
                        </span><span class="n">numTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="c1"># set the compute context to be the sql context</span><span class="w">
</span><span class="n">rxSetComputeContext</span><span class="p">(</span><span class="n">sqlCtx</span><span class="p">)</span><span class="w">    
</span></code></pre></div></div>
<p><strong>Code Snippet 1:</strong> <em>Set up SQL Server Compute Context</em></p>

<p>The connection string we see in <em>Code Snippet 1</em> indicates the where we execute, not necessarily where the data we work with lives. The <code class="highlighter-rouge">numTasks</code> argument defines the maximum number of tasks SQL Server can use. Something interesting when setting <code class="highlighter-rouge">numTasks</code> to be greater than 1 is that when we run the code, we run it hosted in a <code class="highlighter-rouge">mpiexec.exe</code> process. If we run in SQLCC under <code class="highlighter-rouge">numTasks = 1</code> we do not see <code class="highlighter-rouge">mpiexec.exe</code>, but we see another <code class="highlighter-rouge">bxlserver.exe</code> process. We also said that when we run in SQLCC. <code class="highlighter-rouge">sp_execute_external_script</code> executes multiple times.</p>

<p>The most interesting thing that came out of <a href="/2018/05/20/sp-execute-external-script-and-sql-compute-context/">Context - I</a> was the performance benefit of using SQLCC when loading large datasets. So in <a href="/2018/07/07/sp-execute-external-script-and-sql-compute-context-II/">sp_execute_external_script and SQL Compute Context - II</a>, we tried to see where that performance benefit came from.</p>

<p>In <a href="/2018/07/07/sp-execute-external-script-and-sql-compute-context-II/">Context - II</a> we said we had three ways of getting data into an R script:</p>

<ul>
  <li>Push using <code class="highlighter-rouge">@input_data_1</code>.</li>
  <li>Pull using <code class="highlighter-rouge">RxSqlServerData</code> in the local context.</li>
  <li>Pull using <code class="highlighter-rouge">RxSqlServerData</code> and the SQLCC.</li>
</ul>

<p>We saw that to use SQLCC we need to pull the data; we could not push it. We also saw that for large datasets there was a significant performance difference between pulling in the local context and pulling using SQLCC. The interesting point was that pushing data and pulling using SQLCC had the same performance characteristics.</p>

<p>When pulling the data (<code class="highlighter-rouge">RxSqlServerData</code>), we use ODBC, and the protocol is TDS. However, when we use the SQLCC, the BXL protocol is also used and that gives us very efficient processing of data which is the reason we see good performance.</p>

<h2 id="housekeeping">Housekeeping</h2>

<p>Before we go any further let us look at the code and the tools we use today. This section is here for those who want to follow along in what we are doing in the post.</p>

<h4 id="helper-tools">Helper Tools</h4>

<p>To help us figure out the things we want, we use:</p>

<ul>
  <li><em>Process Monitor</em> - to filter out TCP traffic.</li>
  <li><em>WinDbg</em> - to see what happens inside SQL Server. If you need help with setting it up, we covered that in <a href="/2017/03/18/microsoft-sql-server-r-services-internals-i/">Microsoft SQL Server R Services - Internals I</a>.</li>
  <li><em>WireShark</em> - to “sniff” network packets. We covered setting up <em>WireShark</em> in <a href="/2017/08/29/microsoft-sql-server-r-services-internals-x/">Internals - X</a>. Please remember that if you run SSMS and SQL Server on the same machine, then you need the <a href="https://nmap.org/npcap/"><strong>Npcap</strong></a> packet sniffer library instead of the default <strong>WinPcap</strong>.</li>
</ul>

<h4 id="code">Code</h4>

<p>This is the database objects we use in this post:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="n">USE</span> <span class="n">TestParallel</span><span class="p">;</span>
<span class="k">GO</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Rand_50M</span>
<span class="k">GO</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Rand_50M</span>
<span class="p">(</span>
  <span class="n">RowID</span> <span class="n">bigint</span> <span class="k">identity</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> 
  <span class="n">y</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand1</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> 
  <span class="n">rand2</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand3</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> 
  <span class="n">rand4</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">rand5</span> <span class="n">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">GO</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">tb_Rand_50M</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">rand3</span><span class="p">,</span> <span class="n">rand4</span><span class="p">,</span> <span class="n">rand5</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">50000000</span><span class="p">)</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span> 
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">20</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">25</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">14</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">50</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">CHECKSUM</span><span class="p">(</span><span class="n">NEWID</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">100</span> <span class="k">AS</span> <span class="n">INT</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o1</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o2</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o3</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">objects</span> <span class="n">o4</span><span class="p">;</span>
<span class="k">GO</span>

</code></pre></div></div>
<p><strong>Code Snippet 2:</strong> <em>Setup of Database, Table and Data</em></p>

<p>We use more or less the same database and database object as in the <a href="/2018/07/07/sp-execute-external-script-and-sql-compute-context-II/">Context - II</a> post:</p>

<ul>
  <li>A database: <code class="highlighter-rouge">TestParallel</code>.</li>
  <li>A table: <code class="highlighter-rouge">dbo.tb_Rand_50M</code>. This table contains the data we want to analyse.</li>
</ul>

<p>In addition to creating the database and the table <em>Code Snippet 2</em> also loads 50 million records into the <code class="highlighter-rouge">dbo.tb_Rand_50M</code>. Be aware that when you run the code in <em>Code Snippet 2</em> it may take some time to finish due to the loading of the data. Yes, I know - the data is entirely useless, but it is a lot of it, and it helps to illustrate what we want to do.</p>

<p>Not only is the database and database objects similar to what we used in <a href="/2018/07/07/sp-execute-external-script-and-sql-compute-context-II/">Context - II</a>, the code we use is also almost the same:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">isCtx</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">numTasks</span> <span class="n">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'R'</span>
    <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
      # set up the connection string
      sqlServerConnString &lt;- "Driver=SQL Server;server=.;
                              database=testParallel;
                              uid=&lt;username&gt;;pwd=&lt;userpwd&gt;"
      
      if(useContext == 1) {
        sqlCtx &lt;- RxInSqlServer(connectionString = sqlServerConnString, 
                                numTasks = tasks)
        # set the compute context to be the sql context
        rxSetComputeContext(sqlCtx)
      }

      mydata &lt;- RxSqlServerData(sqlQuery = "SELECT y, rand1, rand2, 
                                            rand3, rand4, rand5 
                                            FROM dbo.tb_Rand_50M",
                                connectionString = sqlServerConnString);
                        
      myModel &lt;- rxLinMod(y ~ rand1 + rand2 + rand3 + rand4 + rand5, 
                      data=mydata)'</span>
    <span class="p">,</span> <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@tasks int, @useContext bit'</span>
    <span class="p">,</span> <span class="o">@</span><span class="n">tasks</span> <span class="o">=</span> <span class="o">@</span><span class="n">numTasks</span>
    <span class="p">,</span> <span class="o">@</span><span class="n">useContext</span> <span class="o">=</span> <span class="o">@</span><span class="n">isCtx</span>
</code></pre></div></div>
<p><strong>Code Snippet 3:</strong> <em>Test Code</em></p>

<p>As we see in <em>Code Snippet 3</em> we parameterise the <code class="highlighter-rouge">sp_execute_external_script</code> call, and we have parameters for whether to use the SQLCC and also how many tasks to run when executing in the context. The default is to execute in the local context, and when we execute in SQLCC the default for the number of tasks is 1 (<code class="highlighter-rouge">numTasks = 1</code>).</p>

<h2 id="local-context-pull-vs-push">Local Context Pull vs Push</h2>

<p>Let us try and see what happens in SQL Server when we execute in the local context, and we pull data (<code class="highlighter-rouge">RxSqlServerData</code>) compared to when we push data (<code class="highlighter-rouge">@input_data_1</code>).</p>

<p>First, let us try and understand when and how the <code class="highlighter-rouge">SELECT</code> statement in <code class="highlighter-rouge">Code Snippet 3</code> executes. To check this we use the same technique as we did in <a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">Microsoft SQL Server R Services - Internals XIII</a>, we execute a <code class="highlighter-rouge">SELECT</code> statement which causes a division by zero exception. We capture that exception in <em>WinDbg</em> and we check the call stack.</p>

<p>So, run <em>WinDbg</em> as admin and enable an event-filter, so the debugger breaks at a <code class="highlighter-rouge">C++ EH</code> exception. In the <em>Event Filters</em> dialog you can set how that particular exception should be handled. We want it to be enabled, but not handled:</p>

<p><img src="/images/posts/sql_r_services_windbg_eventfilters_enable.png" alt="" /></p>

<p><strong>Figure 1:</strong> <em>Enable C++ EH Exception</em></p>

<p>When the <em>Event Filter</em> is enabled as in <em>Figure 1</em> we:</p>

<ul>
  <li>Attach <em>WinDbg</em> to the <code class="highlighter-rouge">sqlservr.exe</code> process (please do not do this on a production machine - <em>#justsaying</em>).</li>
  <li>Set a breakpoint at <code class="highlighter-rouge">bp sqllang!SpExecuteExternalScript</code>.</li>
  <li>Change the <code class="highlighter-rouge">SELECT</code> statement in <em>Code Snippet 3</em> slightly, so it generates the division by zero exception mentioned above: <code class="highlighter-rouge">SELECT TOP(1) (1 / y - y), y, rand1, ...</code>.</li>
</ul>

<p>After changing the <code class="highlighter-rouge">SELECT</code> statement, we execute the code. Continue through the breakpoint at <code class="highlighter-rouge">SpExecuteExternalScript</code>, and when the execution breaks at the exception we check the call stack: <code class="highlighter-rouge">k</code>:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">KERNELBASE</span><span class="o">!</span><span class="n">RaiseException</span><span class="o">+</span><span class="mh">0x68</span>
<span class="p">...</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span><span class="o">+</span><span class="mh">0x5a2</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtSelect</span><span class="o">::</span><span class="n">XretExecute</span><span class="o">+</span><span class="mh">0x2f2</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;+</span><span class="mh">0x4c5</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span><span class="o">+</span><span class="mh">0xaae</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0xa2c</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">process_request</span><span class="o">+</span><span class="mh">0xe52</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">process_commands_internal</span><span class="o">+</span><span class="mh">0x289</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">process_messages</span><span class="o">+</span><span class="mh">0x213</span>
<span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Task</span><span class="o">::</span><span class="n">Param</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x231</span>
<span class="p">...</span>
<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlUserThreadStart</span><span class="o">+</span><span class="mh">0x21</span>
</code></pre></div></div>
<p><strong>Code Snippet 4:</strong> <em>Call Stack Local Context Pull</em></p>

<p>The call stack we see in <em>Code Snippet 4</em> is somewhat edited in that it shows only the important parts. Let us compare it with the call-stack we see when we push the data, (<code class="highlighter-rouge">@input_data_1</code>), and receive a division by zero exception as we did in <a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">Microsoft SQL Server R Services - Internals XIII</a>:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">KERNELBASE</span><span class="o">!</span><span class="n">RaiseException</span><span class="o">+</span><span class="mh">0x68</span>
<span class="p">...</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span><span class="o">+</span><span class="mh">0x49f</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtSelect</span><span class="o">::</span><span class="n">XretExecute</span><span class="o">+</span><span class="mh">0x2f2</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;+</span><span class="mh">0x4c5</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span><span class="o">+</span><span class="mh">0xaae</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0xa2c</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span><span class="o">+</span><span class="mh">0x154b</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSpecProc</span><span class="o">::</span><span class="n">ExecuteSpecial</span><span class="o">+</span><span class="mh">0x31e</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXProc</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x139</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0xb5b</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CStmtExecProc</span><span class="o">::</span><span class="n">XretLocalExec</span><span class="o">+</span><span class="mh">0x2d3</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CStmtExecProc</span><span class="o">::</span><span class="n">XretExecExecute</span><span class="o">+</span><span class="mh">0x4a1</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtExecProc</span><span class="o">::</span><span class="n">XretExecute</span><span class="o">+</span><span class="mh">0x38</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">ExecuteStmts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;+</span><span class="mh">0x4c5</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CMsqlExecContext</span><span class="o">::</span><span class="n">FExecute</span><span class="o">+</span><span class="mh">0xaae</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSQLSource</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0xa2c</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">process_request</span><span class="o">+</span><span class="mh">0xe52</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">process_commands_internal</span><span class="o">+</span><span class="mh">0x289</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">process_messages</span><span class="o">+</span><span class="mh">0x213</span>
<span class="n">sqldk</span><span class="o">!</span><span class="n">SOS_Task</span><span class="o">::</span><span class="n">Param</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x231</span>
<span class="p">...</span>
<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlUserThreadStart</span><span class="o">+</span><span class="mh">0x21</span>
</code></pre></div></div>
<p><strong>Code Snippet 5:</strong> <em>Call Stack Local Context Push</em></p>

<p>The call-stack in <em>Code Snippet 5</em> is also edited and when we compare the two call-stacks, they look somewhat similar.  We see <code class="highlighter-rouge">sqllang!CXStmtQuery::ErsqExecuteQuery</code> in both code snippets, and we know from <a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">Internals - XIII</a> that <code class="highlighter-rouge">ErsqExecuteQuery</code> handles execution of SQL statements and also sending data to the SQL Satellite. So that makes sense that we see it in <em>Code Snippet 4</em>. However, what does not make sense is that we do not see <code class="highlighter-rouge">SpExecuteExternalScript</code> in the <em>Code Snippet 4</em> call stack (and no, I did not edit it out). What goes on here?</p>

<p>Ok, let us refer back to what we saw in <a href="/2017/10/31/microsoft-sql-server-r-services-internals-xii/">Internals - XII</a> and  <a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">Internals - XIII</a>, how SQL Server sends various data packages to the SqlSatellite and then finally calls <code class="highlighter-rouge">sqllang!CSatelliteCargoContext::SendChunkEndMessage</code>. So, add a breakpoint, in addition to the <code class="highlighter-rouge">SpExecuteExternalScript</code> breakpoint, at <code class="highlighter-rouge">sqllang!CSatelliteCargoContext::SendChunkEndMessage</code> and execute the code again. Oh, we see how we hit the <code class="highlighter-rouge">SpExecuteExternalScript</code> breakpoint first, followed by <code class="highlighter-rouge">SendChunkEndMessage</code>, and finally, we break at the division by zero exception. That is interesting, SQL Server sends the chunk end message and only after that, the query executes.</p>

<p>So what with <code class="highlighter-rouge">ErsqExecuteQuery</code>, what does that do? Let us see if we can find out:</p>

<ul>
  <li>Change the code not to cause a divide by zero exception: <code class="highlighter-rouge">SELECT TOP(1) y, rand1, ...</code>.</li>
  <li>Set a breakpoint at <code class="highlighter-rouge">ErsqExecuteQuery</code>.</li>
</ul>

<p>When you execute the code you see something like so:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0</span><span class="o">:</span><span class="mi">099</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">0</span> <span class="n">hit</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">SpExecuteExternalScript</span><span class="o">:</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">091</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span><span class="o">:</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">091</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">hit</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CSatelliteCargoContext</span><span class="o">::</span><span class="n">SendChunkEndMessage</span><span class="o">:</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">091</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span><span class="o">:</span>
<span class="mi">0</span><span class="o">:</span><span class="mo">07</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">g</span>
</code></pre></div></div>
<p><strong>Code Snippet 6:</strong> <em>Breakpoints Hit</em></p>

<p>In <em>Code Snippet 6</em> we see how we first hit the <code class="highlighter-rouge">SpExecuteExternalScript</code> breakpoint, followed by <code class="highlighter-rouge">ErsqExecuteQuery</code>, (which is expected), then we hit the <code class="highlighter-rouge">SendChunkEndMessage</code> followed by a second <code class="highlighter-rouge">ErsqExecuteQuery</code>. That is interesting; two <code class="highlighter-rouge">ErsqExecuteQuery</code>, and we know from above that the query executes after the second <code class="highlighter-rouge">ErsqExecuteQuery</code>. So the question is now how the data flows from SQL Server to the SqlSatellite. We know from [Internals - XIII<a href="/2017/11/11/microsoft-sql-server-r-services-internals-xiii/">si13</a>, as we mentioned above, that when we push data, SQL Server makes these calls (among many others):</p>

<ul>
  <li><code class="highlighter-rouge">sqlmin!CQScanUdx::PushNextChildRow</code>.</li>
  <li><code class="highlighter-rouge">sqllang!CUDXR_ExternalScript::PushRow</code>.</li>
  <li><code class="highlighter-rouge">sqllang!CSatelliteCargoContext::SendPackets</code>.</li>
</ul>

<p>Let us set a breakpoint at <code class="highlighter-rouge">sqllang!CSatelliteCargoContext::SendPackets</code> and see what happens when we execute.</p>

<p>THAT was interesting! We never hit <code class="highlighter-rouge">SendPackets</code>. In the recap above we said that when we pull the data we use ODBC and the TDS protocol, and what we see here further ensures that is the case. So what does SQL Server call when it uses TDS to send data? To find out:</p>

<ul>
  <li>Disable the breakpoints at <code class="highlighter-rouge">SendChunkEndMessage</code> and <code class="highlighter-rouge">SendPackets</code>.</li>
  <li>Execute the query.</li>
</ul>

<p>When you reach <code class="highlighter-rouge">ErsqExecuteQuery</code> the second time, do a <code class="highlighter-rouge">wt  -l4</code> (watch and trace 4 levels deep) and continue. Look at the output from the <code class="highlighter-rouge">wt</code>:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span>
  <span class="p">...</span>   
    <span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">SetupQueryScanAndExpression</span>
      <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQuery</span><span class="o">::</span><span class="n">CreateExecPlan</span>
        <span class="n">sqldk</span><span class="o">!</span><span class="n">CMemProc</span><span class="o">::</span><span class="n">CpagesInUse</span>
      <span class="p">...</span>
      <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">StartupQuery</span>
  <span class="p">...</span>      
  <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">GetRow</span>
    <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanTopNew</span><span class="o">::</span><span class="n">GetRow</span>
      <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanTableScanNew</span><span class="o">::</span><span class="n">GetRow</span>
        <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanRowsetNew</span><span class="o">::</span><span class="n">GetRowWithPrefetch</span>
      <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanTableScanNew</span><span class="o">::</span><span class="n">GetRow</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CValOdsRow</span><span class="o">::</span><span class="n">SetDataX</span>
        <span class="n">sqllang</span><span class="o">!</span><span class="n">CShilohTds</span><span class="o">::</span><span class="n">SendRowImpl</span>
      <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanTableScanNew</span><span class="o">::</span><span class="n">GetRow</span>
    <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQScanTopNew</span><span class="o">::</span><span class="n">GetRow</span>
  <span class="n">sqlmin</span><span class="o">!</span><span class="n">CQueryScan</span><span class="o">::</span><span class="n">GetRow</span>
<span class="p">...</span>
<span class="n">sqllang</span><span class="o">!</span><span class="n">CXStmtQuery</span><span class="o">::</span><span class="n">ErsqExecuteQuery</span>
</code></pre></div></div>
<p><strong>Code Snippet 7:</strong> <em>Output from wt</em></p>

<p>The output shows a lot of data, so in <em>Code Snippet 7</em> I have edited out all but the interesting parts. We see some routines that have to do with setting up and starting the query and retrieving result data:</p>

<ul>
  <li><code class="highlighter-rouge">sqllang!CXStmtQuery::SetupQueryScanAndExpression</code>.</li>
  <li><code class="highlighter-rouge">sqlmin!CQueryScan::StartupQuery</code>.</li>
  <li><code class="highlighter-rouge">sqlmin!CQueryScan::GetRow</code>.</li>
</ul>

<p>That is interesting but what is more interesting is what we see after the <code class="highlighter-rouge">GetRow</code> calls: <code class="highlighter-rouge">sqllang!CShilohTds::SendRowImpl</code>. SQL Server calls <code class="highlighter-rouge">SendRowImpl</code> when it pushes data to the network packet which it then sends to the caller. We can confirm this is the case by using <em>WinDbg</em> and <em>Process Monitor</em>. So, run <em>Process Monitor</em> as admin and set an event filter which captures TCP Receive events for the <code class="highlighter-rouge">BxlServer.exe</code> process.</p>

<blockquote>
  <p><strong>NOTE:</strong> If you are not sure how to set an event filter in <em>Process Monitor</em>, you can read about it in the <a href="/2018/07/07/sp-execute-external-script-and-sql-compute-context-II/">sp_execute_external_script and SQL Compute Context - II</a> post.</p>
</blockquote>

<p>Now, disable all breakpoints in <em>WinDbg</em> and execute the code in <em>Code Snippet 3</em>, (with <code class="highlighter-rouge">SELECT TOP(1) ...</code>) and watch the output from <em>Process Monitor</em>:</p>

<p><img src="/images/posts/sql_ml_services_compctx_III_procmon_pull_1.png" alt="" /></p>

<p><strong>Figure 2:</strong> <em>Process Monitor Output</em></p>

<p>What we see in <em>Figure 2</em> is similar to what we saw in <a href="/2018/07/07/sp-execute-external-script-and-sql-compute-context-II/">Context - II</a>, when we looked at the TCP packets SQL Server sends to the <code class="highlighter-rouge">BxlServer.exe</code> process. The outlined row in <em>Figure 2</em> is the packet with the result of the <code class="highlighter-rouge">SELECT</code>. I know that because I tried with multiple <code class="highlighter-rouge">TOP</code> values and saw which row changed length between the <code class="highlighter-rouge">TOP</code> values. In <a href="/2018/07/07/sp-execute-external-script-and-sql-compute-context-II/">Context - II</a> the corresponding row had a length of 1358 as we did a <code class="highlighter-rouge">TOP(50)</code>. You may wonder what the three highlighted parts if the figure is and we come back to that in a little bit.</p>

<p>Now let us confirm that the outlined row is the row with the data:</p>

<ul>
  <li>Re-enable (set) the breakpoint at <code class="highlighter-rouge">sqllang!SpExecuteExternalScript</code>.</li>
  <li>Set a breakpoint at <code class="highlighter-rouge">sqllang!CShilohTds::SendRowImpl</code>.</li>
</ul>

<p>Execute the code and continue through until you break at <code class="highlighter-rouge">SendRowImpl</code>. If you look at the <em>Process Monitor</em> output, the last row you see is a row with a length of 405. That is the fourth row from the end as we see in <em>Figure 2</em>. Now continue the execution, and you see how <em>Process Monitor</em> outputs the three last rows, with a row with a length of 133 as the first one. We have “thus” proven that <code class="highlighter-rouge">SendRowImpl</code> sends the data row to the data packet which then SQL Server sends to the caller. Oh, the reason I use <code class="highlighter-rouge">TOP(1)</code> is that there is one call to <code class="highlighter-rouge">SendRowImpl</code> for each row, and I do not want to have to press F5 millions of times, or even 50 times.</p>

<h2 id="packets">Packets</h2>

<p>Now, what about the highlighted areas in <em>Figure 2</em>, what are those? First of all, if you look at the length of the packets it seems like each area have packets of the same length: in the yellow area, we see packets with a length of 37, 1245, 67 and 405, which we also see in the green and blue area. In <em>Figure 2</em> we also see that the highlighted areas originate from the same <code class="highlighter-rouge">BxlServer.exe</code> process (process id 6572), but different ports: 6799, 6800 and 6801. OK, let us see if we can figure out what this is all about, and to try to get a clearer picture we also want to filter on what <code class="highlighter-rouge">BxlServer.exe</code> sends to SQL Server. To see that, we add two new conditions to the existing <em>Process Monitor</em> filter:</p>

<ul>
  <li>First condition - <em>Operation</em> (first drop-down) <em>is</em> (second dropdown): “TCP Send”.</li>
  <li>Second condition - <em>Path</em> <em>contains</em>: the definition for the SQL Server port (1443). In my examples it is: <code class="highlighter-rouge">win10-dev:ms-sql-s</code>. We set this filter condition, so we only see the ODBC communication.</li>
</ul>

<p>Disable all breakpoints in <em>WinDbg</em> and execute the code and watch the <em>Process Monitor</em> output:</p>

<p><img src="/images/posts/sql_ml_services_compctx_III_procmon_pull_2.png" alt="" /></p>

<p><strong>Figure 3:</strong> <em>Process Monitor Output - II</em></p>

<p>The output we see in <em>Figure 3</em> is quite similar to what we see in <em>Figure 2</em>, apart from that we also see the packets the <code class="highlighter-rouge">BxlServer.exe</code> process sends. We see the same structure of three separate sections of packets, and we have packets of the same length in the three sections. Once again we see the data packet being in the last section, once again with a length of 133 (the outlined row). What are these packets and why do we have three sections? Let us see if we can figure out what the packets do with the help of <em>WireShark</em>:</p>

<ul>
  <li>Start <em>WireShark</em> as admin.</li>
  <li>On the opening screen double click the adapter for <em>Npcap</em> (most likely named “Npcap Loopback Adapter”).</li>
</ul>

<p>This starts capturing events immediately and to stop the capture you click <strong>Ctrl + E</strong>. What we want to do now is to create a <em>WireShark</em> display filter, so we only see network packets we are interested in. What we are interested in are packets for port 1433, and we set the filter in the text box just underneath the toolbox: <code class="highlighter-rouge">tcp.port==1433</code>.  Finally, we click on the right arrow to the right the filter box to apply the filter (outlined in red below):</p>

<p><img src="/images/posts/sql_ml_services_compctx_III_wireshark_filter.png" alt="" /></p>

<p><strong>Figure 4:</strong> <em>WireShark Display Filter</em></p>

<p>TThe assumption at this stage is that the <em>WireShark</em> capture is off. Start the capture (“Ctrl+E”) and then immediately execute the code. We stop the capture as soon as the code has finished executing:</p>

<p><img src="/images/posts/sql_ml_services_compctx_III_wireshark_output_I.png" alt="" /></p>

<p><strong>Figure 5:</strong> <em>WireShark Output</em></p>

<p>In <em>Figure 5</em> we see part of the output from <em>WireShark</em>, and we may wonder why we see more packets than when we looked at the output from <em>Process Monitor</em> and why the packet sixes are not the same. There are a couple of answers to that:</p>

<ul>
  <li><em>Process Monitor</em> only show packets that has a body (data part), but more messages are going over the wire (<code class="highlighter-rouge">ACK</code> etc.), and <em>WireShark</em> shows all of them.</li>
  <li>The packet size question is related to the point above. <em>WireShark</em> shows the bytes going over the wire and that includes headers and so forth, whereas <em>Process Monitor</em> only shows the data size.</li>
  <li>The <em>WireShark</em> display filter is set on port 1433 (anything going in and out of SQL Server), whereas in <em>Process Monitor</em> we filtered on traffic to and from the <code class="highlighter-rouge">BxlServer.exe</code> process. The section in <em>Figure 5</em> highlighted in blue is an example of this; this is the communication between <em>SQL Server Management Studio</em> and SQL Server.</li>
</ul>

<h4 id="yellow-section">Yellow Section</h4>

<p>Ok, so what does <em>WireShark</em> tell us? In <em>Figure 5</em> I have highlighted in yellow the part that corresponds to the highlighted yellow part in <em>Figure 3</em>. For this exercise, we can ignore the packets whose <em>Protocol</em> is TCP and concentrate on the ones which have TDS as a protocol. Just by looking at the info we see that the packets have to do with login and authentication: <code class="highlighter-rouge">TDS7 pre-login message</code> followed by <code class="highlighter-rouge">Response</code> followed by more pre-login messages, followed by <code class="highlighter-rouge">TLS Exchange</code> and a <code class="highlighter-rouge">Response</code>. I am not going into any details about these packets, but if you want all the “gory” details about TDS you find documentation here: <a href="https://msdn.microsoft.com/en-us/library/dd304523.aspx">[MS-TDS]: Tabular Data Stream Protocol</a>.</p>

<p>We now realise that the packets in the first section in <em>Figure 3</em> has to do with authentication. Seeing that we see packets with the same length in the green and blue sections in <em>Figure 3</em> we can safely assume those packets are also authentication packets, and a quick look at the packets in <em>WireShark</em> confirms that. What about the packets that are different?</p>

<h4 id="green-section">Green Section</h4>

<p>In the green section there are packets with lengths of 386, 138, 23 and 22, and in the blue section, we see packet lengths of 330 and 133. Well, we do know what the 133 packet is - that is the packet with the data SQL Server sends to the <code class="highlighter-rouge">BxlServer.exe</code> process. So, let us go back to the <em>WireShark</em> output and see what we can find out:</p>

<p><img src="/images/posts/sql_ml_services_compctx_III_wireshark_output_II.png" alt="" /></p>

<p><strong>Figure 6:</strong> <em>WireShark Output II</em></p>

<p>We see in <em>Figure 6</em> the last packets of the green section packets in <em>Figure 3</em>. In <em>Figure 6</em> the first packet corresponds to the 405 packet in the green section in <em>Figure 3</em> which we know is a response package. To see what type of response packet it is, we click on the row in the “Packet List” pane in <em>WireShark</em> and the “Packet Details” pane shows the details about the packet:</p>

<p><img src="/images/posts/sql_ml_services_compctx_III_wireshark_env_change.png" alt="" /></p>

<p><strong>Figure 7:</strong> <em>WireShark Packet Details</em></p>

<p>Aha, in <em>Figure 7</em> we see that this packet is an <code class="highlighter-rouge">EnvChange</code> packet (yellow highlight) which SQL Server use to notify the caller of an environment change (for example, database, language, and so on). In this case, it is a database context change from <code class="highlighter-rouge">master</code> (grey highlight) to <code class="highlighter-rouge">testParallel</code> (blue highlight). So this packet appears in all three section sin <em>Figure 3</em>. Now let us look at the 386, 138, 23, and 22 packets, which in <em>WireShark</em> have lengths of 856, 360, 130 and 128 and are highlighted in <em>Figure 6</em> with yellow, green, blue and purple respectively.</p>

<p><strong>WireShark Packet 856</strong>:</p>

<p>When we click on the packet in the “Packet List” pane, the “Packet Details” looks like so:</p>

<p><img src="/images/posts/sql_ml_services_compctx_III_wireshark_prepare.png" alt="" /></p>

<p><strong>Figure 8:</strong> <em>WireShark Packet Details II</em></p>

<p>The packet details we see in <em>Figure 8</em> tells us that this is a “Remote Procedure Call” (which we also can see in <em>Figure 6</em>), and the call is to <code class="highlighter-rouge">sp_prepare</code> (highlighted in blue). The procedure <code class="highlighter-rouge">sp_prepare</code> is generally used for performance reasons and prepares a parameterized Transact-SQL statement and returns a statement handle for execution. The “Packet Bytes” pane shows us a hex dump the statement:</p>

<p><img src="/images/posts/sql_ml_services_compctx_III_wireshark_packet_bytes.png" alt="" /></p>

<p><strong>Figure 9:</strong> <em>WireShark Packet Bytes</em></p>

<p><strong>WireShark Packet 360</strong>:</p>

<p>The 360 packet (green) is a response packet, and when we look at the packet we see:</p>

<p><img src="/images/posts/sql_ml_services_compctx_III_wireshark_col_metadata.png" alt="" /></p>

<p><strong>Figure 10:</strong> <em>WireShark Packet Details and Bytes</em></p>

<p>We see in <em>Figure 10</em> that the response to <code class="highlighter-rouge">sp_prepare</code> is column metadata for the query.</p>

<p><strong>WireShark Packet 130 and 128</strong>:</p>

<p>Finally, the last two packets in the green section is a call to <code class="highlighter-rouge">sp_unprepare</code> (packet 130) and an “End of message” response (packet 128) to that.</p>

<h4 id="blue-section">Blue Section</h4>

<p>On to the blue section in <em>Figure 3</em>. We already said that there are only two packets that are different to the ones in the yellow and green sections:</p>

<p><img src="/images/posts/sql_ml_services_compctx_III_wireshark_output_III.png" alt="" /></p>

<p><strong>Figure 11:</strong> <em>WireShark Output III</em></p>

<p>The packet highlighted in yellow in <em>Figure 11</em> is the packet with a length of 330 in <em>Figure 3</em>, and the 350 packet (highlighted in green) is the <em>Figure 3</em> 133 packet.</p>

<p><strong>WireShark Packet 744</strong>:</p>

<p>The 744 packet looks like so:</p>

<p><img src="/images/posts/sql_ml_services_compctx_III_wireshark_sql_batch.png" alt="" /></p>

<p><strong>Figure 12:</strong> <em>WireShark Output III</em></p>

<p>In <em>Figure 12</em> we see how the packet is a SQL batch (yellow highlight), and it contains the actual query (green and blue highlights). So this is the query that SQL Server executes.</p>

<p><strong>WireShark Packet 350</strong>:</p>

<p>As we have mentioned a few times, the 350 packet contains the result of the query executed from the 744 packet, and the packet details and bytes look like so:</p>

<p><img src="/images/posts/sql_ml_services_compctx_III_wireshark_query_result.png" alt="" /></p>

<p><strong>Figure 13:</strong> <em>WireShark Output Query Result</em></p>

<p>With a cursory glance at <em>Figure 13</em> we may think there is no difference between what we see in <em>Figure 10</em> - which shows the response to the <code class="highlighter-rouge">sp_prepare</code> call - and what is in <em>Figure 13</em>. However, looking a bit closer we see that this packet contains the result of the query where we see highlighted in green and blue the two first column values, 2 and 6 respectively. The column values are not present in <em>Figure 10</em>.</p>

<h2 id="sections">Sections</h2>

<p>By now we sort of understand what goes on when we pull the data in the local context. However, why do we have these different sections, and why do we see multiple authentications? I have no answer why we see multiple authentications; maybe I can get an answer from someone “in the know”. As for the multiple sections; I am not 100% clear about that - but it seems to have something to do with what RevoScaleR function that accesses the data, remember from <a href="/2018/07/07/sp-execute-external-script-and-sql-compute-context-II/">Context - II</a> how loading of the data happens not in the <code class="highlighter-rouge">RxSqlServerData</code> call, but in the call which uses the data. So why I say that the sections are related to this is that if we, instead of doing a <code class="highlighter-rouge">rxLinMod</code> call, did something like <code class="highlighter-rouge">ds &lt;- </code>rxImport(mydata)` then we only see the green and blue sections. Hopefully, I can get some more information about the sections as well which I can update this post with.</p>

<h2 id="summary">Summary</h2>

<p>So this post discusses the internal workings in SQL Server when we pull data in the local context. We talked about how SQL Server first sends the script data to the SQL Satellite through the usual <code class="highlighter-rouge">sqllang!CXStmtQuery::ErsqExecuteQuery</code> and <code class="highlighter-rouge">sqllang!CSatelliteCargoContext::SendChunkEndMessage</code>. After <code class="highlighter-rouge">SendChunkEndMessage</code> <code class="highlighter-rouge">ErsqExecuteQuery</code> is called again and at that stage the statement query executes.</p>

<p>The data transfer between the SqlSatellite (hosted by <code class="highlighter-rouge">BxlServer.exe</code>) and SQL Server happens through TDS packets, and we saw how authentication packages are sent multiple times, followed by <code class="highlighter-rouge">sp_prepare</code>. Finally, SQL Server executes the query and returns the result to the SqlSatellite.</p>

<h2 id="-finally">~ Finally</h2>

<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>



    
<p>
<h2>Share this Post:</h2> 
<a href="https://twitter.com/intent/tweet?url=http://nielsberglund.com/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/&text=sp_execute_external_script and SQL Compute Context - III&via=nielsberglund" 
   target="_blank">Twitter</a>
<a href="https://plus.google.com/share?url=http://www.nielsberglund.com//2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/" 
   onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
    | Google+</a>
<a href="https://www.linkedin.com/shareArticle?
         mini=true
         &url=http://www.nielsberglund.com/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/
         &title=sp_execute_external_script and SQL Compute Context - III
         &summary=Blog post: We use WinDbg, Process Monitor and WireShark to look in detail what happens in SQL Server when we use RxSqlServerData to pull data.
         &source=http://www.nielsberglund.com/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/"> | LinkedIn</a> 

</p>   
   <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

   http://www.linkedin.com/shareArticle?mini=true&url=<URL>&title=<TITILE>&summary=<DESCRIPTION>&sourc


   https://www.linkedin.com/shareArticle?mini=true&url=http://nielsberglund.com/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/

   -->



    <p>
<h2>Blog Feed:</h2>
To automatically receive more posts like this, please
<a href="http://feeds.feedburner.com/manageddata/" target="_blank"> subscribe to my RSS/Atom feed</a> in your feed reader!</p>


    <br/>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3005153158271538"
     data-ad-slot="1158080725"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <br/>

    


  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    <h2>Post Tags:</h2>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


<div class="post-tags">
  
    
    <a href="/tags/#sql-server-r-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server R Services</span>
    </a>
  
    
    <a href="/tags/#sql-server-machine-learning-services">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Machine Learning Services</span>
    </a>
  
    
    <a href="/tags/#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags/#python">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Python</span>
    </a>
  
    
    <a href="/tags/#launchpad">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Launchpad</span>
    </a>
  
    
    <a href="/tags/#process-monitor">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Process Monitor</span>
    </a>
  
    
    <a href="/tags/#sqlsatellite">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SqlSatellite</span>
    </a>
  
    
    <a href="/tags/#process-monitor">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Process Monitor</span>
    </a>
  
    
    <a href="/tags/#parallel">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">parallel</span>
    </a>
  
    
    <a href="/tags/#sql-server-compute-context">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SQL Server Compute Context</span>
    </a>
  
    
    <a href="/tags/#sp-execute-external-script">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">sp_execute_external_script</span>
    </a>
  
    
    <a href="/tags/#rxsqlserverdata">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">RxSqlServerData</span>
    </a>
  
    
    <a href="/tags/#windbg">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WinDbg</span>
    </a>
  
    
    <a href="/tags/#wireshark">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WireShark</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://nielsberglund.com/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/";
    this.page.identifier = "" ||
                           "http://nielsberglund.com/2018/08/04/sp-execute-external-script-and-sql-compute-context-iii/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//manageddata.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2018/08/12/interesting-stuff-week-32/">
            Interesting Stuff - Week 32
            <small>12 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/05/interesting-stuff-week-31/">
            Interesting Stuff - Week 31
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/07/29/interesting-stuff-week-30/">
            Interesting Stuff - Week 30
            <small>29 Jul 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18914734-2', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Optional footer content -->

  </body>
</html>
